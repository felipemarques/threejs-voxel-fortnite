import{G as T,C as R,M as w,a as g,B as x,S as xe,P as U,D as Ee,b as De,I as Ke,c as Ae,V as I,d as ke,e as oe,f as ye,g as Je,h as Me,i as Ze,j as Qe,R as et,N as tt,k as it,l as Ge,T as st,E as ot,m as We,n as J,o as Y,p as nt,q as Ue,L as at,r as rt,s as ht,t as V,u as lt,v as ct,w as dt,A as ut,x as mt,y as pt,F as ft,W as gt,z as yt,H as je,J as Pe,K as wt,O as vt}from"./three.module-BS1HX5LR.js";import{createBus as Mt}from"./busElement-DikC1tJ7.js";import{_ as xt}from"./preload-helper-B0g6gzln.js";import{createNormalZombie as bt}from"./normalZombieElement-DnB3_ElI.js";import{createFatZombie as St}from"./fatZombieElement-CN_k09VM.js";import{createBigZombie as kt}from"./bigZombieElement-BwYxHNPs.js";import{createSlenderman as Et}from"./slendermanElement-xZvndKHS.js";import{createSpider as Ct}from"./spiderElement-hFDYL3-m.js";const Dt="/threejs-voxel-firecraft/dist/assets/background-music-by-suno-B4M28EgO.ogg";function Bt(){const b=new T,t=.8+Math.random()*.4;b.scale.set(t,t,t);const e=3.5+Math.random()*1.5,i=new R(.45,.6,e,8),s=new w({color:7028518,roughness:1}),o=new g(i,s);if(o.position.y=e/2,o.castShadow=!0,o.receiveShadow=!0,b.add(o),Math.random()>.7){const l=new x(.15,.15,.05),h=new w({color:5911328}),r=new g(l,h);r.position.set(.25,o.position.y+.6,.45),r.rotation.z=.4,b.add(r)}const n=new w({color:3050327,roughness:.9}),a=6+Math.floor(Math.random()*4);for(let l=0;l<a;l++){const h=1.2+Math.random()*1.6,r=new xe(h,8,6),c=new g(r,n);c.position.y=o.position.y+.8+Math.random()*1.6,c.position.x=(Math.random()-.5)*1.5,c.position.z=(Math.random()-.5)*1.5,c.castShadow=!1,c.receiveShadow=!1,b.add(c)}if(Math.random()>.3){const l=new U(.8,.8),h=new w({color:3066993,side:Ee}),r=new g(l,h);r.rotation.x=-Math.PI/2,r.position.y=.01,r.position.x=(Math.random()-.5)*.5,r.position.z=(Math.random()-.5)*.5,r.receiveShadow=!1,b.add(r)}return b}function It(){const b=new T,t=.8+Math.random()*.4;b.scale.set(t,t,t);const e=3.5+Math.random()*1.5,i=new R(.45,.6,e,8),s=new w({color:7028518,roughness:1}),o=new g(i,s);o.position.y=e/2,o.castShadow=!0,o.receiveShadow=!0,b.add(o);const n=new w({color:1728040,roughness:.9}),a=3+Math.floor(Math.random()*3);for(let r=0;r<a;r++){const c=1.8-r*.4+Math.random()*.2,d=new De(c,1.2+Math.random()*.6,8),f=new g(d,n);f.position.y=o.position.y+.6+r*.9,f.position.x=(Math.random()-.5)*.2,f.position.z=(Math.random()-.5)*.2,f.castShadow=!1,f.receiveShadow=!1,b.add(f)}const l=new xe(.25,6,6),h=new g(l,n);if(h.position.y=o.position.y+a*.9+.3,b.add(h),Math.random()>.3){const r=new U(.8,.8),c=new w({color:3066993,side:Ee}),d=new g(r,c);d.rotation.x=-Math.PI/2,d.position.y=.01,d.position.x=(Math.random()-.5)*.5,d.position.z=(Math.random()-.5)*.5,d.receiveShadow=!1,b.add(d)}return b}function Pt(b,t,e=0){const i=.6+Math.random()*1.4,s=new Ke(i,1),o=s.attributes.position;for(let l=0;l<o.count;l++){const h=o.getX(l),r=o.getY(l),c=o.getZ(l),d=(Math.random()-.5)*i*.15;o.setXYZ(l,h+d,r+d*.5,c+(Math.random()-.5)*i*.15)}s.computeVertexNormals();const n=new w({color:8359053,roughness:1}),a=new g(s,n);if(a.position.set(b,e+i/2,t),a.rotation.set(Math.random()*.5,Math.random()*Math.PI,Math.random()*.5),a.castShadow=!0,a.receiveShadow=!0,Math.random()>.6){const l=new g(new Ae(i*.4,6),new w({color:3066993}));l.rotation.x=-Math.PI/2,l.position.y=.01,a.add(l)}return a}function At(b,t,e=0){const i=2.5+Math.random()*2.5,s=.4+Math.random()*.3,o=s+.5,n=new R(s,o,i,8,1),a=new w({color:7171437,roughness:1}),l=new g(n,a);return l.position.set(b,e+i/2,t),l.castShadow=!0,l.receiveShadow=!0,l}function Tt(b,t,e=0){const i=2+Math.random()*2,s=.8+Math.random()*.6,o=1.5+Math.random()*1,n=new x(i,s,o),a=new w({color:9145227,roughness:1}),l=new g(n,a);return l.position.set(b,e+s/2,t),l.rotation.y=Math.random()*Math.PI,l.castShadow=!0,l.receiveShadow=!0,l}function zt(b,t,e=0){const i=2+Math.random()*2,s=new De(.6+Math.random()*.4,i,6),o=new w({color:10181046,roughness:.7,metalness:.2,emissive:4008804,emissiveIntensity:.25}),n=new g(s,o);return n.position.set(b,e+i/2,t),n.rotation.y=Math.random()*Math.PI,n.castShadow=!0,n.receiveShadow=!0,n}function Lt(b,t,e=0){const i=new T,s=3+Math.floor(Math.random()*4);for(let o=0;o<s;o++){const n=1+Math.random()*2,a=new R(.4,.4,n,6),l=new w({color:5592405,roughness:1}),h=new g(a,l);h.position.set((Math.random()-.5)*2,e+n/2,(Math.random()-.5)*2),h.castShadow=!0,h.receiveShadow=!0,i.add(h)}return i.position.set(b,0,t),i}function _t(b="car",t=null){const e=new T;e.rotation.y=Math.random()*Math.PI*2;const i=b==="truck"?.45:.35,s=b==="truck"?.4:.3;if(e.userData=e.userData||{},e.userData={vehicleType:b,wheelRadius:i,wheelCenterY:s,groundClearance:i-s,wheels:[]},b==="car"){const o=[1668818,15921906,1118481,9116186,15022389,15844367],n=t!==null?t:o[Math.floor(Math.random()*o.length)],a=new w({color:n,metalness:.45,roughness:.38}),l=new w({color:16119285,metalness:.2,roughness:.6}),h=new w({color:2042416,roughness:.8}),r=new g(new x(2.2,.9,4.2),a);r.position.y=.85,r.castShadow=!0,e.add(r);const c=new g(new x(2.25,.15,4.25),l);c.position.set(0,.9,0),e.add(c);const d=new g(new x(1.8,.9,2.1),h);d.position.set(0,1.55,-.2),d.castShadow=!0,e.add(d);const f=new w({color:1710618,transparent:!0,opacity:.7,metalness:.2,roughness:.1}),u=new g(new x(1.6,.6,.08),f);u.position.set(0,1.55,1),e.add(u);const m=new g(new x(1.6,.6,.08),f);m.position.set(0,1.55,-1.5),e.add(m);const p=new g(new x(2.1,.25,.35),h);p.position.set(0,.55,2.1),e.add(p);const v=p.clone();v.position.z=-2.1,e.add(v);const y=new w({color:855309,roughness:.9}),S=[14673130,789516,16777215];[[-.95,s,1.35],[.95,s,1.35],[-.95,s,-1.35],[.95,s,-1.35]].forEach(Z=>{const L=new g(new R(i,i,.35,14,1,!1),y);L.rotation.z=Math.PI/2,L.position.set(...Z),L.castShadow=!0;const j=new g(new x(.35,.12,.14),new w({color:273}));j.position.set(0,0,0),j.rotation.y=Math.PI/8,L.add(j);const O=new g(new R(i*.55,i*.55,.18,12),new w({color:S[Math.floor(Math.random()*S.length)],roughness:.45,metalness:.65}));O.rotation.z=Math.PI/2,O.position.set(0,0,0),L.add(O);const G=new g(new x(.05,i*1.2,.02),new w({color:16777215,emissive:8947848,emissiveIntensity:.6}));G.position.set(0,0,.18),L.add(G),e.add(L),e.userData.wheels.push(L)});const k=new w({color:16777130,emissive:16774557,emissiveIntensity:.8}),C=new w({color:16732754,emissive:16732754,emissiveIntensity:.6}),P=new g(new x(.25,.2,.1),k);P.position.set(-.75,.8,2.15),e.add(P);const B=P.clone();B.position.x=.75,e.add(B);const A=new g(new x(.25,.2,.1),C);A.position.set(-.75,.8,-2.15),e.add(A);const _=A.clone();_.position.x=.75,e.add(_)}else if(b==="truck"){const o=[1981023,15921906,1118481,9116186,15022389,15844367],n=t!==null?t:o[Math.floor(Math.random()*o.length)],a=new w({color:n,metalness:.55,roughness:.42}),l=new w({color:16119285,roughness:.7}),h=new w({color:2042416,roughness:.8}),r=new g(new x(2.6,1.1,5.2),a);r.position.y=1.05,r.castShadow=!0,e.add(r);const c=new g(new x(2.65,.18,5.25),l);c.position.set(0,1.1,0),e.add(c);const d=new g(new x(2.3,1.3,2.2),h);d.position.set(0,2.05,1.2),d.castShadow=!0,e.add(d);const f=new g(new x(2.35,.85,2.6),new w({color:8359053}));f.position.set(0,1.55,-1.55),f.castShadow=!0,e.add(f);const u=new w({color:1710618,transparent:!0,opacity:.7}),m=new g(new x(2,.7,.08),u);m.position.set(0,2.05,2.05),e.add(m);const p=new g(new x(.08,.6,1.2),u);p.position.set(-1.15,2.05,1.2),e.add(p);const v=p.clone();v.position.x=1.15,e.add(v);const y=new w({color:855309}),S=[14673130,789516,16777215];[[-1.1,.4,1.8],[1.1,.4,1.8],[-1.1,.4,-1.5],[1.1,.4,-1.5],[-1.1,.4,-2.2],[1.1,.4,-2.2]].forEach(Z=>{const L=new g(new R(i,i,.45,14,1,!1),y);L.rotation.z=Math.PI/2,L.position.set(...Z),L.castShadow=!0;const j=new g(new x(.4,.14,.16),new w({color:273}));j.rotation.y=Math.PI/8,L.add(j);const O=new g(new R(i*.55,i*.55,.2,12),new w({color:S[Math.floor(Math.random()*S.length)],roughness:.45,metalness:.65}));O.rotation.z=Math.PI/2,O.position.set(0,0,0),L.add(O);const G=new g(new x(.06,i*1.3,.025),new w({color:16777215,emissive:8947848,emissiveIntensity:.6}));G.position.set(0,0,.2),L.add(G),e.add(L),e.userData.wheels.push(L)});const k=new w({color:16776960,emissive:16776960,emissiveIntensity:.6}),C=new w({color:16732754,emissive:16732754,emissiveIntensity:.5}),P=new g(new x(.28,.22,.12),k);P.position.set(-.95,1.85,2.35),e.add(P);const B=P.clone();B.position.x=.95,e.add(B);const A=new g(new x(.28,.22,.12),C);A.position.set(-.95,1.2,-2.55),e.add(A);const _=A.clone();_.position.x=.95,e.add(_)}return e}function Ht(){const b=new T,t=new w({color:2899536,roughness:.3,metalness:.8}),e=new w({color:2171169,roughness:.8}),i=new w({color:15528177,roughness:.1,metalness:.9}),s=new w({color:9127187,roughness:.7}),o=new g(new x(.4,.3,1.8),t);o.position.y=.8,o.castShadow=!0,b.add(o);const n=new g(new x(.5,.5,.7),i);n.position.set(0,.6,.2),n.castShadow=!0,b.add(n);const a=new R(.5,.5,.2,16),l=new g(a,e);l.rotation.z=Math.PI/2,l.position.set(0,.5,1.2),l.castShadow=!0,b.add(l);const h=new R(.6,.6,.25,16),r=new g(h,e);r.rotation.z=Math.PI/2,r.position.set(0,.6,-.8),r.castShadow=!0,b.add(r);const c=new g(new x(.15,.8,.15),i);c.position.set(0,.9,1.2),c.rotation.x=-.3,c.castShadow=!0,b.add(c);const d=new g(new x(1,.1,.1),i);d.position.set(0,1.3,1.1),b.add(d),[-.45,.45].forEach(y=>{const S=new g(new R(.08,.08,.2,8),t);S.rotation.z=Math.PI/2,S.position.set(y,1.3,1.1),b.add(S)});const f=new g(new x(.5,.15,.8),s);f.position.set(0,1.1,-.2),f.castShadow=!0,b.add(f);const u=new g(new x(.45,.4,.6),t);u.position.set(0,1,.5),u.castShadow=!0,b.add(u);const m=new g(new xe(.15,8,8),new w({color:16777164,emissive:16777164,emissiveIntensity:.3}));m.position.set(0,1.1,1.3),b.add(m);const p=new g(new x(.3,.1,.05),new w({color:16711680,emissive:16711680,emissiveIntensity:.4}));p.position.set(0,1,-1.1),b.add(p);const v=new g(new R(.08,.1,.8,8),i);return v.rotation.x=Math.PI/2,v.position.set(.3,.5,-.3),v.castShadow=!0,b.add(v),b.userData={seatPosition:new I(0,1.2,-.2),vehicleType:"motorcycle",mountable:!0},b}const Ce=400;class Rt{constructor(t,e,i){this.scene=t,this.itemManager=e,this.objects=[],this.gameMode=i&&i.gameMode?i.gameMode:"arcade",this.gameMode==="arena"?this.mapSize=150:this.mapSize=i&&i.mapSize?i.mapSize:Ce,this.halfMapSize=this.mapSize/2,this.stormRadius=this.halfMapSize,this.initialStormRadius=this.stormRadius,this._heightFn=this._buildHeightFn(),this.stormEnabled=i&&i.stormEnabled!==!1;const s=i?i.stormTime:180;this.stormShrinkRate=this.stormRadius/s,this.safeZoneCenter=new I(0,0,0),this.init()}init(){this.gameMode==="arena"?this.createArenaEnvironment():this.gameMode==="matrix"?this.createMatrixEnvironment():this.gameMode==="matrix-ai"?this.createMatrixAIEnvironment():this.gameMode==="multiplayer"?this.createMultiplayerEnvironment():this.gameMode==="studio"?this.createStudioEnvironment():this.gameMode==="survival"?this.createSurvivalEnvironment():this.createEnvironment(),this.gameMode!=="matrix"&&this.gameMode!=="studio"&&this.stormEnabled&&this.createStormVisuals()}createEnvironment(){const t=(u=1)=>(Math.random()-.5)*(this.mapSize*u),e=(u=1)=>{const m=this.halfMapSize-5,p=t(u);return Math.max(-m,Math.min(m,p))},i=(u=1,m=12)=>{let p,v,y=0;do p=e(u),v=e(u),y++;while(p*p+v*v<m*m&&y<20);return{x:p,z:v}},s=(u,m)=>this.getHeightAt?this.getHeightAt(u,m):0,o={trees:70,rocks:50,bushes:50,grass:180,houses:12,vehicles:12,plateaus:4,smallBuildings:5},n=new U(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let u=0;u<a.count;u++)a.setZ(u,0);a.needsUpdate=!0;const l=n.attributes.position.count;n.setAttribute("color",new ke(new Float32Array(l*3),3));const h=n.attributes.color,r=new oe;for(let u=0;u<l;u++){const m=Math.random();m>.8?r.setHex(2600544):m>.4?r.setHex(3066993):r.setHex(5822093),h.setXYZ(u,r.r,r.g,r.b)}const c=new w({vertexColors:!0,roughness:.8}),d=new g(n,c);d.rotation.x=-Math.PI/2,d.receiveShadow=!0,d.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(d),this.objects.push(d);for(let u=0;u<o.trees;u++){const{x:m,z:p}=i(.9),v=s(m,p),y=Math.random()>.5?"Oak":"Pine",S=this.createTree(m,p,y);S.position.y=v,S.userData={gameId:this.generateID(),gameName:`Tree_${y}`,type:"tree"},this.scene.add(S),this.objects.push(S)}const f=[(u,m)=>this.createRock(u,m),(u,m,p)=>this.createRockPillar(u,m,p),(u,m,p)=>this.createFlatBoulder(u,m,p),(u,m,p)=>this.createCrystalShard(u,m,p),(u,m,p)=>this.createStackedRock(u,m,p),(u,m,p)=>this.createBasaltCluster(u,m,p)];for(let u=0;u<o.rocks;u++){const{x:m,z:p}=i(.9),v=s(m,p),y=f[u%f.length],S=y(m,p,v);S.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(S),this.objects.push(S)}for(let u=0;u<o.bushes;u++){const{x:m,z:p}=i(.85),v=s(m,p),y=this.createBush(m,p);y.position.y=v,y.userData={gameId:this.generateID(),gameName:"Bush"},this.scene.add(y),this.objects.push(y)}for(let u=0;u<o.grass;u++){const{x:m,z:p}=i(.95),v=s(m,p),y=this.createGrassClump(m,p);y.position.y=v,this.scene.add(y)}for(let u=0;u<o.houses;u++){const{x:m,z:p}=i(.75,20),v=s(m,p),y=Math.random(),S=y>.7,E=y<.25,k=S?1.55:E?.9:1,C=S?"Mansion":E?"Cabin":"House",P=S?"large":E?"small":"medium",B=this.createHouse(m,p,{scale:k});B.position.y=v,B.userData={gameId:this.generateID(),gameName:C,type:"house",size:P},this.scene.add(B),this.objects.push(B),this.itemManager.spawnLootInHouse(m,1,p)}for(let u=0;u<o.vehicles;u++){const{x:m,z:p}=i(.8),v=s(m,p),y=Math.random()>.6?"truck":"car",S=this.createVehicle(m,p,y);S.position.y=v,S.userData={...S.userData||{},gameId:this.generateID(),gameName:`Vehicle_${y}`,type:"vehicle"},this.scene.add(S),this.objects.push(S)}for(let u=0;u<o.plateaus;u++){const{x:m,z:p}=i(.6,25),v=6+Math.random()*6,y=8+Math.random()*6,S=s(m,p),E=this.createPlateau(m,p,y,v,S);E.userData={gameId:this.generateID(),gameName:"Plateau",type:"house"},this.scene.add(E),this.objects.push(E)}for(let u=0;u<o.smallBuildings;u++){const{x:m,z:p}=i(.7,18),v=s(m,p),y=this.createSmallBuilding(m,p);y.position.y=v,y.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"},this.scene.add(y),this.objects.push(y)}}createSurvivalEnvironment(){const t=(u=1)=>(Math.random()-.5)*(this.mapSize*u),e=(u=1)=>{const m=this.halfMapSize-5,p=t(u);return Math.max(-m,Math.min(m,p))},i=(u=1,m=12)=>{let p,v,y=0;do p=e(u),v=e(u),y++;while(p*p+v*v<m*m&&y<20);return{x:p,z:v}},s=(u,m)=>this.getHeightAt?this.getHeightAt(u,m):0,o={trees:90,rocks:60,bushes:80,grass:250},n=new U(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let u=0;u<a.count;u++)a.setZ(u,0);a.needsUpdate=!0;const l=n.attributes.position.count;n.setAttribute("color",new ke(new Float32Array(l*3),3));const h=n.attributes.color,r=new oe;for(let u=0;u<l;u++){const m=Math.random();m>.8?r.setHex(2600544):m>.4?r.setHex(3066993):r.setHex(5822093),h.setXYZ(u,r.r,r.g,r.b)}const c=new w({vertexColors:!0,roughness:.8}),d=new g(n,c);d.rotation.x=-Math.PI/2,d.receiveShadow=!0,d.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(d),this.objects.push(d);for(let u=0;u<o.trees;u++){const{x:m,z:p}=i(.9),v=s(m,p),y=Math.random()>.5?"Oak":"Pine",S=this.createTree(m,p,y);S.position.y=v,S.userData={gameId:this.generateID(),gameName:`Tree_${y}`,type:"tree"},this.scene.add(S),this.objects.push(S)}const f=[(u,m)=>this.createRock(u,m),(u,m,p)=>this.createRockPillar(u,m,p),(u,m,p)=>this.createFlatBoulder(u,m,p),(u,m,p)=>this.createCrystalShard(u,m,p),(u,m,p)=>this.createStackedRock(u,m,p),(u,m,p)=>this.createBasaltCluster(u,m,p)];for(let u=0;u<o.rocks;u++){const{x:m,z:p}=i(.9),v=s(m,p),y=f[u%f.length],S=y(m,p,v);S.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(S),this.objects.push(S)}for(let u=0;u<o.bushes;u++){const{x:m,z:p}=i(.85),v=s(m,p),y=this.createBush(m,p);y.position.y=v,y.userData={gameId:this.generateID(),gameName:"Bush"},this.scene.add(y),this.objects.push(y)}for(let u=0;u<o.grass;u++){const{x:m,z:p}=i(.95),v=s(m,p),y=this.createGrassClump(m,p);y.position.y=v,this.scene.add(y)}}createArenaEnvironment(){const t=(n=1)=>(Math.random()-.5)*(this.mapSize*n),e=(n=1)=>{const a=this.halfMapSize-5,l=t(n);return Math.max(-a,Math.min(a,l))},i=new U(this.mapSize,this.mapSize,1,1),s=new ye({color:3885915,flatShading:!0}),o=new g(i,s);o.rotation.x=-Math.PI/2,o.receiveShadow=!0,o.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(o),this.objects.push(o);for(let n=0;n<30;n++){const a=e(.8),l=e(.8),h=1+Math.random()*3,r=1+Math.random()*2,c=1+Math.random()*2,d=new x(r,h,c),f=new ye({color:5596791,flatShading:!0}),u=new g(d,f);u.position.set(a,h/2,l),u.castShadow=!0,u.receiveShadow=!0,u.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},this.scene.add(u),this.objects.push(u)}for(let n=0;n<6;n++){const a=e(.7),l=e(.7),h=6+Math.random()*3,r=3+Math.random()*2,c=3,d=new x(c,r,h),f=new ye({color:4937059,flatShading:!0}),u=new g(d,f);u.position.set(a,r/2,l),u.rotation.x=-Math.atan(r/h),u.castShadow=!0,u.receiveShadow=!0,u.userData={gameId:this.generateID(),gameName:"Ramp",type:"house"},this.scene.add(u),this.objects.push(u)}for(let n=0;n<6;n++){const a=e(.6),l=e(.6),h=this.createArenaBunker(a,l);h.userData={gameId:this.generateID(),gameName:"Bunker",type:"house"},this.scene.add(h),this.objects.push(h)}for(let n=0;n<20;n++){const a=e(.8),l=e(.8),h=this.createFlatBoulder(a,l,0);h.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(h),this.objects.push(h)}this.itemManager.spawnLootInHouse(0,0,0)}createMatrixEnvironment(){const t=new U(this.mapSize,this.mapSize,128,128),e=t.attributes.position.count;t.setAttribute("color",new ke(new Float32Array(e*3),3));const i=t.attributes.color,s=new oe;for(let d=0;d<e;d++){const f=Math.random();f>.8?s.setHex(2600544):f>.4?s.setHex(3066993):s.setHex(5822093),i.setXYZ(d,s.r,s.g,s.b)}const o=new w({vertexColors:!0,roughness:.8}),n=new g(t,o);n.rotation.x=-Math.PI/2,n.receiveShadow=!0,n.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(n),this.objects.push(n);const a=new x(20,6,.5),l=new w({color:15987699,roughness:.9}),h=new g(a,l);h.position.set(0,3,-15),h.castShadow=!0,h.receiveShadow=!0,h.userData={gameId:this.generateID(),gameName:"Wall",type:"house"},this.scene.add(h),this.objects.push(h);const r=this.createTree(-12,-15,"Oak"),c=this.createTree(12,-15,"Pine");this.scene.add(r),this.scene.add(c),this.objects.push(r),this.objects.push(c)}createStudioEnvironment(){const t=new U(this.mapSize,this.mapSize,128,128),e=this.buildVoxelGroundMaterial(),i=new g(t,e);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(i),this.objects.push(i);const s=12;for(let o=0;o<s;o++){const n=(Math.random()-.5)*this.mapSize*.6,a=(Math.random()-.5)*this.mapSize*.6,l=this.createVoxelCloud(n,a);this.scene.add(l)}}createMatrixAIEnvironment(){const t=this.mapSize,e=80,i=new Je(t,e,16777215,16777215);(Array.isArray(i.material)?i.material:[i.material]).forEach(l=>{l.opacity=.3,l.transparent=!0,l.depthWrite=!1}),i.position.y=.02,this.scene.add(i);const o=new U(t,t,1,1),n=new Me({visible:!1}),a=new g(o,n);a.rotation.x=-Math.PI/2,a.userData={gameId:this.generateID(),gameName:"Ground",type:"ground"},this.scene.add(a),this.objects.push(a)}createMultiplayerEnvironment(){const t=new U(this.mapSize,this.mapSize,128,128),e=this.buildVoxelGroundMaterial(),i=new g(t,e);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(i),this.objects.push(i),this.stormEnabled=!1}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}createTree(t,e,i){const s=i==="Oak"?Bt():It();return s.position.set(t,0,e),s}createVoxelCloud(t,e){const i=new T,s=new x(3,2,3),o=new Ze({color:15922943,transparent:!0,opacity:.9}),n=8+Math.floor(Math.random()*6);for(let a=0;a<n;a++){const l=(Math.random()-.5)*12,h=(Math.random()-.5)*12,r=(Math.random()-.5)*2,c=new g(s,o);c.position.set(l,r,h),c.castShadow=!1,c.receiveShadow=!1,i.add(c)}return i.position.set(t,30+Math.random()*8,e),i}buildVoxelGroundMaterial(){const e=document.createElement("canvas");e.width=64,e.height=64;const i=e.getContext("2d"),s="#4caf50",o="#66bb6a",n="#8d6e63",a=8;for(let c=0;c<64;c+=a)for(let d=0;d<64;d+=a){const u=Math.random()>.85?n:(d/a+c/a)%2===0?s:o;i.fillStyle=u,i.fillRect(d,c,a,a)}const l=i.getImageData(0,0,64,64),h=l.data;for(let c=0;c<h.length;c+=4){const d=Math.random()*30-15;h[c]=Math.min(255,Math.max(0,h[c]+d)),h[c+1]=Math.min(255,Math.max(0,h[c+1]+d)),h[c+2]=Math.min(255,Math.max(0,h[c+2]+d))}i.putImageData(l,0,0);const r=new Qe(e);return r.wrapS=r.wrapT=et,r.repeat.set(this.mapSize/10,this.mapSize/10),r.magFilter=tt,r.minFilter=it,new w({map:r,roughness:1,metalness:0})}createRock(t,e,i=0){const s=Pt(t,e,i);return this._tagStaticCollider(s,"rock"),s}createRockPillar(t,e,i=0){const s=At(t,e,i);return this._tagStaticCollider(s,"rock"),s}createFlatBoulder(t,e,i=0){const s=Tt(t,e,i);return this._tagStaticCollider(s,"rock"),s}createCrystalShard(t,e,i=0){return zt(t,e,i)}createStackedRock(t,e,i=0){const s=new T,o=this.createRock(0,0,0);s.add(o);const n=this.createRock(0,0);n.scale.set(.6,.6,.6),n.position.set(.3,n.position.y+.9,-.2),s.add(n);const a=this.createRock(0,0);return a.scale.set(.4,.4,.4),a.position.set(-.2,a.position.y+1.5,.3),s.add(a),s.position.set(t,i,e),s.traverse(l=>{l.castShadow=!0,l.receiveShadow=!0}),this._tagStaticCollider(s,"rock"),s}createBasaltCluster(t,e,i=0){const s=Lt(t,e,i);return this._tagStaticCollider(s,"rock"),s}createVehicle(t,e,i="car"){let s;return i==="bus"?s=Mt():i==="motorcycle"?s=Ht():s=_t(i),s.position.set(t,0,e),s}createBush(t,e){const i=new T;i.position.set(t,0,e);const s=new w({color:2924588,roughness:1}),o=2+Math.floor(Math.random()*3);for(let n=0;n<o;n++){const a=1.2+Math.random()*1,l=new g(new xe(a,6,6),s);l.position.set((Math.random()-.5)*1.2,a*.65,(Math.random()-.5)*1.2),l.castShadow=!0,i.add(l)}return i}createGrassClump(t,e){const i=new T;i.position.set(t,0,e);const s=3+Math.floor(Math.random()*4);for(let o=0;o<s;o++){const n=.2+Math.random()*.6,a=new U(.05,n),l=new w({color:5620331,side:Ee}),h=new g(a,l);h.position.y=n/2,h.rotation.y=Math.random()*Math.PI,h.rotation.z=(Math.random()-.5)*.6,h.receiveShadow=!0,i.add(h)}return i}createHouse(t,e,{scale:i=1}={}){const s=new T;s.position.set(t,0,e),s.rotation.y=Math.random()*Math.PI*2;const o=new w({color:9807270}),n=new w({color:12597547});[{w:6,h:4,d:.5,x:0,y:2,z:-3},{w:.5,h:4,d:6,x:-3,y:2,z:0},{w:.5,h:4,d:6,x:3,y:2,z:0},{w:2,h:4,d:.5,x:-2,y:2,z:3},{w:2,h:4,d:.5,x:2,y:2,z:3},{w:2,h:1,d:.5,x:0,y:3.5,z:3}].forEach(u=>{const m=new g(new x(u.w,u.h,u.d),o);m.position.set(u.x,u.y,u.z),m.castShadow=!0,m.receiveShadow=!0,s.add(m),this.objects.push(m)});const l=new g(new De(5,2,4),n);l.position.y=5,l.rotation.y=Math.PI/4,l.castShadow=!0,s.add(l);const h=new w({color:5057307}),r=new g(new x(1,2.2,.1),h);r.position.set(0,1.1,3.26),s.add(r);const c=new w({color:8962303,metalness:.1,roughness:.2,transparent:!0,opacity:.8}),d=new g(new x(1,1,.05),c);d.position.set(-2,2.2,-3.26);const f=d.clone();return f.position.set(2,2.2,-3.26),s.add(d),s.add(f),s.scale.setScalar(i),s}createPlateau(t,e,i=10,s=8,o=0){const n=new T,a=new w({color:8355711,roughness:1}),l=new g(new R(i,i*1.05,s,16,1),a);l.position.set(0,s/2,0),l.castShadow=!0,l.receiveShadow=!0,n.add(l);const h=i*1.4,r=s,c=i*.8,d=new x(c,r,h),f=new g(d,new w({color:9342606,roughness:1}));f.castShadow=!0,f.receiveShadow=!0;const u=Math.atan(r/h);f.rotation.x=-u,f.position.set(0,r/2,i),f.userData={type:"house"},n.add(f);const m=new x(c,.2,h),p=new g(m,new w({color:7105644}));return p.position.set(0,r,i),p.rotation.x=f.rotation.x,p.castShadow=!0,n.add(p),n.position.set(t,o,e),n.userData={type:"house"},n}createSmallBuilding(t,e){const i=new T;i.position.set(t,0,e),i.rotation.y=Math.random()*Math.PI*2;const s=new w({color:8359053}),o=new w({color:12436423}),n=8,a=8,l=6,h=.35,r=2.2,c=n/2,d=a/2,f=new g(new x(n,l,h),s);f.position.set(0,l/2,-d);const u=new g(new x(h,l,a),s);u.position.set(-c,l/2,0);const m=u.clone();m.position.x=c;const p=new g(new x((n-r)/2,l,h),s);p.position.set(-2.55,l/2,d);const v=p.clone();v.position.x=r/2+(n-r)/4,[f,u,m,p,v].forEach(A=>{A.castShadow=!0,A.receiveShadow=!0,i.add(A)});const y=new g(new x(n-.4,.3,a-.4),o);y.position.y=.15,y.receiveShadow=!0,i.add(y);const S=new g(new x(n-.4,.3,a-.4),o);S.position.y=3.4,S.receiveShadow=!0,i.add(S);const E=S.position.y,k=10,C=new x(3,E,k),P=new g(C,o);P.position.set(0,E/2,d+k/2),P.rotation.x=-Math.atan(E/k),P.castShadow=!0,P.receiveShadow=!0,i.add(P);const B=new g(new x(n+.4,.4,a+.4),new w({color:9807270}));return B.position.y=l+.2,B.castShadow=!0,i.add(B),i}spawnPrefab(t,e,i,s={}){const o=this.getHeightAt&&typeof this.getHeightAt=="function"?this.getHeightAt(e,i):0;let n=null;switch(t){case"house":{n=this.createHouse(e,i,{scale:1}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"House",type:"house"};break}case"mansion":{n=this.createHouse(e,i,{scale:1.6}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Mansion",type:"house",size:"large"};break}case"cabin":{n=this.createHouse(e,i,{scale:.85}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Cabin",type:"house",size:"small"};break}case"smallBuilding":{n=this.createSmallBuilding(e,i),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"};break}case"plateau":{const a=this.createPlateau(e,i,10+Math.random()*6,8+Math.random()*6,o);a.userData={gameId:this.generateID(),gameName:"Plateau",type:"house",size:"large"},n=a;break}case"rock":{n=this.createRock(e,i),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"};break}case"tree":{const a=s.variant||(Math.random()>.5?"Oak":"Pine");n=this.createTree(e,i,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Tree_${a}`,type:"tree"};break}case"vehicle":{const a=s.variant||(Math.random()>.6?"truck":"car");n=this.createVehicle(e,i,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Vehicle_${a}`,type:"vehicle"};break}case"crate":{const a=new g(new x(2,2,2),new w({color:9342606,roughness:.9}));a.position.set(e,o+1,i),a.castShadow=!0,a.receiveShadow=!0,a.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},n=a;break}}return n&&(this.scene.add(n),this.objects.push(n)),n}createArenaBunker(t,e){const i=new T;i.position.set(t,0,e),i.rotation.y=Math.random()*Math.PI*2;const s=new ye({color:4937059,flatShading:!0}),o=new ye({color:6253691,flatShading:!0}),n=new g(new x(6,2.5,6),s);n.position.y=1.25,n.castShadow=!0,n.receiveShadow=!0,i.add(n);const a=new g(new x(6.2,.3,6.2),o);a.position.y=2.65,a.castShadow=!0,i.add(a);const l=new g(new x(1.2,1.8,.2),new ye({color:9280168,flatShading:!0,transparent:!0,opacity:.2}));l.position.set(0,.9,3.1),i.add(l);const h=new x(2,1.2,4),r=new g(h,o);return r.position.set(-2.5,.6,-1),r.rotation.x=-Math.atan(1.2/4),r.castShadow=!0,r.receiveShadow=!0,r.userData={type:"house"},i.add(r),i}createStormVisuals(){if(this.gameMode==="matrix")return;const t=new R(this.stormRadius,this.stormRadius,50,32,1,!0),e=new Me({color:9323693,transparent:!0,opacity:.3,side:Ee});this.stormMesh=new g(t,e),this.stormMesh.position.y=25,this.scene.add(this.stormMesh)}createTarget(t,e){const i=new T;i.position.set(t,0,e);const s=new g(new R(.05,.05,2,6),new w({color:8947848}));s.position.y=1,i.add(s);const o=new Ae(.8,24),n=new w({color:16777215}),a=new g(o,n);a.position.set(0,2,0),a.rotation.y=Math.PI,i.add(a);const l=new w({color:16729156}),h=new w({color:15844367}),r=new w({color:3447003}),c=(f,u)=>{const m=new g(new st(f,.02,6,24),u);return m.rotation.x=Math.PI/2,m.position.y=2,m};i.add(c(.75,r)),i.add(c(.55,l)),i.add(c(.35,h));const d=new g(new Ae(.1,12),new w({color:0}));return d.position.set(0,2.01,0),d.rotation.y=Math.PI,i.add(d),i.userData={gameId:this.generateID(),gameName:"Target",type:"house"},i}update(t,e){if(this.gameMode==="matrix"||this.gameMode==="studio"||this.gameMode==="matrix-ai")return{inStorm:!1};if(this.stormEnabled===!1)return{inStorm:!1};if(this.stormRadius>10){this.stormRadius-=this.stormShrinkRate*t;const s=this.initialStormRadius?this.stormRadius/this.initialStormRadius:1;this.stormMesh&&this.stormMesh.scale&&this.stormMesh.scale.set(s,1,s)}return{inStorm:Math.sqrt(e.x*e.x+e.z*e.z)>this.stormRadius}}_buildHeightFn(){return()=>0}_tagStaticCollider(t,e=null){if(!t)return;t.updateWorldMatrix(!0,!0);const i=new Ge().setFromObject(t);t.userData=t.userData||{},e&&!t.userData.type&&(t.userData.type=e),t.userData.colliderBox=i,t.userData.colliderType="solid"}getHeightAt(t,e){return this._heightFn?this._heightFn(t,e):0}}const we=new We(0,0,0,"YXZ"),ve=new I,Ft={type:"change"},Ot={type:"lock"},jt={type:"unlock"},Ne=Math.PI/2;class Nt extends ot{constructor(t,e){super(),this.camera=t,this.domElement=e,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=Vt.bind(this),this._onPointerlockChange=Gt.bind(this),this._onPointerlockError=Wt.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(t){return t.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(t){const e=this.camera;ve.setFromMatrixColumn(e.matrix,0),ve.crossVectors(e.up,ve),e.position.addScaledVector(ve,t)}moveRight(t){const e=this.camera;ve.setFromMatrixColumn(e.matrix,0),e.position.addScaledVector(ve,t)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function Vt(b){if(this.isLocked===!1)return;const t=b.movementX||b.mozMovementX||b.webkitMovementX||0,e=b.movementY||b.mozMovementY||b.webkitMovementY||0,i=this.camera;we.setFromQuaternion(i.quaternion),we.y-=t*.002*this.pointerSpeed,we.x-=e*.002*this.pointerSpeed,we.x=Math.max(Ne-this.maxPolarAngle,Math.min(Ne-this.minPolarAngle,we.x)),i.quaternion.setFromEuler(we),this.dispatchEvent(Ft)}function Gt(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(Ot),this.isLocked=!0):(this.dispatchEvent(jt),this.isLocked=!1)}function Wt(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}const Ut="/threejs-voxel-firecraft/dist/assets/mixkit-game-gun-shot-D1lu3gfh.ogg",Yt="/threejs-voxel-firecraft/dist/assets/smack-BAv2er9i.ogg",$t="/threejs-voxel-firecraft/dist/assets/ugh-CPf3Qqe6.ogg",Xt="/threejs-voxel-firecraft/dist/assets/mixkit-footsteps-on-tall-grass-532-DkmduvPT.ogg",qt="/threejs-voxel-firecraft/dist/assets/mixkit-car-door-slam-xN3cwxzE.wav";class Te{constructor(t,e,i,s={}){this.camera=t,this.scene=e,this.worldObjects=i,this.world=null,this.hud=null,this.gameMode=s.gameMode||"arcade",this.showTracers=s.showTracers===!0,this.backpack=null,this.backpackColor=null,this.placedBlocks=[],this.blockSize=1,this.minBlockSize=.5,this.maxBlockSize=2,this.previewBlock=null,this.isFloating=!1,this.selectedBlock=null,this.selectedBlockHelper=null,this.health=100,this.shield=100,this.isDead=!1,this.stamina=100,this.punchCount=0,this.isTired=!1,this.velocity=new I,this.direction=new I,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.isSprinting=!1,this.canJump=!1,this.speed=42,this.jumpHeight=16,this.gravity=65,this.mouthStyle=s&&s.mouthStyle?s.mouthStyle:"serious",this.mouthMesh=null,this.mouthStyles=["serious","smile","angry","surprised","none"],this.showHat=s&&typeof s.showHat<"u"?s.showHat:!0,this.hatMeshes=[],this.distanceTraveled=0,this.previousPosition=new I,this.allWeapons=[{name:"Pistol",ammo:12,maxAmmo:60,magazineSize:12,currentMag:12,damage:20,cooldown:.5,lastShot:0,reloadTime:1.5,range:50},{name:"Fist",ammo:1/0,maxAmmo:1/0,magazineSize:1/0,currentMag:1/0,damage:10,cooldown:.2,lastShot:0,reloadTime:0,range:3},{name:"Rifle",ammo:30,maxAmmo:120,magazineSize:30,currentMag:30,damage:25,cooldown:.15,lastShot:0,reloadTime:2,range:120,zoomFov:30},{name:"Sniper",ammo:5,maxAmmo:20,magazineSize:5,currentMag:5,damage:100,cooldown:2,lastShot:0,reloadTime:3,range:400,zoomFov:12},{name:"SMG",ammo:40,maxAmmo:200,magazineSize:40,currentMag:40,damage:15,cooldown:.08,lastShot:0,reloadTime:1.8,range:80},{name:"Shotgun",ammo:6,maxAmmo:24,magazineSize:6,currentMag:6,damage:60,cooldown:1,lastShot:0,reloadTime:2.5,range:25},{name:"DMR",ammo:12,maxAmmo:48,magazineSize:12,currentMag:12,damage:45,cooldown:.35,lastShot:0,reloadTime:2.2,range:200,zoomFov:18}],this.gameMode==="matrix-ai"?this.weapons=[this.allWeapons[1]]:this.weapons=[this.allWeapons[1],this.allWeapons[0]],this.currentWeaponIndex=0,this.isReloading=!1,this.controls=new Nt(t,document.body),document.addEventListener("pointerlockerror",o=>{try{o.stopImmediatePropagation()}catch{}console.warn("Pointer lock request failed or unavailable in this environment.")},!0),this.allowTouchMovement=!1,this._touchYaw=0,this._touchPitch=0,document.addEventListener("fullscreenchange",()=>{document.fullscreenElement&&document.exitFullscreen().catch(()=>{})}),this.createPlayerMesh(),this.cameraMode=s.cameraMode||"TPS",this.fpsCameraOffset=new I(0,1.6,0),this.tpsCameraOffset=new I(1,1.8,3.4),this.initControls(),this.sfxVolume=.7,this.sfxVolume=.7,this.gunshotBuffer=null,this.reloadBuffer=null,this.smackBuffer=null,this.ughBuffer=null,this.footstepsBuffer=null,this._footstepsSource=null,this._footstepsGain=null,this.vehicleDoorBuffer=null,this.vehicleDriveBuffer=null,this._vehicleDriveSource=null,this._vehicleDriveGain=null,this._lastVehicleDriveActive=!1,this.enableVehicleDriveSound=!1,this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer=null,this._lastFootstepsActive=!1,this.isCrouching=!1,this.crouchHeight=.8,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.vehicleBaseMaxSpeed=70,this.vehicleBoostMax=45,this.vehicleAccel=70,this.vehicleTurnSpeed=1.8,this.vehicleFriction=2.8,this.vehicleAccelHold=0,this.vehiclePromptEl=document.getElementById("interaction-prompt"),this.nearVehicle=null,this.vehicleFuel=0,this.vehicleFuelCapacity=0,this.vehicleDistance=0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=0,this.vehicleEfficiencyKmPerL=10,this.vehicleIdleLph=.4,this.vehicleThrottleLph=.8,this._vehicleStateCache=null,this.vehicleTurbo=!1,this.currentSpeed=0,this.vehicleHud={root:document.getElementById("vehicle-hud"),speed:document.getElementById("vehicle-speed"),fuelBar:document.getElementById("vehicle-fuel-bar"),fuelFill:document.getElementById("vehicle-fuel-fill"),fuelText:document.getElementById("vehicle-fuel-text"),distance:document.getElementById("vehicle-distance"),efficiency:document.getElementById("vehicle-efficiency"),range:document.getElementById("vehicle-range")},this.studioSelected=null,this._studioRaycaster=new J,this.studioSelectionHelper=null,this.selectionInfo=document.getElementById("selection-info"),this.controls.enabled=this.gameMode!=="studio";try{const o=window.AudioContext||window.webkitAudioContext;o&&(this.audioCtx=new o,fetch(Ut).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.gunshotBuffer=n}).catch(n=>console.warn("Error loading gunshot SFX:",n)),xt(()=>import("./mixkit-shotgun-recharge-CcrH8C2K.js"),[]).then(n=>fetch(n.default)).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.reloadBuffer=n}).catch(n=>console.warn("Error loading reload SFX:",n)),fetch(Yt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.smackBuffer=n}).catch(n=>console.warn("Error loading smack SFX:",n)),fetch($t).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.ughBuffer=n}).catch(n=>console.warn("Error loading hurt SFX:",n)),fetch(Xt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.footstepsBuffer=n}).catch(n=>console.warn("Error loading footsteps SFX:",n)),fetch(qt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.vehicleDoorBuffer=n}).catch(n=>console.warn("Error loading vehicle door SFX:",n)))}catch(o){console.warn("Web Audio API not supported:",o)}}separateFromRemotePlayers(){if(!this.multiplayerClient||!this.multiplayerClient.others||this.multiplayerClient.others.size===0)return;const e=.6*2,i=this.mesh.position;this.multiplayerClient.others.forEach(s=>{if(!s||!s.position||s.userData&&s.userData.dead)return;const o=i.x-s.position.x,n=i.z-s.position.z,a=o*o+n*n;if(a<e*e&&a>1e-4){const l=Math.sqrt(a),h=(e-l)*.5,r=o/l,c=n/l;i.x+=r*h,i.z+=c*h}})}placeBlock(){if(!this.world)return;const t=this.getBlockTarget(),e=t.size,i=new x(e,e,e),s=new w({color:11887901,roughness:.9}),o=new g(i,s);o.position.copy(t.position),o.castShadow=!0,o.receiveShadow=!0,o.userData={type:"block",size:e,gameId:this.world.generateID?this.world.generateID():void 0,gameName:"Block"},this.scene.add(o),this.world.objects&&this.world.objects.push(o),this.placedBlocks.push(o)}createPlayerMesh(){this.mesh=new T,this.scene.add(this.mesh);const t=this.playerColor||3447003,e=new w({color:t}),i=new w({color:16764074}),s=new w({color:2899536});this.head=new g(new x(.5,.5,.5),i),this.head.position.y=1.75,this.head.name="playerHead",this.head.userData={role:"playerHead"},this.mesh.add(this.head);const o=new w({color:15158332}),n=new g(new x(.52,.1,.52),o);n.position.set(0,.3,0),n.userData={role:"playerHat"},n.name="playerHatCap",this.head.add(n);const a=new g(new x(.52,.02,.35),o);a.position.set(0,.22,.35),a.userData={role:"playerHat"},a.name="playerHatBrim",this.head.add(a),this.hatMeshes=[n,a],this.setHatVisible(this.showHat);const l=new w({color:0}),h=new w({color:1710618,transparent:!0,opacity:.7,metalness:.8,roughness:.2}),r=new g(new x(.18,.12,.02),h);r.position.set(-.12,.05,.26),this.head.add(r);const c=new g(new x(.18,.12,.02),h);c.position.set(.12,.05,.26),this.head.add(c);const d=new g(new x(.08,.02,.02),l);d.position.set(0,.05,.26),this.head.add(d);const f=new g(new x(.02,.02,.3),l);f.position.set(-.21,.05,.1),this.head.add(f);const u=new g(new x(.02,.02,.3),l);u.position.set(.21,.05,.1),this.head.add(u),this.createMouth(this.mouthStyle);const m=new g(new x(.6,.8,.3),e);m.position.y=1.1,this.mesh.add(m);const p=new x(.2,.8,.2);p.translate(0,-.3,0),this.leftArmPivot=new T,this.leftArmPivot.name="leftArmPivot",this.leftArmPivot.position.set(-.45,1.4,0),this.mesh.add(this.leftArmPivot);const v=new g(p,i);this.leftArmPivot.add(v),this.rightArmPivot=new T,this.rightArmPivot.name="rightArmPivot",this.rightArmPivot.position.set(.45,1.4,0),this.mesh.add(this.rightArmPivot);const y=new g(p,i);this.rightArmPivot.add(y),this.weaponModels={};const S=new T,E=new g(new x(.12,.12,.35),new w({color:1710618,metalness:.8,roughness:.3}));E.position.set(0,-.28,.2);const k=new g(new x(.06,.06,.15),new w({color:657930,metalness:.9,roughness:.2}));k.position.set(0,-.28,.4);const C=new g(new x(.1,.25,.12),new w({color:2894892}));C.position.set(0,-.42,.15);const P=new g(new x(.03,.05,.03),new w({color:1710618}));P.position.set(0,-.35,.18),S.add(E,k,C,P),this.rightArmPivot.add(S),this.weaponModels.Pistol=S;const B=new T,A=new g(new x(.08,.08,.9),new w({color:1710618,metalness:.8,roughness:.3}));A.position.set(0,-.28,.45);const _=new g(new x(.12,.14,.4),new w({color:2894892}));_.position.set(0,-.3,.2);const Z=new g(new x(.1,.22,.12),new w({color:2894892}));Z.position.set(0,-.44,.15);const L=new g(new x(.1,.12,.25),new w({color:3815994}));L.position.set(0,-.28,-.1);const j=new g(new x(.08,.25,.1),new w({color:1710618}));j.position.set(0,-.5,.2),B.add(A,_,Z,L,j),this.rightArmPivot.add(B),this.weaponModels.Rifle=B;const O=new T,G=new g(new x(.08,.08,1.3),new w({color:1727514,metalness:.6,roughness:.4}));G.position.set(0,-.28,.65);const te=new g(new x(.14,.16,.5),new w({color:2969622}));te.position.set(0,-.3,.25);const Q=new g(new R(.06,.06,.35,8),new w({color:657930,metalness:.9,roughness:.1}));Q.rotation.z=Math.PI/2,Q.position.set(0,-.18,.4);const W=new g(new R(.05,.05,.02,8),new w({color:1723791,metalness:.9,roughness:.1,emissive:663616}));W.rotation.z=Math.PI/2,W.position.set(0,-.18,.58);const re=new g(new x(.12,.14,.3),new w({color:3811866}));re.position.set(0,-.28,-.05);const ie=new g(new x(.02,.15,.02),new w({color:1710618}));ie.position.set(0,-.42,.5),O.add(G,te,Q,W,re,ie),this.rightArmPivot.add(O),this.weaponModels.Sniper=O,Object.values(this.weaponModels).forEach(H=>H.visible=!1);const $=B.clone();$.traverse(H=>{H.material&&H.material.color&&H.material.color.setHex(5598095)}),$.scale.set(.8,.8,.8),this.rightArmPivot.add($),this.weaponModels.SMG=$;const X=B.clone();X.traverse(H=>{H.material&&H.material.color&&H.material.color.setHex(9132587)}),X.scale.set(1.1,1,.8),this.rightArmPivot.add(X),this.weaponModels.Shotgun=X;const q=B.clone();q.traverse(H=>{H.material&&H.material.color&&H.material.color.setHex(3050327)}),q.scale.set(.95,.95,1),this.rightArmPivot.add(q),this.weaponModels.DMR=q;const ne=new x(this.blockSize,this.blockSize,this.blockSize),ae=new w({color:3066993,transparent:!0,opacity:.35,wireframe:!0});this.previewBlock=new g(ne,ae),this.previewBlock.visible=this.gameMode==="studio",this.previewBlock.castShadow=!1,this.previewBlock.receiveShadow=!1,this.scene.add(this.previewBlock);const se=new x(.25,.8,.25);se.translate(0,-.4,0),this.leftLegPivot=new T,this.leftLegPivot.name="leftLegPivot",this.leftLegPivot.position.set(-.15,.7,0),this.mesh.add(this.leftLegPivot);const ce=new g(se,s);this.leftLegPivot.add(ce),this.rightLegPivot=new T,this.rightLegPivot.name="rightLegPivot",this.rightLegPivot.position.set(.15,.7,0),this.mesh.add(this.rightLegPivot);const ee=new g(se,s);if(this.rightLegPivot.add(ee),this.isAiming=!1,this.baseFov=75,this.aimFov=20,this.hitTimer=0,this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.animTime=0,this.isPunching=!1,this.punchSide=0,this.isBlocking=!1,this.yaw=0,this.pitch=0,this.camera){const H=new We().setFromQuaternion(this.camera.quaternion,"YXZ");this.yaw=H.y,this.pitch=H.x}}rotateCamera(t,e){if(!this.controls||!this.controls.isLocked){this.yaw-=t,this.pitch-=e;const i=Math.PI/2-.01;this.pitch=Math.max(-i,Math.min(i,this.pitch)),this.camera.rotation.set(this.pitch,this.yaw,0,"YXZ")}}initControls(){const t=o=>{if(this.gameMode==="studio"&&this.studioSelected)switch(o.code){case"ArrowUp":o.shiftKey?this.moveSelectedObject(0,0,1.5):this.moveSelectedObject(0,-2),o.preventDefault();return;case"ArrowDown":o.shiftKey?this.moveSelectedObject(0,0,-1.5):this.moveSelectedObject(0,2),o.preventDefault();return;case"ArrowLeft":this.moveSelectedObject(-2,0),o.preventDefault();return;case"ArrowRight":this.moveSelectedObject(2,0),o.preventDefault();return;case"KeyX":this.removeSelectedObject(),o.preventDefault();return}switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"Space":this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"Digit1":this.switchWeapon(0);break;case"Digit2":this.switchWeapon(1);break;case"Digit3":this.switchWeapon(2);break;case"Digit4":this.switchWeapon(3);break;case"Digit5":this.switchWeapon(4);break;case"Digit6":this.switchWeapon(5);break;case"Numpad1":this.switchWeapon(0);break;case"Numpad2":this.switchWeapon(1);break;case"Numpad3":this.switchWeapon(2);break;case"Numpad4":this.switchWeapon(3);break;case"Numpad5":this.switchWeapon(4);break;case"Numpad6":this.switchWeapon(5);break;case"KeyB":this.gameMode==="studio"&&this.placeBlock();break;case"KeyU":if(this.gameMode==="studio"&&(this.isFloating=!this.isFloating,!this.isFloating)){const n=this.getSurfaceHeight(this.position.x,this.position.z);this.mesh.position.y=n,this.velocity.y=0}break;case"Minus":this.gameMode==="studio"&&this.adjustBlockSize(-.1);break;case"Equal":this.gameMode==="studio"&&this.adjustBlockSize(.1);break;case"KeyM":this.gameMode==="studio"&&this.moveLastBlock();break;case"KeyX":this.gameMode==="studio"&&(this.studioSelected?this.removeSelectedObject():this.selectedBlock?this.removeBlock(this.selectedBlock):this.removeLastBlock());break;case"KeyR":this.reload();break;case"KeyC":this.isCrouching=!this.isCrouching,this.isCrouching&&(this.isSprinting=!1);break;case"ShiftLeft":case"ShiftRight":this.isCrouching||(this.isSprinting=!0);break;case"Space":!this.isInVehicle&&this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"KeyN":this.isInVehicle&&(this.vehicleTurbo=!0);break;case"KeyV":this.toggleCameraMode();break;case"KeyE":if(this.isInVehicle){this.exitVehicle();return}else{const n=this.findNearbyVehicle();if(n){this.enterVehicle(n);return}}break}},e=o=>{switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"ShiftLeft":case"ShiftRight":this.isSprinting=!1;break;case"Space":break;case"KeyN":this.vehicleTurbo=!1;break}},i=o=>{this.gameMode==="studio"&&(this.selectStudioObject(o)||this.selectBlockUnderCrosshair())||this.controls.isLocked&&(o.button===0?this.shoot():o.button===2&&(this.isAiming=!0))},s=o=>{o.button===2&&(this.isAiming=!1)};document.addEventListener("keydown",t),document.addEventListener("keyup",e),document.addEventListener("mousedown",i),document.addEventListener("mouseup",s),document.addEventListener("contextmenu",o=>o.preventDefault()),this._mouthRaycaster=new J,document.addEventListener("pointerdown",o=>{try{if(this.controls&&this.controls.isLocked||!this.head||!this.camera)return;const n=o.clientX/window.innerWidth*2-1,a=-(o.clientY/window.innerHeight)*2+1;this._mouthRaycaster.setFromCamera(new Y(n,a),this.camera);const l=this._mouthRaycaster.intersectObject(this.head,!0);l&&l.length>0&&(o.preventDefault(),o.stopPropagation(),this.cycleMouthStyle())}catch{}})}lockControls(){if(!("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document)){console.warn("Pointer Lock API not available in this environment.");return}const e=document.getElementById("main-menu");if(!(e&&e.style.display!=="none")&&!this.isPaused)try{const i=this.controls.lock();i&&typeof i.catch=="function"&&i.catch(()=>{})}catch(i){console.warn("Unable to lock pointer:",i)}}toggleCameraMode(){this.cameraMode=this.cameraMode==="FPS"?"TPS":"FPS",this.mesh&&(this.mesh.visible=this.cameraMode==="TPS"),console.log(`Camera mode: ${this.cameraMode}`)}switchWeapon(t){if(t>=0&&t<this.weapons.length){if(this.isReloading)return;this.currentWeaponIndex=t;const e=this.weapons[t].name;Object.values(this.weaponModels).forEach(i=>i.visible=!1),this.weaponModels[e]&&(this.weaponModels[e].visible=!0)}}reload(){if(this.isReloading)return;const t=this.weapons[this.currentWeaponIndex];t.ammo!==1/0&&t.currentMag!==t.magazineSize&&(t.ammo<=0||(this.isReloading=!0,console.log("Reloading..."),this.playReloadSound(),setTimeout(()=>{this.finishReload()},t.reloadTime*1e3)))}playReloadSound(){try{if(this.audioCtx&&this.reloadBuffer){this.audioCtx.state==="suspended"&&this.audioCtx.resume();const t=this.audioCtx.createBufferSource();t.buffer=this.reloadBuffer;const e=this.audioCtx.createGain();e.gain.value=this.sfxVolume*.8,t.connect(e),e.connect(this.audioCtx.destination),t.start(0)}}catch(t){console.warn("Error playing reload sound:",t)}}finishReload(){if(!this.isReloading)return;const t=this.weapons[this.currentWeaponIndex],e=t.magazineSize-t.currentMag,i=t.ammo,s=Math.min(e,i);t.currentMag+=s,t.ammo-=s,this.isReloading=!1,console.log("Reloaded!")}startBlocking(){this.weapons[this.currentWeaponIndex].name==="Fist"&&(this.isBlocking=!0)}stopBlocking(){this.isBlocking=!1}collectItem(t){if(t==="ShieldPotion"){this.shield=Math.min(100,this.shield+50);return}if(t==="MedKit"){this.health=Math.min(100,this.health+25),console.log("Used MedKit from chest: +25 HP");return}if(t&&t.startsWith("Backpack:")){const i=t.split(":")[1]||"2c3e50";return this.equipBackpack(parseInt(i,16))}const e=this.weapons.find(i=>i.name===t);if(e)e.ammo=Math.min(e.maxAmmo,e.ammo+e.magazineSize),console.log("Added ammo for "+t);else{const i=this.allWeapons.find(s=>s.name===t);i&&(this.weapons.push(i),console.log("Picked up "+t))}}setEnemyManager(t){this.enemyManager=t}setMultiplayerClient(t){this.multiplayerClient=t}shoot(){var l;if(!(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0)||this.isDead||this.isReloading||this.isBlocking)return;const e=this.weapons[this.currentWeaponIndex],i=performance.now()/1e3;if(i-e.lastShot<e.cooldown)return;if(e.currentMag<=0){this.reload();return}if(e.lastShot=i,e.ammo!==1/0&&e.currentMag--,e.name==="Fist"){this.punch();return}this.createMuzzleFlash();try{if(this.audioCtx&&this.gunshotBuffer&&this.audioCtx.state==="running"){const h=this.audioCtx.createBufferSource();h.buffer=this.gunshotBuffer,e.name==="Pistol"?h.playbackRate.value=1:e.name==="Rifle"?h.playbackRate.value=1.15:e.name==="Sniper"?h.playbackRate.value=.9:h.playbackRate.value=1;const r=this.audioCtx.createGain();r.gain.value=this.sfxVolume,h.connect(r),r.connect(this.audioCtx.destination),h.start(0)}else this.audioCtx&&this.audioCtx.state==="suspended"&&this.audioCtx.resume()}catch{}const s=new J;s.setFromCamera(new Y(0,0),this.camera);const o=this.camera.position.clone();new I,s.ray.direction.clone().normalize();let n=o.clone().add(s.ray.direction.clone().multiplyScalar(1e3)),a=!1;if(this.worldObjects&&this.worldObjects.length>0){const h=s.intersectObjects(this.worldObjects,!0);h.length>0&&(n=h[0].point.clone(),a=!0)}if(this.enemyManager&&this.enemyManager.enemies){const h=s.intersectObjects(this.enemyManager.enemies.map(r=>r.mesh),!0);if(h.length>0){const r=h[0].point,c=o.distanceTo(r),d=o.distanceTo(n);if(c<d){const f=h[0].object;n=r.clone(),a=!0;let u=null;if(u=(p=>{let v=p;for(;v;){const y=this.enemyManager.enemies.find(S=>S.mesh===v);if(y)return y;v=v.parent}return null})(f),u){const p=o.distanceTo(u.position),v=e.range||1e3;if(p<=v){const y=e.damage;if(this.multiplayerClient&&this.player&&this.player.gameMode==="multiplayer"){const S=this.multiplayerClient.isHost,E=u.mesh&&u.mesh.userData?u.mesh.userData.gameId:null;E&&(S?(u.takeDamage(y),typeof this.multiplayerClient.sendZombieState=="function"&&this.multiplayerClient.sendZombieState(E,u.health)):typeof this.multiplayerClient.sendZombieHit=="function"&&this.multiplayerClient.sendZombieHit(E,y))}else u.takeDamage(e.damage)}else a=!1}}}}if(this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const h=Array.from(this.multiplayerClient.others.values()),r=s.intersectObjects(h,!0);if(r.length>0){const c=r[0].point,d=o.distanceTo(c),f=o.distanceTo(n);if(d<f){n=c.clone(),a=!0;let u=r[0].object;for(;u&&!((l=u.userData)!=null&&l.gameId)&&u.parent;)u=u.parent;const m=u&&u.userData?u.userData.gameId:null;m&&this.multiplayerClient&&typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(m,e.damage)}}}this.showTracers&&this.createBulletTracer(o,n,a),a&&e.name==="Sniper"&&this.createImpactSmoke(n)}static buildMouthMesh(t){const e=(t||"serious").toLowerCase(),i=new w({color:2824976,roughness:.6,metalness:0});let s=null;if(e==="smile"){const o=new T;o.userData={role:"playerMouth"},o.name="playerMouth";const n=i.clone(),a=new g(new x(.08,.04,.02),n),l=a.clone(),h=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,l.position.set(0,-.16,.26),h.position.set(.1,-.15,.26),h.rotation.z=.2,[a,l,h].forEach(r=>{r.userData={role:"playerMouth"},r.name="playerMouthSeg"}),o.add(a,l,h),s=o}else if(e==="angry"){const o=new w({color:5901324,roughness:.4});s=new g(new x(.26,.05,.02),o),s.position.set(0,-.16,.26),s.rotation.z=-.18,s.userData={role:"playerMouth"}}else if(e==="surprised")s=new g(new R(.06,.06,.02,20),i),s.position.set(0,-.14,.26),s.rotation.x=Math.PI/2,s.userData={role:"playerMouth"};else{if(e==="none")return null;s=new g(new x(.22,.06,.02),i),s.position.set(0,-.16,.26),s.userData={role:"playerMouth"}}return s.castShadow=!1,s.receiveShadow=!1,s.name="playerMouth",s}createMouth(t){if(!this.head)return;if(this.mouthMesh){try{this.head.remove(this.mouthMesh)}catch{}this.mouthMesh=null}const e=Te.buildMouthMesh(t);e&&(this.head.add(e),this.mouthMesh=e)}setHatVisible(t){this.showHat=t,Array.isArray(this.hatMeshes)&&this.hatMeshes.forEach(e=>{e&&(e.visible=t)})}cycleMouthStyle(){const t=this.mouthStyle||"serious",e=this.mouthStyles.indexOf(t),i=this.mouthStyles[(e+1)%this.mouthStyles.length];this.mouthStyle=i,this.createMouth(i),this.persistSetting("mouthStyle",i);const s=document.getElementById("setting-mouth-style");s&&(s.value=i)}persistSetting(t,e){if(!(typeof window>"u"||!window.localStorage))try{const i=window.localStorage.getItem("voxel-firecraft-settings"),s=i?JSON.parse(i):{};s[t]=e,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(s))}catch{}}createMuzzleFlash(){const t=new nt(16776960,1,5),e=new I;this.camera.getWorldDirection(e),t.position.copy(this.mesh.position),t.position.y+=1.5,t.position.add(e.multiplyScalar(1)),this.scene.add(t),setTimeout(()=>this.scene.remove(t),100)}createBulletTracer(t,e,i){const s=[t,e],o=new Ue().setFromPoints(s),n=i?16729156:16776960,a=new at({color:n,linewidth:2,opacity:.8,transparent:!0}),l=new rt(o,a);this.scene.add(l);let h=.8;const r=setInterval(()=>{h-=.1,a.opacity=h,h<=0&&(clearInterval(r),this.scene.remove(l),o.dispose(),a.dispose())},30)}createImpactSmoke(t){const e=new T;e.position.copy(t);const i=8;for(let a=0;a<i;a++){const l=.15+Math.random()*.2,h=new xe(l,6,6),r=new Me({color:6710886,transparent:!0,opacity:.5}),c=new g(h,r);c.position.set((Math.random()-.5)*.4,(Math.random()-.5)*.2,(Math.random()-.5)*.4),e.add(c)}this.scene.add(e);const s=600,o=performance.now(),n=()=>{const a=performance.now()-o,l=Math.max(0,1-a/s);e.children.forEach(h=>{h.material&&(h.material.opacity=l*.5)}),a<s?requestAnimationFrame(n):(e.traverse(h=>{h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()}),this.scene.remove(e))};n()}update(t){if(this.isDead)return;if(this.updateVehiclePrompt(),this.isInVehicle){this.updateVehicleDrive(t);return}if(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0){this.velocity.x-=this.velocity.x*10*t,this.velocity.z-=this.velocity.z*10*t,this.isFloating?this.velocity.y*=.9:this.velocity.y-=this.gravity*t,this.direction.z=Number(this.moveForward)-Number(this.moveBackward),this.direction.x=Number(this.moveRight)-Number(this.moveLeft),this.direction.normalize(),(this.moveForward||this.moveBackward)&&(this.velocity.z-=this.direction.z*this.speed*t),(this.moveLeft||this.moveRight)&&(this.velocity.x-=this.direction.x*this.speed*t);const i=new I;this.camera.getWorldDirection(i),i.y=0,i.normalize();const s=new I;s.crossVectors(i,new I(0,1,0));const o=new I;this.moveForward&&o.add(i),this.moveBackward&&o.sub(i),this.moveRight&&o.add(s),this.moveLeft&&o.sub(s),o.normalize();const n=o.length()>0;let a=1;this.isSprinting&&!this.isCrouching&&n&&this.stamina>0&&(a=2);const l=this.speed*t*.1*a,h=o.multiplyScalar(l);h.x!==0&&(this.checkCollision(new I(Math.sign(h.x),0,0),Math.abs(h.x))||(this.mesh.position.x+=h.x)),h.z!==0&&(this.checkCollision(new I(0,0,Math.sign(h.z)),Math.abs(h.z))||(this.mesh.position.z+=h.z));let r=0;if(this.isFloating){const y=new I;this.camera.getWorldDirection(y);const S=y.y;this.moveForward&&(r+=S*this.speed*t*.3),this.moveBackward&&(r-=S*this.speed*t*.3)}if(this.mesh.position.y+=this.velocity.y*t+r,o.length()>0){const y=Math.atan2(o.x,o.z);this.mesh.rotation.y=y}if(this.mesh.position.y+=this.velocity.y*t,!this.isFloating&&!this.isFloating){this.mesh.position.y<0&&(this.velocity.y=0,this.mesh.position.y=0,this.canJump=!0);const y=this.getSurfaceHeight(this.mesh.position.x,this.mesh.position.z);this.mesh.position.y<y&&(this.mesh.position.y=y,this.velocity.y=0,this.canJump=!0)}const c=!this.isFloating&&(this.canJump||this.mesh.position.y<=.01);if(this.handleFootsteps(n&&c&&!this.isDead),this.gameMode==="studio"?this.updateBlockPreview():this.previewBlock&&(this.previewBlock.visible=!1),this.world&&typeof this.world.halfMapSize=="number"){const y=this.world.halfMapSize-1;this.mesh.position.x=Math.max(-y,Math.min(y,this.mesh.position.x)),this.mesh.position.z=Math.max(-y,Math.min(y,this.mesh.position.z))}if(this.separateFromRemotePlayers(),this.previousPosition.length()>0){const y=this.mesh.position.distanceTo(this.previousPosition);this.distanceTraveled+=y,t>0&&(this.currentSpeed=y/t)}if(this.previousPosition.copy(this.mesh.position),this.gameMode==="studio"||this.gameMode==="matrix-ai")this.stamina=100;else if(this.isSprinting&&!this.isCrouching&&n&&this.stamina>0){const y=20*t;this.stamina=Math.max(0,this.stamina-y),this.stamina<=0&&(this.isSprinting=!1)}else{const y=10*t;this.stamina=Math.min(100,this.stamina+y)}this.camera.position.copy(this.mesh.position);const f=this.isCrouching?1.6*this.crouchHeight:1.6;this.camera.position.y+=f;const u=this.isCrouching?this.crouchHeight:1;this.mesh.scale.y+=(u-this.mesh.scale.y)*10*t;let m=this.baseFov;const p=this.weapons[this.currentWeaponIndex];this.isAiming&&p&&p.zoomFov&&(m=p.zoomFov),Math.abs(this.camera.fov-m)>.1&&(this.camera.fov+=(m-this.camera.fov)*10*t,this.camera.updateProjectionMatrix());let v;this.cameraMode==="FPS"?v=this.fpsCameraOffset.clone():(v=this.tpsCameraOffset.clone(),v.applyQuaternion(this.camera.quaternion)),v.add(this.mesh.position),this.camera.position.copy(v),this.updateAnimations(t)}}findNearbyVehicle(){if(!this.worldObjects)return null;let t=null,e=4;return this.worldObjects.forEach(i=>{if(!i||!i.userData||i.userData.type!=="vehicle")return;const s=i.position.distanceTo(this.mesh.position);s<e&&(t=i,e=s)}),t}updateVehiclePrompt(){const t=this.vehiclePromptEl;if(!t)return;if(this.isInVehicle){t.innerText="Press E to exit vehicle",t.dataset.vehiclePrompt="1",t.classList.remove("hidden");return}const e=this.findNearbyVehicle();this.nearVehicle=e,e?(t.innerText="Press E to drive vehicle",t.dataset.vehiclePrompt="1",t.classList.remove("hidden")):t.dataset.vehiclePrompt==="1"&&(t.classList.add("hidden"),delete t.dataset.vehiclePrompt)}enterVehicle(t){if(!t||this.isInVehicle)return!1;t.userData||(t.userData={}),t.userData.hasFrontAligned||(t.rotation.y+=Math.PI,t.userData.hasFrontAligned=!0);const e=this.loadVehicleState(t);this.isInVehicle=!0,this.vehicleAccelHold=0,this.isSprinting=!1,this.vehicleTurbo=!1,this.currentVehicle=t,this.vehicleSpeed=0,this.currentSpeed=0;const i=t.userData&&t.userData.vehicleType||"car";return this.vehicleFuelCapacity=e?e.capacity:i==="truck"?60:40,this.vehicleFuel=e?e.fuel:this.vehicleFuelCapacity,this.vehicleDistance=e?e.distanceKm:0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=e?e.fuelUsed:0,this.vehicleEfficiencyKmPerL=i==="truck"?3.5:5.5,this.vehicleIdleLph=i==="truck"?1:.7,this.vehicleThrottleLph=i==="truck"?2.8:1.9,this._vehicleMaxSpeed=i==="truck"?80/3.6:null,this._vehicleTurboMaxSpeed=i==="truck"?100/3.6:null,this._vehicleStateCache=e||null,this.previousPosition.copy(t.position),this.stopFootsteps(),this.stopVehicleDriveSound(),this.playVehicleDoor(),this.mesh.visible=!1,this.velocity.set(0,0,0),this.mesh.position.copy(t.position),this.updateVehicleHUD(!0),!0}exitVehicle(){if(!this.currentVehicle){this.isInVehicle=!1;return}const t=this.currentVehicle;if(this.playVehicleDoor(),this.stopVehicleDriveSound(),this.stopFootsteps(),this.world&&typeof this.world.getHeightAt=="function"){const o=this.world.getHeightAt(t.position.x,t.position.z),n=this.getVehicleGroundClearance(t);t.position.y=o+n}const e=new I(-1.5,0,-2).applyEuler(t.rotation),i=t.position.clone().add(e);this.mesh.position.copy(i);const s=typeof this.getSurfaceHeight=="function"?this.getSurfaceHeight(i.x,i.z):this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(i.x,i.z):i.y;this.mesh.position.y=s,this.velocity.set(0,0,0),this.mesh.visible=!0,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.canJump=!0,this.previousPosition.copy(this.mesh.position),this.saveVehicleState(t),this.updateVehicleHUD(!1),this.vehiclePromptEl&&this.vehiclePromptEl.dataset.vehiclePrompt==="1"&&(this.vehiclePromptEl.classList.add("hidden"),delete this.vehiclePromptEl.dataset.vehiclePrompt)}getVehicleGroundClearance(t){if(!t)return .05;const e=t.userData||{};return typeof e.groundClearance=="number"?e.groundClearance:typeof e.wheelRadius=="number"&&typeof e.wheelCenterY=="number"?Math.max(0,e.wheelRadius-e.wheelCenterY):.05}updateVehicleDrive(t){const e=this.currentVehicle;if(!e){this.isInVehicle=!1;return}this.stopFootsteps();const i=e.position.clone();if(this.vehicleFuel<=0){this.vehicleSpeed=0,this.mesh.position.copy(e.position),this.previousPosition.copy(e.position),this.currentSpeed=0,this.updateVehicleHUD(!0);return}let s=0;this.moveForward&&(s+=1),this.moveBackward&&(s-=1),this.vehicleSpeed+=s*this.vehicleAccel*t,this.moveForward&&s>0?this.vehicleAccelHold=Math.min(1,this.vehicleAccelHold+t*.8):this.vehicleAccelHold=Math.max(0,this.vehicleAccelHold-t*.6);const o=this.vehicleTurbo&&s>0,n=o?vType==="truck"?1.25:1.6:1,a=o?vType==="truck"?1.15:1.35:1,l=(this.vehicleBaseMaxSpeed+this.vehicleBoostMax*this.vehicleAccelHold)*n,h=this.vehicleBaseMaxSpeed*.5;this.vehicleSpeed=Math.min(l,Math.max(-h,this.vehicleSpeed)),this.vehicleSpeed+=s*this.vehicleAccel*t*(a-1),this.vehicleSpeed*=Math.max(0,1-this.vehicleFriction*t),this._vehicleMaxSpeed&&!o?this.vehicleSpeed=Math.min(this._vehicleMaxSpeed,this.vehicleSpeed):this._vehicleTurboMaxSpeed&&o&&(this.vehicleSpeed=Math.min(this._vehicleTurboMaxSpeed,this.vehicleSpeed)),this.currentSpeed=Math.abs(this.vehicleSpeed);const r=s>0,c=this.vehicleSpeed>=0?1:-1;this.moveLeft&&(e.rotation.y+=this.vehicleTurnSpeed*t*c),this.moveRight&&(e.rotation.y-=this.vehicleTurnSpeed*t*c);const d=new I(0,0,1).applyEuler(e.rotation),f=e.position.clone().addScaledVector(d,this.vehicleSpeed*t);if(this.checkVehicleCollision(f,e)?this.vehicleSpeed*=.2:e.position.copy(f),this.world&&typeof this.world.getHeightAt=="function"){const E=this.world.getHeightAt(e.position.x,e.position.z),k=this.getVehicleGroundClearance(e);e.position.y=E+k}if(this.world&&typeof this.world.halfMapSize=="number"){const E=this.world.halfMapSize-1;e.position.x=Math.max(-E,Math.min(E,e.position.x)),e.position.z=Math.max(-E,Math.min(E,e.position.z))}if(this.previousPosition.length()>0){const E=e.position.distanceTo(this.previousPosition);this.distanceTraveled+=E}this.mesh.position.copy(e.position),this.previousPosition.copy(e.position);const u=e.position.distanceTo(i);this.rotateVehicleWheels(e,u,this.vehicleSpeed);let m=0;if(m+=this.vehicleIdleLph/3600*t,r&&(m+=this.vehicleThrottleLph/3600*t*(o?1.7:1)),u>0){const E=u/1e3;this.vehicleDistance+=E;const k=E/this.vehicleEfficiencyKmPerL,C=r?k*.35*(o?1.35:1):0;m+=k+C}if(this.vehicleFuelUsed+=m,this.vehicleFuel=Math.max(0,this.vehicleFuel-m),this.vehicleFuel<=0&&(this.vehicleSpeed=0),this.saveVehicleState(e),this.updateVehicleHUD(!0),this.enemyManager&&Array.isArray(this.enemyManager.enemies)){const E=performance.now();this.enemyManager.enemies.forEach(k=>{if(!k||!k.position)return;if(k.position.distanceTo(e.position)<2.4){k.userData||(k.userData={});const P=k.userData.lastRunOver||0;if(E-P>400){k.userData.lastRunOver=E;try{k.takeDamage(999)}catch{}}}})}const p=e.position.clone(),v=new I(0,2,6).applyQuaternion(this.camera.quaternion),y=p.clone().add(v);this.camera.position.lerp(y,.18);const S=Math.abs(this.vehicleSpeed)>.5;this.handleVehicleDriveSound(S)}rotateVehicleWheels(t,e,i){if(!t||!t.userData||!t.userData.wheels||!t.userData.wheels.length)return;const s=t.userData.wheelRadius||.35,o=e/s,n=i>=0?-1:1;t.userData.wheels.forEach(a=>{try{a.rotation.x+=n*o}catch{}})}updateVehicleHUD(t){if(!this.vehicleHud||!this.vehicleHud.root)return;const e=this.vehicleHud.root,i=document.getElementById("dashboard");if(i){const o=i.getBoundingClientRect();e.style.left=`${o.left}px`,e.style.top=`${o.top+o.height+8}px`,e.style.width=`${o.width}px`}if(!t){e.classList.add("hidden");return}e.classList.remove("hidden");const s=Math.abs(this.vehicleSpeed)*3.6;if(this.vehicleHud.speed&&(this.vehicleHud.speed.innerText=s.toFixed(0)),this.vehicleHud.fuelFill){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelFill.style.width=`${n}%`,this.vehicleHud.fuelFill.style.background=n<20?"linear-gradient(90deg, #ff7043, #ff3d00)":"linear-gradient(90deg, #8bc34a, #cddc39)"}if(this.vehicleHud.fuelText){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelText.innerText=`${this.vehicleFuel.toFixed(1)}L (${n.toFixed(1)}%)`}if(this.vehicleHud.distance&&(this.vehicleHud.distance.innerText=this.vehicleDistance.toFixed(2)),this.vehicleHud.efficiency){const o=this.vehicleFuelUsed>0&&this.vehicleDistance>0?this.vehicleDistance/this.vehicleFuelUsed:0;this.vehicleHud.efficiency.innerText=o.toFixed(2)}if(this.vehicleHud.range){const o=this.vehicleFuel*this.vehicleEfficiencyKmPerL;this.vehicleHud.range.innerText=o.toFixed(1)}}getVehicleStorageKey(t){return!t||!t.userData||!t.userData.gameId?null:`vehicle-state-${t.userData.gameId}`}loadVehicleState(t){try{if(t&&t.userData&&t.userData.vehicleState)return t.userData.vehicleState;const e=this.getVehicleStorageKey(t);if(!e||typeof localStorage>"u")return null;const i=localStorage.getItem(e);if(!i)return null;const s=JSON.parse(i);return t.userData.vehicleState=s,s}catch{return null}}saveVehicleState(t){if(!t)return;const e=this.getVehicleStorageKey(t);if(!e)return;const i={fuel:this.vehicleFuel,capacity:this.vehicleFuelCapacity,distanceKm:this.vehicleDistance,fuelUsed:this.vehicleFuelUsed,vehicleType:t.userData&&t.userData.vehicleType||"car"};t.userData.vehicleState=i;try{typeof localStorage<"u"&&localStorage.setItem(e,JSON.stringify(i))}catch{}}selectStudioObject(t){if(this.gameMode!=="studio"||!this.worldObjects||this.worldObjects.length===0)return null;const e=new Y;this.controls&&this.controls.isLocked?e.set(0,0):t&&t.clientX!==void 0?(e.x=t.clientX/window.innerWidth*2-1,e.y=-(t.clientY/window.innerHeight)*2+1):e.set(0,0),this._studioRaycaster.setFromCamera(e,this.camera);const i=this.worldObjects.filter(n=>n&&n.userData&&n.userData.gameName!=="Ground"),s=this._studioRaycaster.intersectObjects(i,!0);if(!s.length)return this.clearStudioSelection(),null;let o=s[0].object;for(;o&&!this.worldObjects.includes(o);)o=o.parent;return o&&this.setStudioSelection(o),o}moveSelectedObject(t,e,i=0){if(!this.studioSelected)return;const s=this.studioSelected;s.position.x+=t,s.position.z+=e,s.position.y+=i,i===0&&this.world&&typeof this.world.getHeightAt=="function"&&(s.position.y=this.world.getHeightAt(s.position.x,s.position.z)),this.refreshStudioSelectionHelper()}clearStudioSelection(){if(this.studioSelected=null,this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}this.selectionInfo&&this.selectionInfo.classList.add("hidden")}removeSelectedObject(){if(!this.studioSelected)return;const t=this.studioSelected;this.clearStudioSelection();try{this.scene.remove(t)}catch{}if(this.worldObjects){const e=this.worldObjects.indexOf(t);e>=0&&this.worldObjects.splice(e,1)}}setStudioSelection(t){if(this.studioSelected=t,this.selectionInfo){const e=t.userData||{};this.selectionInfo.innerText=`${e.gameName||"Object"} (${e.gameId||"---"})`,this.selectionInfo.classList.remove("hidden")}this.refreshStudioSelectionHelper()}refreshStudioSelectionHelper(){if(this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}if(this.studioSelected)try{const t=this.buildStudioSelectionBox(this.studioSelected);this.studioSelectionHelper=new ht(t,16766720),this.studioSelectionHelper.material.depthTest=!1,this.studioSelectionHelper.material.transparent=!0,this.studioSelectionHelper.material.opacity=.9,this.scene.add(this.studioSelectionHelper)}catch{this.studioSelectionHelper=null}}buildStudioSelectionBox(t){const e=new Ge;return t.traverse(i=>{if(!i.isMesh||!i.geometry)return;const s=i.userData||{},o=i.material;if(!(o&&o.transparent||s.isShadow||s.shadow)){if(!i.geometry.boundingBox)try{i.geometry.computeBoundingBox()}catch{}if(i.geometry.boundingBox){const a=i.geometry.boundingBox.clone();i.updateWorldMatrix(!0,!1),a.applyMatrix4(i.matrixWorld),e.union(a)}}}),e.isEmpty()&&e.setFromCenterAndSize(t.position,new I(1,1,1)),e}checkVehicleCollision(t,e=null){if(!this.worldObjects)return!1;const i=2;for(let s=0;s<this.worldObjects.length;s++){const o=this.worldObjects[s];if(!o)continue;const n=o.userData||{};if(e&&o===e||n.gameName==="Ground"||n.type==="ground")continue;const a=o.position||(o.getWorldPosition?o.getWorldPosition(new I):null);if(!a)continue;const l=a.distanceTo(t);let h=1.5;if(o.geometry&&o.geometry.boundingSphere?h=o.geometry.boundingSphere.radius||h:n&&n.size==="large"?h=5:n.type==="vehicle"&&(h=2.5),l<i+h)return!0}return!1}updateAnimations(t){const e=this.moveForward||this.moveBackward||this.moveLeft||this.moveRight,i=10,s=this.isSprinting&&e?1.8:1;if(e){this.animTime+=t*i*s;const o=Math.sin(this.animTime)*(.5*s);this.leftLegPivot.rotation.x=o,this.rightLegPivot.rotation.x=-o}else this.leftLegPivot.rotation.x=V.lerp(this.leftLegPivot.rotation.x,0,t*i),this.rightLegPivot.rotation.x=V.lerp(this.rightLegPivot.rotation.x,0,t*i);if(this.isBlocking){const o=-Math.PI/2.5,n=.5;this.leftArmPivot.rotation.x=V.lerp(this.leftArmPivot.rotation.x,o,t*15),this.rightArmPivot.rotation.x=V.lerp(this.rightArmPivot.rotation.x,o,t*15),this.leftArmPivot.rotation.z=V.lerp(this.leftArmPivot.rotation.z,-n,t*15),this.rightArmPivot.rotation.z=V.lerp(this.rightArmPivot.rotation.z,n,t*15)}else if(this.isPunching){this.punchTime+=t*20;const o=-Math.PI/2+Math.sin(this.punchTime)*.8;this.punchSide===0?(this.rightArmPivot.rotation.x=o,this.leftArmPivot.rotation.x=V.lerp(this.leftArmPivot.rotation.x,0,t*10)):(this.leftArmPivot.rotation.x=o,this.rightArmPivot.rotation.x=V.lerp(this.rightArmPivot.rotation.x,0,t*10)),this.punchTime>Math.PI&&(this.isPunching=!1,this.rightArmPivot.rotation.x=0,this.leftArmPivot.rotation.x=0),this.leftArmPivot.rotation.z=V.lerp(this.leftArmPivot.rotation.z,0,t*10),this.rightArmPivot.rotation.z=V.lerp(this.rightArmPivot.rotation.z,0,t*10)}else{if(e){const o=Math.sin(this.animTime)*.5*s;this.leftArmPivot.rotation.x=-o,this.rightArmPivot.rotation.x=o}else this.leftArmPivot.rotation.x=V.lerp(this.leftArmPivot.rotation.x,0,t*10),this.rightArmPivot.rotation.x=V.lerp(this.rightArmPivot.rotation.x,0,t*10);this.leftArmPivot.rotation.z=V.lerp(this.leftArmPivot.rotation.z,0,t*10),this.rightArmPivot.rotation.z=V.lerp(this.rightArmPivot.rotation.z,0,t*10)}if(this.hitTimer>0){this.hitTimer-=t;const o=Math.max(0,this.hitTimer)/.6,n=V.lerp(-Math.PI/2.2,0,1-o);this.leftArmPivot.rotation.x=V.lerp(this.leftArmPivot.rotation.x,n,t*20),this.rightArmPivot.rotation.x=V.lerp(this.rightArmPivot.rotation.x,n,t*20)}}punch(){if(!this.isTired&&!(this.isPunching||this.isBlocking)&&(this.isPunching=!0,this.punchTime=0,this.punchSide=this.punchSide===0?1:0,this.punchCount++,this.punchCount>=20&&(this.isTired=!0,this.stamina=Math.max(0,this.stamina-20),setTimeout(()=>{this.isTired=!1,this.punchCount=0},3e3)),this.enemyManager&&this.enemyManager.enemies)){const t=new I;this.mesh.getWorldDirection(t);let e=!1;if(this.enemyManager.enemies.forEach(i=>{if(this.mesh.position.distanceTo(i.position)<3){const o=new I().subVectors(i.position,this.mesh.position).normalize();if(t.angleTo(o)<Math.PI/3){i.takeDamage(10);const a=t.clone().multiplyScalar(2);i.position.add(a),e=!0}}}),this.gameMode==="multiplayer"&&this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const i=Math.PI/3,s=3;this.multiplayerClient.others.forEach((o,n)=>{if(!o||!o.position||o.userData&&o.userData.dead||this.mesh.position.distanceTo(o.position)>s)return;const l=new I().subVectors(o.position,this.mesh.position).normalize();t.angleTo(l)<i&&(typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(n,10),e=!0)})}e&&this.playSmack()}}playSmack(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playSmack());return}if(this.smackBuffer){const t=this.audioCtx.createBufferSource();t.buffer=this.smackBuffer;const e=this.audioCtx.createGain();e.gain.value=this.sfxVolume,t.connect(e),e.connect(this.audioCtx.destination),t.start(0)}}}catch(t){console.warn("playSmack error:",t)}}equipBackpack(t=2899536){const e=this.backpackColor;this.backpack&&this.backpack.parent&&this.backpack.parent.remove(this.backpack);const i=new T;i.position.set(0,1.25,-.32);const s=new g(new x(.7,.9,.35),new w({color:t,metalness:.15,roughness:.8}));s.position.set(0,0,0),i.add(s);const o=new g(new x(.6,.25,.16),new w({color:3426654,metalness:.1,roughness:.8}));o.position.set(0,-.55,.22),i.add(o);const n=new w({color:2042938,metalness:.1,roughness:.9}),a=new g(new x(.1,.82,.07),n);a.position.set(-.28,-.03,.2);const l=a.clone();return l.position.x=.28,i.add(a,l),this.mesh.add(i),this.backpack=i,this.backpackColor=t,e}queueHurtBeat(){if(this._hurtAccumulator+=1,this._hurtAccumulator>=2){const t=Math.floor(this._hurtAccumulator/2);this._hurtQueue+=t,this._hurtAccumulator-=t*2}this._hurtQueue===0&&this._hurtAccumulator>0&&(this._hurtQueue=1,this._hurtAccumulator=0),this._hurtBeatTimer||this._playHurtBeatLoop()}_playHurtBeatLoop(){if(this._hurtQueue<=0){this._hurtBeatTimer=null;return}this.playHurt(),this._hurtQueue=Math.max(0,this._hurtQueue-1),this._hurtBeatTimer=setTimeout(()=>this._playHurtBeatLoop(),2e3)}clearHurtQueue(){this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer&&(clearTimeout(this._hurtBeatTimer),this._hurtBeatTimer=null)}playHurt(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playHurt());return}if(this.ughBuffer){const t=this.audioCtx.createBufferSource();t.buffer=this.ughBuffer;const e=this.audioCtx.createGain();e.gain.value=this.sfxVolume,t.connect(e),e.connect(this.audioCtx.destination),t.start(0)}}}catch(t){console.warn("playHurt error:",t)}}playVehicleDoor(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playVehicleDoor());return}if(this.vehicleDoorBuffer){const t=this.audioCtx.createBufferSource();t.buffer=this.vehicleDoorBuffer;const e=this.audioCtx.createGain();e.gain.value=this.sfxVolume,t.connect(e),e.connect(this.audioCtx.destination),t.start(0)}}}catch(t){console.warn("playVehicleDoor error:",t)}}handleVehicleDriveSound(t){try{if(!this.audioCtx||!this.enableVehicleDriveSound){this.stopVehicleDriveSound();return}if(!this.vehicleDriveBuffer){this.stopVehicleDriveSound();return}if(t===this._lastVehicleDriveActive&&(t&&this._vehicleDriveSource||!t&&!this._vehicleDriveSource))return;if(this._lastVehicleDriveActive=t,t){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._vehicleDriveSource)return;const e=this.audioCtx.createBufferSource();e.buffer=this.vehicleDriveBuffer,e.loop=!0;const i=this.audioCtx.createGain();i.gain.value=this.sfxVolume*.4,e.connect(i),i.connect(this.audioCtx.destination),e.start(0),this._vehicleDriveSource=e,this._vehicleDriveGain=i,e.onended=()=>{this._vehicleDriveSource=null,this._vehicleDriveGain=null}}else this.stopVehicleDriveSound()}catch(e){console.warn("handleVehicleDriveSound error:",e)}}stopVehicleDriveSound(){if(this._lastVehicleDriveActive=!1,this._vehicleDriveSource){try{this._vehicleDriveSource.stop()}catch{}try{this._vehicleDriveSource.disconnect()}catch{}}if(this._vehicleDriveGain)try{this._vehicleDriveGain.disconnect()}catch{}this._vehicleDriveSource=null,this._vehicleDriveGain=null}handleFootsteps(t){try{if(this.isInVehicle){this.stopFootsteps();return}if(!this.audioCtx||!this.footstepsBuffer){this.stopFootsteps();return}if(t===this._lastFootstepsActive&&(t&&this._footstepsSource||!t&&!this._footstepsSource)){if(t&&this._footstepsSource){const e=this.isSprinting?1.4:this.isCrouching?.8:1;this._footstepsSource.playbackRate.value=e}return}if(this._lastFootstepsActive=t,t){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._footstepsSource){try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}const e=this.audioCtx.createBufferSource();e.buffer=this.footstepsBuffer,e.loop=!0,e.playbackRate.value=this.isSprinting?1.4:this.isCrouching?.8:1;const i=this.audioCtx.createGain();i.gain.value=this.sfxVolume*.35,e.connect(i),i.connect(this.audioCtx.destination),e.start(0),this._footstepsSource=e,this._footstepsGain=i,e.onended=()=>{this._footstepsSource=null,this._footstepsGain=null}}else this.stopFootsteps()}catch(e){console.warn("handleFootsteps error:",e)}}stopFootsteps(){if(this._lastFootstepsActive=!1,this._footstepsSource){try{this._footstepsSource.onended=null}catch{}try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}get position(){return this.mesh.position}getSurfaceHeight(t,e){let i=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(t,e):0;return(this.world&&this.world.objects?this.world.objects:[]).forEach(o=>{if(!(!o||!o.userData)){if(o.userData.type==="block"){const n=o.userData.size||this.blockSize;if(Math.abs(o.position.x-t)<n*.6&&Math.abs(o.position.z-e)<n*.6){const a=o.position.y+n/2;a>i&&(i=a)}}if(o.userData.colliderBox){const n=o.userData.colliderBox;t>=n.min.x&&t<=n.max.x&&e>=n.min.z&&e<=n.max.z&&n.max.y>i&&(i=n.max.y)}}}),i}adjustBlockSize(t){const e=Math.max(this.minBlockSize,Math.min(this.maxBlockSize,this.blockSize+t));this.blockSize=e,console.log("Block size:",this.blockSize.toFixed(2))}moveLastBlock(){if(!this.placedBlocks.length)return;const t=this.placedBlocks[this.placedBlocks.length-1];if(!t)return;const e=this.getBlockTarget(t);t.position.set(e.position.x,e.position.y,e.position.z)}getBlockTarget(t=null){const e=t&&t.userData&&t.userData.size?t.userData.size:this.blockSize,i=new J;i.setFromCamera(new Y(0,0),this.camera);const s=c=>Math.round(c);let o=null;if(this.world&&Array.isArray(this.world.objects)){const c=this.world.objects.filter(f=>f&&f.userData&&(f.userData.type==="block"||f.userData.gameName==="Ground")),d=i.intersectObjects(c,!0);d.length>0&&(o=d[0].point.clone())}if(!o){const c=new I;this.camera.getWorldDirection(c),o=this.mesh.position.clone().add(c.multiplyScalar(1.2))}const n=new I(s(o.x),o.y,s(o.z));if(this.world&&typeof this.world.halfMapSize=="number"){const c=this.world.halfMapSize-1;n.x=Math.max(-c,Math.min(c,n.x)),n.z=Math.max(-c,Math.min(c,n.z))}let a=this.world.getHeightAt?this.world.getHeightAt(n.x,n.z):o.y;const h=(this.world.objects||[]).filter(c=>c.userData&&c.userData.type==="block"&&c!==t).filter(c=>Math.abs(c.position.x-n.x)<.1&&Math.abs(c.position.z-n.z)<.1);h.length>0&&(a=Math.max(...h.map(d=>d.position.y+(d.userData&&d.userData.size?d.userData.size/2:e/2))));const r=a+e/2;return{position:new I(n.x,r,n.z),size:e}}updateBlockPreview(){if(!this.previewBlock)return;const t=this.getBlockTarget();this.previewBlock.visible=!0,this.previewBlock.position.copy(t.position);const e=t.size/this.blockSize;this.previewBlock.scale.set(e,e,e)}removeLastBlock(){if(!this.placedBlocks.length)return;const t=this.placedBlocks.pop();t&&t.parent&&t.parent.remove(t),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(e=>e!==t)),t&&t.geometry&&t.geometry.dispose(),t&&t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose()),this.selectedBlock===t&&this.clearBlockSelection()}selectBlockUnderCrosshair(){if(!this.world||!this.world.objects)return!1;const t=new J;t.setFromCamera(new Y(0,0),this.camera);const e=t.intersectObjects(this.world.objects,!0);if(e.length===0)return this.clearBlockSelection(),!1;let i=null;for(const s of e){let o=s.object;for(;o&&o.parent;){if(o.userData&&o.userData.type==="block"){i=o;break}o=o.parent}if(i)break}return i?(this.setBlockSelection(i),!0):(this.clearBlockSelection(),!1)}setBlockSelection(t){this.clearBlockSelection(),this.selectedBlock=t;const e=new lt(t,16776960);e.userData={ignoreSelect:!0},this.scene.add(e),this.selectedBlockHelper=e}clearBlockSelection(){this.selectedBlock=null,this.selectedBlockHelper&&(this.scene.remove(this.selectedBlockHelper),this.selectedBlockHelper.material&&this.selectedBlockHelper.material.dispose(),this.selectedBlockHelper.geometry&&this.selectedBlockHelper.geometry.dispose(),this.selectedBlockHelper=null)}removeBlock(t){t&&(this.placedBlocks=this.placedBlocks.filter(e=>e!==t),t.parent&&t.parent.remove(t),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(e=>e!==t)),t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(e=>e.dispose()):t.material.dispose()),this.selectedBlock===t&&this.clearBlockSelection())}takeDamage(t){this.gameMode==="matrix"||this.gameMode==="studio"||this.multiplayerClient&&!this.multiplayerClient.isMatchLive()||(this.isBlocking&&(t*=.2,console.log("Blocked! Reduced damage to "+t)),this.shield>0?(this.shield-=t,this.shield<0&&(this.health+=this.shield,this.shield=0)):this.health-=t,t>0&&this.queueHurtBeat(),this.health<=0&&(this.health=0,this.die()),this.hitTimer=.6)}die(){this.gameMode==="matrix"||this.gameMode==="studio"||(this.handleFootsteps(!1),this.isDead=!0,this.controls.unlock(),this.mesh.rotation.x=-Math.PI/2,this.multiplayerClient&&typeof this.multiplayerClient.sendDeath=="function"&&this.multiplayerClient.sendDeath(),this.moveForward=this.moveBackward=this.moveLeft=this.moveRight=!1,this.velocity.set(0,0,0),this.hud&&typeof this.hud.showGameOver=="function"&&this.hud.showGameOver("YOU DIED"))}checkCollision(t,e){const i=new J,s=.5,o=[1.6,1,.35];let n=this.worldObjects||[];if(this.enemyManager&&this.enemyManager.enemies){const h=this.enemyManager.enemies.map(r=>r.mesh);n=n.concat(h)}const a=1.5,l=h=>{let r=h;for(;r;){if(r.userData&&r.userData.colliderBox)return r.userData.colliderBox;r=r.parent}return null};for(const h of o){const r=this.mesh.position.clone();if(r.y+=h,i.set(r,t),n.length>0){const c=i.intersectObjects(n,!0);if(c.length>0){const d=c[0];if(d.distance<e+s){const f=l(d.object);if(f){const u=f.max.y,m=u-this.mesh.position.y;if(m<=a&&m>-.5)return this.mesh.position.y=u,this.velocity.y=0,this.canJump=!0,!1}return!0}}}}return!1}}const Kt="/threejs-voxel-firecraft/dist/assets/mixkit-player-losing-or-failing-vCPqUTFf.ogg",Jt="/threejs-voxel-firecraft/dist/assets/game-level-completed-envato-mixkit.co-OEgWp6-U.ogg";class Zt{constructor(t,e,i){this.player=t,this.world=e,this.settings=i||{},this.healthBar=document.getElementById("health-bar"),this.healthText=document.getElementById("health-text"),this.shieldBar=document.getElementById("shield-bar"),this.shieldText=document.getElementById("shield-text"),this.staminaBar=document.getElementById("stamina-bar"),this.staminaText=document.getElementById("stamina-text"),this.weaponName=document.getElementById("weapon-name"),this.ammoCount=document.getElementById("ammo-count"),this.slots=document.querySelectorAll(".slot"),this.timerValue=document.getElementById("timer-value"),this.debugContainer=document.getElementById("debug-container"),this.gameOverScreen=document.getElementById("game-over-screen"),this.selectionInfo=document.getElementById("selection-info"),this.selectionInfoTimeout=null,this.hotbar=document.getElementById("hotbar"),this.fpsCounter=document.getElementById("fps-counter"),this.enemyCount=document.getElementById("enemy-count"),this.killCount=document.getElementById("kill-count"),this.dropCount=document.getElementById("drop-count"),this.distanceTraveled=document.getElementById("distance-traveled"),this.playerSpeed=document.getElementById("player-speed"),this.mapSizeText=document.getElementById("map-size-readout"),this.memoryUsage=document.getElementById("memory-usage"),this.targetInspect=document.getElementById("target-inspect"),this.perfFrame=document.getElementById("perf-frame"),this.perfCalls=document.getElementById("perf-calls"),this.perfTris=document.getElementById("perf-tris"),this.perfGeoms=document.getElementById("perf-geoms"),this.perfTextures=document.getElementById("perf-textures"),this.perfPrograms=document.getElementById("perf-programs"),this.perfObjects=document.getElementById("perf-objects"),this.perfMem=document.getElementById("perf-mem"),this.perfCpu=document.getElementById("perf-cpu"),this.perfGpu=document.getElementById("perf-gpu"),this.perfGpuMem=document.getElementById("perf-gpu-mem"),this.dashboardEl=document.getElementById("dashboard"),this.perfEl=document.getElementById("perf-dashboard"),this.netStatsText=document.getElementById("net-stats"),this.netChart=document.getElementById("net-chart"),this.netChartCtx=this.netChart?this.netChart.getContext("2d"):null,this._renderer=null,this.frameTimeAvg=0,this.gpuInfo=null,this.gpuMemInfo=null,this._gl=null,this.debugInfo=document.getElementById("debug-info"),this.debugName=document.getElementById("debug-target-name"),this.debugId=document.getElementById("debug-target-id"),this.settings.debugMode?this.debugInfo.style.display="block":this.debugInfo.style.display="none",this.timeRemaining=30,this.lastTime=performance.now(),this.frames=0,this.fps=0,this.lastFpsTime=performance.now(),this.lastFrameTime=performance.now(),this.raycaster=new J,this.mouse=new Y,this.hoveredEnemy=null,this.hoveredPlayer=null,this.currentOutlinedEnemy=null,this.hoverInfo=document.getElementById("hover-info"),this.scopeOverlay=document.getElementById("scope-overlay"),this.minimapContainer=document.getElementById("minimap"),this.minimapCanvas=document.getElementById("minimap-canvas"),this.minimapCtx=this.minimapCanvas?this.minimapCanvas.getContext("2d"):null,this.minimapSize=this.minimapCanvas?this.minimapCanvas.width:180,this.mapSize=e&&e.mapSize?e.mapSize:200,this.multiplayer=null,window.addEventListener("mousemove",s=>{const o=s.clientX/window.innerWidth*2-1,n=-(s.clientY/window.innerHeight)*2+1;if(this.mouse.set(o,n),this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const a=[];this.player.enemyManager.enemies.forEach(h=>{h.mesh.traverse(r=>{r.isMesh&&a.push(r)})}),this.raycaster.setFromCamera(this.mouse,this.player.camera);const l=this.raycaster.intersectObjects(a,!0);if(l.length>0){const h=l[0].object;let r=h,c=null;for(;r&&(c=this.player.enemyManager.enemies.find(d=>r.parent===d.mesh||r===d.mesh||d.mesh.children.includes(r)),!c);)r=r.parent;this.hoveredEnemy=c||h||null}else this.hoveredEnemy=null}});try{this.slots.forEach((s,o)=>{const n=a=>{try{a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),this.player&&typeof this.player.switchWeapon=="function"&&this.player.switchWeapon(o)}catch{}};s.addEventListener("pointerdown",n),s.addEventListener("touchstart",n,{passive:!1}),s.addEventListener("click",n)})}catch{}}update(){var l,h;if(this.hoveredEnemy=null,this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0&&this.currentOutlinedEnemy!==this.hoveredEnemy){if(this.currentOutlinedEnemy&&this.currentOutlinedEnemy._outline){try{this.currentOutlinedEnemy.mesh.remove(this.currentOutlinedEnemy._outline)}catch{}this.currentOutlinedEnemy._outline=null}if(this.hoveredEnemy&&this.hoveredEnemy.mesh){const r=new T;this.hoveredEnemy.mesh.traverse(c=>{if(c.isMesh){const d=new g(c.geometry,new Me({color:16776960,side:ct}));d.position.copy(c.position),d.quaternion.copy(c.quaternion),d.scale.copy(c.scale).multiplyScalar(1.06),d.renderOrder=999,d.material.depthTest=!0,r.add(d)}}),this.hoveredEnemy.mesh.add(r),this.hoveredEnemy._outline=r}this.currentOutlinedEnemy=this.hoveredEnemy}this.frames++;const t=performance.now();t-this.lastFpsTime>=1e3&&(this.fpsCounter.innerText=this.frames,this.frames=0,this.lastFpsTime=t,performance.memory&&this.memoryUsage&&(this.memoryUsage.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)));const e=t-this.lastFrameTime;if(this.lastFrameTime=t,this.frameTimeAvg=this.frameTimeAvg===0?e:this.frameTimeAvg*.9+e*.1,this.player.enemyManager&&(this.enemyCount.innerText=this.player.enemyManager.enemies.length,this.killCount.innerText=this.player.enemyManager.killedCount||0),this.dropCount){const r=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;if(r&&Array.isArray(r.items)){const c=r.items.filter(d=>!(d.userData&&d.userData.isOpened)).length;this.dropCount.innerText=c}else this.dropCount.innerText="0"}const i=(this.player.distanceTraveled/1e3).toFixed(2);if(this.distanceTraveled&&(this.distanceTraveled.innerText=i),this.playerSpeed){let r=0;this.player.isInVehicle&&typeof this.player.currentSpeed=="number"?r=this.player.currentSpeed*3.6:typeof this.player.currentSpeed=="number"&&(r=this.player.currentSpeed*3.6),this.playerSpeed.innerText=r.toFixed(1)}if(this.mapSizeText){const r=this.world&&this.world.mapSize?this.world.mapSize:this.mapSize;this.mapSizeText.innerText=Math.round(r)}if(this._renderer){if(this.isPerfCollapsed())return;const r=this._renderer.info;this.perfFrame&&(this.perfFrame.innerText=e.toFixed(1)),this.perfCalls&&(this.perfCalls.innerText=r.render.calls),this.perfTris&&(this.perfTris.innerText=r.render.triangles),this.perfGeoms&&(this.perfGeoms.innerText=r.memory.geometries),this.perfTextures&&(this.perfTextures.innerText=r.memory.textures),this.perfPrograms&&(this.perfPrograms.innerText=r.programs?r.programs.length:"0");let c=0;this.world&&Array.isArray(this.world.objects)&&(c+=this.world.objects.length);const d=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;d&&Array.isArray(d.items)&&(c+=d.items.length),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&(c+=this.player.enemyManager.enemies.length),this.perfObjects&&(this.perfObjects.innerText=c),this.perfMem&&performance.memory&&(this.perfMem.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)),this.perfCpu&&(this.perfCpu.innerText=`${this.frameTimeAvg.toFixed(1)} ms`),this.perfGpu&&(this.perfGpu.innerText=this.gpuInfo||"Unsupported"),this.updateGpuMemory()}this.updateNetPanel(),this.healthBar.style.width=`${this.player.health}%`,this.healthText.innerText=Math.ceil(this.player.health),this.shieldBar.style.width=`${this.player.shield}%`,this.shieldText.innerText=Math.ceil(this.player.shield),this.staminaBar.style.width=`${this.player.stamina}%`,this.staminaText.innerText=Math.ceil(this.player.stamina);const s=this.player.weapons[this.player.currentWeaponIndex];if(this.weaponName.innerText=s.name,this.player.isReloading?this.ammoCount.innerText="RELOADING...":this.ammoCount.innerText=s.ammo===1/0?"":`${s.currentMag} / ${s.ammo}`,this.debugContainer&&(this.debugContainer.innerHTML=""),this.debugInfo)if(this.settings.debugMode)if(this.debugInfo.style.display="block",this.hoveredEnemy){const r=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,c=r&&r.userData&&r.userData.gameName?r.userData.gameName:"Enemy",d=r&&r.userData&&(r.userData.gameId||r.userData.gameid)?r.userData.gameId||r.userData.gameid:"---",f=this.hoveredEnemy.position?this.hoveredEnemy.position:r?r.position:null,u=f?this.player.position.distanceTo(f).toFixed(2):"---";this.debugName.innerText=c,this.debugId.innerText=`${d} (${u}m)`}else this.debugName.innerText="None",this.debugId.innerText="---";else this.debugInfo.style.display="none";let o=null;if(this.hoveredPlayer=null,!this.hoveredEnemy&&this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const r=[];if(this.player.enemyManager.enemies.forEach(c=>{c.mesh.traverse(d=>{d.isMesh&&r.push(d)})}),r.length>0){this.raycaster.setFromCamera(new Y(0,0),this.player.camera);const c=this.raycaster.intersectObjects(r,!0);if(c.length>0){let f=c[0].object,u=null;for(;f&&(u=this.player.enemyManager.enemies.find(m=>f.parent===m.mesh||f===m.mesh||m.mesh.children.includes(f)),!u);)f=f.parent;u?this.hoveredEnemy=u:this.hoveredEnemy=null}else this.hoveredEnemy=null}}if(!this.hoveredEnemy&&this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0){const r=[];if(this.multiplayer.others.forEach(c=>{c&&(c.isMesh?r.push(c):c.traverse&&c.traverse(d=>{d.isMesh&&r.push(d)}))}),r.length>0){this.raycaster.setFromCamera(new Y(0,0),this.player.camera);const c=this.raycaster.intersectObjects(r,!0);if(c.length>0){let d=c[0].object;for(;d.parent&&!((l=d.userData)!=null&&l.nick)&&!this.multiplayer.others.has((h=d.userData)==null?void 0:h.gameId);)d=d.parent;this.hoveredPlayer=d}}}if(this.hoverInfo)if(this.hoveredEnemy){const r=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,c=r&&r.userData&&(r.userData.gameId||r.userData.gameid)?r.userData.gameId||r.userData.gameid:"---",d=this.hoveredEnemy.position?this.hoveredEnemy.position:r?r.position:null;o=d?this.player.position.distanceTo(d):null;const f=o?o.toFixed(2):"---";this.hoverInfo.innerText=`${c}  ${f}m`}else if(this.hoveredPlayer){const r=this.hoveredPlayer.userData&&this.hoveredPlayer.userData.nick?this.hoveredPlayer.userData.nick:"Player";let c=null;this.hoveredPlayer.getWorldPosition?(c=new I,this.hoveredPlayer.getWorldPosition(c)):c=this.hoveredPlayer.position||null,o=c?this.player.position.distanceTo(c):null;const d=o?o.toFixed(2):"---";this.hoverInfo.innerText=`${r}  ${d}m`}else this.hoverInfo.innerText="";if(this.scopeOverlay){const r=this.player.weapons&&this.player.weapons[this.player.currentWeaponIndex],c=this.player.isAiming&&r&&r.name==="Sniper";this.scopeOverlay.classList.toggle("hidden",!c);const d=document.getElementById("crosshair");d&&d.classList.toggle("hidden",c)}const n=document.getElementById("crosshair");if(n){n.classList.remove("target-red","target-yellow");const r=this.player.weapons&&this.player.weapons[this.player.currentWeaponIndex],c=r&&r.range?r.range:1e3;this.hoveredEnemy&&o!==null&&(o<=c?n.classList.add("target-red"):n.classList.add("target-yellow"))}this.updateMinimap(),this.slots.forEach(r=>r.style.display="none"),this.player.weapons.forEach((r,c)=>{let d=this.slots[c];d&&(d.style.display="flex",d.innerText=c+1,c===this.player.currentWeaponIndex?d.classList.add("active"):d.classList.remove("active"))});const a=performance.now();if(a-this.lastTime>1e3){this.timeRemaining--,this.timeRemaining<0&&(this.timeRemaining=0);const r=Math.floor(this.timeRemaining/60).toString().padStart(2,"0"),c=(this.timeRemaining%60).toString().padStart(2,"0");this.timerValue.innerText=`${r}:${c}`,this.lastTime=a}this.player.isDead&&this.player.gameMode!=="matrix"&&this.showGameOver("YOU DIED"),this.updateTargetInspect()}showSelectionInfo(t,e){if(!this.selectionInfo)return;const i=t||"Object",s=e||"---";this.selectionInfo.innerText=`${i} (${s})`,this.selectionInfo.classList.remove("hidden"),this.selectionInfoTimeout&&clearTimeout(this.selectionInfoTimeout),this.selectionInfoTimeout=setTimeout(()=>{try{this.selectionInfo.classList.add("hidden")}catch{}},2500)}updateTargetInspect(){if(!this.targetInspect||!this.player||!this.player.camera)return;const t=this.raycaster,e=new Y(0,0);t.setFromCamera(e,this.player.camera);const i=[];if(this.world&&Array.isArray(this.world.objects)&&i.push(...this.world.objects),this.world&&this.world.itemManager&&Array.isArray(this.world.itemManager.items)&&i.push(...this.world.itemManager.items),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&this.player.enemyManager.enemies.forEach(r=>{r&&r.mesh&&i.push(r.mesh)}),i.length===0){this.targetInspect.innerText="Target: ---";return}const s=Array.from(new Set(i)),o=t.intersectObjects(s,!0);if(!o.length){this.targetInspect.innerText="Target: ---";return}let n=null;for(let r=0;r<o.length;r++){let c=o[r].object;for(;c;){if(c.userData&&(c.userData.gameName||c.userData.type||c.userData.gameId||c.userData.gameid)){n=c.userData;break}c=c.parent}if(n)break}if(!n){this.targetInspect.innerText="Target: ---";return}const a=n.gameName||"Object",l=n.gameId||n.gameid||"---",h=n.type||"---";this.targetInspect.innerText=`Target: ${a} (ID: ${l}) [${h}]`}showGameOver(t){if(this.player&&this.player.gameMode==="matrix"||this.gameOverShown)return;this.gameOverShown=!0,this.gameOverScreen.classList.remove("hidden"),document.getElementById("game-over-title").innerText=t;try{const i=document.getElementById("touch-controls");i&&(i.style.display="none")}catch{}this.hotbar&&(this.hotbar.style.display="none");const e=document.getElementById("restart-btn");e.onclick=()=>{location.reload()},e.style.pointerEvents="auto",e.style.cursor="pointer";try{typeof window<"u"&&window.game&&t&&t.toUpperCase().includes("DIED")&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(Kt)}catch{}}showVictory(){if(!(this.player&&this.player.gameMode==="matrix")){this.gameOverShown=!1,this.showGameOver("VICTORY ROYALE!"),document.getElementById("game-over-title").style.color="#f1c40f";try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}try{const t=document.getElementById("touch-controls");t&&(t.style.display="none")}catch{}try{this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch{}try{typeof window<"u"&&window.game&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(Jt)}catch{}}}updateMinimap(){if(!this.minimapContainer)return;const t=this.settings.showMinimap!==!1;if(this.minimapContainer.classList.toggle("hidden",!t),!t||!this.minimapCtx||!this.player)return;const e=this.minimapCtx,i=this.minimapSize;e.clearRect(0,0,i,i),e.fillStyle="rgba(10, 12, 20, 0.75)",e.fillRect(0,0,i,i),e.strokeStyle="rgba(255, 255, 255, 0.25)",e.lineWidth=2,e.strokeRect(1,1,i-2,i-2);const s=Math.max(1,this.world&&this.world.halfMapSize?this.world.halfMapSize:this.mapSize/2),o=i*.45,n=i/2,a=i/2;if(this.world&&typeof this.world.stormRadius=="number"&&this.world.stormRadius>0){const d=Math.max(0,Math.min(1.2,this.world.stormRadius/s)),f=o*d;e.beginPath(),e.strokeStyle="rgba(157, 77, 187, 0.85)",e.lineWidth=3,e.arc(n,a,f,0,Math.PI*2),e.stroke()}const l=this.player&&this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)?this.player.enemyManager.enemies:[];l.length&&(e.fillStyle="#ff3b30",e.strokeStyle="#660000",e.lineWidth=1.5,l.forEach(d=>{if(!d)return;const f=d.position||d.mesh&&d.mesh.position;if(!f)return;const u=Math.max(n-o,Math.min(n+o,n+f.x/s*o)),m=Math.max(a-o,Math.min(a+o,a-f.z/s*o));e.beginPath(),e.arc(u,m,4,0,Math.PI*2),e.fill(),e.stroke()}));const h=this.world&&Array.isArray(this.world.objects)?this.world.objects.filter(d=>d&&d.userData&&d.userData.type==="house"):[];h.length&&(e.fillStyle="#ffd166",e.strokeStyle="#8c5a00",e.lineWidth=1,h.forEach(d=>{const f=d.position;if(!f)return;const u=Math.max(n-o,Math.min(n+o,n+f.x/s*o)),m=Math.max(a-o,Math.min(a+o,a-f.z/s*o));e.beginPath(),e.arc(u,m,3,0,Math.PI*2),e.fill(),e.stroke()}));const r=Math.max(n-o,Math.min(n+o,n+this.player.position.x/s*o)),c=Math.max(a-o,Math.min(a+o,a-this.player.position.z/s*o));e.beginPath(),e.fillStyle="#00d8ff",e.strokeStyle="#ffffff",e.lineWidth=2,e.arc(r,c,6,0,Math.PI*2),e.fill(),e.stroke(),this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach(d=>{if(!d||!d.position)return;const f=Math.max(n-o,Math.min(n+o,n+d.position.x/s*o)),u=Math.max(a-o,Math.min(a+o,a-d.position.z/s*o)),m=d.userData&&d.userData.color?d.userData.color:"#ffaa00";e.beginPath(),e.fillStyle=m,e.strokeStyle="#111",e.lineWidth=2,e.arc(f,u,5,0,Math.PI*2),e.fill(),e.stroke()});try{const d=new I;if(this.player&&this.player.camera&&this.player.camera.getWorldDirection&&this.player.camera.getWorldDirection(d),d.y=0,d.lengthSq()<1e-4&&this.player.mesh&&(d.set(0,0,-1).applyEuler(this.player.mesh.rotation),d.y=0),d.lengthSq()>1e-4){d.normalize();const f=d.x,u=-d.z,m=Math.atan2(u,f)+Math.PI/2;e.save(),e.translate(r,c),e.rotate(m),e.beginPath(),e.moveTo(0,-10),e.lineTo(6,8),e.lineTo(-6,8),e.closePath(),e.fillStyle="#00d8ff",e.strokeStyle="#003f4f",e.lineWidth=2,e.fill(),e.stroke(),e.restore()}}catch{}}updateNetPanel(){if(this.isPerfCollapsed()||!this.netStatsText&&!this.netChartCtx)return;const t=this.multiplayer&&typeof this.multiplayer.getNetStats=="function"?this.multiplayer.getNetStats():null;if(!t){this.netStatsText&&(this.netStatsText.innerText="offline"),this.netChartCtx&&this.netChartCtx.clearRect(0,0,this.netChart.width,this.netChart.height);return}const e=(t.txPerSec||0)/1024,i=(t.rxPerSec||0)/1024,s=typeof t.lastPing=="number"?`${Math.max(0,t.lastPing).toFixed(0)} ms`:"--";if(this.netStatsText&&(this.netStatsText.innerText=` ${e.toFixed(1)} kbps  ${i.toFixed(1)} kbps  ping ${s}`),!this.netChartCtx||!this.netChart)return;const o=this.netChartCtx,n=this.netChart.width,a=this.netChart.height,l=Array.isArray(t.history)?t.history:[];if(o.clearRect(0,0,n,a),!l.length)return;const h=l.reduce((m,p)=>Math.max(m,Math.max(p.tx||0,p.rx||0)/1024),1),r=2,c=l.length,d=m=>c<=1?r:r+m/(c-1)*(n-r*2),f=m=>{const p=Math.max(0,Math.min(1,m/1024/h));return a-r-p*(a-r*2)};o.strokeStyle="rgba(255,255,255,0.12)",o.beginPath(),o.moveTo(r,a-r),o.lineTo(n-r,a-r),o.stroke();const u=(m,p)=>{o.strokeStyle=m,o.beginPath(),l.forEach((v,y)=>{const S=d(y),E=f(p(v)||0);y===0?o.moveTo(S,E):o.lineTo(S,E)}),o.stroke()};u("rgba(0, 210, 255, 0.85)",m=>m.rx||0),u("rgba(255, 150, 50, 0.85)",m=>m.tx||0)}updateGpuMemory(){if(!this.perfGpuMem)return;if(!this.gpuMemInfo||!this._gl){if(performance.memory){const s=(performance.memory.usedJSHeapSize/1048576).toFixed(1),o=(performance.memory.jsHeapSizeLimit/1048576).toFixed(0);this.perfGpuMem.innerText=`${s} / ${o} MB (heap)`}else this.perfGpuMem.innerText="Unsupported";return}const t=performance.now();if(!this.gpuMemInfo.lastUpdate||t-this.gpuMemInfo.lastUpdate>1e3)try{const s=this._gl.getParameter(this.gpuMemInfo.ext.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX);this.gpuMemInfo.lastAvailKb=s||this.gpuMemInfo.lastAvailKb,this.gpuMemInfo.lastUpdate=t}catch{}const e=this.gpuMemInfo.totalKb?this.gpuMemInfo.totalKb/1024:null,i=this.gpuMemInfo.lastAvailKb?this.gpuMemInfo.lastAvailKb/1024:null;if(e&&i){const s=Math.max(0,e-i);this.perfGpuMem.innerText=`${s.toFixed(1)} / ${e.toFixed(1)} MB`}else i?this.perfGpuMem.innerText=`${i.toFixed(1)} MB free`:this.perfGpuMem.innerText="Unknown"}initGpuInfo(){if(!(!this._renderer||this.gpuInfo))try{const t=this._renderer.getContext();this._gl=t;const e=t.getExtension("WEBGL_debug_renderer_info"),i=e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):t.getParameter(t.RENDERER);this.gpuInfo=i||"Unknown GPU";const s=t.getExtension("WEBGL_gpu_memory_info");if(s){const o=t.getParameter(s.GPU_MEMORY_INFO_TOTAL_AVAILABLE_MEMORY_KB)||t.getParameter(s.GPU_MEMORY_INFO_DEDICATED_VIDMEM_NVX)||null,n=t.getParameter(s.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX)||null;this.gpuMemInfo={ext:s,totalKb:o,lastAvailKb:n,lastUpdate:0}}}catch{this.gpuInfo="Unknown GPU"}}setRenderer(t){this._renderer=t,this.initGpuInfo()}setMultiplayer(t){this.multiplayer=t}isPerfCollapsed(){return this.perfEl&&this.perfEl.classList.contains("collapsed")}}const Qt="/threejs-voxel-firecraft/dist/assets/mixkit-kill-blood-zombie-By90BKfb.ogg",ei="/threejs-voxel-firecraft/dist/assets/zombie-B8PCKsyJ.ogg";class ti{constructor(t,e,i,s){this.scene=t,this.player=e,this.world=i,this.enemies=[],this.spawnInterval=5e3,this.lastSpawn=0,this.killedCount=0,this.groanBuffer=null;const o=s&&(s.gameMode==="matrix"||s.gameMode==="studio"||s.gameMode==="matrix-ai")?0:s?s.enemyCount:15;this.targetCount=o,this.difficulty=s?s.difficulty:"medium",this.gameMode=s&&s.gameMode?s.gameMode:"arcade",this.studioAiEnabled=!1;for(let n=0;n<o;n++)this.spawnEnemy();this.deathBuffer=null;try{const n=window.AudioContext||window.webkitAudioContext;n&&(this.audioCtx=new n,fetch(Qt).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.deathBuffer=a,this.enemies.forEach(l=>{l.audioCtx=this.audioCtx,l.deathBuffer=a})}).catch(a=>{}),fetch(ei).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.groanBuffer=a,this.enemies.forEach(l=>{l.audioCtx=this.audioCtx,l.groanBuffer=a})}).catch(a=>{}))}catch{}}spawnEnemy(t=!1,e=null){if(!t&&(this.gameMode==="matrix"||this.gameMode==="studio"))return;const i=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let s=(Math.random()-.5)*i,o=(Math.random()-.5)*i;if(this.gameMode==="studio"&&this.player&&(s=this.player.position.x+(Math.random()-.5)*5,o=this.player.position.z+(Math.random()-.5)*5),this.gameMode==="matrix-ai"&&this.player){const c=(this.world&&this.world.halfMapSize?this.world.halfMapSize:100)*.6;let d=0;for(;d<10;){const f=this.player.position.x,u=this.player.position.z,m=s-f,p=o-u;if(Math.sqrt(m*m+p*p)>=c)break;s=(Math.random()-.5)*i,o=(Math.random()-.5)*i,d++}}const n=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(s,o):0,a=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let l=!1,h=e||"normal";if(e)h==="big"&&(l=!0);else if(this.gameMode==="survival"){const c=this.enemies.filter(m=>m.isBig).length,d=this.enemies.filter(m=>m.zombieType==="slender").length,f=Math.floor(this.targetCount/5),u=Math.floor(this.targetCount/10);if(c<f)l=!0,h="big";else if(d<u)h="slender";else{const m=this.enemies.filter(v=>!v.isBig&&v.zombieType==="normal").length;h=this.enemies.filter(v=>!v.isBig&&v.zombieType==="fat").length<m?"fat":"normal"}}else if(this.gameMode==="arcade"){const c=this.enemies.filter(f=>f.zombieType==="slender").length,d=Math.floor(this.targetCount/10);if(c<d)h="slender";else{const f=this.enemies.filter(m=>m.zombieType==="normal").length;h=this.enemies.filter(m=>m.zombieType==="fat").length<f?"fat":"normal"}}const r=new Ve(this.scene,s,n,o,this.difficulty,a,this.player,l,h);return r.audioCtx=this.audioCtx,r.deathBuffer=this.deathBuffer,r.groanBuffer=this.groanBuffer,r.world=this.world,this.gameMode==="studio"&&(r.studioMode=!0,r.isStudioNPC=!0),this.enemies.push(r),t&&this.gameMode==="studio"&&(this.studioAiEnabled=!1),r}spawnEnemyAt(t,e,i="normal"){const s=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(t,e):0,o=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let n=!1,a=i;a==="big"&&(n=!0);const l=new Ve(this.scene,t,s,e,this.difficulty,o,this.player,n,a);return l.audioCtx=this.audioCtx,l.deathBuffer=this.deathBuffer,l.groanBuffer=this.groanBuffer,l.world=this.world,l.studioMode=!0,l.isStudioNPC=!0,this.enemies.push(l),l}setTargetCount(t){typeof t=="number"&&t>=0&&(this.targetCount=t)}update(t){if(this.gameMode!=="matrix"&&!(this.gameMode==="studio"&&!this.studioAiEnabled)&&(this.enemies.forEach(e=>{if(e.update(t,this.player),Math.sqrt(e.position.x*e.position.x+e.position.z*e.position.z)>this.world.stormRadius&&e.takeDamage(5*t),this.world&&typeof this.world.halfMapSize=="number"){const s=this.world.halfMapSize-1;e.position.x=Math.max(-s,Math.min(s,e.position.x)),e.position.z=Math.max(-s,Math.min(s,e.position.z))}}),this.enemies=this.enemies.filter(e=>e.readyToDespawn?(this.killedCount++,!1):!0),this.gameMode==="survival"&&this.targetCount!==void 0&&this.targetCount>0)){const e=this.targetCount-this.enemies.length;if(e>0)for(let i=0;i<e;i++)this.spawnEnemy()}}getEnemyById(t){return t&&this.enemies.find(e=>e&&e.mesh&&e.mesh.userData&&e.mesh.userData.gameId===t)||null}applyRemoteZombieHit(t,e){const i=this.getEnemyById(t);return!i||i.isDead?null:(i.takeDamage(e),i.health)}syncZombieState(t,e){const i=this.getEnemyById(t);if(!i)return;i.health=e;const s=i.maxHealth||100,o=Math.max(0,i.health/s);i.healthBarFg&&(i.healthBarFg.scale.x=o),e<=0&&!i.isDead&&i.startDeath()}}class Ve{constructor(t,e,i,s,o,n=100,a=null,l=!1,h="normal"){this.scene=t,this.position=new I(e,i,s),this.mapHalfSize=n,this.world=null,this.player=a,this.isBig=l,this.zombieType=h,this.deathTimer=0,this.deathDuration=0,this.deathFallProgress=0,this.readyToDespawn=!1,this.groanBuffer=null,this.groanCooldown=0,this.groanRange=15,this._groanSource=null,this._groanGain=null,o==="easy"?(this.health=50,this.damage=2,this.speed=3):o==="hard"?(this.health=150,this.damage=10,this.speed=6):(this.health=100,this.damage=5,this.speed=4.5),this.isBig&&(this.health*=5,this.damage*=2,this.speed*=.75),this.zombieType==="fat"&&(this.health*=1.5,this.speed*=.5),this.zombieType==="slender"&&(this.health*=.8,this.speed*=1.5,this.damage*=1.5,this.attackRange=3),this.maxHealth=this.health,this.state="wander",this.isDead=!1,this.attackRange=this.isBig?3.5:2,this.detectionRange=25,this.attackCooldown=1.5,this.lastAttack=0,this.wanderTarget=null,this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4,this.createMesh()}createMesh(){let t="Zombie";this.isBig?t="Big Zombie":this.zombieType==="fat"?t="Fat Zombie":this.zombieType==="slender"&&(t="Slenderman");let e;const i=this.position.x,s=this.position.y,o=this.position.z;this.zombieType==="slender"?e=Et(this.scene,i,s,o):this.isBig?e=kt(this.scene,i,s,o):this.zombieType==="fat"?e=St(this.scene,i,s,o):this.zombieType==="spider"?e=Ct(this.scene,i,s,o):e=bt(this.scene,i,s,o),this.mesh=e.mesh,this.leftArmPivot=e.leftArmPivot,this.rightArmPivot=e.rightArmPivot,this.leftLegPivot=e.leftLegPivot,this.rightLegPivot=e.rightLegPivot,this.mesh.userData={gameId:Math.random().toString(36).substr(2,9).toUpperCase(),gameName:t},this.animTime=0,this.attackAnimTime=0,this.attackAnimDuration=.5,this.createHealthBar()}createHealthBar(){const t=new U(1,.1),e=new Me({color:0});this.healthBarBg=new g(t,e);const i=this.zombieType==="slender"?3:2.3;this.healthBarBg.position.y=i,this.mesh.add(this.healthBarBg);const s=new U(1,.1),o=new Me({color:16711680});this.healthBarFg=new g(s,o),this.healthBarFg.position.y=i,this.healthBarFg.position.z=.01,this.mesh.add(this.healthBarFg)}update(t,e){if(this.isDead){this.updateDeath(t);return}this.groanCooldown=Math.max(0,this.groanCooldown-t),this.groanBuffer&&this.audioCtx&&e&&this.groanCooldown<=0&&this.position.distanceTo(e.position)<=this.groanRange&&(this.playGroan(),this.groanCooldown=2+Math.random()*2.5);const i=e.position;if(this.healthBarBg.lookAt(i),this.healthBarFg.lookAt(i),this.studioMode||this.isStudioNPC){this.animTime+=t,this.animateIdle();return}const s=this.position.distanceTo(i);s<this.detectionRange?this.state="chase":this.state="wander";let o=!1;if(this.state==="chase"){const n=this.hasLineOfSight(e,i);if(s<this.detectionRange&&n){const a=new I().subVectors(i,this.position).normalize();if(a.y=0,s>2){const h=a.clone(),r=Math.sin(performance.now()/500+this.position.x)*.5,c=new I(a.z,0,-a.x).multiplyScalar(r);h.add(c).normalize();const d=this.position.clone().add(h.multiplyScalar(this.speed*t));this.checkCollision(d)||this.position.copy(d),this.mesh.lookAt(i),o=!0}else{const h=a.clone().multiplyScalar(-1),r=this.position.clone().add(h.multiplyScalar(this.speed*t*.5));this.checkCollision(r)||this.position.copy(r),this.mesh.lookAt(i)}if(s<this.attackRange){const h=performance.now()/1e3;h-this.lastAttack>this.attackCooldown&&(e.takeDamage(this.damage),this.lastAttack=h,this.attackAnimTime=this.attackAnimDuration)}}else this.state="wander"}else{if(this.wanderTimer+=t,!this.wanderTarget||this.wanderTimer>this.wanderChangeInterval){const n=10+Math.random()*30,a=Math.random()*Math.PI*2,l=this.position.x+Math.cos(a)*n,h=this.position.z+Math.sin(a)*n,r=(u,m,p)=>Math.max(m,Math.min(p,u)),c=this.mapHalfSize*.9,d=r(l,-c,c),f=r(h,-c,c);this.wanderTarget=new I(d,0,f),this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4}if(this.wanderTarget){const n=new I().subVectors(this.wanderTarget,this.position);n.y=0,n.length()>.5?(n.normalize(),this.position.add(n.multiplyScalar(this.speed*t*.5)),this.mesh.lookAt(this.wanderTarget.x,this.position.y,this.wanderTarget.z),o=!0):(this.wanderTimer+=t,this.wanderTimer>this.wanderChangeInterval&&(this.wanderTarget=null,this.wanderTimer=0))}}if(this.mesh.position.copy(this.position),this.world&&typeof this.world.getHeightAt=="function"){const n=this.world.getHeightAt(this.position.x,this.position.z);this.mesh.position.y=Math.max(this.mesh.position.y,n),this.position.y=this.mesh.position.y}if(o){this.animTime+=t*5;const n=Math.sin(this.animTime)*.5;this.leftLegPivot.rotation.x=n,this.rightLegPivot.rotation.x=-n,this.leftArmPivot.rotation.x=-Math.PI/3+n*.2,this.rightArmPivot.rotation.x=-Math.PI/3-n*.2}else this.state!=="attack"&&(this.leftLegPivot.rotation.x=0,this.rightLegPivot.rotation.x=0,this.leftArmPivot.rotation.x=-Math.PI/3,this.rightArmPivot.rotation.x=-Math.PI/3);if(this.attackAnimTime>0){this.attackAnimTime=Math.max(0,this.attackAnimTime-t);const n=1-this.attackAnimTime/this.attackAnimDuration,a=Math.sin(n*Math.PI)*1.5;if(this.leftArmPivot.rotation.x=-Math.PI/2+a*.2,this.rightArmPivot.rotation.x=-Math.PI/2-a*.2,n>.3&&n<.7){const l=new I;this.mesh.getWorldDirection(l),l.y=0,l.normalize(),this.position.add(l.multiplyScalar(.02))}}}takeDamage(t){this.health-=t;const e=this.maxHealth||100,i=Math.max(0,this.health/e);this.healthBarFg.scale.x=i,this.mesh.traverse(s=>{if(s.isMesh&&s!==this.healthBarBg&&s!==this.healthBarFg){const o=s.material;if(!s.userData.originalColor&&o&&o.color)try{s.userData.originalColor=o.color.clone()}catch{s.userData.originalColor=null}if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new oe(16711680);else if(o&&o.color)try{o.color=o.color.clone().lerp(new oe(16711680),.6)}catch{}}}),setTimeout(()=>{this.isDead||this.mesh.traverse(s=>{if(s.isMesh&&s!==this.healthBarBg&&s!==this.healthBarFg){const o=s.material;if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new oe(0);else if(o&&o.color&&s.userData&&s.userData.originalColor)try{o.color.copy(s.userData.originalColor)}catch{}}})},100),this.health<=0&&!this.isDead&&this.startDeath()}playDeathSound(){try{const t=this.audioCtx.createBufferSource();t.buffer=this.deathBuffer;const e=this.audioCtx.createGain();e.gain.value=.7,t.connect(e),e.connect(this.audioCtx.destination),t.start(0)}catch(t){console.warn("playDeathSound error:",t)}}checkCollision(t){if(!this.scene)return!1;const e=.5;for(let i of this.scene.children)if(i.userData&&(i.userData.type==="house"||i.userData.type==="tree")){const s=i.position,o=Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.z-s.z,2)),n=i.userData.type==="house"?5:2;if(o<e+n)return!0}return!1}hasLineOfSight(t,e){if(!this.scene)return!0;const i=new I().subVectors(e,this.position).normalize(),s=this.position.distanceTo(e),n=new J(this.position.clone().add(new I(0,1,0)),i,0,s).intersectObjects(this.scene.children,!0);for(let a of n){if(a.object===this.mesh||a.object.parent===this.mesh||a.object===t.mesh||a.object.parent===t.mesh)continue;let l=a.object;for(;l.parent&&l.parent!==this.scene;)l=l.parent;if(l.userData&&(l.userData.type==="house"||l.userData.type==="tree"))return!1}return!0}startDeath(){this.isDead=!0,this.deathTimer=0,this.deathFallProgress=0,this.deathDuration=3+Math.random()*2,this.stopGroan(),this.healthBarBg&&(this.healthBarBg.visible=!1),this.healthBarFg&&(this.healthBarFg.visible=!1);const t=25,e=this.player&&this.player.position;if(e?this.position.distanceTo(e)<=t:!0)try{this.audioCtx&&this.deathBuffer&&(this.audioCtx.state==="suspended"?this.audioCtx.resume().then(()=>{this.playDeathSound()}):this.audioCtx.state==="running"&&this.playDeathSound())}catch(s){console.warn("Error playing death sound:",s)}}updateDeath(t){this.deathFallProgress=Math.min(1,this.deathFallProgress+t*2.5);const e=-Math.PI/2*this.deathFallProgress;this.mesh&&(this.mesh.rotation.x=e,this.mesh.position.y=Math.max(0,this.mesh.position.y-t*.6)),this.deathTimer+=t,this.deathTimer>=(this.deathDuration||3)&&(this.mesh&&this.mesh.parent&&this.scene.remove(this.mesh),this.readyToDespawn=!0)}playGroan(){try{if(!this.audioCtx||!this.groanBuffer)return;if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playGroan());return}const t=this.audioCtx.createBufferSource();t.buffer=this.groanBuffer;const e=this.audioCtx.createGain();e.gain.value=.45,t.connect(e),e.connect(this.audioCtx.destination),t.onended=()=>{this._groanSource=null,this._groanGain=null},t.start(0),this._groanSource=t,this._groanGain=e}catch(t){console.warn("playGroan error:",t)}}stopGroan(){if(this._groanSource){try{this._groanSource.stop()}catch{}try{this._groanSource.disconnect()}catch{}this._groanSource=null}if(this._groanGain){try{this._groanGain.disconnect()}catch{}this._groanGain=null}}}class ii{constructor(t,e,i){this.scene=t,this.player=e,this.items=[],this.interactionPrompt=document.getElementById("interaction-prompt"),this.mapSize=i&&i.mapSize?i.mapSize:Ce,this.spawnSpan=this.mapSize*.75,this.glowRadius=7,this.world=null,this.settings=i||{},this.matrixDropInterval=5,this._matrixDropTimer=0,this.matrixDropBatchSize=10,this.matrixDropRadiusLimit=10,this.initLoot(),document.addEventListener("keydown",s=>{s.code==="KeyE"&&this.tryInteract()})}setWorld(t){this.world=t,this.realignItemsToGround()}getClampedCoord(t,e){if(this.world&&typeof this.world.halfMapSize=="number"){const i=this.world.halfMapSize-1;return{x:Math.max(-i,Math.min(i,t)),z:Math.max(-i,Math.min(i,e))}}return{x:t,z:e}}initLoot(){if(this.settings.gameMode==="matrix"||this.settings.gameMode==="studio"||this.settings.gameMode==="matrix-ai"||this.settings.skipLoot)return;for(let e=0;e<24;e++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.createChest(i,.5,s)}for(let e=0;e<36;e++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.spawnJuiceBottle(i,s)}const t=[2899536,15105570,1752220,15158332,10181046];for(let e=0;e<8;e++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s));const o=t[e%t.length];this.spawnBackpack(i,s,o)}for(let e=0;e<12;e++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.spawnMedKit(i,s)}}createChest(t,e,i){this.spawnChest(t,i)}spawnChest(t,e){const i=new T;({x:t,z:e}=this.getClampedCoord(t,e));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(t,e)+.5),i.position.set(t,s,e);const o=new x(1,.8,.6),n=new w({color:15844367,roughness:.3,metalness:.5}),a=new g(o,n);i.add(a);const l=new x(1,.2,.6),h=new g(l,n);h.position.y=.5,i.add(h);const r=new g(new x(.2,.3,.1),new w({color:9807270}));r.position.set(0,.3,.3),i.add(r),i.castShadow=!0,i.receiveShadow=!0;const c=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],d=c[Math.floor(Math.random()*c.length)];i.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:d};const f=this.createGlowEffect();return f.position.y=1,i.add(f),i.userData.glow=f,this.scene.add(i),this.items.push(i),i}spawnChestWithLoot(t,e,i){const s=new T;({x:t,z:e}=this.getClampedCoord(t,e));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(t,e)+.5),s.position.set(t,o,e);const n=new x(1,.8,.6),a=new w({color:15844367,roughness:.3,metalness:.5}),l=new g(n,a);s.add(l);const h=new x(1,.2,.6),r=new g(h,a);r.position.y=.5,s.add(r);const c=new g(new x(.2,.3,.1),new w({color:9807270}));c.position.set(0,.3,.3),s.add(c),s.castShadow=!0,s.receiveShadow=!0,s.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:i};const d=this.createGlowEffect();return d.position.y=1,s.add(d),s.userData.glow=d,this.scene.add(s),this.items.push(s),s}spawnJuiceBottle(t,e){const i=new T;({x:t,z:e}=this.getClampedCoord(t,e));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(t,e)+.5),i.position.set(t,s,e);const o=new g(new R(.2,.2,.6,8),new w({color:2600544}));o.position.y=.5,i.add(o);const n=new g(new R(.12,.12,.15,8),new w({color:12597547}));n.position.y=.9,i.add(n),i.castShadow=!0,i.receiveShadow=!0,i.userData={type:"stamina",gameId:this.generateID(),gameName:"JuiceBottle",amount:50};const a=this.createGlowEffect();return a.position.y=.9,i.add(a),i.userData.glow=a,this.scene.add(i),this.items.push(i),i}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}spawnLootInHouse(t,e,i){this.spawnChest(t,i)}spawnBackpack(t,e,i){const s=new T;({x:t,z:e}=this.getClampedCoord(t,e));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(t,e)+.5),s.position.set(t,o,e);const n=new g(new x(.7,.9,.35),new w({color:i,metalness:.15,roughness:.8}));s.add(n);const a=new g(new x(.6,.25,.16),new w({color:3426654,metalness:.1,roughness:.8}));a.position.set(0,-.55,.18),s.add(a),s.castShadow=!0,s.receiveShadow=!0;const l=this.createGlowEffect();return l.position.y=1,s.add(l),s.userData={type:"backpack",color:i,gameId:this.generateID(),gameName:"Backpack",isOpened:!1,glow:l},this.scene.add(s),this.items.push(s),s}spawnMedKit(t,e){const i=new T;({x:t,z:e}=this.getClampedCoord(t,e));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(t,e)+.3),i.position.set(t,s,e);const o=new g(new x(.8,.5,.6),new w({color:15790320,metalness:.2,roughness:.6}));i.add(o);const n=new g(new x(.5,.05,.15),new w({color:15158332,metalness:.1,roughness:.4}));n.position.y=.28,i.add(n);const a=new g(new x(.15,.05,.5),new w({color:15158332,metalness:.1,roughness:.4}));a.position.y=.28,i.add(a);const l=new g(new x(.6,.1,.08),new w({color:9807270,metalness:.4,roughness:.5}));l.position.y=.35,i.add(l);const h=new g(new x(.15,.08,.08),new w({color:8359053,metalness:.5,roughness:.4}));h.position.set(0,0,.32),i.add(h),i.castShadow=!0,i.receiveShadow=!0;const r=this.createGlowEffect();return r.position.y=.6,i.add(r),i.userData={type:"medkit",gameId:this.generateID(),gameName:"MedKit",healAmount:25,isOpened:!1,glow:r},this.scene.add(i),this.items.push(i),i}spawnMatrixLoadout(t=0,e=0){[{dx:2,dz:0,loot:"Pistol"},{dx:-2,dz:0,loot:"Rifle"},{dx:0,dz:2,loot:"Sniper"},{dx:0,dz:-2,loot:"ShieldPotion"},{dx:2,dz:2,loot:"SMG"},{dx:-2,dz:-2,loot:"Shotgun"},{dx:-2,dz:2,loot:"DMR"}].forEach(o=>{this.spawnChestWithLoot(t+o.dx,e+o.dz,o.loot)}),this.spawnJuiceBottle(t+3,e+3),this.spawnJuiceBottle(t-3,e-3),[2899536,15105570,1752220].forEach((o,n)=>{this.spawnBackpack(t+(n-1)*2,e+4,o)})}countNearbyChests(t=10){if(!this.player)return 0;const e=this.player.position;let i=0;return this.items.forEach(s=>{const o=s.userData||{};if(o.type!=="chest"||o.isOpened)return;const n=s.position.x-e.x,a=s.position.z-e.z;Math.sqrt(n*n+a*a)<=t&&i++}),i}createUmbrella(){const t=new T,e=new g(new R(.08,.08,1.6,6),new w({color:4863016,roughness:.8}));e.position.y=-.2,t.add(e),[16726832,15844367,3447003].forEach((o,n)=>{const a=new g(new x(1.8-n*.3,.15,1.8-n*.3),new w({color:o,roughness:.4,metalness:.2}));a.position.y=.7+n*.12,t.add(a)});const s=new g(new De(.2,.25,6),new w({color:2899536}));return s.position.y=1.1,t.add(s),t.castShadow=!0,t.receiveShadow=!0,t}spawnMatrixDropNearPlayer(){if(!this.player)return;const t=Math.random()*Math.PI*2,e=4+Math.random()*8;let i=this.player.position.x+Math.cos(t)*e,s=this.player.position.z+Math.sin(t)*e;({x:i,z:s}=this.getClampedCoord(i,s));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(i,s)+.5);const n=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],a=n[Math.floor(Math.random()*n.length)],l=this.spawnChestWithLoot(i,s,a);if(l){l.position.y=o+18,l.userData.isDropping=!0,l.userData.dropTargetY=o,l.userData.dropVelocity=0;const h=this.createUmbrella();h.position.y=1.2,l.add(h),l.userData.umbrella=h}}spawnMatrixDropsBatch(){if(this.countNearbyChests(this.matrixDropRadiusLimit)>=this.matrixDropBatchSize)return;const t=this.matrixDropBatchSize-this.countNearbyChests(this.matrixDropRadiusLimit),e=Math.max(0,Math.min(this.matrixDropBatchSize,t));for(let i=0;i<e;i++)this.spawnMatrixDropNearPlayer()}update(t=.016){const e=Math.max(0,t||0);this.settings.gameMode==="matrix"&&this.player&&(this._matrixDropTimer+=e,this._matrixDropTimer>=this.matrixDropInterval&&(this._matrixDropTimer=0,this.spawnMatrixDropsBatch())),this.items.forEach(o=>{const n=o.userData||{};if(n.isDropping&&(n.dropVelocity=(n.dropVelocity||0)+5*e,o.position.y-=n.dropVelocity*e,o.position.y<=n.dropTargetY&&(o.position.y=n.dropTargetY,n.isDropping=!1,n.dropVelocity=0,n.umbrella))){try{o.remove(n.umbrella)}catch{}n.umbrella=null}});let i=null;const s=this.player.position;for(const o of this.items){if(o.userData&&o.userData.isOpened)continue;const n=s.distanceTo(o.position);if(this.updateGlow(o,n),n<3){i=o;break}}if(!(this.interactionPrompt&&this.interactionPrompt.dataset.vehiclePrompt==="1"))if(i){this.interactionPrompt.classList.remove("hidden");const o=i.userData||{};if(o.type==="chest")this.interactionPrompt.innerText=`Press E to open (Contains: ${o.loot})`;else if(o.type==="stamina")this.interactionPrompt.innerText=`Press E to collect ${o.gameName} (+${o.amount} Stamina)`;else if(o.type==="medkit")this.interactionPrompt.innerText=`Press E to use ${o.gameName} (+${o.healAmount}% Health)`;else if(o.type==="backpack"){const n=o.color?"#"+o.color.toString(16).padStart(6,"0"):"";this.interactionPrompt.innerText=`Press E to equip Backpack ${n}`}else this.interactionPrompt.innerText="Press E to interact";this.currentItem=i}else this.interactionPrompt.classList.add("hidden"),this.currentItem=null}tryInteract(){if(this.currentItem){const t=this.currentItem.userData;if(!t)return;if(t.type==="chest"&&!t.isOpened)t.isOpened=!0,this.scene.remove(this.currentItem),this.player.collectItem(t.loot),console.log(`Looted ${t.loot}!`);else if(t.type==="stamina"){const e=t.amount||50;this.player&&(this.player.stamina=Math.min(100,this.player.stamina+e)),this.scene.remove(this.currentItem),t.isOpened=!0,console.log(`Picked up stamina item: +${e}`)}else if(t.type==="medkit"){const e=t.healAmount||25;if(this.player){const s=100*e/100;this.player.health=Math.min(100,this.player.health+s),console.log(`Used MedKit: +${s} HP (${e}%)`)}this.scene.remove(this.currentItem),t.isOpened=!0}else if(t.type==="backpack"){const e=t.color||2899536;if(this.player&&typeof this.player.collectItem=="function"){const i=this.player.collectItem(`Backpack:${e.toString(16)}`);if(i!=null){const s=this.player.position.clone();this.spawnBackpack(s.x+.5,s.z+.5,i)}}this.scene.remove(this.currentItem),t.isOpened=!0,console.log(`Equipped backpack ${e.toString(16)}`)}}}realignItemsToGround(){!this.world||typeof this.world.getHeightAt!="function"||this.items.forEach(t=>{const e=t.position,i=this.world.getHeightAt(e.x,e.z),s=(t.userData&&t.userData.type==="chest",.5);t.position.y=i+s})}updateGlow(t,e){if(!t||!t.userData||!t.userData.glow)return;const i=t.userData.glow,s=!t.userData.isOpened&&e<this.glowRadius;i.visible=s,s&&(i.rotation.y+=.02,i.position.y=(t.userData.type==="chest"?1:.9)+Math.sin(performance.now()/500)*.1)}createGlowEffect(){const e=new Float32Array(120),i=.6;for(let a=0;a<40;a++){const l=i*Math.random(),h=Math.random()*Math.PI*2,r=Math.random()*i*.6;e[a*3]=Math.cos(h)*l,e[a*3+1]=r,e[a*3+2]=Math.sin(h)*l}const s=new Ue;s.setAttribute("position",new ke(e,3));const o=new dt({color:16765286,size:.15,transparent:!0,opacity:.9,depthWrite:!1,blending:ut,sizeAttenuation:!0}),n=new mt(s,o);return n.visible=!1,n}}class si{constructor(t,e={}){this.player=t,this.container=document.getElementById("touch-controls"),this.enabled=!0,this.layout=e&&e.layout?e.layout:{},this._cleanupExistingControls(),this.isEditing=!1,this.buttonHelpers=new Map,this._suppressDragUntil=0,this.joystick=document.createElement("div"),this.joystick.className="tc-joystick",this.joystick.style.zIndex="210",this.stick=document.createElement("div"),this.stick.className="tc-stick",this.joystick.appendChild(this.stick),this.buttons=document.createElement("div"),this.buttons.className="tc-buttons",this.buttons.style.zIndex="210",this.fireBtn=document.createElement("button"),this.fireBtn.className="tc-btn tc-btn-fire",this.fireBtn.innerText="FIRE",this.jumpBtn=document.createElement("button"),this.jumpBtn.className="tc-btn",this.jumpBtn.innerText="JUMP",this.sprintBtn=document.createElement("button"),this.sprintBtn.className="tc-btn",this.sprintBtn.innerText="SPRINT",this.interactBtn=document.createElement("button"),this.interactBtn.className="tc-btn tc-interact-btn",this.interactBtn.innerText="E",this.interactBtn.style.display="none",this.crouchBtn=document.createElement("button"),this.crouchBtn.className="tc-btn",this.crouchBtn.innerText="CROUCH",this.crouchBtn.style.fontSize="16px",this.buttons.appendChild(this.fireBtn),this.buttons.appendChild(this.jumpBtn),this.buttons.appendChild(this.sprintBtn),this.buttons.appendChild(this.crouchBtn),this.buttons.appendChild(this.interactBtn),this.container.appendChild(this.joystick),this.container.appendChild(this.buttons),this.container.classList.remove("hidden"),this.applyLayout(),this._initDragHandles(),this.active=!1,this.startPos=null,this.currentPos={x:0,y:0},this.lookActive=!1,this.lookStartPos=null,this._bindJoystick(),this._bindButtons(),this._bindLookArea(),this._setupEditToggleGesture(),this.deadZone=10,this.maxRadius=50,document.body.style.touchAction="none";try{this.player&&(this.player.allowTouchMovement=!0)}catch{}}_dispatchTouchLook(t,e){try{window.dispatchEvent(new CustomEvent("game-touch-look",{detail:{dx:t,dy:e}}))}catch{}}destroy(){try{this.container.classList.add("hidden"),this.destroyLookArea(),this.container.removeChild(this.joystick),this.container.removeChild(this.buttons),document.body.style.touchAction="",this.player&&(this.player.allowTouchMovement=!1)}catch{}}applyLayout(){const t=this.layout.joystickLeft!==void 0?this.layout.joystickLeft:10,e=this.layout.joystickBottom!==void 0?this.layout.joystickBottom:12,i=this.layout.buttonsRight!==void 0?this.layout.buttonsRight:8,s=this.layout.buttonsBottom!==void 0?this.layout.buttonsBottom:12,o=this.layout.buttonGapVh!==void 0?this.layout.buttonGapVh:14/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={});const n=(l,h)=>{this.layout.buttonPositions[l]||(this.layout.buttonPositions[l]={right:i,bottom:s+o*h})};n("fire",0),n("jump",1),n("sprint",2),n("crouch",3),n("interact",4),this.joystick.style.left=`${t}vw`,this.joystick.style.bottom=`${e}vh`,this.buttons.style.position="absolute",this.buttons.style.top="0",this.buttons.style.left="0",this.buttons.style.right="0",this.buttons.style.bottom="0",this.buttons.style.display="block",this.buttons.style.pointerEvents="none";const a=(l,h)=>{const r=this.layout.buttonPositions[h];r&&(l.style.position="absolute",l.style.right=`${r.right}vw`,l.style.bottom=`${r.bottom}vh`,l.style.pointerEvents="auto")};a(this.fireBtn,"fire"),a(this.jumpBtn,"jump"),a(this.sprintBtn,"sprint"),a(this.crouchBtn,"crouch"),a(this.interactBtn,"interact")}_cleanupExistingControls(){if(!this.container)return;this.container.querySelectorAll(".tc-joystick, .tc-buttons, .tc-look-area").forEach(e=>{try{e.parentNode.removeChild(e)}catch{}})}_initDragHandles(){const t=()=>{try{const o=localStorage.getItem("touch-layout");if(o){const n=JSON.parse(o);this.layout={...this.layout,...n}}}catch{}},e=()=>{try{localStorage.setItem("touch-layout",JSON.stringify(this.layout))}catch{}};t(),this.applyLayout(),((o,n)=>{let a=!1,l=0,h=0;const r=10,c=u=>{const m=u.touches?u.touches[0]:u;if(!a){const p=m.clientX-l,v=m.clientY-h;if(Math.sqrt(p*p+v*v)<r)return;a=!0}{const p=m.clientX/window.innerWidth*100;this.layout.joystickLeft=Math.max(0,Math.min(80,p));const v=(window.innerHeight-m.clientY)/window.innerHeight*100;this.layout.joystickBottom=Math.max(0,Math.min(80,v))}this.applyLayout(),u.preventDefault&&u.preventDefault()},d=()=>{a&&(a=!1,e()),document.removeEventListener("touchmove",c,{passive:!1}),document.removeEventListener("touchend",d),document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",d)},f=u=>{if(!this.isEditing||this._shouldSuppressDrag()||u.touches&&u.touches.length>1)return;const m=u.touches?u.touches[0]:u;l=m.clientX,h=m.clientY,a=!1,document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",d),document.addEventListener("pointermove",c),document.addEventListener("pointerup",d)};o.addEventListener("touchstart",f,{passive:!0}),o.addEventListener("pointerdown",f)})(this.joystick);const s=(o,n)=>{let a=!1,l=0,h=0;const r=10,c=u=>{if(!a)return;const m=u.touches?u.touches[0]:u,p=(window.innerWidth-m.clientX)/window.innerWidth*100,v=(window.innerHeight-m.clientY)/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={}),this.layout.buttonPositions[n]={right:Math.max(0,Math.min(90,p)),bottom:Math.max(0,Math.min(90,v))},this.applyLayout(),u.preventDefault&&u.preventDefault()},d=()=>{a&&(a=!1,e()),document.removeEventListener("touchmove",c,{passive:!1}),document.removeEventListener("touchend",d),document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",d)},f=u=>{if(!this.isEditing||this._shouldSuppressDrag()||u.touches&&u.touches.length>1)return;const m=u.touches?u.touches[0]:u;l=m.clientX,h=m.clientY,a=!1,document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",d),document.addEventListener("pointermove",c),document.addEventListener("pointerup",d)};o.addEventListener("touchstart",f,{passive:!0}),o.addEventListener("pointerdown",f),o.addEventListener("touchmove",u=>{if(!this.isEditing||this._shouldSuppressDrag()||a)return;const m=u.touches?u.touches[0]:u,p=m.clientX-l,v=m.clientY-h;Math.sqrt(p*p+v*v)>r&&(a=!0)},{passive:!0}),o.addEventListener("pointermove",u=>{if(u.pointerType!=="touch"||!this.isEditing||this._shouldSuppressDrag()||a)return;const m=u.clientX-l,p=u.clientY-h;Math.sqrt(m*m+p*p)>r&&(a=!0)})};s(this.fireBtn,"fire"),s(this.jumpBtn,"jump"),s(this.sprintBtn,"sprint"),s(this.crouchBtn,"crouch"),s(this.interactBtn,"interact")}_bindJoystick(){this.joystick.addEventListener("touchstart",e=>{e.preventDefault();const i=e.changedTouches[0];this.joystick.getBoundingClientRect(),this.startPos={x:i.clientX,y:i.clientY},this.active=!0}),this.joystick.addEventListener("touchmove",e=>{if(!this.active)return;e.preventDefault();const i=e.changedTouches[0],s=i.clientX-this.startPos.x,o=i.clientY-this.startPos.y,n=Math.sqrt(s*s+o*o),a=Math.atan2(o,s),l=Math.min(this.maxRadius,n),h=Math.cos(a)*l,r=Math.sin(a)*l;this.stick.style.transform=`translate(${h}px, ${r}px)`;const c=s/this.maxRadius,d=o/this.maxRadius;this.player.moveForward=d<-.3,this.player.moveBackward=d>.3,this.player.moveLeft=c<-.3,this.player.moveRight=c>.3});const t=e=>{this.active&&(e.preventDefault(),this.active=!1,this.startPos=null,this.stick.style.transform="translate(0,0)",this.player.moveForward=!1,this.player.moveBackward=!1,this.player.moveLeft=!1,this.player.moveRight=!1)};this.joystick.addEventListener("touchend",t),this.joystick.addEventListener("touchcancel",t)}_bindButtons(){let t=null,e=null;const i=()=>{t&&(clearInterval(t),t=null)};this._stopFireInterval=i,this.fireBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&(i(),e&&(clearTimeout(e),e=null),this.player&&typeof this.player.shoot=="function"&&(this.player.shoot(),e=setTimeout(()=>{t=setInterval(()=>{this.player&&typeof this.player.shoot=="function"&&this.player.shoot()},150)},220)))});const s=o=>{o&&o.preventDefault&&o.preventDefault(),!this.isEditing&&(e&&(clearTimeout(e),e=null),i())};this.fireBtn.addEventListener("touchend",s),this.fireBtn.addEventListener("touchcancel",s),this.fireBtn.addEventListener("pointerup",o=>{o.pointerType==="touch"&&s(o)}),this.fireBtn.addEventListener("pointercancel",o=>{o.pointerType==="touch"&&s(o)}),this.fireBtn.addEventListener("mouseup",s),this.fireBtn.addEventListener("mouseleave",s),this.jumpBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&this.player.canJump===!0&&(this.player.velocity.y+=this.player.jumpHeight,this.player.canJump=!1)}),this.sprintBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.stamina<=0?this.player.isSprinting=!1:this.player.isSprinting=!this.player.isSprinting,this._updateSprintButton())}),this.interactBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&window.game&&window.game.itemManager&&window.game.itemManager.tryInteract()}),this.crouchBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.isCrouching=!this.player.isCrouching,this.crouchBtn.style.background=this.player.isCrouching?"rgba(52, 152, 219, 0.9)":"rgba(241, 196, 15, 0.9)")})}update(){window.game&&window.game.itemManager&&window.game.itemManager.currentItem?this.interactBtn.style.display="block":this.interactBtn.style.display="none";try{this.player&&this.player.stamina!==void 0&&(this.player.isSprinting&&this.player.stamina<=0&&(this.player.isSprinting=!1),this._updateSprintButton())}catch{}}destroyLookArea(){try{this.lookArea&&this.container&&this.lookArea.parentElement===this.container&&this.container.removeChild(this.lookArea)}catch{}this.lookArea=null}rebuildLookArea(){this.destroyLookArea(),this._bindLookArea()}_bindLookArea(){try{if(this.lookArea)try{this.container.removeChild(this.lookArea)}catch{}this.lookArea=document.createElement("div"),this.lookArea.className="tc-look-area",this.lookArea.style.position="absolute",this.lookArea.style.top="0",this.lookArea.style.bottom="0",this.lookArea.style.right="0",this.lookArea.style.left="0",this.lookArea.style.width="100%",this.lookArea.style.zIndex="190",this.lookArea.style.background="transparent",this.lookArea.style.touchAction="none",this.lookArea.style.pointerEvents="auto",this.container.appendChild(this.lookArea);let t=null,e=0,i=0;this.lookArea.addEventListener("touchstart",o=>{if(t!==null)return;const n=o.changedTouches[0];t=n.identifier,e=n.clientX,i=n.clientY,o.cancelable&&o.preventDefault()},{passive:!1}),this.lookArea.addEventListener("touchmove",o=>{if(t!==null){o.cancelable&&o.preventDefault();for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===t){const a=o.changedTouches[n],l=a.clientX-e,h=a.clientY-i;e=a.clientX,i=a.clientY,this._dispatchTouchLook(l,h);break}}},{passive:!1});const s=o=>{if(t!==null){for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===t){t=null;break}}};this.lookArea.addEventListener("touchend",s),this.lookArea.addEventListener("touchcancel",s)}catch{}}_getButtons(){return[this.fireBtn,this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_getEditToggleTargets(){return[this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_setupEditToggleGesture(){let t=0,e=0;const i=700,s=n=>{n.touches&&n.touches.length>=2&&(n.preventDefault(),n.stopPropagation(),t=0,this._suppressDrag(),this._toggleEditMode())},o=n=>{const a=performance.now();a-e<i?t+=1:t=1,e=a,t>=3&&(n.preventDefault(),n.stopPropagation(),t=0,this._suppressDrag(),this._toggleEditMode())};this._getEditToggleTargets().forEach(n=>{n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("touchend",o,{passive:!1}),n.addEventListener("touchcancel",()=>{t=0},{passive:!0}),n.addEventListener("pointerdown",a=>{a.pointerType})})}_updateSprintButton(){if(!this.player)return;const t=!!this.player.isSprinting;this.sprintBtn.style.background=t?"rgba(46, 204, 113, 0.9)":"rgba(241, 196, 15, 0.9)"}_toggleEditMode(){this.isEditing?this._exitEditMode():this._enterEditMode()}_enterEditMode(){this.isEditing=!0,typeof this._stopFireInterval=="function"&&this._stopFireInterval(),this._showButtonHelpers(),this._suppressDrag()}_exitEditMode(){this.isEditing=!1,this._hideButtonHelpers()}_showButtonHelpers(){this._getButtons().forEach(t=>{t.classList.add("tc-btn-editing");let e=this.buttonHelpers.get(t);e||(e=document.createElement("div"),e.className="tc-btn-helper",e.style.position="absolute",e.style.inset="-8px",e.style.border="2px dashed rgba(255, 255, 255, 0.75)",e.style.borderRadius="22px",e.style.pointerEvents="none",e.style.boxShadow="0 0 12px rgba(255, 255, 255, 0.5)",e.style.animation="tc-btn-helper-pulse 1.6s ease-in-out infinite",e.style.opacity="0.9",this.buttonHelpers.set(t,e)),t.contains(e)||(e.setAttribute("aria-hidden","true"),t.appendChild(e))})}_hideButtonHelpers(){this._getButtons().forEach(t=>{t.classList.remove("tc-btn-editing");const e=this.buttonHelpers.get(t);e&&e.parentNode===t&&t.removeChild(e)})}_suppressDrag(t=450){this._suppressDragUntil=performance.now()+t}_shouldSuppressDrag(){return performance.now()<this._suppressDragUntil}}class oi{constructor({player:t,scene:e,url:i,nick:s="Player",color:o="#29b6f6",roomCode:n="PUBLIC",settings:a=null}){this.player=t,this.scene=e,this.url=i,this.nick=s,this.color=o,this.roomCode=n||"PUBLIC",this.socket=null,this.id=null,this.others=new Map,this.lastSend=0,this.sendInterval=.05,this.lastSentPos=null,this.lastSentRot=null,this.lastAnimSig=null,this.heartbeatTimer=0,this.isHost=!1,this.roomSettings=a,this._manualClose=!1,this.deadPeers=new Set,this.matchLive=!1,this.remoteStates=new Map,this.remoteLastYaw=new Map,this.interpDelayMs=100,this.maxBufferMs=1e3,this.maxExtrapMs=80,this.remoteFaceOffset=0,this._now=typeof performance<"u"&&performance.now.bind(performance)||Date.now,this._tmpVec=new I,this.enemyManager=null,this.netStats={txBytes:0,rxBytes:0,txPerSec:0,rxPerSec:0,lastSample:this._now(),history:[]},this.lastPingSent=0,this.pingInterval=5,this.connect()}applyColorToTorso(t,e){if(!t||!e)return;let i=!1;const s=new oe(e);return t.traverse(o=>{if(!o.isMesh||!o.material||Array.isArray(o.material))return;const n=o.userData&&o.userData.gameName?o.userData.gameName.toLowerCase():"";(n.includes("body")||n.includes("torso")||n.includes("shirt")||n.includes("clothes")||o.geometry&&o.geometry.parameters&&Math.abs(o.geometry.parameters.width-.6)<.05)&&(o.material=o.material.clone(),o.material.color=s,i=!0)}),t.userData&&(t.userData.color=e),i}connect(){if(!this.url){console.warn("Multiplayer URL not configured.");const t=document.getElementById("ai-log");if(t){const e=document.createElement("div");e.textContent="Multiplayer URL not set in settings.",e.style.color="#ff9b9b",t.appendChild(e)}return}try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.sendJoin()},this.socket.onmessage=t=>this.handleMessage(t),this.socket.onclose=()=>{this.others.forEach(t=>{try{this.scene.remove(t)}catch{}}),this.others.clear(),this.deadPeers.clear(),this.matchLive=!1,this._manualClose||setTimeout(()=>this.connect(),1500)},this.socket.onerror=()=>{}}catch(t){console.warn("Multiplayer connect failed:",t)}}handleMessage(t){var e;try{const i=typeof t.data=="string"?t.data.length:0,s=JSON.parse(t.data);if(i>0&&this.trackRx(i),s.type!=="hello"){if(s.type==="welcome")this.id=s.id,this.isHost=!!s.isHost,s.settings&&(this.roomSettings=s.settings),s.custom&&(this.localCustom=s.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount()),this.onHostChanged&&this.onHostChanged(this.isHost),s.settings&&this.onSettings&&this.onSettings(s.settings);else if(s.type==="player-join")s.id&&s.id!==this.id&&this.ensureRemote(s.id,null,s.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(s.type==="player-leave")this.removeRemote(s.id),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(s.type==="state"&&s.id!==this.id){if(this.deadPeers.has(s.id))return;const o=this.ensureRemote(s.id,s.color,s.custom),n=typeof s.ts=="number"?s.ts:this._now();this.bufferRemoteState(s.id,{t:n,pos:s.pos,rot:s.rot,fwd:s.fwd,anim:s.anim,nick:s.nick,color:s.color,custom:s.custom?{...s.custom}:null}),o&&s.color&&((e=o.userData)==null?void 0:e.color)!==s.color&&this.applyColorToTorso(o,s.color),this.applyRemoteCustomization(o,s.custom),o&&o.userData&&(o.userData.custom=s.custom?{...s.custom}:null)}else if(s.type==="hit")this.onHit&&this.onHit(s);else if(s.type==="host-changed")this.isHost=s.hostId===this.id,this.onHostChanged&&this.onHostChanged(this.isHost);else if(s.type==="start-countdown")this.onCountdown&&this.onCountdown(s.duration||10);else if(s.type==="match-start")this.onMatchStart&&this.onMatchStart(),this.matchLive=!0;else if(s.type==="settings")this.roomSettings=s.settings,this.onSettings&&this.onSettings(s.settings);else if(s.type==="zombie-hit"){if(this.isHost&&this.enemyManager&&s.id&&typeof s.amount=="number"){const o=this.enemyManager.applyRemoteZombieHit(s.id,s.amount);typeof o=="number"&&this.sendZombieState(s.id,o)}}else if(s.type==="zombie-state")this.enemyManager&&s.id&&typeof s.health=="number"&&this.enemyManager.syncZombieState(s.id,s.health);else if(s.type==="player-dead")s.id&&(this.deadPeers.add(s.id),this.killRemote(s.id),this.onPeerDeath&&this.onPeerDeath(s.id));else if(s.type==="pong"&&typeof s.ts=="number"){const o=this._now()-s.ts;this.netStats.lastPing=o}}}catch(i){console.warn("Multiplayer parse error:",i)}}ensureRemote(t,e=null,i=null){if(!t||t===this.id||this.deadPeers&&this.deadPeers.has(t))return null;if(this.others.has(t))return this.others.get(t);const s=this.clonePlayerAvatar(e);if(s)return s.userData={...s.userData||{},gameId:t,gameName:"Player",color:e||this.color},this.applyColorToTorso(s,e||this.color),s.traverse(l=>{l.isMesh&&(l.castShadow=!1,l.receiveShadow=!0)}),this.scene.add(s),this.others.set(t,s),s.userData&&(s.userData.custom=i?{...i}:null),this.applyRemoteCustomization(s,i),s;const o=new x(.8,1.8,.8),n=new w({color:e||this.color,emissive:0,roughness:.7}),a=new g(o,n);return a.position.y=1,a.userData={gameId:t,gameName:"Player"},this.scene.add(a),this.others.set(t,a),a.userData&&(a.userData.custom=i?{...i}:null),this.applyRemoteCustomization(a,i),a}removeRemote(t){const e=this.others.get(t);if(e){if(e.userData&&e.userData.label&&e.userData.label.parentNode)try{e.userData.label.parentNode.removeChild(e.userData.label)}catch{}try{this.scene.remove(e)}catch{}this.others.delete(t)}this.remoteStates.delete(t)}killRemote(t){const e=this.others.get(t);if(e){try{e.rotation.x=-Math.PI/2,e.userData.dead=!0}catch{}setTimeout(()=>{this.removeRemote(t)},3500)}}clonePlayerAvatar(t=null){if(!this.player||!this.player.mesh)return null;try{const e=this.player.mesh.clone(!0),i={leftArm:null,rightArm:null,leftLeg:null,rightLeg:null};return e.traverse(s=>{if(s.isMesh&&(s.castShadow=!0,s.receiveShadow=!0,s.material&&s.material.clone&&(s.material=s.material.clone()),s.geometry&&s.geometry.clone&&(s.geometry=s.geometry.clone()),t&&s.material&&!Array.isArray(s.material))){const o=s.userData&&s.userData.gameName?s.userData.gameName.toLowerCase():"";(o.includes("body")||o.includes("torso")||o.includes("shirt")||o.includes("clothes")||s.geometry&&s.geometry.parameters&&Math.abs(s.geometry.parameters.width-.6)<.05)&&(s.material=s.material.clone(),s.material.color=new oe(t))}s.userData&&(s.userData={...s.userData}),s.name==="leftArmPivot"?i.leftArm=s:s.name==="rightArmPivot"?i.rightArm=s:s.name==="leftLegPivot"?i.leftLeg=s:s.name==="rightLegPivot"&&(i.rightLeg=s)}),e.userData={...e.userData||{},pivots:i},e}catch(e){return console.warn("Failed to clone player avatar:",e),null}}applyRemoteAnimation(t,e){var s,o,n,a;if(!e||!t||!t.userData)return;const i=t.userData.pivots||{};try{i.leftArm&&typeof((s=e==null?void 0:e.arms)==null?void 0:s.leftX)=="number"&&(i.leftArm.rotation.x=e.arms.leftX),i.rightArm&&typeof((o=e==null?void 0:e.arms)==null?void 0:o.rightX)=="number"&&(i.rightArm.rotation.x=e.arms.rightX),i.leftLeg&&typeof((n=e==null?void 0:e.legs)==null?void 0:n.leftX)=="number"&&(i.leftLeg.rotation.x=e.legs.leftX),i.rightLeg&&typeof((a=e==null?void 0:e.legs)==null?void 0:a.rightX)=="number"&&(i.rightLeg.rotation.x=e.legs.rightX)}catch{}}update(t){var d,f,u;if(this.updateRemoteInterpolation(),this.sampleNetRates(),!this.socket||this.socket.readyState!==WebSocket.OPEN||(this.lastSend+=t,this.heartbeatTimer+=t,this.player&&!this.player.isDead&&(this.lastPingSent+=t,this.lastPingSent>=this.pingInterval&&(this.sendPing(),this.lastPingSent=0)),this.lastSend<this.sendInterval)||(this.lastSend=0,!this.player||!this.player.mesh)||this.player.isDead)return;const e=this.player.mesh.position,i={arms:{leftX:this.player.leftArmPivot?this.player.leftArmPivot.rotation.x:0,rightX:this.player.rightArmPivot?this.player.rightArmPivot.rotation.x:0},legs:{leftX:this.player.leftLegPivot?this.player.leftLegPivot.rotation.x:0,rightX:this.player.rightLegPivot?this.player.rightLegPivot.rotation.x:0}};let s=0,o={x:0,z:1};if(this.player&&this.player.camera&&this.player.camera.getWorldDirection){const m=new I;this.player.camera.getWorldDirection(m),m.y=0,m.lengthSq()<1e-6&&this.player.mesh&&this.player.mesh.rotation?(s=this.player.mesh.rotation.y,o={x:Math.sin(s),z:Math.cos(s)}):(m.normalize(),s=Math.atan2(m.x,m.z),o={x:m.x,z:m.z})}else{const m=typeof this.player.yaw=="number"?this.player.yaw:this.player.mesh&&this.player.mesh.rotation?this.player.mesh.rotation.y:0;s=this._wrapAngle(m),o={x:Math.sin(s),z:Math.cos(s)}}s=this._wrapAngle(s+Math.PI),o={x:Math.sin(s),z:Math.cos(s)};const n={type:"state",pos:{x:e.x,y:e.y,z:e.z},rot:s,fwd:o,nick:this.nick,color:this.color,anim:i,ts:this._now(),custom:{...this.getCustomization()}};let a=!1;this.lastSentPos?e.distanceTo?a=e.distanceTo(new I(this.lastSentPos.x,this.lastSentPos.y,this.lastSentPos.z))>.015:a=Math.abs(e.x-(((d=this.lastSentPos)==null?void 0:d.x)||0))>.015||Math.abs(e.y-(((f=this.lastSentPos)==null?void 0:f.y)||0))>.015||Math.abs(e.z-(((u=this.lastSentPos)==null?void 0:u.z)||0))>.015:a=!0;const l=`${i.arms.leftX.toFixed(3)},${i.arms.rightX.toFixed(3)},${i.legs.leftX.toFixed(3)},${i.legs.rightX.toFixed(3)}`,h=this.lastAnimSig!==l,r=Math.abs(this._angleDiff(this.lastSentRot??s,s))>.02,c=this.heartbeatTimer>=5;if(a||h||r||c){const m=JSON.stringify(n);try{this.socket.send(m)}catch{}this.trackTx(m.length),this.lastSentPos={x:e.x,y:e.y,z:e.z},this.lastAnimSig=l,this.lastSentRot=s,c&&(this.heartbeatTimer=0)}}dispose(){if(this._manualClose=!0,this.socket)try{this.socket.close()}catch{}this.others.forEach(t=>{try{this.scene.remove(t)}catch{}}),this.others.clear()}updateLabel(t,e){if(t.userData&&t.userData.label)try{t.userData.label.style.display="none"}catch{}t.userData&&(t.userData.nick=e||"Player")}sendHit(t,e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!t||typeof e!="number")return;const s=JSON.stringify({type:"hit",targetId:t,amount:e});try{this.socket.send(s)}catch{}this.trackTx(s.length)}getPeerCount(){return 1+this.others.size}sendJoin(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const t=JSON.stringify({type:"join",room:this.roomCode,nick:this.nick,color:this.color,custom:this.getCustomization()});this.socket.send(t),this.trackTx(t.length)}catch{}}sendStart(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const t=JSON.stringify({type:"start"});this.socket.send(t),this.trackTx(t.length)}catch{}}sendSettings(t){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&!(!this.isHost||!t))try{const e=JSON.stringify({type:"settings",settings:t});this.socket.send(e),this.trackTx(e.length)}catch{}}sendDeath(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&this.id)try{const t=JSON.stringify({type:"player-dead",id:this.id});this.socket.send(t),this.trackTx(t.length)}catch{}}isMatchLive(){return this.matchLive===!0}resetMatchState(){this.deadPeers.clear(),this.matchLive=!1}bufferRemoteState(t,e){if(!t||!e)return;const i=this.remoteStates.get(t)||[];if(typeof e.rot=="number"){const s=this.remoteLastYaw.get(t),o=this._unwrapAngle(e.rot,s);e.rot=o,this.remoteLastYaw.set(t,o)}for(i.push(e);i.length>24;)i.shift();this.remoteStates.set(t,i)}applyRemoteCustomization(t,e){if(!t||!e)return;const i=t.getObjectByName("playerHead");if(!i)return;this.removeNodesByRole(i,"playerMouth");const s=this._buildMouthMesh(e.mouthStyle||"serious");s&&i.add(s),this.setHatVisibility(i,e.showHat!==!1)}removeNodesByRole(t,e){if(!t)return;const i=[];t.traverse(s=>{s.userData&&s.userData.role===e&&i.push(s)}),i.forEach(s=>{s.parent&&s.parent.remove(s)})}setHatVisibility(t,e){t&&t.traverse(i=>{i.userData&&i.userData.role==="playerHat"&&(i.visible=e)})}_buildMouthMesh(t){const e=(t||"serious").toLowerCase(),i=new w({color:2824976,roughness:.6,metalness:0});let s=null;if(e==="smile"){const o=new T;o.userData={role:"playerMouth"},o.name="playerMouth";const n=i.clone(),a=new g(new x(.08,.04,.02),n),l=a.clone(),h=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,l.position.set(0,-.16,.26),h.position.set(.1,-.15,.26),h.rotation.z=.2,[a,l,h].forEach(r=>{r.userData={role:"playerMouth"},r.name="playerMouthSeg"}),o.add(a,l,h),s=o}else if(e==="angry"){const o=new w({color:5901324,roughness:.4});s=new g(new x(.26,.05,.02),o),s.position.set(0,-.16,.26),s.rotation.z=-.18}else if(e==="surprised")s=new g(new R(.06,.06,.02,20),i),s.position.set(0,-.14,.26),s.rotation.x=Math.PI/2;else{if(e==="none")return null;s=new g(new x(.22,.06,.02),i),s.position.set(0,-.16,.26)}return s.castShadow=!1,s.receiveShadow=!1,s.userData||(s.userData={}),s.userData.role="playerMouth",s.name=s.name||"playerMouth",s}updateRemoteInterpolation(){if(!this.remoteStates||this.remoteStates.size===0)return;const e=this._now()-this.interpDelayMs;this.remoteStates.forEach((i,s)=>{var j,O,G,te,Q,W,re,ie,$,X,q,ne,ae,se,ce,ee,H,de;if(!i||i.length===0)return;const o=this.others.get(s);if(!o)return;for(;i.length>2&&e-i[0].t>this.maxBufferMs;)i.shift();const n=i[i.length-1];let a=i[0],l=n;for(let z=1;z<i.length;z++)if(i[z].t>=e){a=i[z-1]||i[z],l=i[z];break}const h=l.t-a.t;let r=h>0?(e-a.t)/h:1;if(e>n.t&&e-n.t<=this.maxExtrapMs&&i.length>=2){const z=i[i.length-2],K=Math.max(1,n.t-z.t),me=(n.pos.x-z.pos.x)/K,pe=(n.pos.y-z.pos.y)/K,fe=(n.pos.z-z.pos.z)/K,he=e-n.t;this._tmpVec.set(n.pos.x+me*he,n.pos.y+pe*he,n.pos.z+fe*he),o.position.copy(this._tmpVec),o.rotation&&(typeof n.rot=="number"?o.rotation.y=this._wrapAngle(n.rot+this.remoteFaceOffset):n.fwd&&typeof n.fwd.x=="number"&&typeof n.fwd.z=="number"&&(o.rotation.y=this._wrapAngle(Math.atan2(n.fwd.x,n.fwd.z)+this.remoteFaceOffset))),this.applyRemoteAnimation(o,n.anim),this.updateLabel(o,n.nick);return}r=Math.min(1,Math.max(0,r));const c=((j=a.pos)==null?void 0:j.x)??0,d=((O=a.pos)==null?void 0:O.y)??0,f=((G=a.pos)==null?void 0:G.z)??0,u=((te=l.pos)==null?void 0:te.x)??c,m=((Q=l.pos)==null?void 0:Q.y)??d,p=((W=l.pos)==null?void 0:W.z)??f;this._tmpVec.set(c+(u-c)*r,d+(m-d)*r,f+(p-f)*r),o.position.copy(this._tmpVec);const v=typeof a.rot=="number"?a.rot:typeof((re=a.fwd)==null?void 0:re.x)=="number"&&typeof((ie=a.fwd)==null?void 0:ie.z)=="number"?Math.atan2(a.fwd.x,a.fwd.z):o.rotation.y||0,y=typeof l.rot=="number"?l.rot:typeof(($=l.fwd)==null?void 0:$.x)=="number"&&typeof((X=l.fwd)==null?void 0:X.z)=="number"?Math.atan2(l.fwd.x,l.fwd.z):v,S=v+this.remoteFaceOffset,E=y+this.remoteFaceOffset,k=z=>{for(;z>Math.PI;)z-=Math.PI*2;for(;z<-Math.PI;)z+=Math.PI*2;return z},C=E-S,P=S+C*r;o.rotation&&(o.rotation.y=k(P+this.remoteFaceOffset));const B=(z,K)=>(typeof z!="number"&&(z=0),typeof K!="number"&&(K=z),z+(K-z)*r),A=a.anim||{},_=l.anim||{},Z={arms:{leftX:B((q=A==null?void 0:A.arms)==null?void 0:q.leftX,(ne=_==null?void 0:_.arms)==null?void 0:ne.leftX),rightX:B((ae=A==null?void 0:A.arms)==null?void 0:ae.rightX,(se=_==null?void 0:_.arms)==null?void 0:se.rightX)},legs:{leftX:B((ce=A==null?void 0:A.legs)==null?void 0:ce.leftX,(ee=_==null?void 0:_.legs)==null?void 0:ee.leftX),rightX:B((H=A==null?void 0:A.legs)==null?void 0:H.rightX,(de=_==null?void 0:_.legs)==null?void 0:de.rightX)}};this.applyRemoteAnimation(o,Z);const L=l.custom||a.custom||(o.userData?o.userData.custom:null);this.applyRemoteCustomization(o,L),o.userData&&(o.userData.custom=L?{...L}:null),this.updateLabel(o,l.nick||a.nick)})}sendPing(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return;const t={type:"ping",ts:this._now()},e=JSON.stringify(t);try{this.socket.send(e)}catch{}this.trackTx(e.length)}trackTx(t){!t||t<=0||(this.netStats.txBytes+=t)}sendZombieHit(t,e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!t||typeof e!="number")return;const i=JSON.stringify({type:"zombie-hit",id:t,amount:e});try{this.socket.send(i)}catch{}this.trackTx(i.length)}sendZombieState(t,e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!t||typeof e!="number")return;const i=JSON.stringify({type:"zombie-state",id:t,health:e});try{this.socket.send(i)}catch{}this.trackTx(i.length)}trackRx(t){!t||t<=0||(this.netStats.rxBytes+=t)}sampleNetRates(){const t=this._now(),e=t-this.netStats.lastSample;if(e<1e3)return;const i=e/1e3,s=this.netStats.txBytes/i,o=this.netStats.rxBytes/i;for(this.netStats.txPerSec=s,this.netStats.rxPerSec=o,this.netStats.history.push({t,tx:s,rx:o,ping:this.netStats.lastPing||null});this.netStats.history.length>60;)this.netStats.history.shift();this.netStats.txBytes=0,this.netStats.rxBytes=0,this.netStats.lastSample=t}getNetStats(){return this.netStats}getCustomization(){return this.player?{mouthStyle:this.player.mouthStyle||"serious",showHat:this.player.showHat!==!1}:{mouthStyle:"serious",showHat:!0}}setEnemyManager(t){this.enemyManager=t}_wrapAngle(t){let e=t;for(;e>Math.PI;)e-=Math.PI*2;for(;e<-Math.PI;)e+=Math.PI*2;return e}_angleDiff(t,e){return this._wrapAngle(t-e)}_unwrapAngle(t,e){if(typeof e!="number")return t;let i=t,s=i-e;for(;s>Math.PI;)i-=Math.PI*2,s=i-e;for(;s<-Math.PI;)i+=Math.PI*2,s=i-e;return i}}function ni({maxLines:b=400,autoShow:t=!1}={}){const e=[],i={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)},s=document.createElement("div");s.id="debug-overlay",s.className="debug-overlay hidden";const o=document.createElement("div");o.className="debug-overlay-header",o.innerHTML="<strong>DEBUG</strong>";const n=document.createElement("div");n.className="debug-overlay-actions";const a=document.createElement("button");a.textContent="Clear";const l=document.createElement("button");l.textContent="Close",n.appendChild(a),n.appendChild(l),o.appendChild(n);const h=document.createElement("div");h.className="debug-overlay-list",s.appendChild(o),s.appendChild(h),document.body.appendChild(s),o.style.cursor="move";let r=!1,c=0,d=0;function f(k){if(!r)return;const C=Math.max(0,Math.min(window.innerWidth-s.offsetWidth,k.clientX-c)),P=Math.max(0,Math.min(window.innerHeight-s.offsetHeight,k.clientY-d));s.style.left=C+"px",s.style.top=P+"px",s.style.right="auto"}function u(k){r=!1,window.removeEventListener("pointermove",f),window.removeEventListener("pointerup",u);try{k&&k.pointerId&&s.releasePointerCapture&&s.releasePointerCapture(k.pointerId)}catch{}}o.addEventListener("pointerdown",k=>{try{const C=s.getBoundingClientRect();s.style.left=C.left+"px",s.style.top=C.top+"px",s.style.position="fixed",s.style.transform="none",s.style.right="auto",c=k.clientX-C.left,d=k.clientY-C.top,r=!0,window.addEventListener("pointermove",f),window.addEventListener("pointerup",u);try{s.setPointerCapture&&s.setPointerCapture(k.pointerId)}catch{}}catch{}},{passive:!1});function m(){h.innerHTML="";const k=Math.max(0,e.length-b);for(let C=k;C<e.length;C++){const P=document.createElement("div");P.className="debug-line debug-"+e[C].level;const B=new Date(e[C].ts).toLocaleTimeString();P.textContent=`[${B}] ${e[C].level.toUpperCase()}: ${e[C].msg}`,h.appendChild(P)}h.scrollTop=h.scrollHeight}function p(k,C){try{const P=C.map(B=>{try{return typeof B=="string"?B:JSON.stringify(B)}catch{return String(B)}}).join(" ");e.push({level:k,msg:P,ts:Date.now()}),e.length>b*2&&e.splice(0,e.length-b*2),m()}catch{}}console.log=function(...k){i.log(...k),p("log",k)},console.info=function(...k){i.info(...k),p("info",k)},console.warn=function(...k){i.warn(...k),p("warn",k)},console.error=function(...k){i.error(...k),p("error",k)};function v(k,C,P,B,A){typeof k=="string"?p("error",[k+" "+(C||"")+":"+(P||"?")]):k&&k.message&&p("error",[k.message,k.error||A])}function y(k){try{p("error",["UnhandledRejection",k&&k.reason?k.reason:k])}catch{}}window.addEventListener("error",v),window.addEventListener("unhandledrejection",y),a.addEventListener("click",()=>{e.length=0,m()}),l.addEventListener("click",()=>E());function S(){s.classList.remove("hidden")}function E(){s.classList.add("hidden")}return t&&S(),{show:S,hide:E,destroy(){console.log=i.log,console.info=i.info,console.warn=i.warn,console.error=i.error,window.removeEventListener("error",v),window.removeEventListener("unhandledrejection",y);try{s.remove()}catch{}},logs:e}}const ue=(()=>{try{return typeof navigator>"u"?!1:/Mobi|Android|iPhone|iPad|Tablet|Mobile/i.test(navigator.userAgent)||window.matchMedia&&window.matchMedia("(pointer: coarse)").matches}catch{return!1}})();window.addEventListener("unhandledrejection",b=>{try{const t=b.reason,e=t&&t.message?t.message:String(t);if(e&&e.includes("If you see this error we have a bug")){console.warn("Suppressed Chromium UnknownError:",e),b.preventDefault&&b.preventDefault();return}}catch{}});class ze{constructor(){this.scene=new pt,this.scene.background=new oe(8900331),this.scene.fog=new ft(8900331,20,100),this._animationStarted=!1,this._selectedMode="arcade",this._defaultRandom=Math.random,this._currentRandomSeed=null,this.matchSettings=null,this.lastPlaySettings=null,this.aiObjects=[],this.aiMaxAiObjects=200,this.renderer=new gt({antialias:!0});const t=ue?1:1.5;this.renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,t)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=yt,document.getElementById("game-container").appendChild(this.renderer.domElement),this._renderScaleApplied=this.renderer.getPixelRatio(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.forceFixedMultiplayerSpawn=!1;const e=new je(16777215,.6);this.scene.add(e);const i=new Pe(16777215,.8);i.position.set(50,100,50),i.castShadow=!0,i.shadow.camera.left=-100,i.shadow.camera.right=100,i.shadow.camera.top=100,i.shadow.camera.bottom=-100,i.shadow.camera.near=.1,i.shadow.camera.far=160,i.shadow.mapSize.width=1024,i.shadow.mapSize.height=1024,this.scene.add(i),this.dirLight=i,this.camera=new wt(75,window.innerWidth/window.innerHeight,.1,1e3),this.clock=new vt,this._pickRaycaster=new J,this._objectClickHandler=null,this._objectClickTarget=null,this._longPressTimer=null,this.hotkeyModalVisible=!1,this.isPaused=!1,this.pauseMenu=document.getElementById("pause-menu"),this.bgAudio=null,this.bgMusicVolume=.5,this._endSequenceAudio=null,this._prevBgVolume=null,this.autoPerfEnabled=!1,this._autoPerfTimer=0,this._renderScaleApplied=1,this.sfxVolume=.7,document.addEventListener("keydown",s=>{if(s.code==="Escape"&&this.togglePause(),this.player&&this.player.gameMode==="studio")if(s.code==="KeyL")try{this.spawnStudioDrops()}catch(o){console.warn("Studio drop failed:",o)}else s.code==="KeyH"&&this.toggleHotkeyModal(!this.hotkeyModalVisible)}),this.setupMenu(),this.setupLongPressMenu(),this.setMenuOpenState(!0),document.addEventListener("pointerlockerror",s=>{s.preventDefault&&s.preventDefault(),console.warn("Pointer lock request failed or was cancelled.")})}applyGraphicsSettings(t={}){if(!this.renderer)return;const e=!!t.performanceMode,i=Math.max(.5,Math.min(1,(t.renderScale||100)/100)),s=ue?1:e?1.25:1.5,o=Math.min((window.devicePixelRatio||1)*i,s);this.renderer.setPixelRatio(o),this.renderer.setSize(window.innerWidth,window.innerHeight);const n=!e;if(this.renderer.shadowMap.enabled=n,this.dirLight&&this.dirLight.shadow){this.dirLight.castShadow=n;const a=e?512:1024;this.dirLight.shadow.mapSize.width=a,this.dirLight.shadow.mapSize.height=a}}applyDeterministicRandom(t){if(!t)return;this._currentRandomSeed=t;const e=String(t);let i=1779033703^e.length;for(let n=0;n<e.length;n++)i=Math.imul(i^e.charCodeAt(n),3432918353),i=i<<13|i>>>19;i=Math.imul(i^i>>>16,2246822507),i=(i^i>>>13)>>>0;let s=i;Math.random=()=>{s=s+1831565813|0;let n=Math.imul(s^s>>>15,1|s);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}spawnStudioDrops(){if(!(!this.itemManager||!this.player||this.player.gameMode!=="studio"))try{for(let t=0;t<3;t++)this.itemManager.spawnMatrixDropNearPlayer()}catch(t){console.warn("spawnStudioDrops error:",t)}}toggleHotkeyModal(t){const e=document.getElementById("hotkey-modal");e&&(e.classList.toggle("hidden",!t),e.setAttribute("aria-hidden",t?"false":"true"),this.hotkeyModalVisible=t)}toggleTouchLookArea(t){try{if(!this.touchControls)return;t?this.touchControls.lookArea?this.touchControls.lookArea.style.display="":this.touchControls.rebuildLookArea&&this.touchControls.rebuildLookArea():this.touchControls.destroyLookArea?this.touchControls.destroyLookArea():this.touchControls.lookArea&&(this.touchControls.lookArea.style.display="none")}catch{}}setHotbarVisible(t){const e=document.getElementById("hotbar");e&&(e.style.display=t?"flex":"none")}setMenuOpenState(t){document.body.classList.toggle("menu-open",!!t)}updateDebugToggleVisibility(t){const e=document.getElementById("debug-toggle-btn");if(e&&(e.classList.toggle("hidden",!t),!t&&window.debugOverlay&&typeof window.debugOverlay.hide=="function")){try{window.debugOverlay.hide()}catch{}try{localStorage.removeItem("showDebugOverlay")}catch{}}}assignMultiplayerSpawn(){if(!this.player||!this.world)return;const t=this.world&&typeof this.world.halfMapSize=="number"?this.world.halfMapSize-5:100;let e=null;const i=this._defaultRandom||Math.random;if(this.forceFixedMultiplayerSpawn)e={x:0,y:this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(0,0):0,z:0};else for(let s=0;s<12;s++){const o=(i()*2-1)*t,n=(i()*2-1)*t;let a=0;if(this.world&&typeof this.world.getHeightAt=="function"&&(a=this.world.getHeightAt(o,n)),!this.multiplayer||this.multiplayer.others.size===0||Array.from(this.multiplayer.others.values()).every(h=>{if(!h||!h.position)return!0;const r=h.position.x-o,c=h.position.z-n;return Math.sqrt(r*r+c*c)>15})){e={x:o,y:a,z:n};break}}e||(e={x:0,y:0,z:0}),this.player.mesh.position.set(e.x,e.y,e.z),this.player.controls&&this.player.controls.getObject&&this.player.controls.getObject().position.set(e.x,e.y+1.6,e.z),this.player.camera&&this.player.camera.position.set(e.x,e.y+1.6,e.z)}setupMultiplayerLobbyUI(){const t=document.getElementById("mp-lobby"),e=document.getElementById("mp-start-btn"),i=document.getElementById("mp-lobby-status");if(!t||!e||!i)return;t.classList.remove("hidden");const s=this.multiplayer&&this.multiplayer.roomCode?this.multiplayer.roomCode:"PUBLIC";i.innerText=`Waiting in lobby (Room: ${s})`,e.classList.toggle("hidden",!(this.multiplayer&&this.multiplayer.isHost)),e.onclick=()=>{if(!this.multiplayer||!this.multiplayer.isHost)return;const o=typeof this.multiplayer.getPeerCount=="function"?Math.max(0,this.multiplayer.getPeerCount()-1):0,n=this.enemyManager?typeof this.enemyManager.targetCount=="number"?this.enemyManager.targetCount:this.enemyManager.enemies?this.enemyManager.enemies.length:0:0;if(o<=0&&n<=0){alert("Need at least 1 remote player or 1 NPC zombie before starting the match.");return}this.beginLobbyCountdown(10),this.multiplayer.sendStart()},this.lobbyCountdown=0,this.updateLobbyUI(this.multiplayer?this.multiplayer.isHost:!1)}updateLobbyUI(t){const e=document.getElementById("mp-start-btn");e&&e.classList.toggle("hidden",!t)}beginLobbyCountdown(t=10){this.matchPhase="countdown",this.lobbyCountdown=t;const e=document.getElementById("mp-lobby"),i=document.getElementById("mp-lobby-countdown");e&&e.classList.remove("hidden"),i&&(i.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`)}startMultiplayerMatch(){this.matchPhase="live",this.multiplayer&&(this.multiplayer.matchLive=!0),this.refreshMultiplayerTargets();const t=document.getElementById("mp-lobby");t&&t.classList.add("hidden"),this.lobbyCountdown=0}checkMultiplayerVictory(){if(!this.multiplayer)return;const t=this.multiplayer.deadPeers||new Set;let e=0;this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach((o,n)=>{t.has(n)||o&&o.userData&&o.userData.dead||(e+=1)});const i=this.player&&!this.player.isDead;(i?1:0)+e===1&&i&&(this.hud&&typeof this.hud.showVictory=="function"&&this.hud.showVictory(),this.multiplayer&&(this.multiplayer.matchLive=!1))}setupMenu(){const t=document.getElementById("main-menu"),e=document.getElementById("play-btn"),i=document.getElementById("setting-difficulty"),s=document.getElementById("setting-enemies"),o=document.getElementById("setting-storm"),n=document.getElementById("setting-storm-enabled"),a=document.getElementById("setting-map-size"),l=document.getElementById("map-size-val"),h=document.getElementById("setting-debug"),r=document.getElementById("setting-minimap"),c=document.getElementById("setting-music-volume"),d=document.getElementById("setting-music-volume-val"),f=document.getElementById("setting-sfx-volume"),u=document.getElementById("setting-sfx-volume-val"),m=document.getElementById("setting-camera"),p=document.getElementById("setting-mouth-style"),v=document.getElementById("setting-show-hat"),y=document.getElementById("setting-performance-mode"),S=document.getElementById("setting-auto-performance"),E=document.getElementById("setting-render-scale"),k=document.getElementById("render-scale-val"),C=document.getElementById("setting-touch-controls"),P=document.getElementById("setting-fullscreen"),B=document.getElementById("setting-game-mode"),A=document.getElementById("quit-btn"),_=document.getElementById("active-mode-label"),Z=document.getElementById("active-mode-chip"),L=document.getElementById("float-btn"),j=document.getElementById("setting-openai-key"),O=document.getElementById("setting-groq-key"),G=document.getElementById("setting-nvidia-key"),te=document.getElementById("setting-mp-server"),Q=document.getElementById("setting-mp-seed"),W=document.getElementById("setting-mp-room"),re=document.getElementById("mp-room-generate"),ie=document.getElementById("setting-mp-nickname"),$=document.getElementById("setting-mp-color"),X=document.getElementById("setting-mp-zombies"),q=document.getElementById("setting-mp-fixed-spawn"),ne=document.getElementById("setting-language"),ae=document.getElementById("hotkey-hint"),se=document.getElementById("hotkey-modal"),ce=document.getElementById("hotkey-modal-close"),ee=document.getElementById("setting-arena-time"),H=document.getElementById("arena-time-val"),de=document.getElementById("setting-arena-respawn"),z=document.getElementById("setting-matrix-infinite-ammo"),K=document.getElementById("setting-matrix-show-ui"),me=document.getElementById("setting-matrix-ai-autospawn"),pe=document.getElementById("setting-matrix-ai-hints"),fe=document.getElementById("setting-studio-flight"),he=document.getElementById("setting-studio-show-grid"),Ye=document.getElementById("dash-toggle"),$e=document.getElementById("perf-toggle"),Le=document.getElementById("enemy-count-val"),_e=document.getElementById("storm-time-val"),ge=(M,D)=>{if(!M||!D)return;const F=()=>{D.innerText=M.value};M.addEventListener("input",F),M.addEventListener("change",F),F()},Se=(M,D)=>{if(!(typeof window>"u"||!window.localStorage))try{const F=window.localStorage.getItem("voxel-firecraft-settings"),N=F?JSON.parse(F):{};N[M]=D,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(N))}catch{}},He=(M,D)=>{M&&(M.addEventListener("pointerdown",F=>{try{F.preventDefault(),F.stopPropagation()}catch{}}),M.addEventListener("click",F=>{try{F.preventDefault(),F.stopPropagation()}catch{}const N=document.getElementById(D);if(!N)return;const le=N.classList.toggle("collapsed");Array.from(N.children).forEach(Ie=>{Ie!==M&&(Ie.style.display=le?"none":"")}),M.innerText=le?"+":""}))};He(Ye,"dashboard"),He($e,"perf-dashboard");const Re=localStorage.getItem("voxel-firecraft-settings");if(Re){const M=JSON.parse(Re);if(M.gameMode==="survival"&&(M.gameMode="arcade"),i.value=M.difficulty,s.value=M.enemyCount,o.value=M.stormTime,Le.innerText=M.enemyCount,_e.innerText=M.stormTime,n&&(n.checked=M.stormEnabled!==!1),a&&l){const D=M.mapSize||Ce;a.value=D,l.innerText=D}if(M.debugMode&&(h.checked=!0),r&&(r.checked=M.showMinimap!==!1),P&&(P.checked=!!M.fullscreen),M.musicVolume!==void 0&&c&&d){const D=parseInt(M.musicVolume,10);c.value=D,d.innerText=D,this.bgMusicVolume=D/100}if(f&&u&&M.sfxVolume!==void 0){const D=parseInt(M.sfxVolume,10);f.value=D,u.innerText=D,this.sfxVolume=D/100}if(M.cameraMode&&(m.value=M.cameraMode),p&&M.mouthStyle&&(p.value=M.mouthStyle),v&&(v.checked=M.showHat!==!1),y&&(y.checked=!!M.performanceMode),S&&(S.checked=!!M.autoPerformance),E&&k){const D=M.renderScale||100;E.value=D,k.innerText=D}if(M.useTouchControls!==void 0&&C&&(C.checked=!!M.useTouchControls),M.gameMode&&B&&(B.value=M.gameMode),M.gameMode&&(this._selectedMode=M.gameMode),ne&&M.language&&(ne.value=M.language),j&&(j.value=M.openaiKey||""),O&&(O.value=M.groqKey||""),G&&(G.value=M.nvidiaKey||""),te&&(te.value=M.mpServer||""),Q&&(Q.value=M.mpSeed||""),W&&(W.value=M.mpRoom||""),ie&&(ie.value=M.mpNick||""),$&&($.value=M.mpColor||"#29b6f6"),X&&(X.checked=M.mpZombies!==!1),q&&(q.checked=!!M.mpFixedSpawn),ee&&H){const D=M.arenaTime||parseInt(ee.value,10)||180;ee.value=D,H.innerText=D}de&&(de.checked=M.arenaRespawn!==!1),z&&(z.checked=M.matrixInfiniteAmmo!==!1),K&&(K.checked=M.matrixShowUI!==!1),me&&(me.checked=M.matrixAiAutospawn!==!1),pe&&(pe.checked=M.matrixAiHints!==!1),fe&&(fe.checked=M.studioFlight!==!1),he&&(he.checked=M.studioShowGrid!==!1)}ge(s,Le),ge(o,_e),ge(a,l),ge(ee,H),ge(E,k),ge(f,u),S&&S.addEventListener("change",()=>{const M=this.lastPlaySettings||{};M.autoPerformance=S.checked,this.autoPerfEnabled=M.autoPerformance,Se("autoPerformance",M.autoPerformance)}),y&&y.addEventListener("change",()=>{const M=this.lastPlaySettings||{};M.performanceMode=y.checked,this.applyGraphicsSettings(M),Se("performanceMode",y.checked)}),E&&E.addEventListener("change",()=>{const M=this.lastPlaySettings||{};M.renderScale=parseInt(E.value,10),this.applyGraphicsSettings(M),Se("renderScale",M.renderScale)}),v&&v.addEventListener("change",()=>{this.player&&typeof this.player.setHatVisible=="function"&&this.player.setHatVisible(v.checked),Se("showHat",v.checked)}),e.onclick=()=>{const M=this._selectedMode||"arcade";if(M==="multiplayer"&&this.multiplayer&&!this.multiplayer.isHost&&!this.multiplayer.roomSettings){alert("Waiting for host settings. Please try again in a moment.");return}const D={difficulty:M==="survival"?document.getElementById("setting-survival-difficulty")?document.getElementById("setting-survival-difficulty").value:"medium":i.value,enemyCount:parseInt(s.value),stormTime:parseInt(o.value),stormEnabled:n?n.checked:!0,mapSize:a?parseInt(a.value):Ce,debugMode:h.checked,showMinimap:r?r.checked:!0,musicVolume:c?parseInt(c.value):Math.round(this.bgMusicVolume*100),musicEnabled:document.getElementById("setting-music-enabled")?document.getElementById("setting-music-enabled").checked:!0,cameraMode:m.value,mouthStyle:p?p.value:"serious",showHat:v?v.checked:!0,performanceMode:y?y.checked:!1,autoPerformance:S?S.checked:!1,renderScale:E?parseInt(E.value,10):100,sfxVolume:f?parseInt(f.value,10):70,language:ne?ne.value:"en",useTouchControls:C?C.checked:!1,fullscreen:P?P.checked:!1,gameMode:M,openaiKey:j?j.value:"",groqKey:O?O.value:"",nvidiaKey:G?G.value:"",mpServer:te?te.value:"",mpSeed:Q?Q.value.trim():"",mpRoom:W?W.value:"",mpNick:ie?ie.value:"",mpColor:$?$.value:"#29b6f6",mpZombies:X?X.checked:!0,mpFixedSpawn:q?q.checked:!1,arenaTime:ee?parseInt(ee.value,10):180,arenaRespawn:de?de.checked:!0,matrixInfiniteAmmo:z?z.checked:!0,matrixShowUI:K?K.checked:!0,matrixAiAutospawn:me?me.checked:!0,matrixAiHints:pe?pe.checked:!0,studioFlight:fe?fe.checked:!0,studioShowGrid:he?he.checked:!0};this.lastPlaySettings=D,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(D)),this.updateDebugToggleVisibility(D.debugMode),this.applyGraphicsSettings(D),t.style.display="none",this.setMenuOpenState(!1),D.musicEnabled!==!1?this.playBackgroundMusic():this.stopBackgroundMusic(),this.requestFullscreenIfNeeded(D.fullscreen);const F=this.player&&this.world&&this.enemyManager,N=F&&this.player&&this.player.gameMode===M;if(F&&!N&&this.resetGameState(),this.player&&this.world&&this.enemyManager&&N){if(this.isPaused=!1,this.clock.getDelta(),e.innerText="PLAY GAME",this.player)try{this.player.lockControls()}catch{}if(this.hud&&(this.hud.settings=D),this.world){this.world.stormEnabled=D.stormEnabled!==!1;const le=this.world.stormEnabled&&this.world.gameMode!=="matrix"&&this.world.gameMode!=="studio"&&this.world.gameMode!=="matrix-ai";this.world.stormMesh?this.world.stormMesh.visible=le:le&&typeof this.world.createStormVisuals=="function"&&this.world.createStormVisuals()}this.player&&(this.player.mouthStyle=D.mouthStyle||"serious",typeof this.player.createMouth=="function"&&this.player.createMouth(this.player.mouthStyle)),this.setHotbarVisible(!0)}else e.innerText="PLAY GAME",this.startGame(D);if(ae){const le=D&&D.gameMode==="studio";ae.classList.toggle("hidden",!le)}},A&&(A.onclick=()=>{this.multiplayer&&typeof this.multiplayer.dispose=="function"&&this.multiplayer.dispose(),location.reload()}),L&&L.classList.add("hidden"),re&&W&&(re.onclick=()=>{const M=Math.random().toString(36).substr(2,5).toUpperCase();W.value=M;try{const D=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");D.mpRoom=M,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(D))}catch{}}),ae&&(ae.onclick=()=>this.toggleHotkeyModal(!0)),ce&&(ce.onclick=()=>this.toggleHotkeyModal(!1)),se&&se.addEventListener("click",M=>{M.target===se&&this.toggleHotkeyModal(!1)}),c&&(c.oninput=()=>{const M=parseInt(c.value,10);if(d&&(d.innerText=M),this.bgMusicVolume=M/100,this.bgAudio)try{this.bgAudio.volume=this.bgMusicVolume}catch{}});const Be=document.getElementById("setting-music-enabled");Be&&(Be.onchange=()=>{Be.checked?this.playBackgroundMusic():this.stopBackgroundMusic()}),C&&(C.onchange=()=>{try{const M=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");M.useTouchControls=C.checked,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(M))}catch{}}),this.setHotbarVisible(!1),this.setMenuOpenState(!0);const be=Array.from(document.querySelectorAll(".tab-btn")),Xe=document.querySelectorAll(".tab-panel"),Fe=M=>{if(!M)return;const D=M.getAttribute("data-tab");be.forEach(N=>N.classList.toggle("active",N===M)),Xe.forEach(N=>{N.id===D?N.classList.remove("hidden"):N.classList.add("hidden")});const F=M.getAttribute("data-mode");F&&B&&(B.value=F,_&&(_.innerText=M.innerText),Z&&(Z.innerText=M.innerText)),F&&(this._selectedMode=F)};be.forEach(M=>M.addEventListener("click",()=>Fe(M)));const Oe=this._selectedMode||(B?B.value:null),qe=(Oe?be.find(M=>M.getAttribute("data-mode")===Oe):null)||be.find(M=>M.classList.contains("active"))||be[0];Fe(qe)}resetGameState(){if(this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState(),this.multiplayer&&typeof this.multiplayer.dispose=="function")try{this.multiplayer.dispose()}catch(t){console.warn("Dispose multiplayer failed:",t)}this.multiplayer=null,this.multiplayerEnemyBaseCount=0,this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.isPaused=!1,this.forceFixedMultiplayerSpawn=!1,this.matchSettings=null;try{this.scene.clear()}catch(t){console.warn("Scene clear failed:",t)}try{const t=new je(16777215,.6);this.scene.add(t);const e=new Pe(16777215,.8);e.position.set(50,100,50),e.castShadow=!0,e.shadow.camera.left=-100,e.shadow.camera.right=100,e.shadow.camera.top=100,e.shadow.camera.bottom=-100,e.shadow.camera.near=.1,e.shadow.camera.far=160,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,this.scene.add(e)}catch(t){console.warn("Rebuild lights failed:",t)}this.player=null,this.world=null,this.enemyManager=null,this.itemManager=null,this.hud=null,this.matchSettings=null,this.lastPlaySettings=null,Math.random=this._defaultRandom,this._currentRandomSeed=null,this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState()}startGame(t){this.clearAiObjects(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.victoryShown=!1;const e={...t};if(this.forceFixedMultiplayerSpawn=e.gameMode==="multiplayer"?!!t.mpFixedSpawn:!1,e.gameMode==="multiplayer"){const h=this.multiplayer&&!this.multiplayer.isHost&&this.multiplayer.roomSettings?this.multiplayer.roomSettings:null;if(!this.multiplayer||this.multiplayer.isHost||!h){const r=t.mpSeed||Math.random().toString(36).slice(2);this.matchSettings={mapSize:t.mapSize,enemyCount:t.enemyCount,stormEnabled:!1,seed:r,fixedSpawn:!!t.mpFixedSpawn}}else this.matchSettings=h;this.matchSettings&&(e.mapSize=this.matchSettings.mapSize,e.enemyCount=this.matchSettings.enemyCount,e.stormEnabled=this.matchSettings.stormEnabled,this.forceFixedMultiplayerSpawn=!!this.matchSettings.fixedSpawn,this.applyDeterministicRandom(this.matchSettings.seed||"mp-seed"))}if((e.gameMode==="matrix"||e.gameMode==="studio")&&(e.enemyCount=0,e.skipLoot=!0),e.gameMode==="multiplayer"&&(e.skipLoot=!0,e.stormEnabled=!1,t.mpZombies===!1&&(e.enemyCount=0)),e.gameMode==="survival"&&(e.stormEnabled=!1,e.mapSize=Math.max(100,e.mapSize)),this.survivalStartTime=performance.now(),this.survivalTime=0,this.lootDropEligible=!1,this.lootDropCooldown=0,this.multiplayerEnemyBaseCount=e.enemyCount||0,this.player=new Te(this.camera,this.scene,null,e),typeof t.sfxVolume<"u"&&(this.player.sfxVolume=Math.max(0,Math.min(1,t.sfxVolume/100))),t&&t.mpColor){if(this.player.playerColor=t.mpColor,this.player.mesh)try{this.scene.remove(this.player.mesh)}catch{}this.player.createPlayerMesh()}this.player&&(this.player.setHatVisible(t.showHat!==!1),this.player.mouthStyle=t.mouthStyle||"serious",this.player.createMouth(this.player.mouthStyle)),e.gameMode==="multiplayer"?(this.matchPhase="lobby",this.multiplayer&&(this.multiplayer.matchLive=!1)):this.matchPhase="live",this.itemManager=new ii(this.scene,this.player,e),this.world=new Rt(this.scene,this.itemManager,e),this.player.worldObjects=this.world.objects,this.player.world=this.world,this.itemManager&&typeof this.itemManager.setWorld=="function"&&this.itemManager.setWorld(this.world);const i=document.getElementById("mp-lobby"),s=document.getElementById("mp-start-btn");if(i&&i.classList.add("hidden"),s&&s.classList.add("hidden"),e.gameMode==="matrix"&&this.itemManager&&typeof this.itemManager.spawnMatrixLoadout=="function"&&this.itemManager.spawnMatrixLoadout(this.player.position.x,this.player.position.z),e.gameMode==="multiplayer"&&this.assignMultiplayerSpawn(),e.gameMode==="multiplayer"?(this.multiplayer=new oi({player:this.player,scene:this.scene,url:t.mpServer,nick:t.mpNick||"Player",color:t.mpColor||"#29b6f6",roomCode:t.mpRoom||"PUBLIC",settings:this.matchSettings}),t.mpServer||alert("Multiplayer server URL not set. Please configure it in the Multiplayer tab."),this.player&&typeof this.player.setMultiplayerClient=="function"&&this.player.setMultiplayerClient(this.multiplayer),this.multiplayer&&(this.multiplayer.onPeersChanged=()=>this.refreshMultiplayerTargets(),this.multiplayer.roomCode=t.mpRoom||"PUBLIC",this.multiplayer.onHostChanged=h=>{this.updateLobbyUI(h),h&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings)},this.multiplayer.onCountdown=h=>this.beginLobbyCountdown(h),this.multiplayer.onMatchStart=()=>this.startMultiplayerMatch(),this.multiplayer.onSettings=h=>{this.matchSettings=h;const r=this.multiplayer&&this.multiplayer.isHost,d=this.player&&this.player.gameMode==="multiplayer"&&h&&(this.world&&this.world.mapSize!==h.mapSize||this.multiplayerEnemyBaseCount!==h.enemyCount);if(!r&&h&&d&&this.lastPlaySettings){const f={...this.lastPlaySettings,mapSize:h.mapSize,enemyCount:h.enemyCount};this.resetGameState(),this.matchSettings=h,this.applyDeterministicRandom(h.seed||"mp-seed"),this.startGame(f)}},this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings),this.multiplayer.onPeerDeath=()=>{this.checkMultiplayerVictory()},this.updateLobbyUI(this.multiplayer.isHost),this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings))):this.multiplayer=null,e.gameMode==="matrix-ai"){e.enemyCount=0,e.skipLoot=!0;const h=document.getElementById("ai-panel");h&&h.classList.remove("hidden")}else{const h=document.getElementById("ai-panel");h&&h.classList.add("hidden")}this.hud=new Zt(this.player,this.world,t),this.player&&(this.player.hud=this.hud),this.hud&&typeof this.hud.setRenderer=="function"&&this.hud.setRenderer(this.renderer),this.hud&&typeof this.hud.setMultiplayer=="function"&&this.hud.setMultiplayer(this.multiplayer),this.enemyManager=new ti(this.scene,this.player,this.world,e),this.multiplayer&&typeof this.multiplayer.setEnemyManager=="function"&&this.multiplayer.setEnemyManager(this.enemyManager),e.gameMode==="multiplayer"&&(this.multiplayerEnemyBaseCount=e.enemyCount||0,typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(this.multiplayerEnemyBaseCount),this.multiplayer&&(this.multiplayer.onHit=h=>{if(!h||h.targetId!==this.multiplayer.id)return;const r=typeof h.amount=="number"?h.amount:0;r>0&&this.player&&typeof this.player.takeDamage=="function"&&this.player.takeDamage(r)})),this.player.setEnemyManager(this.enemyManager),e.gameMode==="multiplayer"&&(this.refreshMultiplayerTargets(),this.setupMultiplayerLobbyUI()),this.setupObjectInspector(),this.updateDebugToggleVisibility(!!t.debugMode),this.setHotbarVisible(!0);const o=document.getElementById("float-btn");o&&(e.gameMode==="studio"?(o.classList.remove("hidden"),o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF",o.onclick=()=>{if(this.player.isFloating=!this.player.isFloating,!this.player.isFloating){const h=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=h,this.player.velocity.y=0}o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF"}):o.classList.add("hidden"));const n=document.getElementById("storm-timer");if(n){const h=e.stormEnabled===!1||e.gameMode==="studio"||e.gameMode==="matrix"||e.gameMode==="matrix-ai"||e.gameMode==="multiplayer"||e.gameMode==="survival";n.classList.toggle("hidden",h)}const a=document.getElementById("survival-timer");if(a){const h=e.gameMode==="arcade"||e.gameMode==="survival";a.classList.toggle("hidden",!h)}window.addEventListener("resize",()=>this.onWindowResize(),!1),this.renderer.domElement.addEventListener("pointerdown",()=>{if(!ue){try{const h=document.getElementById("main-menu")&&document.getElementById("main-menu").style.display!=="none",r=this.player&&this.player.gameMode==="studio";if(this.isPaused||h||r)return;this.player&&!this.player.isDead&&this.player.lockControls()}catch(h){console.warn("Pointer lock request skipped or failed:",h)}this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic()}}),this.setupPauseMenu();try{const h=typeof navigator<"u"&&/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent),r=typeof window<"u"&&window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;(!!t.useTouchControls||h||r)&&(this.touchControls=new si(this.player))}catch{}if(this.setupStudioPalette(e),this.refreshStudioPaletteVisibility(),this.setupAiPanel(),!ue&&this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch(h){console.warn("Pointer lock on start skipped/failed:",h)}this._animationStarted||(this._animationStarted=!0,this.animate())}setupLongPressMenu(){if(!ue)return;const t=document.getElementById("ui-layer")||document.body;if(!t)return;const e=s=>{try{if(s.touches&&s.touches.length>1)return;this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=setTimeout(()=>{this._longPressTimer=null,this.showPauseMenu()},800)}catch{}},i=()=>{this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null)};t.addEventListener("touchstart",e,{passive:!0}),t.addEventListener("touchend",i),t.addEventListener("touchcancel",i),t.addEventListener("touchmove",i)}setupAiPanel(){const t=document.getElementById("ai-panel"),e=document.getElementById("ai-send"),i=document.getElementById("ai-prompt"),s=document.getElementById("ai-log"),o=document.getElementById("ai-provider");if(!t||!e||!i||!s)return;const n=(h,r="")=>{const c=document.createElement("div");c.textContent=h,r&&(c.className=r),s.appendChild(c),s.scrollTop=s.scrollHeight};e.onclick=()=>{const h=i.value.trim();h&&(n(`You: ${h}`,"ai-user"),n("AI: (stub) Interpreter not wired. Imagine this runs your Three.js code.","ai-bot"),i.value="")};const a=`You are a level-building assistant for a Three.js sandbox. Respond ONLY with a JSON object:
{
  "actions": [
    {
      "action": "add",
      "type": "box" | "sphere" | "cylinder" | "plane",
      "pos": [x,y,z],
      "size": [sx,sy,sz],
      "color": "#rrggbb"
    }
  ]
}
Constraints: numbers are in meters, keep |x|,|z| <= 150, size in [0.2, 40]. No functions, no code, no prose, no markdown.`,l=async h=>{const r=document.getElementById("setting-openai-key"),c=r&&r.value?r.value.trim():"";if(!c)return n("Erro: configure a chave OpenAI em Settings.","ai-error"),"";const d={model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:h}],temperature:.2,max_tokens:2e3,response_format:{type:"json_object"}},f=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(d)});if(!f.ok){const p=await f.text();return n(`Erro OpenAI: ${f.status} ${p}`,"ai-error"),""}const u=await f.json(),m=u&&u.choices&&u.choices[0]&&u.choices[0].message?u.choices[0].message.content:"";return n(`AI: ${m||"(vazio)"}`,"ai-bot"),m||""};e.onclick=async()=>{const h=i.value.trim();if(!h)return;n(`You: ${h}`,"ai-user"),i.value="";const r=o?o.value:"openai";e.disabled=!0,e.innerText="Enviando...";try{if(r==="openai"){const c=await l(h);if(c){const d=this.parseAiActions(c,n);if(d&&d.length){const f=this.applyAiActions(d,n);n(`Aplicado: ${f} objeto(s)`,"ai-info")}}}else n(`Provider ${r} no suportado.`,"ai-error")}catch(c){n(`Erro na requisio: ${c.message||c}`,"ai-error")}finally{e.disabled=!1,e.innerText="Send to AI"}}}parseAiActions(t,e){const i=e||(()=>{});let s=null;try{s=JSON.parse(t)}catch{return i("Falha ao parsear JSON da AI.","ai-error"),[]}if(s&&s.actions&&Array.isArray(s.actions)&&(s=s.actions),!Array.isArray(s))return i("Resposta no  uma lista de aes.","ai-error"),[];const o=(r,c,d)=>Math.min(d,Math.max(c,r)),n=new Set(["box","sphere","cylinder","plane"]),a=/^#([0-9a-fA-F]{6})$/,l=this.aiMaxAiObjects||200,h=[];for(const r of s){if(!r||r.action!=="add"||!n.has(r.type))continue;const c=Array.isArray(r.pos)?r.pos.slice(0,3):[0,0,0],d=Array.isArray(r.size)?r.size.slice(0,3):[1,1,1],f=[o(Number(c[0]??0),-150,150),o(Number(c[1]??0),-10,200),o(Number(c[2]??0),-150,150)],u=[o(Math.abs(Number(d[0]??1)),.2,40),o(Math.abs(Number(d[1]??1)),.2,40),o(Math.abs(Number(d[2]??1)),.2,40)],m=typeof r.color=="string"&&a.test(r.color)?r.color:"#cccccc";if(h.push({type:r.type,pos:f,size:u,color:m}),h.length>=l)break}return h.length||i("Nenhuma ao vlida na resposta.","ai-error"),h}clearAiObjects(){this.aiObjects||(this.aiObjects=[]),this.aiObjects.forEach(t=>{try{t.parent&&t.parent.remove(t),t.geometry&&t.geometry.dispose&&t.geometry.dispose(),t.material&&t.material.dispose&&t.material.dispose()}catch{}}),this.aiObjects=[]}applyAiActions(t,e){const i=e||(()=>{});if(!t||!t.length)return 0;if(!this.scene||!this.player||this.player.gameMode!=="matrix-ai")return i("Aes ignoradas: no est no modo Matrix AI Builder.","ai-error"),0;this.clearAiObjects();const s=this.aiMaxAiObjects||200,o=[],n=new Pe(16777215,.2);return n.position.set(0,10,0),this.scene.add(n),o.push(n),t.slice(0,s).forEach(a=>{try{let l=null;const h=new w({color:new oe(a.color),metalness:.05,roughness:.85});if(a.type==="box")l=new x(a.size[0],a.size[1],a.size[2]);else if(a.type==="sphere"){const c=a.size[0]/2;l=new xe(c,20,16)}else if(a.type==="cylinder"){const c=a.size[0]/2;l=new R(c,c,a.size[1],16)}else a.type==="plane"&&(l=new U(a.size[0],a.size[2]));if(!l)return;const r=new g(l,h);r.position.set(a.pos[0],a.pos[1],a.pos[2]),a.type==="plane"&&(r.rotation.x=-Math.PI/2),this.scene.add(r),o.push(r)}catch(l){i("Falha ao criar objeto: "+l.message,"ai-error")}}),this.aiObjects=o,o.length}refreshStudioPaletteVisibility(){const t=document.getElementById("studio-palette");if(!t)return;const e=this.player&&this.player.gameMode==="studio"&&!this.isPaused;t.classList.toggle("hidden",!e)}refreshMultiplayerTargets(){if(!this.player||this.player.gameMode!=="multiplayer"||!this.enemyManager)return;const t=typeof this.multiplayerEnemyBaseCount=="number"?this.multiplayerEnemyBaseCount:this.enemyManager.enemies.length;this.matchPhase==="live"&&typeof this.enemyManager.setTargetCount=="function"?this.enemyManager.setTargetCount(t):this.matchPhase!=="live"&&typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(0)}setupStudioPalette(t){const e=document.getElementById("studio-palette");if(!e)return;const i=t&&(t.gameMode==="studio"||t.gameMode==="matrix-ai");if(e.classList.toggle("hidden",!i),!i)return;this.initStudioPaletteDrag(e),e.querySelectorAll("button").forEach(n=>{if(n._boundStudio)return;n._boundStudio=!0;const a=h=>{if(h&&h.stopPropagation&&h.stopPropagation(),!this.player||!this.world)return;const r=n.getAttribute("data-action");if(r==="resume"){if(this.isPaused=!1,this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch{}const m=document.getElementById("main-menu");m&&(m.style.display="none"),this.setMenuOpenState(!1),this.setHotbarVisible(!0);try{e.classList.add("hidden")}catch{}if(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0),this.player&&this.player.studioSelectionHelper){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}this.refreshStudioPaletteVisibility(),this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic();return}else if(r==="float-toggle"){if(this.player&&this.player.gameMode==="studio"){this.player.isFloating=!this.player.isFloating;const m=this.player.isFloating?"FLOAT ON":"FLOAT OFF";if(n.innerText=m,!this.player.isFloating){const p=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=p,this.player.velocity.y=0}}return}else if(r==="spawn-npc"){const m=n.getAttribute("data-npc-type")||"normal";this.studioSelectedPrefab="npc",this.studioSelectedOptions={type:m},this.toggleTouchLookArea(!1);const p=document.getElementById("npc-menu");p&&p.classList.add("hidden");return}else if(r==="remove-npc"){if(this.studioRemoveNPCMode=!this.studioRemoveNPCMode,n.style.background=this.studioRemoveNPCMode?"#e74c3c":"",n.textContent=this.studioRemoveNPCMode?"Remove NPC (Active)":"Remove NPC",this.studioRemoveNPCMode&&(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.player&&this.player.studioSelectionHelper)){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}return}else if(r==="drops"){this.spawnStudioDrops();return}else if(r==="menu"){this.showPauseMenu();return}else if(r==="quit"){try{localStorage.removeItem("voxel-firecraft-settings")}catch{}location.reload();return}const c=n.getAttribute("data-prefab"),d=n.getAttribute("data-vehicle-type"),f=n.getAttribute("data-tree-type"),u=n.getAttribute("data-submenu");if(u){const m=document.getElementById(u);m&&m.classList.toggle("hidden");return}if(this.studioSelectedPrefab=c,this.studioSelectedOptions=d?{variant:d}:f?{variant:f}:{},this.toggleTouchLookArea(!1),u){const m=document.getElementById(u);m&&m.classList.add("hidden")}},l=h=>{h&&h.preventDefault&&h.preventDefault(),a(h)};n.addEventListener("pointerdown",l),n.addEventListener("click",h=>{h&&h.preventDefault&&h.preventDefault(),a(h)})});const o=document.getElementById("studio-minimize-btn");o&&o.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const a=document.querySelector("#studio-palette .palette-grid");a&&(a.classList.toggle("hidden"),o.textContent=a.classList.contains("hidden")?"+":"_")})}setupObjectInspector(){const t=this.renderer?this.renderer.domElement:null;if(t){if(this._objectClickHandler&&this._objectClickTarget)try{this._objectClickTarget.removeEventListener("click",this._objectClickHandler),this._objectClickTarget.removeEventListener("pointerdown",this._objectClickHandler)}catch{}this._objectClickTarget=t,this._objectClickHandler=e=>{if(!this.player||!this.hud)return;const i=this.player.gameMode||"arcade";if(i==="matrix")return;if(i==="studio"&&this.studioRemoveNPCMode){const d=this.renderer.domElement.getBoundingClientRect(),f=(e.clientX-d.left)/d.width*2-1,u=-((e.clientY-d.top)/d.height*2-1),m=new J;if(m.setFromCamera(new Y(f,u),this.camera),this.enemyManager&&this.enemyManager.enemies){console.log("Remove NPC: Checking",this.enemyManager.enemies.length,"enemies");for(let p=this.enemyManager.enemies.length-1;p>=0;p--){const v=this.enemyManager.enemies[p];if(v.mesh&&m.intersectObject(v.mesh,!0).length>0){console.log("Hit enemy",p,"removing..."),this.scene.remove(v.mesh),this.enemyManager.enemies.splice(p,1),console.log("Removed NPC");return}}}return}if(i==="studio"&&this.studioSelectedPrefab){const d=t.getBoundingClientRect(),f=(e.clientX-d.left)/d.width*2-1,u=-((e.clientY-d.top)/d.height*2-1),m=new J;m.setFromCamera(new Y(f,u),this.camera);const p=m.intersectObjects(this.world.objects,!0);let v=null;for(const y of p)if(y.object&&y.object.userData&&y.object.userData.gameName==="Ground"){v=y;break}if(!v){const y=new J;y.setFromCamera(new Y(0,0),this.camera);const S=y.intersectObjects(this.world.objects,!0);for(const E of S)if(E.object&&E.object.userData&&E.object.userData.gameName==="Ground"){v=E;break}}if(v){if(this.studioSelectedPrefab==="npc"){if(this.enemyManager&&typeof this.enemyManager.spawnEnemyAt=="function"){const y=this.studioSelectedOptions?this.studioSelectedOptions.type:"normal";this.enemyManager.spawnEnemyAt(v.point.x,v.point.z,y)}}else if(typeof this.world.spawnPrefab=="function"){const y=this.studioSelectedOptions||{};this.world.spawnPrefab(this.studioSelectedPrefab,v.point.x,v.point.z,y)}}this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0);return}let s=0,o=0;if(this.player.controls&&this.player.controls.isLocked)s=0,o=0;else{const d=t.getBoundingClientRect();s=(e.clientX-d.left)/d.width*2-1,o=-((e.clientY-d.top)/d.height*2-1)}this._pickRaycaster.setFromCamera(new Y(s,o),this.camera);const n=[];if(this.world&&Array.isArray(this.world.objects)&&n.push(...this.world.objects),this.itemManager&&Array.isArray(this.itemManager.items)&&n.push(...this.itemManager.items),this.enemyManager&&Array.isArray(this.enemyManager.enemies)&&this.enemyManager.enemies.forEach(d=>{d&&d.mesh&&n.push(d.mesh)}),n.length===0)return;const a=this._pickRaycaster.intersectObjects(n,!0);if(!a.length)return;let l=a[0].object,h=null;for(;l;){if(l.userData&&(l.userData.gameId||l.userData.gameid)&&l.userData.gameName){h=l.userData;break}l=l.parent}if(!h)return;const r=h.gameName||"Object",c=h.gameId||h.gameid||"---";typeof this.hud.showSelectionInfo=="function"&&this.hud.showSelectionInfo(r,c)},t.addEventListener("click",this._objectClickHandler),t.addEventListener("pointerdown",this._objectClickHandler)}}initStudioPaletteDrag(t){if(!t||t._dragInit)return;t._dragInit=!0;const e=t.querySelector(".palette-title")||t;let i=!1,s=0,o=0,n=0,a=0,l=null;t.style.touchAction="none";const h=c=>{if(!i){const m=Math.abs(c.clientX-n),p=Math.abs(c.clientY-a);if(m<3&&p<3)return;i=!0,l&&(t.style.right="auto",t.style.bottom="auto",t.style.position="fixed",t.style.width=`${l.width}px`,t.style.minWidth=`${l.width}px`,t.style.maxWidth=`${l.width}px`,t.style.left=`${l.left}px`,t.style.top=`${l.top}px`)}const d=t.getBoundingClientRect(),f=Math.max(0,Math.min(window.innerWidth-d.width,c.clientX-s)),u=Math.max(0,Math.min(window.innerHeight-d.height,c.clientY-o));t.style.left=`${f}px`,t.style.top=`${u}px`},r=()=>{i=!1,e.releasePointerCapture&&e.releasePointerCapture(e._dragPointerId),document.removeEventListener("pointermove",h),document.removeEventListener("pointerup",r)};e.addEventListener("pointerdown",c=>{try{c.preventDefault()}catch{}const d=t.getBoundingClientRect();l=d,s=c.clientX-d.left,o=c.clientY-d.top,n=c.clientX,a=c.clientY,i=!1,e._dragPointerId=c.pointerId;try{e.setPointerCapture(c.pointerId)}catch{}document.addEventListener("pointermove",h),document.addEventListener("pointerup",r)})}togglePause(){if(this.player){if(this.player.controls&&this.player.controls.isLocked){this.showPauseMenu();return}this.isPaused=!this.isPaused,this.isPaused?this.pauseBackgroundMusic():this.playBackgroundMusic()}}setupPauseMenu(){document.addEventListener("keydown",e=>{e.code==="Escape"&&this.player&&!this.player.isDead&&(e.preventDefault(),this.showPauseMenu())});const t=document.getElementById("pause-menu");t&&t.remove()}showPauseMenu(){this.isPaused=!0,this.player.controls&&this.player.controls.isLocked&&this.player.controls.unlock(),this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps(),this.pauseBackgroundMusic();const t=document.getElementById("main-menu");if(t){t.style.display="flex",this.setMenuOpenState(!0);const e=document.getElementById("play-btn");e&&this.player&&(e.innerText="RESUME GAME")}if(this.setHotbarVisible(!1),this.player&&this.player.gameMode==="studio"){const e=document.getElementById("studio-palette");e&&e.classList.remove("hidden")}}playBackgroundMusic(){try{this.bgAudio||(this.bgAudio=new Audio(Dt),this.bgAudio.loop=!0,this.bgAudio.volume=this.bgMusicVolume,this.bgAudio.preload="auto");const t=this.bgAudio.play();t&&typeof t.then=="function"&&t.catch(()=>{})}catch(t){console.warn("Could not play background music:",t)}}pauseBackgroundMusic(){if(this.bgAudio&&!this.bgAudio.paused)try{this.bgAudio.pause()}catch{}}stopBackgroundMusic(){if(this.bgAudio)try{this.bgAudio.pause(),this.bgAudio.currentTime=0}catch{}}requestFullscreenIfNeeded(t){if(!t)return;const e=document;if(e.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement)return;const s=document.documentElement||document.body,o=s.requestFullscreen||s.webkitRequestFullscreen||s.mozRequestFullScreen||s.msRequestFullscreen;o?o.call(s).catch(n=>{console.warn("Fullscreen request failed:",n),ue&&alert("Fullscreen may not be supported on this mobile device.")}):ue&&alert("Fullscreen is not available on this mobile device.")}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate());try{const t=this.clock.getDelta(),e=Math.min(t,.1),i=!!(this.touchControls&&this.touchControls.enabled),s=!!(this.player&&this.player.controls&&this.player.controls.isLocked),o=!!(this.player&&this.player.gameMode==="studio");if(!this.isPaused&&this.player&&(s||i||o)){try{this.player.update(e)}catch(n){console.error("Error in player.update:",n)}try{const n=this.world.update(e,this.player.position);!(this.player&&this.player.gameMode==="studio")&&n&&n.inStorm?this.player.takeDamage(1*e):this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch(n){console.error("Error in world.update:",n)}try{this.enemyManager.update(e)}catch(n){console.error("Error in enemyManager.update:",n)}try{this.itemManager.update(e)}catch(n){console.error("Error in itemManager.update:",n)}if(this.player&&this.player.gameMode==="multiplayer"){if(this.matchPhase==="live")this.multiplayerDropTimer+=e,this.multiplayerDropTimer>=30&&(this.multiplayerDropActive=!0),this.multiplayerDropActive&&this.itemManager&&(this.multiplayerDropCooldown-=e,this.multiplayerDropCooldown<=0&&(this.multiplayerDropCooldown=60,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"&&this.itemManager.spawnMatrixDropNearPlayer()));else if(this.matchPhase==="countdown"){this.lobbyCountdown-=e;const n=document.getElementById("mp-lobby-countdown");this.lobbyCountdown<0&&(this.lobbyCountdown=0),n&&(n.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`),this.lobbyCountdown<=0&&this.startMultiplayerMatch()}}try{this.multiplayer&&typeof this.multiplayer.update=="function"&&this.multiplayer.update(e)}catch(n){console.error("Error in multiplayer.update:",n)}if(this.player&&(this.player.gameMode==="arcade"||this.player.gameMode==="survival")){this.survivalTime=(performance.now()-this.survivalStartTime)/1e3;const n=document.getElementById("survival-time-value");if(n){const a=Math.floor(this.survivalTime/60),l=Math.floor(this.survivalTime%60);n.innerText=`${a.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}if(this.itemManager&&this.enemyManager){const a=this.itemManager.items?this.itemManager.items.filter(h=>!(h.userData&&h.userData.isOpened)).length:0,l=this.enemyManager.targetCount>0?this.enemyManager.killedCount/this.enemyManager.targetCount:0;if(a===0&&l>=.3&&!this.lootDropEligible&&(this.lootDropEligible=!0,this.lootDropCooldown=0,console.log("Loot drops from sky enabled! Player killed 30%+ zombies.")),this.lootDropEligible&&(this.lootDropCooldown-=e,this.lootDropCooldown<=0&&(this.lootDropCooldown=45,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"))){const h=2+Math.floor(Math.random()*2);for(let r=0;r<h;r++)this.itemManager.spawnMatrixDropNearPlayer();console.log(`Dropped ${h} items from sky!`)}}}try{this.hud.update()}catch(n){console.error("Error in hud.update:",n)}try{this.touchControls&&typeof this.touchControls.update=="function"&&this.touchControls.update()}catch(n){console.error("Error in touchControls.update:",n)}try{if(!(this.player&&(this.player.gameMode==="matrix"||this.player.gameMode==="studio"||this.player.gameMode==="multiplayer"||this.player.gameMode==="matrix-ai"))&&this.enemyManager.enemies.length===0&&!this.player.isDead&&!this.victoryShown){this.victoryShown=!0;try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}this.hud.showVictory(),this.player.controls.unlock()}else this.player&&this.player.gameMode==="multiplayer"&&this.matchPhase==="live"&&!this.player.isDead&&!this.victoryShown&&(this.multiplayer?this.multiplayer.others.size:0)===0&&(this.victoryShown=!0,this.hud.showVictory(),this.player.controls&&this.player.controls.unlock&&this.player.controls.unlock())}catch(n){console.error("Error in victory check:",n)}}this.renderer.render(this.scene,this.camera)}catch(t){try{console.error("Unhandled error in Game.animate:",t,{playerExists:!!this.player,playerWeaponCount:this.player?this.player.weapons?this.player.weapons.length:"no-weapons":"no-player",currentWeaponIndex:this.player?this.player.currentWeaponIndex:"no-player",hudExists:!!this.hud,hudSettings:this.hud?this.hud.settings:null});try{this._logRenderMaterialDiagnostics(t)}catch(e){console.error("Error during render diagnostics:",e)}}catch(e){console.error("Error logging animate failure:",e)}return}}}ze.prototype.playEndSequence=function(b,t={}){try{if(this._playingEndSequence)return;if(this._playingEndSequence=!0,this.bgAudio)try{this._prevBgVolume=this.bgAudio.volume,this.bgAudio.pause()}catch{this._prevBgVolume=this.bgMusicVolume}if(this._endSequenceAudio){try{this._endSequenceAudio.pause(),this._endSequenceAudio.currentTime=0}catch{}this._endSequenceAudio=null}const e=new Audio(b);e.loop=t.loop||!1,e.volume=t.volume!==void 0?t.volume:1,e.preload="auto",this._endSequenceAudio=e,e.load(),setTimeout(()=>{const i=e.play();i&&typeof i.then=="function"&&i.catch(s=>{console.log("Audio playback blocked, waiting for user interaction:",s);const o=()=>{e.readyState<2&&e.load(),e.play().catch(()=>{}),document.removeEventListener("touchstart",o),document.removeEventListener("click",o)};document.addEventListener("touchstart",o,{once:!0}),document.addEventListener("click",o,{once:!0})})},100),e.addEventListener("ended",()=>{try{this.bgAudio&&this._prevBgVolume!==null&&(this.bgAudio.volume=this._prevBgVolume)}catch{}this._endSequenceAudio=null,this._prevBgVolume=null,this._playingEndSequence=!1})}catch(e){console.warn("playEndSequence error:",e)}};ze.prototype._logRenderMaterialDiagnostics=function(b){try{const t=[];let e=0;this.scene.traverse(i=>{if(i.isMesh){e++;const s=i.material;if(!s){t.push({uuid:i.uuid,name:i.name||i.userData&&i.userData.gameName||"mesh",issue:"no-material"});return}const o=n=>({type:n.type||n.constructor&&n.constructor.name||"Unknown",isShaderMaterial:!!n.isShaderMaterial,isStandardMaterial:!!n.isMeshStandardMaterial,hasEmissive:n.emissive!==void 0,uniformsKeys:n.uniforms?Object.keys(n.uniforms):null,userData:n.userData||null});Array.isArray(s)?t.push({uuid:i.uuid,name:i.name||i.userData&&i.userData.gameName||"mesh",materials:s.map(o)}):t.push({uuid:i.uuid,name:i.userData&&i.userData.gameName||i.name||"mesh",material:o(s)})}}),console.error("Render diagnostics:",{originalError:b&&b.toString(),totalMeshes:e,sampleProblems:t.slice(0,30),note:"Look for materials missing expected uniforms (shader/standard) or meshes without material."})}catch(t){console.error("Failed collecting render diagnostics:",t)}};window.game=new ze;(function(){try{const t=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}"),e=t&&t.debugMode||localStorage.getItem("showDebugOverlay")==="true"||!!window.DEBUG_OVERLAY;window.debugOverlay=ni({autoShow:!!e}),window.addEventListener("keydown",i=>{if(i.key==="`"&&window.debugOverlay){const s=document.getElementById("debug-overlay");s&&s.classList.contains("hidden")?window.debugOverlay.show():window.debugOverlay&&window.debugOverlay.hide()}});try{let i=document.getElementById("debug-toggle-btn");i||(i=document.createElement("button"),i.id="debug-toggle-btn",i.title="Debug logs",i.innerText="DBG",document.body.appendChild(i));const s=!0;i.addEventListener("click",o=>{try{const n=document.getElementById("debug-overlay");n&&n.classList.contains("hidden")?(window.debugOverlay&&window.debugOverlay.show(),localStorage.setItem("showDebugOverlay","true")):(window.debugOverlay&&window.debugOverlay.hide(),localStorage.removeItem("showDebugOverlay"))}catch(n){console.warn("debug toggle error",n)}})}catch{}}catch(t){console.warn("debugOverlay init failed",t)}})();window.addEventListener("game-touch-look",b=>{try{const t=b.detail||{dx:0,dy:0},e=.003;if(window.game&&window.game.player)try{if(typeof window.game.player.rotateCamera=="function")window.game.player.rotateCamera(t.dx*e,t.dy*e);else{window.game.player._touchYaw=(window.game.player._touchYaw||0)-t.dx*.01,window.game.player._touchPitch=(window.game.player._touchPitch||0)-t.dy*.01;const s=Math.PI/2-.1;window.game.player._touchPitch=Math.max(-s,Math.min(s,window.game.player._touchPitch))}}catch{}}catch{}});
