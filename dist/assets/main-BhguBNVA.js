import{O as Pe,I as Je,E as Ee,V as T,M as Ze,P as te,B as xe,C as ne,a as S,b as g,c as ye,d as b,G as Qe,e as Me,f as O,g as et,h as tt,R as it,N as st,i as ot,S as Ie,D as Fe,j as We,k as ie,l as je,m as Ue,T as nt,n as at,o as $,p as X,q as rt,r as Xe,L as ht,s as lt,t as ct,u as U,v as dt,w as ut,x as mt,y as pt,z as ft,A as gt,F as yt,H as wt,J as vt,K as Mt,Q as bt,W as St,U as xt,X as Ne,Y as Ce,Z as kt,_ as Et}from"./slendermanElement-CLgnoac4.js";import{c as Dt,a as Bt,b as Ct,d as Pt,e as It,f as At,g as Tt,h as Lt,i as zt,j as _t,_ as Ht,k as Rt}from"./spiderElement-DnGhScWy.js";const Ot="/threejs-voxel-firecraft/dist/assets/background-music-by-suno-B4M28EgO.ogg";class Ft{constructor(e){this.scene=e,this.buckets=new Map}addInstance(e,t,i,s,o,n={}){const a=[];t.traverse(l=>{l.isMesh&&a.push(l)}),a.forEach(l=>{const h=Array.isArray(l.material)?l.material.map(w=>w.uuid).join("-"):l.material.uuid,r=l.geometry.uuid,c=`${e}_${r}_${h}`;this.buckets.has(c)||this.buckets.set(c,{geometry:l.geometry,material:l.material,instances:[],castShadow:l.castShadow,receiveShadow:l.receiveShadow});const d=this.buckets.get(c),p=l.position.clone(),m=l.rotation.clone(),u=l.scale.clone();d.instances.push({pos:i,rot:s,scl:o,offsetPos:p,offsetRot:m,offsetScl:u,userData:n})})}build(){const e=new Pe,t=[];return this.buckets.forEach((i,s)=>{if(i.instances.length===0)return;const o=new Je(i.geometry,i.material,i.instances.length);o.castShadow=i.castShadow,o.receiveShadow=i.receiveShadow,o.userData={isInstanced:!0};for(let n=0;n<i.instances.length;n++){const a=i.instances[n];e.position.copy(a.pos),e.rotation.copy(a.rot||new Ee),e.scale.copy(a.scl||new T(1,1,1)),e.updateMatrix();const l=new Pe;l.position.copy(a.offsetPos),l.rotation.copy(a.offsetRot),l.scale.copy(a.offsetScl),l.updateMatrix();const h=new Ze;h.multiplyMatrices(e.matrix,l.matrix),o.setMatrixAt(n,h)}o.instanceMatrix.needsUpdate=!0,this.scene.add(o),t.push(o)}),this.buckets.clear(),t}}const ke=400;class jt{constructor(e,t,i){this.scene=e,this.itemManager=t,this.objects=[],this.gameMode=i&&i.gameMode?i.gameMode:"arcade",this.gameMode==="arena"?this.mapSize=150:this.mapSize=i&&i.mapSize?i.mapSize:ke,this.halfMapSize=this.mapSize/2,this.stormRadius=this.halfMapSize,this.initialStormRadius=this.stormRadius,this._heightFn=this._buildHeightFn(),this.stormEnabled=i&&i.stormEnabled!==!1;const s=i?i.stormTime:180;this.stormShrinkRate=this.stormRadius/s,this.safeZoneCenter=new T(0,0,0),this.instanceManager=new Ft(this.scene),this.useInstancing=this.gameMode!=="studio"&&this.gameMode!=="matrix"&&this.gameMode!=="matrix-ai",this.init()}init(){this.gameMode==="arena"?this.createArenaEnvironment():this.gameMode==="matrix"?this.createMatrixEnvironment():this.gameMode==="matrix-ai"?this.createMatrixAIEnvironment():this.gameMode==="multiplayer"?this.createMultiplayerEnvironment():this.gameMode==="studio"?this.createStudioEnvironment():this.gameMode==="survival"?this.createSurvivalEnvironment():this.createEnvironment(),this.useInstancing&&this.instanceManager.build().forEach(t=>{this.objects.push(t)}),this.gameMode!=="matrix"&&this.gameMode!=="studio"&&this.stormEnabled&&this.createStormVisuals()}addWorldObject(e,t,i,s,o,n=1,a=0,l={}){const h=new T(i,s,o),r=new Ee(0,a,0),c=new T(n,n,n);if(this.useInstancing){this.instanceManager.addInstance(e,t,h,r,c,l);const d=new Pe;return d.position.copy(h),d.rotation.copy(r),d.scale.copy(c),d.userData={...l},d.userData.radius||(e.includes("Tree")?d.userData.radius=1:e.includes("Rock")?d.userData.radius=1.5:e.includes("Bush")&&(d.userData.radius=1)),this.objects.push(d),d}else{const d=t.clone();return d.position.copy(h),d.rotation.copy(r),d.scale.copy(c),d.userData={...l,gameId:this.generateID()},this.scene.add(d),this.objects.push(d),d}}createEnvironment(){const e=(y=1)=>(Math.random()-.5)*(this.mapSize*y),t=(y=1)=>{const M=this.halfMapSize-5,B=e(y);return Math.max(-M,Math.min(M,B))},i=(y=1,M=12)=>{let B,I,C=0;do B=t(y),I=t(y),C++;while(B*B+I*I<M*M&&C<20);return{x:B,z:I}},s=(y,M)=>this.getHeightAt?this.getHeightAt(y,M):0,o={trees:70,rocks:50,bushes:50,grass:180,houses:12,vehicles:12,plateaus:4,smallBuildings:5},n=new te(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let y=0;y<a.count;y++)a.setZ(y,0);a.needsUpdate=!0;const l=n.attributes.position.count;n.setAttribute("color",new xe(new Float32Array(l*3),3));const h=n.attributes.color,r=new ne;for(let y=0;y<l;y++){const M=Math.random();M>.8?r.setHex(2600544):M>.4?r.setHex(3066993):r.setHex(5822093),h.setXYZ(y,r.r,r.g,r.b)}const c=new S({vertexColors:!0,roughness:.8}),d=new g(n,c);d.rotation.x=-Math.PI/2,d.receiveShadow=!0,d.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(d),this.objects.push(d);const p=this.createTree(0,0,"Oak"),m=this.createTree(0,0,"Pine"),u=this.createRock(0,0),w=this.createRockPillar(0,0),E=this.createFlatBoulder(0,0),x=this.createCrystalShard(0,0),k=this.createStackedRock(0,0),D=this.createBasaltCluster(0,0),v=this.createBush(0,0),P=this.createGrassClump(0,0);for(let y=0;y<o.trees;y++){const{x:M,z:B}=i(.9),I=s(M,B),C=Math.random()>.5?"Oak":"Pine",_=C==="Oak"?p:m,F=.8+Math.random()*.4,V=Math.random()*Math.PI*2;this.addWorldObject(C,_,M,I,B,F,V,{gameName:`Tree_${C}`,type:"tree"})}const L=[u,w,E,x,k,D],z=["Rock","RockPillar","FlatBoulder","Crystal","StackedRock","Basalt"];for(let y=0;y<o.rocks;y++){const{x:M,z:B}=i(.9),I=s(M,B),C=y%L.length,_=L[C],F=z[C],V=.8+Math.random()*.4,G=Math.random()*Math.PI*2;this.addWorldObject(F,_,M,I,B,V,G,{gameName:"Rock",type:"rock"})}for(let y=0;y<o.bushes;y++){const{x:M,z:B}=i(.85),I=s(M,B),C=.8+Math.random()*.4,_=Math.random()*Math.PI*2;this.addWorldObject("Bush",v,M,I,B,C,_,{gameName:"Bush"})}for(let y=0;y<o.grass;y++){const{x:M,z:B}=i(.95),I=s(M,B),C=Math.random()*Math.PI*2;this.addWorldObject("Grass",P,M,I,B,1,C,{gameName:"Grass"})}for(let y=0;y<o.houses;y++){const{x:M,z:B}=i(.75,20),I=s(M,B),C=Math.random(),_=C>.7,F=C<.25,V=_?1.55:F?.9:1,G=_?"Mansion":F?"Cabin":"House",Y=_?"large":F?"small":"medium",q=this.createHouse(M,B,{scale:V});q.position.y=I,q.userData={gameId:this.generateID(),gameName:G,type:"house",size:Y},this.scene.add(q),this.objects.push(q),this.itemManager.spawnLootInHouse(M,1,B)}for(let y=0;y<o.vehicles;y++){const{x:M,z:B}=i(.8),I=s(M,B),C=Math.random()>.6?"truck":"car",_=this.createVehicle(M,B,C);_.position.y=I,_.userData={..._.userData||{},gameId:this.generateID(),gameName:`Vehicle_${C}`,type:"vehicle"},this.scene.add(_),this.objects.push(_)}for(let y=0;y<o.plateaus;y++){const{x:M,z:B}=i(.6,25),I=6+Math.random()*6,C=8+Math.random()*6,_=s(M,B),F=this.createPlateau(M,B,C,I,_);F.userData={gameId:this.generateID(),gameName:"Plateau",type:"house"},this.scene.add(F),this.objects.push(F)}for(let y=0;y<o.smallBuildings;y++){const{x:M,z:B}=i(.7,18),I=s(M,B),C=this.createSmallBuilding(M,B);C.position.y=I,C.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"},this.scene.add(C),this.objects.push(C)}}createSurvivalEnvironment(){const e=(y=1)=>(Math.random()-.5)*(this.mapSize*y),t=(y=1)=>{const M=this.halfMapSize-5,B=e(y);return Math.max(-M,Math.min(M,B))},i=(y=1,M=12)=>{let B,I,C=0;do B=t(y),I=t(y),C++;while(B*B+I*I<M*M&&C<20);return{x:B,z:I}},s=(y,M)=>this.getHeightAt?this.getHeightAt(y,M):0,o={trees:90,rocks:60,bushes:80,grass:250},n=new te(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let y=0;y<a.count;y++)a.setZ(y,0);a.needsUpdate=!0;const l=n.attributes.position.count;n.setAttribute("color",new xe(new Float32Array(l*3),3));const h=n.attributes.color,r=new ne;for(let y=0;y<l;y++){const M=Math.random();M>.8?r.setHex(2600544):M>.4?r.setHex(3066993):r.setHex(5822093),h.setXYZ(y,r.r,r.g,r.b)}const c=new S({vertexColors:!0,roughness:.8}),d=new g(n,c);d.rotation.x=-Math.PI/2,d.receiveShadow=!0,d.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(d),this.objects.push(d);const p=this.createTree(0,0,"Oak"),m=this.createTree(0,0,"Pine"),u=this.createRock(0,0),w=this.createRockPillar(0,0),E=this.createFlatBoulder(0,0),x=this.createCrystalShard(0,0),k=this.createStackedRock(0,0),D=this.createBasaltCluster(0,0),v=this.createBush(0,0),P=this.createGrassClump(0,0);for(let y=0;y<o.trees;y++){const{x:M,z:B}=i(.9),I=s(M,B),C=Math.random()>.5?"Oak":"Pine",_=C==="Oak"?p:m,F=.8+Math.random()*.4,V=Math.random()*Math.PI*2;this.addWorldObject(C,_,M,I,B,F,V,{gameName:`Tree_${C}`,type:"tree"})}const L=[u,w,E,x,k,D],z=["Rock","RockPillar","FlatBoulder","Crystal","StackedRock","Basalt"];for(let y=0;y<o.rocks;y++){const{x:M,z:B}=i(.9),I=s(M,B),C=y%L.length,_=L[C],F=z[C],V=.8+Math.random()*.4,G=Math.random()*Math.PI*2;this.addWorldObject(F,_,M,I,B,V,G,{gameName:"Rock",type:"rock"})}for(let y=0;y<o.bushes;y++){const{x:M,z:B}=i(.85),I=s(M,B),C=.8+Math.random()*.4,_=Math.random()*Math.PI*2;this.addWorldObject("Bush",v,M,I,B,C,_,{gameName:"Bush"})}for(let y=0;y<o.grass;y++){const{x:M,z:B}=i(.95),I=s(M,B),C=Math.random()*Math.PI*2;this.addWorldObject("Grass",P,M,I,B,1,C,{gameName:"Grass"})}}createArenaEnvironment(){const e=(n=1)=>(Math.random()-.5)*(this.mapSize*n),t=(n=1)=>{const a=this.halfMapSize-5,l=e(n);return Math.max(-a,Math.min(a,l))},i=new te(this.mapSize,this.mapSize,1,1),s=new ye({color:3885915,flatShading:!0}),o=new g(i,s);o.rotation.x=-Math.PI/2,o.receiveShadow=!0,o.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(o),this.objects.push(o);for(let n=0;n<30;n++){const a=t(.8),l=t(.8),h=1+Math.random()*3,r=1+Math.random()*2,c=1+Math.random()*2,d=new b(r,h,c),p=new ye({color:5596791,flatShading:!0}),m=new g(d,p);m.position.set(a,h/2,l),m.castShadow=!0,m.receiveShadow=!0,m.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},this.scene.add(m),this.objects.push(m)}for(let n=0;n<6;n++){const a=t(.7),l=t(.7),h=6+Math.random()*3,r=3+Math.random()*2,c=3,d=new b(c,r,h),p=new ye({color:4937059,flatShading:!0}),m=new g(d,p);m.position.set(a,r/2,l),m.rotation.x=-Math.atan(r/h),m.castShadow=!0,m.receiveShadow=!0,m.userData={gameId:this.generateID(),gameName:"Ramp",type:"house"},this.scene.add(m),this.objects.push(m)}for(let n=0;n<6;n++){const a=t(.6),l=t(.6),h=this.createArenaBunker(a,l);h.userData={gameId:this.generateID(),gameName:"Bunker",type:"house"},this.scene.add(h),this.objects.push(h)}for(let n=0;n<20;n++){const a=t(.8),l=t(.8),h=this.createFlatBoulder(a,l,0);h.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(h),this.objects.push(h)}this.itemManager.spawnLootInHouse(0,0,0)}createMatrixEnvironment(){const e=new te(this.mapSize,this.mapSize,128,128),t=e.attributes.position.count;e.setAttribute("color",new xe(new Float32Array(t*3),3));const i=e.attributes.color,s=new ne;for(let d=0;d<t;d++){const p=Math.random();p>.8?s.setHex(2600544):p>.4?s.setHex(3066993):s.setHex(5822093),i.setXYZ(d,s.r,s.g,s.b)}const o=new S({vertexColors:!0,roughness:.8}),n=new g(e,o);n.rotation.x=-Math.PI/2,n.receiveShadow=!0,n.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(n),this.objects.push(n);const a=new b(20,6,.5),l=new S({color:15987699,roughness:.9}),h=new g(a,l);h.position.set(0,3,-15),h.castShadow=!0,h.receiveShadow=!0,h.userData={gameId:this.generateID(),gameName:"Wall",type:"house"},this.scene.add(h),this.objects.push(h);const r=this.createTree(-12,-15,"Oak"),c=this.createTree(12,-15,"Pine");this.scene.add(r),this.scene.add(c),this.objects.push(r),this.objects.push(c)}createStudioEnvironment(){const e=new te(this.mapSize,this.mapSize,128,128),t=this.buildVoxelGroundMaterial(),i=new g(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(i),this.objects.push(i);const s=12;for(let o=0;o<s;o++){const n=(Math.random()-.5)*this.mapSize*.6,a=(Math.random()-.5)*this.mapSize*.6,l=this.createVoxelCloud(n,a);this.scene.add(l)}}createMatrixAIEnvironment(){const e=this.mapSize,t=80,i=new Qe(e,t,16777215,16777215);(Array.isArray(i.material)?i.material:[i.material]).forEach(l=>{l.opacity=.3,l.transparent=!0,l.depthWrite=!1}),i.position.y=.02,this.scene.add(i);const o=new te(e,e,1,1),n=new Me({visible:!1}),a=new g(o,n);a.rotation.x=-Math.PI/2,a.userData={gameId:this.generateID(),gameName:"Ground",type:"ground"},this.scene.add(a),this.objects.push(a)}createMultiplayerEnvironment(){const e=new te(this.mapSize,this.mapSize,128,128),t=this.buildVoxelGroundMaterial(),i=new g(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(i),this.objects.push(i),this.stormEnabled=!1}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}createTree(e,t,i){const s=i==="Oak"?Dt():Bt();return s.position.set(e,0,t),s}createVoxelCloud(e,t){const i=new O,s=new b(3,2,3),o=new et({color:15922943,transparent:!0,opacity:.9}),n=8+Math.floor(Math.random()*6);for(let a=0;a<n;a++){const l=(Math.random()-.5)*12,h=(Math.random()-.5)*12,r=(Math.random()-.5)*2,c=new g(s,o);c.position.set(l,r,h),c.castShadow=!1,c.receiveShadow=!1,i.add(c)}return i.position.set(e,30+Math.random()*8,t),i}buildVoxelGroundMaterial(){const t=document.createElement("canvas");t.width=64,t.height=64;const i=t.getContext("2d"),s="#4caf50",o="#66bb6a",n="#8d6e63",a=8;for(let c=0;c<64;c+=a)for(let d=0;d<64;d+=a){const m=Math.random()>.85?n:(d/a+c/a)%2===0?s:o;i.fillStyle=m,i.fillRect(d,c,a,a)}const l=i.getImageData(0,0,64,64),h=l.data;for(let c=0;c<h.length;c+=4){const d=Math.random()*30-15;h[c]=Math.min(255,Math.max(0,h[c]+d)),h[c+1]=Math.min(255,Math.max(0,h[c+1]+d)),h[c+2]=Math.min(255,Math.max(0,h[c+2]+d))}i.putImageData(l,0,0);const r=new tt(t);return r.wrapS=r.wrapT=it,r.repeat.set(this.mapSize/10,this.mapSize/10),r.magFilter=st,r.minFilter=ot,new S({map:r,roughness:1,metalness:0})}createRock(e,t,i=0){const s=Ct(e,t,i);return this._tagStaticCollider(s,"rock"),s}createRockPillar(e,t,i=0){const s=Pt(e,t,i);return this._tagStaticCollider(s,"rock"),s}createFlatBoulder(e,t,i=0){const s=It(e,t,i);return this._tagStaticCollider(s,"rock"),s}createCrystalShard(e,t,i=0){return At(e,t,i)}createStackedRock(e,t,i=0){const s=new O,o=this.createRock(0,0,0);s.add(o);const n=this.createRock(0,0);n.scale.set(.6,.6,.6),n.position.set(.3,n.position.y+.9,-.2),s.add(n);const a=this.createRock(0,0);return a.scale.set(.4,.4,.4),a.position.set(-.2,a.position.y+1.5,.3),s.add(a),s.position.set(e,i,t),s.traverse(l=>{l.castShadow=!0,l.receiveShadow=!0}),this._tagStaticCollider(s,"rock"),s}createBasaltCluster(e,t,i=0){const s=Tt(e,t,i);return this._tagStaticCollider(s,"rock"),s}createVehicle(e,t,i="car"){let s;return i==="bus"?s=Lt():i==="motorcycle"?s=zt():s=_t(i),s.position.set(e,0,t),s}createBush(e,t){const i=new O;i.position.set(e,0,t);const s=new S({color:2924588,roughness:1}),o=2+Math.floor(Math.random()*3);for(let n=0;n<o;n++){const a=1.2+Math.random()*1,l=new g(new Ie(a,6,6),s);l.position.set((Math.random()-.5)*1.2,a*.65,(Math.random()-.5)*1.2),l.castShadow=!0,i.add(l)}return i}createGrassClump(e,t){const i=new O;i.position.set(e,0,t);const s=3+Math.floor(Math.random()*4);for(let o=0;o<s;o++){const n=.2+Math.random()*.6,a=new te(.05,n),l=new S({color:5620331,side:Fe}),h=new g(a,l);h.position.y=n/2,h.rotation.y=Math.random()*Math.PI,h.rotation.z=(Math.random()-.5)*.6,h.receiveShadow=!0,i.add(h)}return i}createHouse(e,t,{scale:i=1}={}){const s=new O;s.position.set(e,0,t),s.rotation.y=Math.random()*Math.PI*2;const o=new S({color:9807270}),n=new S({color:12597547});[{w:6,h:4,d:.5,x:0,y:2,z:-3},{w:.5,h:4,d:6,x:-3,y:2,z:0},{w:.5,h:4,d:6,x:3,y:2,z:0},{w:2,h:4,d:.5,x:-2,y:2,z:3},{w:2,h:4,d:.5,x:2,y:2,z:3},{w:2,h:1,d:.5,x:0,y:3.5,z:3}].forEach(m=>{const u=new g(new b(m.w,m.h,m.d),o);u.position.set(m.x,m.y,m.z),u.castShadow=!0,u.receiveShadow=!0,s.add(u),this.objects.push(u)});const l=new g(new We(5,2,4),n);l.position.y=5,l.rotation.y=Math.PI/4,l.castShadow=!0,s.add(l);const h=new S({color:5057307}),r=new g(new b(1,2.2,.1),h);r.position.set(0,1.1,3.26),s.add(r);const c=new S({color:8962303,metalness:.1,roughness:.2,transparent:!0,opacity:.8}),d=new g(new b(1,1,.05),c);d.position.set(-2,2.2,-3.26);const p=d.clone();return p.position.set(2,2.2,-3.26),s.add(d),s.add(p),s.scale.setScalar(i),s}createPlateau(e,t,i=10,s=8,o=0){const n=new O,a=new S({color:8355711,roughness:1}),l=new g(new ie(i,i*1.05,s,16,1),a);l.position.set(0,s/2,0),l.castShadow=!0,l.receiveShadow=!0,n.add(l);const h=i*1.4,r=s,c=i*.8,d=new b(c,r,h),p=new g(d,new S({color:9342606,roughness:1}));p.castShadow=!0,p.receiveShadow=!0;const m=Math.atan(r/h);p.rotation.x=-m,p.position.set(0,r/2,i),p.userData={type:"house"},n.add(p);const u=new b(c,.2,h),w=new g(u,new S({color:7105644}));return w.position.set(0,r,i),w.rotation.x=p.rotation.x,w.castShadow=!0,n.add(w),n.position.set(e,o,t),n.userData={type:"house"},n}createSmallBuilding(e,t){const i=new O;i.position.set(e,0,t),i.rotation.y=Math.random()*Math.PI*2;const s=new S({color:8359053}),o=new S({color:12436423}),n=8,a=8,l=6,h=.35,r=2.2,c=n/2,d=a/2,p=new g(new b(n,l,h),s);p.position.set(0,l/2,-d);const m=new g(new b(h,l,a),s);m.position.set(-c,l/2,0);const u=m.clone();u.position.x=c;const w=new g(new b((n-r)/2,l,h),s);w.position.set(-2.55,l/2,d);const E=w.clone();E.position.x=r/2+(n-r)/4,[p,m,u,w,E].forEach(y=>{y.castShadow=!0,y.receiveShadow=!0,i.add(y)});const x=new g(new b(n-.4,.3,a-.4),o);x.position.y=.15,x.receiveShadow=!0,i.add(x);const k=new g(new b(n-.4,.3,a-.4),o);k.position.y=3.4,k.receiveShadow=!0,i.add(k);const D=k.position.y,v=10,P=new b(3,D,v),L=new g(P,o);L.position.set(0,D/2,d+v/2),L.rotation.x=-Math.atan(D/v),L.castShadow=!0,L.receiveShadow=!0,i.add(L);const z=new g(new b(n+.4,.4,a+.4),new S({color:9807270}));return z.position.y=l+.2,z.castShadow=!0,i.add(z),i}spawnPrefab(e,t,i,s={}){const o=this.getHeightAt&&typeof this.getHeightAt=="function"?this.getHeightAt(t,i):0;let n=null;switch(e){case"house":{n=this.createHouse(t,i,{scale:1}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"House",type:"house"};break}case"mansion":{n=this.createHouse(t,i,{scale:1.6}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Mansion",type:"house",size:"large"};break}case"cabin":{n=this.createHouse(t,i,{scale:.85}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Cabin",type:"house",size:"small"};break}case"smallBuilding":{n=this.createSmallBuilding(t,i),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"};break}case"plateau":{const a=this.createPlateau(t,i,10+Math.random()*6,8+Math.random()*6,o);a.userData={gameId:this.generateID(),gameName:"Plateau",type:"house",size:"large"},n=a;break}case"rock":{n=this.createRock(t,i),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"};break}case"tree":{const a=s.variant||(Math.random()>.5?"Oak":"Pine");n=this.createTree(t,i,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Tree_${a}`,type:"tree"};break}case"vehicle":{const a=s.variant||(Math.random()>.6?"truck":"car");n=this.createVehicle(t,i,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Vehicle_${a}`,type:"vehicle"};break}case"crate":{const a=new g(new b(2,2,2),new S({color:9342606,roughness:.9}));a.position.set(t,o+1,i),a.castShadow=!0,a.receiveShadow=!0,a.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},n=a;break}}return n&&(this.scene.add(n),this.objects.push(n)),n}createArenaBunker(e,t){const i=new O;i.position.set(e,0,t),i.rotation.y=Math.random()*Math.PI*2;const s=new ye({color:4937059,flatShading:!0}),o=new ye({color:6253691,flatShading:!0}),n=new g(new b(6,2.5,6),s);n.position.y=1.25,n.castShadow=!0,n.receiveShadow=!0,i.add(n);const a=new g(new b(6.2,.3,6.2),o);a.position.y=2.65,a.castShadow=!0,i.add(a);const l=new g(new b(1.2,1.8,.2),new ye({color:9280168,flatShading:!0,transparent:!0,opacity:.2}));l.position.set(0,.9,3.1),i.add(l);const h=new b(2,1.2,4),r=new g(h,o);return r.position.set(-2.5,.6,-1),r.rotation.x=-Math.atan(1.2/4),r.castShadow=!0,r.receiveShadow=!0,r.userData={type:"house"},i.add(r),i}createStormVisuals(){if(this.gameMode==="matrix")return;const e=new ie(this.stormRadius,this.stormRadius,50,32,1,!0),t=new Me({color:9323693,transparent:!0,opacity:.3,side:Fe});this.stormMesh=new g(e,t),this.stormMesh.position.y=25,this.scene.add(this.stormMesh)}createTarget(e,t){const i=new O;i.position.set(e,0,t);const s=new g(new ie(.05,.05,2,6),new S({color:8947848}));s.position.y=1,i.add(s);const o=new je(.8,24),n=new S({color:16777215}),a=new g(o,n);a.position.set(0,2,0),a.rotation.y=Math.PI,i.add(a);const l=new S({color:16729156}),h=new S({color:15844367}),r=new S({color:3447003}),c=(p,m)=>{const u=new g(new nt(p,.02,6,24),m);return u.rotation.x=Math.PI/2,u.position.y=2,u};i.add(c(.75,r)),i.add(c(.55,l)),i.add(c(.35,h));const d=new g(new je(.1,12),new S({color:0}));return d.position.set(0,2.01,0),d.rotation.y=Math.PI,i.add(d),i.userData={gameId:this.generateID(),gameName:"Target",type:"house"},i}update(e,t){if(this.gameMode==="matrix"||this.gameMode==="studio"||this.gameMode==="matrix-ai")return{inStorm:!1};if(this.stormEnabled===!1)return{inStorm:!1};if(this.stormRadius>10){this.stormRadius-=this.stormShrinkRate*e;const s=this.initialStormRadius?this.stormRadius/this.initialStormRadius:1;this.stormMesh&&this.stormMesh.scale&&this.stormMesh.scale.set(s,1,s)}return{inStorm:Math.sqrt(t.x*t.x+t.z*t.z)>this.stormRadius}}_buildHeightFn(){return()=>0}_tagStaticCollider(e,t=null){if(!e)return;e.updateWorldMatrix(!0,!0);const i=new Ue().setFromObject(e);e.userData=e.userData||{},t&&!e.userData.type&&(e.userData.type=t),e.userData.colliderBox=i,e.userData.colliderType="solid"}getHeightAt(e,t){return this._heightFn?this._heightFn(e,t):0}}const we=new Ee(0,0,0,"YXZ"),ve=new T,Nt={type:"change"},Vt={type:"lock"},Gt={type:"unlock"},Ve=Math.PI/2;class Wt extends at{constructor(e,t){super(),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=Ut.bind(this),this._onPointerlockChange=Xt.bind(this),this._onPointerlockError=Yt.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(e){return e.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(e){const t=this.camera;ve.setFromMatrixColumn(t.matrix,0),ve.crossVectors(t.up,ve),t.position.addScaledVector(ve,e)}moveRight(e){const t=this.camera;ve.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(ve,e)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function Ut(H){if(this.isLocked===!1)return;const e=H.movementX||H.mozMovementX||H.webkitMovementX||0,t=H.movementY||H.mozMovementY||H.webkitMovementY||0,i=this.camera;we.setFromQuaternion(i.quaternion),we.y-=e*.002*this.pointerSpeed,we.x-=t*.002*this.pointerSpeed,we.x=Math.max(Ve-this.maxPolarAngle,Math.min(Ve-this.minPolarAngle,we.x)),i.quaternion.setFromEuler(we),this.dispatchEvent(Nt)}function Xt(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(Vt),this.isLocked=!0):(this.dispatchEvent(Gt),this.isLocked=!1)}function Yt(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}const $t="/threejs-voxel-firecraft/dist/assets/mixkit-game-gun-shot-D1lu3gfh.ogg",qt="/threejs-voxel-firecraft/dist/assets/smack-BAv2er9i.ogg",Kt="/threejs-voxel-firecraft/dist/assets/ugh-CPf3Qqe6.ogg",Jt="/threejs-voxel-firecraft/dist/assets/mixkit-footsteps-on-tall-grass-532-DkmduvPT.ogg",Zt="/threejs-voxel-firecraft/dist/assets/mixkit-car-door-slam-xN3cwxzE.wav";class Ae{constructor(e,t,i,s={}){this.camera=e,this.scene=t,this.worldObjects=i,this.world=null,this.hud=null,this.gameMode=s.gameMode||"arcade",this.showTracers=s.showTracers===!0,this.backpack=null,this.backpackColor=null,this.placedBlocks=[],this.blockSize=1,this.minBlockSize=.5,this.maxBlockSize=2,this.previewBlock=null,this.isFloating=!1,this.selectedBlock=null,this.selectedBlockHelper=null,this.health=100,this.shield=100,this.isDead=!1,this.stamina=100,this.punchCount=0,this.isTired=!1,this.velocity=new T,this.direction=new T,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.isSprinting=!1,this.canJump=!1,this.speed=42,this.jumpHeight=16,this.gravity=65,this.mouthStyle=s&&s.mouthStyle?s.mouthStyle:"serious",this.mouthMesh=null,this.mouthStyles=["serious","smile","angry","surprised","none"],this.showHat=s&&typeof s.showHat<"u"?s.showHat:!0,this.hatMeshes=[],this.distanceTraveled=0,this.previousPosition=new T,this.allWeapons=[{name:"Pistol",ammo:12,maxAmmo:60,magazineSize:12,currentMag:12,damage:20,cooldown:.5,lastShot:0,reloadTime:1.5,range:50},{name:"Fist",ammo:1/0,maxAmmo:1/0,magazineSize:1/0,currentMag:1/0,damage:10,cooldown:.2,lastShot:0,reloadTime:0,range:3},{name:"Rifle",ammo:30,maxAmmo:120,magazineSize:30,currentMag:30,damage:25,cooldown:.15,lastShot:0,reloadTime:2,range:120,zoomFov:30},{name:"Sniper",ammo:5,maxAmmo:20,magazineSize:5,currentMag:5,damage:100,cooldown:2,lastShot:0,reloadTime:3,range:400,zoomFov:12},{name:"SMG",ammo:40,maxAmmo:200,magazineSize:40,currentMag:40,damage:15,cooldown:.08,lastShot:0,reloadTime:1.8,range:80},{name:"Shotgun",ammo:6,maxAmmo:24,magazineSize:6,currentMag:6,damage:60,cooldown:1,lastShot:0,reloadTime:2.5,range:25},{name:"DMR",ammo:12,maxAmmo:48,magazineSize:12,currentMag:12,damage:45,cooldown:.35,lastShot:0,reloadTime:2.2,range:200,zoomFov:18}],this.gameMode==="matrix-ai"?this.weapons=[this.allWeapons[1]]:this.weapons=[this.allWeapons[1],this.allWeapons[0]],this.currentWeaponIndex=0,this.isReloading=!1,this.controls=new Wt(e,document.body),document.addEventListener("pointerlockerror",o=>{try{o.stopImmediatePropagation()}catch{}console.warn("Pointer lock request failed or unavailable in this environment.")},!0),this.allowTouchMovement=!1,this._touchYaw=0,this._touchPitch=0,document.addEventListener("fullscreenchange",()=>{document.fullscreenElement&&document.exitFullscreen().catch(()=>{})}),this.createPlayerMesh(),this.cameraMode=s.cameraMode||"TPS",this.fpsCameraOffset=new T(0,1.6,0),this.tpsCameraOffset=new T(1,1.8,3.4),this.initControls(),this.sfxVolume=.7,this.sfxVolume=.7,this.gunshotBuffer=null,this.reloadBuffer=null,this.smackBuffer=null,this.ughBuffer=null,this.footstepsBuffer=null,this._footstepsSource=null,this._footstepsGain=null,this.vehicleDoorBuffer=null,this.vehicleDriveBuffer=null,this._vehicleDriveSource=null,this._vehicleDriveGain=null,this._lastVehicleDriveActive=!1,this.enableVehicleDriveSound=!1,this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer=null,this._lastFootstepsActive=!1,this.isCrouching=!1,this.crouchHeight=.8,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.vehicleBaseMaxSpeed=70,this.vehicleBoostMax=45,this.vehicleAccel=70,this.vehicleTurnSpeed=1.8,this.vehicleFriction=2.8,this.vehicleAccelHold=0,this.vehiclePromptEl=document.getElementById("interaction-prompt"),this.nearVehicle=null,this.vehicleFuel=0,this.vehicleFuelCapacity=0,this.vehicleDistance=0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=0,this.vehicleEfficiencyKmPerL=10,this.vehicleIdleLph=.4,this.vehicleThrottleLph=.8,this._vehicleStateCache=null,this.vehicleTurbo=!1,this.currentSpeed=0,this.vehicleHud={root:document.getElementById("vehicle-hud"),speed:document.getElementById("vehicle-speed"),fuelBar:document.getElementById("vehicle-fuel-bar"),fuelFill:document.getElementById("vehicle-fuel-fill"),fuelText:document.getElementById("vehicle-fuel-text"),distance:document.getElementById("vehicle-distance"),efficiency:document.getElementById("vehicle-efficiency"),range:document.getElementById("vehicle-range")},this.studioSelected=null,this._studioRaycaster=new $,this.studioSelectionHelper=null,this.selectionInfo=document.getElementById("selection-info"),this.controls.enabled=this.gameMode!=="studio";try{const o=window.AudioContext||window.webkitAudioContext;o&&(this.audioCtx=new o,fetch($t).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.gunshotBuffer=n}).catch(n=>console.warn("Error loading gunshot SFX:",n)),Ht(()=>import("./mixkit-shotgun-recharge-CcrH8C2K.js"),[]).then(n=>fetch(n.default)).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.reloadBuffer=n}).catch(n=>console.warn("Error loading reload SFX:",n)),fetch(qt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.smackBuffer=n}).catch(n=>console.warn("Error loading smack SFX:",n)),fetch(Kt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.ughBuffer=n}).catch(n=>console.warn("Error loading hurt SFX:",n)),fetch(Jt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.footstepsBuffer=n}).catch(n=>console.warn("Error loading footsteps SFX:",n)),fetch(Zt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.vehicleDoorBuffer=n}).catch(n=>console.warn("Error loading vehicle door SFX:",n)))}catch(o){console.warn("Web Audio API not supported:",o)}}separateFromRemotePlayers(){if(!this.multiplayerClient||!this.multiplayerClient.others||this.multiplayerClient.others.size===0)return;const t=.6*2,i=this.mesh.position;this.multiplayerClient.others.forEach(s=>{if(!s||!s.position||s.userData&&s.userData.dead)return;const o=i.x-s.position.x,n=i.z-s.position.z,a=o*o+n*n;if(a<t*t&&a>1e-4){const l=Math.sqrt(a),h=(t-l)*.5,r=o/l,c=n/l;i.x+=r*h,i.z+=c*h}})}placeBlock(){if(!this.world)return;const e=this.getBlockTarget(),t=e.size,i=new b(t,t,t),s=new S({color:11887901,roughness:.9}),o=new g(i,s);o.position.copy(e.position),o.castShadow=!0,o.receiveShadow=!0,o.userData={type:"block",size:t,gameId:this.world.generateID?this.world.generateID():void 0,gameName:"Block"},this.scene.add(o),this.world.objects&&this.world.objects.push(o),this.placedBlocks.push(o)}createPlayerMesh(){this.mesh=new O,this.scene.add(this.mesh);const e=this.playerColor||3447003,t=new S({color:e}),i=new S({color:16764074}),s=new S({color:2899536});this.head=new g(new b(.5,.5,.5),i),this.head.position.y=1.75,this.head.name="playerHead",this.head.userData={role:"playerHead"},this.mesh.add(this.head);const o=new S({color:15158332}),n=new g(new b(.52,.1,.52),o);n.position.set(0,.3,0),n.userData={role:"playerHat"},n.name="playerHatCap",this.head.add(n);const a=new g(new b(.52,.02,.35),o);a.position.set(0,.22,.35),a.userData={role:"playerHat"},a.name="playerHatBrim",this.head.add(a),this.hatMeshes=[n,a],this.setHatVisible(this.showHat);const l=new S({color:0}),h=new S({color:1710618,transparent:!0,opacity:.7,metalness:.8,roughness:.2}),r=new g(new b(.18,.12,.02),h);r.position.set(-.12,.05,.26),this.head.add(r);const c=new g(new b(.18,.12,.02),h);c.position.set(.12,.05,.26),this.head.add(c);const d=new g(new b(.08,.02,.02),l);d.position.set(0,.05,.26),this.head.add(d);const p=new g(new b(.02,.02,.3),l);p.position.set(-.21,.05,.1),this.head.add(p);const m=new g(new b(.02,.02,.3),l);m.position.set(.21,.05,.1),this.head.add(m),this.createMouth(this.mouthStyle);const u=new g(new b(.6,.8,.3),t);u.position.y=1.1,this.mesh.add(u);const w=new b(.2,.8,.2);w.translate(0,-.3,0),this.leftArmPivot=new O,this.leftArmPivot.name="leftArmPivot",this.leftArmPivot.position.set(-.45,1.4,0),this.mesh.add(this.leftArmPivot);const E=new g(w,i);this.leftArmPivot.add(E),this.rightArmPivot=new O,this.rightArmPivot.name="rightArmPivot",this.rightArmPivot.position.set(.45,1.4,0),this.mesh.add(this.rightArmPivot);const x=new g(w,i);this.rightArmPivot.add(x),this.weaponModels={};const k=new O,D=new g(new b(.12,.12,.35),new S({color:1710618,metalness:.8,roughness:.3}));D.position.set(0,-.28,.2);const v=new g(new b(.06,.06,.15),new S({color:657930,metalness:.9,roughness:.2}));v.position.set(0,-.28,.4);const P=new g(new b(.1,.25,.12),new S({color:2894892}));P.position.set(0,-.42,.15);const L=new g(new b(.03,.05,.03),new S({color:1710618}));L.position.set(0,-.35,.18),k.add(D,v,P,L),this.rightArmPivot.add(k),this.weaponModels.Pistol=k;const z=new O,y=new g(new b(.08,.08,.9),new S({color:1710618,metalness:.8,roughness:.3}));y.position.set(0,-.28,.45);const M=new g(new b(.12,.14,.4),new S({color:2894892}));M.position.set(0,-.3,.2);const B=new g(new b(.1,.22,.12),new S({color:2894892}));B.position.set(0,-.44,.15);const I=new g(new b(.1,.12,.25),new S({color:3815994}));I.position.set(0,-.28,-.1);const C=new g(new b(.08,.25,.1),new S({color:1710618}));C.position.set(0,-.5,.2),z.add(y,M,B,I,C),this.rightArmPivot.add(z),this.weaponModels.Rifle=z;const _=new O,F=new g(new b(.08,.08,1.3),new S({color:1727514,metalness:.6,roughness:.4}));F.position.set(0,-.28,.65);const V=new g(new b(.14,.16,.5),new S({color:2969622}));V.position.set(0,-.3,.25);const G=new g(new ie(.06,.06,.35,8),new S({color:657930,metalness:.9,roughness:.1}));G.rotation.z=Math.PI/2,G.position.set(0,-.18,.4);const Y=new g(new ie(.05,.05,.02,8),new S({color:1723791,metalness:.9,roughness:.1,emissive:663616}));Y.rotation.z=Math.PI/2,Y.position.set(0,-.18,.58);const q=new g(new b(.12,.14,.3),new S({color:3811866}));q.position.set(0,-.28,-.05);const se=new g(new b(.02,.15,.02),new S({color:1710618}));se.position.set(0,-.42,.5),_.add(F,V,G,Y,q,se),this.rightArmPivot.add(_),this.weaponModels.Sniper=_,Object.values(this.weaponModels).forEach(j=>j.visible=!1);const K=z.clone();K.traverse(j=>{j.material&&j.material.color&&j.material.color.setHex(5598095)}),K.scale.set(.8,.8,.8),this.rightArmPivot.add(K),this.weaponModels.SMG=K;const J=z.clone();J.traverse(j=>{j.material&&j.material.color&&j.material.color.setHex(9132587)}),J.scale.set(1.1,1,.8),this.rightArmPivot.add(J),this.weaponModels.Shotgun=J;const Z=z.clone();Z.traverse(j=>{j.material&&j.material.color&&j.material.color.setHex(3050327)}),Z.scale.set(.95,.95,1),this.rightArmPivot.add(Z),this.weaponModels.DMR=Z;const ae=new b(this.blockSize,this.blockSize,this.blockSize),re=new S({color:3066993,transparent:!0,opacity:.35,wireframe:!0});this.previewBlock=new g(ae,re),this.previewBlock.visible=this.gameMode==="studio",this.previewBlock.castShadow=!1,this.previewBlock.receiveShadow=!1,this.scene.add(this.previewBlock);const oe=new b(.25,.8,.25);oe.translate(0,-.4,0),this.leftLegPivot=new O,this.leftLegPivot.name="leftLegPivot",this.leftLegPivot.position.set(-.15,.7,0),this.mesh.add(this.leftLegPivot);const ce=new g(oe,s);this.leftLegPivot.add(ce),this.rightLegPivot=new O,this.rightLegPivot.name="rightLegPivot",this.rightLegPivot.position.set(.15,.7,0),this.mesh.add(this.rightLegPivot);const ee=new g(oe,s);if(this.rightLegPivot.add(ee),this.isAiming=!1,this.baseFov=75,this.aimFov=20,this.hitTimer=0,this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.animTime=0,this.isPunching=!1,this.punchSide=0,this.isBlocking=!1,this.yaw=0,this.pitch=0,this.camera){const j=new Ee().setFromQuaternion(this.camera.quaternion,"YXZ");this.yaw=j.y,this.pitch=j.x}}rotateCamera(e,t){if(!this.controls||!this.controls.isLocked){this.yaw-=e,this.pitch-=t;const i=Math.PI/2-.01;this.pitch=Math.max(-i,Math.min(i,this.pitch)),this.camera.rotation.set(this.pitch,this.yaw,0,"YXZ")}}initControls(){const e=o=>{if(this.gameMode==="studio"&&this.studioSelected)switch(o.code){case"ArrowUp":o.shiftKey?this.moveSelectedObject(0,0,1.5):this.moveSelectedObject(0,-2),o.preventDefault();return;case"ArrowDown":o.shiftKey?this.moveSelectedObject(0,0,-1.5):this.moveSelectedObject(0,2),o.preventDefault();return;case"ArrowLeft":this.moveSelectedObject(-2,0),o.preventDefault();return;case"ArrowRight":this.moveSelectedObject(2,0),o.preventDefault();return;case"KeyX":this.removeSelectedObject(),o.preventDefault();return}switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"Space":this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"Digit1":this.switchWeapon(0);break;case"Digit2":this.switchWeapon(1);break;case"Digit3":this.switchWeapon(2);break;case"Digit4":this.switchWeapon(3);break;case"Digit5":this.switchWeapon(4);break;case"Digit6":this.switchWeapon(5);break;case"Numpad1":this.switchWeapon(0);break;case"Numpad2":this.switchWeapon(1);break;case"Numpad3":this.switchWeapon(2);break;case"Numpad4":this.switchWeapon(3);break;case"Numpad5":this.switchWeapon(4);break;case"Numpad6":this.switchWeapon(5);break;case"KeyB":this.gameMode==="studio"&&this.placeBlock();break;case"KeyU":if(this.gameMode==="studio"&&(this.isFloating=!this.isFloating,!this.isFloating)){const n=this.getSurfaceHeight(this.position.x,this.position.z);this.mesh.position.y=n,this.velocity.y=0}break;case"Minus":this.gameMode==="studio"&&this.adjustBlockSize(-.1);break;case"Equal":this.gameMode==="studio"&&this.adjustBlockSize(.1);break;case"KeyM":this.gameMode==="studio"&&this.moveLastBlock();break;case"KeyX":this.gameMode==="studio"&&(this.studioSelected?this.removeSelectedObject():this.selectedBlock?this.removeBlock(this.selectedBlock):this.removeLastBlock());break;case"KeyR":this.reload();break;case"KeyC":this.isCrouching=!this.isCrouching,this.isCrouching&&(this.isSprinting=!1);break;case"ShiftLeft":case"ShiftRight":this.isCrouching||(this.isSprinting=!0);break;case"Space":!this.isInVehicle&&this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"KeyN":this.isInVehicle&&(this.vehicleTurbo=!0);break;case"KeyV":this.toggleCameraMode();break;case"KeyE":if(this.isInVehicle){this.exitVehicle();return}else{const n=this.findNearbyVehicle();if(n){this.enterVehicle(n);return}}break}},t=o=>{switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"ShiftLeft":case"ShiftRight":this.isSprinting=!1;break;case"Space":break;case"KeyN":this.vehicleTurbo=!1;break}},i=o=>{this.gameMode==="studio"&&(this.selectStudioObject(o)||this.selectBlockUnderCrosshair())||this.controls.isLocked&&(o.button===0?this.shoot():o.button===2&&(this.isAiming=!0))},s=o=>{o.button===2&&(this.isAiming=!1)};document.addEventListener("keydown",e),document.addEventListener("keyup",t),document.addEventListener("mousedown",i),document.addEventListener("mouseup",s),document.addEventListener("contextmenu",o=>o.preventDefault()),this._mouthRaycaster=new $,document.addEventListener("pointerdown",o=>{try{if(this.controls&&this.controls.isLocked||!this.head||!this.camera)return;const n=o.clientX/window.innerWidth*2-1,a=-(o.clientY/window.innerHeight)*2+1;this._mouthRaycaster.setFromCamera(new X(n,a),this.camera);const l=this._mouthRaycaster.intersectObject(this.head,!0);l&&l.length>0&&(o.preventDefault(),o.stopPropagation(),this.cycleMouthStyle())}catch{}})}lockControls(){if(!("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document)){console.warn("Pointer Lock API not available in this environment.");return}const t=document.getElementById("main-menu");if(!(t&&t.style.display!=="none")&&!this.isPaused)try{const i=this.controls.lock();i&&typeof i.catch=="function"&&i.catch(()=>{})}catch(i){console.warn("Unable to lock pointer:",i)}}toggleCameraMode(){this.cameraMode=this.cameraMode==="FPS"?"TPS":"FPS",this.mesh&&(this.mesh.visible=this.cameraMode==="TPS"),console.log(`Camera mode: ${this.cameraMode}`)}switchWeapon(e){if(e>=0&&e<this.weapons.length){if(this.isReloading)return;this.currentWeaponIndex=e;const t=this.weapons[e].name;Object.values(this.weaponModels).forEach(i=>i.visible=!1),this.weaponModels[t]&&(this.weaponModels[t].visible=!0)}}reload(){if(this.isReloading)return;const e=this.weapons[this.currentWeaponIndex];e.ammo!==1/0&&e.currentMag!==e.magazineSize&&(e.ammo<=0||(this.isReloading=!0,console.log("Reloading..."),this.playReloadSound(),setTimeout(()=>{this.finishReload()},e.reloadTime*1e3)))}playReloadSound(){try{if(this.audioCtx&&this.reloadBuffer){this.audioCtx.state==="suspended"&&this.audioCtx.resume();const e=this.audioCtx.createBufferSource();e.buffer=this.reloadBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume*.8,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}catch(e){console.warn("Error playing reload sound:",e)}}finishReload(){if(!this.isReloading)return;const e=this.weapons[this.currentWeaponIndex],t=e.magazineSize-e.currentMag,i=e.ammo,s=Math.min(t,i);e.currentMag+=s,e.ammo-=s,this.isReloading=!1,console.log("Reloaded!")}startBlocking(){this.weapons[this.currentWeaponIndex].name==="Fist"&&(this.isBlocking=!0)}stopBlocking(){this.isBlocking=!1}collectItem(e){if(e==="ShieldPotion"){this.shield=Math.min(100,this.shield+50);return}if(e==="MedKit"){this.health=Math.min(100,this.health+25),console.log("Used MedKit from chest: +25 HP");return}if(e&&e.startsWith("Backpack:")){const i=e.split(":")[1]||"2c3e50";return this.equipBackpack(parseInt(i,16))}const t=this.weapons.find(i=>i.name===e);if(t)t.ammo=Math.min(t.maxAmmo,t.ammo+t.magazineSize),console.log("Added ammo for "+e);else{const i=this.allWeapons.find(s=>s.name===e);i&&(this.weapons.push(i),console.log("Picked up "+e))}}setEnemyManager(e){this.enemyManager=e}setMultiplayerClient(e){this.multiplayerClient=e}shoot(){var l;if(!(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0)||this.isDead||this.isReloading||this.isBlocking)return;const t=this.weapons[this.currentWeaponIndex],i=performance.now()/1e3;if(i-t.lastShot<t.cooldown)return;if(t.currentMag<=0){this.reload();return}if(t.lastShot=i,t.ammo!==1/0&&t.currentMag--,t.name==="Fist"){this.punch();return}this.createMuzzleFlash();try{if(this.audioCtx&&this.gunshotBuffer&&this.audioCtx.state==="running"){const h=this.audioCtx.createBufferSource();h.buffer=this.gunshotBuffer,t.name==="Pistol"?h.playbackRate.value=1:t.name==="Rifle"?h.playbackRate.value=1.15:t.name==="Sniper"?h.playbackRate.value=.9:h.playbackRate.value=1;const r=this.audioCtx.createGain();r.gain.value=this.sfxVolume,h.connect(r),r.connect(this.audioCtx.destination),h.start(0)}else this.audioCtx&&this.audioCtx.state==="suspended"&&this.audioCtx.resume()}catch{}const s=new $;s.setFromCamera(new X(0,0),this.camera);const o=this.camera.position.clone();new T,s.ray.direction.clone().normalize();let n=o.clone().add(s.ray.direction.clone().multiplyScalar(1e3)),a=!1;if(this.worldObjects&&this.worldObjects.length>0){const h=s.intersectObjects(this.worldObjects,!0);h.length>0&&(n=h[0].point.clone(),a=!0)}if(this.enemyManager&&this.enemyManager.enemies){const h=s.intersectObjects(this.enemyManager.enemies.map(r=>r.mesh),!0);if(h.length>0){const r=h[0].point,c=o.distanceTo(r),d=o.distanceTo(n);if(c<d){const p=h[0].object;n=r.clone(),a=!0;let m=null;if(m=(w=>{let E=w;for(;E;){const x=this.enemyManager.enemies.find(k=>k.mesh===E);if(x)return x;E=E.parent}return null})(p),m){const w=o.distanceTo(m.position),E=t.range||1e3;if(w<=E){const x=t.damage;if(this.multiplayerClient&&this.player&&this.player.gameMode==="multiplayer"){const k=this.multiplayerClient.isHost,D=m.mesh&&m.mesh.userData?m.mesh.userData.gameId:null;D&&(k?(m.takeDamage(x),typeof this.multiplayerClient.sendZombieState=="function"&&this.multiplayerClient.sendZombieState(D,m.health)):typeof this.multiplayerClient.sendZombieHit=="function"&&this.multiplayerClient.sendZombieHit(D,x))}else m.takeDamage(t.damage)}else a=!1}}}}if(this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const h=Array.from(this.multiplayerClient.others.values()),r=s.intersectObjects(h,!0);if(r.length>0){const c=r[0].point,d=o.distanceTo(c),p=o.distanceTo(n);if(d<p){n=c.clone(),a=!0;let m=r[0].object;for(;m&&!((l=m.userData)!=null&&l.gameId)&&m.parent;)m=m.parent;const u=m&&m.userData?m.userData.gameId:null;u&&this.multiplayerClient&&typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(u,t.damage)}}}this.showTracers&&this.createBulletTracer(o,n,a),a&&t.name==="Sniper"&&this.createImpactSmoke(n)}static buildMouthMesh(e){const t=(e||"serious").toLowerCase(),i=new S({color:2824976,roughness:.6,metalness:0});let s=null;if(t==="smile"){const o=new O;o.userData={role:"playerMouth"},o.name="playerMouth";const n=i.clone(),a=new g(new b(.08,.04,.02),n),l=a.clone(),h=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,l.position.set(0,-.16,.26),h.position.set(.1,-.15,.26),h.rotation.z=.2,[a,l,h].forEach(r=>{r.userData={role:"playerMouth"},r.name="playerMouthSeg"}),o.add(a,l,h),s=o}else if(t==="angry"){const o=new S({color:5901324,roughness:.4});s=new g(new b(.26,.05,.02),o),s.position.set(0,-.16,.26),s.rotation.z=-.18,s.userData={role:"playerMouth"}}else if(t==="surprised")s=new g(new ie(.06,.06,.02,20),i),s.position.set(0,-.14,.26),s.rotation.x=Math.PI/2,s.userData={role:"playerMouth"};else{if(t==="none")return null;s=new g(new b(.22,.06,.02),i),s.position.set(0,-.16,.26),s.userData={role:"playerMouth"}}return s.castShadow=!1,s.receiveShadow=!1,s.name="playerMouth",s}createMouth(e){if(!this.head)return;if(this.mouthMesh){try{this.head.remove(this.mouthMesh)}catch{}this.mouthMesh=null}const t=Ae.buildMouthMesh(e);t&&(this.head.add(t),this.mouthMesh=t)}setHatVisible(e){this.showHat=e,Array.isArray(this.hatMeshes)&&this.hatMeshes.forEach(t=>{t&&(t.visible=e)})}cycleMouthStyle(){const e=this.mouthStyle||"serious",t=this.mouthStyles.indexOf(e),i=this.mouthStyles[(t+1)%this.mouthStyles.length];this.mouthStyle=i,this.createMouth(i),this.persistSetting("mouthStyle",i);const s=document.getElementById("setting-mouth-style");s&&(s.value=i)}persistSetting(e,t){if(!(typeof window>"u"||!window.localStorage))try{const i=window.localStorage.getItem("voxel-firecraft-settings"),s=i?JSON.parse(i):{};s[e]=t,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(s))}catch{}}createMuzzleFlash(){const e=new rt(16776960,1,5),t=new T;this.camera.getWorldDirection(t),e.position.copy(this.mesh.position),e.position.y+=1.5,e.position.add(t.multiplyScalar(1)),this.scene.add(e),setTimeout(()=>this.scene.remove(e),100)}createBulletTracer(e,t,i){const s=[e,t],o=new Xe().setFromPoints(s),n=i?16729156:16776960,a=new ht({color:n,linewidth:2,opacity:.8,transparent:!0}),l=new lt(o,a);this.scene.add(l);let h=.8;const r=setInterval(()=>{h-=.1,a.opacity=h,h<=0&&(clearInterval(r),this.scene.remove(l),o.dispose(),a.dispose())},30)}createImpactSmoke(e){const t=new O;t.position.copy(e);const i=8;for(let a=0;a<i;a++){const l=.15+Math.random()*.2,h=new Ie(l,6,6),r=new Me({color:6710886,transparent:!0,opacity:.5}),c=new g(h,r);c.position.set((Math.random()-.5)*.4,(Math.random()-.5)*.2,(Math.random()-.5)*.4),t.add(c)}this.scene.add(t);const s=600,o=performance.now(),n=()=>{const a=performance.now()-o,l=Math.max(0,1-a/s);t.children.forEach(h=>{h.material&&(h.material.opacity=l*.5)}),a<s?requestAnimationFrame(n):(t.traverse(h=>{h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()}),this.scene.remove(t))};n()}update(e){if(this.isDead)return;if(this.updateVehiclePrompt(),this.isInVehicle){this.updateVehicleDrive(e);return}if(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0){this.velocity.x-=this.velocity.x*10*e,this.velocity.z-=this.velocity.z*10*e,this.isFloating?this.velocity.y*=.9:this.velocity.y-=this.gravity*e,this.direction.z=Number(this.moveForward)-Number(this.moveBackward),this.direction.x=Number(this.moveRight)-Number(this.moveLeft),this.direction.normalize(),(this.moveForward||this.moveBackward)&&(this.velocity.z-=this.direction.z*this.speed*e),(this.moveLeft||this.moveRight)&&(this.velocity.x-=this.direction.x*this.speed*e);const i=new T;this.camera.getWorldDirection(i),i.y=0,i.normalize();const s=new T;s.crossVectors(i,new T(0,1,0));const o=new T;this.moveForward&&o.add(i),this.moveBackward&&o.sub(i),this.moveRight&&o.add(s),this.moveLeft&&o.sub(s),o.normalize();const n=o.length()>0;let a=1;this.isSprinting&&!this.isCrouching&&n&&this.stamina>0&&(a=2);const l=this.speed*e*.1*a,h=o.multiplyScalar(l);h.x!==0&&(this.checkCollision(new T(Math.sign(h.x),0,0),Math.abs(h.x))||(this.mesh.position.x+=h.x)),h.z!==0&&(this.checkCollision(new T(0,0,Math.sign(h.z)),Math.abs(h.z))||(this.mesh.position.z+=h.z));let r=0;if(this.isFloating){const x=new T;this.camera.getWorldDirection(x);const k=x.y;this.moveForward&&(r+=k*this.speed*e*.3),this.moveBackward&&(r-=k*this.speed*e*.3)}if(this.mesh.position.y+=this.velocity.y*e+r,o.length()>0){const x=Math.atan2(o.x,o.z);this.mesh.rotation.y=x}if(this.mesh.position.y+=this.velocity.y*e,!this.isFloating&&!this.isFloating){this.mesh.position.y<0&&(this.velocity.y=0,this.mesh.position.y=0,this.canJump=!0);const x=this.getSurfaceHeight(this.mesh.position.x,this.mesh.position.z);this.mesh.position.y<x&&(this.mesh.position.y=x,this.velocity.y=0,this.canJump=!0)}const c=!this.isFloating&&(this.canJump||this.mesh.position.y<=.01);if(this.handleFootsteps(n&&c&&!this.isDead),this.gameMode==="studio"?this.updateBlockPreview():this.previewBlock&&(this.previewBlock.visible=!1),this.world&&typeof this.world.halfMapSize=="number"){const x=this.world.halfMapSize-1;this.mesh.position.x=Math.max(-x,Math.min(x,this.mesh.position.x)),this.mesh.position.z=Math.max(-x,Math.min(x,this.mesh.position.z))}if(this.separateFromRemotePlayers(),this.previousPosition.length()>0){const x=this.mesh.position.distanceTo(this.previousPosition);this.distanceTraveled+=x,e>0&&(this.currentSpeed=x/e)}if(this.previousPosition.copy(this.mesh.position),this.gameMode==="studio"||this.gameMode==="matrix-ai")this.stamina=100;else if(this.isSprinting&&!this.isCrouching&&n&&this.stamina>0){const x=20*e;this.stamina=Math.max(0,this.stamina-x),this.stamina<=0&&(this.isSprinting=!1)}else{const x=10*e;this.stamina=Math.min(100,this.stamina+x)}this.camera.position.copy(this.mesh.position);const p=this.isCrouching?1.6*this.crouchHeight:1.6;this.camera.position.y+=p;const m=this.isCrouching?this.crouchHeight:1;this.mesh.scale.y+=(m-this.mesh.scale.y)*10*e;let u=this.baseFov;const w=this.weapons[this.currentWeaponIndex];this.isAiming&&w&&w.zoomFov&&(u=w.zoomFov),Math.abs(this.camera.fov-u)>.1&&(this.camera.fov+=(u-this.camera.fov)*10*e,this.camera.updateProjectionMatrix());let E;this.cameraMode==="FPS"?E=this.fpsCameraOffset.clone():(E=this.tpsCameraOffset.clone(),E.applyQuaternion(this.camera.quaternion)),E.add(this.mesh.position),this.camera.position.copy(E),this.updateAnimations(e)}}findNearbyVehicle(){if(!this.worldObjects)return null;let e=null,t=4;return this.worldObjects.forEach(i=>{if(!i||!i.userData||i.userData.type!=="vehicle")return;const s=i.position.distanceTo(this.mesh.position);s<t&&(e=i,t=s)}),e}updateVehiclePrompt(){const e=this.vehiclePromptEl;if(!e)return;if(this.isInVehicle){e.innerText="Press E to exit vehicle",e.dataset.vehiclePrompt="1",e.classList.remove("hidden");return}const t=this.findNearbyVehicle();this.nearVehicle=t,t?(e.innerText="Press E to drive vehicle",e.dataset.vehiclePrompt="1",e.classList.remove("hidden")):e.dataset.vehiclePrompt==="1"&&(e.classList.add("hidden"),delete e.dataset.vehiclePrompt)}enterVehicle(e){if(!e||this.isInVehicle)return!1;e.userData||(e.userData={}),e.userData.hasFrontAligned||(e.rotation.y+=Math.PI,e.userData.hasFrontAligned=!0);const t=this.loadVehicleState(e);this.isInVehicle=!0,this.vehicleAccelHold=0,this.isSprinting=!1,this.vehicleTurbo=!1,this.currentVehicle=e,this.vehicleSpeed=0,this.currentSpeed=0;const i=e.userData&&e.userData.vehicleType||"car";return this.vehicleFuelCapacity=t?t.capacity:i==="truck"?60:40,this.vehicleFuel=t?t.fuel:this.vehicleFuelCapacity,this.vehicleDistance=t?t.distanceKm:0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=t?t.fuelUsed:0,this.vehicleEfficiencyKmPerL=i==="truck"?3.5:5.5,this.vehicleIdleLph=i==="truck"?1:.7,this.vehicleThrottleLph=i==="truck"?2.8:1.9,this._vehicleMaxSpeed=i==="truck"?80/3.6:null,this._vehicleTurboMaxSpeed=i==="truck"?100/3.6:null,this._vehicleStateCache=t||null,this.previousPosition.copy(e.position),this.stopFootsteps(),this.stopVehicleDriveSound(),this.playVehicleDoor(),this.mesh.visible=!1,this.velocity.set(0,0,0),this.mesh.position.copy(e.position),this.updateVehicleHUD(!0),!0}exitVehicle(){if(!this.currentVehicle){this.isInVehicle=!1;return}const e=this.currentVehicle;if(this.playVehicleDoor(),this.stopVehicleDriveSound(),this.stopFootsteps(),this.world&&typeof this.world.getHeightAt=="function"){const o=this.world.getHeightAt(e.position.x,e.position.z),n=this.getVehicleGroundClearance(e);e.position.y=o+n}const t=new T(-1.5,0,-2).applyEuler(e.rotation),i=e.position.clone().add(t);this.mesh.position.copy(i);const s=typeof this.getSurfaceHeight=="function"?this.getSurfaceHeight(i.x,i.z):this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(i.x,i.z):i.y;this.mesh.position.y=s,this.velocity.set(0,0,0),this.mesh.visible=!0,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.canJump=!0,this.previousPosition.copy(this.mesh.position),this.saveVehicleState(e),this.updateVehicleHUD(!1),this.vehiclePromptEl&&this.vehiclePromptEl.dataset.vehiclePrompt==="1"&&(this.vehiclePromptEl.classList.add("hidden"),delete this.vehiclePromptEl.dataset.vehiclePrompt)}getVehicleGroundClearance(e){if(!e)return .05;const t=e.userData||{};return typeof t.groundClearance=="number"?t.groundClearance:typeof t.wheelRadius=="number"&&typeof t.wheelCenterY=="number"?Math.max(0,t.wheelRadius-t.wheelCenterY):.05}updateVehicleDrive(e){const t=this.currentVehicle;if(!t){this.isInVehicle=!1;return}this.stopFootsteps();const i=t.position.clone();if(this.vehicleFuel<=0){this.vehicleSpeed=0,this.mesh.position.copy(t.position),this.previousPosition.copy(t.position),this.currentSpeed=0,this.updateVehicleHUD(!0);return}let s=0;this.moveForward&&(s+=1),this.moveBackward&&(s-=1),this.vehicleSpeed+=s*this.vehicleAccel*e,this.moveForward&&s>0?this.vehicleAccelHold=Math.min(1,this.vehicleAccelHold+e*.8):this.vehicleAccelHold=Math.max(0,this.vehicleAccelHold-e*.6);const o=this.vehicleTurbo&&s>0,n=o?vType==="truck"?1.25:1.6:1,a=o?vType==="truck"?1.15:1.35:1,l=(this.vehicleBaseMaxSpeed+this.vehicleBoostMax*this.vehicleAccelHold)*n,h=this.vehicleBaseMaxSpeed*.5;this.vehicleSpeed=Math.min(l,Math.max(-h,this.vehicleSpeed)),this.vehicleSpeed+=s*this.vehicleAccel*e*(a-1),this.vehicleSpeed*=Math.max(0,1-this.vehicleFriction*e),this._vehicleMaxSpeed&&!o?this.vehicleSpeed=Math.min(this._vehicleMaxSpeed,this.vehicleSpeed):this._vehicleTurboMaxSpeed&&o&&(this.vehicleSpeed=Math.min(this._vehicleTurboMaxSpeed,this.vehicleSpeed)),this.currentSpeed=Math.abs(this.vehicleSpeed);const r=s>0,c=this.vehicleSpeed>=0?1:-1;this.moveLeft&&(t.rotation.y+=this.vehicleTurnSpeed*e*c),this.moveRight&&(t.rotation.y-=this.vehicleTurnSpeed*e*c);const d=new T(0,0,1).applyEuler(t.rotation),p=t.position.clone().addScaledVector(d,this.vehicleSpeed*e);if(this.checkVehicleCollision(p,t)?this.vehicleSpeed*=.2:t.position.copy(p),this.world&&typeof this.world.getHeightAt=="function"){const D=this.world.getHeightAt(t.position.x,t.position.z),v=this.getVehicleGroundClearance(t);t.position.y=D+v}if(this.world&&typeof this.world.halfMapSize=="number"){const D=this.world.halfMapSize-1;t.position.x=Math.max(-D,Math.min(D,t.position.x)),t.position.z=Math.max(-D,Math.min(D,t.position.z))}if(this.previousPosition.length()>0){const D=t.position.distanceTo(this.previousPosition);this.distanceTraveled+=D}this.mesh.position.copy(t.position),this.previousPosition.copy(t.position);const m=t.position.distanceTo(i);this.rotateVehicleWheels(t,m,this.vehicleSpeed);let u=0;if(u+=this.vehicleIdleLph/3600*e,r&&(u+=this.vehicleThrottleLph/3600*e*(o?1.7:1)),m>0){const D=m/1e3;this.vehicleDistance+=D;const v=D/this.vehicleEfficiencyKmPerL,P=r?v*.35*(o?1.35:1):0;u+=v+P}if(this.vehicleFuelUsed+=u,this.vehicleFuel=Math.max(0,this.vehicleFuel-u),this.vehicleFuel<=0&&(this.vehicleSpeed=0),this.saveVehicleState(t),this.updateVehicleHUD(!0),this.enemyManager&&Array.isArray(this.enemyManager.enemies)){const D=performance.now();this.enemyManager.enemies.forEach(v=>{if(!v||!v.position)return;if(v.position.distanceTo(t.position)<2.4){v.userData||(v.userData={});const L=v.userData.lastRunOver||0;if(D-L>400){v.userData.lastRunOver=D;try{v.takeDamage(999)}catch{}}}})}const w=t.position.clone(),E=new T(0,2,6).applyQuaternion(this.camera.quaternion),x=w.clone().add(E);this.camera.position.lerp(x,.18);const k=Math.abs(this.vehicleSpeed)>.5;this.handleVehicleDriveSound(k)}rotateVehicleWheels(e,t,i){if(!e||!e.userData||!e.userData.wheels||!e.userData.wheels.length)return;const s=e.userData.wheelRadius||.35,o=t/s,n=i>=0?-1:1;e.userData.wheels.forEach(a=>{try{a.rotation.x+=n*o}catch{}})}updateVehicleHUD(e){if(!this.vehicleHud||!this.vehicleHud.root)return;const t=this.vehicleHud.root,i=document.getElementById("dashboard");if(i){const o=i.getBoundingClientRect();t.style.left=`${o.left}px`,t.style.top=`${o.top+o.height+8}px`,t.style.width=`${o.width}px`}if(!e){t.classList.add("hidden");return}t.classList.remove("hidden");const s=Math.abs(this.vehicleSpeed)*3.6;if(this.vehicleHud.speed&&(this.vehicleHud.speed.innerText=s.toFixed(0)),this.vehicleHud.fuelFill){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelFill.style.width=`${n}%`,this.vehicleHud.fuelFill.style.background=n<20?"linear-gradient(90deg, #ff7043, #ff3d00)":"linear-gradient(90deg, #8bc34a, #cddc39)"}if(this.vehicleHud.fuelText){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelText.innerText=`${this.vehicleFuel.toFixed(1)}L (${n.toFixed(1)}%)`}if(this.vehicleHud.distance&&(this.vehicleHud.distance.innerText=this.vehicleDistance.toFixed(2)),this.vehicleHud.efficiency){const o=this.vehicleFuelUsed>0&&this.vehicleDistance>0?this.vehicleDistance/this.vehicleFuelUsed:0;this.vehicleHud.efficiency.innerText=o.toFixed(2)}if(this.vehicleHud.range){const o=this.vehicleFuel*this.vehicleEfficiencyKmPerL;this.vehicleHud.range.innerText=o.toFixed(1)}}getVehicleStorageKey(e){return!e||!e.userData||!e.userData.gameId?null:`vehicle-state-${e.userData.gameId}`}loadVehicleState(e){try{if(e&&e.userData&&e.userData.vehicleState)return e.userData.vehicleState;const t=this.getVehicleStorageKey(e);if(!t||typeof localStorage>"u")return null;const i=localStorage.getItem(t);if(!i)return null;const s=JSON.parse(i);return e.userData.vehicleState=s,s}catch{return null}}saveVehicleState(e){if(!e)return;const t=this.getVehicleStorageKey(e);if(!t)return;const i={fuel:this.vehicleFuel,capacity:this.vehicleFuelCapacity,distanceKm:this.vehicleDistance,fuelUsed:this.vehicleFuelUsed,vehicleType:e.userData&&e.userData.vehicleType||"car"};e.userData.vehicleState=i;try{typeof localStorage<"u"&&localStorage.setItem(t,JSON.stringify(i))}catch{}}selectStudioObject(e){if(this.gameMode!=="studio"||!this.worldObjects||this.worldObjects.length===0)return null;const t=new X;this.controls&&this.controls.isLocked?t.set(0,0):e&&e.clientX!==void 0?(t.x=e.clientX/window.innerWidth*2-1,t.y=-(e.clientY/window.innerHeight)*2+1):t.set(0,0),this._studioRaycaster.setFromCamera(t,this.camera);const i=this.worldObjects.filter(n=>n&&n.userData&&n.userData.gameName!=="Ground"),s=this._studioRaycaster.intersectObjects(i,!0);if(!s.length)return this.clearStudioSelection(),null;let o=s[0].object;for(;o&&!this.worldObjects.includes(o);)o=o.parent;return o&&this.setStudioSelection(o),o}moveSelectedObject(e,t,i=0){if(!this.studioSelected)return;const s=this.studioSelected;s.position.x+=e,s.position.z+=t,s.position.y+=i,i===0&&this.world&&typeof this.world.getHeightAt=="function"&&(s.position.y=this.world.getHeightAt(s.position.x,s.position.z)),this.refreshStudioSelectionHelper()}clearStudioSelection(){if(this.studioSelected=null,this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}this.selectionInfo&&this.selectionInfo.classList.add("hidden")}removeSelectedObject(){if(!this.studioSelected)return;const e=this.studioSelected;this.clearStudioSelection();try{this.scene.remove(e)}catch{}if(this.worldObjects){const t=this.worldObjects.indexOf(e);t>=0&&this.worldObjects.splice(t,1)}}setStudioSelection(e){if(this.studioSelected=e,this.selectionInfo)if(e&&e.userData){const t=e.userData;this.selectionInfo.innerText=`${t.gameName||"Object"} (${t.gameId||"---"})`,this.selectionInfo.classList.remove("hidden")}else this.selectionInfo.classList.add("hidden");this.refreshStudioSelectionHelper()}refreshStudioSelectionHelper(){if(this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}if(this.studioSelected)try{const e=this.buildStudioSelectionBox(this.studioSelected);console.log("[DEBUG BOX] Creating Box3Helper with box:",e),this.studioSelectionHelper=new ct(e,16766720),this.studioSelectionHelper.material.depthTest=!1,this.studioSelectionHelper.material.transparent=!0,this.studioSelectionHelper.material.opacity=.9,this.scene.add(this.studioSelectionHelper),console.log("[DEBUG BOX] Box3Helper added to scene successfully")}catch(e){console.error("[DEBUG BOX] ERROR creating Box3Helper:",e),this.studioSelectionHelper=null}}buildStudioSelectionBox(e){var o,n;console.log("[DEBUG BOX] Building box for:",(o=e.userData)==null?void 0:o.gameName,"isNPC:",(n=e.userData)==null?void 0:n.isNPC);const t=new Ue;let i=0,s=0;return e.traverse(a=>{if(!a.isMesh||!a.geometry)return;i++;const l=a.userData||{},h=a.material;if(h&&h.transparent||l.isShadow||l.shadow){console.log("[DEBUG BOX] Skipping mesh (transparent or shadow):",a.name||"unnamed"),s++;return}if(!a.geometry.boundingBox)try{a.geometry.computeBoundingBox()}catch{}if(a.geometry.boundingBox){const c=a.geometry.boundingBox.clone();a.updateWorldMatrix(!0,!1),c.applyMatrix4(a.matrixWorld),t.union(c),console.log("[DEBUG BOX] Added mesh to box")}}),console.log("[DEBUG BOX] Processed:",i,"meshes, skipped:",s,"isEmpty:",t.isEmpty()),t.isEmpty()&&(console.log("[DEBUG BOX] Box is empty! Using fallback 1x1x1 box"),t.setFromCenterAndSize(e.position,new T(1,1,1))),t}checkVehicleCollision(e,t=null){if(!this.worldObjects)return!1;const i=2;for(let s=0;s<this.worldObjects.length;s++){const o=this.worldObjects[s];if(!o)continue;const n=o.userData||{};if(t&&o===t||n.gameName==="Ground"||n.type==="ground")continue;const a=o.position||(o.getWorldPosition?o.getWorldPosition(new T):null);if(!a)continue;const l=a.distanceTo(e);let h=1.5;if(o.geometry&&o.geometry.boundingSphere?h=o.geometry.boundingSphere.radius||h:n&&n.size==="large"?h=5:n.type==="vehicle"&&(h=2.5),l<i+h)return!0}return!1}updateAnimations(e){const t=this.moveForward||this.moveBackward||this.moveLeft||this.moveRight,i=10,s=this.isSprinting&&t?1.8:1;if(t){this.animTime+=e*i*s;const o=Math.sin(this.animTime)*(.5*s);this.leftLegPivot.rotation.x=o,this.rightLegPivot.rotation.x=-o}else this.leftLegPivot.rotation.x=U.lerp(this.leftLegPivot.rotation.x,0,e*i),this.rightLegPivot.rotation.x=U.lerp(this.rightLegPivot.rotation.x,0,e*i);if(this.isBlocking){const o=-Math.PI/2.5,n=.5;this.leftArmPivot.rotation.x=U.lerp(this.leftArmPivot.rotation.x,o,e*15),this.rightArmPivot.rotation.x=U.lerp(this.rightArmPivot.rotation.x,o,e*15),this.leftArmPivot.rotation.z=U.lerp(this.leftArmPivot.rotation.z,-n,e*15),this.rightArmPivot.rotation.z=U.lerp(this.rightArmPivot.rotation.z,n,e*15)}else if(this.isPunching){this.punchTime+=e*20;const o=-Math.PI/2+Math.sin(this.punchTime)*.8;this.punchSide===0?(this.rightArmPivot.rotation.x=o,this.leftArmPivot.rotation.x=U.lerp(this.leftArmPivot.rotation.x,0,e*10)):(this.leftArmPivot.rotation.x=o,this.rightArmPivot.rotation.x=U.lerp(this.rightArmPivot.rotation.x,0,e*10)),this.punchTime>Math.PI&&(this.isPunching=!1,this.rightArmPivot.rotation.x=0,this.leftArmPivot.rotation.x=0),this.leftArmPivot.rotation.z=U.lerp(this.leftArmPivot.rotation.z,0,e*10),this.rightArmPivot.rotation.z=U.lerp(this.rightArmPivot.rotation.z,0,e*10)}else{if(t){const o=Math.sin(this.animTime)*.5*s;this.leftArmPivot.rotation.x=-o,this.rightArmPivot.rotation.x=o}else this.leftArmPivot.rotation.x=U.lerp(this.leftArmPivot.rotation.x,0,e*10),this.rightArmPivot.rotation.x=U.lerp(this.rightArmPivot.rotation.x,0,e*10);this.leftArmPivot.rotation.z=U.lerp(this.leftArmPivot.rotation.z,0,e*10),this.rightArmPivot.rotation.z=U.lerp(this.rightArmPivot.rotation.z,0,e*10)}if(this.hitTimer>0){this.hitTimer-=e;const o=Math.max(0,this.hitTimer)/.6,n=U.lerp(-Math.PI/2.2,0,1-o);this.leftArmPivot.rotation.x=U.lerp(this.leftArmPivot.rotation.x,n,e*20),this.rightArmPivot.rotation.x=U.lerp(this.rightArmPivot.rotation.x,n,e*20)}}punch(){if(!this.isTired&&!(this.isPunching||this.isBlocking)&&(this.isPunching=!0,this.punchTime=0,this.punchSide=this.punchSide===0?1:0,this.punchCount++,this.punchCount>=20&&(this.isTired=!0,this.stamina=Math.max(0,this.stamina-20),setTimeout(()=>{this.isTired=!1,this.punchCount=0},3e3)),this.enemyManager&&this.enemyManager.enemies)){const e=new T;this.mesh.getWorldDirection(e);let t=!1;if(this.enemyManager.enemies.forEach(i=>{if(this.mesh.position.distanceTo(i.position)<3){const o=new T().subVectors(i.position,this.mesh.position).normalize();if(e.angleTo(o)<Math.PI/3){i.takeDamage(10);const a=e.clone().multiplyScalar(2);i.position.add(a),t=!0}}}),this.gameMode==="multiplayer"&&this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const i=Math.PI/3,s=3;this.multiplayerClient.others.forEach((o,n)=>{if(!o||!o.position||o.userData&&o.userData.dead||this.mesh.position.distanceTo(o.position)>s)return;const l=new T().subVectors(o.position,this.mesh.position).normalize();e.angleTo(l)<i&&(typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(n,10),t=!0)})}t&&this.playSmack()}}playSmack(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playSmack());return}if(this.smackBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.smackBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playSmack error:",e)}}equipBackpack(e=2899536){const t=this.backpackColor;this.backpack&&this.backpack.parent&&this.backpack.parent.remove(this.backpack);const i=new O;i.position.set(0,1.25,-.32);const s=new g(new b(.7,.9,.35),new S({color:e,metalness:.15,roughness:.8}));s.position.set(0,0,0),i.add(s);const o=new g(new b(.6,.25,.16),new S({color:3426654,metalness:.1,roughness:.8}));o.position.set(0,-.55,.22),i.add(o);const n=new S({color:2042938,metalness:.1,roughness:.9}),a=new g(new b(.1,.82,.07),n);a.position.set(-.28,-.03,.2);const l=a.clone();return l.position.x=.28,i.add(a,l),this.mesh.add(i),this.backpack=i,this.backpackColor=e,t}queueHurtBeat(){if(this._hurtAccumulator+=1,this._hurtAccumulator>=2){const e=Math.floor(this._hurtAccumulator/2);this._hurtQueue+=e,this._hurtAccumulator-=e*2}this._hurtQueue===0&&this._hurtAccumulator>0&&(this._hurtQueue=1,this._hurtAccumulator=0),this._hurtBeatTimer||this._playHurtBeatLoop()}_playHurtBeatLoop(){if(this._hurtQueue<=0){this._hurtBeatTimer=null;return}this.playHurt(),this._hurtQueue=Math.max(0,this._hurtQueue-1),this._hurtBeatTimer=setTimeout(()=>this._playHurtBeatLoop(),2e3)}clearHurtQueue(){this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer&&(clearTimeout(this._hurtBeatTimer),this._hurtBeatTimer=null)}playHurt(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playHurt());return}if(this.ughBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.ughBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playHurt error:",e)}}playVehicleDoor(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playVehicleDoor());return}if(this.vehicleDoorBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.vehicleDoorBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playVehicleDoor error:",e)}}handleVehicleDriveSound(e){try{if(!this.audioCtx||!this.enableVehicleDriveSound){this.stopVehicleDriveSound();return}if(!this.vehicleDriveBuffer){this.stopVehicleDriveSound();return}if(e===this._lastVehicleDriveActive&&(e&&this._vehicleDriveSource||!e&&!this._vehicleDriveSource))return;if(this._lastVehicleDriveActive=e,e){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._vehicleDriveSource)return;const t=this.audioCtx.createBufferSource();t.buffer=this.vehicleDriveBuffer,t.loop=!0;const i=this.audioCtx.createGain();i.gain.value=this.sfxVolume*.4,t.connect(i),i.connect(this.audioCtx.destination),t.start(0),this._vehicleDriveSource=t,this._vehicleDriveGain=i,t.onended=()=>{this._vehicleDriveSource=null,this._vehicleDriveGain=null}}else this.stopVehicleDriveSound()}catch(t){console.warn("handleVehicleDriveSound error:",t)}}stopVehicleDriveSound(){if(this._lastVehicleDriveActive=!1,this._vehicleDriveSource){try{this._vehicleDriveSource.stop()}catch{}try{this._vehicleDriveSource.disconnect()}catch{}}if(this._vehicleDriveGain)try{this._vehicleDriveGain.disconnect()}catch{}this._vehicleDriveSource=null,this._vehicleDriveGain=null}handleFootsteps(e){try{if(this.isInVehicle){this.stopFootsteps();return}if(!this.audioCtx||!this.footstepsBuffer){this.stopFootsteps();return}if(e===this._lastFootstepsActive&&(e&&this._footstepsSource||!e&&!this._footstepsSource)){if(e&&this._footstepsSource){const t=this.isSprinting?1.4:this.isCrouching?.8:1;this._footstepsSource.playbackRate.value=t}return}if(this._lastFootstepsActive=e,e){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._footstepsSource){try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}const t=this.audioCtx.createBufferSource();t.buffer=this.footstepsBuffer,t.loop=!0,t.playbackRate.value=this.isSprinting?1.4:this.isCrouching?.8:1;const i=this.audioCtx.createGain();i.gain.value=this.sfxVolume*.35,t.connect(i),i.connect(this.audioCtx.destination),t.start(0),this._footstepsSource=t,this._footstepsGain=i,t.onended=()=>{this._footstepsSource=null,this._footstepsGain=null}}else this.stopFootsteps()}catch(t){console.warn("handleFootsteps error:",t)}}stopFootsteps(){if(this._lastFootstepsActive=!1,this._footstepsSource){try{this._footstepsSource.onended=null}catch{}try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}get position(){return this.mesh.position}getSurfaceHeight(e,t){let i=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(e,t):0;return(this.world&&this.world.objects?this.world.objects:[]).forEach(o=>{if(!(!o||!o.userData)){if(o.userData.type==="block"){const n=o.userData.size||this.blockSize;if(Math.abs(o.position.x-e)<n*.6&&Math.abs(o.position.z-t)<n*.6){const a=o.position.y+n/2;a>i&&(i=a)}}if(o.userData.colliderBox){const n=o.userData.colliderBox;e>=n.min.x&&e<=n.max.x&&t>=n.min.z&&t<=n.max.z&&n.max.y>i&&(i=n.max.y)}}}),i}adjustBlockSize(e){const t=Math.max(this.minBlockSize,Math.min(this.maxBlockSize,this.blockSize+e));this.blockSize=t,console.log("Block size:",this.blockSize.toFixed(2))}moveLastBlock(){if(!this.placedBlocks.length)return;const e=this.placedBlocks[this.placedBlocks.length-1];if(!e)return;const t=this.getBlockTarget(e);e.position.set(t.position.x,t.position.y,t.position.z)}getBlockTarget(e=null){const t=e&&e.userData&&e.userData.size?e.userData.size:this.blockSize,i=new $;i.setFromCamera(new X(0,0),this.camera);const s=c=>Math.round(c);let o=null;if(this.world&&Array.isArray(this.world.objects)){const c=this.world.objects.filter(p=>p&&p.userData&&(p.userData.type==="block"||p.userData.gameName==="Ground")),d=i.intersectObjects(c,!0);d.length>0&&(o=d[0].point.clone())}if(!o){const c=new T;this.camera.getWorldDirection(c),o=this.mesh.position.clone().add(c.multiplyScalar(1.2))}const n=new T(s(o.x),o.y,s(o.z));if(this.world&&typeof this.world.halfMapSize=="number"){const c=this.world.halfMapSize-1;n.x=Math.max(-c,Math.min(c,n.x)),n.z=Math.max(-c,Math.min(c,n.z))}let a=this.world.getHeightAt?this.world.getHeightAt(n.x,n.z):o.y;const h=(this.world.objects||[]).filter(c=>c.userData&&c.userData.type==="block"&&c!==e).filter(c=>Math.abs(c.position.x-n.x)<.1&&Math.abs(c.position.z-n.z)<.1);h.length>0&&(a=Math.max(...h.map(d=>d.position.y+(d.userData&&d.userData.size?d.userData.size/2:t/2))));const r=a+t/2;return{position:new T(n.x,r,n.z),size:t}}updateBlockPreview(){if(!this.previewBlock)return;const e=this.getBlockTarget();this.previewBlock.visible=!0,this.previewBlock.position.copy(e.position);const t=e.size/this.blockSize;this.previewBlock.scale.set(t,t,t)}removeLastBlock(){if(!this.placedBlocks.length)return;const e=this.placedBlocks.pop();e&&e.parent&&e.parent.remove(e),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(t=>t!==e)),e&&e.geometry&&e.geometry.dispose(),e&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),this.selectedBlock===e&&this.clearBlockSelection()}selectBlockUnderCrosshair(){if(!this.world||!this.world.objects)return!1;const e=new $;e.setFromCamera(new X(0,0),this.camera);const t=e.intersectObjects(this.world.objects,!0);if(t.length===0)return this.clearBlockSelection(),!1;let i=null;for(const s of t){let o=s.object;for(;o&&o.parent;){if(o.userData&&o.userData.type==="block"){i=o;break}o=o.parent}if(i)break}return i?(this.setBlockSelection(i),!0):(this.clearBlockSelection(),!1)}setBlockSelection(e){this.clearBlockSelection(),this.selectedBlock=e;const t=new dt(e,16776960);t.userData={ignoreSelect:!0},this.scene.add(t),this.selectedBlockHelper=t}clearBlockSelection(){this.selectedBlock=null,this.selectedBlockHelper&&(this.scene.remove(this.selectedBlockHelper),this.selectedBlockHelper.material&&this.selectedBlockHelper.material.dispose(),this.selectedBlockHelper.geometry&&this.selectedBlockHelper.geometry.dispose(),this.selectedBlockHelper=null)}removeBlock(e){e&&(this.placedBlocks=this.placedBlocks.filter(t=>t!==e),e.parent&&e.parent.remove(e),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(t=>t!==e)),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),this.selectedBlock===e&&this.clearBlockSelection())}takeDamage(e){this.gameMode==="matrix"||this.gameMode==="studio"||this.multiplayerClient&&!this.multiplayerClient.isMatchLive()||(this.isBlocking&&(e*=.2,console.log("Blocked! Reduced damage to "+e)),this.shield>0?(this.shield-=e,this.shield<0&&(this.health+=this.shield,this.shield=0)):this.health-=e,e>0&&this.queueHurtBeat(),this.health<=0&&(this.health=0,this.die()),this.hitTimer=.6)}die(){this.gameMode==="matrix"||this.gameMode==="studio"||(this.handleFootsteps(!1),this.isDead=!0,this.controls.unlock(),this.mesh.rotation.x=-Math.PI/2,this.multiplayerClient&&typeof this.multiplayerClient.sendDeath=="function"&&this.multiplayerClient.sendDeath(),this.moveForward=this.moveBackward=this.moveLeft=this.moveRight=!1,this.velocity.set(0,0,0),this.hud&&typeof this.hud.showGameOver=="function"&&this.hud.showGameOver("YOU DIED"))}checkCollision(e,t){const i=new $,s=.5,o=[1.6,1,.35];let n=this.worldObjects||[];if(this.enemyManager&&this.enemyManager.enemies){const h=this.enemyManager.enemies.map(r=>r.mesh);n=n.concat(h)}const a=1.5,l=h=>{let r=h;for(;r;){if(r.userData&&r.userData.colliderBox)return r.userData.colliderBox;r=r.parent}return null};for(const h of o){const r=this.mesh.position.clone();if(r.y+=h,i.set(r,e),n.length>0){const c=i.intersectObjects(n,!0);if(c.length>0){const d=c[0];if(d.distance<t+s){const p=l(d.object);if(p){const m=p.max.y,u=m-this.mesh.position.y;if(u<=a&&u>-.5)return this.mesh.position.y=m,this.velocity.y=0,this.canJump=!0,!1}return!0}}}}return!1}}const Qt="/threejs-voxel-firecraft/dist/assets/mixkit-player-losing-or-failing-vCPqUTFf.ogg",ei="/threejs-voxel-firecraft/dist/assets/game-level-completed-envato-mixkit.co-OEgWp6-U.ogg";class ti{constructor(e,t,i){this.player=e,this.world=t,this.settings=i||{},this.healthBar=document.getElementById("health-bar"),this.healthText=document.getElementById("health-text"),this.shieldBar=document.getElementById("shield-bar"),this.shieldText=document.getElementById("shield-text"),this.staminaBar=document.getElementById("stamina-bar"),this.staminaText=document.getElementById("stamina-text"),this.weaponName=document.getElementById("weapon-name"),this.ammoCount=document.getElementById("ammo-count"),this.slots=document.querySelectorAll(".slot"),this.timerValue=document.getElementById("timer-value"),this.debugContainer=document.getElementById("debug-container"),this.gameOverScreen=document.getElementById("game-over-screen"),this.selectionInfo=document.getElementById("selection-info"),this.selectionInfoTimeout=null,this.hotbar=document.getElementById("hotbar"),this.fpsCounter=document.getElementById("fps-counter"),this.enemyCount=document.getElementById("enemy-count"),this.killCount=document.getElementById("kill-count"),this.dropCount=document.getElementById("drop-count"),this.distanceTraveled=document.getElementById("distance-traveled"),this.playerSpeed=document.getElementById("player-speed"),this.mapSizeText=document.getElementById("map-size-readout"),this.memoryUsage=document.getElementById("memory-usage"),this.targetInspect=document.getElementById("target-inspect"),this.perfFrame=document.getElementById("perf-frame"),this.perfCalls=document.getElementById("perf-calls"),this.perfTris=document.getElementById("perf-tris"),this.perfGeoms=document.getElementById("perf-geoms"),this.perfTextures=document.getElementById("perf-textures"),this.perfPrograms=document.getElementById("perf-programs"),this.perfObjects=document.getElementById("perf-objects"),this.perfMem=document.getElementById("perf-mem"),this.perfCpu=document.getElementById("perf-cpu"),this.perfGpu=document.getElementById("perf-gpu"),this.perfGpuMem=document.getElementById("perf-gpu-mem"),this.dashboardEl=document.getElementById("dashboard"),this.perfEl=document.getElementById("perf-dashboard"),this.netStatsText=document.getElementById("net-stats"),this.netChart=document.getElementById("net-chart"),this.netChartCtx=this.netChart?this.netChart.getContext("2d"):null,this._renderer=null,this.frameTimeAvg=0,this.gpuInfo=null,this.gpuMemInfo=null,this._gl=null,this.debugInfo=document.getElementById("debug-info"),this.debugName=document.getElementById("debug-target-name"),this.debugId=document.getElementById("debug-target-id"),this.settings.debugMode?this.debugInfo.style.display="block":this.debugInfo.style.display="none",this.timeRemaining=30,this.lastTime=performance.now(),this.frames=0,this.fps=0,this.lastFpsTime=performance.now(),this.lastFrameTime=performance.now(),this.raycaster=new $,this.mouse=new X,this.hoveredEnemy=null,this.hoveredPlayer=null,this.currentOutlinedEnemy=null,this.hoverInfo=document.getElementById("hover-info"),this.scopeOverlay=document.getElementById("scope-overlay"),this.minimapContainer=document.getElementById("minimap"),this.minimapCanvas=document.getElementById("minimap-canvas"),this.minimapCtx=this.minimapCanvas?this.minimapCanvas.getContext("2d"):null,this.minimapSize=this.minimapCanvas?this.minimapCanvas.width:180,this.mapSize=t&&t.mapSize?t.mapSize:200,this.multiplayer=null,window.addEventListener("mousemove",s=>{const o=s.clientX/window.innerWidth*2-1,n=-(s.clientY/window.innerHeight)*2+1;if(this.mouse.set(o,n),this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const a=[];this.player.enemyManager.enemies.forEach(h=>{h.mesh.traverse(r=>{r.isMesh&&a.push(r)})}),this.raycaster.setFromCamera(this.mouse,this.player.camera);const l=this.raycaster.intersectObjects(a,!0);if(l.length>0){const h=l[0].object;let r=h,c=null;for(;r&&(c=this.player.enemyManager.enemies.find(d=>r.parent===d.mesh||r===d.mesh||d.mesh.children.includes(r)),!c);)r=r.parent;this.hoveredEnemy=c||h||null}else this.hoveredEnemy=null}});try{this.slots.forEach((s,o)=>{const n=a=>{try{a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),this.player&&typeof this.player.switchWeapon=="function"&&this.player.switchWeapon(o)}catch{}};s.addEventListener("pointerdown",n),s.addEventListener("touchstart",n,{passive:!1}),s.addEventListener("click",n)})}catch{}}update(){var l,h;if(this.hoveredEnemy=null,this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0&&this.currentOutlinedEnemy!==this.hoveredEnemy){if(this.currentOutlinedEnemy&&this.currentOutlinedEnemy._outline){try{this.currentOutlinedEnemy.mesh.remove(this.currentOutlinedEnemy._outline)}catch{}this.currentOutlinedEnemy._outline=null}if(this.hoveredEnemy&&this.hoveredEnemy.mesh){const r=new O;this.hoveredEnemy.mesh.traverse(c=>{if(c.isMesh){const d=new g(c.geometry,new Me({color:16776960,side:ut}));d.position.copy(c.position),d.quaternion.copy(c.quaternion),d.scale.copy(c.scale).multiplyScalar(1.06),d.renderOrder=999,d.material.depthTest=!0,r.add(d)}}),this.hoveredEnemy.mesh.add(r),this.hoveredEnemy._outline=r}this.currentOutlinedEnemy=this.hoveredEnemy}this.frames++;const e=performance.now();e-this.lastFpsTime>=1e3&&(this.fpsCounter.innerText=this.frames,this.frames=0,this.lastFpsTime=e,performance.memory&&this.memoryUsage&&(this.memoryUsage.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)));const t=e-this.lastFrameTime;if(this.lastFrameTime=e,this.frameTimeAvg=this.frameTimeAvg===0?t:this.frameTimeAvg*.9+t*.1,this.player.enemyManager&&(this.enemyCount.innerText=this.player.enemyManager.enemies.length,this.killCount.innerText=this.player.enemyManager.killedCount||0),this.dropCount){const r=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;if(r&&Array.isArray(r.items)){const c=r.items.filter(d=>!(d.userData&&d.userData.isOpened)).length;this.dropCount.innerText=c}else this.dropCount.innerText="0"}const i=(this.player.distanceTraveled/1e3).toFixed(2);if(this.distanceTraveled&&(this.distanceTraveled.innerText=i),this.playerSpeed){let r=0;this.player.isInVehicle&&typeof this.player.currentSpeed=="number"?r=this.player.currentSpeed*3.6:typeof this.player.currentSpeed=="number"&&(r=this.player.currentSpeed*3.6),this.playerSpeed.innerText=r.toFixed(1)}if(this.mapSizeText){const r=this.world&&this.world.mapSize?this.world.mapSize:this.mapSize;this.mapSizeText.innerText=Math.round(r)}if(this._renderer){if(this.isPerfCollapsed())return;const r=this._renderer.info;this.perfFrame&&(this.perfFrame.innerText=t.toFixed(1)),this.perfCalls&&(this.perfCalls.innerText=r.render.calls),this.perfTris&&(this.perfTris.innerText=r.render.triangles),this.perfGeoms&&(this.perfGeoms.innerText=r.memory.geometries),this.perfTextures&&(this.perfTextures.innerText=r.memory.textures),this.perfPrograms&&(this.perfPrograms.innerText=r.programs?r.programs.length:"0");let c=0;this.world&&Array.isArray(this.world.objects)&&(c+=this.world.objects.length);const d=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;d&&Array.isArray(d.items)&&(c+=d.items.length),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&(c+=this.player.enemyManager.enemies.length),this.perfObjects&&(this.perfObjects.innerText=c),this.perfMem&&performance.memory&&(this.perfMem.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)),this.perfCpu&&(this.perfCpu.innerText=`${this.frameTimeAvg.toFixed(1)} ms`),this.perfGpu&&(this.perfGpu.innerText=this.gpuInfo||"Unsupported"),this.updateGpuMemory()}this.updateNetPanel(),this.healthBar.style.width=`${this.player.health}%`,this.healthText.innerText=Math.ceil(this.player.health),this.shieldBar.style.width=`${this.player.shield}%`,this.shieldText.innerText=Math.ceil(this.player.shield),this.staminaBar.style.width=`${this.player.stamina}%`,this.staminaText.innerText=Math.ceil(this.player.stamina);const s=this.player.weapons[this.player.currentWeaponIndex];if(this.weaponName.innerText=s.name,this.player.isReloading?this.ammoCount.innerText="RELOADING...":this.ammoCount.innerText=s.ammo===1/0?"":`${s.currentMag} / ${s.ammo}`,this.debugContainer&&(this.debugContainer.innerHTML=""),this.debugInfo)if(this.settings.debugMode)if(this.debugInfo.style.display="block",this.hoveredEnemy){const r=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,c=r&&r.userData&&r.userData.gameName?r.userData.gameName:"Enemy",d=r&&r.userData&&(r.userData.gameId||r.userData.gameid)?r.userData.gameId||r.userData.gameid:"---",p=this.hoveredEnemy.position?this.hoveredEnemy.position:r?r.position:null,m=p?this.player.position.distanceTo(p).toFixed(2):"---";this.debugName.innerText=c,this.debugId.innerText=`${d} (${m}m)`}else this.debugName.innerText="None",this.debugId.innerText="---";else this.debugInfo.style.display="none";let o=null;if(this.hoveredPlayer=null,!this.hoveredEnemy&&this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const r=[];if(this.player.enemyManager.enemies.forEach(c=>{c.mesh.traverse(d=>{d.isMesh&&r.push(d)})}),r.length>0){this.raycaster.setFromCamera(new X(0,0),this.player.camera);const c=this.raycaster.intersectObjects(r,!0);if(c.length>0){let p=c[0].object,m=null;for(;p&&(m=this.player.enemyManager.enemies.find(u=>p.parent===u.mesh||p===u.mesh||u.mesh.children.includes(p)),!m);)p=p.parent;m?this.hoveredEnemy=m:this.hoveredEnemy=null}else this.hoveredEnemy=null}}if(!this.hoveredEnemy&&this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0){const r=[];if(this.multiplayer.others.forEach(c=>{c&&(c.isMesh?r.push(c):c.traverse&&c.traverse(d=>{d.isMesh&&r.push(d)}))}),r.length>0){this.raycaster.setFromCamera(new X(0,0),this.player.camera);const c=this.raycaster.intersectObjects(r,!0);if(c.length>0){let d=c[0].object;for(;d.parent&&!((l=d.userData)!=null&&l.nick)&&!this.multiplayer.others.has((h=d.userData)==null?void 0:h.gameId);)d=d.parent;this.hoveredPlayer=d}}}if(this.hoverInfo)if(this.hoveredEnemy){const r=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,c=r&&r.userData&&(r.userData.gameId||r.userData.gameid)?r.userData.gameId||r.userData.gameid:"---",d=this.hoveredEnemy.position?this.hoveredEnemy.position:r?r.position:null;o=d?this.player.position.distanceTo(d):null;const p=o?o.toFixed(2):"---";this.hoverInfo.innerText=`${c}  ${p}m`}else if(this.hoveredPlayer){const r=this.hoveredPlayer.userData&&this.hoveredPlayer.userData.nick?this.hoveredPlayer.userData.nick:"Player";let c=null;this.hoveredPlayer.getWorldPosition?(c=new T,this.hoveredPlayer.getWorldPosition(c)):c=this.hoveredPlayer.position||null,o=c?this.player.position.distanceTo(c):null;const d=o?o.toFixed(2):"---";this.hoverInfo.innerText=`${r}  ${d}m`}else this.hoverInfo.innerText="";if(this.scopeOverlay){const r=this.player.weapons&&this.player.weapons[this.player.currentWeaponIndex],c=this.player.isAiming&&r&&r.name==="Sniper";this.scopeOverlay.classList.toggle("hidden",!c);const d=document.getElementById("crosshair");d&&d.classList.toggle("hidden",c)}const n=document.getElementById("crosshair");if(n){n.classList.remove("target-red","target-yellow");const r=this.player.weapons&&this.player.weapons[this.player.currentWeaponIndex],c=r&&r.range?r.range:1e3;this.hoveredEnemy&&o!==null&&(o<=c?n.classList.add("target-red"):n.classList.add("target-yellow"))}this.updateMinimap(),this.slots.forEach(r=>r.style.display="none"),this.player.weapons.forEach((r,c)=>{let d=this.slots[c];d&&(d.style.display="flex",d.innerText=c+1,c===this.player.currentWeaponIndex?d.classList.add("active"):d.classList.remove("active"))});const a=performance.now();if(a-this.lastTime>1e3){this.timeRemaining--,this.timeRemaining<0&&(this.timeRemaining=0);const r=Math.floor(this.timeRemaining/60).toString().padStart(2,"0"),c=(this.timeRemaining%60).toString().padStart(2,"0");this.timerValue.innerText=`${r}:${c}`,this.lastTime=a}this.player.isDead&&this.player.gameMode!=="matrix"&&this.showGameOver("YOU DIED"),this.updateTargetInspect()}showSelectionInfo(e,t){if(!this.selectionInfo)return;const i=e||"Object",s=t||"---";this.selectionInfo.innerText=`${i} (${s})`,this.selectionInfo.classList.remove("hidden"),this.selectionInfoTimeout&&clearTimeout(this.selectionInfoTimeout),this.selectionInfoTimeout=setTimeout(()=>{try{this.selectionInfo.classList.add("hidden")}catch{}},2500)}updateTargetInspect(){if(!this.targetInspect||!this.player||!this.player.camera)return;const e=this.raycaster,t=new X(0,0);e.setFromCamera(t,this.player.camera);const i=[];if(this.world&&Array.isArray(this.world.objects)&&i.push(...this.world.objects),this.world&&this.world.itemManager&&Array.isArray(this.world.itemManager.items)&&i.push(...this.world.itemManager.items),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&this.player.enemyManager.enemies.forEach(r=>{r&&r.mesh&&i.push(r.mesh)}),i.length===0){this.targetInspect.innerText="Target: ---";return}const s=Array.from(new Set(i)),o=e.intersectObjects(s,!0);if(!o.length){this.targetInspect.innerText="Target: ---";return}let n=null;for(let r=0;r<o.length;r++){let c=o[r].object;for(;c;){if(c.userData&&(c.userData.gameName||c.userData.type||c.userData.gameId||c.userData.gameid)){n=c.userData;break}c=c.parent}if(n)break}if(!n){this.targetInspect.innerText="Target: ---";return}const a=n.gameName||"Object",l=n.gameId||n.gameid||"---",h=n.type||"---";this.targetInspect.innerText=`Target: ${a} (ID: ${l}) [${h}]`}showGameOver(e){if(this.player&&this.player.gameMode==="matrix"||this.gameOverShown)return;this.gameOverShown=!0,this.gameOverScreen.classList.remove("hidden"),document.getElementById("game-over-title").innerText=e;try{const i=document.getElementById("touch-controls");i&&(i.style.display="none")}catch{}this.hotbar&&(this.hotbar.style.display="none");const t=document.getElementById("restart-btn");t.onclick=()=>{location.reload()},t.style.pointerEvents="auto",t.style.cursor="pointer";try{typeof window<"u"&&window.game&&e&&e.toUpperCase().includes("DIED")&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(Qt)}catch{}}showVictory(){if(!(this.player&&this.player.gameMode==="matrix")){this.gameOverShown=!1,this.showGameOver("VICTORY ROYALE!"),document.getElementById("game-over-title").style.color="#f1c40f";try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}try{const e=document.getElementById("touch-controls");e&&(e.style.display="none")}catch{}try{this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch{}try{typeof window<"u"&&window.game&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(ei)}catch{}}}updateMinimap(){if(!this.minimapContainer)return;const e=this.settings.showMinimap!==!1;if(this.minimapContainer.classList.toggle("hidden",!e),!e||!this.minimapCtx||!this.player)return;const t=this.minimapCtx,i=this.minimapSize;t.clearRect(0,0,i,i),t.fillStyle="rgba(10, 12, 20, 0.75)",t.fillRect(0,0,i,i),t.strokeStyle="rgba(255, 255, 255, 0.25)",t.lineWidth=2,t.strokeRect(1,1,i-2,i-2);const s=Math.max(1,this.world&&this.world.halfMapSize?this.world.halfMapSize:this.mapSize/2),o=i*.45,n=i/2,a=i/2;if(this.world&&typeof this.world.stormRadius=="number"&&this.world.stormRadius>0){const d=Math.max(0,Math.min(1.2,this.world.stormRadius/s)),p=o*d;t.beginPath(),t.strokeStyle="rgba(157, 77, 187, 0.85)",t.lineWidth=3,t.arc(n,a,p,0,Math.PI*2),t.stroke()}const l=this.player&&this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)?this.player.enemyManager.enemies:[];l.length&&(t.fillStyle="#ff3b30",t.strokeStyle="#660000",t.lineWidth=1.5,l.forEach(d=>{if(!d)return;const p=d.position||d.mesh&&d.mesh.position;if(!p)return;const m=Math.max(n-o,Math.min(n+o,n+p.x/s*o)),u=Math.max(a-o,Math.min(a+o,a-p.z/s*o));t.beginPath(),t.arc(m,u,4,0,Math.PI*2),t.fill(),t.stroke()}));const h=this.world&&Array.isArray(this.world.objects)?this.world.objects.filter(d=>d&&d.userData&&d.userData.type==="house"):[];h.length&&(t.fillStyle="#ffd166",t.strokeStyle="#8c5a00",t.lineWidth=1,h.forEach(d=>{const p=d.position;if(!p)return;const m=Math.max(n-o,Math.min(n+o,n+p.x/s*o)),u=Math.max(a-o,Math.min(a+o,a-p.z/s*o));t.beginPath(),t.arc(m,u,3,0,Math.PI*2),t.fill(),t.stroke()}));const r=Math.max(n-o,Math.min(n+o,n+this.player.position.x/s*o)),c=Math.max(a-o,Math.min(a+o,a-this.player.position.z/s*o));t.beginPath(),t.fillStyle="#00d8ff",t.strokeStyle="#ffffff",t.lineWidth=2,t.arc(r,c,6,0,Math.PI*2),t.fill(),t.stroke(),this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach(d=>{if(!d||!d.position)return;const p=Math.max(n-o,Math.min(n+o,n+d.position.x/s*o)),m=Math.max(a-o,Math.min(a+o,a-d.position.z/s*o)),u=d.userData&&d.userData.color?d.userData.color:"#ffaa00";t.beginPath(),t.fillStyle=u,t.strokeStyle="#111",t.lineWidth=2,t.arc(p,m,5,0,Math.PI*2),t.fill(),t.stroke()});try{const d=new T;if(this.player&&this.player.camera&&this.player.camera.getWorldDirection&&this.player.camera.getWorldDirection(d),d.y=0,d.lengthSq()<1e-4&&this.player.mesh&&(d.set(0,0,-1).applyEuler(this.player.mesh.rotation),d.y=0),d.lengthSq()>1e-4){d.normalize();const p=d.x,m=-d.z,u=Math.atan2(m,p)+Math.PI/2;t.save(),t.translate(r,c),t.rotate(u),t.beginPath(),t.moveTo(0,-10),t.lineTo(6,8),t.lineTo(-6,8),t.closePath(),t.fillStyle="#00d8ff",t.strokeStyle="#003f4f",t.lineWidth=2,t.fill(),t.stroke(),t.restore()}}catch{}}updateNetPanel(){if(this.isPerfCollapsed()||!this.netStatsText&&!this.netChartCtx)return;const e=this.multiplayer&&typeof this.multiplayer.getNetStats=="function"?this.multiplayer.getNetStats():null;if(!e){this.netStatsText&&(this.netStatsText.innerText="offline"),this.netChartCtx&&this.netChartCtx.clearRect(0,0,this.netChart.width,this.netChart.height);return}const t=(e.txPerSec||0)/1024,i=(e.rxPerSec||0)/1024,s=typeof e.lastPing=="number"?`${Math.max(0,e.lastPing).toFixed(0)} ms`:"--";if(this.netStatsText&&(this.netStatsText.innerText=` ${t.toFixed(1)} kbps  ${i.toFixed(1)} kbps  ping ${s}`),!this.netChartCtx||!this.netChart)return;const o=this.netChartCtx,n=this.netChart.width,a=this.netChart.height,l=Array.isArray(e.history)?e.history:[];if(o.clearRect(0,0,n,a),!l.length)return;const h=l.reduce((u,w)=>Math.max(u,Math.max(w.tx||0,w.rx||0)/1024),1),r=2,c=l.length,d=u=>c<=1?r:r+u/(c-1)*(n-r*2),p=u=>{const w=Math.max(0,Math.min(1,u/1024/h));return a-r-w*(a-r*2)};o.strokeStyle="rgba(255,255,255,0.12)",o.beginPath(),o.moveTo(r,a-r),o.lineTo(n-r,a-r),o.stroke();const m=(u,w)=>{o.strokeStyle=u,o.beginPath(),l.forEach((E,x)=>{const k=d(x),D=p(w(E)||0);x===0?o.moveTo(k,D):o.lineTo(k,D)}),o.stroke()};m("rgba(0, 210, 255, 0.85)",u=>u.rx||0),m("rgba(255, 150, 50, 0.85)",u=>u.tx||0)}updateGpuMemory(){if(!this.perfGpuMem)return;if(!this.gpuMemInfo||!this._gl){if(performance.memory){const s=(performance.memory.usedJSHeapSize/1048576).toFixed(1),o=(performance.memory.jsHeapSizeLimit/1048576).toFixed(0);this.perfGpuMem.innerText=`${s} / ${o} MB (heap)`}else this.perfGpuMem.innerText="Unsupported";return}const e=performance.now();if(!this.gpuMemInfo.lastUpdate||e-this.gpuMemInfo.lastUpdate>1e3)try{const s=this._gl.getParameter(this.gpuMemInfo.ext.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX);this.gpuMemInfo.lastAvailKb=s||this.gpuMemInfo.lastAvailKb,this.gpuMemInfo.lastUpdate=e}catch{}const t=this.gpuMemInfo.totalKb?this.gpuMemInfo.totalKb/1024:null,i=this.gpuMemInfo.lastAvailKb?this.gpuMemInfo.lastAvailKb/1024:null;if(t&&i){const s=Math.max(0,t-i);this.perfGpuMem.innerText=`${s.toFixed(1)} / ${t.toFixed(1)} MB`}else i?this.perfGpuMem.innerText=`${i.toFixed(1)} MB free`:this.perfGpuMem.innerText="Unknown"}initGpuInfo(){if(!(!this._renderer||this.gpuInfo))try{const e=this._renderer.getContext();this._gl=e;const t=e.getExtension("WEBGL_debug_renderer_info"),i=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):e.getParameter(e.RENDERER);this.gpuInfo=i||"Unknown GPU";const s=e.getExtension("WEBGL_gpu_memory_info");if(s){const o=e.getParameter(s.GPU_MEMORY_INFO_TOTAL_AVAILABLE_MEMORY_KB)||e.getParameter(s.GPU_MEMORY_INFO_DEDICATED_VIDMEM_NVX)||null,n=e.getParameter(s.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX)||null;this.gpuMemInfo={ext:s,totalKb:o,lastAvailKb:n,lastUpdate:0}}}catch{this.gpuInfo="Unknown GPU"}}setRenderer(e){this._renderer=e,this.initGpuInfo()}setMultiplayer(e){this.multiplayer=e}isPerfCollapsed(){return this.perfEl&&this.perfEl.classList.contains("collapsed")}}const ii="/threejs-voxel-firecraft/dist/assets/mixkit-kill-blood-zombie-By90BKfb.ogg",si="/threejs-voxel-firecraft/dist/assets/zombie-B8PCKsyJ.ogg";class oi{constructor(e,t,i,s){this.scene=e,this.player=t,this.world=i,this.enemies=[],this.spawnInterval=5e3,this.lastSpawn=0,this.killedCount=0,this.groanBuffer=null;const o=s&&(s.gameMode==="matrix"||s.gameMode==="studio"||s.gameMode==="matrix-ai")?0:s?s.enemyCount:15;this.targetCount=o,this.difficulty=s?s.difficulty:"medium",this.gameMode=s&&s.gameMode?s.gameMode:"arcade",this.studioAiEnabled=!1;for(let n=0;n<o;n++)this.spawnEnemy();this.deathBuffer=null;try{const n=window.AudioContext||window.webkitAudioContext;n&&(this.audioCtx=new n,fetch(ii).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.deathBuffer=a,this.enemies.forEach(l=>{l.audioCtx=this.audioCtx,l.deathBuffer=a})}).catch(a=>{}),fetch(si).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.groanBuffer=a,this.enemies.forEach(l=>{l.audioCtx=this.audioCtx,l.groanBuffer=a})}).catch(a=>{}))}catch{}}spawnEnemy(e=!1,t=null){if(!e&&(this.gameMode==="matrix"||this.gameMode==="studio"))return;const i=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let s=(Math.random()-.5)*i,o=(Math.random()-.5)*i;if(this.gameMode==="studio"&&this.player&&(s=this.player.position.x+(Math.random()-.5)*5,o=this.player.position.z+(Math.random()-.5)*5),this.gameMode==="matrix-ai"&&this.player){const c=(this.world&&this.world.halfMapSize?this.world.halfMapSize:100)*.6;let d=0;for(;d<10;){const p=this.player.position.x,m=this.player.position.z,u=s-p,w=o-m;if(Math.sqrt(u*u+w*w)>=c)break;s=(Math.random()-.5)*i,o=(Math.random()-.5)*i,d++}}const n=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(s,o):0,a=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let l=!1,h=t||"normal";if(t)h==="big"&&(l=!0);else if(this.gameMode==="survival"){const c=this.enemies.filter(u=>u.isBig).length,d=this.enemies.filter(u=>u.zombieType==="slender").length,p=Math.floor(this.targetCount/5),m=Math.floor(this.targetCount/10);if(c<p)l=!0,h="big";else if(d<m)h="slender";else{const u=this.enemies.filter(E=>!E.isBig&&E.zombieType==="normal").length;h=this.enemies.filter(E=>!E.isBig&&E.zombieType==="fat").length<u?"fat":"normal"}}else if(this.gameMode==="arcade"){const c=this.enemies.filter(p=>p.zombieType==="slender").length,d=Math.floor(this.targetCount/10);if(c<d)h="slender";else{const p=this.enemies.filter(u=>u.zombieType==="normal").length;h=this.enemies.filter(u=>u.zombieType==="fat").length<p?"fat":"normal"}}const r=new Ge(this.scene,s,n,o,this.difficulty,a,this.player,l,h);return r.audioCtx=this.audioCtx,r.deathBuffer=this.deathBuffer,r.groanBuffer=this.groanBuffer,r.world=this.world,this.gameMode==="studio"&&(r.studioMode=!0,r.isStudioNPC=!0),this.enemies.push(r),e&&this.gameMode==="studio"&&(this.studioAiEnabled=!1),r}spawnEnemyAt(e,t,i="normal"){const s=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(e,t):0,o=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let n=!1,a=i;a==="big"&&(n=!0);const l=new Ge(this.scene,e,s,t,this.difficulty,o,this.player,n,a);return l.audioCtx=this.audioCtx,l.deathBuffer=this.deathBuffer,l.groanBuffer=this.groanBuffer,l.world=this.world,l.studioMode=!0,l.isStudioNPC=!0,this.enemies.push(l),l}setTargetCount(e){typeof e=="number"&&e>=0&&(this.targetCount=e)}update(e){if(this.gameMode!=="matrix"&&!(this.gameMode==="studio"&&!this.studioAiEnabled)&&(this.enemies.forEach(t=>{if(t.update(e,this.player),Math.sqrt(t.position.x*t.position.x+t.position.z*t.position.z)>this.world.stormRadius&&t.takeDamage(5*e),this.world&&typeof this.world.halfMapSize=="number"){const s=this.world.halfMapSize-1;t.position.x=Math.max(-s,Math.min(s,t.position.x)),t.position.z=Math.max(-s,Math.min(s,t.position.z))}}),this.enemies=this.enemies.filter(t=>t.readyToDespawn?(this.killedCount++,!1):!0),this.gameMode==="survival"&&this.targetCount!==void 0&&this.targetCount>0)){const t=this.targetCount-this.enemies.length;if(t>0)for(let i=0;i<t;i++)this.spawnEnemy()}}getEnemyById(e){return e&&this.enemies.find(t=>t&&t.mesh&&t.mesh.userData&&t.mesh.userData.gameId===e)||null}applyRemoteZombieHit(e,t){const i=this.getEnemyById(e);return!i||i.isDead?null:(i.takeDamage(t),i.health)}syncZombieState(e,t){const i=this.getEnemyById(e);if(!i)return;i.health=t;const s=i.maxHealth||100,o=Math.max(0,i.health/s);i.healthBarFg&&(i.healthBarFg.scale.x=o),t<=0&&!i.isDead&&i.startDeath()}}class Ge{constructor(e,t,i,s,o,n=100,a=null,l=!1,h="normal"){this.scene=e,this.position=new T(t,i,s),this.mapHalfSize=n,this.world=null,this.player=a,this.isBig=l,this.zombieType=h,this.deathTimer=0,this.deathDuration=0,this.deathFallProgress=0,this.readyToDespawn=!1,this.groanBuffer=null,this.groanCooldown=0,this.groanRange=15,this._groanSource=null,this._groanGain=null,o==="easy"?(this.health=50,this.damage=2,this.speed=3):o==="hard"?(this.health=150,this.damage=10,this.speed=6):(this.health=100,this.damage=5,this.speed=4.5),this.isBig&&(this.health*=5,this.damage*=2,this.speed*=.75),this.zombieType==="fat"&&(this.health*=1.5,this.speed*=.5),this.zombieType==="slender"&&(this.health*=.8,this.speed*=1.5,this.damage*=1.5,this.attackRange=3),this.maxHealth=this.health,this.state="wander",this.isDead=!1,this.attackRange=this.isBig?3.5:2,this.detectionRange=25,this.attackCooldown=1.5,this.lastAttack=0,this.wanderTarget=null,this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4,this.createMesh()}createMesh(){let e="Zombie";this.isBig?e="Big Zombie":this.zombieType==="fat"?e="Fat Zombie":this.zombieType==="slender"&&(e="Slenderman");let t;const i=this.position.x,s=this.position.y,o=this.position.z;this.zombieType==="slender"?t=mt(this.scene,i,s,o):this.isBig?t=pt(this.scene,i,s,o):this.zombieType==="fat"?t=ft(this.scene,i,s,o):this.zombieType==="spider"?t=Rt(this.scene,i,s,o):t=gt(this.scene,i,s,o),this.mesh=t.mesh,this.leftArmPivot=t.leftArmPivot,this.rightArmPivot=t.rightArmPivot,this.leftLegPivot=t.leftLegPivot,this.rightLegPivot=t.rightLegPivot,this.mesh.userData={gameId:Math.random().toString(36).substr(2,9).toUpperCase(),gameName:e,isNPC:!0},this.animTime=0,this.attackAnimTime=0,this.attackAnimDuration=.5,this.createHealthBar()}createHealthBar(){const e=new te(1,.1),t=new Me({color:0});this.healthBarBg=new g(e,t);const i=this.zombieType==="slender"?3:2.3;this.healthBarBg.position.y=i,this.mesh.add(this.healthBarBg);const s=new te(1,.1),o=new Me({color:16711680});this.healthBarFg=new g(s,o),this.healthBarFg.position.y=i,this.healthBarFg.position.z=.01,this.mesh.add(this.healthBarFg)}update(e,t){if(this.isDead){this.updateDeath(e);return}this.groanCooldown=Math.max(0,this.groanCooldown-e),this.groanBuffer&&this.audioCtx&&t&&this.groanCooldown<=0&&this.position.distanceTo(t.position)<=this.groanRange&&(this.playGroan(),this.groanCooldown=2+Math.random()*2.5);const i=t.position;if(this.healthBarBg.lookAt(i),this.healthBarFg.lookAt(i),this.studioMode||this.isStudioNPC){this.animTime+=e,this.animateIdle();return}const s=this.position.distanceTo(i);s<this.detectionRange?this.state="chase":this.state="wander";let o=!1;if(this.state==="chase"){const n=this.hasLineOfSight(t,i);if(s<this.detectionRange&&n){const a=new T().subVectors(i,this.position).normalize();if(a.y=0,s>2){const h=a.clone(),r=Math.sin(performance.now()/500+this.position.x)*.5,c=new T(a.z,0,-a.x).multiplyScalar(r);h.add(c).normalize();const d=this.position.clone().add(h.multiplyScalar(this.speed*e));this.checkCollision(d)||this.position.copy(d),this.mesh.lookAt(i),o=!0}else{const h=a.clone().multiplyScalar(-1),r=this.position.clone().add(h.multiplyScalar(this.speed*e*.5));this.checkCollision(r)||this.position.copy(r),this.mesh.lookAt(i)}if(s<this.attackRange){const h=performance.now()/1e3;h-this.lastAttack>this.attackCooldown&&(t.takeDamage(this.damage),this.lastAttack=h,this.attackAnimTime=this.attackAnimDuration)}}else this.state="wander"}else{if(this.wanderTimer+=e,!this.wanderTarget||this.wanderTimer>this.wanderChangeInterval){const n=10+Math.random()*30,a=Math.random()*Math.PI*2,l=this.position.x+Math.cos(a)*n,h=this.position.z+Math.sin(a)*n,r=(m,u,w)=>Math.max(u,Math.min(w,m)),c=this.mapHalfSize*.9,d=r(l,-c,c),p=r(h,-c,c);this.wanderTarget=new T(d,0,p),this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4}if(this.wanderTarget){const n=new T().subVectors(this.wanderTarget,this.position);n.y=0,n.length()>.5?(n.normalize(),this.position.add(n.multiplyScalar(this.speed*e*.5)),this.mesh.lookAt(this.wanderTarget.x,this.position.y,this.wanderTarget.z),o=!0):(this.wanderTimer+=e,this.wanderTimer>this.wanderChangeInterval&&(this.wanderTarget=null,this.wanderTimer=0))}}if(this.mesh.position.copy(this.position),this.world&&typeof this.world.getHeightAt=="function"){const n=this.world.getHeightAt(this.position.x,this.position.z);this.mesh.position.y=Math.max(this.mesh.position.y,n),this.position.y=this.mesh.position.y}if(o){this.animTime+=e*5;const n=Math.sin(this.animTime)*.5;this.leftLegPivot.rotation.x=n,this.rightLegPivot.rotation.x=-n,this.leftArmPivot.rotation.x=-Math.PI/3+n*.2,this.rightArmPivot.rotation.x=-Math.PI/3-n*.2}else this.state!=="attack"&&(this.leftLegPivot.rotation.x=0,this.rightLegPivot.rotation.x=0,this.leftArmPivot.rotation.x=-Math.PI/3,this.rightArmPivot.rotation.x=-Math.PI/3);if(this.attackAnimTime>0){this.attackAnimTime=Math.max(0,this.attackAnimTime-e);const n=1-this.attackAnimTime/this.attackAnimDuration,a=Math.sin(n*Math.PI)*1.5;if(this.leftArmPivot.rotation.x=-Math.PI/2+a*.2,this.rightArmPivot.rotation.x=-Math.PI/2-a*.2,n>.3&&n<.7){const l=new T;this.mesh.getWorldDirection(l),l.y=0,l.normalize(),this.position.add(l.multiplyScalar(.02))}}}takeDamage(e){this.health-=e;const t=this.maxHealth||100,i=Math.max(0,this.health/t);this.healthBarFg.scale.x=i,this.mesh.traverse(s=>{if(s.isMesh&&s!==this.healthBarBg&&s!==this.healthBarFg){const o=s.material;if(!s.userData.originalColor&&o&&o.color)try{s.userData.originalColor=o.color.clone()}catch{s.userData.originalColor=null}if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new ne(16711680);else if(o&&o.color)try{o.color=o.color.clone().lerp(new ne(16711680),.6)}catch{}}}),setTimeout(()=>{this.isDead||this.mesh.traverse(s=>{if(s.isMesh&&s!==this.healthBarBg&&s!==this.healthBarFg){const o=s.material;if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new ne(0);else if(o&&o.color&&s.userData&&s.userData.originalColor)try{o.color.copy(s.userData.originalColor)}catch{}}})},100),this.health<=0&&!this.isDead&&this.startDeath()}playDeathSound(){try{const e=this.audioCtx.createBufferSource();e.buffer=this.deathBuffer;const t=this.audioCtx.createGain();t.gain.value=.7,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}catch(e){console.warn("playDeathSound error:",e)}}checkCollision(e){if(!this.scene)return!1;const t=.5;for(let i of this.scene.children)if(i.userData&&(i.userData.type==="house"||i.userData.type==="tree")){const s=i.position,o=Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.z-s.z,2)),n=i.userData.type==="house"?5:2;if(o<t+n)return!0}return!1}hasLineOfSight(e,t){if(!this.scene)return!0;const i=new T().subVectors(t,this.position).normalize(),s=this.position.distanceTo(t),n=new $(this.position.clone().add(new T(0,1,0)),i,0,s).intersectObjects(this.scene.children,!0);for(let a of n){if(a.object===this.mesh||a.object.parent===this.mesh||a.object===e.mesh||a.object.parent===e.mesh)continue;let l=a.object;for(;l.parent&&l.parent!==this.scene;)l=l.parent;if(l.userData&&(l.userData.type==="house"||l.userData.type==="tree"))return!1}return!0}startDeath(){this.isDead=!0,this.deathTimer=0,this.deathFallProgress=0,this.deathDuration=3+Math.random()*2,this.stopGroan(),this.healthBarBg&&(this.healthBarBg.visible=!1),this.healthBarFg&&(this.healthBarFg.visible=!1);const e=25,t=this.player&&this.player.position;if(t?this.position.distanceTo(t)<=e:!0)try{this.audioCtx&&this.deathBuffer&&(this.audioCtx.state==="suspended"?this.audioCtx.resume().then(()=>{this.playDeathSound()}):this.audioCtx.state==="running"&&this.playDeathSound())}catch(s){console.warn("Error playing death sound:",s)}}updateDeath(e){this.deathFallProgress=Math.min(1,this.deathFallProgress+e*2.5);const t=-Math.PI/2*this.deathFallProgress;this.mesh&&(this.mesh.rotation.x=t,this.mesh.position.y=Math.max(0,this.mesh.position.y-e*.6)),this.deathTimer+=e,this.deathTimer>=(this.deathDuration||3)&&(this.mesh&&this.mesh.parent&&this.scene.remove(this.mesh),this.readyToDespawn=!0)}playGroan(){try{if(!this.audioCtx||!this.groanBuffer)return;if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playGroan());return}const e=this.audioCtx.createBufferSource();e.buffer=this.groanBuffer;const t=this.audioCtx.createGain();t.gain.value=.45,e.connect(t),t.connect(this.audioCtx.destination),e.onended=()=>{this._groanSource=null,this._groanGain=null},e.start(0),this._groanSource=e,this._groanGain=t}catch(e){console.warn("playGroan error:",e)}}stopGroan(){if(this._groanSource){try{this._groanSource.stop()}catch{}try{this._groanSource.disconnect()}catch{}this._groanSource=null}if(this._groanGain){try{this._groanGain.disconnect()}catch{}this._groanGain=null}}}class ni{constructor(e,t,i){this.scene=e,this.player=t,this.items=[],this.interactionPrompt=document.getElementById("interaction-prompt"),this.mapSize=i&&i.mapSize?i.mapSize:ke,this.spawnSpan=this.mapSize*.75,this.glowRadius=7,this.world=null,this.settings=i||{},this.matrixDropInterval=5,this._matrixDropTimer=0,this.matrixDropBatchSize=10,this.matrixDropRadiusLimit=10,this.initLoot(),document.addEventListener("keydown",s=>{s.code==="KeyE"&&this.tryInteract()})}setWorld(e){this.world=e,this.realignItemsToGround()}getClampedCoord(e,t){if(this.world&&typeof this.world.halfMapSize=="number"){const i=this.world.halfMapSize-1;return{x:Math.max(-i,Math.min(i,e)),z:Math.max(-i,Math.min(i,t))}}return{x:e,z:t}}initLoot(){if(this.settings.gameMode==="matrix"||this.settings.gameMode==="studio"||this.settings.gameMode==="matrix-ai"||this.settings.skipLoot)return;for(let t=0;t<24;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.createChest(i,.5,s)}for(let t=0;t<36;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.spawnJuiceBottle(i,s)}const e=[2899536,15105570,1752220,15158332,10181046];for(let t=0;t<8;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s));const o=e[t%e.length];this.spawnBackpack(i,s,o)}for(let t=0;t<12;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.spawnMedKit(i,s)}}createChest(e,t,i){this.spawnChest(e,i)}spawnChest(e,t){const i=new O;({x:e,z:t}=this.getClampedCoord(e,t));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(e,t)+.5),i.position.set(e,s,t);const o=new b(1,.8,.6),n=new S({color:15844367,roughness:.3,metalness:.5}),a=new g(o,n);i.add(a);const l=new b(1,.2,.6),h=new g(l,n);h.position.y=.5,i.add(h);const r=new g(new b(.2,.3,.1),new S({color:9807270}));r.position.set(0,.3,.3),i.add(r),i.castShadow=!0,i.receiveShadow=!0;const c=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],d=c[Math.floor(Math.random()*c.length)];i.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:d};const p=this.createGlowEffect();return p.position.y=1,i.add(p),i.userData.glow=p,this.scene.add(i),this.items.push(i),i}spawnChestWithLoot(e,t,i){const s=new O;({x:e,z:t}=this.getClampedCoord(e,t));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(e,t)+.5),s.position.set(e,o,t);const n=new b(1,.8,.6),a=new S({color:15844367,roughness:.3,metalness:.5}),l=new g(n,a);s.add(l);const h=new b(1,.2,.6),r=new g(h,a);r.position.y=.5,s.add(r);const c=new g(new b(.2,.3,.1),new S({color:9807270}));c.position.set(0,.3,.3),s.add(c),s.castShadow=!0,s.receiveShadow=!0,s.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:i};const d=this.createGlowEffect();return d.position.y=1,s.add(d),s.userData.glow=d,this.scene.add(s),this.items.push(s),s}spawnJuiceBottle(e,t){const i=new O;({x:e,z:t}=this.getClampedCoord(e,t));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(e,t)+.5),i.position.set(e,s,t);const o=new g(new ie(.2,.2,.6,8),new S({color:2600544}));o.position.y=.5,i.add(o);const n=new g(new ie(.12,.12,.15,8),new S({color:12597547}));n.position.y=.9,i.add(n),i.castShadow=!0,i.receiveShadow=!0,i.userData={type:"stamina",gameId:this.generateID(),gameName:"JuiceBottle",amount:50};const a=this.createGlowEffect();return a.position.y=.9,i.add(a),i.userData.glow=a,this.scene.add(i),this.items.push(i),i}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}spawnLootInHouse(e,t,i){this.spawnChest(e,i)}spawnBackpack(e,t,i){const s=new O;({x:e,z:t}=this.getClampedCoord(e,t));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(e,t)+.5),s.position.set(e,o,t);const n=new g(new b(.7,.9,.35),new S({color:i,metalness:.15,roughness:.8}));s.add(n);const a=new g(new b(.6,.25,.16),new S({color:3426654,metalness:.1,roughness:.8}));a.position.set(0,-.55,.18),s.add(a),s.castShadow=!0,s.receiveShadow=!0;const l=this.createGlowEffect();return l.position.y=1,s.add(l),s.userData={type:"backpack",color:i,gameId:this.generateID(),gameName:"Backpack",isOpened:!1,glow:l},this.scene.add(s),this.items.push(s),s}spawnMedKit(e,t){const i=new O;({x:e,z:t}=this.getClampedCoord(e,t));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(e,t)+.3),i.position.set(e,s,t);const o=new g(new b(.8,.5,.6),new S({color:15790320,metalness:.2,roughness:.6}));i.add(o);const n=new g(new b(.5,.05,.15),new S({color:15158332,metalness:.1,roughness:.4}));n.position.y=.28,i.add(n);const a=new g(new b(.15,.05,.5),new S({color:15158332,metalness:.1,roughness:.4}));a.position.y=.28,i.add(a);const l=new g(new b(.6,.1,.08),new S({color:9807270,metalness:.4,roughness:.5}));l.position.y=.35,i.add(l);const h=new g(new b(.15,.08,.08),new S({color:8359053,metalness:.5,roughness:.4}));h.position.set(0,0,.32),i.add(h),i.castShadow=!0,i.receiveShadow=!0;const r=this.createGlowEffect();return r.position.y=.6,i.add(r),i.userData={type:"medkit",gameId:this.generateID(),gameName:"MedKit",healAmount:25,isOpened:!1,glow:r},this.scene.add(i),this.items.push(i),i}spawnMatrixLoadout(e=0,t=0){[{dx:2,dz:0,loot:"Pistol"},{dx:-2,dz:0,loot:"Rifle"},{dx:0,dz:2,loot:"Sniper"},{dx:0,dz:-2,loot:"ShieldPotion"},{dx:2,dz:2,loot:"SMG"},{dx:-2,dz:-2,loot:"Shotgun"},{dx:-2,dz:2,loot:"DMR"}].forEach(o=>{this.spawnChestWithLoot(e+o.dx,t+o.dz,o.loot)}),this.spawnJuiceBottle(e+3,t+3),this.spawnJuiceBottle(e-3,t-3),[2899536,15105570,1752220].forEach((o,n)=>{this.spawnBackpack(e+(n-1)*2,t+4,o)})}countNearbyChests(e=10){if(!this.player)return 0;const t=this.player.position;let i=0;return this.items.forEach(s=>{const o=s.userData||{};if(o.type!=="chest"||o.isOpened)return;const n=s.position.x-t.x,a=s.position.z-t.z;Math.sqrt(n*n+a*a)<=e&&i++}),i}createUmbrella(){const e=new O,t=new g(new ie(.08,.08,1.6,6),new S({color:4863016,roughness:.8}));t.position.y=-.2,e.add(t),[16726832,15844367,3447003].forEach((o,n)=>{const a=new g(new b(1.8-n*.3,.15,1.8-n*.3),new S({color:o,roughness:.4,metalness:.2}));a.position.y=.7+n*.12,e.add(a)});const s=new g(new We(.2,.25,6),new S({color:2899536}));return s.position.y=1.1,e.add(s),e.castShadow=!0,e.receiveShadow=!0,e}spawnMatrixDropNearPlayer(){if(!this.player)return;const e=Math.random()*Math.PI*2,t=4+Math.random()*8;let i=this.player.position.x+Math.cos(e)*t,s=this.player.position.z+Math.sin(e)*t;({x:i,z:s}=this.getClampedCoord(i,s));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(i,s)+.5);const n=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],a=n[Math.floor(Math.random()*n.length)],l=this.spawnChestWithLoot(i,s,a);if(l){l.position.y=o+18,l.userData.isDropping=!0,l.userData.dropTargetY=o,l.userData.dropVelocity=0;const h=this.createUmbrella();h.position.y=1.2,l.add(h),l.userData.umbrella=h}}spawnMatrixDropsBatch(){if(this.countNearbyChests(this.matrixDropRadiusLimit)>=this.matrixDropBatchSize)return;const e=this.matrixDropBatchSize-this.countNearbyChests(this.matrixDropRadiusLimit),t=Math.max(0,Math.min(this.matrixDropBatchSize,e));for(let i=0;i<t;i++)this.spawnMatrixDropNearPlayer()}update(e=.016){const t=Math.max(0,e||0);this.settings.gameMode==="matrix"&&this.player&&(this._matrixDropTimer+=t,this._matrixDropTimer>=this.matrixDropInterval&&(this._matrixDropTimer=0,this.spawnMatrixDropsBatch())),this.items.forEach(o=>{const n=o.userData||{};if(n.isDropping&&(n.dropVelocity=(n.dropVelocity||0)+5*t,o.position.y-=n.dropVelocity*t,o.position.y<=n.dropTargetY&&(o.position.y=n.dropTargetY,n.isDropping=!1,n.dropVelocity=0,n.umbrella))){try{o.remove(n.umbrella)}catch{}n.umbrella=null}});let i=null;const s=this.player.position;for(const o of this.items){if(o.userData&&o.userData.isOpened)continue;const n=s.distanceTo(o.position);if(this.updateGlow(o,n),n<3){i=o;break}}if(!(this.interactionPrompt&&this.interactionPrompt.dataset.vehiclePrompt==="1"))if(i){this.interactionPrompt.classList.remove("hidden");const o=i.userData||{};if(o.type==="chest")this.interactionPrompt.innerText=`Press E to open (Contains: ${o.loot})`;else if(o.type==="stamina")this.interactionPrompt.innerText=`Press E to collect ${o.gameName} (+${o.amount} Stamina)`;else if(o.type==="medkit")this.interactionPrompt.innerText=`Press E to use ${o.gameName} (+${o.healAmount}% Health)`;else if(o.type==="backpack"){const n=o.color?"#"+o.color.toString(16).padStart(6,"0"):"";this.interactionPrompt.innerText=`Press E to equip Backpack ${n}`}else this.interactionPrompt.innerText="Press E to interact";this.currentItem=i}else this.interactionPrompt.classList.add("hidden"),this.currentItem=null}tryInteract(){if(this.currentItem){const e=this.currentItem.userData;if(!e)return;if(e.type==="chest"&&!e.isOpened)e.isOpened=!0,this.scene.remove(this.currentItem),this.player.collectItem(e.loot),console.log(`Looted ${e.loot}!`);else if(e.type==="stamina"){const t=e.amount||50;this.player&&(this.player.stamina=Math.min(100,this.player.stamina+t)),this.scene.remove(this.currentItem),e.isOpened=!0,console.log(`Picked up stamina item: +${t}`)}else if(e.type==="medkit"){const t=e.healAmount||25;if(this.player){const s=100*t/100;this.player.health=Math.min(100,this.player.health+s),console.log(`Used MedKit: +${s} HP (${t}%)`)}this.scene.remove(this.currentItem),e.isOpened=!0}else if(e.type==="backpack"){const t=e.color||2899536;if(this.player&&typeof this.player.collectItem=="function"){const i=this.player.collectItem(`Backpack:${t.toString(16)}`);if(i!=null){const s=this.player.position.clone();this.spawnBackpack(s.x+.5,s.z+.5,i)}}this.scene.remove(this.currentItem),e.isOpened=!0,console.log(`Equipped backpack ${t.toString(16)}`)}}}realignItemsToGround(){!this.world||typeof this.world.getHeightAt!="function"||this.items.forEach(e=>{const t=e.position,i=this.world.getHeightAt(t.x,t.z),s=(e.userData&&e.userData.type==="chest",.5);e.position.y=i+s})}updateGlow(e,t){if(!e||!e.userData||!e.userData.glow)return;const i=e.userData.glow,s=!e.userData.isOpened&&t<this.glowRadius;i.visible=s,s&&(i.rotation.y+=.02,i.position.y=(e.userData.type==="chest"?1:.9)+Math.sin(performance.now()/500)*.1)}createGlowEffect(){const t=new Float32Array(120),i=.6;for(let a=0;a<40;a++){const l=i*Math.random(),h=Math.random()*Math.PI*2,r=Math.random()*i*.6;t[a*3]=Math.cos(h)*l,t[a*3+1]=r,t[a*3+2]=Math.sin(h)*l}const s=new Xe;s.setAttribute("position",new xe(t,3));const o=new yt({color:16765286,size:.15,transparent:!0,opacity:.9,depthWrite:!1,blending:wt,sizeAttenuation:!0}),n=new vt(s,o);return n.visible=!1,n}}class ai{constructor(e,t={}){this.player=e,this.container=document.getElementById("touch-controls"),this.enabled=!0,this.layout=t&&t.layout?t.layout:{},this._cleanupExistingControls(),this.isEditing=!1,this.buttonHelpers=new Map,this._suppressDragUntil=0,this.joystick=document.createElement("div"),this.joystick.className="tc-joystick",this.joystick.style.zIndex="210",this.stick=document.createElement("div"),this.stick.className="tc-stick",this.joystick.appendChild(this.stick),this.buttons=document.createElement("div"),this.buttons.className="tc-buttons",this.buttons.style.zIndex="210",this.fireBtn=document.createElement("button"),this.fireBtn.className="tc-btn tc-btn-fire",this.fireBtn.innerText="FIRE",this.jumpBtn=document.createElement("button"),this.jumpBtn.className="tc-btn",this.jumpBtn.innerText="JUMP",this.sprintBtn=document.createElement("button"),this.sprintBtn.className="tc-btn",this.sprintBtn.innerText="SPRINT",this.interactBtn=document.createElement("button"),this.interactBtn.className="tc-btn tc-interact-btn",this.interactBtn.innerText="E",this.interactBtn.style.display="none",this.crouchBtn=document.createElement("button"),this.crouchBtn.className="tc-btn",this.crouchBtn.innerText="CROUCH",this.crouchBtn.style.fontSize="16px",this.buttons.appendChild(this.fireBtn),this.buttons.appendChild(this.jumpBtn),this.buttons.appendChild(this.sprintBtn),this.buttons.appendChild(this.crouchBtn),this.buttons.appendChild(this.interactBtn),this.container.appendChild(this.joystick),this.container.appendChild(this.buttons),this.container.classList.remove("hidden"),this.applyLayout(),this._initDragHandles(),this.active=!1,this.startPos=null,this.currentPos={x:0,y:0},this.lookActive=!1,this.lookStartPos=null,this._bindJoystick(),this._bindButtons(),this._bindLookArea(),this._setupEditToggleGesture(),this.deadZone=10,this.maxRadius=50,document.body.style.touchAction="none";try{this.player&&(this.player.allowTouchMovement=!0)}catch{}}_dispatchTouchLook(e,t){try{window.dispatchEvent(new CustomEvent("game-touch-look",{detail:{dx:e,dy:t}}))}catch{}}destroy(){try{this.container.classList.add("hidden"),this.destroyLookArea(),this.container.removeChild(this.joystick),this.container.removeChild(this.buttons),document.body.style.touchAction="",this.player&&(this.player.allowTouchMovement=!1)}catch{}}applyLayout(){const e=this.layout.joystickLeft!==void 0?this.layout.joystickLeft:10,t=this.layout.joystickBottom!==void 0?this.layout.joystickBottom:12,i=this.layout.buttonsRight!==void 0?this.layout.buttonsRight:8,s=this.layout.buttonsBottom!==void 0?this.layout.buttonsBottom:12,o=this.layout.buttonGapVh!==void 0?this.layout.buttonGapVh:14/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={});const n=(l,h)=>{this.layout.buttonPositions[l]||(this.layout.buttonPositions[l]={right:i,bottom:s+o*h})};n("fire",0),n("jump",1),n("sprint",2),n("crouch",3),n("interact",4),this.joystick.style.left=`${e}vw`,this.joystick.style.bottom=`${t}vh`,this.buttons.style.position="absolute",this.buttons.style.top="0",this.buttons.style.left="0",this.buttons.style.right="0",this.buttons.style.bottom="0",this.buttons.style.display="block",this.buttons.style.pointerEvents="none";const a=(l,h)=>{const r=this.layout.buttonPositions[h];r&&(l.style.position="absolute",l.style.right=`${r.right}vw`,l.style.bottom=`${r.bottom}vh`,l.style.pointerEvents="auto")};a(this.fireBtn,"fire"),a(this.jumpBtn,"jump"),a(this.sprintBtn,"sprint"),a(this.crouchBtn,"crouch"),a(this.interactBtn,"interact")}_cleanupExistingControls(){if(!this.container)return;this.container.querySelectorAll(".tc-joystick, .tc-buttons, .tc-look-area").forEach(t=>{try{t.parentNode.removeChild(t)}catch{}})}_initDragHandles(){const e=()=>{try{const o=localStorage.getItem("touch-layout");if(o){const n=JSON.parse(o);this.layout={...this.layout,...n}}}catch{}},t=()=>{try{localStorage.setItem("touch-layout",JSON.stringify(this.layout))}catch{}};e(),this.applyLayout(),((o,n)=>{let a=!1,l=0,h=0;const r=10,c=m=>{const u=m.touches?m.touches[0]:m;if(!a){const w=u.clientX-l,E=u.clientY-h;if(Math.sqrt(w*w+E*E)<r)return;a=!0}{const w=u.clientX/window.innerWidth*100;this.layout.joystickLeft=Math.max(0,Math.min(80,w));const E=(window.innerHeight-u.clientY)/window.innerHeight*100;this.layout.joystickBottom=Math.max(0,Math.min(80,E))}this.applyLayout(),m.preventDefault&&m.preventDefault()},d=()=>{a&&(a=!1,t()),document.removeEventListener("touchmove",c,{passive:!1}),document.removeEventListener("touchend",d),document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",d)},p=m=>{if(!this.isEditing||this._shouldSuppressDrag()||m.touches&&m.touches.length>1)return;const u=m.touches?m.touches[0]:m;l=u.clientX,h=u.clientY,a=!1,document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",d),document.addEventListener("pointermove",c),document.addEventListener("pointerup",d)};o.addEventListener("touchstart",p,{passive:!0}),o.addEventListener("pointerdown",p)})(this.joystick);const s=(o,n)=>{let a=!1,l=0,h=0;const r=10,c=m=>{if(!a)return;const u=m.touches?m.touches[0]:m,w=(window.innerWidth-u.clientX)/window.innerWidth*100,E=(window.innerHeight-u.clientY)/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={}),this.layout.buttonPositions[n]={right:Math.max(0,Math.min(90,w)),bottom:Math.max(0,Math.min(90,E))},this.applyLayout(),m.preventDefault&&m.preventDefault()},d=()=>{a&&(a=!1,t()),document.removeEventListener("touchmove",c,{passive:!1}),document.removeEventListener("touchend",d),document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",d)},p=m=>{if(!this.isEditing||this._shouldSuppressDrag()||m.touches&&m.touches.length>1)return;const u=m.touches?m.touches[0]:m;l=u.clientX,h=u.clientY,a=!1,document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",d),document.addEventListener("pointermove",c),document.addEventListener("pointerup",d)};o.addEventListener("touchstart",p,{passive:!0}),o.addEventListener("pointerdown",p),o.addEventListener("touchmove",m=>{if(!this.isEditing||this._shouldSuppressDrag()||a)return;const u=m.touches?m.touches[0]:m,w=u.clientX-l,E=u.clientY-h;Math.sqrt(w*w+E*E)>r&&(a=!0)},{passive:!0}),o.addEventListener("pointermove",m=>{if(m.pointerType!=="touch"||!this.isEditing||this._shouldSuppressDrag()||a)return;const u=m.clientX-l,w=m.clientY-h;Math.sqrt(u*u+w*w)>r&&(a=!0)})};s(this.fireBtn,"fire"),s(this.jumpBtn,"jump"),s(this.sprintBtn,"sprint"),s(this.crouchBtn,"crouch"),s(this.interactBtn,"interact")}_bindJoystick(){this.joystick.addEventListener("touchstart",t=>{t.preventDefault();const i=t.changedTouches[0];this.joystick.getBoundingClientRect(),this.startPos={x:i.clientX,y:i.clientY},this.active=!0}),this.joystick.addEventListener("touchmove",t=>{if(!this.active)return;t.preventDefault();const i=t.changedTouches[0],s=i.clientX-this.startPos.x,o=i.clientY-this.startPos.y,n=Math.sqrt(s*s+o*o),a=Math.atan2(o,s),l=Math.min(this.maxRadius,n),h=Math.cos(a)*l,r=Math.sin(a)*l;this.stick.style.transform=`translate(${h}px, ${r}px)`;const c=s/this.maxRadius,d=o/this.maxRadius;this.player.moveForward=d<-.3,this.player.moveBackward=d>.3,this.player.moveLeft=c<-.3,this.player.moveRight=c>.3});const e=t=>{this.active&&(t.preventDefault(),this.active=!1,this.startPos=null,this.stick.style.transform="translate(0,0)",this.player.moveForward=!1,this.player.moveBackward=!1,this.player.moveLeft=!1,this.player.moveRight=!1)};this.joystick.addEventListener("touchend",e),this.joystick.addEventListener("touchcancel",e)}_bindButtons(){let e=null,t=null;const i=()=>{e&&(clearInterval(e),e=null)};this._stopFireInterval=i,this.fireBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&(i(),t&&(clearTimeout(t),t=null),this.player&&typeof this.player.shoot=="function"&&(this.player.shoot(),t=setTimeout(()=>{e=setInterval(()=>{this.player&&typeof this.player.shoot=="function"&&this.player.shoot()},150)},220)))});const s=o=>{o&&o.preventDefault&&o.preventDefault(),!this.isEditing&&(t&&(clearTimeout(t),t=null),i())};this.fireBtn.addEventListener("touchend",s),this.fireBtn.addEventListener("touchcancel",s),this.fireBtn.addEventListener("pointerup",o=>{o.pointerType==="touch"&&s(o)}),this.fireBtn.addEventListener("pointercancel",o=>{o.pointerType==="touch"&&s(o)}),this.fireBtn.addEventListener("mouseup",s),this.fireBtn.addEventListener("mouseleave",s),this.jumpBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&this.player.canJump===!0&&(this.player.velocity.y+=this.player.jumpHeight,this.player.canJump=!1)}),this.sprintBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.stamina<=0?this.player.isSprinting=!1:this.player.isSprinting=!this.player.isSprinting,this._updateSprintButton())}),this.interactBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&window.game&&window.game.itemManager&&window.game.itemManager.tryInteract()}),this.crouchBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.isCrouching=!this.player.isCrouching,this.crouchBtn.style.background=this.player.isCrouching?"rgba(52, 152, 219, 0.9)":"rgba(241, 196, 15, 0.9)")})}update(){window.game&&window.game.itemManager&&window.game.itemManager.currentItem?this.interactBtn.style.display="block":this.interactBtn.style.display="none";try{this.player&&this.player.stamina!==void 0&&(this.player.isSprinting&&this.player.stamina<=0&&(this.player.isSprinting=!1),this._updateSprintButton())}catch{}}destroyLookArea(){try{this.lookArea&&this.container&&this.lookArea.parentElement===this.container&&this.container.removeChild(this.lookArea)}catch{}this.lookArea=null}rebuildLookArea(){this.destroyLookArea(),this._bindLookArea()}_bindLookArea(){try{if(this.lookArea)try{this.container.removeChild(this.lookArea)}catch{}this.lookArea=document.createElement("div"),this.lookArea.className="tc-look-area",this.lookArea.style.position="absolute",this.lookArea.style.top="0",this.lookArea.style.bottom="0",this.lookArea.style.right="0",this.lookArea.style.left="0",this.lookArea.style.width="100%",this.lookArea.style.zIndex="190",this.lookArea.style.background="transparent",this.lookArea.style.touchAction="none",this.lookArea.style.pointerEvents="auto",this.container.appendChild(this.lookArea);let e=null,t=0,i=0;this.lookArea.addEventListener("touchstart",o=>{if(e!==null)return;const n=o.changedTouches[0];e=n.identifier,t=n.clientX,i=n.clientY,o.cancelable&&o.preventDefault()},{passive:!1}),this.lookArea.addEventListener("touchmove",o=>{if(e!==null){o.cancelable&&o.preventDefault();for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===e){const a=o.changedTouches[n],l=a.clientX-t,h=a.clientY-i;t=a.clientX,i=a.clientY,this._dispatchTouchLook(l,h);break}}},{passive:!1});const s=o=>{if(e!==null){for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===e){e=null;break}}};this.lookArea.addEventListener("touchend",s),this.lookArea.addEventListener("touchcancel",s)}catch{}}_getButtons(){return[this.fireBtn,this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_getEditToggleTargets(){return[this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_setupEditToggleGesture(){let e=0,t=0;const i=700,s=n=>{n.touches&&n.touches.length>=2&&(n.preventDefault(),n.stopPropagation(),e=0,this._suppressDrag(),this._toggleEditMode())},o=n=>{const a=performance.now();a-t<i?e+=1:e=1,t=a,e>=3&&(n.preventDefault(),n.stopPropagation(),e=0,this._suppressDrag(),this._toggleEditMode())};this._getEditToggleTargets().forEach(n=>{n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("touchend",o,{passive:!1}),n.addEventListener("touchcancel",()=>{e=0},{passive:!0}),n.addEventListener("pointerdown",a=>{a.pointerType})})}_updateSprintButton(){if(!this.player)return;const e=!!this.player.isSprinting;this.sprintBtn.style.background=e?"rgba(46, 204, 113, 0.9)":"rgba(241, 196, 15, 0.9)"}_toggleEditMode(){this.isEditing?this._exitEditMode():this._enterEditMode()}_enterEditMode(){this.isEditing=!0,typeof this._stopFireInterval=="function"&&this._stopFireInterval(),this._showButtonHelpers(),this._suppressDrag()}_exitEditMode(){this.isEditing=!1,this._hideButtonHelpers()}_showButtonHelpers(){this._getButtons().forEach(e=>{e.classList.add("tc-btn-editing");let t=this.buttonHelpers.get(e);t||(t=document.createElement("div"),t.className="tc-btn-helper",t.style.position="absolute",t.style.inset="-8px",t.style.border="2px dashed rgba(255, 255, 255, 0.75)",t.style.borderRadius="22px",t.style.pointerEvents="none",t.style.boxShadow="0 0 12px rgba(255, 255, 255, 0.5)",t.style.animation="tc-btn-helper-pulse 1.6s ease-in-out infinite",t.style.opacity="0.9",this.buttonHelpers.set(e,t)),e.contains(t)||(t.setAttribute("aria-hidden","true"),e.appendChild(t))})}_hideButtonHelpers(){this._getButtons().forEach(e=>{e.classList.remove("tc-btn-editing");const t=this.buttonHelpers.get(e);t&&t.parentNode===e&&e.removeChild(t)})}_suppressDrag(e=450){this._suppressDragUntil=performance.now()+e}_shouldSuppressDrag(){return performance.now()<this._suppressDragUntil}}class ri{constructor({player:e,scene:t,url:i,nick:s="Player",color:o="#29b6f6",roomCode:n="PUBLIC",settings:a=null}){this.player=e,this.scene=t,this.url=i,this.nick=s,this.color=o,this.roomCode=n||"PUBLIC",this.socket=null,this.id=null,this.others=new Map,this.lastSend=0,this.sendInterval=.05,this.lastSentPos=null,this.lastSentRot=null,this.lastAnimSig=null,this.heartbeatTimer=0,this.isHost=!1,this.roomSettings=a,this._manualClose=!1,this.deadPeers=new Set,this.matchLive=!1,this.remoteStates=new Map,this.remoteLastYaw=new Map,this.interpDelayMs=100,this.maxBufferMs=1e3,this.maxExtrapMs=80,this.remoteFaceOffset=0,this._now=typeof performance<"u"&&performance.now.bind(performance)||Date.now,this._tmpVec=new T,this.enemyManager=null,this.netStats={txBytes:0,rxBytes:0,txPerSec:0,rxPerSec:0,lastSample:this._now(),history:[]},this.lastPingSent=0,this.pingInterval=5,this.connect()}applyColorToTorso(e,t){if(!e||!t)return;let i=!1;const s=new ne(t);return e.traverse(o=>{if(!o.isMesh||!o.material||Array.isArray(o.material))return;const n=o.userData&&o.userData.gameName?o.userData.gameName.toLowerCase():"";(n.includes("body")||n.includes("torso")||n.includes("shirt")||n.includes("clothes")||o.geometry&&o.geometry.parameters&&Math.abs(o.geometry.parameters.width-.6)<.05)&&(o.material=o.material.clone(),o.material.color=s,i=!0)}),e.userData&&(e.userData.color=t),i}connect(){if(!this.url){console.warn("Multiplayer URL not configured.");const e=document.getElementById("ai-log");if(e){const t=document.createElement("div");t.textContent="Multiplayer URL not set in settings.",t.style.color="#ff9b9b",e.appendChild(t)}return}try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.sendJoin()},this.socket.onmessage=e=>this.handleMessage(e),this.socket.onclose=()=>{this.others.forEach(e=>{try{this.scene.remove(e)}catch{}}),this.others.clear(),this.deadPeers.clear(),this.matchLive=!1,this._manualClose||setTimeout(()=>this.connect(),1500)},this.socket.onerror=()=>{}}catch(e){console.warn("Multiplayer connect failed:",e)}}handleMessage(e){var t;try{const i=typeof e.data=="string"?e.data.length:0,s=JSON.parse(e.data);if(i>0&&this.trackRx(i),s.type!=="hello"){if(s.type==="welcome")this.id=s.id,this.isHost=!!s.isHost,s.settings&&(this.roomSettings=s.settings),s.custom&&(this.localCustom=s.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount()),this.onHostChanged&&this.onHostChanged(this.isHost),s.settings&&this.onSettings&&this.onSettings(s.settings);else if(s.type==="player-join")s.id&&s.id!==this.id&&this.ensureRemote(s.id,null,s.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(s.type==="player-leave")this.removeRemote(s.id),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(s.type==="state"&&s.id!==this.id){if(this.deadPeers.has(s.id))return;const o=this.ensureRemote(s.id,s.color,s.custom),n=typeof s.ts=="number"?s.ts:this._now();this.bufferRemoteState(s.id,{t:n,pos:s.pos,rot:s.rot,fwd:s.fwd,anim:s.anim,nick:s.nick,color:s.color,custom:s.custom?{...s.custom}:null}),o&&s.color&&((t=o.userData)==null?void 0:t.color)!==s.color&&this.applyColorToTorso(o,s.color),this.applyRemoteCustomization(o,s.custom),o&&o.userData&&(o.userData.custom=s.custom?{...s.custom}:null)}else if(s.type==="hit")this.onHit&&this.onHit(s);else if(s.type==="host-changed")this.isHost=s.hostId===this.id,this.onHostChanged&&this.onHostChanged(this.isHost);else if(s.type==="start-countdown")this.onCountdown&&this.onCountdown(s.duration||10);else if(s.type==="match-start")this.onMatchStart&&this.onMatchStart(),this.matchLive=!0;else if(s.type==="settings")this.roomSettings=s.settings,this.onSettings&&this.onSettings(s.settings);else if(s.type==="zombie-hit"){if(this.isHost&&this.enemyManager&&s.id&&typeof s.amount=="number"){const o=this.enemyManager.applyRemoteZombieHit(s.id,s.amount);typeof o=="number"&&this.sendZombieState(s.id,o)}}else if(s.type==="zombie-state")this.enemyManager&&s.id&&typeof s.health=="number"&&this.enemyManager.syncZombieState(s.id,s.health);else if(s.type==="player-dead")s.id&&(this.deadPeers.add(s.id),this.killRemote(s.id),this.onPeerDeath&&this.onPeerDeath(s.id));else if(s.type==="pong"&&typeof s.ts=="number"){const o=this._now()-s.ts;this.netStats.lastPing=o}}}catch(i){console.warn("Multiplayer parse error:",i)}}ensureRemote(e,t=null,i=null){if(!e||e===this.id||this.deadPeers&&this.deadPeers.has(e))return null;if(this.others.has(e))return this.others.get(e);const s=this.clonePlayerAvatar(t);if(s)return s.userData={...s.userData||{},gameId:e,gameName:"Player",color:t||this.color},this.applyColorToTorso(s,t||this.color),s.traverse(l=>{l.isMesh&&(l.castShadow=!1,l.receiveShadow=!0)}),this.scene.add(s),this.others.set(e,s),s.userData&&(s.userData.custom=i?{...i}:null),this.applyRemoteCustomization(s,i),s;const o=new b(.8,1.8,.8),n=new S({color:t||this.color,emissive:0,roughness:.7}),a=new g(o,n);return a.position.y=1,a.userData={gameId:e,gameName:"Player"},this.scene.add(a),this.others.set(e,a),a.userData&&(a.userData.custom=i?{...i}:null),this.applyRemoteCustomization(a,i),a}removeRemote(e){const t=this.others.get(e);if(t){if(t.userData&&t.userData.label&&t.userData.label.parentNode)try{t.userData.label.parentNode.removeChild(t.userData.label)}catch{}try{this.scene.remove(t)}catch{}this.others.delete(e)}this.remoteStates.delete(e)}killRemote(e){const t=this.others.get(e);if(t){try{t.rotation.x=-Math.PI/2,t.userData.dead=!0}catch{}setTimeout(()=>{this.removeRemote(e)},3500)}}clonePlayerAvatar(e=null){if(!this.player||!this.player.mesh)return null;try{const t=this.player.mesh.clone(!0),i={leftArm:null,rightArm:null,leftLeg:null,rightLeg:null};return t.traverse(s=>{if(s.isMesh&&(s.castShadow=!0,s.receiveShadow=!0,s.material&&s.material.clone&&(s.material=s.material.clone()),s.geometry&&s.geometry.clone&&(s.geometry=s.geometry.clone()),e&&s.material&&!Array.isArray(s.material))){const o=s.userData&&s.userData.gameName?s.userData.gameName.toLowerCase():"";(o.includes("body")||o.includes("torso")||o.includes("shirt")||o.includes("clothes")||s.geometry&&s.geometry.parameters&&Math.abs(s.geometry.parameters.width-.6)<.05)&&(s.material=s.material.clone(),s.material.color=new ne(e))}s.userData&&(s.userData={...s.userData}),s.name==="leftArmPivot"?i.leftArm=s:s.name==="rightArmPivot"?i.rightArm=s:s.name==="leftLegPivot"?i.leftLeg=s:s.name==="rightLegPivot"&&(i.rightLeg=s)}),t.userData={...t.userData||{},pivots:i},t}catch(t){return console.warn("Failed to clone player avatar:",t),null}}applyRemoteAnimation(e,t){var s,o,n,a;if(!t||!e||!e.userData)return;const i=e.userData.pivots||{};try{i.leftArm&&typeof((s=t==null?void 0:t.arms)==null?void 0:s.leftX)=="number"&&(i.leftArm.rotation.x=t.arms.leftX),i.rightArm&&typeof((o=t==null?void 0:t.arms)==null?void 0:o.rightX)=="number"&&(i.rightArm.rotation.x=t.arms.rightX),i.leftLeg&&typeof((n=t==null?void 0:t.legs)==null?void 0:n.leftX)=="number"&&(i.leftLeg.rotation.x=t.legs.leftX),i.rightLeg&&typeof((a=t==null?void 0:t.legs)==null?void 0:a.rightX)=="number"&&(i.rightLeg.rotation.x=t.legs.rightX)}catch{}}update(e){var d,p,m;if(this.updateRemoteInterpolation(),this.sampleNetRates(),!this.socket||this.socket.readyState!==WebSocket.OPEN||(this.lastSend+=e,this.heartbeatTimer+=e,this.player&&!this.player.isDead&&(this.lastPingSent+=e,this.lastPingSent>=this.pingInterval&&(this.sendPing(),this.lastPingSent=0)),this.lastSend<this.sendInterval)||(this.lastSend=0,!this.player||!this.player.mesh)||this.player.isDead)return;const t=this.player.mesh.position,i={arms:{leftX:this.player.leftArmPivot?this.player.leftArmPivot.rotation.x:0,rightX:this.player.rightArmPivot?this.player.rightArmPivot.rotation.x:0},legs:{leftX:this.player.leftLegPivot?this.player.leftLegPivot.rotation.x:0,rightX:this.player.rightLegPivot?this.player.rightLegPivot.rotation.x:0}};let s=0,o={x:0,z:1};if(this.player&&this.player.camera&&this.player.camera.getWorldDirection){const u=new T;this.player.camera.getWorldDirection(u),u.y=0,u.lengthSq()<1e-6&&this.player.mesh&&this.player.mesh.rotation?(s=this.player.mesh.rotation.y,o={x:Math.sin(s),z:Math.cos(s)}):(u.normalize(),s=Math.atan2(u.x,u.z),o={x:u.x,z:u.z})}else{const u=typeof this.player.yaw=="number"?this.player.yaw:this.player.mesh&&this.player.mesh.rotation?this.player.mesh.rotation.y:0;s=this._wrapAngle(u),o={x:Math.sin(s),z:Math.cos(s)}}s=this._wrapAngle(s+Math.PI),o={x:Math.sin(s),z:Math.cos(s)};const n={type:"state",pos:{x:t.x,y:t.y,z:t.z},rot:s,fwd:o,nick:this.nick,color:this.color,anim:i,ts:this._now(),custom:{...this.getCustomization()}};let a=!1;this.lastSentPos?t.distanceTo?a=t.distanceTo(new T(this.lastSentPos.x,this.lastSentPos.y,this.lastSentPos.z))>.015:a=Math.abs(t.x-(((d=this.lastSentPos)==null?void 0:d.x)||0))>.015||Math.abs(t.y-(((p=this.lastSentPos)==null?void 0:p.y)||0))>.015||Math.abs(t.z-(((m=this.lastSentPos)==null?void 0:m.z)||0))>.015:a=!0;const l=`${i.arms.leftX.toFixed(3)},${i.arms.rightX.toFixed(3)},${i.legs.leftX.toFixed(3)},${i.legs.rightX.toFixed(3)}`,h=this.lastAnimSig!==l,r=Math.abs(this._angleDiff(this.lastSentRot??s,s))>.02,c=this.heartbeatTimer>=5;if(a||h||r||c){const u=JSON.stringify(n);try{this.socket.send(u)}catch{}this.trackTx(u.length),this.lastSentPos={x:t.x,y:t.y,z:t.z},this.lastAnimSig=l,this.lastSentRot=s,c&&(this.heartbeatTimer=0)}}dispose(){if(this._manualClose=!0,this.socket)try{this.socket.close()}catch{}this.others.forEach(e=>{try{this.scene.remove(e)}catch{}}),this.others.clear()}updateLabel(e,t){if(e.userData&&e.userData.label)try{e.userData.label.style.display="none"}catch{}e.userData&&(e.userData.nick=t||"Player")}sendHit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const s=JSON.stringify({type:"hit",targetId:e,amount:t});try{this.socket.send(s)}catch{}this.trackTx(s.length)}getPeerCount(){return 1+this.others.size}sendJoin(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify({type:"join",room:this.roomCode,nick:this.nick,color:this.color,custom:this.getCustomization()});this.socket.send(e),this.trackTx(e.length)}catch{}}sendStart(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify({type:"start"});this.socket.send(e),this.trackTx(e.length)}catch{}}sendSettings(e){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&!(!this.isHost||!e))try{const t=JSON.stringify({type:"settings",settings:e});this.socket.send(t),this.trackTx(t.length)}catch{}}sendDeath(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&this.id)try{const e=JSON.stringify({type:"player-dead",id:this.id});this.socket.send(e),this.trackTx(e.length)}catch{}}isMatchLive(){return this.matchLive===!0}resetMatchState(){this.deadPeers.clear(),this.matchLive=!1}bufferRemoteState(e,t){if(!e||!t)return;const i=this.remoteStates.get(e)||[];if(typeof t.rot=="number"){const s=this.remoteLastYaw.get(e),o=this._unwrapAngle(t.rot,s);t.rot=o,this.remoteLastYaw.set(e,o)}for(i.push(t);i.length>24;)i.shift();this.remoteStates.set(e,i)}applyRemoteCustomization(e,t){if(!e||!t)return;const i=e.getObjectByName("playerHead");if(!i)return;this.removeNodesByRole(i,"playerMouth");const s=this._buildMouthMesh(t.mouthStyle||"serious");s&&i.add(s),this.setHatVisibility(i,t.showHat!==!1)}removeNodesByRole(e,t){if(!e)return;const i=[];e.traverse(s=>{s.userData&&s.userData.role===t&&i.push(s)}),i.forEach(s=>{s.parent&&s.parent.remove(s)})}setHatVisibility(e,t){e&&e.traverse(i=>{i.userData&&i.userData.role==="playerHat"&&(i.visible=t)})}_buildMouthMesh(e){const t=(e||"serious").toLowerCase(),i=new S({color:2824976,roughness:.6,metalness:0});let s=null;if(t==="smile"){const o=new O;o.userData={role:"playerMouth"},o.name="playerMouth";const n=i.clone(),a=new g(new b(.08,.04,.02),n),l=a.clone(),h=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,l.position.set(0,-.16,.26),h.position.set(.1,-.15,.26),h.rotation.z=.2,[a,l,h].forEach(r=>{r.userData={role:"playerMouth"},r.name="playerMouthSeg"}),o.add(a,l,h),s=o}else if(t==="angry"){const o=new S({color:5901324,roughness:.4});s=new g(new b(.26,.05,.02),o),s.position.set(0,-.16,.26),s.rotation.z=-.18}else if(t==="surprised")s=new g(new ie(.06,.06,.02,20),i),s.position.set(0,-.14,.26),s.rotation.x=Math.PI/2;else{if(t==="none")return null;s=new g(new b(.22,.06,.02),i),s.position.set(0,-.16,.26)}return s.castShadow=!1,s.receiveShadow=!1,s.userData||(s.userData={}),s.userData.role="playerMouth",s.name=s.name||"playerMouth",s}updateRemoteInterpolation(){if(!this.remoteStates||this.remoteStates.size===0)return;const t=this._now()-this.interpDelayMs;this.remoteStates.forEach((i,s)=>{var C,_,F,V,G,Y,q,se,K,J,Z,ae,re,oe,ce,ee,j,de;if(!i||i.length===0)return;const o=this.others.get(s);if(!o)return;for(;i.length>2&&t-i[0].t>this.maxBufferMs;)i.shift();const n=i[i.length-1];let a=i[0],l=n;for(let R=1;R<i.length;R++)if(i[R].t>=t){a=i[R-1]||i[R],l=i[R];break}const h=l.t-a.t;let r=h>0?(t-a.t)/h:1;if(t>n.t&&t-n.t<=this.maxExtrapMs&&i.length>=2){const R=i[i.length-2],Q=Math.max(1,n.t-R.t),me=(n.pos.x-R.pos.x)/Q,pe=(n.pos.y-R.pos.y)/Q,fe=(n.pos.z-R.pos.z)/Q,he=t-n.t;this._tmpVec.set(n.pos.x+me*he,n.pos.y+pe*he,n.pos.z+fe*he),o.position.copy(this._tmpVec),o.rotation&&(typeof n.rot=="number"?o.rotation.y=this._wrapAngle(n.rot+this.remoteFaceOffset):n.fwd&&typeof n.fwd.x=="number"&&typeof n.fwd.z=="number"&&(o.rotation.y=this._wrapAngle(Math.atan2(n.fwd.x,n.fwd.z)+this.remoteFaceOffset))),this.applyRemoteAnimation(o,n.anim),this.updateLabel(o,n.nick);return}r=Math.min(1,Math.max(0,r));const c=((C=a.pos)==null?void 0:C.x)??0,d=((_=a.pos)==null?void 0:_.y)??0,p=((F=a.pos)==null?void 0:F.z)??0,m=((V=l.pos)==null?void 0:V.x)??c,u=((G=l.pos)==null?void 0:G.y)??d,w=((Y=l.pos)==null?void 0:Y.z)??p;this._tmpVec.set(c+(m-c)*r,d+(u-d)*r,p+(w-p)*r),o.position.copy(this._tmpVec);const E=typeof a.rot=="number"?a.rot:typeof((q=a.fwd)==null?void 0:q.x)=="number"&&typeof((se=a.fwd)==null?void 0:se.z)=="number"?Math.atan2(a.fwd.x,a.fwd.z):o.rotation.y||0,x=typeof l.rot=="number"?l.rot:typeof((K=l.fwd)==null?void 0:K.x)=="number"&&typeof((J=l.fwd)==null?void 0:J.z)=="number"?Math.atan2(l.fwd.x,l.fwd.z):E,k=E+this.remoteFaceOffset,D=x+this.remoteFaceOffset,v=R=>{for(;R>Math.PI;)R-=Math.PI*2;for(;R<-Math.PI;)R+=Math.PI*2;return R},P=D-k,L=k+P*r;o.rotation&&(o.rotation.y=v(L+this.remoteFaceOffset));const z=(R,Q)=>(typeof R!="number"&&(R=0),typeof Q!="number"&&(Q=R),R+(Q-R)*r),y=a.anim||{},M=l.anim||{},B={arms:{leftX:z((Z=y==null?void 0:y.arms)==null?void 0:Z.leftX,(ae=M==null?void 0:M.arms)==null?void 0:ae.leftX),rightX:z((re=y==null?void 0:y.arms)==null?void 0:re.rightX,(oe=M==null?void 0:M.arms)==null?void 0:oe.rightX)},legs:{leftX:z((ce=y==null?void 0:y.legs)==null?void 0:ce.leftX,(ee=M==null?void 0:M.legs)==null?void 0:ee.leftX),rightX:z((j=y==null?void 0:y.legs)==null?void 0:j.rightX,(de=M==null?void 0:M.legs)==null?void 0:de.rightX)}};this.applyRemoteAnimation(o,B);const I=l.custom||a.custom||(o.userData?o.userData.custom:null);this.applyRemoteCustomization(o,I),o.userData&&(o.userData.custom=I?{...I}:null),this.updateLabel(o,l.nick||a.nick)})}sendPing(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return;const e={type:"ping",ts:this._now()},t=JSON.stringify(e);try{this.socket.send(t)}catch{}this.trackTx(t.length)}trackTx(e){!e||e<=0||(this.netStats.txBytes+=e)}sendZombieHit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const i=JSON.stringify({type:"zombie-hit",id:e,amount:t});try{this.socket.send(i)}catch{}this.trackTx(i.length)}sendZombieState(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const i=JSON.stringify({type:"zombie-state",id:e,health:t});try{this.socket.send(i)}catch{}this.trackTx(i.length)}trackRx(e){!e||e<=0||(this.netStats.rxBytes+=e)}sampleNetRates(){const e=this._now(),t=e-this.netStats.lastSample;if(t<1e3)return;const i=t/1e3,s=this.netStats.txBytes/i,o=this.netStats.rxBytes/i;for(this.netStats.txPerSec=s,this.netStats.rxPerSec=o,this.netStats.history.push({t:e,tx:s,rx:o,ping:this.netStats.lastPing||null});this.netStats.history.length>60;)this.netStats.history.shift();this.netStats.txBytes=0,this.netStats.rxBytes=0,this.netStats.lastSample=e}getNetStats(){return this.netStats}getCustomization(){return this.player?{mouthStyle:this.player.mouthStyle||"serious",showHat:this.player.showHat!==!1}:{mouthStyle:"serious",showHat:!0}}setEnemyManager(e){this.enemyManager=e}_wrapAngle(e){let t=e;for(;t>Math.PI;)t-=Math.PI*2;for(;t<-Math.PI;)t+=Math.PI*2;return t}_angleDiff(e,t){return this._wrapAngle(e-t)}_unwrapAngle(e,t){if(typeof t!="number")return e;let i=e,s=i-t;for(;s>Math.PI;)i-=Math.PI*2,s=i-t;for(;s<-Math.PI;)i+=Math.PI*2,s=i-t;return i}}function hi({maxLines:H=400,autoShow:e=!1}={}){const t=[],i={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)},s=document.createElement("div");s.id="debug-overlay",s.className="debug-overlay hidden";const o=document.createElement("div");o.className="debug-overlay-header",o.innerHTML="<strong>DEBUG</strong>";const n=document.createElement("div");n.className="debug-overlay-actions";const a=document.createElement("button");a.textContent="Clear";const l=document.createElement("button");l.textContent="Close",n.appendChild(a),n.appendChild(l),o.appendChild(n);const h=document.createElement("div");h.className="debug-overlay-list",s.appendChild(o),s.appendChild(h),document.body.appendChild(s),o.style.cursor="move";let r=!1,c=0,d=0;function p(v){if(!r)return;const P=Math.max(0,Math.min(window.innerWidth-s.offsetWidth,v.clientX-c)),L=Math.max(0,Math.min(window.innerHeight-s.offsetHeight,v.clientY-d));s.style.left=P+"px",s.style.top=L+"px",s.style.right="auto"}function m(v){r=!1,window.removeEventListener("pointermove",p),window.removeEventListener("pointerup",m);try{v&&v.pointerId&&s.releasePointerCapture&&s.releasePointerCapture(v.pointerId)}catch{}}o.addEventListener("pointerdown",v=>{try{const P=s.getBoundingClientRect();s.style.left=P.left+"px",s.style.top=P.top+"px",s.style.position="fixed",s.style.transform="none",s.style.right="auto",c=v.clientX-P.left,d=v.clientY-P.top,r=!0,window.addEventListener("pointermove",p),window.addEventListener("pointerup",m);try{s.setPointerCapture&&s.setPointerCapture(v.pointerId)}catch{}}catch{}},{passive:!1});function u(){h.innerHTML="";const v=Math.max(0,t.length-H);for(let P=v;P<t.length;P++){const L=document.createElement("div");L.className="debug-line debug-"+t[P].level;const z=new Date(t[P].ts).toLocaleTimeString();L.textContent=`[${z}] ${t[P].level.toUpperCase()}: ${t[P].msg}`,h.appendChild(L)}h.scrollTop=h.scrollHeight}function w(v,P){try{const L=P.map(z=>{try{return typeof z=="string"?z:JSON.stringify(z)}catch{return String(z)}}).join(" ");t.push({level:v,msg:L,ts:Date.now()}),t.length>H*2&&t.splice(0,t.length-H*2),u()}catch{}}console.log=function(...v){i.log(...v),w("log",v)},console.info=function(...v){i.info(...v),w("info",v)},console.warn=function(...v){i.warn(...v),w("warn",v)},console.error=function(...v){i.error(...v),w("error",v)};function E(v,P,L,z,y){typeof v=="string"?w("error",[v+" "+(P||"")+":"+(L||"?")]):v&&v.message&&w("error",[v.message,v.error||y])}function x(v){try{w("error",["UnhandledRejection",v&&v.reason?v.reason:v])}catch{}}window.addEventListener("error",E),window.addEventListener("unhandledrejection",x),a.addEventListener("click",()=>{t.length=0,u()}),l.addEventListener("click",()=>D());function k(){s.classList.remove("hidden")}function D(){s.classList.add("hidden")}return e&&k(),{show:k,hide:D,destroy(){console.log=i.log,console.info=i.info,console.warn=i.warn,console.error=i.error,window.removeEventListener("error",E),window.removeEventListener("unhandledrejection",x);try{s.remove()}catch{}},logs:t}}const ue=(()=>{try{return typeof navigator>"u"?!1:/Mobi|Android|iPhone|iPad|Tablet|Mobile/i.test(navigator.userAgent)||window.matchMedia&&window.matchMedia("(pointer: coarse)").matches}catch{return!1}})();window.addEventListener("unhandledrejection",H=>{try{const e=H.reason,t=e&&e.message?e.message:String(e);if(t&&t.includes("If you see this error we have a bug")){console.warn("Suppressed Chromium UnknownError:",t),H.preventDefault&&H.preventDefault();return}}catch{}});class Te{constructor(){this.scene=new Mt,this.scene.background=new ne(8900331),this.scene.fog=new bt(8900331,20,100),this._animationStarted=!1,this._selectedMode="arcade",this._defaultRandom=Math.random,this._currentRandomSeed=null,this.matchSettings=null,this.lastPlaySettings=null,this.aiObjects=[],this.aiMaxAiObjects=200,this.renderer=new St({antialias:!0});const e=ue?1:1.5;this.renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,e)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=xt,document.getElementById("game-container").appendChild(this.renderer.domElement),this._renderScaleApplied=this.renderer.getPixelRatio(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.forceFixedMultiplayerSpawn=!1;const t=new Ne(16777215,.6);this.scene.add(t);const i=new Ce(16777215,.8);i.position.set(50,100,50),i.castShadow=!0,i.shadow.camera.left=-100,i.shadow.camera.right=100,i.shadow.camera.top=100,i.shadow.camera.bottom=-100,i.shadow.camera.near=.1,i.shadow.camera.far=160,i.shadow.mapSize.width=1024,i.shadow.mapSize.height=1024,this.scene.add(i),this.dirLight=i,this.camera=new kt(75,window.innerWidth/window.innerHeight,.1,1e3),this.clock=new Et,this._pickRaycaster=new $,this._objectClickHandler=null,this._objectClickTarget=null,this._longPressTimer=null,this.hotkeyModalVisible=!1,this.isPaused=!1,this.pauseMenu=document.getElementById("pause-menu"),this.bgAudio=null,this.bgMusicVolume=.5,this._endSequenceAudio=null,this._prevBgVolume=null,this.autoPerfEnabled=!1,this._autoPerfTimer=0,this._renderScaleApplied=1,this.sfxVolume=.7,document.addEventListener("keydown",s=>{if(s.code==="Escape"&&this.togglePause(),this.player&&this.player.gameMode==="studio")if(s.code==="KeyL")try{this.spawnStudioDrops()}catch(o){console.warn("Studio drop failed:",o)}else s.code==="KeyH"&&this.toggleHotkeyModal(!this.hotkeyModalVisible)}),this.setupMenu(),this.setupLongPressMenu(),this.setMenuOpenState(!0),document.addEventListener("pointerlockerror",s=>{s.preventDefault&&s.preventDefault(),console.warn("Pointer lock request failed or was cancelled.")})}applyGraphicsSettings(e={}){if(!this.renderer)return;const t=!!e.performanceMode,i=Math.max(.5,Math.min(1,(e.renderScale||100)/100)),s=ue?1:t?1.25:1.5,o=Math.min((window.devicePixelRatio||1)*i,s);this.renderer.setPixelRatio(o),this.renderer.setSize(window.innerWidth,window.innerHeight);const n=!t;if(this.renderer.shadowMap.enabled=n,this.dirLight&&this.dirLight.shadow){this.dirLight.castShadow=n;const a=t?512:1024;this.dirLight.shadow.mapSize.width=a,this.dirLight.shadow.mapSize.height=a}}applyDeterministicRandom(e){if(!e)return;this._currentRandomSeed=e;const t=String(e);let i=1779033703^t.length;for(let n=0;n<t.length;n++)i=Math.imul(i^t.charCodeAt(n),3432918353),i=i<<13|i>>>19;i=Math.imul(i^i>>>16,2246822507),i=(i^i>>>13)>>>0;let s=i;Math.random=()=>{s=s+1831565813|0;let n=Math.imul(s^s>>>15,1|s);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}spawnStudioDrops(){if(!(!this.itemManager||!this.player||this.player.gameMode!=="studio"))try{for(let e=0;e<3;e++)this.itemManager.spawnMatrixDropNearPlayer()}catch(e){console.warn("spawnStudioDrops error:",e)}}toggleHotkeyModal(e){const t=document.getElementById("hotkey-modal");t&&(t.classList.toggle("hidden",!e),t.setAttribute("aria-hidden",e?"false":"true"),this.hotkeyModalVisible=e)}toggleTouchLookArea(e){try{if(!this.touchControls)return;e?this.touchControls.lookArea?this.touchControls.lookArea.style.display="":this.touchControls.rebuildLookArea&&this.touchControls.rebuildLookArea():this.touchControls.destroyLookArea?this.touchControls.destroyLookArea():this.touchControls.lookArea&&(this.touchControls.lookArea.style.display="none")}catch{}}setHotbarVisible(e){const t=document.getElementById("hotbar");t&&(t.style.display=e?"flex":"none")}setMenuOpenState(e){document.body.classList.toggle("menu-open",!!e)}updateDebugToggleVisibility(e){const t=document.getElementById("debug-toggle-btn");if(t&&(t.classList.toggle("hidden",!e),!e&&window.debugOverlay&&typeof window.debugOverlay.hide=="function")){try{window.debugOverlay.hide()}catch{}try{localStorage.removeItem("showDebugOverlay")}catch{}}}assignMultiplayerSpawn(){if(!this.player||!this.world)return;const e=this.world&&typeof this.world.halfMapSize=="number"?this.world.halfMapSize-5:100;let t=null;const i=this._defaultRandom||Math.random;if(this.forceFixedMultiplayerSpawn)t={x:0,y:this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(0,0):0,z:0};else for(let s=0;s<12;s++){const o=(i()*2-1)*e,n=(i()*2-1)*e;let a=0;if(this.world&&typeof this.world.getHeightAt=="function"&&(a=this.world.getHeightAt(o,n)),!this.multiplayer||this.multiplayer.others.size===0||Array.from(this.multiplayer.others.values()).every(h=>{if(!h||!h.position)return!0;const r=h.position.x-o,c=h.position.z-n;return Math.sqrt(r*r+c*c)>15})){t={x:o,y:a,z:n};break}}t||(t={x:0,y:0,z:0}),this.player.mesh.position.set(t.x,t.y,t.z),this.player.controls&&this.player.controls.getObject&&this.player.controls.getObject().position.set(t.x,t.y+1.6,t.z),this.player.camera&&this.player.camera.position.set(t.x,t.y+1.6,t.z)}setupMultiplayerLobbyUI(){const e=document.getElementById("mp-lobby"),t=document.getElementById("mp-start-btn"),i=document.getElementById("mp-lobby-status");if(!e||!t||!i)return;e.classList.remove("hidden");const s=this.multiplayer&&this.multiplayer.roomCode?this.multiplayer.roomCode:"PUBLIC";i.innerText=`Waiting in lobby (Room: ${s})`,t.classList.toggle("hidden",!(this.multiplayer&&this.multiplayer.isHost)),t.onclick=()=>{if(!this.multiplayer||!this.multiplayer.isHost)return;const o=typeof this.multiplayer.getPeerCount=="function"?Math.max(0,this.multiplayer.getPeerCount()-1):0,n=this.enemyManager?typeof this.enemyManager.targetCount=="number"?this.enemyManager.targetCount:this.enemyManager.enemies?this.enemyManager.enemies.length:0:0;if(o<=0&&n<=0){alert("Need at least 1 remote player or 1 NPC zombie before starting the match.");return}this.beginLobbyCountdown(10),this.multiplayer.sendStart()},this.lobbyCountdown=0,this.updateLobbyUI(this.multiplayer?this.multiplayer.isHost:!1)}updateLobbyUI(e){const t=document.getElementById("mp-start-btn");t&&t.classList.toggle("hidden",!e)}beginLobbyCountdown(e=10){this.matchPhase="countdown",this.lobbyCountdown=e;const t=document.getElementById("mp-lobby"),i=document.getElementById("mp-lobby-countdown");t&&t.classList.remove("hidden"),i&&(i.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`)}startMultiplayerMatch(){this.matchPhase="live",this.multiplayer&&(this.multiplayer.matchLive=!0),this.refreshMultiplayerTargets();const e=document.getElementById("mp-lobby");e&&e.classList.add("hidden"),this.lobbyCountdown=0}checkMultiplayerVictory(){if(!this.multiplayer)return;const e=this.multiplayer.deadPeers||new Set;let t=0;this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach((o,n)=>{e.has(n)||o&&o.userData&&o.userData.dead||(t+=1)});const i=this.player&&!this.player.isDead;(i?1:0)+t===1&&i&&(this.hud&&typeof this.hud.showVictory=="function"&&this.hud.showVictory(),this.multiplayer&&(this.multiplayer.matchLive=!1))}setupMenu(){const e=document.getElementById("main-menu"),t=document.getElementById("play-btn"),i=document.getElementById("setting-difficulty"),s=document.getElementById("setting-enemies"),o=document.getElementById("setting-storm"),n=document.getElementById("setting-storm-enabled"),a=document.getElementById("setting-map-size"),l=document.getElementById("map-size-val"),h=document.getElementById("setting-debug"),r=document.getElementById("setting-minimap"),c=document.getElementById("setting-music-volume"),d=document.getElementById("setting-music-volume-val"),p=document.getElementById("setting-sfx-volume"),m=document.getElementById("setting-sfx-volume-val"),u=document.getElementById("setting-camera"),w=document.getElementById("setting-mouth-style"),E=document.getElementById("setting-show-hat"),x=document.getElementById("setting-performance-mode"),k=document.getElementById("setting-auto-performance"),D=document.getElementById("setting-render-scale"),v=document.getElementById("render-scale-val"),P=document.getElementById("setting-touch-controls"),L=document.getElementById("setting-fullscreen"),z=document.getElementById("setting-game-mode"),y=document.getElementById("quit-btn"),M=document.getElementById("active-mode-label"),B=document.getElementById("active-mode-chip"),I=document.getElementById("float-btn"),C=document.getElementById("setting-openai-key"),_=document.getElementById("setting-groq-key"),F=document.getElementById("setting-nvidia-key"),V=document.getElementById("setting-mp-server"),G=document.getElementById("setting-mp-seed"),Y=document.getElementById("setting-mp-room"),q=document.getElementById("mp-room-generate"),se=document.getElementById("setting-mp-nickname"),K=document.getElementById("setting-mp-color"),J=document.getElementById("setting-mp-zombies"),Z=document.getElementById("setting-mp-fixed-spawn"),ae=document.getElementById("setting-language"),re=document.getElementById("hotkey-hint"),oe=document.getElementById("hotkey-modal"),ce=document.getElementById("hotkey-modal-close"),ee=document.getElementById("setting-arena-time"),j=document.getElementById("arena-time-val"),de=document.getElementById("setting-arena-respawn"),R=document.getElementById("setting-matrix-infinite-ammo"),Q=document.getElementById("setting-matrix-show-ui"),me=document.getElementById("setting-matrix-ai-autospawn"),pe=document.getElementById("setting-matrix-ai-hints"),fe=document.getElementById("setting-studio-flight"),he=document.getElementById("setting-studio-show-grid"),Ye=document.getElementById("dash-toggle"),$e=document.getElementById("perf-toggle"),Le=document.getElementById("enemy-count-val"),ze=document.getElementById("storm-time-val"),ge=(f,A)=>{if(!f||!A)return;const N=()=>{A.innerText=f.value};f.addEventListener("input",N),f.addEventListener("change",N),N()},Se=(f,A)=>{if(!(typeof window>"u"||!window.localStorage))try{const N=window.localStorage.getItem("voxel-firecraft-settings"),W=N?JSON.parse(N):{};W[f]=A,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(W))}catch{}},_e=(f,A)=>{f&&(f.addEventListener("pointerdown",N=>{try{N.preventDefault(),N.stopPropagation()}catch{}}),f.addEventListener("click",N=>{try{N.preventDefault(),N.stopPropagation()}catch{}const W=document.getElementById(A);if(!W)return;const le=W.classList.toggle("collapsed");Array.from(W.children).forEach(Be=>{Be!==f&&(Be.style.display=le?"none":"")}),f.innerText=le?"+":""}))};_e(Ye,"dashboard"),_e($e,"perf-dashboard");const He=localStorage.getItem("voxel-firecraft-settings");if(He){const f=JSON.parse(He);if(f.gameMode==="survival"&&(f.gameMode="arcade"),i.value=f.difficulty,s.value=f.enemyCount,o.value=f.stormTime,Le.innerText=f.enemyCount,ze.innerText=f.stormTime,n&&(n.checked=f.stormEnabled!==!1),a&&l){const A=f.mapSize||ke;a.value=A,l.innerText=A}if(f.debugMode&&(h.checked=!0),r&&(r.checked=f.showMinimap!==!1),L&&(L.checked=!!f.fullscreen),f.musicVolume!==void 0&&c&&d){const A=parseInt(f.musicVolume,10);c.value=A,d.innerText=A,this.bgMusicVolume=A/100}if(p&&m&&f.sfxVolume!==void 0){const A=parseInt(f.sfxVolume,10);p.value=A,m.innerText=A,this.sfxVolume=A/100}if(f.cameraMode&&(u.value=f.cameraMode),w&&f.mouthStyle&&(w.value=f.mouthStyle),E&&(E.checked=f.showHat!==!1),x&&(x.checked=!!f.performanceMode),k&&(k.checked=!!f.autoPerformance),D&&v){const A=f.renderScale||100;D.value=A,v.innerText=A}if(f.useTouchControls!==void 0&&P&&(P.checked=!!f.useTouchControls),f.gameMode&&z&&(z.value=f.gameMode),f.gameMode&&(this._selectedMode=f.gameMode),ae&&f.language&&(ae.value=f.language),C&&(C.value=f.openaiKey||""),_&&(_.value=f.groqKey||""),F&&(F.value=f.nvidiaKey||""),V&&(V.value=f.mpServer||""),G&&(G.value=f.mpSeed||""),Y&&(Y.value=f.mpRoom||""),se&&(se.value=f.mpNick||""),K&&(K.value=f.mpColor||"#29b6f6"),J&&(J.checked=f.mpZombies!==!1),Z&&(Z.checked=!!f.mpFixedSpawn),ee&&j){const A=f.arenaTime||parseInt(ee.value,10)||180;ee.value=A,j.innerText=A}de&&(de.checked=f.arenaRespawn!==!1),R&&(R.checked=f.matrixInfiniteAmmo!==!1),Q&&(Q.checked=f.matrixShowUI!==!1),me&&(me.checked=f.matrixAiAutospawn!==!1),pe&&(pe.checked=f.matrixAiHints!==!1),fe&&(fe.checked=f.studioFlight!==!1),he&&(he.checked=f.studioShowGrid!==!1)}ge(s,Le),ge(o,ze),ge(a,l),ge(ee,j),ge(D,v),ge(p,m),k&&k.addEventListener("change",()=>{const f=this.lastPlaySettings||{};f.autoPerformance=k.checked,this.autoPerfEnabled=f.autoPerformance,Se("autoPerformance",f.autoPerformance)}),x&&x.addEventListener("change",()=>{const f=this.lastPlaySettings||{};f.performanceMode=x.checked,this.applyGraphicsSettings(f),Se("performanceMode",x.checked)}),D&&D.addEventListener("change",()=>{const f=this.lastPlaySettings||{};f.renderScale=parseInt(D.value,10),this.applyGraphicsSettings(f),Se("renderScale",f.renderScale)}),E&&E.addEventListener("change",()=>{this.player&&typeof this.player.setHatVisible=="function"&&this.player.setHatVisible(E.checked),Se("showHat",E.checked)}),t.onclick=()=>{const f=this._selectedMode||"arcade";if(f==="multiplayer"&&this.multiplayer&&!this.multiplayer.isHost&&!this.multiplayer.roomSettings){alert("Waiting for host settings. Please try again in a moment.");return}const A={difficulty:f==="survival"?document.getElementById("setting-survival-difficulty")?document.getElementById("setting-survival-difficulty").value:"medium":i.value,enemyCount:parseInt(s.value),stormTime:parseInt(o.value),stormEnabled:n?n.checked:!0,mapSize:a?parseInt(a.value):ke,debugMode:h.checked,showMinimap:r?r.checked:!0,musicVolume:c?parseInt(c.value):Math.round(this.bgMusicVolume*100),musicEnabled:document.getElementById("setting-music-enabled")?document.getElementById("setting-music-enabled").checked:!0,cameraMode:u.value,mouthStyle:w?w.value:"serious",showHat:E?E.checked:!0,performanceMode:x?x.checked:!1,autoPerformance:k?k.checked:!1,renderScale:D?parseInt(D.value,10):100,sfxVolume:p?parseInt(p.value,10):70,language:ae?ae.value:"en",useTouchControls:P?P.checked:!1,fullscreen:L?L.checked:!1,gameMode:f,openaiKey:C?C.value:"",groqKey:_?_.value:"",nvidiaKey:F?F.value:"",mpServer:V?V.value:"",mpSeed:G?G.value.trim():"",mpRoom:Y?Y.value:"",mpNick:se?se.value:"",mpColor:K?K.value:"#29b6f6",mpZombies:J?J.checked:!0,mpFixedSpawn:Z?Z.checked:!1,arenaTime:ee?parseInt(ee.value,10):180,arenaRespawn:de?de.checked:!0,matrixInfiniteAmmo:R?R.checked:!0,matrixShowUI:Q?Q.checked:!0,matrixAiAutospawn:me?me.checked:!0,matrixAiHints:pe?pe.checked:!0,studioFlight:fe?fe.checked:!0,studioShowGrid:he?he.checked:!0};this.lastPlaySettings=A,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(A)),this.updateDebugToggleVisibility(A.debugMode),this.applyGraphicsSettings(A),e.style.display="none",this.setMenuOpenState(!1),A.musicEnabled!==!1?this.playBackgroundMusic():this.stopBackgroundMusic(),this.requestFullscreenIfNeeded(A.fullscreen);const N=this.player&&this.world&&this.enemyManager,W=N&&this.player&&this.player.gameMode===f;if(N&&!W&&this.resetGameState(),this.player&&this.world&&this.enemyManager&&W){if(this.isPaused=!1,this.clock.getDelta(),t.innerText="PLAY GAME",this.player)try{this.player.lockControls()}catch{}if(this.hud&&(this.hud.settings=A),this.world){this.world.stormEnabled=A.stormEnabled!==!1;const le=this.world.stormEnabled&&this.world.gameMode!=="matrix"&&this.world.gameMode!=="studio"&&this.world.gameMode!=="matrix-ai";this.world.stormMesh?this.world.stormMesh.visible=le:le&&typeof this.world.createStormVisuals=="function"&&this.world.createStormVisuals()}this.player&&(this.player.mouthStyle=A.mouthStyle||"serious",typeof this.player.createMouth=="function"&&this.player.createMouth(this.player.mouthStyle)),this.setHotbarVisible(!0)}else t.innerText="PLAY GAME",this.startGame(A);if(re){const le=A&&A.gameMode==="studio";re.classList.toggle("hidden",!le)}},y&&(y.onclick=()=>{this.multiplayer&&typeof this.multiplayer.dispose=="function"&&this.multiplayer.dispose(),location.reload()}),I&&I.classList.add("hidden"),q&&Y&&(q.onclick=()=>{const f=Math.random().toString(36).substr(2,5).toUpperCase();Y.value=f;try{const A=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");A.mpRoom=f,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(A))}catch{}}),re&&(re.onclick=()=>this.toggleHotkeyModal(!0)),ce&&(ce.onclick=()=>this.toggleHotkeyModal(!1)),oe&&oe.addEventListener("click",f=>{f.target===oe&&this.toggleHotkeyModal(!1)}),c&&(c.oninput=()=>{const f=parseInt(c.value,10);if(d&&(d.innerText=f),this.bgMusicVolume=f/100,this.bgAudio)try{this.bgAudio.volume=this.bgMusicVolume}catch{}});const De=document.getElementById("setting-music-enabled");De&&(De.onchange=()=>{De.checked?this.playBackgroundMusic():this.stopBackgroundMusic()}),P&&(P.onchange=()=>{try{const f=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");f.useTouchControls=P.checked,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(f))}catch{}}),this.setHotbarVisible(!1),this.setMenuOpenState(!0);const be=Array.from(document.querySelectorAll(".tab-btn")),qe=document.querySelectorAll(".tab-panel"),Re=f=>{if(!f)return;const A=f.getAttribute("data-tab");be.forEach(W=>W.classList.toggle("active",W===f)),qe.forEach(W=>{W.id===A?W.classList.remove("hidden"):W.classList.add("hidden")});const N=f.getAttribute("data-mode");N&&z&&(z.value=N,M&&(M.innerText=f.innerText),B&&(B.innerText=f.innerText)),N&&(this._selectedMode=N)};be.forEach(f=>f.addEventListener("click",()=>Re(f)));const Oe=this._selectedMode||(z?z.value:null),Ke=(Oe?be.find(f=>f.getAttribute("data-mode")===Oe):null)||be.find(f=>f.classList.contains("active"))||be[0];Re(Ke)}resetGameState(){if(this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState(),this.multiplayer&&typeof this.multiplayer.dispose=="function")try{this.multiplayer.dispose()}catch(e){console.warn("Dispose multiplayer failed:",e)}this.multiplayer=null,this.multiplayerEnemyBaseCount=0,this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.isPaused=!1,this.forceFixedMultiplayerSpawn=!1,this.matchSettings=null;try{this.scene.clear()}catch(e){console.warn("Scene clear failed:",e)}try{const e=new Ne(16777215,.6);this.scene.add(e);const t=new Ce(16777215,.8);t.position.set(50,100,50),t.castShadow=!0,t.shadow.camera.left=-100,t.shadow.camera.right=100,t.shadow.camera.top=100,t.shadow.camera.bottom=-100,t.shadow.camera.near=.1,t.shadow.camera.far=160,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,this.scene.add(t)}catch(e){console.warn("Rebuild lights failed:",e)}this.player=null,this.world=null,this.enemyManager=null,this.itemManager=null,this.hud=null,this.matchSettings=null,this.lastPlaySettings=null,Math.random=this._defaultRandom,this._currentRandomSeed=null,this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState()}startGame(e){this.clearAiObjects(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.victoryShown=!1;const t={...e};if(this.forceFixedMultiplayerSpawn=t.gameMode==="multiplayer"?!!e.mpFixedSpawn:!1,t.gameMode==="multiplayer"){const h=this.multiplayer&&!this.multiplayer.isHost&&this.multiplayer.roomSettings?this.multiplayer.roomSettings:null;if(!this.multiplayer||this.multiplayer.isHost||!h){const r=e.mpSeed||Math.random().toString(36).slice(2);this.matchSettings={mapSize:e.mapSize,enemyCount:e.enemyCount,stormEnabled:!1,seed:r,fixedSpawn:!!e.mpFixedSpawn}}else this.matchSettings=h;this.matchSettings&&(t.mapSize=this.matchSettings.mapSize,t.enemyCount=this.matchSettings.enemyCount,t.stormEnabled=this.matchSettings.stormEnabled,this.forceFixedMultiplayerSpawn=!!this.matchSettings.fixedSpawn,this.applyDeterministicRandom(this.matchSettings.seed||"mp-seed"))}if((t.gameMode==="matrix"||t.gameMode==="studio")&&(t.enemyCount=0,t.skipLoot=!0),t.gameMode==="multiplayer"&&(t.skipLoot=!0,t.stormEnabled=!1,e.mpZombies===!1&&(t.enemyCount=0)),t.gameMode==="survival"&&(t.stormEnabled=!1,t.mapSize=Math.max(100,t.mapSize)),this.survivalStartTime=performance.now(),this.survivalTime=0,this.lootDropEligible=!1,this.lootDropCooldown=0,this.multiplayerEnemyBaseCount=t.enemyCount||0,this.player=new Ae(this.camera,this.scene,null,t),typeof e.sfxVolume<"u"&&(this.player.sfxVolume=Math.max(0,Math.min(1,e.sfxVolume/100))),e&&e.mpColor){if(this.player.playerColor=e.mpColor,this.player.mesh)try{this.scene.remove(this.player.mesh)}catch{}this.player.createPlayerMesh()}this.player&&(this.player.setHatVisible(e.showHat!==!1),this.player.mouthStyle=e.mouthStyle||"serious",this.player.createMouth(this.player.mouthStyle)),t.gameMode==="multiplayer"?(this.matchPhase="lobby",this.multiplayer&&(this.multiplayer.matchLive=!1)):this.matchPhase="live",this.itemManager=new ni(this.scene,this.player,t),this.world=new jt(this.scene,this.itemManager,t),this.player.worldObjects=this.world.objects,this.player.world=this.world,this.itemManager&&typeof this.itemManager.setWorld=="function"&&this.itemManager.setWorld(this.world);const i=document.getElementById("mp-lobby"),s=document.getElementById("mp-start-btn");if(i&&i.classList.add("hidden"),s&&s.classList.add("hidden"),t.gameMode==="matrix"&&this.itemManager&&typeof this.itemManager.spawnMatrixLoadout=="function"&&this.itemManager.spawnMatrixLoadout(this.player.position.x,this.player.position.z),t.gameMode==="multiplayer"&&this.assignMultiplayerSpawn(),t.gameMode==="multiplayer"?(this.multiplayer=new ri({player:this.player,scene:this.scene,url:e.mpServer,nick:e.mpNick||"Player",color:e.mpColor||"#29b6f6",roomCode:e.mpRoom||"PUBLIC",settings:this.matchSettings}),e.mpServer||alert("Multiplayer server URL not set. Please configure it in the Multiplayer tab."),this.player&&typeof this.player.setMultiplayerClient=="function"&&this.player.setMultiplayerClient(this.multiplayer),this.multiplayer&&(this.multiplayer.onPeersChanged=()=>this.refreshMultiplayerTargets(),this.multiplayer.roomCode=e.mpRoom||"PUBLIC",this.multiplayer.onHostChanged=h=>{this.updateLobbyUI(h),h&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings)},this.multiplayer.onCountdown=h=>this.beginLobbyCountdown(h),this.multiplayer.onMatchStart=()=>this.startMultiplayerMatch(),this.multiplayer.onSettings=h=>{this.matchSettings=h;const r=this.multiplayer&&this.multiplayer.isHost,d=this.player&&this.player.gameMode==="multiplayer"&&h&&(this.world&&this.world.mapSize!==h.mapSize||this.multiplayerEnemyBaseCount!==h.enemyCount);if(!r&&h&&d&&this.lastPlaySettings){const p={...this.lastPlaySettings,mapSize:h.mapSize,enemyCount:h.enemyCount};this.resetGameState(),this.matchSettings=h,this.applyDeterministicRandom(h.seed||"mp-seed"),this.startGame(p)}},this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings),this.multiplayer.onPeerDeath=()=>{this.checkMultiplayerVictory()},this.updateLobbyUI(this.multiplayer.isHost),this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings))):this.multiplayer=null,t.gameMode==="matrix-ai"){t.enemyCount=0,t.skipLoot=!0;const h=document.getElementById("ai-panel");h&&h.classList.remove("hidden")}else{const h=document.getElementById("ai-panel");h&&h.classList.add("hidden")}this.hud=new ti(this.player,this.world,e),this.player&&(this.player.hud=this.hud),this.hud&&typeof this.hud.setRenderer=="function"&&this.hud.setRenderer(this.renderer),this.hud&&typeof this.hud.setMultiplayer=="function"&&this.hud.setMultiplayer(this.multiplayer),this.enemyManager=new oi(this.scene,this.player,this.world,t),this.multiplayer&&typeof this.multiplayer.setEnemyManager=="function"&&this.multiplayer.setEnemyManager(this.enemyManager),t.gameMode==="multiplayer"&&(this.multiplayerEnemyBaseCount=t.enemyCount||0,typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(this.multiplayerEnemyBaseCount),this.multiplayer&&(this.multiplayer.onHit=h=>{if(!h||h.targetId!==this.multiplayer.id)return;const r=typeof h.amount=="number"?h.amount:0;r>0&&this.player&&typeof this.player.takeDamage=="function"&&this.player.takeDamage(r)})),this.player.setEnemyManager(this.enemyManager),t.gameMode==="multiplayer"&&(this.refreshMultiplayerTargets(),this.setupMultiplayerLobbyUI()),this.setupObjectInspector(),this.updateDebugToggleVisibility(!!e.debugMode),this.setHotbarVisible(!0);const o=document.getElementById("float-btn");o&&(t.gameMode==="studio"?(o.classList.remove("hidden"),o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF",o.onclick=()=>{if(this.player.isFloating=!this.player.isFloating,!this.player.isFloating){const h=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=h,this.player.velocity.y=0}o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF"}):o.classList.add("hidden"));const n=document.getElementById("storm-timer");if(n){const h=t.stormEnabled===!1||t.gameMode==="studio"||t.gameMode==="matrix"||t.gameMode==="matrix-ai"||t.gameMode==="multiplayer"||t.gameMode==="survival";n.classList.toggle("hidden",h)}const a=document.getElementById("survival-timer");if(a){const h=t.gameMode==="arcade"||t.gameMode==="survival";a.classList.toggle("hidden",!h)}window.addEventListener("resize",()=>this.onWindowResize(),!1),this.renderer.domElement.addEventListener("pointerdown",()=>{if(!ue){try{const h=document.getElementById("main-menu")&&document.getElementById("main-menu").style.display!=="none",r=this.player&&this.player.gameMode==="studio";if(this.isPaused||h||r)return;this.player&&!this.player.isDead&&this.player.lockControls()}catch(h){console.warn("Pointer lock request skipped or failed:",h)}this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic()}}),this.setupPauseMenu();try{const h=typeof navigator<"u"&&/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent),r=typeof window<"u"&&window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;(!!e.useTouchControls||h||r)&&(this.touchControls=new ai(this.player))}catch{}if(this.setupStudioPalette(t),this.refreshStudioPaletteVisibility(),this.setupAiPanel(),!ue&&this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch(h){console.warn("Pointer lock on start skipped/failed:",h)}this._animationStarted||(this._animationStarted=!0,this.animate())}setupLongPressMenu(){if(!ue)return;const e=document.getElementById("ui-layer")||document.body;if(!e)return;const t=s=>{try{if(s.touches&&s.touches.length>1)return;this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=setTimeout(()=>{this._longPressTimer=null,this.showPauseMenu()},800)}catch{}},i=()=>{this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null)};e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("touchend",i),e.addEventListener("touchcancel",i),e.addEventListener("touchmove",i)}setupAiPanel(){const e=document.getElementById("ai-panel"),t=document.getElementById("ai-send"),i=document.getElementById("ai-prompt"),s=document.getElementById("ai-log"),o=document.getElementById("ai-provider");if(!e||!t||!i||!s)return;const n=(h,r="")=>{const c=document.createElement("div");c.textContent=h,r&&(c.className=r),s.appendChild(c),s.scrollTop=s.scrollHeight};t.onclick=()=>{const h=i.value.trim();h&&(n(`You: ${h}`,"ai-user"),n("AI: (stub) Interpreter not wired. Imagine this runs your Three.js code.","ai-bot"),i.value="")};const a=`You are a level-building assistant for a Three.js sandbox. Respond ONLY with a JSON object:
{
  "actions": [
    {
      "action": "add",
      "type": "box" | "sphere" | "cylinder" | "plane",
      "pos": [x,y,z],
      "size": [sx,sy,sz],
      "color": "#rrggbb"
    }
  ]
}
Constraints: numbers are in meters, keep |x|,|z| <= 150, size in [0.2, 40]. No functions, no code, no prose, no markdown.`,l=async h=>{const r=document.getElementById("setting-openai-key"),c=r&&r.value?r.value.trim():"";if(!c)return n("Erro: configure a chave OpenAI em Settings.","ai-error"),"";const d={model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:h}],temperature:.2,max_tokens:2e3,response_format:{type:"json_object"}},p=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(d)});if(!p.ok){const w=await p.text();return n(`Erro OpenAI: ${p.status} ${w}`,"ai-error"),""}const m=await p.json(),u=m&&m.choices&&m.choices[0]&&m.choices[0].message?m.choices[0].message.content:"";return n(`AI: ${u||"(vazio)"}`,"ai-bot"),u||""};t.onclick=async()=>{const h=i.value.trim();if(!h)return;n(`You: ${h}`,"ai-user"),i.value="";const r=o?o.value:"openai";t.disabled=!0,t.innerText="Enviando...";try{if(r==="openai"){const c=await l(h);if(c){const d=this.parseAiActions(c,n);if(d&&d.length){const p=this.applyAiActions(d,n);n(`Aplicado: ${p} objeto(s)`,"ai-info")}}}else n(`Provider ${r} no suportado.`,"ai-error")}catch(c){n(`Erro na requisio: ${c.message||c}`,"ai-error")}finally{t.disabled=!1,t.innerText="Send to AI"}}}parseAiActions(e,t){const i=t||(()=>{});let s=null;try{s=JSON.parse(e)}catch{return i("Falha ao parsear JSON da AI.","ai-error"),[]}if(s&&s.actions&&Array.isArray(s.actions)&&(s=s.actions),!Array.isArray(s))return i("Resposta no  uma lista de aes.","ai-error"),[];const o=(r,c,d)=>Math.min(d,Math.max(c,r)),n=new Set(["box","sphere","cylinder","plane"]),a=/^#([0-9a-fA-F]{6})$/,l=this.aiMaxAiObjects||200,h=[];for(const r of s){if(!r||r.action!=="add"||!n.has(r.type))continue;const c=Array.isArray(r.pos)?r.pos.slice(0,3):[0,0,0],d=Array.isArray(r.size)?r.size.slice(0,3):[1,1,1],p=[o(Number(c[0]??0),-150,150),o(Number(c[1]??0),-10,200),o(Number(c[2]??0),-150,150)],m=[o(Math.abs(Number(d[0]??1)),.2,40),o(Math.abs(Number(d[1]??1)),.2,40),o(Math.abs(Number(d[2]??1)),.2,40)],u=typeof r.color=="string"&&a.test(r.color)?r.color:"#cccccc";if(h.push({type:r.type,pos:p,size:m,color:u}),h.length>=l)break}return h.length||i("Nenhuma ao vlida na resposta.","ai-error"),h}clearAiObjects(){this.aiObjects||(this.aiObjects=[]),this.aiObjects.forEach(e=>{try{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose()}catch{}}),this.aiObjects=[]}applyAiActions(e,t){const i=t||(()=>{});if(!e||!e.length)return 0;if(!this.scene||!this.player||this.player.gameMode!=="matrix-ai")return i("Aes ignoradas: no est no modo Matrix AI Builder.","ai-error"),0;this.clearAiObjects();const s=this.aiMaxAiObjects||200,o=[],n=new Ce(16777215,.2);return n.position.set(0,10,0),this.scene.add(n),o.push(n),e.slice(0,s).forEach(a=>{try{let l=null;const h=new S({color:new ne(a.color),metalness:.05,roughness:.85});if(a.type==="box")l=new b(a.size[0],a.size[1],a.size[2]);else if(a.type==="sphere"){const c=a.size[0]/2;l=new Ie(c,20,16)}else if(a.type==="cylinder"){const c=a.size[0]/2;l=new ie(c,c,a.size[1],16)}else a.type==="plane"&&(l=new te(a.size[0],a.size[2]));if(!l)return;const r=new g(l,h);r.position.set(a.pos[0],a.pos[1],a.pos[2]),a.type==="plane"&&(r.rotation.x=-Math.PI/2),this.scene.add(r),o.push(r)}catch(l){i("Falha ao criar objeto: "+l.message,"ai-error")}}),this.aiObjects=o,o.length}refreshStudioPaletteVisibility(){const e=document.getElementById("studio-palette");if(!e)return;const t=this.player&&this.player.gameMode==="studio"&&!this.isPaused;e.classList.toggle("hidden",!t)}refreshMultiplayerTargets(){if(!this.player||this.player.gameMode!=="multiplayer"||!this.enemyManager)return;const e=typeof this.multiplayerEnemyBaseCount=="number"?this.multiplayerEnemyBaseCount:this.enemyManager.enemies.length;this.matchPhase==="live"&&typeof this.enemyManager.setTargetCount=="function"?this.enemyManager.setTargetCount(e):this.matchPhase!=="live"&&typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(0)}setupStudioPalette(e){const t=document.getElementById("studio-palette");if(!t)return;const i=e&&(e.gameMode==="studio"||e.gameMode==="matrix-ai");if(t.classList.toggle("hidden",!i),!i)return;this.initStudioPaletteDrag(t),t.querySelectorAll("button").forEach(n=>{if(n._boundStudio)return;n._boundStudio=!0;const a=h=>{if(h&&h.stopPropagation&&h.stopPropagation(),!this.player||!this.world)return;const r=n.getAttribute("data-action");if(r==="resume"){if(this.isPaused=!1,this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch{}const u=document.getElementById("main-menu");u&&(u.style.display="none"),this.setMenuOpenState(!1),this.setHotbarVisible(!0);try{t.classList.add("hidden")}catch{}if(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0),this.player&&this.player.studioSelectionHelper){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}this.refreshStudioPaletteVisibility(),this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic();return}else if(r==="float-toggle"){if(this.player&&this.player.gameMode==="studio"){this.player.isFloating=!this.player.isFloating;const u=this.player.isFloating?"FLOAT ON":"FLOAT OFF";if(n.innerText=u,!this.player.isFloating){const w=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=w,this.player.velocity.y=0}}return}else if(r==="spawn-npc"){const u=n.getAttribute("data-npc-type")||"normal";this.studioSelectedPrefab="npc",this.studioSelectedOptions={type:u},this.toggleTouchLookArea(!1);const w=document.getElementById("npc-menu");w&&w.classList.add("hidden");return}else if(r==="remove-npc"){if(this.studioRemoveNPCMode=!this.studioRemoveNPCMode,this.studioMoveMode=!1,n.style.background=this.studioRemoveNPCMode?"#e74c3c":"",n.textContent=this.studioRemoveNPCMode?"Remove NPC (Active)":"Remove NPC",this.studioRemoveNPCMode&&(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.player&&this.player.studioSelectionHelper)){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}return}else if(r==="move-tool"){this.studioMoveMode=!this.studioMoveMode,this.studioRemoveNPCMode=!1,n.style.background=this.studioMoveMode?"#3498db":"",n.textContent=this.studioMoveMode?"Move Tool (Active)":"Move Tool",this.studioMoveMode?(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!1)):(this.toggleTouchLookArea(!0),this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(null));return}else if(r!=="drops"){if(r==="drops"){this.spawnStudioDrops();return}else if(r==="menu"){this.showPauseMenu();return}else if(r==="quit"){try{localStorage.removeItem("voxel-firecraft-settings")}catch{}location.reload();return}}const c=n.getAttribute("data-prefab"),d=n.getAttribute("data-vehicle-type"),p=n.getAttribute("data-tree-type"),m=n.getAttribute("data-submenu");if(m){const u=document.getElementById(m);u&&u.classList.toggle("hidden");return}if(this.studioSelectedPrefab=c,this.studioSelectedOptions=d?{variant:d}:p?{variant:p}:{},this.toggleTouchLookArea(!1),m){const u=document.getElementById(m);u&&u.classList.add("hidden")}},l=h=>{h&&h.preventDefault&&h.preventDefault(),a(h)};n.addEventListener("pointerdown",l),n.addEventListener("click",h=>{h&&h.preventDefault&&h.preventDefault(),a(h)})});const o=document.getElementById("studio-minimize-btn");o&&o.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const a=document.querySelector("#studio-palette .palette-grid");a&&(a.classList.toggle("hidden"),o.textContent=a.classList.contains("hidden")?"+":"_")})}setupObjectInspector(){const e=this.renderer?this.renderer.domElement:null;if(!e)return;if(this._objectClickHandler&&this._objectClickTarget)try{this._objectClickTarget.removeEventListener("click",this._objectClickHandler),this._objectClickTarget.removeEventListener("pointerdown",this._objectClickHandler)}catch{}this._objectClickTarget=e;const t=o=>{if(this.player&&this.player.gameMode==="studio"){const c=e.getBoundingClientRect(),d=(o.clientX-c.left)/c.width*2-1,p=-((o.clientY-c.top)/c.height*2-1),m=new $;m.setFromCamera(new X(d,p),this.camera);let u=null;const w=[];if(this.world&&this.world.objects&&w.push(...this.world.objects),this.enemyManager&&this.enemyManager.enemies){console.log("[DEBUG] Enemies in scene:",this.enemyManager.enemies.map(x=>{var k,D;return((D=(k=x.mesh)==null?void 0:k.userData)==null?void 0:D.gameName)||"Unknown"}));for(const x of this.enemyManager.enemies)x.mesh&&w.push(x.mesh)}const E=m.intersectObjects(w,!0);console.log("[DEBUG] Raycast hits:",E.length,"objects. Checking each hit...");for(const x of E){let k=x.object;for(console.log("[DEBUG] Hit object:",k.type,k.userData);k.parent&&k.parent.type!=="Scene";)k=k.parent;if(console.log("[DEBUG] Root object:",k.type,k.userData),k.userData&&k.userData.gameName==="Ground"){console.log("[DEBUG] Skipping ground");continue}if(k.userData&&(k.userData.isNPC||k.userData.gameName)){console.log("[DEBUG] FOUND VALID OBJECT!",k.userData.gameName,"isNPC:",k.userData.isNPC),u=k;break}else console.log("[DEBUG] Object has no valid userData, skipping")}u?(console.log("[DEBUG] Setting selection for:",u.userData.gameName),this.player&&typeof this.player.setStudioSelection=="function"&&(this.player.setStudioSelection(u),console.log("[DEBUG] setStudioSelection called successfully"))):this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(null)}if(!this.studioMoveMode||this.player.gameMode!=="studio")return;const n=e.getBoundingClientRect(),a=(o.clientX-n.left)/n.width*2-1,l=-((o.clientY-n.top)/n.height*2-1),h=new $;h.setFromCamera(new X(a,l),this.camera);let r=null;if(this.enemyManager&&this.enemyManager.enemies){for(const c of this.enemyManager.enemies)if(c.mesh&&h.intersectObject(c.mesh,!0).length>0){for(r=c.mesh;r.parent&&r.parent.type!=="Scene";)r=r.parent;break}}if(!r){const c=h.intersectObjects(this.world.objects,!0);for(const d of c)if(d.object.userData&&d.object.userData.gameName!=="Ground"){for(r=d.object;r.parent&&r.parent.type!=="Scene";)r=r.parent;break}}r&&(this.studioDraggedObject=r,this.studioIsDragging=!0,this.player.controls&&(this.player.controls.enabled=!1),this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(r))},i=o=>{if(!this.studioIsDragging||!this.studioDraggedObject)return;const n=e.getBoundingClientRect(),a=(o.clientX-n.left)/n.width*2-1,l=-((o.clientY-n.top)/n.height*2-1),h=new $;h.setFromCamera(new X(a,l),this.camera);const r=h.intersectObjects(this.world.objects,!0);for(const c of r)if(c.object.userData&&c.object.userData.gameName==="Ground"){if(this.studioDraggedObject.position.x=c.point.x,this.studioDraggedObject.position.z=c.point.z,this.world&&typeof this.world.getHeightAt=="function"&&(this.studioDraggedObject.position.y=this.world.getHeightAt(c.point.x,c.point.z)),this.enemyManager){const d=this.enemyManager.enemies.find(p=>p.mesh===this.studioDraggedObject);d&&d.position.copy(this.studioDraggedObject.position)}break}},s=()=>{this.studioIsDragging&&(this.studioIsDragging=!1,this.studioDraggedObject=null,this.player.controls&&(this.player.controls.enabled=!0))};e.addEventListener("pointerdown",t),e.addEventListener("pointermove",i),e.addEventListener("pointerup",s),e.addEventListener("pointerleave",s),this._objectClickHandler=o=>{if(!this.player||!this.hud)return;const n=this.player.gameMode||"arcade";if(n==="matrix")return;if(n==="studio"&&this.studioRemoveNPCMode){const u=this.renderer.domElement.getBoundingClientRect(),w=(o.clientX-u.left)/u.width*2-1,E=-((o.clientY-u.top)/u.height*2-1),x=new $;if(x.setFromCamera(new X(w,E),this.camera),this.enemyManager&&this.enemyManager.enemies){console.log("Remove NPC: Checking",this.enemyManager.enemies.length,"enemies");for(let k=this.enemyManager.enemies.length-1;k>=0;k--){const D=this.enemyManager.enemies[k];if(D.mesh&&x.intersectObject(D.mesh,!0).length>0){console.log("Hit enemy",k,"removing..."),this.scene.remove(D.mesh),this.enemyManager.enemies.splice(k,1),console.log("Removed NPC");return}}}return}if(n==="studio"&&this.studioSelectedPrefab){const u=e.getBoundingClientRect(),w=(o.clientX-u.left)/u.width*2-1,E=-((o.clientY-u.top)/u.height*2-1),x=new $;x.setFromCamera(new X(w,E),this.camera);const k=x.intersectObjects(this.world.objects,!0);let D=null;for(const v of k)if(v.object&&v.object.userData&&v.object.userData.gameName==="Ground"){D=v;break}if(!D){const v=new $;v.setFromCamera(new X(0,0),this.camera);const P=v.intersectObjects(this.world.objects,!0);for(const L of P)if(L.object&&L.object.userData&&L.object.userData.gameName==="Ground"){D=L;break}}if(D){if(this.studioSelectedPrefab==="npc"){if(this.enemyManager&&typeof this.enemyManager.spawnEnemyAt=="function"){const v=this.studioSelectedOptions?this.studioSelectedOptions.type:"normal";this.enemyManager.spawnEnemyAt(D.point.x,D.point.z,v)}}else if(typeof this.world.spawnPrefab=="function"){const v=this.studioSelectedOptions||{};this.world.spawnPrefab(this.studioSelectedPrefab,D.point.x,D.point.z,v)}}this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0);return}let a=0,l=0;if(this.player.controls&&this.player.controls.isLocked)a=0,l=0;else{const u=e.getBoundingClientRect();a=(o.clientX-u.left)/u.width*2-1,l=-((o.clientY-u.top)/u.height*2-1)}this._pickRaycaster.setFromCamera(new X(a,l),this.camera);const h=[];if(this.world&&Array.isArray(this.world.objects)&&h.push(...this.world.objects),this.itemManager&&Array.isArray(this.itemManager.items)&&h.push(...this.itemManager.items),this.enemyManager&&Array.isArray(this.enemyManager.enemies)&&this.enemyManager.enemies.forEach(u=>{u&&u.mesh&&h.push(u.mesh)}),h.length===0)return;const r=this._pickRaycaster.intersectObjects(h,!0);if(!r.length)return;let c=r[0].object,d=null;for(;c;){if(c.userData&&(c.userData.gameId||c.userData.gameid)&&c.userData.gameName){d=c.userData;break}c=c.parent}if(!d)return;const p=d.gameName||"Object",m=d.gameId||d.gameid||"---";typeof this.hud.showSelectionInfo=="function"&&this.hud.showSelectionInfo(p,m)},e.addEventListener("click",this._objectClickHandler),e.addEventListener("pointerdown",this._objectClickHandler)}initStudioPaletteDrag(e){if(!e||e._dragInit)return;e._dragInit=!0;const t=e.querySelector(".palette-title")||e;let i=!1,s=0,o=0,n=0,a=0,l=null;e.style.touchAction="none";const h=c=>{if(!i){const u=Math.abs(c.clientX-n),w=Math.abs(c.clientY-a);if(u<3&&w<3)return;i=!0,l&&(e.style.right="auto",e.style.bottom="auto",e.style.position="fixed",e.style.width=`${l.width}px`,e.style.minWidth=`${l.width}px`,e.style.maxWidth=`${l.width}px`,e.style.left=`${l.left}px`,e.style.top=`${l.top}px`)}const d=e.getBoundingClientRect(),p=Math.max(0,Math.min(window.innerWidth-d.width,c.clientX-s)),m=Math.max(0,Math.min(window.innerHeight-d.height,c.clientY-o));e.style.left=`${p}px`,e.style.top=`${m}px`},r=()=>{i=!1,t.releasePointerCapture&&t.releasePointerCapture(t._dragPointerId),document.removeEventListener("pointermove",h),document.removeEventListener("pointerup",r)};t.addEventListener("pointerdown",c=>{try{c.preventDefault()}catch{}const d=e.getBoundingClientRect();l=d,s=c.clientX-d.left,o=c.clientY-d.top,n=c.clientX,a=c.clientY,i=!1,t._dragPointerId=c.pointerId;try{t.setPointerCapture(c.pointerId)}catch{}document.addEventListener("pointermove",h),document.addEventListener("pointerup",r)})}togglePause(){if(this.player){if(this.player.controls&&this.player.controls.isLocked){this.showPauseMenu();return}this.isPaused=!this.isPaused,this.isPaused?this.pauseBackgroundMusic():this.playBackgroundMusic()}}setupPauseMenu(){document.addEventListener("keydown",t=>{t.code==="Escape"&&this.player&&!this.player.isDead&&(t.preventDefault(),this.showPauseMenu())});const e=document.getElementById("pause-menu");e&&e.remove()}showPauseMenu(){this.isPaused=!0,this.player.controls&&this.player.controls.isLocked&&this.player.controls.unlock(),this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps(),this.pauseBackgroundMusic();const e=document.getElementById("main-menu");if(e){e.style.display="flex",this.setMenuOpenState(!0);const t=document.getElementById("play-btn");t&&this.player&&(t.innerText="RESUME GAME")}if(this.setHotbarVisible(!1),this.player&&this.player.gameMode==="studio"){const t=document.getElementById("studio-palette");t&&t.classList.remove("hidden")}}playBackgroundMusic(){try{this.bgAudio||(this.bgAudio=new Audio(Ot),this.bgAudio.loop=!0,this.bgAudio.volume=this.bgMusicVolume,this.bgAudio.preload="auto");const e=this.bgAudio.play();e&&typeof e.then=="function"&&e.catch(()=>{})}catch(e){console.warn("Could not play background music:",e)}}pauseBackgroundMusic(){if(this.bgAudio&&!this.bgAudio.paused)try{this.bgAudio.pause()}catch{}}stopBackgroundMusic(){if(this.bgAudio)try{this.bgAudio.pause(),this.bgAudio.currentTime=0}catch{}}requestFullscreenIfNeeded(e){if(!e)return;const t=document;if(t.fullscreenElement||t.webkitFullscreenElement||t.mozFullScreenElement||t.msFullscreenElement)return;const s=document.documentElement||document.body,o=s.requestFullscreen||s.webkitRequestFullscreen||s.mozRequestFullScreen||s.msRequestFullscreen;o?o.call(s).catch(n=>{console.warn("Fullscreen request failed:",n),ue&&alert("Fullscreen may not be supported on this mobile device.")}):ue&&alert("Fullscreen is not available on this mobile device.")}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate());try{const e=this.clock.getDelta(),t=Math.min(e,.1),i=!!(this.touchControls&&this.touchControls.enabled),s=!!(this.player&&this.player.controls&&this.player.controls.isLocked),o=!!(this.player&&this.player.gameMode==="studio");if(!this.isPaused&&this.player&&(s||i||o)){try{this.player.update(t)}catch(n){console.error("Error in player.update:",n)}try{const n=this.world.update(t,this.player.position);!(this.player&&this.player.gameMode==="studio")&&n&&n.inStorm?this.player.takeDamage(1*t):this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch(n){console.error("Error in world.update:",n)}try{this.enemyManager.update(t)}catch(n){console.error("Error in enemyManager.update:",n)}try{this.itemManager.update(t)}catch(n){console.error("Error in itemManager.update:",n)}if(this.player&&this.player.gameMode==="multiplayer"){if(this.matchPhase==="live")this.multiplayerDropTimer+=t,this.multiplayerDropTimer>=30&&(this.multiplayerDropActive=!0),this.multiplayerDropActive&&this.itemManager&&(this.multiplayerDropCooldown-=t,this.multiplayerDropCooldown<=0&&(this.multiplayerDropCooldown=60,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"&&this.itemManager.spawnMatrixDropNearPlayer()));else if(this.matchPhase==="countdown"){this.lobbyCountdown-=t;const n=document.getElementById("mp-lobby-countdown");this.lobbyCountdown<0&&(this.lobbyCountdown=0),n&&(n.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`),this.lobbyCountdown<=0&&this.startMultiplayerMatch()}}try{this.multiplayer&&typeof this.multiplayer.update=="function"&&this.multiplayer.update(t)}catch(n){console.error("Error in multiplayer.update:",n)}if(this.player&&(this.player.gameMode==="arcade"||this.player.gameMode==="survival")){this.survivalTime=(performance.now()-this.survivalStartTime)/1e3;const n=document.getElementById("survival-time-value");if(n){const a=Math.floor(this.survivalTime/60),l=Math.floor(this.survivalTime%60);n.innerText=`${a.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}if(this.itemManager&&this.enemyManager){const a=this.itemManager.items?this.itemManager.items.filter(h=>!(h.userData&&h.userData.isOpened)).length:0,l=this.enemyManager.targetCount>0?this.enemyManager.killedCount/this.enemyManager.targetCount:0;if(a===0&&l>=.3&&!this.lootDropEligible&&(this.lootDropEligible=!0,this.lootDropCooldown=0,console.log("Loot drops from sky enabled! Player killed 30%+ zombies.")),this.lootDropEligible&&(this.lootDropCooldown-=t,this.lootDropCooldown<=0&&(this.lootDropCooldown=45,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"))){const h=2+Math.floor(Math.random()*2);for(let r=0;r<h;r++)this.itemManager.spawnMatrixDropNearPlayer();console.log(`Dropped ${h} items from sky!`)}}}try{this.hud.update()}catch(n){console.error("Error in hud.update:",n)}try{this.touchControls&&typeof this.touchControls.update=="function"&&this.touchControls.update()}catch(n){console.error("Error in touchControls.update:",n)}try{if(!(this.player&&(this.player.gameMode==="matrix"||this.player.gameMode==="studio"||this.player.gameMode==="multiplayer"||this.player.gameMode==="matrix-ai"))&&this.enemyManager.enemies.length===0&&!this.player.isDead&&!this.victoryShown){this.victoryShown=!0;try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}this.hud.showVictory(),this.player.controls.unlock()}else this.player&&this.player.gameMode==="multiplayer"&&this.matchPhase==="live"&&!this.player.isDead&&!this.victoryShown&&(this.multiplayer?this.multiplayer.others.size:0)===0&&(this.victoryShown=!0,this.hud.showVictory(),this.player.controls&&this.player.controls.unlock&&this.player.controls.unlock())}catch(n){console.error("Error in victory check:",n)}}this.renderer.render(this.scene,this.camera)}catch(e){try{console.error("Unhandled error in Game.animate:",e,{playerExists:!!this.player,playerWeaponCount:this.player?this.player.weapons?this.player.weapons.length:"no-weapons":"no-player",currentWeaponIndex:this.player?this.player.currentWeaponIndex:"no-player",hudExists:!!this.hud,hudSettings:this.hud?this.hud.settings:null});try{this._logRenderMaterialDiagnostics(e)}catch(t){console.error("Error during render diagnostics:",t)}}catch(t){console.error("Error logging animate failure:",t)}return}}}Te.prototype.playEndSequence=function(H,e={}){try{if(this._playingEndSequence)return;if(this._playingEndSequence=!0,this.bgAudio)try{this._prevBgVolume=this.bgAudio.volume,this.bgAudio.pause()}catch{this._prevBgVolume=this.bgMusicVolume}if(this._endSequenceAudio){try{this._endSequenceAudio.pause(),this._endSequenceAudio.currentTime=0}catch{}this._endSequenceAudio=null}const t=new Audio(H);t.loop=e.loop||!1,t.volume=e.volume!==void 0?e.volume:1,t.preload="auto",this._endSequenceAudio=t,t.load(),setTimeout(()=>{const i=t.play();i&&typeof i.then=="function"&&i.catch(s=>{console.log("Audio playback blocked, waiting for user interaction:",s);const o=()=>{t.readyState<2&&t.load(),t.play().catch(()=>{}),document.removeEventListener("touchstart",o),document.removeEventListener("click",o)};document.addEventListener("touchstart",o,{once:!0}),document.addEventListener("click",o,{once:!0})})},100),t.addEventListener("ended",()=>{try{this.bgAudio&&this._prevBgVolume!==null&&(this.bgAudio.volume=this._prevBgVolume)}catch{}this._endSequenceAudio=null,this._prevBgVolume=null,this._playingEndSequence=!1})}catch(t){console.warn("playEndSequence error:",t)}};Te.prototype._logRenderMaterialDiagnostics=function(H){try{const e=[];let t=0;this.scene.traverse(i=>{if(i.isMesh){t++;const s=i.material;if(!s){e.push({uuid:i.uuid,name:i.name||i.userData&&i.userData.gameName||"mesh",issue:"no-material"});return}const o=n=>({type:n.type||n.constructor&&n.constructor.name||"Unknown",isShaderMaterial:!!n.isShaderMaterial,isStandardMaterial:!!n.isMeshStandardMaterial,hasEmissive:n.emissive!==void 0,uniformsKeys:n.uniforms?Object.keys(n.uniforms):null,userData:n.userData||null});Array.isArray(s)?e.push({uuid:i.uuid,name:i.name||i.userData&&i.userData.gameName||"mesh",materials:s.map(o)}):e.push({uuid:i.uuid,name:i.userData&&i.userData.gameName||i.name||"mesh",material:o(s)})}}),console.error("Render diagnostics:",{originalError:H&&H.toString(),totalMeshes:t,sampleProblems:e.slice(0,30),note:"Look for materials missing expected uniforms (shader/standard) or meshes without material."})}catch(e){console.error("Failed collecting render diagnostics:",e)}};window.game=new Te;(function(){try{const e=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}"),t=e&&e.debugMode||localStorage.getItem("showDebugOverlay")==="true"||!!window.DEBUG_OVERLAY;window.debugOverlay=hi({autoShow:!!t}),window.addEventListener("keydown",i=>{if(i.key==="`"&&window.debugOverlay){const s=document.getElementById("debug-overlay");s&&s.classList.contains("hidden")?window.debugOverlay.show():window.debugOverlay&&window.debugOverlay.hide()}});try{let i=document.getElementById("debug-toggle-btn");i||(i=document.createElement("button"),i.id="debug-toggle-btn",i.title="Debug logs",i.innerText="DBG",document.body.appendChild(i));const s=!0;i.addEventListener("click",o=>{try{const n=document.getElementById("debug-overlay");n&&n.classList.contains("hidden")?(window.debugOverlay&&window.debugOverlay.show(),localStorage.setItem("showDebugOverlay","true")):(window.debugOverlay&&window.debugOverlay.hide(),localStorage.removeItem("showDebugOverlay"))}catch(n){console.warn("debug toggle error",n)}})}catch{}}catch(e){console.warn("debugOverlay init failed",e)}})();window.addEventListener("game-touch-look",H=>{try{const e=H.detail||{dx:0,dy:0},t=.003;if(window.game&&window.game.player)try{if(typeof window.game.player.rotateCamera=="function")window.game.player.rotateCamera(e.dx*t,e.dy*t);else{window.game.player._touchYaw=(window.game.player._touchYaw||0)-e.dx*.01,window.game.player._touchPitch=(window.game.player._touchPitch||0)-e.dy*.01;const s=Math.PI/2-.1;window.game.player._touchPitch=Math.max(-s,Math.min(s,window.game.player._touchPitch))}}catch{}}catch{}});
