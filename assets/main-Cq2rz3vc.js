import{O as ze,I as st,E as Pe,V as z,M as ot,P as te,B as Be,C as ne,a as E,b as v,c as we,d as k,G as nt,e as ue,f as O,g as at,h as rt,R as ht,N as lt,i as ct,S as ke,D as We,j as Ke,k as ie,l as $e,m as Je,T as dt,n as ut,o as Y,p as U,q as mt,r as Ze,L as pt,s as ft,t as gt,u as X,v as yt,w as wt,x as vt,y as bt,z as Mt,A as xt,F as St,H as kt,J as Et,K as Dt,Q as Ct,W as Bt,U as It,X as Ue,Y as Le,Z as Pt,_ as Tt}from"./slendermanElement-CLgnoac4.js";import{c as At,a as Lt,b as zt,d as Ht,e as _t,f as Rt,g as Ft,h as Ot,i as jt,j as Nt,_ as Vt,k as Gt}from"./spiderElement-CcVWrlae.js";const Wt="/threejs-voxel-firecraft/v1/dist/assets/background-music-by-suno-B4M28EgO.ogg";class $t{constructor(e){this.scene=e,this.buckets=new Map}addInstance(e,t,s,i,o,n={}){const a=[];t.traverse(l=>{l.isMesh&&a.push(l)}),a.forEach(l=>{const r=Array.isArray(l.material)?l.material.map(p=>p.uuid).join("-"):l.material.uuid,h=l.geometry.uuid,c=`${e}_${h}_${r}`;this.buckets.has(c)||this.buckets.set(c,{geometry:l.geometry,material:l.material,instances:[],castShadow:l.castShadow,receiveShadow:l.receiveShadow});const u=this.buckets.get(c),f=l.position.clone(),m=l.rotation.clone(),d=l.scale.clone();u.instances.push({pos:s,rot:i,scl:o,offsetPos:f,offsetRot:m,offsetScl:d,userData:n})})}build(){const e=new ze,t=[];return this.buckets.forEach((s,i)=>{if(s.instances.length===0)return;const o=new st(s.geometry,s.material,s.instances.length);o.castShadow=s.castShadow,o.receiveShadow=s.receiveShadow,o.userData={isInstanced:!0};for(let n=0;n<s.instances.length;n++){const a=s.instances[n];e.position.copy(a.pos),e.rotation.copy(a.rot||new Pe),e.scale.copy(a.scl||new z(1,1,1)),e.updateMatrix();const l=new ze;l.position.copy(a.offsetPos),l.rotation.copy(a.offsetRot),l.scale.copy(a.offsetScl),l.updateMatrix();const r=new ot;r.multiplyMatrices(e.matrix,l.matrix),o.setMatrixAt(n,r)}o.instanceMatrix.needsUpdate=!0,this.scene.add(o),t.push(o)}),this.buckets.clear(),t}}const Ie=400;class Ut{constructor(e,t,s){this.scene=e,this.itemManager=t,this.objects=[],this.gameMode=s&&s.gameMode?s.gameMode:"arcade",this.gameMode==="arena"?this.mapSize=150:this.mapSize=s&&s.mapSize?s.mapSize:Ie,this.halfMapSize=this.mapSize/2,this.stormRadius=this.halfMapSize,this.initialStormRadius=this.stormRadius,this._heightFn=this._buildHeightFn(),this.stormEnabled=s&&s.stormEnabled!==!1;const i=s?s.stormTime:180;this.stormShrinkRate=this.stormRadius/i,this.safeZoneCenter=new z(0,0,0),this.instanceManager=new $t(this.scene),this.useInstancing=this.gameMode!=="studio"&&this.gameMode!=="matrix"&&this.gameMode!=="matrix-ai",this.init()}init(){this.gameMode==="arena"?this.createArenaEnvironment():this.gameMode==="matrix"?this.createMatrixEnvironment():this.gameMode==="matrix-ai"?this.createMatrixAIEnvironment():this.gameMode==="multiplayer"?this.createMultiplayerEnvironment():this.gameMode==="studio"?this.createStudioEnvironment():this.gameMode==="survival"?this.createSurvivalEnvironment():this.createEnvironment(),this.useInstancing&&this.instanceManager.build().forEach(t=>{this.objects.push(t)}),this.gameMode!=="matrix"&&this.gameMode!=="studio"&&this.stormEnabled&&this.createStormVisuals()}addWorldObject(e,t,s,i,o,n=1,a=0,l={}){const r=new z(s,i,o),h=new Pe(0,a,0),c=new z(n,n,n);if(this.useInstancing){this.instanceManager.addInstance(e,t,r,h,c,l);const u=new ze;return u.position.copy(r),u.rotation.copy(h),u.scale.copy(c),u.userData={...l},u.userData.radius||(e.includes("Tree")?u.userData.radius=1:e.includes("Rock")?u.userData.radius=1.5:e.includes("Bush")&&(u.userData.radius=1)),this.objects.push(u),u}else{const u=t.clone();return u.position.copy(r),u.rotation.copy(h),u.scale.copy(c),u.userData={...l,gameId:this.generateID()},this.scene.add(u),this.objects.push(u),u}}createEnvironment(){const e=(w=1)=>(Math.random()-.5)*(this.mapSize*w),t=(w=1)=>{const x=this.halfMapSize-5,I=e(w);return Math.max(-x,Math.min(x,I))},s=(w=1,x=12)=>{let I,L,T=0;do I=t(w),L=t(w),T++;while(I*I+L*L<x*x&&T<20);return{x:I,z:L}},i=(w,x)=>this.getHeightAt?this.getHeightAt(w,x):0,o={trees:70,rocks:50,bushes:50,grass:180,houses:12,vehicles:12,plateaus:4,smallBuildings:5},n=new te(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let w=0;w<a.count;w++)a.setZ(w,0);a.needsUpdate=!0;const l=n.attributes.position.count;n.setAttribute("color",new Be(new Float32Array(l*3),3));const r=n.attributes.color,h=new ne;for(let w=0;w<l;w++){const x=Math.random();x>.8?h.setHex(2600544):x>.4?h.setHex(3066993):h.setHex(5822093),r.setXYZ(w,h.r,h.g,h.b)}const c=new E({vertexColors:!0,roughness:.8}),u=new v(n,c);u.rotation.x=-Math.PI/2,u.receiveShadow=!0,u.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(u),this.objects.push(u);const f=this.createTree(0,0,"Oak"),m=this.createTree(0,0,"Pine"),d=this.createRock(0,0),p=this.createRockPillar(0,0),g=this.createFlatBoulder(0,0),M=this.createCrystalShard(0,0),b=this.createStackedRock(0,0),S=this.createBasaltCluster(0,0),C=this.createBush(0,0),D=this.createGrassClump(0,0);for(let w=0;w<o.trees;w++){const{x,z:I}=s(.9),L=i(x,I),T=Math.random()>.5?"Oak":"Pine",_=T==="Oak"?f:m,j=.8+Math.random()*.4,W=Math.random()*Math.PI*2;this.addWorldObject(T,_,x,L,I,j,W,{gameName:`Tree_${T}`,type:"tree"})}const B=[d,p,g,M,b,S],A=["Rock","RockPillar","FlatBoulder","Crystal","StackedRock","Basalt"];for(let w=0;w<o.rocks;w++){const{x,z:I}=s(.9),L=i(x,I),T=w%B.length,_=B[T],j=A[T],W=.8+Math.random()*.4,N=Math.random()*Math.PI*2;this.addWorldObject(j,_,x,L,I,W,N,{gameName:"Rock",type:"rock"})}for(let w=0;w<o.bushes;w++){const{x,z:I}=s(.85),L=i(x,I),T=.8+Math.random()*.4,_=Math.random()*Math.PI*2;this.addWorldObject("Bush",C,x,L,I,T,_,{gameName:"Bush"})}for(let w=0;w<o.grass;w++){const{x,z:I}=s(.95),L=i(x,I),T=Math.random()*Math.PI*2;this.addWorldObject("Grass",D,x,L,I,1,T,{gameName:"Grass"})}for(let w=0;w<o.houses;w++){const{x,z:I}=s(.75,20),L=i(x,I),T=Math.random(),_=T>.7,j=T<.25,W=_?1.55:j?.9:1,N=_?"Mansion":j?"Cabin":"House",$=_?"large":j?"small":"medium",q=this.createHouse(x,I,{scale:W});q.position.y=L,q.userData={gameId:this.generateID(),gameName:N,type:"house",size:$},this.scene.add(q),this.objects.push(q),this.itemManager.spawnLootInHouse(x,1,I)}for(let w=0;w<o.vehicles;w++){const{x,z:I}=s(.8),L=i(x,I),T=Math.random()>.6?"truck":"car",_=this.createVehicle(x,I,T);_.position.y=L,_.userData={..._.userData||{},gameId:this.generateID(),gameName:`Vehicle_${T}`,type:"vehicle"},this.scene.add(_),this.objects.push(_)}for(let w=0;w<o.plateaus;w++){const{x,z:I}=s(.6,25),L=6+Math.random()*6,T=8+Math.random()*6,_=i(x,I),j=this.createPlateau(x,I,T,L,_);j.userData={gameId:this.generateID(),gameName:"Plateau",type:"house"},this.scene.add(j),this.objects.push(j)}for(let w=0;w<o.smallBuildings;w++){const{x,z:I}=s(.7,18),L=i(x,I),T=this.createSmallBuilding(x,I);T.position.y=L,T.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"},this.scene.add(T),this.objects.push(T)}}createSurvivalEnvironment(){const e=(w=1)=>(Math.random()-.5)*(this.mapSize*w),t=(w=1)=>{const x=this.halfMapSize-5,I=e(w);return Math.max(-x,Math.min(x,I))},s=(w=1,x=12)=>{let I,L,T=0;do I=t(w),L=t(w),T++;while(I*I+L*L<x*x&&T<20);return{x:I,z:L}},i=(w,x)=>this.getHeightAt?this.getHeightAt(w,x):0,o={trees:90,rocks:60,bushes:80,grass:250},n=new te(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let w=0;w<a.count;w++)a.setZ(w,0);a.needsUpdate=!0;const l=n.attributes.position.count;n.setAttribute("color",new Be(new Float32Array(l*3),3));const r=n.attributes.color,h=new ne;for(let w=0;w<l;w++){const x=Math.random();x>.8?h.setHex(2600544):x>.4?h.setHex(3066993):h.setHex(5822093),r.setXYZ(w,h.r,h.g,h.b)}const c=new E({vertexColors:!0,roughness:.8}),u=new v(n,c);u.rotation.x=-Math.PI/2,u.receiveShadow=!0,u.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(u),this.objects.push(u);const f=this.createTree(0,0,"Oak"),m=this.createTree(0,0,"Pine"),d=this.createRock(0,0),p=this.createRockPillar(0,0),g=this.createFlatBoulder(0,0),M=this.createCrystalShard(0,0),b=this.createStackedRock(0,0),S=this.createBasaltCluster(0,0),C=this.createBush(0,0),D=this.createGrassClump(0,0);for(let w=0;w<o.trees;w++){const{x,z:I}=s(.9),L=i(x,I),T=Math.random()>.5?"Oak":"Pine",_=T==="Oak"?f:m,j=.8+Math.random()*.4,W=Math.random()*Math.PI*2;this.addWorldObject(T,_,x,L,I,j,W,{gameName:`Tree_${T}`,type:"tree"})}const B=[d,p,g,M,b,S],A=["Rock","RockPillar","FlatBoulder","Crystal","StackedRock","Basalt"];for(let w=0;w<o.rocks;w++){const{x,z:I}=s(.9),L=i(x,I),T=w%B.length,_=B[T],j=A[T],W=.8+Math.random()*.4,N=Math.random()*Math.PI*2;this.addWorldObject(j,_,x,L,I,W,N,{gameName:"Rock",type:"rock"})}for(let w=0;w<o.bushes;w++){const{x,z:I}=s(.85),L=i(x,I),T=.8+Math.random()*.4,_=Math.random()*Math.PI*2;this.addWorldObject("Bush",C,x,L,I,T,_,{gameName:"Bush"})}for(let w=0;w<o.grass;w++){const{x,z:I}=s(.95),L=i(x,I),T=Math.random()*Math.PI*2;this.addWorldObject("Grass",D,x,L,I,1,T,{gameName:"Grass"})}}createArenaEnvironment(){const e=(n=1)=>(Math.random()-.5)*(this.mapSize*n),t=(n=1)=>{const a=this.halfMapSize-5,l=e(n);return Math.max(-a,Math.min(a,l))},s=new te(this.mapSize,this.mapSize,1,1),i=new we({color:3885915,flatShading:!0}),o=new v(s,i);o.rotation.x=-Math.PI/2,o.receiveShadow=!0,o.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(o),this.objects.push(o);for(let n=0;n<30;n++){const a=t(.8),l=t(.8),r=1+Math.random()*3,h=1+Math.random()*2,c=1+Math.random()*2,u=new k(h,r,c),f=new we({color:5596791,flatShading:!0}),m=new v(u,f);m.position.set(a,r/2,l),m.castShadow=!0,m.receiveShadow=!0,m.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},this.scene.add(m),this.objects.push(m)}for(let n=0;n<6;n++){const a=t(.7),l=t(.7),r=6+Math.random()*3,h=3+Math.random()*2,c=3,u=new k(c,h,r),f=new we({color:4937059,flatShading:!0}),m=new v(u,f);m.position.set(a,h/2,l),m.rotation.x=-Math.atan(h/r),m.castShadow=!0,m.receiveShadow=!0,m.userData={gameId:this.generateID(),gameName:"Ramp",type:"house"},this.scene.add(m),this.objects.push(m)}for(let n=0;n<6;n++){const a=t(.6),l=t(.6),r=this.createArenaBunker(a,l);r.userData={gameId:this.generateID(),gameName:"Bunker",type:"house"},this.scene.add(r),this.objects.push(r)}for(let n=0;n<20;n++){const a=t(.8),l=t(.8),r=this.createFlatBoulder(a,l,0);r.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(r),this.objects.push(r)}this.itemManager.spawnLootInHouse(0,0,0)}createMatrixEnvironment(){const e=new te(this.mapSize,this.mapSize,128,128),t=e.attributes.position.count;e.setAttribute("color",new Be(new Float32Array(t*3),3));const s=e.attributes.color,i=new ne;for(let u=0;u<t;u++){const f=Math.random();f>.8?i.setHex(2600544):f>.4?i.setHex(3066993):i.setHex(5822093),s.setXYZ(u,i.r,i.g,i.b)}const o=new E({vertexColors:!0,roughness:.8}),n=new v(e,o);n.rotation.x=-Math.PI/2,n.receiveShadow=!0,n.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(n),this.objects.push(n);const a=new k(20,6,.5),l=new E({color:15987699,roughness:.9}),r=new v(a,l);r.position.set(0,3,-15),r.castShadow=!0,r.receiveShadow=!0,r.userData={gameId:this.generateID(),gameName:"Wall",type:"house"},this.scene.add(r),this.objects.push(r);const h=this.createTree(-12,-15,"Oak"),c=this.createTree(12,-15,"Pine");this.scene.add(h),this.scene.add(c),this.objects.push(h),this.objects.push(c)}createStudioEnvironment(){const e=new te(this.mapSize,this.mapSize,128,128),t=this.buildVoxelGroundMaterial(),s=new v(e,t);s.rotation.x=-Math.PI/2,s.receiveShadow=!0,s.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(s),this.objects.push(s);const i=12;for(let o=0;o<i;o++){const n=(Math.random()-.5)*this.mapSize*.6,a=(Math.random()-.5)*this.mapSize*.6,l=this.createVoxelCloud(n,a);this.scene.add(l)}}createMatrixAIEnvironment(){const e=this.mapSize,t=80,s=new nt(e,t,16777215,16777215);(Array.isArray(s.material)?s.material:[s.material]).forEach(l=>{l.opacity=.3,l.transparent=!0,l.depthWrite=!1}),s.position.y=.02,this.scene.add(s);const o=new te(e,e,1,1),n=new ue({visible:!1}),a=new v(o,n);a.rotation.x=-Math.PI/2,a.userData={gameId:this.generateID(),gameName:"Ground",type:"ground"},this.scene.add(a),this.objects.push(a)}createMultiplayerEnvironment(){const e=new te(this.mapSize,this.mapSize,128,128),t=this.buildVoxelGroundMaterial(),s=new v(e,t);s.rotation.x=-Math.PI/2,s.receiveShadow=!0,s.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(s),this.objects.push(s),this.stormEnabled=!1}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}createTree(e,t,s){const i=s==="Oak"?At():Lt();return i.position.set(e,0,t),i}createVoxelCloud(e,t){const s=new O,i=new k(3,2,3),o=new at({color:15922943,transparent:!0,opacity:.9}),n=8+Math.floor(Math.random()*6);for(let a=0;a<n;a++){const l=(Math.random()-.5)*12,r=(Math.random()-.5)*12,h=(Math.random()-.5)*2,c=new v(i,o);c.position.set(l,h,r),c.castShadow=!1,c.receiveShadow=!1,s.add(c)}return s.position.set(e,30+Math.random()*8,t),s}buildVoxelGroundMaterial(){const t=document.createElement("canvas");t.width=64,t.height=64;const s=t.getContext("2d"),i="#4caf50",o="#66bb6a",n="#8d6e63",a=8;for(let c=0;c<64;c+=a)for(let u=0;u<64;u+=a){const m=Math.random()>.85?n:(u/a+c/a)%2===0?i:o;s.fillStyle=m,s.fillRect(u,c,a,a)}const l=s.getImageData(0,0,64,64),r=l.data;for(let c=0;c<r.length;c+=4){const u=Math.random()*30-15;r[c]=Math.min(255,Math.max(0,r[c]+u)),r[c+1]=Math.min(255,Math.max(0,r[c+1]+u)),r[c+2]=Math.min(255,Math.max(0,r[c+2]+u))}s.putImageData(l,0,0);const h=new rt(t);return h.wrapS=h.wrapT=ht,h.repeat.set(this.mapSize/10,this.mapSize/10),h.magFilter=lt,h.minFilter=ct,new E({map:h,roughness:1,metalness:0})}createRock(e,t,s=0){const i=zt(e,t,s);return this._tagStaticCollider(i,"rock"),i}createRockPillar(e,t,s=0){const i=Ht(e,t,s);return this._tagStaticCollider(i,"rock"),i}createFlatBoulder(e,t,s=0){const i=_t(e,t,s);return this._tagStaticCollider(i,"rock"),i}createCrystalShard(e,t,s=0){return Rt(e,t,s)}createStackedRock(e,t,s=0){const i=new O,o=this.createRock(0,0,0);i.add(o);const n=this.createRock(0,0);n.scale.set(.6,.6,.6),n.position.set(.3,n.position.y+.9,-.2),i.add(n);const a=this.createRock(0,0);return a.scale.set(.4,.4,.4),a.position.set(-.2,a.position.y+1.5,.3),i.add(a),i.position.set(e,s,t),i.traverse(l=>{l.castShadow=!0,l.receiveShadow=!0}),this._tagStaticCollider(i,"rock"),i}createBasaltCluster(e,t,s=0){const i=Ft(e,t,s);return this._tagStaticCollider(i,"rock"),i}createVehicle(e,t,s="car"){let i;return s==="bus"?i=Ot():s==="motorcycle"?i=jt():i=Nt(s),i.position.set(e,0,t),i}createBush(e,t){const s=new O;s.position.set(e,0,t);const i=new E({color:2924588,roughness:1}),o=2+Math.floor(Math.random()*3);for(let n=0;n<o;n++){const a=1.2+Math.random()*1,l=new v(new ke(a,6,6),i);l.position.set((Math.random()-.5)*1.2,a*.65,(Math.random()-.5)*1.2),l.castShadow=!0,s.add(l)}return s}createGrassClump(e,t){const s=new O;s.position.set(e,0,t);const i=3+Math.floor(Math.random()*4);for(let o=0;o<i;o++){const n=.2+Math.random()*.6,a=new te(.05,n),l=new E({color:5620331,side:We}),r=new v(a,l);r.position.y=n/2,r.rotation.y=Math.random()*Math.PI,r.rotation.z=(Math.random()-.5)*.6,r.receiveShadow=!0,s.add(r)}return s}createHouse(e,t,{scale:s=1}={}){const i=new O;i.position.set(e,0,t),i.rotation.y=Math.random()*Math.PI*2;const o=new E({color:9807270}),n=new E({color:12597547});[{w:6,h:4,d:.5,x:0,y:2,z:-3},{w:.5,h:4,d:6,x:-3,y:2,z:0},{w:.5,h:4,d:6,x:3,y:2,z:0},{w:2,h:4,d:.5,x:-2,y:2,z:3},{w:2,h:4,d:.5,x:2,y:2,z:3},{w:2,h:1,d:.5,x:0,y:3.5,z:3}].forEach(m=>{const d=new v(new k(m.w,m.h,m.d),o);d.position.set(m.x,m.y,m.z),d.castShadow=!0,d.receiveShadow=!0,i.add(d),this.objects.push(d)});const l=new v(new Ke(5,2,4),n);l.position.y=5,l.rotation.y=Math.PI/4,l.castShadow=!0,i.add(l);const r=new E({color:5057307}),h=new v(new k(1,2.2,.1),r);h.position.set(0,1.1,3.26),i.add(h);const c=new E({color:8962303,metalness:.1,roughness:.2,transparent:!0,opacity:.8}),u=new v(new k(1,1,.05),c);u.position.set(-2,2.2,-3.26);const f=u.clone();return f.position.set(2,2.2,-3.26),i.add(u),i.add(f),i.scale.setScalar(s),i}createPlateau(e,t,s=10,i=8,o=0){const n=new O,a=new E({color:8355711,roughness:1}),l=new v(new ie(s,s*1.05,i,16,1),a);l.position.set(0,i/2,0),l.castShadow=!0,l.receiveShadow=!0,n.add(l);const r=s*1.4,h=i,c=s*.8,u=new k(c,h,r),f=new v(u,new E({color:9342606,roughness:1}));f.castShadow=!0,f.receiveShadow=!0;const m=Math.atan(h/r);f.rotation.x=-m,f.position.set(0,h/2,s),f.userData={type:"house"},n.add(f);const d=new k(c,.2,r),p=new v(d,new E({color:7105644}));return p.position.set(0,h,s),p.rotation.x=f.rotation.x,p.castShadow=!0,n.add(p),n.position.set(e,o,t),n.userData={type:"house"},n}createSmallBuilding(e,t){const s=new O;s.position.set(e,0,t),s.rotation.y=Math.random()*Math.PI*2;const i=new E({color:8359053}),o=new E({color:12436423}),n=8,a=8,l=6,r=.35,h=2.2,c=n/2,u=a/2,f=new v(new k(n,l,r),i);f.position.set(0,l/2,-u);const m=new v(new k(r,l,a),i);m.position.set(-c,l/2,0);const d=m.clone();d.position.x=c;const p=new v(new k((n-h)/2,l,r),i);p.position.set(-2.55,l/2,u);const g=p.clone();g.position.x=h/2+(n-h)/4,[f,m,d,p,g].forEach(w=>{w.castShadow=!0,w.receiveShadow=!0,s.add(w)});const M=new v(new k(n-.4,.3,a-.4),o);M.position.y=.15,M.receiveShadow=!0,s.add(M);const b=new v(new k(n-.4,.3,a-.4),o);b.position.y=3.4,b.receiveShadow=!0,s.add(b);const S=b.position.y,C=10,D=new k(3,S,C),B=new v(D,o);B.position.set(0,S/2,u+C/2),B.rotation.x=-Math.atan(S/C),B.castShadow=!0,B.receiveShadow=!0,s.add(B);const A=new v(new k(n+.4,.4,a+.4),new E({color:9807270}));return A.position.y=l+.2,A.castShadow=!0,s.add(A),s}spawnPrefab(e,t,s,i={}){const o=this.getHeightAt&&typeof this.getHeightAt=="function"?this.getHeightAt(t,s):0;let n=null;switch(e){case"house":{n=this.createHouse(t,s,{scale:1}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"House",type:"house"};break}case"mansion":{n=this.createHouse(t,s,{scale:1.6}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Mansion",type:"house",size:"large"};break}case"cabin":{n=this.createHouse(t,s,{scale:.85}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Cabin",type:"house",size:"small"};break}case"smallBuilding":{n=this.createSmallBuilding(t,s),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"};break}case"plateau":{const a=this.createPlateau(t,s,10+Math.random()*6,8+Math.random()*6,o);a.userData={gameId:this.generateID(),gameName:"Plateau",type:"house",size:"large"},n=a;break}case"rock":{n=this.createRock(t,s),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"};break}case"tree":{const a=i.variant||(Math.random()>.5?"Oak":"Pine");n=this.createTree(t,s,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Tree_${a}`,type:"tree"};break}case"vehicle":{const a=i.variant||(Math.random()>.6?"truck":"car");n=this.createVehicle(t,s,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Vehicle_${a}`,type:"vehicle"};break}case"crate":{const a=new v(new k(2,2,2),new E({color:9342606,roughness:.9}));a.position.set(t,o+1,s),a.castShadow=!0,a.receiveShadow=!0,a.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},n=a;break}}return n&&(this.scene.add(n),this.objects.push(n)),n}createArenaBunker(e,t){const s=new O;s.position.set(e,0,t),s.rotation.y=Math.random()*Math.PI*2;const i=new we({color:4937059,flatShading:!0}),o=new we({color:6253691,flatShading:!0}),n=new v(new k(6,2.5,6),i);n.position.y=1.25,n.castShadow=!0,n.receiveShadow=!0,s.add(n);const a=new v(new k(6.2,.3,6.2),o);a.position.y=2.65,a.castShadow=!0,s.add(a);const l=new v(new k(1.2,1.8,.2),new we({color:9280168,flatShading:!0,transparent:!0,opacity:.2}));l.position.set(0,.9,3.1),s.add(l);const r=new k(2,1.2,4),h=new v(r,o);return h.position.set(-2.5,.6,-1),h.rotation.x=-Math.atan(1.2/4),h.castShadow=!0,h.receiveShadow=!0,h.userData={type:"house"},s.add(h),s}createStormVisuals(){if(this.gameMode==="matrix")return;const e=new ie(this.stormRadius,this.stormRadius,50,32,1,!0),t=new ue({color:9323693,transparent:!0,opacity:.3,side:We});this.stormMesh=new v(e,t),this.stormMesh.position.y=25,this.scene.add(this.stormMesh)}createTarget(e,t){const s=new O;s.position.set(e,0,t);const i=new v(new ie(.05,.05,2,6),new E({color:8947848}));i.position.y=1,s.add(i);const o=new $e(.8,24),n=new E({color:16777215}),a=new v(o,n);a.position.set(0,2,0),a.rotation.y=Math.PI,s.add(a);const l=new E({color:16729156}),r=new E({color:15844367}),h=new E({color:3447003}),c=(f,m)=>{const d=new v(new dt(f,.02,6,24),m);return d.rotation.x=Math.PI/2,d.position.y=2,d};s.add(c(.75,h)),s.add(c(.55,l)),s.add(c(.35,r));const u=new v(new $e(.1,12),new E({color:0}));return u.position.set(0,2.01,0),u.rotation.y=Math.PI,s.add(u),s.userData={gameId:this.generateID(),gameName:"Target",type:"house"},s}update(e,t){if(this.gameMode==="matrix"||this.gameMode==="studio"||this.gameMode==="matrix-ai")return{inStorm:!1};if(this.stormEnabled===!1)return{inStorm:!1};if(this.stormRadius>10){this.stormRadius-=this.stormShrinkRate*e;const i=this.initialStormRadius?this.stormRadius/this.initialStormRadius:1;this.stormMesh&&this.stormMesh.scale&&this.stormMesh.scale.set(i,1,i)}return{inStorm:Math.sqrt(t.x*t.x+t.z*t.z)>this.stormRadius}}_buildHeightFn(){return()=>0}_tagStaticCollider(e,t=null){if(!e)return;e.updateWorldMatrix(!0,!0);const s=new Je().setFromObject(e);e.userData=e.userData||{},t&&!e.userData.type&&(e.userData.type=t),e.userData.colliderBox=s,e.userData.colliderType="solid"}getHeightAt(e,t){return this._heightFn?this._heightFn(e,t):0}}const ve=new Pe(0,0,0,"YXZ"),be=new z,Xt={type:"change"},Yt={type:"lock"},qt={type:"unlock"},Xe=Math.PI/2;class Kt extends ut{constructor(e,t){super(),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=Jt.bind(this),this._onPointerlockChange=Zt.bind(this),this._onPointerlockError=Qt.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(e){return e.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(e){const t=this.camera;be.setFromMatrixColumn(t.matrix,0),be.crossVectors(t.up,be),t.position.addScaledVector(be,e)}moveRight(e){const t=this.camera;be.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(be,e)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function Jt(H){if(this.isLocked===!1)return;const e=H.movementX||H.mozMovementX||H.webkitMovementX||0,t=H.movementY||H.mozMovementY||H.webkitMovementY||0,s=this.camera;ve.setFromQuaternion(s.quaternion),ve.y-=e*.002*this.pointerSpeed,ve.x-=t*.002*this.pointerSpeed,ve.x=Math.max(Xe-this.maxPolarAngle,Math.min(Xe-this.minPolarAngle,ve.x)),s.quaternion.setFromEuler(ve),this.dispatchEvent(Xt)}function Zt(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(Yt),this.isLocked=!0):(this.dispatchEvent(qt),this.isLocked=!1)}function Qt(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}const ei="/threejs-voxel-firecraft/v1/dist/assets/mixkit-game-gun-shot-D1lu3gfh.ogg",ti="/threejs-voxel-firecraft/v1/dist/assets/smack-BAv2er9i.ogg",ii="/threejs-voxel-firecraft/v1/dist/assets/ugh-CPf3Qqe6.ogg",si="/threejs-voxel-firecraft/v1/dist/assets/mixkit-footsteps-on-tall-grass-532-DkmduvPT.ogg",oi="/threejs-voxel-firecraft/v1/dist/assets/mixkit-car-door-slam-xN3cwxzE.wav";class He{constructor(e,t,s,i={}){if(this.camera=e,this.scene=t,this.worldObjects=s,this.world=null,this.hud=null,this.gameMode=i.gameMode||"arcade",this.showTracers=i.showTracers===!0,this.backpack=null,this.backpackColor=null,this.placedBlocks=[],this.blockSize=1,this.minBlockSize=.5,this.maxBlockSize=2,this.previewBlock=null,this.isFloating=!1,this.selectedBlock=null,this.selectedBlockHelper=null,this.maxHealth=100,this.health=100,this.maxShield=100,this.shield=100,this.isDead=!1,this.maxStamina=100,this.stamina=100,this.punchCount=0,this.isTired=!1,this.velocity=new z,this.direction=new z,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.isSprinting=!1,this.canJump=!1,this.speed=42,this.jumpHeight=16,this.gravity=65,this.mouthStyle=i&&i.mouthStyle?i.mouthStyle:"serious",this.mouthMesh=null,this.mouthStyles=["serious","smile","angry","surprised","none"],this.showHat=i&&typeof i.showHat<"u"?i.showHat:!0,this.hatMeshes=[],this.distanceTraveled=0,this.previousPosition=new z,this.allWeapons=[{name:"Pistol",ammo:12,maxAmmo:60,magazineSize:12,currentMag:12,damage:20,cooldown:.5,lastShot:0,reloadTime:1.5,range:50},{name:"Fist",ammo:1/0,maxAmmo:1/0,magazineSize:1/0,currentMag:1/0,damage:10,cooldown:.2,lastShot:0,reloadTime:0,range:3},{name:"Rifle",ammo:30,maxAmmo:120,magazineSize:30,currentMag:30,damage:25,cooldown:.15,lastShot:0,reloadTime:2,range:120,zoomFov:30},{name:"Sniper",ammo:5,maxAmmo:20,magazineSize:5,currentMag:5,damage:100,cooldown:2,lastShot:0,reloadTime:3,range:400,zoomFov:12},{name:"SMG",ammo:40,maxAmmo:200,magazineSize:40,currentMag:40,damage:15,cooldown:.08,lastShot:0,reloadTime:1.8,range:80},{name:"Shotgun",ammo:6,maxAmmo:24,magazineSize:6,currentMag:6,damage:60,cooldown:1,lastShot:0,reloadTime:2.5,range:25},{name:"DMR",ammo:12,maxAmmo:48,magazineSize:12,currentMag:12,damage:45,cooldown:.35,lastShot:0,reloadTime:2.2,range:200,zoomFov:18}],this.gameMode==="matrix-ai")this.weapons=[this.allWeapons[1]];else if(this.gameMode==="matrix")this.weapons=[this.allWeapons[1],this.allWeapons[0],this.allWeapons[2],this.allWeapons[3],this.allWeapons[4],this.allWeapons[5],this.allWeapons[6]];else if(this.gameMode==="arena"){const o=[2,3,4,5,6][Math.floor(Math.random()*5)];this.weapons=[this.allWeapons[1],this.allWeapons[0],this.allWeapons[o]]}else this.weapons=[this.allWeapons[1],this.allWeapons[0]];this.currentWeaponIndex=0,this.isReloading=!1,this.controls=new Kt(e,document.body),document.addEventListener("pointerlockerror",o=>{try{o.stopImmediatePropagation()}catch{}console.warn("Pointer lock request failed or unavailable in this environment.")},!0),this.allowTouchMovement=!1,this._touchYaw=0,this._touchPitch=0,document.addEventListener("fullscreenchange",()=>{document.fullscreenElement&&document.exitFullscreen().catch(()=>{})}),this.createPlayerMesh(),this.cameraMode=i.cameraMode||"TPS",this.fpsCameraOffset=new z(0,1.6,0),this.tpsCameraOffset=new z(1,1.8,3.4),this.initControls(),this.sfxVolume=i.sfxVolume!==void 0?i.sfxVolume/100:.7,this.sfxVolume=.7,this.gunshotBuffer=null,this.reloadBuffer=null,this.smackBuffer=null,this.ughBuffer=null,this.footstepsBuffer=null,this._footstepsSource=null,this._footstepsGain=null,this.vehicleDoorBuffer=null,this.vehicleDriveBuffer=null,this._vehicleDriveSource=null,this._vehicleDriveGain=null,this._lastVehicleDriveActive=!1,this.enableVehicleDriveSound=!1,this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer=null,this._lastFootstepsActive=!1,this.isCrouching=!1,this.crouchHeight=.8,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.vehicleBaseMaxSpeed=70,this.vehicleBoostMax=45,this.vehicleAccel=70,this.vehicleTurnSpeed=1.8,this.vehicleFriction=2.8,this.vehicleAccelHold=0,this.vehiclePromptEl=document.getElementById("interaction-prompt"),this.nearVehicle=null,this.vehicleFuel=0,this.vehicleFuelCapacity=0,this.vehicleDistance=0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=0,this.vehicleEfficiencyKmPerL=10,this.vehicleIdleLph=.4,this.vehicleThrottleLph=.8,this._vehicleStateCache=null,this.vehicleTurbo=!1,this.currentSpeed=0,this.vehicleHud={root:document.getElementById("vehicle-hud"),speed:document.getElementById("vehicle-speed"),fuelBar:document.getElementById("vehicle-fuel-bar"),fuelFill:document.getElementById("vehicle-fuel-fill"),fuelText:document.getElementById("vehicle-fuel-text"),distance:document.getElementById("vehicle-distance"),efficiency:document.getElementById("vehicle-efficiency"),range:document.getElementById("vehicle-range")},this.studioSelected=null,this._studioRaycaster=new Y,this.studioSelectionHelper=null,this.selectionInfo=document.getElementById("selection-info"),this.controls.enabled=this.gameMode!=="studio";try{const o=window.AudioContext||window.webkitAudioContext;o&&(this.audioCtx=new o,fetch(ei).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.gunshotBuffer=n}).catch(n=>console.warn("Error loading gunshot SFX:",n)),Vt(()=>import("./mixkit-shotgun-recharge-TecsDDA8.js"),[]).then(n=>fetch(n.default)).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.reloadBuffer=n}).catch(n=>console.warn("Error loading reload SFX:",n)),fetch(ti).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.smackBuffer=n}).catch(n=>console.warn("Error loading smack SFX:",n)),fetch(ii).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.ughBuffer=n}).catch(n=>console.warn("Error loading hurt SFX:",n)),fetch(si).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.footstepsBuffer=n}).catch(n=>console.warn("Error loading footsteps SFX:",n)),fetch(oi).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.vehicleDoorBuffer=n}).catch(n=>console.warn("Error loading vehicle door SFX:",n)))}catch(o){console.warn("Web Audio API not supported:",o)}}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}separateFromRemotePlayers(){if(!this.multiplayerClient||!this.multiplayerClient.others||this.multiplayerClient.others.size===0)return;const t=.6*2,s=this.mesh.position;this.multiplayerClient.others.forEach(i=>{if(!i||!i.position||i.userData&&i.userData.dead)return;const o=s.x-i.position.x,n=s.z-i.position.z,a=o*o+n*n;if(a<t*t&&a>1e-4){const l=Math.sqrt(a),r=(t-l)*.5,h=o/l,c=n/l;s.x+=h*r,s.z+=c*r}})}placeBlock(){if(!this.world)return;const e=this.getBlockTarget(),t=e.size,s=new k(t,t,t),i=new E({color:11887901,roughness:.9}),o=new v(s,i);o.position.copy(e.position),o.castShadow=!0,o.receiveShadow=!0,o.userData={type:"block",size:t,gameId:this.world.generateID?this.world.generateID():void 0,gameName:"Block"},this.scene.add(o),this.world.objects&&this.world.objects.push(o),this.placedBlocks.push(o)}createPlayerMesh(){this.mesh=new O,this.scene.add(this.mesh);const e=this.playerColor||3447003,t=new E({color:e}),s=new E({color:16764074}),i=new E({color:2899536});this.head=new v(new k(.5,.5,.5),s),this.head.position.y=1.75,this.head.name="playerHead",this.head.userData={role:"playerHead"},this.mesh.add(this.head);const o=new E({color:15158332}),n=new v(new k(.52,.1,.52),o);n.position.set(0,.3,0),n.userData={role:"playerHat"},n.name="playerHatCap",this.head.add(n);const a=new v(new k(.52,.02,.35),o);a.position.set(0,.22,.35),a.userData={role:"playerHat"},a.name="playerHatBrim",this.head.add(a),this.hatMeshes=[n,a],this.setHatVisible(this.showHat);const l=new E({color:0}),r=new E({color:1710618,transparent:!0,opacity:.7,metalness:.8,roughness:.2}),h=new v(new k(.18,.12,.02),r);h.position.set(-.12,.05,.26),this.head.add(h);const c=new v(new k(.18,.12,.02),r);c.position.set(.12,.05,.26),this.head.add(c);const u=new v(new k(.08,.02,.02),l);u.position.set(0,.05,.26),this.head.add(u);const f=new v(new k(.02,.02,.3),l);f.position.set(-.21,.05,.1),this.head.add(f);const m=new v(new k(.02,.02,.3),l);m.position.set(.21,.05,.1),this.head.add(m),this.createMouth(this.mouthStyle);const d=new v(new k(.6,.8,.3),t);d.position.y=1.1,this.mesh.add(d);const p=new k(.2,.8,.2);p.translate(0,-.3,0),this.leftArmPivot=new O,this.leftArmPivot.name="leftArmPivot",this.leftArmPivot.position.set(-.45,1.4,0),this.mesh.add(this.leftArmPivot);const g=new v(p,s);this.leftArmPivot.add(g),this.rightArmPivot=new O,this.rightArmPivot.name="rightArmPivot",this.rightArmPivot.position.set(.45,1.4,0),this.mesh.add(this.rightArmPivot);const M=new v(p,s);this.rightArmPivot.add(M),this.weaponModels={};const b=new O,S=new v(new k(.12,.12,.35),new E({color:1710618,metalness:.8,roughness:.3}));S.position.set(0,-.28,.2);const C=new v(new k(.06,.06,.15),new E({color:657930,metalness:.9,roughness:.2}));C.position.set(0,-.28,.4);const D=new v(new k(.1,.25,.12),new E({color:2894892}));D.position.set(0,-.42,.15);const B=new v(new k(.03,.05,.03),new E({color:1710618}));B.position.set(0,-.35,.18),b.add(S,C,D,B),this.rightArmPivot.add(b),this.weaponModels.Pistol=b;const A=new O,w=new v(new k(.08,.08,.9),new E({color:1710618,metalness:.8,roughness:.3}));w.position.set(0,-.28,.45);const x=new v(new k(.12,.14,.4),new E({color:2894892}));x.position.set(0,-.3,.2);const I=new v(new k(.1,.22,.12),new E({color:2894892}));I.position.set(0,-.44,.15);const L=new v(new k(.1,.12,.25),new E({color:3815994}));L.position.set(0,-.28,-.1);const T=new v(new k(.08,.25,.1),new E({color:1710618}));T.position.set(0,-.5,.2),A.add(w,x,I,L,T),this.rightArmPivot.add(A),this.weaponModels.Rifle=A;const _=new O,j=new v(new k(.08,.08,1.3),new E({color:1727514,metalness:.6,roughness:.4}));j.position.set(0,-.28,.65);const W=new v(new k(.14,.16,.5),new E({color:2969622}));W.position.set(0,-.3,.25);const N=new v(new ie(.06,.06,.35,8),new E({color:657930,metalness:.9,roughness:.1}));N.rotation.z=Math.PI/2,N.position.set(0,-.18,.4);const $=new v(new ie(.05,.05,.02,8),new E({color:1723791,metalness:.9,roughness:.1,emissive:663616}));$.rotation.z=Math.PI/2,$.position.set(0,-.18,.58);const q=new v(new k(.12,.14,.3),new E({color:3811866}));q.position.set(0,-.28,-.05);const K=new v(new k(.02,.15,.02),new E({color:1710618}));K.position.set(0,-.42,.5),_.add(j,W,N,$,q,K),this.rightArmPivot.add(_),this.weaponModels.Sniper=_,Object.values(this.weaponModels).forEach(V=>V.visible=!1);const se=A.clone();se.traverse(V=>{V.material&&V.material.color&&V.material.color.setHex(5598095)}),se.scale.set(.8,.8,.8),this.rightArmPivot.add(se),this.weaponModels.SMG=se;const oe=A.clone();oe.traverse(V=>{V.material&&V.material.color&&V.material.color.setHex(9132587)}),oe.scale.set(1.1,1,.8),this.rightArmPivot.add(oe),this.weaponModels.Shotgun=oe;const J=A.clone();J.traverse(V=>{V.material&&V.material.color&&V.material.color.setHex(3050327)}),J.scale.set(.95,.95,1),this.rightArmPivot.add(J),this.weaponModels.DMR=J;const ae=new k(this.blockSize,this.blockSize,this.blockSize),re=new E({color:3066993,transparent:!0,opacity:.35,wireframe:!0});this.previewBlock=new v(ae,re),this.previewBlock.visible=this.gameMode==="studio",this.previewBlock.castShadow=!1,this.previewBlock.receiveShadow=!1,this.scene.add(this.previewBlock);const Z=new k(.25,.8,.25);Z.translate(0,-.4,0),this.leftLegPivot=new O,this.leftLegPivot.name="leftLegPivot",this.leftLegPivot.position.set(-.15,.7,0),this.mesh.add(this.leftLegPivot);const he=new v(Z,i);this.leftLegPivot.add(he),this.rightLegPivot=new O,this.rightLegPivot.name="rightLegPivot",this.rightLegPivot.position.set(.15,.7,0),this.mesh.add(this.rightLegPivot);const le=new v(Z,i);if(this.rightLegPivot.add(le),this.isAiming=!1,this.baseFov=75,this.aimFov=20,this.hitTimer=0,this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.animTime=0,this.isPunching=!1,this.punchSide=0,this.isBlocking=!1,this.yaw=0,this.pitch=0,this.camera){const V=new Pe().setFromQuaternion(this.camera.quaternion,"YXZ");this.yaw=V.y,this.pitch=V.x}}rotateCamera(e,t){if(!this.controls||!this.controls.isLocked){this.yaw-=e,this.pitch-=t;const s=Math.PI/2-.01;this.pitch=Math.max(-s,Math.min(s,this.pitch)),this.camera.rotation.set(this.pitch,this.yaw,0,"YXZ")}}initControls(){const e=o=>{if(this.gameMode==="studio"&&this.studioSelected)switch(o.code){case"ArrowUp":o.shiftKey?this.moveSelectedObject(0,0,1.5):this.moveSelectedObject(0,-2),o.preventDefault();return;case"ArrowDown":o.shiftKey?this.moveSelectedObject(0,0,-1.5):this.moveSelectedObject(0,2),o.preventDefault();return;case"ArrowLeft":this.moveSelectedObject(-2,0),o.preventDefault();return;case"ArrowRight":this.moveSelectedObject(2,0),o.preventDefault();return;case"KeyX":this.removeSelectedObject(),o.preventDefault();return}switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"Space":this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"Digit1":this.switchWeapon(0);break;case"Digit2":this.switchWeapon(1);break;case"Digit3":this.switchWeapon(2);break;case"Digit4":this.switchWeapon(3);break;case"Digit5":this.switchWeapon(4);break;case"Digit6":this.switchWeapon(5);break;case"Numpad1":this.switchWeapon(0);break;case"Numpad2":this.switchWeapon(1);break;case"Numpad3":this.switchWeapon(2);break;case"Numpad4":this.switchWeapon(3);break;case"Numpad5":this.switchWeapon(4);break;case"Numpad6":this.switchWeapon(5);break;case"KeyH":this.multiplayerClient&&typeof this.multiplayerClient.toggleHitboxes=="function"&&this.multiplayerClient.toggleHitboxes();break;case"KeyB":this.gameMode==="studio"&&this.placeBlock();break;case"KeyU":if(this.gameMode==="studio"&&(this.isFloating=!this.isFloating,!this.isFloating)){const n=this.getSurfaceHeight(this.position.x,this.position.z);this.mesh.position.y=n,this.velocity.y=0}break;case"Minus":this.gameMode==="studio"&&this.adjustBlockSize(-.1);break;case"Equal":this.gameMode==="studio"&&this.adjustBlockSize(.1);break;case"KeyM":this.gameMode==="studio"&&this.moveLastBlock();break;case"KeyX":this.gameMode==="studio"&&(this.studioSelected?this.removeSelectedObject():this.selectedBlock?this.removeBlock(this.selectedBlock):this.removeLastBlock());break;case"KeyR":this.reload();break;case"KeyC":this.isCrouching=!this.isCrouching,this.isCrouching&&(this.isSprinting=!1);break;case"ShiftLeft":case"ShiftRight":this.isCrouching||(this.isSprinting=!0);break;case"Space":!this.isInVehicle&&this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"Escape":this.controls&&this.controls.isLocked&&this.controls.unlock();break;case"KeyN":this.isInVehicle&&(this.vehicleTurbo=!0);break;case"KeyV":this.toggleCameraMode();break;case"KeyE":if(this.isInVehicle){this.exitVehicle();return}else{const n=this.findNearbyVehicle();if(n){this.enterVehicle(n);return}}break}},t=o=>{switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"ShiftLeft":case"ShiftRight":this.isSprinting=!1;break;case"Space":break;case"KeyN":this.vehicleTurbo=!1;break}},s=o=>{this.gameMode==="studio"&&(this.selectStudioObject(o)||this.selectBlockUnderCrosshair())||this.controls.isLocked&&(o.button===0?this.shoot():o.button===2&&(this.isAiming=!0))},i=o=>{o.button===2&&(this.isAiming=!1)};document.addEventListener("keydown",e),document.addEventListener("keyup",t),document.addEventListener("mousedown",s),document.addEventListener("mouseup",i),document.addEventListener("contextmenu",o=>{if(o.preventDefault(),!this.hud||!this.hud.debugEnabled)return;const n=new Y;n.setFromCamera(new U(0,0),this.camera);const a=[];this.worldObjects&&this.worldObjects.length>0&&this.worldObjects.forEach(r=>{r&&r.traverse?r.traverse(h=>{h.isMesh&&a.push(h)}):r&&r.isMesh&&a.push(r)}),this.enemyManager&&this.enemyManager.enemies&&this.enemyManager.enemies.forEach(r=>{r.mesh&&r.mesh.traverse(h=>{h.isMesh&&a.push(h)})}),this.itemManager&&this.itemManager.items&&this.itemManager.items.forEach(r=>{r.mesh&&(r.mesh.traverse?r.mesh.traverse(h=>{h.isMesh&&a.push(h)}):r.mesh.isMesh&&a.push(r.mesh))}),this.vehicleManager&&this.vehicleManager.vehicles&&this.vehicleManager.vehicles.forEach(r=>{r.mesh&&r.mesh.traverse(h=>{h.isMesh&&a.push(h)})}),this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.forEach(r=>{r&&r.traverse&&r.traverse(h=>{h.isMesh&&a.push(h)})});const l=n.intersectObjects(a,!1);if(l.length>0){const r=l[0].object;let h=r.name||"Unnamed",c=r.type||"Mesh",u="Unknown",f=r;for(;f;)f.userData&&(f.userData.type&&(u=f.userData.type),f.userData.category&&(u=f.userData.category),f.userData.itemType&&(u=`Item: ${f.userData.itemType}`),f.userData.enemyType&&(u=`Enemy: ${f.userData.enemyType}`),f.userData.vehicleType&&(u=`Vehicle: ${f.userData.vehicleType}`),f.userData.gameId&&(h=f.userData.gameId),f.userData.nick&&(h=f.userData.nick,u="Player")),f=f.parent;const m=document.getElementById("target-inspect");m&&(m.innerHTML=`Object Target Inspect: <strong>${h}</strong> | Type: ${c} | Category: ${u}`),console.group("[ðŸ” DEBUG INSPECTOR]"),console.log("ðŸ“‹ Object Name:",h),console.log("ðŸ·ï¸  Object Type:",c),console.log("ðŸ“¦ Category:",u),console.log("ðŸ“ Position:",{x:l[0].point.x.toFixed(2),y:l[0].point.y.toFixed(2),z:l[0].point.z.toFixed(2)}),console.log("ðŸ“ Distance:",l[0].distance.toFixed(2)+"m"),r.userData&&Object.keys(r.userData).length>0?(console.log("ðŸ’¾ UserData:"),console.table(r.userData)):console.log("ðŸ’¾ UserData:","(empty)");const d=[];let p=r;for(;p&&d.length<5;)d.push({name:p.name||"unnamed",type:p.type,userData:p.userData?Object.keys(p.userData).join(", "):"none"}),p=p.parent;if(console.log("ðŸŒ³ Hierarchy:"),console.table(d),r.geometry){r.geometry.computeBoundingBox();const g=r.geometry.boundingBox;g&&console.log("ðŸ“ Bounding Box:",{width:(g.max.x-g.min.x).toFixed(2),height:(g.max.y-g.min.y).toFixed(2),depth:(g.max.z-g.min.z).toFixed(2)})}console.log("ðŸ”§ Raw Object:",r),console.groupEnd()}else{const r=document.getElementById("target-inspect");r&&(r.innerHTML="Object Target Inspect: ---")}}),this._mouthRaycaster=new Y,document.addEventListener("pointerdown",o=>{try{if(this.controls&&this.controls.isLocked||!this.head||!this.camera)return;const n=o.clientX/window.innerWidth*2-1,a=-(o.clientY/window.innerHeight)*2+1;this._mouthRaycaster.setFromCamera(new U(n,a),this.camera);const l=this._mouthRaycaster.intersectObject(this.head,!0);l&&l.length>0&&(o.preventDefault(),o.stopPropagation(),this.cycleMouthStyle())}catch{}})}lockControls(){if(!("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document)){console.warn("Pointer Lock API not available in this environment.");return}const t=document.getElementById("main-menu");if(!(t&&t.style.display!=="none")&&!this.isPaused)try{const s=this.controls.lock();s&&typeof s.catch=="function"&&s.catch(()=>{})}catch(s){console.warn("Unable to lock pointer:",s)}}toggleCameraMode(){this.cameraMode=this.cameraMode==="FPS"?"TPS":"FPS",this.mesh&&(this.mesh.visible=this.cameraMode==="TPS"),console.log(`Camera mode: ${this.cameraMode}`)}switchWeapon(e){if(e>=0&&e<this.weapons.length){if(this.isReloading)return;this.currentWeaponIndex=e;const t=this.weapons[e].name;Object.values(this.weaponModels).forEach(s=>s.visible=!1),this.weaponModels[t]&&(this.weaponModels[t].visible=!0)}}reload(){if(this.isReloading)return;const e=this.weapons[this.currentWeaponIndex];e.ammo!==1/0&&e.currentMag!==e.magazineSize&&(e.ammo<=0||(this.isReloading=!0,console.log("Reloading..."),this.playReloadSound(),setTimeout(()=>{this.finishReload()},e.reloadTime*1e3)))}playReloadSound(){try{if(this.audioCtx&&this.reloadBuffer){this.audioCtx.state==="suspended"&&this.audioCtx.resume();const e=this.audioCtx.createBufferSource();e.buffer=this.reloadBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume*.8,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}catch(e){console.warn("Error playing reload sound:",e)}}finishReload(){if(!this.isReloading)return;const e=this.weapons[this.currentWeaponIndex],t=e.magazineSize-e.currentMag,s=e.ammo,i=Math.min(t,s);e.currentMag+=i,e.ammo-=i,this.isReloading=!1,console.log("Reloaded!")}startBlocking(){this.weapons[this.currentWeaponIndex].name==="Fist"&&(this.isBlocking=!0)}stopBlocking(){this.isBlocking=!1}collectItem(e){if(e==="ShieldPotion"){this.shield=Math.min(100,this.shield+50);return}if(e==="MedKit"){this.health=Math.min(100,this.health+25),console.log("Used MedKit from chest: +25 HP");return}if(e&&e.startsWith("Backpack:")){const s=e.split(":")[1]||"2c3e50";return this.equipBackpack(parseInt(s,16))}const t=this.weapons.find(s=>s.name===e);if(t)t.ammo=Math.min(t.maxAmmo,t.ammo+t.magazineSize),console.log("Added ammo for "+e);else{const s=this.allWeapons.find(i=>i.name===e);s&&(this.weapons.push(s),console.log("Picked up "+e))}}setEnemyManager(e){this.enemyManager=e}setMultiplayerClient(e){this.multiplayerClient=e}shoot(){if(!(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0)||this.isDead||this.isReloading||this.isBlocking)return;const t=this.weapons[this.currentWeaponIndex],s=performance.now()/1e3;if(s-t.lastShot<t.cooldown)return;if(t.currentMag<=0){this.reload();return}if(t.lastShot=s,t.ammo!==1/0&&t.currentMag--,t.name==="Fist"){this.punch();return}const i=new z;this.camera.getWorldDirection(i),i.y=0,i.normalize();const o=Math.atan2(i.x,i.z);this.mesh.rotation.y=o,this.createMuzzleFlash();try{if(this.audioCtx&&this.gunshotBuffer&&this.audioCtx.state==="running"){const h=this.audioCtx.createBufferSource();h.buffer=this.gunshotBuffer,t.name==="Pistol"?h.playbackRate.value=1:t.name==="Rifle"?h.playbackRate.value=1.15:t.name==="Sniper"?h.playbackRate.value=.9:h.playbackRate.value=1;const c=this.audioCtx.createGain();c.gain.value=this.sfxVolume,h.connect(c),c.connect(this.audioCtx.destination),h.start(0)}else this.audioCtx&&this.audioCtx.state==="suspended"&&this.audioCtx.resume()}catch{}const n=new Y;n.setFromCamera(new U(0,0),this.camera);const a=this.camera.position.clone();new z,n.ray.direction.clone().normalize();let l=a.clone().add(n.ray.direction.clone().multiplyScalar(1e3)),r=!1;if(this.worldObjects&&this.worldObjects.length>0){const h=n.intersectObjects(this.worldObjects,!0);h.length>0&&(l=h[0].point.clone(),r=!0)}if(this.enemyManager&&this.enemyManager.enemies){const h=n.intersectObjects(this.enemyManager.enemies.map(c=>c.mesh),!0);if(h.length>0){const c=h[0].point,u=a.distanceTo(c),f=a.distanceTo(l);if(u<f){const m=h[0].object;l=c.clone(),r=!0;let d=null;if(d=(g=>{let M=g;for(;M;){const b=this.enemyManager.enemies.find(S=>S.mesh===M);if(b)return b;M=M.parent}return null})(m),d){const g=a.distanceTo(d.position),M=t.range||1e3;if(g<=M){const b=t.damage;if(this.multiplayerClient&&this.player&&this.player.gameMode==="multiplayer"){const S=this.multiplayerClient.isHost,C=d.mesh&&d.mesh.userData?d.mesh.userData.gameId:null;C&&(S?(d.takeDamage(b),typeof this.multiplayerClient.sendZombieState=="function"&&this.multiplayerClient.sendZombieState(C,d.health)):typeof this.multiplayerClient.sendZombieHit=="function"&&this.multiplayerClient.sendZombieHit(C,b))}else d.takeDamage(t.damage)}else r=!1}}}}if(this.multiplayerClient&&typeof this.multiplayerClient.sendShoot=="function"){const h=n.ray.direction.clone(),c=n.ray.origin.clone();console.log("[CLIENT SHOOT DEBUG]"),console.log("  Camera pos:",this.camera.position),console.log("  Camera rot:",this.camera.rotation),console.log("  Mesh pos:",this.mesh.position),console.log("  Mesh rot:",this.mesh.rotation.y.toFixed(2)),console.log("  Direction:",`(${h.x.toFixed(3)}, ${h.y.toFixed(3)}, ${h.z.toFixed(3)})`),console.log("  Direction length:",h.length().toFixed(3)),console.log("  Raycaster origin:",c),this.multiplayerClient.sendShoot(h,t.name,c)}if(this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const h=Array.from(this.multiplayerClient.others.values()),c=n.intersectObjects(h,!0);if(c.length>0){const u=c[0].point,f=a.distanceTo(u),m=a.distanceTo(l);f<m&&(l=u.clone(),r=!0)}}this.showTracers&&this.createBulletTracer(a,l,r),r&&t.name==="Sniper"&&this.createImpactSmoke(l)}static buildMouthMesh(e){const t=(e||"serious").toLowerCase(),s=new E({color:2824976,roughness:.6,metalness:0});let i=null;if(t==="smile"){const o=new O;o.userData={role:"playerMouth"},o.name="playerMouth";const n=s.clone(),a=new v(new k(.08,.04,.02),n),l=a.clone(),r=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,l.position.set(0,-.16,.26),r.position.set(.1,-.15,.26),r.rotation.z=.2,[a,l,r].forEach(h=>{h.userData={role:"playerMouth"},h.name="playerMouthSeg"}),o.add(a,l,r),i=o}else if(t==="angry"){const o=new E({color:5901324,roughness:.4});i=new v(new k(.26,.05,.02),o),i.position.set(0,-.16,.26),i.rotation.z=-.18,i.userData={role:"playerMouth"}}else if(t==="surprised")i=new v(new ie(.06,.06,.02,20),s),i.position.set(0,-.14,.26),i.rotation.x=Math.PI/2,i.userData={role:"playerMouth"};else{if(t==="none")return null;i=new v(new k(.22,.06,.02),s),i.position.set(0,-.16,.26),i.userData={role:"playerMouth"}}return i.castShadow=!1,i.receiveShadow=!1,i.name="playerMouth",i}createMouth(e){if(!this.head)return;if(this.mouthMesh){try{this.head.remove(this.mouthMesh)}catch{}this.mouthMesh=null}const t=He.buildMouthMesh(e);t&&(this.head.add(t),this.mouthMesh=t)}setHatVisible(e){this.showHat=e,Array.isArray(this.hatMeshes)&&this.hatMeshes.forEach(t=>{t&&(t.visible=e)})}cycleMouthStyle(){const e=this.mouthStyle||"serious",t=this.mouthStyles.indexOf(e),s=this.mouthStyles[(t+1)%this.mouthStyles.length];this.mouthStyle=s,this.createMouth(s),this.persistSetting("mouthStyle",s);const i=document.getElementById("setting-mouth-style");i&&(i.value=s)}persistSetting(e,t){if(!(typeof window>"u"||!window.localStorage))try{const s=window.localStorage.getItem("voxel-firecraft-settings"),i=s?JSON.parse(s):{};i[e]=t,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(i))}catch{}}createMuzzleFlash(){const e=new mt(16776960,1,5),t=new z;this.camera.getWorldDirection(t),e.position.copy(this.mesh.position),e.position.y+=1.5,e.position.add(t.multiplyScalar(1)),this.scene.add(e),setTimeout(()=>this.scene.remove(e),100)}createBulletTracer(e,t,s){const i=[e,t],o=new Ze().setFromPoints(i),n=s?16729156:16776960,a=new pt({color:n,linewidth:2,opacity:.8,transparent:!0}),l=new ft(o,a);this.scene.add(l);let r=.8;const h=setInterval(()=>{r-=.1,a.opacity=r,r<=0&&(clearInterval(h),this.scene.remove(l),o.dispose(),a.dispose())},30)}createImpactSmoke(e){const t=new O;t.position.copy(e);const s=8;for(let a=0;a<s;a++){const l=.15+Math.random()*.2,r=new ke(l,6,6),h=new ue({color:6710886,transparent:!0,opacity:.5}),c=new v(r,h);c.position.set((Math.random()-.5)*.4,(Math.random()-.5)*.2,(Math.random()-.5)*.4),t.add(c)}this.scene.add(t);const i=600,o=performance.now(),n=()=>{const a=performance.now()-o,l=Math.max(0,1-a/i);t.children.forEach(r=>{r.material&&(r.material.opacity=l*.5)}),a<i?requestAnimationFrame(n):(t.traverse(r=>{r.geometry&&r.geometry.dispose(),r.material&&r.material.dispose()}),this.scene.remove(t))};n()}update(e){if(this.isDead)return;if(this.updateStamina(e),this.updateVehiclePrompt(),this.isInVehicle){this.updateVehicleDrive(e);return}if(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0){this.velocity.x-=this.velocity.x*10*e,this.velocity.z-=this.velocity.z*10*e,this.isFloating?this.velocity.y*=.9:this.velocity.y-=this.gravity*e,this.direction.z=Number(this.moveForward)-Number(this.moveBackward),this.direction.x=Number(this.moveRight)-Number(this.moveLeft),this.direction.normalize(),(this.moveForward||this.moveBackward)&&(this.velocity.z-=this.direction.z*this.speed*e),(this.moveLeft||this.moveRight)&&(this.velocity.x-=this.direction.x*this.speed*e);const s=new z;this.camera.getWorldDirection(s),s.y=0,s.normalize();const i=new z;i.crossVectors(s,new z(0,1,0));const o=new z;this.moveForward&&o.add(s),this.moveBackward&&o.sub(s),this.moveRight&&o.add(i),this.moveLeft&&o.sub(i),o.normalize();const n=o.length()>0;let a=1;this.isSprinting&&!this.isCrouching&&n&&this.stamina>0&&(a=2);const l=this.speed*e*.1*a,r=o.multiplyScalar(l);r.x!==0&&(this.checkCollision(new z(Math.sign(r.x),0,0),Math.abs(r.x))||(this.mesh.position.x+=r.x)),r.z!==0&&(this.checkCollision(new z(0,0,Math.sign(r.z)),Math.abs(r.z))||(this.mesh.position.z+=r.z));let h=0;if(this.isFloating){const M=new z;this.camera.getWorldDirection(M);const b=M.y;this.moveForward&&(h+=b*this.speed*e*.3),this.moveBackward&&(h-=b*this.speed*e*.3)}if(this.mesh.position.y+=this.velocity.y*e+h,o.length()>0){const M=Math.atan2(o.x,o.z);this.mesh.rotation.y=M}if(this.mesh.position.y+=this.velocity.y*e,!this.isFloating){this.mesh.position.y<0&&(this.velocity.y=0,this.mesh.position.y=0,this.canJump=!0);const M=this.getSurfaceHeight(this.mesh.position.x,this.mesh.position.z);this.mesh.position.y<M&&(this.mesh.position.y=M,this.velocity.y=0,this.canJump=!0)}const c=!this.isFloating&&(this.canJump||this.mesh.position.y<=.01);if(this.handleFootsteps(n&&c&&!this.isDead),this.gameMode==="studio"?this.updateBlockPreview():this.previewBlock&&(this.previewBlock.visible=!1),this.world&&typeof this.world.halfMapSize=="number"){const M=this.world.halfMapSize-1;this.mesh.position.x=Math.max(-M,Math.min(M,this.mesh.position.x)),this.mesh.position.z=Math.max(-M,Math.min(M,this.mesh.position.z))}if(this.separateFromRemotePlayers(),this.previousPosition.length()>0){const M=this.mesh.position.distanceTo(this.previousPosition);this.distanceTraveled+=M,e>0&&(this.currentSpeed=M/e)}if(this.previousPosition.copy(this.mesh.position),this.gameMode==="studio"||this.gameMode==="matrix-ai")this.stamina=100;else if(this.isSprinting&&!this.isCrouching&&n&&this.stamina>0){const M=20*e;this.stamina=Math.max(0,this.stamina-M),this.stamina<=0&&(this.isSprinting=!1)}else{const M=10*e;this.stamina=Math.min(100,this.stamina+M)}this.camera.position.copy(this.mesh.position);const f=this.isCrouching?1.6*this.crouchHeight:1.6;this.camera.position.y+=f;const m=this.isCrouching?this.crouchHeight:1;this.mesh.scale.y+=(m-this.mesh.scale.y)*10*e;let d=this.baseFov;const p=this.weapons[this.currentWeaponIndex];this.isAiming&&p&&p.zoomFov&&(d=p.zoomFov),Math.abs(this.camera.fov-d)>.1&&(this.camera.fov+=(d-this.camera.fov)*10*e,this.camera.updateProjectionMatrix());let g;this.cameraMode==="FPS"?g=this.fpsCameraOffset.clone():(g=this.tpsCameraOffset.clone(),g.applyQuaternion(this.camera.quaternion)),g.add(this.mesh.position),this.camera.position.copy(g),this.updateAnimations(e)}}findNearbyVehicle(){if(!this.worldObjects)return null;let e=null,t=4;return this.worldObjects.forEach(s=>{if(!s||!s.userData||s.userData.type!=="vehicle")return;const i=s.position.distanceTo(this.mesh.position);i<t&&(e=s,t=i)}),e}updateVehiclePrompt(){const e=this.vehiclePromptEl;if(!e)return;if(this.isInVehicle){e.innerText="Press E to exit vehicle",e.dataset.vehiclePrompt="1",e.classList.remove("hidden");return}const t=this.findNearbyVehicle();this.nearVehicle=t,t?(e.innerText="Press E to drive vehicle",e.dataset.vehiclePrompt="1",e.classList.remove("hidden")):e.dataset.vehiclePrompt==="1"&&(e.classList.add("hidden"),delete e.dataset.vehiclePrompt)}enterVehicle(e){if(!e||this.isInVehicle)return!1;e.userData||(e.userData={}),e.userData.hasFrontAligned||(e.rotation.y+=Math.PI,e.userData.hasFrontAligned=!0);const t=this.loadVehicleState(e);this.isInVehicle=!0,this.vehicleAccelHold=0,this.isSprinting=!1,this.vehicleTurbo=!1,this.currentVehicle=e,this.vehicleSpeed=0,this.currentSpeed=0;const s=e.userData&&e.userData.vehicleType||"car";return this.vehicleFuelCapacity=t?t.capacity:s==="truck"?60:40,this.vehicleFuel=t?t.fuel:this.vehicleFuelCapacity,this.vehicleDistance=t?t.distanceKm:0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=t?t.fuelUsed:0,this.vehicleEfficiencyKmPerL=s==="truck"?3.5:5.5,this.vehicleIdleLph=s==="truck"?1:.7,this.vehicleThrottleLph=s==="truck"?2.8:1.9,this._vehicleMaxSpeed=s==="truck"?80/3.6:null,this._vehicleTurboMaxSpeed=s==="truck"?100/3.6:null,this._vehicleStateCache=t||null,this.previousPosition.copy(e.position),this.stopFootsteps(),this.stopVehicleDriveSound(),this.playVehicleDoor(),this.mesh.visible=!1,this.velocity.set(0,0,0),this.mesh.position.copy(e.position),this.updateVehicleHUD(!0),!0}exitVehicle(){if(!this.currentVehicle){this.isInVehicle=!1;return}const e=this.currentVehicle;if(this.playVehicleDoor(),this.stopVehicleDriveSound(),this.stopFootsteps(),this.world&&typeof this.world.getHeightAt=="function"){const o=this.world.getHeightAt(e.position.x,e.position.z),n=this.getVehicleGroundClearance(e);e.position.y=o+n}const t=new z(-1.5,0,-2).applyEuler(e.rotation),s=e.position.clone().add(t);this.mesh.position.copy(s);const i=typeof this.getSurfaceHeight=="function"?this.getSurfaceHeight(s.x,s.z):this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(s.x,s.z):s.y;this.mesh.position.y=i,this.velocity.set(0,0,0),this.mesh.visible=!0,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.canJump=!0,this.previousPosition.copy(this.mesh.position),this.saveVehicleState(e),this.updateVehicleHUD(!1),this.vehiclePromptEl&&this.vehiclePromptEl.dataset.vehiclePrompt==="1"&&(this.vehiclePromptEl.classList.add("hidden"),delete this.vehiclePromptEl.dataset.vehiclePrompt)}getVehicleGroundClearance(e){if(!e)return .05;const t=e.userData||{};return typeof t.groundClearance=="number"?t.groundClearance:typeof t.wheelRadius=="number"&&typeof t.wheelCenterY=="number"?Math.max(0,t.wheelRadius-t.wheelCenterY):.05}updateVehicleDrive(e){const t=this.currentVehicle;if(!t){this.isInVehicle=!1;return}this.stopFootsteps();const s=t.position.clone();if(this.vehicleFuel<=0){this.vehicleSpeed=0,this.mesh.position.copy(t.position),this.previousPosition.copy(t.position),this.currentSpeed=0,this.updateVehicleHUD(!0);return}let i=0;this.moveForward&&(i+=1),this.moveBackward&&(i-=1),this.vehicleSpeed+=i*this.vehicleAccel*e,this.moveForward&&i>0?this.vehicleAccelHold=Math.min(1,this.vehicleAccelHold+e*.8):this.vehicleAccelHold=Math.max(0,this.vehicleAccelHold-e*.6);const o=this.vehicleTurbo&&i>0,n=o?vType==="truck"?1.25:1.6:1,a=o?vType==="truck"?1.15:1.35:1,l=(this.vehicleBaseMaxSpeed+this.vehicleBoostMax*this.vehicleAccelHold)*n,r=this.vehicleBaseMaxSpeed*.5;this.vehicleSpeed=Math.min(l,Math.max(-r,this.vehicleSpeed)),this.vehicleSpeed+=i*this.vehicleAccel*e*(a-1),this.vehicleSpeed*=Math.max(0,1-this.vehicleFriction*e),this._vehicleMaxSpeed&&!o?this.vehicleSpeed=Math.min(this._vehicleMaxSpeed,this.vehicleSpeed):this._vehicleTurboMaxSpeed&&o&&(this.vehicleSpeed=Math.min(this._vehicleTurboMaxSpeed,this.vehicleSpeed)),this.currentSpeed=Math.abs(this.vehicleSpeed);const h=i>0,c=this.vehicleSpeed>=0?1:-1;this.moveLeft&&(t.rotation.y+=this.vehicleTurnSpeed*e*c),this.moveRight&&(t.rotation.y-=this.vehicleTurnSpeed*e*c);const u=new z(0,0,1).applyEuler(t.rotation),f=t.position.clone().addScaledVector(u,this.vehicleSpeed*e);if(this.checkVehicleCollision(f,t)?this.vehicleSpeed*=.2:t.position.copy(f),this.world&&typeof this.world.getHeightAt=="function"){const S=this.world.getHeightAt(t.position.x,t.position.z),C=this.getVehicleGroundClearance(t);t.position.y=S+C}if(this.world&&typeof this.world.halfMapSize=="number"){const S=this.world.halfMapSize-1;t.position.x=Math.max(-S,Math.min(S,t.position.x)),t.position.z=Math.max(-S,Math.min(S,t.position.z))}if(this.previousPosition.length()>0){const S=t.position.distanceTo(this.previousPosition);this.distanceTraveled+=S}this.mesh.position.copy(t.position),this.previousPosition.copy(t.position);const m=t.position.distanceTo(s);this.rotateVehicleWheels(t,m,this.vehicleSpeed);let d=0;if(d+=this.vehicleIdleLph/3600*e,h&&(d+=this.vehicleThrottleLph/3600*e*(o?1.7:1)),m>0){const S=m/1e3;this.vehicleDistance+=S;const C=S/this.vehicleEfficiencyKmPerL,D=h?C*.35*(o?1.35:1):0;d+=C+D}if(this.vehicleFuelUsed+=d,this.vehicleFuel=Math.max(0,this.vehicleFuel-d),this.vehicleFuel<=0&&(this.vehicleSpeed=0),this.saveVehicleState(t),this.updateVehicleHUD(!0),this.enemyManager&&Array.isArray(this.enemyManager.enemies)){const S=performance.now();this.enemyManager.enemies.forEach(C=>{if(!C||!C.position)return;if(C.position.distanceTo(t.position)<2.4){C.userData||(C.userData={});const B=C.userData.lastRunOver||0;if(S-B>400){C.userData.lastRunOver=S;try{C.takeDamage(999)}catch{}}}})}const p=t.position.clone(),g=new z(0,2,6).applyQuaternion(this.camera.quaternion),M=p.clone().add(g);this.camera.position.lerp(M,.18);const b=Math.abs(this.vehicleSpeed)>.5;this.handleVehicleDriveSound(b)}rotateVehicleWheels(e,t,s){if(!e||!e.userData||!e.userData.wheels||!e.userData.wheels.length)return;const i=e.userData.wheelRadius||.35,o=t/i,n=s>=0?-1:1;e.userData.wheels.forEach(a=>{try{a.rotation.x+=n*o}catch{}})}updateVehicleHUD(e){if(!this.vehicleHud||!this.vehicleHud.root)return;const t=this.vehicleHud.root,s=document.getElementById("dashboard");if(s){const o=s.getBoundingClientRect();t.style.left=`${o.left}px`,t.style.top=`${o.top+o.height+8}px`,t.style.width=`${o.width}px`}if(!e){t.classList.add("hidden");return}t.classList.remove("hidden");const i=Math.abs(this.vehicleSpeed)*3.6;if(this.vehicleHud.speed&&(this.vehicleHud.speed.innerText=i.toFixed(0)),this.vehicleHud.fuelFill){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelFill.style.width=`${n}%`,this.vehicleHud.fuelFill.style.background=n<20?"linear-gradient(90deg, #ff7043, #ff3d00)":"linear-gradient(90deg, #8bc34a, #cddc39)"}if(this.vehicleHud.fuelText){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelText.innerText=`${this.vehicleFuel.toFixed(1)}L (${n.toFixed(1)}%)`}if(this.vehicleHud.distance&&(this.vehicleHud.distance.innerText=this.vehicleDistance.toFixed(2)),this.vehicleHud.efficiency){const o=this.vehicleFuelUsed>0&&this.vehicleDistance>0?this.vehicleDistance/this.vehicleFuelUsed:0;this.vehicleHud.efficiency.innerText=o.toFixed(2)}if(this.vehicleHud.range){const o=this.vehicleFuel*this.vehicleEfficiencyKmPerL;this.vehicleHud.range.innerText=o.toFixed(1)}}getVehicleStorageKey(e){return!e||!e.userData||!e.userData.gameId?null:`vehicle-state-${e.userData.gameId}`}loadVehicleState(e){try{if(e&&e.userData&&e.userData.vehicleState)return e.userData.vehicleState;const t=this.getVehicleStorageKey(e);if(!t||typeof localStorage>"u")return null;const s=localStorage.getItem(t);if(!s)return null;const i=JSON.parse(s);return e.userData.vehicleState=i,i}catch{return null}}saveVehicleState(e){if(!e)return;const t=this.getVehicleStorageKey(e);if(!t)return;const s={fuel:this.vehicleFuel,capacity:this.vehicleFuelCapacity,distanceKm:this.vehicleDistance,fuelUsed:this.vehicleFuelUsed,vehicleType:e.userData&&e.userData.vehicleType||"car"};e.userData.vehicleState=s;try{typeof localStorage<"u"&&localStorage.setItem(t,JSON.stringify(s))}catch{}}selectStudioObject(e){if(this.gameMode!=="studio"||!this.worldObjects||this.worldObjects.length===0)return null;const t=new U;this.controls&&this.controls.isLocked?t.set(0,0):e&&e.clientX!==void 0?(t.x=e.clientX/window.innerWidth*2-1,t.y=-(e.clientY/window.innerHeight)*2+1):t.set(0,0),this._studioRaycaster.setFromCamera(t,this.camera);const s=this.worldObjects.filter(n=>n&&n.userData&&n.userData.gameName!=="Ground"),i=this._studioRaycaster.intersectObjects(s,!0);if(!i.length)return this.clearStudioSelection(),null;let o=i[0].object;for(;o&&!this.worldObjects.includes(o);)o=o.parent;return o&&this.setStudioSelection(o),o}moveSelectedObject(e,t,s=0){if(!this.studioSelected)return;const i=this.studioSelected;i.position.x+=e,i.position.z+=t,i.position.y+=s,s===0&&this.world&&typeof this.world.getHeightAt=="function"&&(i.position.y=this.world.getHeightAt(i.position.x,i.position.z)),this.refreshStudioSelectionHelper()}clearStudioSelection(){if(this.studioSelected=null,this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}this.selectionInfo&&this.selectionInfo.classList.add("hidden")}removeSelectedObject(){if(!this.studioSelected)return;const e=this.studioSelected;this.clearStudioSelection();try{this.scene.remove(e)}catch{}if(this.worldObjects){const t=this.worldObjects.indexOf(e);t>=0&&this.worldObjects.splice(t,1)}}setStudioSelection(e){if(this.studioSelected=e,this.selectionInfo)if(e&&e.userData){const t=e.userData;this.selectionInfo.innerText=`${t.gameName||"Object"} (${t.gameId||"---"})`,this.selectionInfo.classList.remove("hidden")}else this.selectionInfo.classList.add("hidden");this.refreshStudioSelectionHelper()}refreshStudioSelectionHelper(){if(this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}if(this.studioSelected)try{const e=this.buildStudioSelectionBox(this.studioSelected);console.log("[DEBUG BOX] Creating Box3Helper with box:",e),this.studioSelectionHelper=new gt(e,16766720),this.studioSelectionHelper.material.depthTest=!1,this.studioSelectionHelper.material.transparent=!0,this.studioSelectionHelper.material.opacity=.9,this.scene.add(this.studioSelectionHelper),console.log("[DEBUG BOX] Box3Helper added to scene successfully")}catch(e){console.error("[DEBUG BOX] ERROR creating Box3Helper:",e),this.studioSelectionHelper=null}}buildStudioSelectionBox(e){var o,n;console.log("[DEBUG BOX] Building box for:",(o=e.userData)==null?void 0:o.gameName,"isNPC:",(n=e.userData)==null?void 0:n.isNPC);const t=new Je;let s=0,i=0;return e.traverse(a=>{if(!a.isMesh||!a.geometry)return;s++;const l=a.userData||{},r=a.material;if(r&&r.transparent||l.isShadow||l.shadow){console.log("[DEBUG BOX] Skipping mesh (transparent or shadow):",a.name||"unnamed"),i++;return}if(!a.geometry.boundingBox)try{a.geometry.computeBoundingBox()}catch{}if(a.geometry.boundingBox){const c=a.geometry.boundingBox.clone();a.updateWorldMatrix(!0,!1),c.applyMatrix4(a.matrixWorld),t.union(c),console.log("[DEBUG BOX] Added mesh to box")}}),console.log("[DEBUG BOX] Processed:",s,"meshes, skipped:",i,"isEmpty:",t.isEmpty()),t.isEmpty()&&(console.log("[DEBUG BOX] Box is empty! Using fallback 1x1x1 box"),t.setFromCenterAndSize(e.position,new z(1,1,1))),t}checkVehicleCollision(e,t=null){if(!this.worldObjects)return!1;const s=2;for(let i=0;i<this.worldObjects.length;i++){const o=this.worldObjects[i];if(!o)continue;const n=o.userData||{};if(t&&o===t||n.gameName==="Ground"||n.type==="ground")continue;const a=o.position||(o.getWorldPosition?o.getWorldPosition(new z):null);if(!a)continue;const l=a.distanceTo(e);let r=1.5;if(o.geometry&&o.geometry.boundingSphere?r=o.geometry.boundingSphere.radius||r:n&&n.size==="large"?r=5:n.type==="vehicle"&&(r=2.5),l<s+r)return!0}return!1}updateAnimations(e){const t=this.moveForward||this.moveBackward||this.moveLeft||this.moveRight,s=10,i=this.isSprinting&&t?1.8:1;if(t){this.animTime+=e*s*i;const o=Math.sin(this.animTime)*(.5*i);this.leftLegPivot.rotation.x=o,this.rightLegPivot.rotation.x=-o}else this.leftLegPivot.rotation.x=X.lerp(this.leftLegPivot.rotation.x,0,e*s),this.rightLegPivot.rotation.x=X.lerp(this.rightLegPivot.rotation.x,0,e*s);if(this.isBlocking){const o=-Math.PI/2.5,n=.5;this.leftArmPivot.rotation.x=X.lerp(this.leftArmPivot.rotation.x,o,e*15),this.rightArmPivot.rotation.x=X.lerp(this.rightArmPivot.rotation.x,o,e*15),this.leftArmPivot.rotation.z=X.lerp(this.leftArmPivot.rotation.z,-n,e*15),this.rightArmPivot.rotation.z=X.lerp(this.rightArmPivot.rotation.z,n,e*15)}else if(this.isPunching){this.punchTime+=e*20;const o=-Math.PI/2+Math.sin(this.punchTime)*.8;this.punchSide===0?(this.rightArmPivot.rotation.x=o,this.leftArmPivot.rotation.x=X.lerp(this.leftArmPivot.rotation.x,0,e*10)):(this.leftArmPivot.rotation.x=o,this.rightArmPivot.rotation.x=X.lerp(this.rightArmPivot.rotation.x,0,e*10)),this.punchTime>Math.PI&&(this.isPunching=!1,this.rightArmPivot.rotation.x=0,this.leftArmPivot.rotation.x=0),this.leftArmPivot.rotation.z=X.lerp(this.leftArmPivot.rotation.z,0,e*10),this.rightArmPivot.rotation.z=X.lerp(this.rightArmPivot.rotation.z,0,e*10)}else{if(t){const o=Math.sin(this.animTime)*.5*i;this.leftArmPivot.rotation.x=-o,this.rightArmPivot.rotation.x=o}else this.leftArmPivot.rotation.x=X.lerp(this.leftArmPivot.rotation.x,0,e*10),this.rightArmPivot.rotation.x=X.lerp(this.rightArmPivot.rotation.x,0,e*10);this.leftArmPivot.rotation.z=X.lerp(this.leftArmPivot.rotation.z,0,e*10),this.rightArmPivot.rotation.z=X.lerp(this.rightArmPivot.rotation.z,0,e*10)}if(this.hitTimer>0){this.hitTimer-=e;const o=Math.max(0,this.hitTimer)/.6,n=X.lerp(-Math.PI/2.2,0,1-o);this.leftArmPivot.rotation.x=X.lerp(this.leftArmPivot.rotation.x,n,e*20),this.rightArmPivot.rotation.x=X.lerp(this.rightArmPivot.rotation.x,n,e*20)}}punch(){if(!(this.stamina<15)&&!(this.isPunching||this.isBlocking)&&(this.isPunching=!0,this.punchTime=0,this.punchSide=this.punchSide===0?1:0,this.stamina=Math.max(0,this.stamina-15),this.isTired=!1,this.punchCount=0,this.enemyManager&&this.enemyManager.enemies)){const e=new z;this.mesh.getWorldDirection(e);let t=!1;if(this.enemyManager.enemies.forEach(s=>{if(this.mesh.position.distanceTo(s.position)<3){const o=new z().subVectors(s.position,this.mesh.position).normalize();if(e.angleTo(o)<Math.PI/3){s.takeDamage(10);const a=e.clone().multiplyScalar(2);s.position.add(a),t=!0}}}),this.gameMode==="multiplayer"&&this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const s=Math.PI/3,i=3;this.multiplayerClient.others.forEach((o,n)=>{if(!o||!o.position||o.userData&&o.userData.dead||this.mesh.position.distanceTo(o.position)>i)return;const l=new z().subVectors(o.position,this.mesh.position).normalize();e.angleTo(l)<s&&(typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(n,10),t=!0)})}t&&this.playSmack()}}playSmack(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playSmack());return}if(this.smackBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.smackBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playSmack error:",e)}}equipBackpack(e=2899536){const t=this.backpackColor;this.backpack&&this.backpack.parent&&this.backpack.parent.remove(this.backpack);const s=new O;s.position.set(0,1.25,-.32);const i=new v(new k(.7,.9,.35),new E({color:e,metalness:.15,roughness:.8}));i.position.set(0,0,0),s.add(i);const o=new v(new k(.6,.25,.16),new E({color:3426654,metalness:.1,roughness:.8}));o.position.set(0,-.55,.22),s.add(o);const n=new E({color:2042938,metalness:.1,roughness:.9}),a=new v(new k(.1,.82,.07),n);a.position.set(-.28,-.03,.2);const l=a.clone();return l.position.x=.28,s.add(a,l),this.mesh.add(s),this.backpack=s,this.backpackColor=e,t}queueHurtBeat(){if(this._hurtAccumulator+=1,this._hurtAccumulator>=2){const e=Math.floor(this._hurtAccumulator/2);this._hurtQueue+=e,this._hurtAccumulator-=e*2}this._hurtQueue===0&&this._hurtAccumulator>0&&(this._hurtQueue=1,this._hurtAccumulator=0),this._hurtBeatTimer||this._playHurtBeatLoop()}_playHurtBeatLoop(){if(this._hurtQueue<=0){this._hurtBeatTimer=null;return}this.playHurt(),this._hurtQueue=Math.max(0,this._hurtQueue-1),this._hurtBeatTimer=setTimeout(()=>this._playHurtBeatLoop(),2e3)}clearHurtQueue(){this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer&&(clearTimeout(this._hurtBeatTimer),this._hurtBeatTimer=null)}playHurt(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playHurt());return}if(this.ughBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.ughBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playHurt error:",e)}}playVehicleDoor(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playVehicleDoor());return}if(this.vehicleDoorBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.vehicleDoorBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playVehicleDoor error:",e)}}handleVehicleDriveSound(e){try{if(!this.audioCtx||!this.enableVehicleDriveSound){this.stopVehicleDriveSound();return}if(!this.vehicleDriveBuffer){this.stopVehicleDriveSound();return}if(e===this._lastVehicleDriveActive&&(e&&this._vehicleDriveSource||!e&&!this._vehicleDriveSource))return;if(this._lastVehicleDriveActive=e,e){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._vehicleDriveSource)return;const t=this.audioCtx.createBufferSource();t.buffer=this.vehicleDriveBuffer,t.loop=!0;const s=this.audioCtx.createGain();s.gain.value=this.sfxVolume*.4,t.connect(s),s.connect(this.audioCtx.destination),t.start(0),this._vehicleDriveSource=t,this._vehicleDriveGain=s,t.onended=()=>{this._vehicleDriveSource=null,this._vehicleDriveGain=null}}else this.stopVehicleDriveSound()}catch(t){console.warn("handleVehicleDriveSound error:",t)}}stopVehicleDriveSound(){if(this._lastVehicleDriveActive=!1,this._vehicleDriveSource){try{this._vehicleDriveSource.stop()}catch{}try{this._vehicleDriveSource.disconnect()}catch{}}if(this._vehicleDriveGain)try{this._vehicleDriveGain.disconnect()}catch{}this._vehicleDriveSource=null,this._vehicleDriveGain=null}handleFootsteps(e){try{if(this.isInVehicle){this.stopFootsteps();return}if(!this.audioCtx||!this.footstepsBuffer){this.stopFootsteps();return}if(e===this._lastFootstepsActive&&(e&&this._footstepsSource||!e&&!this._footstepsSource)){if(e&&this._footstepsSource){const t=this.isSprinting?1.4:this.isCrouching?.8:1;this._footstepsSource.playbackRate.value=t}return}if(this._lastFootstepsActive=e,e){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._footstepsSource){try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}const t=this.audioCtx.createBufferSource();t.buffer=this.footstepsBuffer,t.loop=!0,t.playbackRate.value=this.isSprinting?1.4:this.isCrouching?.8:1;const s=this.audioCtx.createGain();s.gain.value=this.sfxVolume*.35,t.connect(s),s.connect(this.audioCtx.destination),t.start(0),this._footstepsSource=t,this._footstepsGain=s,t.onended=()=>{this._footstepsSource=null,this._footstepsGain=null}}else this.stopFootsteps()}catch(t){console.warn("handleFootsteps error:",t)}}stopFootsteps(){if(this._lastFootstepsActive=!1,this._footstepsSource){try{this._footstepsSource.onended=null}catch{}try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}get position(){return this.mesh.position}getSurfaceHeight(e,t){let s=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(e,t):0;return(this.world&&this.world.objects?this.world.objects:[]).forEach(o=>{if(!(!o||!o.userData)){if(o.userData.type==="block"){const n=o.userData.size||this.blockSize;if(Math.abs(o.position.x-e)<n*.6&&Math.abs(o.position.z-t)<n*.6){const a=o.position.y+n/2;a>s&&(s=a)}}if(o.userData.colliderBox){const n=o.userData.colliderBox;e>=n.min.x&&e<=n.max.x&&t>=n.min.z&&t<=n.max.z&&n.max.y>s&&(s=n.max.y)}}}),s}adjustBlockSize(e){const t=Math.max(this.minBlockSize,Math.min(this.maxBlockSize,this.blockSize+e));this.blockSize=t,console.log("Block size:",this.blockSize.toFixed(2))}moveLastBlock(){if(!this.placedBlocks.length)return;const e=this.placedBlocks[this.placedBlocks.length-1];if(!e)return;const t=this.getBlockTarget(e);e.position.set(t.position.x,t.position.y,t.position.z)}getBlockTarget(e=null){const t=e&&e.userData&&e.userData.size?e.userData.size:this.blockSize,s=new Y;s.setFromCamera(new U(0,0),this.camera);const i=c=>Math.round(c);let o=null;if(this.world&&Array.isArray(this.world.objects)){const c=this.world.objects.filter(f=>f&&f.userData&&(f.userData.type==="block"||f.userData.gameName==="Ground")),u=s.intersectObjects(c,!0);u.length>0&&(o=u[0].point.clone())}if(!o){const c=new z;this.camera.getWorldDirection(c),o=this.mesh.position.clone().add(c.multiplyScalar(1.2))}const n=new z(i(o.x),o.y,i(o.z));if(this.world&&typeof this.world.halfMapSize=="number"){const c=this.world.halfMapSize-1;n.x=Math.max(-c,Math.min(c,n.x)),n.z=Math.max(-c,Math.min(c,n.z))}let a=this.world.getHeightAt?this.world.getHeightAt(n.x,n.z):o.y;const r=(this.world.objects||[]).filter(c=>c.userData&&c.userData.type==="block"&&c!==e).filter(c=>Math.abs(c.position.x-n.x)<.1&&Math.abs(c.position.z-n.z)<.1);r.length>0&&(a=Math.max(...r.map(u=>u.position.y+(u.userData&&u.userData.size?u.userData.size/2:t/2))));const h=a+t/2;return{position:new z(n.x,h,n.z),size:t}}updateBlockPreview(){if(!this.previewBlock)return;const e=this.getBlockTarget();this.previewBlock.visible=!0,this.previewBlock.position.copy(e.position);const t=e.size/this.blockSize;this.previewBlock.scale.set(t,t,t)}removeLastBlock(){if(!this.placedBlocks.length)return;const e=this.placedBlocks.pop();e&&e.parent&&e.parent.remove(e),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(t=>t!==e)),e&&e.geometry&&e.geometry.dispose(),e&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),this.selectedBlock===e&&this.clearBlockSelection()}selectBlockUnderCrosshair(){if(!this.world||!this.world.objects)return!1;const e=new Y;e.setFromCamera(new U(0,0),this.camera);const t=e.intersectObjects(this.world.objects,!0);if(t.length===0)return this.clearBlockSelection(),!1;let s=null;for(const i of t){let o=i.object;for(;o&&o.parent;){if(o.userData&&o.userData.type==="block"){s=o;break}o=o.parent}if(s)break}return s?(this.setBlockSelection(s),!0):(this.clearBlockSelection(),!1)}setBlockSelection(e){this.clearBlockSelection(),this.selectedBlock=e;const t=new yt(e,16776960);t.userData={ignoreSelect:!0},this.scene.add(t),this.selectedBlockHelper=t}clearBlockSelection(){this.selectedBlock=null,this.selectedBlockHelper&&(this.scene.remove(this.selectedBlockHelper),this.selectedBlockHelper.material&&this.selectedBlockHelper.material.dispose(),this.selectedBlockHelper.geometry&&this.selectedBlockHelper.geometry.dispose(),this.selectedBlockHelper=null)}removeBlock(e){e&&(this.placedBlocks=this.placedBlocks.filter(t=>t!==e),e.parent&&e.parent.remove(e),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(t=>t!==e)),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),this.selectedBlock===e&&this.clearBlockSelection())}takeDamage(e){this.gameMode==="matrix"||this.gameMode==="studio"||this.multiplayerClient&&!this.multiplayerClient.isMatchLive()||(this.isBlocking&&(e*=.2,console.log("Blocked! Reduced damage to "+e)),this.shield>0?(this.shield-=e,this.shield<0&&(this.health+=this.shield,this.shield=0)):this.health-=e,e>0&&this.queueHurtBeat(),this.health<=0&&(this.health=0,this.die()),this.hitTimer=.6)}die(){this.gameMode==="matrix"||this.gameMode==="studio"||(this.handleFootsteps(!1),this.isDead=!0,this.controls.unlock(),this.mesh.rotation.x=-Math.PI/2,this.multiplayerClient&&typeof this.multiplayerClient.sendDeath=="function"&&this.multiplayerClient.sendDeath(),this.moveForward=this.moveBackward=this.moveLeft=this.moveRight=!1,this.velocity.set(0,0,0),this.hud&&typeof this.hud.showGameOver=="function"&&this.hud.showGameOver("YOU DIED"))}checkCollision(e,t){const s=new Y,i=.5,o=[1.6,1,.35];let n=this.worldObjects||[];if(this.enemyManager&&this.enemyManager.enemies){const r=this.enemyManager.enemies.map(h=>h.mesh);n=n.concat(r)}if(n.length===0)return!1;const a=1.5,l=r=>{let h=r;for(;h;){if(h.userData&&h.userData.colliderBox)return h.userData.colliderBox;h=h.parent}return null};for(const r of o){const h=this.mesh.position.clone();if(h.y+=r,s.set(h,e),n.length>0){const c=s.intersectObjects(n,!0);if(c.length>0){const u=c[0];if(u.distance<t+i){const f=l(u.object);if(f){const m=f.max.y,d=m-this.mesh.position.y;if(d<=a&&d>-.5)return this.mesh.position.y=m,this.velocity.y=0,this.canJump=!0,!1}return!0}}}}return!1}updateStamina(e){!this.isSprinting&&this.onGround&&(this.stamina=Math.min(this.maxStamina,this.stamina+15*e)),this.hud&&typeof this.hud.updateStamina=="function"&&this.hud.updateStamina(this.stamina,this.maxStamina)}}const ni="/threejs-voxel-firecraft/v1/dist/assets/mixkit-player-losing-or-failing-vCPqUTFf.ogg",ai="/threejs-voxel-firecraft/v1/dist/assets/game-level-completed-envato-mixkit.co-OEgWp6-U.ogg";class ri{constructor(e,t,s){this.player=e,this.world=t,this.settings=s||{},this.healthBar=document.getElementById("health-bar"),this.healthText=document.getElementById("health-text"),this.shieldBar=document.getElementById("shield-bar"),this.shieldText=document.getElementById("shield-text"),this.staminaBar=document.getElementById("stamina-bar"),this.staminaText=document.getElementById("stamina-text"),this.weaponName=document.getElementById("weapon-name"),this.ammoCount=document.getElementById("ammo-count"),this.slots=document.querySelectorAll(".slot"),this.timerValue=document.getElementById("timer-value"),this.debugContainer=document.getElementById("debug-container"),this.gameOverScreen=document.getElementById("game-over-screen"),this.selectionInfo=document.getElementById("selection-info"),this.selectionInfoTimeout=null,this.hotbar=document.getElementById("hotbar"),this.fpsCounter=document.getElementById("fps-counter"),this.enemyCount=document.getElementById("enemy-count"),this.killCount=document.getElementById("kill-count"),this.dropCount=document.getElementById("drop-count"),this.distanceTraveled=document.getElementById("distance-traveled"),this.playerSpeed=document.getElementById("player-speed"),this.mapSizeText=document.getElementById("map-size-readout"),this.memoryUsage=document.getElementById("memory-usage"),this.targetInspect=document.getElementById("target-inspect"),this.perfFrame=document.getElementById("perf-frame"),this.perfCalls=document.getElementById("perf-calls"),this.perfTris=document.getElementById("perf-tris"),this.perfGeoms=document.getElementById("perf-geoms"),this.perfTextures=document.getElementById("perf-textures"),this.perfPrograms=document.getElementById("perf-programs"),this.perfObjects=document.getElementById("perf-objects"),this.perfMem=document.getElementById("perf-mem"),this.perfCpu=document.getElementById("perf-cpu"),this.perfGpu=document.getElementById("perf-gpu"),this.perfGpuMem=document.getElementById("perf-gpu-mem"),this.dashboardEl=document.getElementById("dashboard"),this.perfDashboardEl=document.getElementById("perf-dashboard"),this.debugEnabled=!1,this.netStatsText=document.getElementById("net-stats"),this.netChart=document.getElementById("net-chart"),this.netChartCtx=this.netChart?this.netChart.getContext("2d"):null,this._renderer=null,this.frameTimeAvg=0,this.gpuInfo=null,this.gpuMemInfo=null,this._gl=null,this.debugInfo=document.getElementById("debug-info"),this.debugName=document.getElementById("debug-target-name"),this.debugId=document.getElementById("debug-target-id"),this.debugClearBtn=document.getElementById("debug-clear-btn"),this.debugEnabled=!1,this.hoveredEnemy=null,this.lastRaycastTime=0,this.raycastInterval=150,this.cachedEnemyMeshes=[],this.enemyMeshCacheTime=0,this.enemyMeshCacheDuration=500,this.lastHoverInfoText="",this.lastWeaponName="",this.lastAmmoText="",this.settings.debugMode?(this.debugInfo.style.display="block",this.debugEnabled=!0):(this.debugInfo.style.display="none",this.debugEnabled=!1),this.timeRemaining=30,this.lastTime=performance.now(),this.frames=0,this.fps=0,this.lastFpsTime=performance.now(),this.lastFrameTime=performance.now(),this.raycaster=new Y,this.mouse=new U,this.hoveredEnemy=null,this.hoveredPlayer=null,this.currentOutlinedEnemy=null,this.hoverInfo=document.getElementById("hover-info"),this.scopeOverlay=document.getElementById("scope-overlay"),this.minimapContainer=document.getElementById("minimap"),this.minimapCanvas=document.getElementById("minimap-canvas"),this.minimapCtx=this.minimapCanvas?this.minimapCanvas.getContext("2d"):null,this.minimapSize=this.minimapCanvas?this.minimapCanvas.width:180,this.mapSize=t&&t.mapSize?t.mapSize:200,this.multiplayer=null,window.addEventListener("mousemove",i=>{const o=i.clientX/window.innerWidth*2-1,n=-(i.clientY/window.innerHeight)*2+1;if(this.mouse.set(o,n),this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const a=[];this.player.enemyManager.enemies.forEach(r=>{r.mesh.traverse(h=>{h.isMesh&&a.push(h)})}),this.raycaster.setFromCamera(this.mouse,this.player.camera);const l=this.raycaster.intersectObjects(a,!0);if(l.length>0){const r=l[0].object;let h=r,c=null;for(;h&&(c=this.player.enemyManager.enemies.find(u=>h.parent===u.mesh||h===u.mesh||u.mesh.children.includes(h)),!c);)h=h.parent;this.hoveredEnemy=c||r||null}else this.hoveredEnemy=null}if(this.player&&this.player.multiplayerClient&&this.player.multiplayerClient.others.size>0){const a=Array.from(this.player.multiplayerClient.others.values());this.raycaster.setFromCamera(this.mouse,this.player.camera);let l=this.raycaster.intersectObjects(a,!0);if(l.length===0&&(this.raycaster.setFromCamera(new U(0,0),this.player.camera),l=this.raycaster.intersectObjects(a,!0)),l.length>0){let r=l[0].object,h=null;for(;r;){if(r.userData&&r.userData.gameId){h=r.userData.gameId;break}r=r.parent}if(h){const c=this.player.multiplayerClient.others.get(h),u=this.player.mesh.position.distanceTo(l[0].point),f=c?c.position:l[0].point;let m=`Player ${h.substring(0,4)}`;this.player.multiplayerClient.remoteData&&this.player.multiplayerClient.remoteData[h]&&(m=this.player.multiplayerClient.remoteData[h].nick||m),this.hoverInfo.innerHTML=`${m} (${u.toFixed(1)}m)<br>Pos: (${f.x.toFixed(1)}, ${f.y.toFixed(1)}, ${f.z.toFixed(1)})`,this.hoverInfo.style.display="block",this.hoveredPlayer=h}}else this.hoveredEnemy||(this.hoveredPlayer=null,this.hoveredEnemy||(this.hoverInfo.style.display="none"))}});try{this.slots.forEach((i,o)=>{const n=a=>{try{a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),this.player&&typeof this.player.switchWeapon=="function"&&this.player.switchWeapon(o)}catch{}};i.addEventListener("pointerdown",n),i.addEventListener("touchstart",n,{passive:!1}),i.addEventListener("click",n)})}catch{}}update(e){var f,m;if(!this.player)return;const t=performance.now(),s=Math.max(0,Math.min(100,this.player.health/this.player.maxHealth*100));this.healthBar.style.width=`${s}%`,this.healthText.innerText=`${Math.ceil(this.player.health)} / ${this.player.maxHealth}`;const i=Math.max(0,Math.min(100,this.player.shield/this.player.maxShield*100));if(this.shieldBar.style.width=`${i}%`,this.shieldText.innerText=`${Math.ceil(this.player.shield)}`,this.staminaBar&&this.player.maxStamina){const d=Math.max(0,Math.min(100,this.player.stamina/this.player.maxStamina*100));this.staminaBar.style.width=`${d}%`,this.staminaText.innerText=`${Math.ceil(this.player.stamina)}`}const o=this.player.weapons[this.player.currentWeaponIndex];this.lastWeaponName!==o.name&&(this.weaponName.innerText=o.name,this.lastWeaponName=o.name);let n;o.name==="Fist"?n="âˆž":n=o.ammo===1/0?"âˆž":`${o.currentMag} / ${o.ammo}`,this.lastAmmoText!==n&&(this.ammoCount.innerText=n,this.lastAmmoText=n);const a=document.getElementById("crosshair");if(a&&(a.classList.remove("target-red","target-yellow"),o&&o.range&&o.range),this.slots.forEach((d,p)=>{p===this.player.currentWeaponIndex?d.classList.add("active"):d.classList.remove("active")}),t-this.lastTime>1e3){this.timeRemaining--,this.timeRemaining<0&&(this.timeRemaining=0);const d=Math.floor(this.timeRemaining/60).toString().padStart(2,"0"),p=(this.timeRemaining%60).toString().padStart(2,"0");this.timerValue.innerText=`${d}:${p}`,this.lastTime=t}if(this.player.isDead&&this.player.gameMode!=="matrix"&&this.showGameOver("YOU DIED"),this.updateMinimap(),this.hoveredEnemy=null,this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const d=[];this.player.enemyManager.enemies.forEach(M=>{M.mesh.traverse(b=>{b.isMesh&&d.push(b)})}),this.raycaster.setFromCamera(this.mouse,this.player.camera);const p=this.raycaster.intersectObjects(d,!0);let g=null;if(p.length>0){const M=p[0].object;g=p[0].distance;let b=M,S=null;for(;b&&(S=this.player.enemyManager.enemies.find(C=>b.parent===C.mesh||b===C.mesh||C.mesh.children.includes(b)),!S);)b=b.parent;this.hoveredEnemy=S||M||null}a&&this.hoveredEnemy&&g!==null&&(g<=(o.range||1e3)?a.classList.add("target-red"):a.classList.add("target-yellow"))}if(this.player&&this.player.enemyManager&&this.currentOutlinedEnemy!==this.hoveredEnemy){if(this.currentOutlinedEnemy&&this.currentOutlinedEnemy._outline){try{this.currentOutlinedEnemy.mesh.remove(this.currentOutlinedEnemy._outline)}catch{}this.currentOutlinedEnemy._outline=null}if(this.hoveredEnemy&&this.hoveredEnemy.mesh){const d=new O;this.hoveredEnemy.mesh.traverse(p=>{if(p.isMesh){const g=new v(p.geometry,new ue({color:16776960,side:wt}));g.position.copy(p.position),g.quaternion.copy(p.quaternion),g.scale.copy(p.scale).multiplyScalar(1.06),g.renderOrder=999,g.material.depthTest=!0,d.add(g)}}),this.hoveredEnemy.mesh.add(d),this.hoveredEnemy._outline=d}this.currentOutlinedEnemy=this.hoveredEnemy}let l=null;if(this.hoveredPlayer=null,t-this.lastRaycastTime>=this.raycastInterval&&!this.hoveredEnemy&&this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0&&(this.lastRaycastTime=t,(t-this.enemyMeshCacheTime>=this.enemyMeshCacheDuration||this.cachedEnemyMeshes.length===0)&&(this.cachedEnemyMeshes=[],this.player.enemyManager.enemies.forEach(d=>{d.mesh.traverse(p=>{p.isMesh&&this.cachedEnemyMeshes.push(p)})}),this.enemyMeshCacheTime=t),this.cachedEnemyMeshes.length>0)){this.raycaster.setFromCamera(new U(0,0),this.player.camera);const d=this.raycaster.intersectObjects(this.cachedEnemyMeshes,!1);if(d.length>0){let g=d[0].object,M=null;for(;g&&(M=this.player.enemyManager.enemies.find(b=>g.parent===b.mesh||g===b.mesh||b.mesh.children.includes(g)),!M);)g=g.parent;M?this.hoveredEnemy=M:this.hoveredEnemy=null}else this.hoveredEnemy=null}if(!this.hoveredEnemy&&this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0){const d=[];if(this.multiplayer.others.forEach(p=>{p&&(p.isMesh?d.push(p):p.traverse&&p.traverse(g=>{g.isMesh&&d.push(g)}))}),d.length>0){this.raycaster.setFromCamera(new U(0,0),this.player.camera);const p=this.raycaster.intersectObjects(d,!0);if(p.length>0){let g=p[0].object;for(;g.parent&&!((f=g.userData)!=null&&f.nick)&&!this.multiplayer.others.has((m=g.userData)==null?void 0:m.gameId);)g=g.parent;this.hoveredPlayer=g}}}if(this.hoverInfo){let d="",p=!1;if(this.hoveredEnemy){const b=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,S=b&&b.userData&&(b.userData.gameId||b.userData.gameid)?b.userData.gameId||b.userData.gameid:"---",C=this.hoveredEnemy.position?this.hoveredEnemy.position:b?b.position:null;l=C?this.player.position.distanceTo(C):null;const D=l?l.toFixed(2):"---";d=`${S} â€¢ ${D}m`,p=!0}else if(this.hoveredPlayer){const b=this.hoveredPlayer.userData&&this.hoveredPlayer.userData.nick?this.hoveredPlayer.userData.nick:"Player";let S=null;this.hoveredPlayer.getWorldPosition?(S=new z,this.hoveredPlayer.getWorldPosition(S)):S=this.hoveredPlayer.position||null,l=S?this.player.position.distanceTo(S):null;const C=l?l.toFixed(2):"---";d=`${b} â€¢ ${C}m`,p=!0}this.lastHoverInfoText!==d&&(this.hoverInfo.innerText=d,this.lastHoverInfoText=d);const g=this.hoverInfo.style.display,M=p?"block":"none";g!==M&&(this.hoverInfo.style.display=M)}if(a){a.classList.remove("target-red","target-yellow");const d=o&&o.range?o.range:1e3;this.hoveredEnemy&&l!==null&&(l<=d?a.classList.add("target-red"):a.classList.add("target-yellow"))}if(!this.debugEnabled)return;this.frames++;const h=performance.now();h-this.lastFpsTime>=1e3&&(this.fpsCounter.innerText=this.frames,this.frames=0,this.lastFpsTime=h,performance.memory&&this.memoryUsage&&(this.memoryUsage.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)));const c=h-this.lastFrameTime;if(this.lastFrameTime=h,this.frameTimeAvg=this.frameTimeAvg===0?c:this.frameTimeAvg*.9+c*.1,this.player.enemyManager&&(this.enemyCount.innerText=this.player.enemyManager.enemies.length,this.killCount.innerText=this.player.enemyManager.killedCount||0),this.dropCount){const d=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;if(d&&Array.isArray(d.items)){const p=d.items.filter(g=>!(g.userData&&g.userData.isOpened)).length;this.dropCount.innerText=p}else this.dropCount.innerText="0"}const u=(this.player.distanceTraveled/1e3).toFixed(2);if(this.distanceTraveled&&(this.distanceTraveled.innerText=u),this.playerSpeed){let d=0;this.player.isInVehicle&&typeof this.player.currentSpeed=="number"?d=this.player.currentSpeed*3.6:typeof this.player.currentSpeed=="number"&&(d=this.player.currentSpeed*3.6),this.playerSpeed.innerText=d.toFixed(1)}if(this.mapSizeText){const d=this.world&&this.world.mapSize?this.world.mapSize:this.mapSize;this.mapSizeText.innerText=Math.round(d)}if(this._renderer){if(this.isPerfCollapsed())return;const d=this._renderer.info;this.perfFrame&&(this.perfFrame.innerText=c.toFixed(1)),this.perfCalls&&(this.perfCalls.innerText=d.render.calls),this.perfTris&&(this.perfTris.innerText=d.render.triangles),this.perfGeoms&&(this.perfGeoms.innerText=d.memory.geometries),this.perfTextures&&(this.perfTextures.innerText=d.memory.textures),this.perfPrograms&&(this.perfPrograms.innerText=d.programs?d.programs.length:"0");let p=0;this.world&&Array.isArray(this.world.objects)&&(p+=this.world.objects.length);const g=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;g&&Array.isArray(g.items)&&(p+=g.items.length),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&(p+=this.player.enemyManager.enemies.length),this.perfObjects&&(this.perfObjects.innerText=p),this.perfMem&&performance.memory&&(this.perfMem.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)),this.perfCpu&&(this.perfCpu.innerText=`${this.frameTimeAvg.toFixed(1)} ms`),this.perfGpu&&(this.perfGpu.innerText=this.gpuInfo||"Unsupported"),this.updateGpuMemory()}if(this.updateNetPanel(),this.player){document.getElementById("fps-counter").innerText=Math.round(1/(window.game?window.game.clock.getDelta():.016)),document.getElementById("player-speed").innerText=(this.player.currentSpeed*3.6).toFixed(1),document.getElementById("distance-traveled").innerText=(this.player.distanceTraveled/1e3).toFixed(2);const d=this.player.mesh.position,p=`Pos: (${d.x.toFixed(1)}, ${d.y.toFixed(1)}, ${d.z.toFixed(1)})`;let g=document.getElementById("player-coords");g||(g=document.createElement("div"),g.id="player-coords",document.getElementById("dashboard").appendChild(g)),g.innerText=p;let M=document.getElementById("screen-res");M||(M=document.createElement("div"),M.id="screen-res",document.getElementById("dashboard").appendChild(M)),M.innerText=`Res: ${window.innerWidth}x${window.innerHeight}`,Math.max(0,Math.min(100,this.player.health))}if(this.weaponName.innerText=o.name,this.player.isReloading?this.ammoCount.innerText="RELOADING...":this.ammoCount.innerText=o.ammo===1/0?"âˆž":`${o.currentMag} / ${o.ammo}`,this.debugContainer&&(this.debugContainer.innerHTML=""),this.debugInfo)if(this.settings.debugMode)if(this.debugInfo.style.display="block",this.hoveredEnemy){const d=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,p=d&&d.userData&&d.userData.gameName?d.userData.gameName:"Enemy",g=d&&d.userData&&(d.userData.gameId||d.userData.gameid)?d.userData.gameId||d.userData.gameid:"---",M=this.hoveredEnemy.position?this.hoveredEnemy.position:d?d.position:null,b=M?this.player.position.distanceTo(M).toFixed(2):"---";this.debugName.innerText=p,this.debugId.innerText=`${g} (${b}m)`}else this.debugName.innerText="None",this.debugId.innerText="---";else this.debugInfo.style.display="none";if(this.scopeOverlay){const d=this.player.isAiming&&o&&o.name==="Sniper";this.scopeOverlay.classList.toggle("hidden",!d),a&&a.classList.toggle("hidden",d)}this.updateMinimap(),this.slots.forEach(d=>d.style.display="none"),this.player.weapons.forEach((d,p)=>{let g=this.slots[p];g&&(g.style.display="flex",g.innerText=p+1,p===this.player.currentWeaponIndex?g.classList.add("active"):g.classList.remove("active"))}),this.player.isDead&&this.player.gameMode!=="matrix"&&this.showGameOver("YOU DIED"),this.updateTargetInspect()}showSelectionInfo(e,t){if(!this.selectionInfo)return;const s=e||"Object",i=t||"---";this.selectionInfo.innerText=`${s} (${i})`,this.selectionInfo.classList.remove("hidden"),this.selectionInfoTimeout&&clearTimeout(this.selectionInfoTimeout),this.selectionInfoTimeout=setTimeout(()=>{try{this.selectionInfo.classList.add("hidden")}catch{}},2500)}updateTargetInspect(){if(!this.targetInspect||!this.player||!this.player.camera)return;const e=this.raycaster,t=new U(0,0);e.setFromCamera(t,this.player.camera);const s=[];if(this.world&&Array.isArray(this.world.objects)&&s.push(...this.world.objects),this.world&&this.world.itemManager&&Array.isArray(this.world.itemManager.items)&&s.push(...this.world.itemManager.items),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&this.player.enemyManager.enemies.forEach(h=>{h&&h.mesh&&s.push(h.mesh)}),s.length===0){this.targetInspect.innerText="Target: ---";return}const i=Array.from(new Set(s)),o=e.intersectObjects(i,!0);if(!o.length){this.targetInspect.innerText="Target: ---";return}let n=null;for(let h=0;h<o.length;h++){let c=o[h].object;for(;c;){if(c.userData&&(c.userData.gameName||c.userData.type||c.userData.gameId||c.userData.gameid)){n=c.userData;break}c=c.parent}if(n)break}if(!n){this.targetInspect.innerText="Target: ---";return}const a=n.gameName||"Object",l=n.gameId||n.gameid||"---",r=n.type||"---";this.targetInspect.innerText=`Target: ${a} (ID: ${l}) [${r}]`}showGameOver(e){if(this.player&&this.player.gameMode==="matrix"||this.gameOverShown)return;this.gameOverShown=!0,this.gameOverScreen.classList.remove("hidden"),document.getElementById("game-over-title").innerText=e;try{const s=document.getElementById("touch-controls");s&&(s.style.display="none")}catch{}this.hotbar&&(this.hotbar.style.display="none");const t=document.getElementById("restart-btn");t.onclick=()=>{location.reload()},t.style.pointerEvents="auto",t.style.cursor="pointer";try{typeof window<"u"&&window.game&&e&&e.toUpperCase().includes("DIED")&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(ni)}catch{}}showVictory(){if(!(this.player&&this.player.gameMode==="matrix")){this.gameOverShown=!1,this.showGameOver("VICTORY ROYALE!"),document.getElementById("game-over-title").style.color="#f1c40f";try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}try{const e=document.getElementById("touch-controls");e&&(e.style.display="none")}catch{}try{this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch{}try{typeof window<"u"&&window.game&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(ai)}catch{}}}updateMinimap(){if(!this.minimapContainer)return;const e=this.settings.showMinimap!==!1;if(this.minimapContainer.classList.toggle("hidden",!e),!e||!this.minimapCtx||!this.player)return;const t=this.minimapCtx,s=this.minimapSize;t.clearRect(0,0,s,s),t.fillStyle="rgba(10, 12, 20, 0.75)",t.fillRect(0,0,s,s),t.strokeStyle="rgba(255, 255, 255, 0.25)",t.lineWidth=2,t.strokeRect(1,1,s-2,s-2);const i=Math.max(1,this.world&&this.world.halfMapSize?this.world.halfMapSize:this.mapSize/2),o=s*.45,n=s/2,a=s/2;if(this.world&&typeof this.world.stormRadius=="number"&&this.world.stormRadius>0){const u=Math.max(0,Math.min(1.2,this.world.stormRadius/i)),f=o*u;t.beginPath(),t.strokeStyle="rgba(157, 77, 187, 0.85)",t.lineWidth=3,t.arc(n,a,f,0,Math.PI*2),t.stroke()}const l=this.player&&this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)?this.player.enemyManager.enemies:[];l.length&&(t.fillStyle="#ff3b30",t.strokeStyle="#660000",t.lineWidth=1.5,l.forEach(u=>{if(!u)return;const f=u.position||u.mesh&&u.mesh.position;if(!f)return;const m=Math.max(n-o,Math.min(n+o,n+f.x/i*o)),d=Math.max(a-o,Math.min(a+o,a-f.z/i*o));t.beginPath(),t.arc(m,d,4,0,Math.PI*2),t.fill(),t.stroke()}));const r=this.world&&Array.isArray(this.world.objects)?this.world.objects.filter(u=>u&&u.userData&&u.userData.type==="house"):[];r.length&&(t.fillStyle="#ffd166",t.strokeStyle="#8c5a00",t.lineWidth=1,r.forEach(u=>{const f=u.position;if(!f)return;const m=Math.max(n-o,Math.min(n+o,n+f.x/i*o)),d=Math.max(a-o,Math.min(a+o,a-f.z/i*o));t.beginPath(),t.arc(m,d,3,0,Math.PI*2),t.fill(),t.stroke()}));const h=Math.max(n-o,Math.min(n+o,n+this.player.position.x/i*o)),c=Math.max(a-o,Math.min(a+o,a-this.player.position.z/i*o));t.beginPath(),t.fillStyle="#00d8ff",t.strokeStyle="#ffffff",t.lineWidth=2,t.arc(h,c,6,0,Math.PI*2),t.fill(),t.stroke(),this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach(u=>{if(!u||!u.position)return;const f=Math.max(n-o,Math.min(n+o,n+u.position.x/i*o)),m=Math.max(a-o,Math.min(a+o,a-u.position.z/i*o)),d=u.userData&&u.userData.color?u.userData.color:"#ffaa00";t.beginPath(),t.fillStyle=d,t.strokeStyle="#111",t.lineWidth=2,t.arc(f,m,5,0,Math.PI*2),t.fill(),t.stroke()});try{const u=new z;if(this.player&&this.player.camera&&this.player.camera.getWorldDirection&&this.player.camera.getWorldDirection(u),u.y=0,u.lengthSq()<1e-4&&this.player.mesh&&(u.set(0,0,-1).applyEuler(this.player.mesh.rotation),u.y=0),u.lengthSq()>1e-4){u.normalize();const f=u.x,m=-u.z,d=Math.atan2(m,f)+Math.PI/2;t.save(),t.translate(h,c),t.rotate(d),t.beginPath(),t.moveTo(0,-10),t.lineTo(6,8),t.lineTo(-6,8),t.closePath(),t.fillStyle="#00d8ff",t.strokeStyle="#003f4f",t.lineWidth=2,t.fill(),t.stroke(),t.restore()}}catch{}}updateNetPanel(){if(this.isPerfCollapsed()||!this.netStatsText&&!this.netChartCtx)return;const e=this.multiplayer&&typeof this.multiplayer.getNetStats=="function"?this.multiplayer.getNetStats():null;if(!e){this.netStatsText&&(this.netStatsText.innerText="offline"),this.netChartCtx&&this.netChartCtx.clearRect(0,0,this.netChart.width,this.netChart.height);return}const t=(e.txPerSec||0)/1024,s=(e.rxPerSec||0)/1024,i=typeof e.lastPing=="number"?`${Math.max(0,e.lastPing).toFixed(0)} ms`:"--";if(this.netStatsText&&(this.netStatsText.innerText=`â†‘ ${t.toFixed(1)} kbps â†“ ${s.toFixed(1)} kbps â€¢ ping ${i}`),!this.netChartCtx||!this.netChart)return;const o=this.netChartCtx,n=this.netChart.width,a=this.netChart.height,l=Array.isArray(e.history)?e.history:[];if(o.clearRect(0,0,n,a),!l.length)return;const r=l.reduce((d,p)=>Math.max(d,Math.max(p.tx||0,p.rx||0)/1024),1),h=2,c=l.length,u=d=>c<=1?h:h+d/(c-1)*(n-h*2),f=d=>{const p=Math.max(0,Math.min(1,d/1024/r));return a-h-p*(a-h*2)};o.strokeStyle="rgba(255,255,255,0.12)",o.beginPath(),o.moveTo(h,a-h),o.lineTo(n-h,a-h),o.stroke();const m=(d,p)=>{o.strokeStyle=d,o.beginPath(),l.forEach((g,M)=>{const b=u(M),S=f(p(g)||0);M===0?o.moveTo(b,S):o.lineTo(b,S)}),o.stroke()};m("rgba(0, 210, 255, 0.85)",d=>d.rx||0),m("rgba(255, 150, 50, 0.85)",d=>d.tx||0)}updateGpuMemory(){if(!this.perfGpuMem)return;if(!this.gpuMemInfo||!this._gl){if(performance.memory){const i=(performance.memory.usedJSHeapSize/1048576).toFixed(1),o=(performance.memory.jsHeapSizeLimit/1048576).toFixed(0);this.perfGpuMem.innerText=`${i} / ${o} MB (heap)`}else this.perfGpuMem.innerText="Unsupported";return}const e=performance.now();if(!this.gpuMemInfo.lastUpdate||e-this.gpuMemInfo.lastUpdate>1e3)try{const i=this._gl.getParameter(this.gpuMemInfo.ext.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX);this.gpuMemInfo.lastAvailKb=i||this.gpuMemInfo.lastAvailKb,this.gpuMemInfo.lastUpdate=e}catch{}const t=this.gpuMemInfo.totalKb?this.gpuMemInfo.totalKb/1024:null,s=this.gpuMemInfo.lastAvailKb?this.gpuMemInfo.lastAvailKb/1024:null;if(t&&s){const i=Math.max(0,t-s);this.perfGpuMem.innerText=`${i.toFixed(1)} / ${t.toFixed(1)} MB`}else s?this.perfGpuMem.innerText=`${s.toFixed(1)} MB free`:this.perfGpuMem.innerText="Unknown"}initGpuInfo(){if(!(!this._renderer||this.gpuInfo))try{const e=this._renderer.getContext();this._gl=e;const t=e.getExtension("WEBGL_debug_renderer_info"),s=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):e.getParameter(e.RENDERER);this.gpuInfo=s||"Unknown GPU";const i=e.getExtension("WEBGL_gpu_memory_info");if(i){const o=e.getParameter(i.GPU_MEMORY_INFO_TOTAL_AVAILABLE_MEMORY_KB)||e.getParameter(i.GPU_MEMORY_INFO_DEDICATED_VIDMEM_NVX)||null,n=e.getParameter(i.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX)||null;this.gpuMemInfo={ext:i,totalKb:o,lastAvailKb:n,lastUpdate:0}}}catch{this.gpuInfo="Unknown GPU"}}setRenderer(e){this._renderer=e,this.initGpuInfo()}setMultiplayer(e){this.multiplayer=e}isPerfCollapsed(){return this.perfEl&&this.perfEl.classList.contains("collapsed")}setDebugEnabled(e){this.debugEnabled=e;const t=document.querySelector(".dashboardContainer");t&&(t.style.display=e?"flex":"none"),this.dashboardEl&&(this.dashboardEl.style.display=e?"block":"none"),this.perfDashboardEl&&(this.perfDashboardEl.style.display=e?"block":"none")}}const hi="/threejs-voxel-firecraft/v1/dist/assets/mixkit-kill-blood-zombie-By90BKfb.ogg",li="/threejs-voxel-firecraft/v1/dist/assets/zombie-B8PCKsyJ.ogg";class ci{constructor(e,t,s,i){this.scene=e,this.player=t,this.world=s,this.enemies=[],this.spawnInterval=5e3,this.lastSpawn=0,this.killedCount=0,this.groanBuffer=null;const o=i&&(i.gameMode==="matrix"||i.gameMode==="studio"||i.gameMode==="matrix-ai")?0:i?i.enemyCount:15;this.targetCount=o,this.difficulty=i?i.difficulty:"medium",this.gameMode=i&&i.gameMode?i.gameMode:"arcade",this.sfxVolume=i&&i.sfxVolume!==void 0?i.sfxVolume/100:.5,this.studioAiEnabled=!1;for(let n=0;n<o;n++)this.spawnEnemy();this.deathBuffer=null;try{const n=window.AudioContext||window.webkitAudioContext;n&&(this.audioCtx=new n,fetch(hi).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.deathBuffer=a,this.enemies.forEach(l=>{l.audioCtx=this.audioCtx,l.deathBuffer=a})}).catch(a=>{}),fetch(li).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.groanBuffer=a,this.enemies.forEach(l=>{l.audioCtx=this.audioCtx,l.groanBuffer=a})}).catch(a=>{}))}catch{}}spawnEnemy(e=!1,t=null){if(!e&&(this.gameMode==="matrix"||this.gameMode==="studio"))return;const s=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let i=(Math.random()-.5)*s,o=(Math.random()-.5)*s;if(this.gameMode==="studio"&&this.player&&(i=this.player.position.x+(Math.random()-.5)*5,o=this.player.position.z+(Math.random()-.5)*5),this.gameMode==="matrix-ai"&&this.player){const c=(this.world&&this.world.halfMapSize?this.world.halfMapSize:100)*.6;let u=0;for(;u<10;){const f=this.player.position.x,m=this.player.position.z,d=i-f,p=o-m;if(Math.sqrt(d*d+p*p)>=c)break;i=(Math.random()-.5)*s,o=(Math.random()-.5)*s,u++}}const n=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(i,o):0,a=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let l=!1,r=t||"normal";if(t)r==="big"&&(l=!0);else if(this.gameMode==="survival"){const c=this.enemies.filter(d=>d.isBig).length,u=this.enemies.filter(d=>d.zombieType==="slender").length,f=Math.floor(this.targetCount/5),m=Math.floor(this.targetCount/10);if(c<f)l=!0,r="big";else if(u<m)r="slender";else{const d=this.enemies.filter(g=>!g.isBig&&g.zombieType==="normal").length;r=this.enemies.filter(g=>!g.isBig&&g.zombieType==="fat").length<d?"fat":"normal"}}else if(this.gameMode==="arcade"){const c=this.enemies.filter(f=>f.zombieType==="slender").length,u=Math.floor(this.targetCount/10);if(c<u)r="slender";else{const f=this.enemies.filter(d=>d.zombieType==="normal").length;r=this.enemies.filter(d=>d.zombieType==="fat").length<f?"fat":"normal"}}const h=new Ye(this.scene,i,n,o,this.difficulty,a,this.player,l,r);return h.audioCtx=this.audioCtx,h.deathBuffer=this.deathBuffer,h.groanBuffer=this.groanBuffer,h.world=this.world,this.gameMode==="studio"&&(h.studioMode=!0,h.isStudioNPC=!0),this.enemies.push(h),e&&this.gameMode==="studio"&&(this.studioAiEnabled=!1),h}spawnEnemyAt(e,t,s="normal"){const i=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(e,t):0,o=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let n=!1,a=s;a==="big"&&(n=!0);const l=new Ye(this.scene,e,i,t,this.difficulty,o,this.player,n,a);return l.audioCtx=this.audioCtx,l.deathBuffer=this.deathBuffer,l.groanBuffer=this.groanBuffer,l.world=this.world,l.studioMode=!0,l.isStudioNPC=!0,this.enemies.push(l),l}setTargetCount(e){typeof e=="number"&&e>=0&&(this.targetCount=e)}update(e){if(this.gameMode!=="matrix"&&!(this.gameMode==="studio"&&!this.studioAiEnabled)&&(this.enemies.forEach(t=>{if(t.update(e,this.player),Math.sqrt(t.position.x*t.position.x+t.position.z*t.position.z)>this.world.stormRadius&&t.takeDamage(5*e),this.world&&typeof this.world.halfMapSize=="number"){const i=this.world.halfMapSize-1;t.position.x=Math.max(-i,Math.min(i,t.position.x)),t.position.z=Math.max(-i,Math.min(i,t.position.z))}}),this.enemies=this.enemies.filter(t=>t.readyToDespawn?(this.killedCount++,!1):!0),this.gameMode==="survival"&&this.targetCount!==void 0&&this.targetCount>0)){const t=this.targetCount-this.enemies.length;if(t>0)for(let s=0;s<t;s++)this.spawnEnemy()}}getEnemyById(e){return e&&this.enemies.find(t=>t&&t.mesh&&t.mesh.userData&&t.mesh.userData.gameId===e)||null}applyRemoteZombieHit(e,t){const s=this.getEnemyById(e);return!s||s.isDead?null:(s.takeDamage(t),s.health)}syncZombieState(e,t){const s=this.getEnemyById(e);if(!s)return;s.health=t;const i=s.maxHealth||100,o=Math.max(0,s.health/i);s.healthBarFg&&(s.healthBarFg.scale.x=o),t<=0&&!s.isDead&&s.startDeath()}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e)),this.enemies.forEach(t=>{t&&typeof t.setSFXVolume=="function"&&t.setSFXVolume(this.sfxVolume)})}}class Ye{constructor(e,t,s,i,o,n=100,a=null,l=!1,r="normal",h=.5){this.scene=e,this.position=new z(t,s,i),this.mapHalfSize=n,this.world=null,this.player=a,this.isBig=l,this.zombieType=r,this.deathTimer=0,this.deathDuration=0,this.deathFallProgress=0,this.readyToDespawn=!1,this.groanBuffer=null,this.groanCooldown=0,this.groanRange=15,this._groanSource=null,this._groanGain=null,this.sfxVolume=h,o==="easy"?(this.health=50,this.damage=2,this.speed=3):o==="hard"?(this.health=150,this.damage=10,this.speed=6):(this.health=100,this.damage=5,this.speed=4.5),this.isBig&&(this.health*=5,this.damage*=2,this.speed*=.75),this.zombieType==="fat"&&(this.health*=1.5,this.speed*=.5),this.zombieType==="slender"&&(this.health*=.8,this.speed*=1.5,this.damage*=1.5,this.attackRange=3),this.maxHealth=this.health,this.state="wander",this.isDead=!1,this.attackRange=this.isBig?3.5:2,this.detectionRange=25,this.attackCooldown=1.5,this.lastAttack=0,this.wanderTarget=null,this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4,this.createMesh()}createMesh(){let e="Zombie";this.isBig?e="Big Zombie":this.zombieType==="fat"?e="Fat Zombie":this.zombieType==="slender"&&(e="Slenderman");let t;const s=this.position.x,i=this.position.y,o=this.position.z;this.zombieType==="slender"?t=vt(this.scene,s,i,o):this.isBig?t=bt(this.scene,s,i,o):this.zombieType==="fat"?t=Mt(this.scene,s,i,o):this.zombieType==="spider"?t=Gt(this.scene,s,i,o):t=xt(this.scene,s,i,o),this.mesh=t.mesh,this.leftArmPivot=t.leftArmPivot,this.rightArmPivot=t.rightArmPivot,this.leftLegPivot=t.leftLegPivot,this.rightLegPivot=t.rightLegPivot,this.mesh.userData={gameId:Math.random().toString(36).substr(2,9).toUpperCase(),gameName:e,isNPC:!0},this.animTime=0,this.attackAnimTime=0,this.attackAnimDuration=.5,this.createHealthBar()}createHealthBar(){const e=new te(1,.1),t=new ue({color:0});this.healthBarBg=new v(e,t);const s=this.zombieType==="slender"?3:2.3;this.healthBarBg.position.y=s,this.mesh.add(this.healthBarBg);const i=new te(1,.1),o=new ue({color:16711680});this.healthBarFg=new v(i,o),this.healthBarFg.position.y=s,this.healthBarFg.position.z=.01,this.mesh.add(this.healthBarFg)}update(e,t){if(this.isDead){this.updateDeath(e);return}this.groanCooldown=Math.max(0,this.groanCooldown-e),this.groanBuffer&&this.audioCtx&&t&&this.groanCooldown<=0&&this.position.distanceTo(t.position)<=this.groanRange&&(this.playGroan(),this.groanCooldown=2+Math.random()*2.5);const s=t.position;if(this.healthBarBg.lookAt(s),this.healthBarFg.lookAt(s),this.studioMode||this.isStudioNPC){this.animTime+=e,this.animateIdle();return}const i=this.position.distanceTo(s);i<this.detectionRange?this.state="chase":this.state="wander";let o=!1;if(this.state==="chase"){const n=this.hasLineOfSight(t,s);if(i<this.detectionRange&&n){const a=new z().subVectors(s,this.position).normalize();if(a.y=0,i>2){const r=a.clone(),h=Math.sin(performance.now()/500+this.position.x)*.5,c=new z(a.z,0,-a.x).multiplyScalar(h);r.add(c).normalize();const u=this.position.clone().add(r.multiplyScalar(this.speed*e));this.checkCollision(u)||this.position.copy(u),this.mesh.lookAt(s),o=!0}else{const r=a.clone().multiplyScalar(-1),h=this.position.clone().add(r.multiplyScalar(this.speed*e*.5));this.checkCollision(h)||this.position.copy(h),this.mesh.lookAt(s)}if(i<this.attackRange){const r=performance.now()/1e3;r-this.lastAttack>this.attackCooldown&&(t.takeDamage(this.damage),this.lastAttack=r,this.attackAnimTime=this.attackAnimDuration)}}else this.state="wander"}else{if(this.wanderTimer+=e,!this.wanderTarget||this.wanderTimer>this.wanderChangeInterval){const n=10+Math.random()*30,a=Math.random()*Math.PI*2,l=this.position.x+Math.cos(a)*n,r=this.position.z+Math.sin(a)*n,h=(m,d,p)=>Math.max(d,Math.min(p,m)),c=this.mapHalfSize*.9,u=h(l,-c,c),f=h(r,-c,c);this.wanderTarget=new z(u,0,f),this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4}if(this.wanderTarget){const n=new z().subVectors(this.wanderTarget,this.position);n.y=0,n.length()>.5?(n.normalize(),this.position.add(n.multiplyScalar(this.speed*e*.5)),this.mesh.lookAt(this.wanderTarget.x,this.position.y,this.wanderTarget.z),o=!0):(this.wanderTimer+=e,this.wanderTimer>this.wanderChangeInterval&&(this.wanderTarget=null,this.wanderTimer=0))}}if(this.mesh.position.copy(this.position),this.world&&typeof this.world.getHeightAt=="function"){const n=this.world.getHeightAt(this.position.x,this.position.z);this.mesh.position.y=Math.max(this.mesh.position.y,n),this.position.y=this.mesh.position.y}if(o){this.animTime+=e*5;const n=Math.sin(this.animTime)*.5;this.leftLegPivot.rotation.x=n,this.rightLegPivot.rotation.x=-n,this.leftArmPivot.rotation.x=-Math.PI/3+n*.2,this.rightArmPivot.rotation.x=-Math.PI/3-n*.2}else this.state!=="attack"&&(this.leftLegPivot.rotation.x=0,this.rightLegPivot.rotation.x=0,this.leftArmPivot.rotation.x=-Math.PI/3,this.rightArmPivot.rotation.x=-Math.PI/3);if(this.attackAnimTime>0){this.attackAnimTime=Math.max(0,this.attackAnimTime-e);const n=1-this.attackAnimTime/this.attackAnimDuration,a=Math.sin(n*Math.PI)*1.5;if(this.leftArmPivot.rotation.x=-Math.PI/2+a*.2,this.rightArmPivot.rotation.x=-Math.PI/2-a*.2,n>.3&&n<.7){const l=new z;this.mesh.getWorldDirection(l),l.y=0,l.normalize(),this.position.add(l.multiplyScalar(.02))}}}takeDamage(e){this.health-=e;const t=this.maxHealth||100,s=Math.max(0,this.health/t);this.healthBarFg.scale.x=s,this.mesh.traverse(i=>{if(i.isMesh&&i!==this.healthBarBg&&i!==this.healthBarFg){const o=i.material;if(!i.userData.originalColor&&o&&o.color)try{i.userData.originalColor=o.color.clone()}catch{i.userData.originalColor=null}if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new ne(16711680);else if(o&&o.color)try{o.color=o.color.clone().lerp(new ne(16711680),.6)}catch{}}}),setTimeout(()=>{this.isDead||this.mesh.traverse(i=>{if(i.isMesh&&i!==this.healthBarBg&&i!==this.healthBarFg){const o=i.material;if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new ne(0);else if(o&&o.color&&i.userData&&i.userData.originalColor)try{o.color.copy(i.userData.originalColor)}catch{}}})},100),this.health<=0&&!this.isDead&&this.startDeath()}playDeathSound(){try{const e=this.audioCtx.createBufferSource();e.buffer=this.deathBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume*1.4,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}catch(e){console.warn("playDeathSound error:",e)}}checkCollision(e){if(!this.scene)return!1;const t=.5;for(let s of this.scene.children)if(s.userData&&(s.userData.type==="house"||s.userData.type==="tree")){const i=s.position,o=Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2)),n=s.userData.type==="house"?5:2;if(o<t+n)return!0}return!1}hasLineOfSight(e,t){if(!this.scene)return!0;const s=new z().subVectors(t,this.position).normalize(),i=this.position.distanceTo(t),n=new Y(this.position.clone().add(new z(0,1,0)),s,0,i).intersectObjects(this.scene.children,!0);for(let a of n){if(a.object===this.mesh||a.object.parent===this.mesh||a.object===e.mesh||a.object.parent===e.mesh)continue;let l=a.object;for(;l.parent&&l.parent!==this.scene;)l=l.parent;if(l.userData&&(l.userData.type==="house"||l.userData.type==="tree"))return!1}return!0}startDeath(){this.isDead=!0,this.deathTimer=0,this.deathFallProgress=0,this.deathDuration=3+Math.random()*2,this.stopGroan(),this.healthBarBg&&(this.healthBarBg.visible=!1),this.healthBarFg&&(this.healthBarFg.visible=!1);const e=25,t=this.player&&this.player.position;if(t?this.position.distanceTo(t)<=e:!0)try{this.audioCtx&&this.deathBuffer&&(this.audioCtx.state==="suspended"?this.audioCtx.resume().then(()=>{this.playDeathSound()}):this.audioCtx.state==="running"&&this.playDeathSound())}catch(i){console.warn("Error playing death sound:",i)}}updateDeath(e){this.deathFallProgress=Math.min(1,this.deathFallProgress+e*2.5);const t=-Math.PI/2*this.deathFallProgress;this.mesh&&(this.mesh.rotation.x=t,this.mesh.position.y=Math.max(0,this.mesh.position.y-e*.6)),this.deathTimer+=e,this.deathTimer>=(this.deathDuration||3)&&(this.mesh&&this.mesh.parent&&this.scene.remove(this.mesh),this.readyToDespawn=!0)}playGroan(){try{if(!this.audioCtx||!this.groanBuffer)return;if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playGroan());return}const e=this.audioCtx.createBufferSource();e.buffer=this.groanBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume*.9,e.connect(t),t.connect(this.audioCtx.destination),e.onended=()=>{this._groanSource=null,this._groanGain=null},e.start(0),this._groanSource=e,this._groanGain=t}catch(e){console.warn("playGroan error:",e)}}stopGroan(){if(this._groanSource){try{this._groanSource.stop()}catch{}try{this._groanSource.disconnect()}catch{}this._groanSource=null}if(this._groanGain){try{this._groanGain.disconnect()}catch{}this._groanGain=null}}setSFXVolume(e){this.sfxVolume=e}}class di{constructor(e,t,s){this.scene=e,this.player=t,this.items=[],this.interactionPrompt=document.getElementById("interaction-prompt"),this.mapSize=s&&s.mapSize?s.mapSize:Ie,this.spawnSpan=this.mapSize*.75,this.glowRadius=7,this.world=null,this.settings=s||{},this.matrixDropInterval=5,this._matrixDropTimer=0,this.matrixDropBatchSize=10,this.matrixDropRadiusLimit=10,this.initLoot(),document.addEventListener("keydown",i=>{i.code==="KeyE"&&this.tryInteract()})}setWorld(e){this.world=e,this.realignItemsToGround()}getClampedCoord(e,t){if(this.world&&typeof this.world.halfMapSize=="number"){const s=this.world.halfMapSize-1;return{x:Math.max(-s,Math.min(s,e)),z:Math.max(-s,Math.min(s,t))}}return{x:e,z:t}}initLoot(){if(this.settings.gameMode==="matrix"||this.settings.gameMode==="studio"||this.settings.gameMode==="matrix-ai"||this.settings.skipLoot)return;for(let t=0;t<24;t++){let s=(Math.random()-.5)*this.spawnSpan,i=(Math.random()-.5)*this.spawnSpan;({x:s,z:i}=this.getClampedCoord(s,i)),this.createChest(s,.5,i)}for(let t=0;t<36;t++){let s=(Math.random()-.5)*this.spawnSpan,i=(Math.random()-.5)*this.spawnSpan;({x:s,z:i}=this.getClampedCoord(s,i)),this.spawnJuiceBottle(s,i)}const e=[2899536,15105570,1752220,15158332,10181046];for(let t=0;t<8;t++){let s=(Math.random()-.5)*this.spawnSpan,i=(Math.random()-.5)*this.spawnSpan;({x:s,z:i}=this.getClampedCoord(s,i));const o=e[t%e.length];this.spawnBackpack(s,i,o)}for(let t=0;t<12;t++){let s=(Math.random()-.5)*this.spawnSpan,i=(Math.random()-.5)*this.spawnSpan;({x:s,z:i}=this.getClampedCoord(s,i)),this.spawnMedKit(s,i)}}createChest(e,t,s){this.spawnChest(e,s)}spawnChest(e,t){const s=new O;({x:e,z:t}=this.getClampedCoord(e,t));let i=.5;this.world&&typeof this.world.getHeightAt=="function"&&(i=this.world.getHeightAt(e,t)+.5),s.position.set(e,i,t);const o=new k(1,.8,.6),n=new E({color:15844367,roughness:.3,metalness:.5}),a=new v(o,n);s.add(a);const l=new k(1,.2,.6),r=new v(l,n);r.position.y=.5,s.add(r);const h=new v(new k(.2,.3,.1),new E({color:9807270}));h.position.set(0,.3,.3),s.add(h),s.castShadow=!0,s.receiveShadow=!0;const c=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],u=c[Math.floor(Math.random()*c.length)];s.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:u};const f=this.createGlowEffect();return f.position.y=1,s.add(f),s.userData.glow=f,this.scene.add(s),this.items.push(s),s}spawnChestWithLoot(e,t,s){const i=new O;({x:e,z:t}=this.getClampedCoord(e,t));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(e,t)+.5),i.position.set(e,o,t);const n=new k(1,.8,.6),a=new E({color:15844367,roughness:.3,metalness:.5}),l=new v(n,a);i.add(l);const r=new k(1,.2,.6),h=new v(r,a);h.position.y=.5,i.add(h);const c=new v(new k(.2,.3,.1),new E({color:9807270}));c.position.set(0,.3,.3),i.add(c),i.castShadow=!0,i.receiveShadow=!0,i.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:s};const u=this.createGlowEffect();return u.position.y=1,i.add(u),i.userData.glow=u,this.scene.add(i),this.items.push(i),i}spawnJuiceBottle(e,t){const s=new O;({x:e,z:t}=this.getClampedCoord(e,t));let i=.5;this.world&&typeof this.world.getHeightAt=="function"&&(i=this.world.getHeightAt(e,t)+.5),s.position.set(e,i,t);const o=new v(new ie(.2,.2,.6,8),new E({color:2600544}));o.position.y=.5,s.add(o);const n=new v(new ie(.12,.12,.15,8),new E({color:12597547}));n.position.y=.9,s.add(n),s.castShadow=!0,s.receiveShadow=!0,s.userData={type:"stamina",gameId:this.generateID(),gameName:"JuiceBottle",amount:50};const a=this.createGlowEffect();return a.position.y=.9,s.add(a),s.userData.glow=a,this.scene.add(s),this.items.push(s),s}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}spawnLootInHouse(e,t,s){this.spawnChest(e,s)}spawnBackpack(e,t,s){const i=new O;({x:e,z:t}=this.getClampedCoord(e,t));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(e,t)+.5),i.position.set(e,o,t);const n=new v(new k(.7,.9,.35),new E({color:s,metalness:.15,roughness:.8}));i.add(n);const a=new v(new k(.6,.25,.16),new E({color:3426654,metalness:.1,roughness:.8}));a.position.set(0,-.55,.18),i.add(a),i.castShadow=!0,i.receiveShadow=!0;const l=this.createGlowEffect();return l.position.y=1,i.add(l),i.userData={type:"backpack",color:s,gameId:this.generateID(),gameName:"Backpack",isOpened:!1,glow:l},this.scene.add(i),this.items.push(i),i}spawnMedKit(e,t){const s=new O;({x:e,z:t}=this.getClampedCoord(e,t));let i=.5;this.world&&typeof this.world.getHeightAt=="function"&&(i=this.world.getHeightAt(e,t)+.3),s.position.set(e,i,t);const o=new v(new k(.8,.5,.6),new E({color:15790320,metalness:.2,roughness:.6}));s.add(o);const n=new v(new k(.5,.05,.15),new E({color:15158332,metalness:.1,roughness:.4}));n.position.y=.28,s.add(n);const a=new v(new k(.15,.05,.5),new E({color:15158332,metalness:.1,roughness:.4}));a.position.y=.28,s.add(a);const l=new v(new k(.6,.1,.08),new E({color:9807270,metalness:.4,roughness:.5}));l.position.y=.35,s.add(l);const r=new v(new k(.15,.08,.08),new E({color:8359053,metalness:.5,roughness:.4}));r.position.set(0,0,.32),s.add(r),s.castShadow=!0,s.receiveShadow=!0;const h=this.createGlowEffect();return h.position.y=.6,s.add(h),s.userData={type:"medkit",gameId:this.generateID(),gameName:"MedKit",healAmount:25,isOpened:!1,glow:h},this.scene.add(s),this.items.push(s),s}spawnMatrixLoadout(e=0,t=0){[{dx:2,dz:0,loot:"Pistol"},{dx:-2,dz:0,loot:"Rifle"},{dx:0,dz:2,loot:"Sniper"},{dx:0,dz:-2,loot:"ShieldPotion"},{dx:2,dz:2,loot:"SMG"},{dx:-2,dz:-2,loot:"Shotgun"},{dx:-2,dz:2,loot:"DMR"}].forEach(o=>{this.spawnChestWithLoot(e+o.dx,t+o.dz,o.loot)}),this.spawnJuiceBottle(e+3,t+3),this.spawnJuiceBottle(e-3,t-3),[2899536,15105570,1752220].forEach((o,n)=>{this.spawnBackpack(e+(n-1)*2,t+4,o)})}countNearbyChests(e=10){if(!this.player)return 0;const t=this.player.position;let s=0;return this.items.forEach(i=>{const o=i.userData||{};if(o.type!=="chest"||o.isOpened)return;const n=i.position.x-t.x,a=i.position.z-t.z;Math.sqrt(n*n+a*a)<=e&&s++}),s}createUmbrella(){const e=new O,t=new v(new ie(.08,.08,1.6,6),new E({color:4863016,roughness:.8}));t.position.y=-.2,e.add(t),[16726832,15844367,3447003].forEach((o,n)=>{const a=new v(new k(1.8-n*.3,.15,1.8-n*.3),new E({color:o,roughness:.4,metalness:.2}));a.position.y=.7+n*.12,e.add(a)});const i=new v(new Ke(.2,.25,6),new E({color:2899536}));return i.position.y=1.1,e.add(i),e.castShadow=!0,e.receiveShadow=!0,e}spawnMatrixDropNearPlayer(){if(!this.player)return;const e=Math.random()*Math.PI*2,t=4+Math.random()*8;let s=this.player.position.x+Math.cos(e)*t,i=this.player.position.z+Math.sin(e)*t;({x:s,z:i}=this.getClampedCoord(s,i));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(s,i)+.5);const n=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],a=n[Math.floor(Math.random()*n.length)],l=this.spawnChestWithLoot(s,i,a);if(l){l.position.y=o+18,l.userData.isDropping=!0,l.userData.dropTargetY=o,l.userData.dropVelocity=0;const r=this.createUmbrella();r.position.y=1.2,l.add(r),l.userData.umbrella=r}}spawnMatrixDropsBatch(){if(this.countNearbyChests(this.matrixDropRadiusLimit)>=this.matrixDropBatchSize)return;const e=this.matrixDropBatchSize-this.countNearbyChests(this.matrixDropRadiusLimit),t=Math.max(0,Math.min(this.matrixDropBatchSize,e));for(let s=0;s<t;s++)this.spawnMatrixDropNearPlayer()}update(e=.016){const t=Math.max(0,e||0);this.settings.gameMode==="matrix"&&this.player&&(this._matrixDropTimer+=t,this._matrixDropTimer>=this.matrixDropInterval&&(this._matrixDropTimer=0,this.spawnMatrixDropsBatch())),this.items.forEach(o=>{const n=o.userData||{};if(n.isDropping&&(n.dropVelocity=(n.dropVelocity||0)+5*t,o.position.y-=n.dropVelocity*t,o.position.y<=n.dropTargetY&&(o.position.y=n.dropTargetY,n.isDropping=!1,n.dropVelocity=0,n.umbrella))){try{o.remove(n.umbrella)}catch{}n.umbrella=null}});let s=null;const i=this.player.position;for(const o of this.items){if(o.userData&&o.userData.isOpened)continue;const n=i.distanceTo(o.position);if(this.updateGlow(o,n),n<3){s=o;break}}if(!(this.interactionPrompt&&this.interactionPrompt.dataset.vehiclePrompt==="1"))if(s){this.interactionPrompt.classList.remove("hidden");const o=s.userData||{};if(o.type==="chest")this.interactionPrompt.innerText=`Press E to open (Contains: ${o.loot})`;else if(o.type==="stamina")this.interactionPrompt.innerText=`Press E to collect ${o.gameName} (+${o.amount} Stamina)`;else if(o.type==="medkit")this.interactionPrompt.innerText=`Press E to use ${o.gameName} (+${o.healAmount}% Health)`;else if(o.type==="backpack"){const n=o.color?"#"+o.color.toString(16).padStart(6,"0"):"";this.interactionPrompt.innerText=`Press E to equip Backpack ${n}`}else this.interactionPrompt.innerText="Press E to interact";this.currentItem=s}else this.interactionPrompt.classList.add("hidden"),this.currentItem=null}tryInteract(){if(this.currentItem){const e=this.currentItem.userData;if(!e)return;if(e.type==="chest"&&!e.isOpened)e.isOpened=!0,this.scene.remove(this.currentItem),this.player.collectItem(e.loot),console.log(`Looted ${e.loot}!`);else if(e.type==="stamina"){const t=e.amount||50;this.player&&(this.player.stamina=Math.min(100,this.player.stamina+t)),this.scene.remove(this.currentItem),e.isOpened=!0,console.log(`Picked up stamina item: +${t}`)}else if(e.type==="medkit"){const t=e.healAmount||25;if(this.player){const i=100*t/100;this.player.health=Math.min(100,this.player.health+i),console.log(`Used MedKit: +${i} HP (${t}%)`)}this.scene.remove(this.currentItem),e.isOpened=!0}else if(e.type==="backpack"){const t=e.color||2899536;if(this.player&&typeof this.player.collectItem=="function"){const s=this.player.collectItem(`Backpack:${t.toString(16)}`);if(s!=null){const i=this.player.position.clone();this.spawnBackpack(i.x+.5,i.z+.5,s)}}this.scene.remove(this.currentItem),e.isOpened=!0,console.log(`Equipped backpack ${t.toString(16)}`)}}}realignItemsToGround(){!this.world||typeof this.world.getHeightAt!="function"||this.items.forEach(e=>{const t=e.position,s=this.world.getHeightAt(t.x,t.z),i=(e.userData&&e.userData.type==="chest",.5);e.position.y=s+i})}updateGlow(e,t){if(!e||!e.userData||!e.userData.glow)return;const s=e.userData.glow,i=!e.userData.isOpened&&t<this.glowRadius;s.visible=i,i&&(s.rotation.y+=.02,s.position.y=(e.userData.type==="chest"?1:.9)+Math.sin(performance.now()/500)*.1)}createGlowEffect(){const t=new Float32Array(120),s=.6;for(let a=0;a<40;a++){const l=s*Math.random(),r=Math.random()*Math.PI*2,h=Math.random()*s*.6;t[a*3]=Math.cos(r)*l,t[a*3+1]=h,t[a*3+2]=Math.sin(r)*l}const i=new Ze;i.setAttribute("position",new Be(t,3));const o=new St({color:16765286,size:.15,transparent:!0,opacity:.9,depthWrite:!1,blending:kt,sizeAttenuation:!0}),n=new Et(i,o);return n.visible=!1,n}}class ui{constructor(e,t={}){this.player=e,this.container=document.getElementById("touch-controls"),this.enabled=!0,this.layout=t&&t.layout?t.layout:{},this._cleanupExistingControls(),this.isEditing=!1,this.buttonHelpers=new Map,this._suppressDragUntil=0,this.joystick=document.createElement("div"),this.joystick.className="tc-joystick",this.joystick.style.zIndex="210",this.stick=document.createElement("div"),this.stick.className="tc-stick",this.joystick.appendChild(this.stick),this.buttons=document.createElement("div"),this.buttons.className="tc-buttons",this.buttons.style.zIndex="210",this.fireBtn=document.createElement("button"),this.fireBtn.className="tc-btn tc-btn-fire",this.fireBtn.innerText="FIRE",this.jumpBtn=document.createElement("button"),this.jumpBtn.className="tc-btn",this.jumpBtn.innerText="JUMP",this.sprintBtn=document.createElement("button"),this.sprintBtn.className="tc-btn",this.sprintBtn.innerText="SPRINT",this.interactBtn=document.createElement("button"),this.interactBtn.className="tc-btn tc-interact-btn",this.interactBtn.innerText="E",this.interactBtn.style.display="none",this.crouchBtn=document.createElement("button"),this.crouchBtn.className="tc-btn",this.crouchBtn.innerText="CROUCH",this.crouchBtn.style.fontSize="16px",this.buttons.appendChild(this.fireBtn),this.buttons.appendChild(this.jumpBtn),this.buttons.appendChild(this.sprintBtn),this.buttons.appendChild(this.crouchBtn),this.buttons.appendChild(this.interactBtn),this.container.appendChild(this.joystick),this.container.appendChild(this.buttons),this.container.classList.remove("hidden"),this.applyLayout(),this._initDragHandles(),this.active=!1,this.startPos=null,this.currentPos={x:0,y:0},this.lookActive=!1,this.lookStartPos=null,this._bindJoystick(),this._bindButtons(),this._bindLookArea(),this._setupEditToggleGesture(),this.deadZone=10,this.maxRadius=50,document.body.style.touchAction="none";try{this.player&&(this.player.allowTouchMovement=!0)}catch{}}_dispatchTouchLook(e,t){try{window.dispatchEvent(new CustomEvent("game-touch-look",{detail:{dx:e,dy:t}}))}catch{}}destroy(){try{this.container.classList.add("hidden"),this.destroyLookArea(),this.container.removeChild(this.joystick),this.container.removeChild(this.buttons),document.body.style.touchAction="",this.player&&(this.player.allowTouchMovement=!1)}catch{}}applyLayout(){const e=this.layout.joystickLeft!==void 0?this.layout.joystickLeft:10,t=this.layout.joystickBottom!==void 0?this.layout.joystickBottom:12,s=this.layout.buttonsRight!==void 0?this.layout.buttonsRight:8,i=this.layout.buttonsBottom!==void 0?this.layout.buttonsBottom:12,o=this.layout.buttonGapVh!==void 0?this.layout.buttonGapVh:14/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={});const n=(l,r)=>{this.layout.buttonPositions[l]||(this.layout.buttonPositions[l]={right:s,bottom:i+o*r})};n("fire",0),n("jump",1),n("sprint",2),n("crouch",3),n("interact",4),this.joystick.style.left=`${e}vw`,this.joystick.style.bottom=`${t}vh`,this.buttons.style.position="absolute",this.buttons.style.top="0",this.buttons.style.left="0",this.buttons.style.right="0",this.buttons.style.bottom="0",this.buttons.style.display="block",this.buttons.style.pointerEvents="none";const a=(l,r)=>{const h=this.layout.buttonPositions[r];h&&(l.style.position="absolute",l.style.right=`${h.right}vw`,l.style.bottom=`${h.bottom}vh`,l.style.pointerEvents="auto")};a(this.fireBtn,"fire"),a(this.jumpBtn,"jump"),a(this.sprintBtn,"sprint"),a(this.crouchBtn,"crouch"),a(this.interactBtn,"interact")}_cleanupExistingControls(){if(!this.container)return;this.container.querySelectorAll(".tc-joystick, .tc-buttons, .tc-look-area").forEach(t=>{try{t.parentNode.removeChild(t)}catch{}})}_initDragHandles(){const e=()=>{try{const o=localStorage.getItem("touch-layout");if(o){const n=JSON.parse(o);this.layout={...this.layout,...n}}}catch{}},t=()=>{try{localStorage.setItem("touch-layout",JSON.stringify(this.layout))}catch{}};e(),this.applyLayout(),((o,n)=>{let a=!1,l=0,r=0;const h=10,c=m=>{const d=m.touches?m.touches[0]:m;if(!a){const p=d.clientX-l,g=d.clientY-r;if(Math.sqrt(p*p+g*g)<h)return;a=!0}{const p=d.clientX/window.innerWidth*100;this.layout.joystickLeft=Math.max(0,Math.min(80,p));const g=(window.innerHeight-d.clientY)/window.innerHeight*100;this.layout.joystickBottom=Math.max(0,Math.min(80,g))}this.applyLayout(),m.preventDefault&&m.preventDefault()},u=()=>{a&&(a=!1,t()),document.removeEventListener("touchmove",c,{passive:!1}),document.removeEventListener("touchend",u),document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",u)},f=m=>{if(!this.isEditing||this._shouldSuppressDrag()||m.touches&&m.touches.length>1)return;const d=m.touches?m.touches[0]:m;l=d.clientX,r=d.clientY,a=!1,document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",u),document.addEventListener("pointermove",c),document.addEventListener("pointerup",u)};o.addEventListener("touchstart",f,{passive:!0}),o.addEventListener("pointerdown",f)})(this.joystick);const i=(o,n)=>{let a=!1,l=0,r=0;const h=10,c=m=>{if(!a)return;const d=m.touches?m.touches[0]:m,p=(window.innerWidth-d.clientX)/window.innerWidth*100,g=(window.innerHeight-d.clientY)/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={}),this.layout.buttonPositions[n]={right:Math.max(0,Math.min(90,p)),bottom:Math.max(0,Math.min(90,g))},this.applyLayout(),m.preventDefault&&m.preventDefault()},u=()=>{a&&(a=!1,t()),document.removeEventListener("touchmove",c,{passive:!1}),document.removeEventListener("touchend",u),document.removeEventListener("pointermove",c),document.removeEventListener("pointerup",u)},f=m=>{if(!this.isEditing||this._shouldSuppressDrag()||m.touches&&m.touches.length>1)return;const d=m.touches?m.touches[0]:m;l=d.clientX,r=d.clientY,a=!1,document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",u),document.addEventListener("pointermove",c),document.addEventListener("pointerup",u)};o.addEventListener("touchstart",f,{passive:!0}),o.addEventListener("pointerdown",f),o.addEventListener("touchmove",m=>{if(!this.isEditing||this._shouldSuppressDrag()||a)return;const d=m.touches?m.touches[0]:m,p=d.clientX-l,g=d.clientY-r;Math.sqrt(p*p+g*g)>h&&(a=!0)},{passive:!0}),o.addEventListener("pointermove",m=>{if(m.pointerType!=="touch"||!this.isEditing||this._shouldSuppressDrag()||a)return;const d=m.clientX-l,p=m.clientY-r;Math.sqrt(d*d+p*p)>h&&(a=!0)})};i(this.fireBtn,"fire"),i(this.jumpBtn,"jump"),i(this.sprintBtn,"sprint"),i(this.crouchBtn,"crouch"),i(this.interactBtn,"interact")}_bindJoystick(){this.joystick.addEventListener("touchstart",t=>{t.preventDefault();const s=t.changedTouches[0];this.joystick.getBoundingClientRect(),this.startPos={x:s.clientX,y:s.clientY},this.active=!0}),this.joystick.addEventListener("touchmove",t=>{if(!this.active)return;t.preventDefault();const s=t.changedTouches[0],i=s.clientX-this.startPos.x,o=s.clientY-this.startPos.y,n=Math.sqrt(i*i+o*o),a=Math.atan2(o,i),l=Math.min(this.maxRadius,n),r=Math.cos(a)*l,h=Math.sin(a)*l;this.stick.style.transform=`translate(${r}px, ${h}px)`;const c=i/this.maxRadius,u=o/this.maxRadius;this.player.moveForward=u<-.3,this.player.moveBackward=u>.3,this.player.moveLeft=c<-.3,this.player.moveRight=c>.3});const e=t=>{this.active&&(t.preventDefault(),this.active=!1,this.startPos=null,this.stick.style.transform="translate(0,0)",this.player.moveForward=!1,this.player.moveBackward=!1,this.player.moveLeft=!1,this.player.moveRight=!1)};this.joystick.addEventListener("touchend",e),this.joystick.addEventListener("touchcancel",e)}_bindButtons(){let e=null,t=null;const s=()=>{e&&(clearInterval(e),e=null)};this._stopFireInterval=s,this.fireBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&(s(),t&&(clearTimeout(t),t=null),this.player&&typeof this.player.shoot=="function"&&(this.player.shoot(),t=setTimeout(()=>{e=setInterval(()=>{this.player&&typeof this.player.shoot=="function"&&this.player.shoot()},150)},220)))});const i=o=>{o&&o.preventDefault&&o.preventDefault(),!this.isEditing&&(t&&(clearTimeout(t),t=null),s())};this.fireBtn.addEventListener("touchend",i),this.fireBtn.addEventListener("touchcancel",i),this.fireBtn.addEventListener("pointerup",o=>{o.pointerType==="touch"&&i(o)}),this.fireBtn.addEventListener("pointercancel",o=>{o.pointerType==="touch"&&i(o)}),this.fireBtn.addEventListener("mouseup",i),this.fireBtn.addEventListener("mouseleave",i),this.jumpBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&this.player.canJump===!0&&(this.player.velocity.y+=this.player.jumpHeight,this.player.canJump=!1)}),this.sprintBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.stamina<=0?this.player.isSprinting=!1:this.player.isSprinting=!this.player.isSprinting,this._updateSprintButton())}),this.interactBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&window.game&&window.game.itemManager&&window.game.itemManager.tryInteract()}),this.crouchBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.isCrouching=!this.player.isCrouching,this.crouchBtn.style.background=this.player.isCrouching?"rgba(52, 152, 219, 0.9)":"rgba(241, 196, 15, 0.9)")})}update(){window.game&&window.game.itemManager&&window.game.itemManager.currentItem?this.interactBtn.style.display="block":this.interactBtn.style.display="none";try{this.player&&this.player.stamina!==void 0&&(this.player.isSprinting&&this.player.stamina<=0&&(this.player.isSprinting=!1),this._updateSprintButton())}catch{}}destroyLookArea(){try{this.lookArea&&this.container&&this.lookArea.parentElement===this.container&&this.container.removeChild(this.lookArea)}catch{}this.lookArea=null}rebuildLookArea(){this.destroyLookArea(),this._bindLookArea()}_bindLookArea(){try{if(this.lookArea)try{this.container.removeChild(this.lookArea)}catch{}this.lookArea=document.createElement("div"),this.lookArea.className="tc-look-area",this.lookArea.style.position="absolute",this.lookArea.style.top="0",this.lookArea.style.bottom="0",this.lookArea.style.right="0",this.lookArea.style.left="0",this.lookArea.style.width="100%",this.lookArea.style.zIndex="190",this.lookArea.style.background="transparent",this.lookArea.style.touchAction="none",this.lookArea.style.pointerEvents="auto",this.container.appendChild(this.lookArea);let e=null,t=0,s=0;this.lookArea.addEventListener("touchstart",o=>{if(e!==null)return;const n=o.changedTouches[0];e=n.identifier,t=n.clientX,s=n.clientY,o.cancelable&&o.preventDefault()},{passive:!1}),this.lookArea.addEventListener("touchmove",o=>{if(e!==null){o.cancelable&&o.preventDefault();for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===e){const a=o.changedTouches[n],l=a.clientX-t,r=a.clientY-s;t=a.clientX,s=a.clientY,this._dispatchTouchLook(l,r);break}}},{passive:!1});const i=o=>{if(e!==null){for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===e){e=null;break}}};this.lookArea.addEventListener("touchend",i),this.lookArea.addEventListener("touchcancel",i)}catch{}}_getButtons(){return[this.fireBtn,this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_getEditToggleTargets(){return[this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_setupEditToggleGesture(){let e=0,t=0;const s=700,i=n=>{n.touches&&n.touches.length>=2&&(n.preventDefault(),n.stopPropagation(),e=0,this._suppressDrag(),this._toggleEditMode())},o=n=>{const a=performance.now();a-t<s?e+=1:e=1,t=a,e>=3&&(n.preventDefault(),n.stopPropagation(),e=0,this._suppressDrag(),this._toggleEditMode())};this._getEditToggleTargets().forEach(n=>{n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("touchend",o,{passive:!1}),n.addEventListener("touchcancel",()=>{e=0},{passive:!0}),n.addEventListener("pointerdown",a=>{a.pointerType})})}_updateSprintButton(){if(!this.player)return;const e=!!this.player.isSprinting;this.sprintBtn.style.background=e?"rgba(46, 204, 113, 0.9)":"rgba(241, 196, 15, 0.9)"}_toggleEditMode(){this.isEditing?this._exitEditMode():this._enterEditMode()}_enterEditMode(){this.isEditing=!0,typeof this._stopFireInterval=="function"&&this._stopFireInterval(),this._showButtonHelpers(),this._suppressDrag()}_exitEditMode(){this.isEditing=!1,this._hideButtonHelpers()}_showButtonHelpers(){this._getButtons().forEach(e=>{e.classList.add("tc-btn-editing");let t=this.buttonHelpers.get(e);t||(t=document.createElement("div"),t.className="tc-btn-helper",t.style.position="absolute",t.style.inset="-8px",t.style.border="2px dashed rgba(255, 255, 255, 0.75)",t.style.borderRadius="22px",t.style.pointerEvents="none",t.style.boxShadow="0 0 12px rgba(255, 255, 255, 0.5)",t.style.animation="tc-btn-helper-pulse 1.6s ease-in-out infinite",t.style.opacity="0.9",this.buttonHelpers.set(e,t)),e.contains(t)||(t.setAttribute("aria-hidden","true"),e.appendChild(t))})}_hideButtonHelpers(){this._getButtons().forEach(e=>{e.classList.remove("tc-btn-editing");const t=this.buttonHelpers.get(e);t&&t.parentNode===e&&e.removeChild(t)})}_suppressDrag(e=450){this._suppressDragUntil=performance.now()+e}_shouldSuppressDrag(){return performance.now()<this._suppressDragUntil}}class mi{constructor(e){const{player:t,scene:s,url:i,nick:o="Player",color:n="#29b6f6",roomCode:a="PUBLIC",settings:l=null,customSpawn:r=null}=e;this.player=t,this.scene=s,this.url=i,this.nick=o,this.color=n,this.roomCode=a||"PUBLIC",this.customSpawnStr=r||null,this.socket=null,this.id=null,this.others=new Map,this.lastSend=0,this.sendInterval=.05,this.lastSentPos=null,this.lastSentRot=null,this.lastAnimSig=null,this.heartbeatTimer=0,this.isHost=!1,this.roomSettings=l,this._manualClose=!1,this.deadPeers=new Set,this.matchLive=!1,this.remoteStates=new Map,this.remoteLastYaw=new Map,this.interpDelayMs=100,this.maxBufferMs=1e3,this.maxExtrapMs=80,this.remoteFaceOffset=0,this._now=typeof performance<"u"&&performance.now.bind(performance)||Date.now,this._tmpVec=new z,this.enemyManager=null,this.netStats={txBytes:0,rxBytes:0,txPerSec:0,rxPerSec:0,lastSample:this._now(),history:[]},this.lastPingSent=0,this.pingInterval=5,this.showHitboxes=!1,this.connect()}applyColorToTorso(e,t){if(!e||!t)return;let s=!1;const i=new ne(t);return e.traverse(o=>{if(!o.isMesh||!o.material||Array.isArray(o.material))return;const n=o.userData&&o.userData.gameName?o.userData.gameName.toLowerCase():"";(n.includes("body")||n.includes("torso")||n.includes("shirt")||n.includes("clothes")||o.geometry&&o.geometry.parameters&&Math.abs(o.geometry.parameters.width-.6)<.05)&&(o.material=o.material.clone(),o.material.color=i,s=!0)}),e.userData&&(e.userData.color=t),s}connect(){if(!this.url){console.warn("Multiplayer URL not configured.");const e=document.getElementById("ai-log");if(e){const t=document.createElement("div");t.textContent="Multiplayer URL not set in settings.",t.style.color="#ff9b9b",e.appendChild(t)}return}try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.sendJoin()},this.socket.onmessage=e=>this.handleMessage(e),this.socket.onclose=()=>{this.others.forEach(e=>{try{this.scene.remove(e)}catch{}}),this.others.clear(),this.deadPeers.clear(),this.matchLive=!1,this._manualClose||setTimeout(()=>this.connect(),1500)},this.socket.onerror=()=>{}}catch(e){console.warn("Multiplayer connect failed:",e)}}handleMessage(e){var t;try{const s=typeof e.data=="string"?e.data.length:0,i=JSON.parse(e.data);if(s>0&&this.trackRx(s),i.type!=="hello"){if(i.type==="welcome")this.id=i.id,this.isHost=!!i.isHost,i.settings&&(this.roomSettings=i.settings),i.custom&&(this.localCustom=i.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount()),this.onHostChanged&&this.onHostChanged(this.isHost),i.settings&&this.onSettings&&this.onSettings(i.settings);else if(i.type==="player-join")i.id&&i.id!==this.id&&this.ensureRemote(i.id,null,i.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(i.type==="player-leave")this.removeRemote(i.id),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(i.type==="state"&&i.id!==this.id){if(this.deadPeers.has(i.id))return;const o=this.ensureRemote(i.id,i.color,i.custom),n=typeof i.ts=="number"?i.ts:this._now();this.bufferRemoteState(i.id,{t:n,pos:i.pos,rot:i.rot,fwd:i.fwd,anim:i.anim,nick:i.nick,color:i.color,custom:i.custom?{...i.custom}:null}),o&&i.color&&((t=o.userData)==null?void 0:t.color)!==i.color&&this.applyColorToTorso(o,i.color),this.applyRemoteCustomization(o,i.custom),o&&o.userData&&(o.userData.custom=i.custom?{...i.custom}:null)}else if(i.type==="hit")console.warn("[DEPRECATED] Received old hit message, use hit-confirm"),this.onHit&&this.onHit(i);else if(i.type==="hit-confirm"){if(i.position&&this.scene&&this.createHitMarker(i.position),i.hitPoint&&i.region){console.log(`%c[HIT CONFIRM] Region: ${i.region} | Damage: ${i.damage}`,"color: #00ff00; font-weight: bold; font-size: 14px;"),console.log(`Exact Hit: (${i.hitPoint.x.toFixed(2)}, ${i.hitPoint.y.toFixed(2)}, ${i.hitPoint.z.toFixed(2)})`);const o=document.getElementById("debug-info");o&&(o.style.display="block",document.getElementById("debug-target-name").innerText=`HIT: ${i.region}`,document.getElementById("debug-target-id").innerText=`DMG: ${i.damage}`)}this.onHitConfirm&&this.onHitConfirm(i),i.targetId===this.id&&this.player&&typeof this.player.takeDamage=="function"&&this.player.takeDamage(i.damage),i.position&&this.scene&&this.createHitMarker(i.position)}else if(i.type==="host-changed")this.isHost=i.hostId===this.id,this.onHostChanged&&this.onHostChanged(this.isHost);else if(i.type==="start-countdown")this.onCountdown&&this.onCountdown(i.duration||10);else if(i.type==="match-start")this.onMatchStart&&this.onMatchStart(),this.matchLive=!0;else if(i.type==="settings")this.roomSettings=i.settings,this.onSettings&&this.onSettings(i.settings);else if(i.type==="zombie-hit"){if(this.isHost&&this.enemyManager&&i.id&&typeof i.amount=="number"){const o=this.enemyManager.applyRemoteZombieHit(i.id,i.amount);typeof o=="number"&&this.sendZombieState(i.id,o)}}else if(i.type==="zombie-state")this.enemyManager&&i.id&&typeof i.health=="number"&&this.enemyManager.syncZombieState(i.id,i.health);else if(i.type==="player-dead")i.id&&(i.id===this.id?this.player&&typeof this.player.die=="function"&&!this.player.isDead&&(console.log("[MP] Received own death confirmation from server"),this.player.die()):(this.deadPeers.add(i.id),this.killRemote(i.id),this.onPeerDeath&&this.onPeerDeath(i.id)));else if(i.type==="pong"&&typeof i.ts=="number"){const o=this._now()-i.ts;this.netStats.lastPing=o}}}catch(s){console.warn("Multiplayer parse error:",s)}}ensureRemote(e,t=null,s=null){if(!e||e===this.id||this.deadPeers&&this.deadPeers.has(e))return null;if(this.others.has(e))return this.others.get(e);const i=this.clonePlayerAvatar(t);if(i)return i.userData={...i.userData||{},gameId:e,gameName:"Player",color:t||this.color},this.applyColorToTorso(i,t||this.color),i.traverse(l=>{l.isMesh&&(l.castShadow=!1,l.receiveShadow=!0)}),this.scene.add(i),this.others.set(e,i),i.userData&&(i.userData.custom=s?{...s}:null),this.applyRemoteCustomization(i,s),i;const o=new k(.8,1.8,.8),n=new E({color:t||this.color,emissive:0,roughness:.7}),a=new v(o,n);return a.position.y=1,a.userData={gameId:e,gameName:"Player"},this.scene.add(a),this.others.set(e,a),a.userData&&(a.userData.custom=s?{...s}:null),this.applyRemoteCustomization(a,s),a}removeRemote(e){const t=this.others.get(e);if(t){if(t.userData&&t.userData.label&&t.userData.label.parentNode)try{t.userData.label.parentNode.removeChild(t.userData.label)}catch{}try{this.scene.remove(t)}catch{}this.others.delete(e)}this.remoteStates.delete(e)}killRemote(e){const t=this.others.get(e);if(t){try{t.rotation.x=-Math.PI/2,t.userData.dead=!0}catch{}setTimeout(()=>{this.removeRemote(e)},3500)}}clonePlayerAvatar(e=null){if(!this.player||!this.player.mesh)return null;try{const t=this.player.mesh.clone(!0),s={leftArm:null,rightArm:null,leftLeg:null,rightLeg:null};return t.traverse(i=>{if(i.isMesh&&(i.castShadow=!0,i.receiveShadow=!0,i.material&&i.material.clone&&(i.material=i.material.clone()),i.geometry&&i.geometry.clone&&(i.geometry=i.geometry.clone()),e&&i.material&&!Array.isArray(i.material))){const o=i.userData&&i.userData.gameName?i.userData.gameName.toLowerCase():"";(o.includes("body")||o.includes("torso")||o.includes("shirt")||o.includes("clothes")||i.geometry&&i.geometry.parameters&&Math.abs(i.geometry.parameters.width-.6)<.05)&&(i.material=i.material.clone(),i.material.color=new ne(e))}i.userData&&(i.userData={...i.userData}),i.name==="leftArmPivot"?s.leftArm=i:i.name==="rightArmPivot"?s.rightArm=i:i.name==="leftLegPivot"?s.leftLeg=i:i.name==="rightLegPivot"&&(s.rightLeg=i)}),t.userData={...t.userData||{},pivots:s},this.addDebugHitbox(t),t}catch(t){return console.warn("Failed to clone player avatar:",t),null}}applyRemoteAnimation(e,t){var i,o,n,a;if(!t||!e||!e.userData)return;const s=e.userData.pivots||{};try{s.leftArm&&typeof((i=t==null?void 0:t.arms)==null?void 0:i.leftX)=="number"&&(s.leftArm.rotation.x=t.arms.leftX),s.rightArm&&typeof((o=t==null?void 0:t.arms)==null?void 0:o.rightX)=="number"&&(s.rightArm.rotation.x=t.arms.rightX),s.leftLeg&&typeof((n=t==null?void 0:t.legs)==null?void 0:n.leftX)=="number"&&(s.leftLeg.rotation.x=t.legs.leftX),s.rightLeg&&typeof((a=t==null?void 0:t.legs)==null?void 0:a.rightX)=="number"&&(s.rightLeg.rotation.x=t.legs.rightX)}catch{}}update(e){var f,m,d;if(this.updateRemoteInterpolation(),this.sampleNetRates(),!this.socket||this.socket.readyState!==WebSocket.OPEN||(this.lastSend+=e,this.heartbeatTimer+=e,this.player&&!this.player.isDead&&(this.lastPingSent+=e,this.lastPingSent>=this.pingInterval&&(this.sendPing(),this.lastPingSent=0)),this.lastSend<this.sendInterval)||(this.lastSend=0,!this.player||!this.player.mesh)||this.player.isDead)return;const t=this.player.mesh.position,s={arms:{leftX:this.player.leftArmPivot?this.player.leftArmPivot.rotation.x:0,rightX:this.player.rightArmPivot?this.player.rightArmPivot.rotation.x:0},legs:{leftX:this.player.leftLegPivot?this.player.leftLegPivot.rotation.x:0,rightX:this.player.rightLegPivot?this.player.rightLegPivot.rotation.x:0}};let i=0,o={x:0,z:1};this.player&&this.player.mesh&&this.player.mesh.rotation&&(i=this.player.mesh.rotation.y,o={x:Math.sin(i),z:Math.cos(i)});let n=null;if(this.customSpawnStr&&typeof this.customSpawnStr=="string"){const p=this.customSpawnStr.split(",").map(g=>parseFloat(g.trim()));p.length===3&&p.every(g=>!isNaN(g))&&(n={x:p[0],y:p[1],z:p[2]})}const a={type:"state",pos:{x:t.x,y:t.y,z:t.z},rot:i,fwd:o,nick:this.nick,color:this.color,anim:s,ts:this._now(),custom:{...this.getCustomization()},customSpawn:n};let l=!1;this.lastSentPos?t.distanceTo?l=t.distanceTo(new z(this.lastSentPos.x,this.lastSentPos.y,this.lastSentPos.z))>.015:l=Math.abs(t.x-(((f=this.lastSentPos)==null?void 0:f.x)||0))>.015||Math.abs(t.y-(((m=this.lastSentPos)==null?void 0:m.y)||0))>.015||Math.abs(t.z-(((d=this.lastSentPos)==null?void 0:d.z)||0))>.015:l=!0;const r=`${s.arms.leftX.toFixed(3)},${s.arms.rightX.toFixed(3)},${s.legs.leftX.toFixed(3)},${s.legs.rightX.toFixed(3)}`,h=this.lastAnimSig!==r,c=Math.abs(this._angleDiff(this.lastSentRot??i,i))>.02,u=this.heartbeatTimer>=5;if(l||h||c||u){const p=JSON.stringify(a);try{this.socket.send(p)}catch{}this.trackTx(p.length),this.lastSentPos={x:t.x,y:t.y,z:t.z},this.lastAnimSig=r,this.lastSentRot=i,u&&(this.heartbeatTimer=0)}}dispose(){if(this._manualClose=!0,this.socket)try{this.socket.close()}catch{}this.others.forEach(e=>{try{this.scene.remove(e)}catch{}}),this.others.clear()}updateLabel(e,t){if(e.userData&&e.userData.label)try{e.userData.label.style.display="none"}catch{}e.userData&&(e.userData.nick=t||"Player")}sendHit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const i=JSON.stringify({type:"hit",targetId:e,amount:t});try{this.socket.send(i)}catch{}this.trackTx(i.length)}sendShoot(e,t,s=null){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return;const i={type:"shoot",direction:{x:e.x,y:e.y,z:e.z},weapon:t||"Pistol",ts:this._now()};s&&(i.origin={x:s.x,y:s.y,z:s.z}),this.socket.send(JSON.stringify(i))}getPeerCount(){return 1+this.others.size}sendJoin(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify({type:"join",room:this.roomCode,nick:this.nick,color:this.color,custom:this.getCustomization()});this.socket.send(e),this.trackTx(e.length)}catch{}}sendStart(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify({type:"start"});this.socket.send(e),this.trackTx(e.length)}catch{}}sendSettings(e){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&!(!this.isHost||!e))try{const t=JSON.stringify({type:"settings",settings:e});this.socket.send(t),this.trackTx(t.length)}catch{}}sendDeath(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&this.id)try{const e=JSON.stringify({type:"player-dead",id:this.id});this.socket.send(e),this.trackTx(e.length)}catch{}}isMatchLive(){return this.matchLive===!0}resetMatchState(){this.deadPeers.clear(),this.matchLive=!1}bufferRemoteState(e,t){if(!e||!t)return;const s=this.remoteStates.get(e)||[];if(typeof t.rot=="number"){const i=this.remoteLastYaw.get(e),o=this._unwrapAngle(t.rot,i);t.rot=o,this.remoteLastYaw.set(e,o)}for(s.push(t);s.length>24;)s.shift();this.remoteStates.set(e,s)}applyRemoteCustomization(e,t){if(!e||!t)return;const s=e.getObjectByName("playerHead");if(!s)return;this.removeNodesByRole(s,"playerMouth");const i=this._buildMouthMesh(t.mouthStyle||"serious");i&&s.add(i),this.setHatVisibility(s,t.showHat!==!1)}removeNodesByRole(e,t){if(!e)return;const s=[];e.traverse(i=>{i.userData&&i.userData.role===t&&s.push(i)}),s.forEach(i=>{i.parent&&i.parent.remove(i)})}setHatVisibility(e,t){e&&e.traverse(s=>{s.userData&&s.userData.role==="playerHat"&&(s.visible=t)})}_buildMouthMesh(e){const t=(e||"serious").toLowerCase(),s=new E({color:2824976,roughness:.6,metalness:0});let i=null;if(t==="smile"){const o=new O;o.userData={role:"playerMouth"},o.name="playerMouth";const n=s.clone(),a=new v(new k(.08,.04,.02),n),l=a.clone(),r=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,l.position.set(0,-.16,.26),r.position.set(.1,-.15,.26),r.rotation.z=.2,[a,l,r].forEach(h=>{h.userData={role:"playerMouth"},h.name="playerMouthSeg"}),o.add(a,l,r),i=o}else if(t==="angry"){const o=new E({color:5901324,roughness:.4});i=new v(new k(.26,.05,.02),o),i.position.set(0,-.16,.26),i.rotation.z=-.18}else if(t==="surprised")i=new v(new ie(.06,.06,.02,20),s),i.position.set(0,-.14,.26),i.rotation.x=Math.PI/2;else{if(t==="none")return null;i=new v(new k(.22,.06,.02),s),i.position.set(0,-.16,.26)}return i.castShadow=!1,i.receiveShadow=!1,i.userData||(i.userData={}),i.userData.role="playerMouth",i.name=i.name||"playerMouth",i}updateRemoteInterpolation(){if(!this.remoteStates||this.remoteStates.size===0)return;const t=this._now()-this.interpDelayMs;this.remoteStates.forEach((s,i)=>{var T,_,j,W,N,$,q,K,se,oe,J,ae,re,Z,he,le,V,Me;if(!s||s.length===0)return;const o=this.others.get(i);if(!o)return;for(;s.length>2&&t-s[0].t>this.maxBufferMs;)s.shift();const n=s[s.length-1];let a=s[0],l=n;for(let F=1;F<s.length;F++)if(s[F].t>=t){a=s[F-1]||s[F],l=s[F];break}const r=l.t-a.t;let h=r>0?(t-a.t)/r:1;if(t>n.t&&t-n.t<=this.maxExtrapMs&&s.length>=2){const F=s[s.length-2],Q=Math.max(1,n.t-F.t),pe=(n.pos.x-F.pos.x)/Q,fe=(n.pos.y-F.pos.y)/Q,ge=(n.pos.z-F.pos.z)/Q,ce=t-n.t;this._tmpVec.set(n.pos.x+pe*ce,n.pos.y+fe*ce,n.pos.z+ge*ce),o.position.copy(this._tmpVec),o.rotation&&(typeof n.rot=="number"?o.rotation.y=this._wrapAngle(n.rot):n.fwd&&typeof n.fwd.x=="number"&&typeof n.fwd.z=="number"&&(o.rotation.y=this._wrapAngle(Math.atan2(n.fwd.x,n.fwd.z)))),this.applyRemoteAnimation(o,n.anim),this.updateLabel(o,n.nick);return}h=Math.min(1,Math.max(0,h));const c=((T=a.pos)==null?void 0:T.x)??0,u=((_=a.pos)==null?void 0:_.y)??0,f=((j=a.pos)==null?void 0:j.z)??0,m=((W=l.pos)==null?void 0:W.x)??c,d=((N=l.pos)==null?void 0:N.y)??u,p=(($=l.pos)==null?void 0:$.z)??f;this._tmpVec.set(c+(m-c)*h,u+(d-u)*h,f+(p-f)*h),o.position.copy(this._tmpVec);const g=typeof a.rot=="number"?a.rot:typeof((q=a.fwd)==null?void 0:q.x)=="number"&&typeof((K=a.fwd)==null?void 0:K.z)=="number"?Math.atan2(a.fwd.x,a.fwd.z):o.rotation.y||0,M=typeof l.rot=="number"?l.rot:typeof((se=l.fwd)==null?void 0:se.x)=="number"&&typeof((oe=l.fwd)==null?void 0:oe.z)=="number"?Math.atan2(l.fwd.x,l.fwd.z):g,b=g,S=M,C=F=>{for(;F>Math.PI;)F-=Math.PI*2;for(;F<-Math.PI;)F+=Math.PI*2;return F},D=S-b,B=b+D*h;o.rotation&&(o.rotation.y=C(B));const A=(F,Q)=>(typeof F!="number"&&(F=0),typeof Q!="number"&&(Q=F),F+(Q-F)*h),w=a.anim||{},x=l.anim||{},I={arms:{leftX:A((J=w==null?void 0:w.arms)==null?void 0:J.leftX,(ae=x==null?void 0:x.arms)==null?void 0:ae.leftX),rightX:A((re=w==null?void 0:w.arms)==null?void 0:re.rightX,(Z=x==null?void 0:x.arms)==null?void 0:Z.rightX)},legs:{leftX:A((he=w==null?void 0:w.legs)==null?void 0:he.leftX,(le=x==null?void 0:x.legs)==null?void 0:le.leftX),rightX:A((V=w==null?void 0:w.legs)==null?void 0:V.rightX,(Me=x==null?void 0:x.legs)==null?void 0:Me.rightX)}};this.applyRemoteAnimation(o,I);const L=l.custom||a.custom||(o.userData?o.userData.custom:null);this.applyRemoteCustomization(o,L),o.userData&&(o.userData.custom=L?{...L}:null),this.updateLabel(o,l.nick||a.nick)})}sendPing(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return;const e={type:"ping",ts:this._now()},t=JSON.stringify(e);try{this.socket.send(t)}catch{}this.trackTx(t.length)}trackTx(e){!e||e<=0||(this.netStats.txBytes+=e)}sendZombieHit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const s=JSON.stringify({type:"zombie-hit",id:e,amount:t});try{this.socket.send(s)}catch{}this.trackTx(s.length)}sendZombieState(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const s=JSON.stringify({type:"zombie-state",id:e,health:t});try{this.socket.send(s)}catch{}this.trackTx(s.length)}trackRx(e){!e||e<=0||(this.netStats.rxBytes+=e)}sampleNetRates(){const e=this._now(),t=e-this.netStats.lastSample;if(t<1e3)return;const s=t/1e3,i=this.netStats.txBytes/s,o=this.netStats.rxBytes/s;for(this.netStats.txPerSec=i,this.netStats.rxPerSec=o,this.netStats.history.push({t:e,tx:i,rx:o,ping:this.netStats.lastPing||null});this.netStats.history.length>60;)this.netStats.history.shift();this.netStats.txBytes=0,this.netStats.rxBytes=0,this.netStats.lastSample=e}getNetStats(){return this.netStats}getCustomization(){return this.player?{mouthStyle:this.player.mouthStyle||"serious",showHat:this.player.showHat!==!1}:{mouthStyle:"serious",showHat:!0}}setEnemyManager(e){this.enemyManager=e}_wrapAngle(e){let t=e;for(;t>Math.PI;)t-=Math.PI*2;for(;t<-Math.PI;)t+=Math.PI*2;return t}_angleDiff(e,t){return this._wrapAngle(e-t)}_unwrapAngle(e,t){if(typeof t!="number")return e;let s=e,i=s-t;for(;i>Math.PI;)s-=Math.PI*2,i=s-t;for(;i<-Math.PI;)s+=Math.PI*2,i=s-t;return s}createHitMarker(e){try{const t=new ke(.1,8,8),s=new ue({color:16711680,transparent:!0,opacity:.8}),i=new v(t,s);i.position.set(e.x,e.y,e.z),this.scene.add(i),setTimeout(()=>{this.scene.remove(i),t.dispose(),s.dispose()},200)}catch{}}addDebugHitbox(e){const t=new ke(.8,16,12),s=new ue({color:16711680,wireframe:!0,transparent:!0,opacity:.5}),i=new v(t,s);i.position.y=.9,i.name="debugHitbox",i.visible=!1,e.add(i)}toggleHitboxes(){this.showHitboxes=!this.showHitboxes,console.log(`[DEBUG] Hitboxes ${this.showHitboxes?"ON":"OFF"}`),this.others.forEach(e=>{const t=e.getObjectByName("debugHitbox");t&&(t.visible=this.showHitboxes)})}}function qe({maxLines:H=400,autoShow:e=!1}={}){const t=[],s={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)},i=document.createElement("div");i.id="debug-overlay",i.className="debug-overlay hidden";const o=document.createElement("div");o.className="debug-overlay-header",o.innerHTML="<strong>DEBUG</strong>";const n=document.createElement("div");n.className="debug-overlay-actions";const a=document.createElement("button");a.textContent="Copy";const l=document.createElement("button");l.textContent="Clear";const r=document.createElement("button");r.textContent="Close",n.appendChild(a),n.appendChild(l),n.appendChild(r),o.appendChild(n);const h=document.createElement("div");h.className="debug-overlay-list",i.appendChild(o),i.appendChild(h),document.body.appendChild(i),o.style.cursor="move";let c=!1,u=0,f=0;function m(D){if(!c)return;const B=Math.max(0,Math.min(window.innerWidth-i.offsetWidth,D.clientX-u)),A=Math.max(0,Math.min(window.innerHeight-i.offsetHeight,D.clientY-f));i.style.left=B+"px",i.style.top=A+"px",i.style.right="auto"}function d(D){c=!1,window.removeEventListener("pointermove",m),window.removeEventListener("pointerup",d);try{D&&D.pointerId&&i.releasePointerCapture&&i.releasePointerCapture(D.pointerId)}catch{}}o.addEventListener("pointerdown",D=>{try{const B=i.getBoundingClientRect();i.style.left=B.left+"px",i.style.top=B.top+"px",i.style.position="fixed",i.style.transform="none",i.style.right="auto",u=D.clientX-B.left,f=D.clientY-B.top,c=!0,window.addEventListener("pointermove",m),window.addEventListener("pointerup",d);try{i.setPointerCapture&&i.setPointerCapture(D.pointerId)}catch{}}catch{}},{passive:!1});function p(){h.innerHTML="";const D=Math.max(0,t.length-H);for(let B=D;B<t.length;B++){const A=document.createElement("div");A.className="debug-line debug-"+t[B].level;const w=new Date(t[B].ts).toLocaleTimeString();A.textContent=`[${w}] ${t[B].level.toUpperCase()}: ${t[B].msg}`,h.appendChild(A)}h.scrollTop=h.scrollHeight}function g(D,B){try{const A=B.map(w=>{try{return typeof w=="string"?w:JSON.stringify(w)}catch{return String(w)}}).join(" ");t.push({level:D,msg:A,ts:Date.now()}),t.length>H*2&&t.splice(0,t.length-H*2),p()}catch{}}console.log=function(...D){s.log(...D),g("log",D)},console.info=function(...D){s.info(...D),g("info",D)},console.warn=function(...D){s.warn(...D),g("warn",D)},console.error=function(...D){s.error(...D),g("error",D)};function M(D,B,A,w,x){typeof D=="string"?g("error",[D+" "+(B||"")+":"+(A||"?")]):D&&D.message&&g("error",[D.message,D.error||x])}function b(D){try{g("error",["UnhandledRejection",D&&D.reason?D.reason:D])}catch{}}window.addEventListener("error",M),window.addEventListener("unhandledrejection",b),a.addEventListener("click",()=>{try{const D=t.map(A=>`[${new Date(A.ts).toLocaleTimeString()}] ${A.level.toUpperCase()}: ${A.msg}`).join(`
`),B=document.createElement("textarea");B.value=D,B.style.position="fixed",B.style.left="-9999px",B.style.top="0",document.body.appendChild(B),B.focus(),B.select();try{document.execCommand("copy")?(a.textContent="Copied!",setTimeout(()=>{a.textContent="Copy"},1e3)):(a.textContent="Failed",setTimeout(()=>{a.textContent="Copy"},1e3))}catch(A){console.error("execCommand failed:",A),a.textContent="Error",setTimeout(()=>{a.textContent="Copy"},1e3)}finally{document.body.removeChild(B)}}catch(D){console.error("Copy failed:",D)}}),l.addEventListener("click",()=>{t.length=0,p()}),r.addEventListener("click",()=>C());function S(){i.classList.remove("hidden")}function C(){i.classList.add("hidden")}return e&&S(),{show:S,hide:C,destroy(){console.log=s.log,console.info=s.info,console.warn=s.warn,console.error=s.error,window.removeEventListener("error",M),window.removeEventListener("unhandledrejection",b);try{i.remove()}catch{}},logs:t}}var Se=function(){var H=0,e=document.createElement("div");e.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",e.addEventListener("click",function(h){h.preventDefault(),s(++H%e.children.length)},!1);function t(h){return e.appendChild(h.dom),h}function s(h){for(var c=0;c<e.children.length;c++)e.children[c].style.display=c===h?"block":"none";H=h}var i=(performance||Date).now(),o=i,n=0,a=t(new Se.Panel("FPS","#0ff","#002")),l=t(new Se.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var r=t(new Se.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:e,addPanel:t,showPanel:s,begin:function(){i=(performance||Date).now()},end:function(){n++;var h=(performance||Date).now();if(l.update(h-i,200),h>=o+1e3&&(a.update(n*1e3/(h-o),100),o=h,n=0,r)){var c=performance.memory;r.update(c.usedJSHeapSize/1048576,c.jsHeapSizeLimit/1048576)}return h},update:function(){i=this.end()},domElement:e,setMode:s}};Se.Panel=function(H,e,t){var s=1/0,i=0,o=Math.round,n=o(window.devicePixelRatio||1),a=80*n,l=48*n,r=3*n,h=2*n,c=3*n,u=15*n,f=74*n,m=30*n,d=document.createElement("canvas");d.width=a,d.height=l,d.style.cssText="width:80px;height:48px";var p=d.getContext("2d");return p.font="bold "+9*n+"px Helvetica,Arial,sans-serif",p.textBaseline="top",p.fillStyle=t,p.fillRect(0,0,a,l),p.fillStyle=e,p.fillText(H,r,h),p.fillRect(c,u,f,m),p.fillStyle=t,p.globalAlpha=.9,p.fillRect(c,u,f,m),{dom:d,update:function(g,M){s=Math.min(s,g),i=Math.max(i,g),p.fillStyle=t,p.globalAlpha=1,p.fillRect(0,0,a,u),p.fillStyle=e,p.fillText(o(g)+" "+H+" ("+o(s)+"-"+o(i)+")",r,h),p.drawImage(d,c+n,u,f-n,m,c,u,f-n,m),p.fillRect(c+f-n,u,n,m),p.fillStyle=t,p.globalAlpha=.9,p.fillRect(c+f-n,u,n,o((1-g/M)*m))}}};window.DEBUG_STATIC_TEST=!0;const me=(()=>{try{return typeof navigator>"u"?!1:/Mobi|Android|iPhone|iPad|Tablet|Mobile/i.test(navigator.userAgent)||window.matchMedia&&window.matchMedia("(pointer: coarse)").matches}catch{return!1}})();window.addEventListener("unhandledrejection",H=>{try{const e=H.reason,t=e&&e.message?e.message:String(e);if(t&&t.includes("If you see this error we have a bug")){console.warn("Suppressed Chromium UnknownError:",t),H.preventDefault&&H.preventDefault();return}}catch{}});class _e{constructor(){this.scene=new Dt,this.scene.background=new ne(8900331),this.scene.fog=new Ct(8900331,20,100),this._animationStarted=!1,this._selectedMode="arcade",this._defaultRandom=Math.random,this._currentRandomSeed=null,this.matchSettings=null,this.lastPlaySettings=null,this.aiObjects=[],this.stats=new Se,this.stats.showPanel(0),this.stats.dom.style.position="absolute",this.stats.dom.style.left="5px",this.stats.dom.style.top="5px",this.stats.dom.style.zIndex="100",this.stats.dom.style.display="none",document.body.appendChild(this.stats.dom),this.aiMaxAiObjects=200,this.renderer=new Bt({antialias:!0});const e=me?1:1.5;this.renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,e)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=It,document.getElementById("game-container").appendChild(this.renderer.domElement),this._renderScaleApplied=this.renderer.getPixelRatio(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.forceFixedMultiplayerSpawn=!1;const t=new Ue(16777215,.6);this.scene.add(t);const s=new Le(16777215,.8);s.position.set(50,100,50),s.castShadow=!0,s.shadow.camera.left=-100,s.shadow.camera.right=100,s.shadow.camera.top=100,s.shadow.camera.bottom=-100,s.shadow.camera.near=.1,s.shadow.camera.far=160,s.shadow.mapSize.width=1024,s.shadow.mapSize.height=1024,this.scene.add(s),this.dirLight=s,this.camera=new Pt(75,window.innerWidth/window.innerHeight,.1,1e3),this.clock=new Tt,this._pickRaycaster=new Y,this._objectClickHandler=null,this._objectClickTarget=null,this._longPressTimer=null,this.hotkeyModalVisible=!1,this.isPaused=!1,this.pauseMenu=document.getElementById("pause-menu"),this.bgAudio=null,this.bgMusicVolume=.5,this._endSequenceAudio=null,this._prevBgVolume=null,this.autoPerfEnabled=!1,this._autoPerfTimer=0,this._renderScaleApplied=1,this.sfxVolume=.7,document.addEventListener("keydown",i=>{if(i.code==="Escape"&&this.togglePause(),this.player&&this.player.gameMode==="studio")if(i.code==="KeyL")try{this.spawnStudioDrops()}catch(o){console.warn("Studio drop failed:",o)}else i.code==="KeyH"&&this.toggleHotkeyModal(!this.hotkeyModalVisible)}),this.setupMenu(),this.setupLongPressMenu(),this.setMenuOpenState(!0),document.addEventListener("pointerlockerror",i=>{i.preventDefault&&i.preventDefault(),console.warn("Pointer lock request failed or was cancelled.")})}applyGraphicsSettings(e={}){if(!this.renderer)return;const t=!!e.performanceMode,s=Math.max(.5,Math.min(1,(e.renderScale||100)/100)),i=me?1:t?1.25:1.5,o=Math.min((window.devicePixelRatio||1)*s,i);this.renderer.setPixelRatio(o),this.renderer.setSize(window.innerWidth,window.innerHeight);const n=!t;if(this.renderer.shadowMap.enabled=n,this.dirLight&&this.dirLight.shadow){this.dirLight.castShadow=n;const a=t?512:1024;this.dirLight.shadow.mapSize.width=a,this.dirLight.shadow.mapSize.height=a}}applyDeterministicRandom(e){if(!e)return;this._currentRandomSeed=e;const t=String(e);let s=1779033703^t.length;for(let n=0;n<t.length;n++)s=Math.imul(s^t.charCodeAt(n),3432918353),s=s<<13|s>>>19;s=Math.imul(s^s>>>16,2246822507),s=(s^s>>>13)>>>0;let i=s;Math.random=()=>{i=i+1831565813|0;let n=Math.imul(i^i>>>15,1|i);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}spawnStudioDrops(){if(!(!this.itemManager||!this.player||this.player.gameMode!=="studio"))try{for(let e=0;e<3;e++)this.itemManager.spawnMatrixDropNearPlayer()}catch(e){console.warn("spawnStudioDrops error:",e)}}toggleHotkeyModal(e){const t=document.getElementById("hotkey-modal");t&&(t.classList.toggle("hidden",!e),t.setAttribute("aria-hidden",e?"false":"true"),this.hotkeyModalVisible=e)}toggleTouchLookArea(e){try{if(!this.touchControls)return;e?this.touchControls.lookArea?this.touchControls.lookArea.style.display="":this.touchControls.rebuildLookArea&&this.touchControls.rebuildLookArea():this.touchControls.destroyLookArea?this.touchControls.destroyLookArea():this.touchControls.lookArea&&(this.touchControls.lookArea.style.display="none")}catch{}}setHotbarVisible(e){const t=document.getElementById("hotbar");t&&(t.style.display=e?"flex":"none")}setMenuOpenState(e){document.body.classList.toggle("menu-open",!!e)}updateDebugToggleVisibility(e){const t=document.getElementById("debug-toggle-btn");if(t&&(t.classList.toggle("hidden",!e),!e&&window.debugOverlay&&typeof window.debugOverlay.hide=="function")){try{window.debugOverlay.hide()}catch{}try{localStorage.removeItem("showDebugOverlay")}catch{}}}makeDashboardDraggable(e){const t=document.getElementById(e);if(!t)return;let s=!1,i,o,n,a,l=0,r=0;t.style.cursor="move";const h=m=>{m.target!==t&&!m.target.classList.contains("dashboard-header")||(m.type==="touchstart"?(n=m.touches[0].clientX-l,a=m.touches[0].clientY-r):(n=m.clientX-l,a=m.clientY-r),s=!0)},c=m=>{n=i,a=o,s=!1},u=m=>{s&&(m.preventDefault(),m.type==="touchmove"?(i=m.touches[0].clientX-n,o=m.touches[0].clientY-a):(i=m.clientX-n,o=m.clientY-a),l=i,r=o,f(i,o,t))},f=(m,d,p)=>{p.style.transform=`translate(${m}px, ${d}px)`};t.addEventListener("mousedown",h),t.addEventListener("mouseup",c),t.addEventListener("mousemove",u),t.addEventListener("touchstart",h),t.addEventListener("touchend",c),t.addEventListener("touchmove",u)}assignMultiplayerSpawn(){if(!this.player||!this.world)return;const e=this.world&&typeof this.world.halfMapSize=="number"?this.world.halfMapSize-5:100;let t=null;const s=this._defaultRandom||Math.random;if(this.forceFixedMultiplayerSpawn)t={x:0,y:this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(0,0):0,z:0};else for(let i=0;i<12;i++){const o=(s()*2-1)*e,n=(s()*2-1)*e;let a=0;if(this.world&&typeof this.world.getHeightAt=="function"&&(window.DEBUG_STATIC_TEST||(a=this.world.getHeightAt(o,n))),!this.multiplayer||this.multiplayer.others.size===0||Array.from(this.multiplayer.others.values()).every(r=>{if(!r||!r.position)return!0;const h=r.position.x-o,c=r.position.z-n;return Math.sqrt(h*h+c*c)>15})){t={x:o,y:a,z:n};break}}t||(t={x:0,y:0,z:0}),this.player.mesh.position.set(t.x,t.y,t.z),this.player.controls&&this.player.controls.getObject&&this.player.controls.getObject().position.set(t.x,t.y+1.6,t.z),this.player.camera&&this.player.camera.position.set(t.x,t.y+1.6,t.z)}setupMultiplayerLobbyUI(){const e=document.getElementById("mp-lobby"),t=document.getElementById("mp-start-btn"),s=document.getElementById("mp-lobby-status");if(!e||!t||!s)return;e.classList.remove("hidden");const i=this.multiplayer&&this.multiplayer.roomCode?this.multiplayer.roomCode:"PUBLIC";s.innerText=`Waiting in lobby (Room: ${i})`,t.classList.toggle("hidden",!(this.multiplayer&&this.multiplayer.isHost)),t.onclick=()=>{if(!this.multiplayer||!this.multiplayer.isHost)return;const o=typeof this.multiplayer.getPeerCount=="function"?Math.max(0,this.multiplayer.getPeerCount()-1):0,n=this.enemyManager?typeof this.enemyManager.targetCount=="number"?this.enemyManager.targetCount:this.enemyManager.enemies?this.enemyManager.enemies.length:0:0;if(o<=0&&n<=0){alert("Need at least 1 remote player or 1 NPC zombie before starting the match.");return}this.beginLobbyCountdown(10),this.multiplayer.sendStart()},this.lobbyCountdown=0,this.updateLobbyUI(this.multiplayer?this.multiplayer.isHost:!1)}updateLobbyUI(e){const t=document.getElementById("mp-start-btn");t&&t.classList.toggle("hidden",!e)}beginLobbyCountdown(e=10){this.matchPhase="countdown",this.lobbyCountdown=e;const t=document.getElementById("mp-lobby"),s=document.getElementById("mp-lobby-countdown");t&&t.classList.remove("hidden"),s&&(s.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`)}startMultiplayerMatch(){this.matchPhase="live",this.multiplayer&&(this.multiplayer.matchLive=!0),this.refreshMultiplayerTargets();const e=document.getElementById("mp-lobby");e&&e.classList.add("hidden"),this.lobbyCountdown=0}checkMultiplayerVictory(){if(!this.multiplayer)return;const e=this.multiplayer.deadPeers||new Set;let t=0;this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach((o,n)=>{e.has(n)||o&&o.userData&&o.userData.dead||(t+=1)});const s=this.player&&!this.player.isDead;(s?1:0)+t===1&&s&&(this.hud&&typeof this.hud.showVictory=="function"&&this.hud.showVictory(),this.multiplayer&&(this.multiplayer.matchLive=!1))}setupMenu(){const e=document.getElementById("main-menu"),t=document.getElementById("play-btn"),s=document.getElementById("setting-difficulty"),i=document.getElementById("setting-enemies"),o=document.getElementById("setting-storm"),n=document.getElementById("setting-storm-enabled"),a=document.getElementById("setting-map-size"),l=document.getElementById("map-size-val"),r=document.getElementById("setting-debug"),h=document.getElementById("setting-minimap"),c=document.getElementById("setting-show-fps"),u=document.getElementById("setting-music-volume"),f=document.getElementById("setting-music-volume-val"),m=document.getElementById("setting-sfx-volume"),d=document.getElementById("setting-sfx-volume-val"),p=document.getElementById("setting-camera"),g=document.getElementById("setting-mouth-style"),M=document.getElementById("setting-show-hat"),b=document.getElementById("setting-performance-mode"),S=document.getElementById("setting-auto-performance"),C=document.getElementById("setting-render-scale"),D=document.getElementById("render-scale-val"),B=document.getElementById("setting-touch-controls"),A=document.getElementById("setting-fullscreen"),w=document.getElementById("setting-game-mode"),x=document.getElementById("quit-btn"),I=document.getElementById("active-mode-label"),L=document.getElementById("active-mode-chip"),T=document.getElementById("float-btn"),_=document.getElementById("setting-openai-key"),j=document.getElementById("setting-groq-key"),W=document.getElementById("setting-nvidia-key"),N=document.getElementById("setting-mp-server"),$=document.getElementById("setting-mp-server-select"),q=document.getElementById("setting-mp-seed"),K=document.getElementById("setting-mp-room"),se=document.getElementById("mp-room-generate"),oe=document.getElementById("setting-mp-spawn"),J=document.getElementById("setting-mp-nickname"),ae=document.getElementById("setting-mp-color"),re=document.getElementById("setting-mp-zombies"),Z=document.getElementById("setting-mp-fixed-spawn"),he=document.getElementById("setting-language"),le=document.getElementById("hotkey-hint"),V=document.getElementById("hotkey-modal"),Me=document.getElementById("hotkey-modal-close"),F=document.getElementById("setting-arena-time"),Q=document.getElementById("arena-time-val"),pe=document.getElementById("setting-arena-respawn"),fe=document.getElementById("setting-matrix-infinite-ammo"),ge=document.getElementById("setting-matrix-show-ui"),ce=document.getElementById("setting-matrix-ai-autospawn"),Ee=document.getElementById("setting-matrix-ai-hints"),De=document.getElementById("setting-studio-flight"),Ce=document.getElementById("setting-studio-show-grid"),Qe=document.getElementById("dash-toggle"),et=document.getElementById("perf-toggle"),Re=document.getElementById("enemy-count-val"),Fe=document.getElementById("storm-time-val"),ye=(y,P)=>{if(!y||!P)return;const R=()=>{P.innerText=y.value};y.addEventListener("input",R),y.addEventListener("change",R),R()},de=(y,P)=>{if(!(typeof window>"u"||!window.localStorage))try{const R=window.localStorage.getItem("voxel-firecraft-settings"),G=R?JSON.parse(R):{};G[y]=P,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(G))}catch{}},Oe=(y,P)=>{y&&(y.addEventListener("pointerdown",R=>{try{R.preventDefault(),R.stopPropagation()}catch{}}),y.addEventListener("click",R=>{try{R.preventDefault(),R.stopPropagation()}catch{}const G=document.getElementById(P);if(!G)return;const ee=G.classList.toggle("collapsed");Array.from(G.children).forEach(Ae=>{Ae!==y&&(Ae.style.display=ee?"none":"")}),y.innerText=ee?"+":"â€“",P==="dashboard"&&this.hud&&typeof this.hud.setDebugEnabled=="function"&&this.hud.setDebugEnabled(!ee)}))};Oe(Qe,"dashboard"),Oe(et,"perf-dashboard");const je=document.getElementById("debug-clear-btn");je&&je.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation();const P=document.getElementById("debug-info");if(P){P.style.display="none";const R=document.getElementById("debug-target-name"),G=document.getElementById("debug-target-id");R&&(R.innerText="None"),G&&(G.innerText="---")}});const Ne=localStorage.getItem("voxel-firecraft-settings");if(Ne){const y=JSON.parse(Ne);if(y.gameMode==="survival"&&(y.gameMode="arcade"),s.value=y.difficulty,i.value=y.enemyCount,o.value=y.stormTime,Re.innerText=y.enemyCount,Fe.innerText=y.stormTime,n&&(n.checked=y.stormEnabled!==!1),a&&l){const P=y.mapSize||Ie;a.value=P,l.innerText=P}if(y.debugMode&&(r.checked=!0),h&&(h.checked=y.showMinimap!==!1),A&&(A.checked=!!y.fullscreen),y.musicVolume!==void 0&&u&&f){const P=parseInt(y.musicVolume,10);u.value=P,f.innerText=P,this.bgMusicVolume=Math.pow(P/100,2)}if(m&&d&&y.sfxVolume!==void 0){const P=parseInt(y.sfxVolume,10);m.value=P,d.innerText=P,this.sfxVolume=P/100}if(y.cameraMode&&(p.value=y.cameraMode),g&&y.mouthStyle&&(g.value=y.mouthStyle),M&&(M.checked=y.showHat!==!1),b&&(b.checked=!!y.performanceMode),S&&(S.checked=!!y.autoPerformance),C&&D){const P=y.renderScale||100;C.value=P,D.innerText=P}if(y.useTouchControls!==void 0&&B&&(B.checked=!!y.useTouchControls),y.gameMode&&w&&(w.value=y.gameMode),y.gameMode&&(this._selectedMode=y.gameMode),he&&y.language&&(he.value=y.language),_&&(_.value=y.openaiKey||""),j&&(j.value=y.groqKey||""),W&&(W.value=y.nvidiaKey||""),N&&(N.value=y.mpServer||""),q&&(q.value=y.mpSeed||""),K&&(K.value=y.mpRoom||""),J&&(J.value=y.mpNick||""),ae&&(ae.value=y.mpColor||"#29b6f6"),re&&(re.checked=y.mpZombies!==!1),Z&&(Z.checked=!!y.mpFixedSpawn),F&&Q){const P=y.arenaTime||parseInt(F.value,10)||180;F.value=P,Q.innerText=P}pe&&(pe.checked=y.arenaRespawn!==!1),fe&&(fe.checked=y.matrixInfiniteAmmo!==!1),ge&&(ge.checked=y.matrixShowUI!==!1),ce&&(ce.checked=y.matrixAiAutospawn!==!1),Ee&&(Ee.checked=y.matrixAiHints!==!1),De&&(De.checked=y.studioFlight!==!1),Ce&&(Ce.checked=y.studioShowGrid!==!1),c&&(c.checked=y.showFps===!0,this.stats&&(this.stats.dom.style.display=c.checked?"block":"none"))}if(ye(i,Re),ye(o,Fe),ye(a,l),ye(F,Q),ye(C,D),ye(m,d),m&&m.addEventListener("change",()=>{const y=parseInt(m.value,10);de("sfxVolume",y);const P=y/100;this.player&&typeof this.player.setSFXVolume=="function"&&this.player.setSFXVolume(P),this.enemyManager&&typeof this.enemyManager.setSFXVolume=="function"&&this.enemyManager.setSFXVolume(P)}),S&&S.addEventListener("change",()=>{const y=this.lastPlaySettings||{};y.autoPerformance=S.checked,this.autoPerfEnabled=y.autoPerformance,de("autoPerformance",y.autoPerformance)}),b&&b.addEventListener("change",()=>{const y=this.lastPlaySettings||{};y.performanceMode=b.checked,this.applyGraphicsSettings(y),de("performanceMode",b.checked)}),r){r.addEventListener("change",()=>{const P=r.checked;de("debugMode",P),this.hud&&typeof this.hud.setDebugEnabled=="function"&&this.hud.setDebugEnabled(P)});const y=localStorage.getItem("voxel-firecraft-settings");if(y){const P=JSON.parse(y);this.hud&&typeof this.hud.setDebugEnabled=="function"&&this.hud.setDebugEnabled(P.debugMode===!0)}}if(C&&C.addEventListener("change",()=>{const y=this.lastPlaySettings||{};y.renderScale=parseInt(C.value,10),this.applyGraphicsSettings(y),de("renderScale",y.renderScale)}),M&&M.addEventListener("change",()=>{this.player&&typeof this.player.setHatVisible=="function"&&this.player.setHatVisible(M.checked),de("showHat",M.checked)}),c&&c.addEventListener("change",()=>{const y=c.checked;de("showFps",y),this.stats&&(this.stats.dom.style.display=y?"block":"none")}),$&&N){$.addEventListener("change",()=>{$.value==="custom"?(N.style.display="block",N.focus()):(N.style.display="none",N.value=$.value)});const y=localStorage.getItem("voxel-firecraft-settings");if(y){const R=JSON.parse(y).mpServer;R&&(Array.from($.options).some(ee=>ee.value===R)&&R!=="custom"?($.value=R,N.value=R,N.style.display="none"):($.value="custom",N.value=R,N.style.display="block"))}}this.makeDashboardDraggable("dashboard"),this.makeDashboardDraggable("perf-dashboard"),t.onclick=()=>{const y=this._selectedMode||"arcade";if(y==="multiplayer"&&this.multiplayer&&!this.multiplayer.isHost&&!this.multiplayer.roomSettings){alert("Waiting for host settings. Please try again in a moment.");return}const P={difficulty:y==="survival"?document.getElementById("setting-survival-difficulty")?document.getElementById("setting-survival-difficulty").value:"medium":s.value,enemyCount:parseInt(i.value),stormTime:parseInt(o.value),stormEnabled:n?n.checked:!0,mapSize:a?parseInt(a.value):Ie,debugMode:r.checked,showMinimap:h?h.checked:!0,musicVolume:u?parseInt(u.value):Math.round(this.bgMusicVolume*100),musicEnabled:document.getElementById("setting-music-enabled")?document.getElementById("setting-music-enabled").checked:!0,showFps:c?c.checked:!1,cameraMode:p.value,mouthStyle:g?g.value:"serious",showHat:M?M.checked:!0,performanceMode:b?b.checked:!1,autoPerformance:S?S.checked:!1,renderScale:C?parseInt(C.value,10):100,sfxVolume:m?parseInt(m.value,10):70,language:he?he.value:"en",useTouchControls:B?B.checked:!1,fullscreen:A?A.checked:!1,gameMode:y,openaiKey:_?_.value:"",groqKey:j?j.value:"",nvidiaKey:W?W.value:"",mpServer:N?$&&$.value!=="custom"?$.value:N.value:"",mpSeed:q?q.value.trim():"",mpRoom:K?K.value:"",mpSpawn:oe?oe.value:"",mpNick:J?J.value:"",mpColor:ae?ae.value:"#29b6f6",mpZombies:re?re.checked:!0,mpFixedSpawn:Z?Z.checked:!1,arenaTime:F?parseInt(F.value,10):180,arenaRespawn:pe?pe.checked:!0,matrixInfiniteAmmo:fe?fe.checked:!0,matrixShowUI:ge?ge.checked:!0,matrixAiAutospawn:ce?ce.checked:!0,matrixAiHints:Ee?Ee.checked:!0,studioFlight:De?De.checked:!0,studioShowGrid:Ce?Ce.checked:!0};this.lastPlaySettings=P,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(P)),this.updateDebugToggleVisibility(P.debugMode),this.applyGraphicsSettings(P),e.style.display="none",this.setMenuOpenState(!1),P.musicEnabled!==!1?this.playBackgroundMusic():this.stopBackgroundMusic(),this.requestFullscreenIfNeeded(P.fullscreen);const R=this.player&&this.world&&this.enemyManager,G=R&&this.player&&this.player.gameMode===y;if(R&&!G&&this.resetGameState(),this.player&&this.world&&this.enemyManager&&G){if(this.isPaused=!1,this.clock.getDelta(),t.innerText="PLAY GAME",this.player)try{this.player.lockControls()}catch{}if(this.hud&&(this.hud.settings=P),this.world){this.world.stormEnabled=P.stormEnabled!==!1;const ee=this.world.stormEnabled&&this.world.gameMode!=="matrix"&&this.world.gameMode!=="studio"&&this.world.gameMode!=="matrix-ai";this.world.stormMesh?this.world.stormMesh.visible=ee:ee&&typeof this.world.createStormVisuals=="function"&&this.world.createStormVisuals()}this.player&&(this.player.mouthStyle=P.mouthStyle||"serious",typeof this.player.createMouth=="function"&&this.player.createMouth(this.player.mouthStyle)),this.setHotbarVisible(!0)}else t.innerText="PLAY GAME",this.startGame(P);if(le){const ee=P&&P.gameMode==="studio";le.classList.toggle("hidden",!ee)}},x&&(x.onclick=()=>{this.multiplayer&&typeof this.multiplayer.dispose=="function"&&this.multiplayer.dispose(),location.reload()}),T&&T.classList.add("hidden"),se&&K&&(se.onclick=()=>{const y=Math.random().toString(36).substr(2,5).toUpperCase();K.value=y;try{const P=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");P.mpRoom=y,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(P))}catch{}}),le&&(le.onclick=()=>this.toggleHotkeyModal(!0)),Me&&(Me.onclick=()=>this.toggleHotkeyModal(!1)),V&&V.addEventListener("click",y=>{y.target===V&&this.toggleHotkeyModal(!1)}),u&&u.addEventListener("change",()=>{const y=parseInt(u.value,10);de("musicVolume",y),this.bgMusicVolume=Math.pow(y/100,2),this.bgMusic&&(this.bgMusic.volume=this.bgMusicVolume)});const Te=document.getElementById("setting-music-enabled");Te&&(Te.onchange=()=>{Te.checked?this.playBackgroundMusic():this.stopBackgroundMusic()}),B&&(B.onchange=()=>{try{const y=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");y.useTouchControls=B.checked,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(y))}catch{}}),this.setHotbarVisible(!1),this.setMenuOpenState(!0);const xe=Array.from(document.querySelectorAll(".tab-btn")),tt=document.querySelectorAll(".tab-panel"),Ve=y=>{if(!y)return;const P=y.getAttribute("data-tab");xe.forEach(G=>G.classList.toggle("active",G===y)),tt.forEach(G=>{G.id===P?G.classList.remove("hidden"):G.classList.add("hidden")});const R=y.getAttribute("data-mode");R&&w&&(w.value=R,I&&(I.innerText=y.innerText),L&&(L.innerText=y.innerText)),R&&(this._selectedMode=R)};xe.forEach(y=>y.addEventListener("click",()=>Ve(y)));const Ge=this._selectedMode||(w?w.value:null),it=(Ge?xe.find(y=>y.getAttribute("data-mode")===Ge):null)||xe.find(y=>y.classList.contains("active"))||xe[0];Ve(it)}resetGameState(){if(this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState(),this.multiplayer&&typeof this.multiplayer.dispose=="function")try{this.multiplayer.dispose()}catch(e){console.warn("Dispose multiplayer failed:",e)}this.multiplayer=null,this.multiplayerEnemyBaseCount=0,this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.isPaused=!1,this.forceFixedMultiplayerSpawn=!1,this.matchSettings=null;try{this.scene.clear()}catch(e){console.warn("Scene clear failed:",e)}try{const e=new Ue(16777215,.6);this.scene.add(e);const t=new Le(16777215,.8);t.position.set(50,100,50),t.castShadow=!0,t.shadow.camera.left=-100,t.shadow.camera.right=100,t.shadow.camera.top=100,t.shadow.camera.bottom=-100,t.shadow.camera.near=.1,t.shadow.camera.far=160,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,this.scene.add(t)}catch(e){console.warn("Rebuild lights failed:",e)}this.player=null,this.world=null,this.enemyManager=null,this.itemManager=null,this.hud=null,this.matchSettings=null,this.lastPlaySettings=null,Math.random=this._defaultRandom,this._currentRandomSeed=null,this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState()}startGame(e){this.clearAiObjects(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.victoryShown=!1;const t={...e};if(this.forceFixedMultiplayerSpawn=t.gameMode==="multiplayer"?!!e.mpFixedSpawn:!1,t.gameMode==="multiplayer"){const r=this.multiplayer&&!this.multiplayer.isHost&&this.multiplayer.roomSettings?this.multiplayer.roomSettings:null;if(!this.multiplayer||this.multiplayer.isHost||!r){const h=e.mpSeed||Math.random().toString(36).slice(2);this.matchSettings={mapSize:e.mapSize,enemyCount:e.enemyCount,stormEnabled:!1,seed:h,fixedSpawn:!!e.mpFixedSpawn}}else this.matchSettings=r;this.matchSettings&&(t.mapSize=this.matchSettings.mapSize,t.enemyCount=this.matchSettings.enemyCount,t.stormEnabled=this.matchSettings.stormEnabled,this.forceFixedMultiplayerSpawn=!!this.matchSettings.fixedSpawn,this.applyDeterministicRandom(this.matchSettings.seed||"mp-seed"))}if((t.gameMode==="matrix"||t.gameMode==="studio")&&(t.enemyCount=0,t.skipLoot=!0),t.gameMode==="multiplayer"&&(t.skipLoot=!0,t.stormEnabled=!1,e.mpZombies===!1&&(t.enemyCount=0)),t.gameMode==="survival"&&(t.stormEnabled=!1,t.mapSize=Math.max(100,t.mapSize)),this.survivalStartTime=performance.now(),this.survivalTime=0,this.lootDropEligible=!1,this.lootDropCooldown=0,this.multiplayerEnemyBaseCount=t.enemyCount||0,this.player=new He(this.camera,this.scene,null,t),typeof e.sfxVolume<"u"&&(this.player.sfxVolume=Math.max(0,Math.min(1,e.sfxVolume/100))),e&&e.mpColor){if(this.player.playerColor=e.mpColor,this.player.mesh)try{this.scene.remove(this.player.mesh)}catch{}this.player.createPlayerMesh()}this.player&&(this.player.setHatVisible(e.showHat!==!1),this.player.mouthStyle=e.mouthStyle||"serious",this.player.createMouth(this.player.mouthStyle)),t.gameMode==="multiplayer"?(this.matchPhase="lobby",this.multiplayer&&(this.multiplayer.matchLive=!1)):this.matchPhase="live",this.itemManager=new di(this.scene,this.player,t),this.world=new Ut(this.scene,this.itemManager,t),this.player.worldObjects=this.world.objects,this.player.world=this.world,this.itemManager&&typeof this.itemManager.setWorld=="function"&&this.itemManager.setWorld(this.world);const s=document.getElementById("mp-lobby"),i=document.getElementById("mp-start-btn");if(s&&s.classList.add("hidden"),i&&i.classList.add("hidden"),t.gameMode==="matrix"&&this.itemManager&&typeof this.itemManager.spawnMatrixLoadout=="function"&&this.itemManager.spawnMatrixLoadout(this.player.position.x,this.player.position.z),t.gameMode==="multiplayer")if(window.DEBUG_STATIC_TEST&&e.mpSpawn){const r=e.mpSpawn.split(",").map(h=>parseFloat(h.trim()));r.length===3&&r.every(h=>!isNaN(h))&&(console.log("[MAIN] Setting initial spawn to custom position:",r),this.player.mesh.position.set(r[0],r[1],r[2]),this.player.debugSpawnY=r[1])}else window.DEBUG_STATIC_TEST||this.assignMultiplayerSpawn();if(this.setupTopBar(t),t.gameMode==="multiplayer"?(this.multiplayer=new mi({player:this.player,scene:this.scene,url:e.mpServer,nick:e.mpNick||"Player",color:e.mpColor||"#29b6f6",roomCode:e.mpRoom||"PUBLIC",settings:this.matchSettings,customSpawn:e.mpSpawn||null}),e.mpServer||alert("Multiplayer server URL not set. Please configure it in the Multiplayer tab."),this.player&&typeof this.player.setMultiplayerClient=="function"&&this.player.setMultiplayerClient(this.multiplayer),this.multiplayer&&(this.multiplayer.onPeersChanged=()=>this.refreshMultiplayerTargets(),this.multiplayer.roomCode=e.mpRoom||"PUBLIC",this.multiplayer.onHostChanged=r=>{this.updateLobbyUI(r),r&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings)},this.multiplayer.onCountdown=r=>this.beginLobbyCountdown(r),this.multiplayer.onMatchStart=()=>this.startMultiplayerMatch(),this.multiplayer.onSettings=r=>{this.matchSettings=r;const h=this.multiplayer&&this.multiplayer.isHost,u=this.player&&this.player.gameMode==="multiplayer"&&r&&(this.world&&this.world.mapSize!==r.mapSize||this.multiplayerEnemyBaseCount!==r.enemyCount);if(!h&&r&&u&&this.lastPlaySettings){const f={...this.lastPlaySettings,mapSize:r.mapSize,enemyCount:r.enemyCount};this.resetGameState(),this.matchSettings=r,this.applyDeterministicRandom(r.seed||"mp-seed"),this.startGame(f)}},this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings),this.multiplayer.onPeerDeath=()=>{this.checkMultiplayerVictory()},this.updateLobbyUI(this.multiplayer.isHost),this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings))):this.multiplayer=null,t.gameMode==="matrix-ai"){t.enemyCount=0,t.skipLoot=!0;const r=document.getElementById("ai-panel");r&&r.classList.remove("hidden")}else{const r=document.getElementById("ai-panel");r&&r.classList.add("hidden")}if(this.hud=new ri(this.player,this.world,e),this.player&&(this.player.hud=this.hud),this.hud.setRenderer(this.renderer),this.multiplayer&&this.hud.setMultiplayer(this.multiplayer),this.hud&&typeof this.hud.setDebugEnabled=="function"){const r=e.debugMode===!0;this.hud.setDebugEnabled(r)}this.enemyManager=new ci(this.scene,this.player,this.world,t),this.multiplayer&&typeof this.multiplayer.setEnemyManager=="function"&&this.multiplayer.setEnemyManager(this.enemyManager),t.gameMode==="multiplayer"&&(this.multiplayerEnemyBaseCount=t.enemyCount||0,typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(this.multiplayerEnemyBaseCount),this.multiplayer&&(this.multiplayer.onHit=r=>{console.warn("[DEPRECATED] Direct hit message received, ignoring")},this.multiplayer.onHitConfirm=r=>{console.log(`[HIT CONFIRMED] ${r.shooterId} -> ${r.targetId} [${r.damage} dmg, ${r.weapon}]${r.isDead?" [KILL]":""}`)})),this.player.setEnemyManager(this.enemyManager),t.gameMode==="multiplayer"&&(this.refreshMultiplayerTargets(),this.setupMultiplayerLobbyUI()),this.setupObjectInspector(),this.updateDebugToggleVisibility(!!e.debugMode),this.setHotbarVisible(!0);const o=document.getElementById("float-btn");o&&(t.gameMode==="studio"?(o.classList.remove("hidden"),o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF",o.onclick=()=>{if(this.player.isFloating=!this.player.isFloating,!this.player.isFloating){const r=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=r,this.player.velocity.y=0}o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF"}):o.classList.add("hidden"));const n=document.getElementById("storm-timer");if(n){const r=t.stormEnabled===!1||t.gameMode==="studio"||t.gameMode==="matrix"||t.gameMode==="matrix-ai"||t.gameMode==="multiplayer"||t.gameMode==="survival";n.classList.toggle("hidden",r)}const a=document.getElementById("survival-timer");if(a){const r=t.gameMode==="arcade"||t.gameMode==="survival";a.classList.toggle("hidden",!r)}window.addEventListener("resize",()=>this.onWindowResize(),!1),this.renderer.domElement.addEventListener("pointerdown",()=>{if(!me){try{const r=document.getElementById("main-menu")&&document.getElementById("main-menu").style.display!=="none",h=this.player&&this.player.gameMode==="studio";if(this.isPaused||r||h)return;this.player&&!this.player.isDead&&this.player.lockControls()}catch(r){console.warn("Pointer lock request skipped or failed:",r)}this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic()}}),this.setupPauseMenu();try{const r=typeof navigator<"u"&&/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent),h=typeof window<"u"&&window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;(!!e.useTouchControls||r||h)&&(this.touchControls=new ui(this.player))}catch{}if(this.setupStudioPalette(t),this.refreshStudioPaletteVisibility(),this.setupAiPanel(),!me&&this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch(r){console.warn("Pointer lock on start skipped/failed:",r)}this._animationStarted||(this._animationStarted=!0,this.animate())}setupLongPressMenu(){if(!me)return;const e=document.getElementById("ui-layer")||document.body;if(!e)return;const t=i=>{try{if(i.touches&&i.touches.length>1)return;this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=setTimeout(()=>{this._longPressTimer=null,this.showPauseMenu()},800)}catch{}},s=()=>{this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null)};e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("touchend",s),e.addEventListener("touchcancel",s),e.addEventListener("touchmove",s)}setupAiPanel(){const e=document.getElementById("ai-panel"),t=document.getElementById("ai-send"),s=document.getElementById("ai-prompt"),i=document.getElementById("ai-log"),o=document.getElementById("ai-provider");if(!e||!t||!s||!i)return;const n=(r,h="")=>{const c=document.createElement("div");c.textContent=r,h&&(c.className=h),i.appendChild(c),i.scrollTop=i.scrollHeight};t.onclick=()=>{const r=s.value.trim();r&&(n(`You: ${r}`,"ai-user"),n("AI: (stub) Interpreter not wired. Imagine this runs your Three.js code.","ai-bot"),s.value="")};const a=`You are a level-building assistant for a Three.js sandbox. Respond ONLY with a JSON object:
{
  "actions": [
    {
      "action": "add",
      "type": "box" | "sphere" | "cylinder" | "plane",
      "pos": [x,y,z],
      "size": [sx,sy,sz],
      "color": "#rrggbb"
    }
  ]
}
Constraints: numbers are in meters, keep |x|,|z| <= 150, size in [0.2, 40]. No functions, no code, no prose, no markdown.`,l=async r=>{const h=document.getElementById("setting-openai-key"),c=h&&h.value?h.value.trim():"";if(!c)return n("Erro: configure a chave OpenAI em Settings.","ai-error"),"";const u={model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:r}],temperature:.2,max_tokens:2e3,response_format:{type:"json_object"}},f=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(u)});if(!f.ok){const p=await f.text();return n(`Erro OpenAI: ${f.status} ${p}`,"ai-error"),""}const m=await f.json(),d=m&&m.choices&&m.choices[0]&&m.choices[0].message?m.choices[0].message.content:"";return n(`AI: ${d||"(vazio)"}`,"ai-bot"),d||""};t.onclick=async()=>{const r=s.value.trim();if(!r)return;n(`You: ${r}`,"ai-user"),s.value="";const h=o?o.value:"openai";t.disabled=!0,t.innerText="Enviando...";try{if(h==="openai"){const c=await l(r);if(c){const u=this.parseAiActions(c,n);if(u&&u.length){const f=this.applyAiActions(u,n);n(`Aplicado: ${f} objeto(s)`,"ai-info")}}}else n(`Provider ${h} nÃ£o suportado.`,"ai-error")}catch(c){n(`Erro na requisiÃ§Ã£o: ${c.message||c}`,"ai-error")}finally{t.disabled=!1,t.innerText="Send to AI"}}}parseAiActions(e,t){const s=t||(()=>{});let i=null;try{i=JSON.parse(e)}catch{return s("Falha ao parsear JSON da AI.","ai-error"),[]}if(i&&i.actions&&Array.isArray(i.actions)&&(i=i.actions),!Array.isArray(i))return s("Resposta nÃ£o Ã© uma lista de aÃ§Ãµes.","ai-error"),[];const o=(h,c,u)=>Math.min(u,Math.max(c,h)),n=new Set(["box","sphere","cylinder","plane"]),a=/^#([0-9a-fA-F]{6})$/,l=this.aiMaxAiObjects||200,r=[];for(const h of i){if(!h||h.action!=="add"||!n.has(h.type))continue;const c=Array.isArray(h.pos)?h.pos.slice(0,3):[0,0,0],u=Array.isArray(h.size)?h.size.slice(0,3):[1,1,1],f=[o(Number(c[0]??0),-150,150),o(Number(c[1]??0),-10,200),o(Number(c[2]??0),-150,150)],m=[o(Math.abs(Number(u[0]??1)),.2,40),o(Math.abs(Number(u[1]??1)),.2,40),o(Math.abs(Number(u[2]??1)),.2,40)],d=typeof h.color=="string"&&a.test(h.color)?h.color:"#cccccc";if(r.push({type:h.type,pos:f,size:m,color:d}),r.length>=l)break}return r.length||s("Nenhuma aÃ§Ã£o vÃ¡lida na resposta.","ai-error"),r}clearAiObjects(){this.aiObjects||(this.aiObjects=[]),this.aiObjects.forEach(e=>{try{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose()}catch{}}),this.aiObjects=[]}applyAiActions(e,t){const s=t||(()=>{});if(!e||!e.length)return 0;if(!this.scene||!this.player||this.player.gameMode!=="matrix-ai")return s("AÃ§Ãµes ignoradas: nÃ£o estÃ¡ no modo Matrix AI Builder.","ai-error"),0;this.clearAiObjects();const i=this.aiMaxAiObjects||200,o=[],n=new Le(16777215,.2);return n.position.set(0,10,0),this.scene.add(n),o.push(n),e.slice(0,i).forEach(a=>{try{let l=null;const r=new E({color:new ne(a.color),metalness:.05,roughness:.85});if(a.type==="box")l=new k(a.size[0],a.size[1],a.size[2]);else if(a.type==="sphere"){const c=a.size[0]/2;l=new ke(c,20,16)}else if(a.type==="cylinder"){const c=a.size[0]/2;l=new ie(c,c,a.size[1],16)}else a.type==="plane"&&(l=new te(a.size[0],a.size[2]));if(!l)return;const h=new v(l,r);h.position.set(a.pos[0],a.pos[1],a.pos[2]),a.type==="plane"&&(h.rotation.x=-Math.PI/2),this.scene.add(h),o.push(h)}catch(l){s("Falha ao criar objeto: "+l.message,"ai-error")}}),this.aiObjects=o,o.length}refreshStudioPaletteVisibility(){const e=document.getElementById("studio-palette");if(!e)return;const t=this.player&&this.player.gameMode==="studio"&&!this.isPaused;e.classList.toggle("hidden",!t)}refreshMultiplayerTargets(){if(!this.player||this.player.gameMode!=="multiplayer"||!this.enemyManager)return;const e=typeof this.multiplayerEnemyBaseCount=="number"?this.multiplayerEnemyBaseCount:this.enemyManager.enemies.length;this.matchPhase==="live"&&typeof this.enemyManager.setTargetCount=="function"?this.enemyManager.setTargetCount(e):this.matchPhase!=="live"&&typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(0)}setupStudioPalette(e){const t=document.getElementById("studio-palette");if(!t)return;const s=e&&(e.gameMode==="studio"||e.gameMode==="matrix-ai");if(t.classList.toggle("hidden",!s),!s)return;this.initStudioPaletteDrag(t),t.querySelectorAll("button").forEach(n=>{if(n._boundStudio)return;n._boundStudio=!0;const a=r=>{if(r&&r.stopPropagation&&r.stopPropagation(),!this.player||!this.world)return;const h=n.getAttribute("data-action");if(h==="resume"){if(this.isPaused=!1,this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch{}const d=document.getElementById("main-menu");d&&(d.style.display="none"),this.setMenuOpenState(!1),this.setHotbarVisible(!0);try{t.classList.add("hidden")}catch{}if(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0),this.player&&this.player.studioSelectionHelper){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}this.refreshStudioPaletteVisibility(),this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic();return}else if(h==="float-toggle"){if(this.player&&this.player.gameMode==="studio"){this.player.isFloating=!this.player.isFloating;const d=this.player.isFloating?"FLOAT ON":"FLOAT OFF";if(n.innerText=d,!this.player.isFloating){const p=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=p,this.player.velocity.y=0}}return}else if(h==="spawn-npc"){const d=n.getAttribute("data-npc-type")||"normal";this.studioSelectedPrefab="npc",this.studioSelectedOptions={type:d},this.toggleTouchLookArea(!1);const p=document.getElementById("npc-menu");p&&p.classList.add("hidden");return}else if(h==="remove-npc"){if(this.studioRemoveNPCMode=!this.studioRemoveNPCMode,this.studioMoveMode=!1,n.style.background=this.studioRemoveNPCMode?"#e74c3c":"",n.textContent=this.studioRemoveNPCMode?"Remove NPC (Active)":"Remove NPC",this.studioRemoveNPCMode&&(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.player&&this.player.studioSelectionHelper)){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}return}else if(h==="move-tool"){this.studioMoveMode=!this.studioMoveMode,this.studioRemoveNPCMode=!1,n.style.background=this.studioMoveMode?"#3498db":"",n.textContent=this.studioMoveMode?"Move Tool (Active)":"Move Tool",this.studioMoveMode?(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!1)):(this.toggleTouchLookArea(!0),this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(null));return}else if(h!=="drops"){if(h==="drops"){this.spawnStudioDrops();return}else if(h==="menu"){this.showPauseMenu();return}else if(h==="quit"){try{localStorage.removeItem("voxel-firecraft-settings")}catch{}location.reload();return}}const c=n.getAttribute("data-prefab"),u=n.getAttribute("data-vehicle-type"),f=n.getAttribute("data-tree-type"),m=n.getAttribute("data-submenu");if(m){const d=document.getElementById(m);d&&d.classList.toggle("hidden");return}if(this.studioSelectedPrefab=c,this.studioSelectedOptions=u?{variant:u}:f?{variant:f}:{},this.toggleTouchLookArea(!1),m){const d=document.getElementById(m);d&&d.classList.add("hidden")}},l=r=>{r&&r.preventDefault&&r.preventDefault(),a(r)};n.addEventListener("pointerdown",l),n.addEventListener("click",r=>{r&&r.preventDefault&&r.preventDefault(),a(r)})});const o=document.getElementById("studio-minimize-btn");o&&o.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const a=document.querySelector("#studio-palette .palette-grid");a&&(a.classList.toggle("hidden"),o.textContent=a.classList.contains("hidden")?"+":"_")})}setupObjectInspector(){const e=this.renderer?this.renderer.domElement:null;if(!e)return;if(this._objectClickHandler&&this._objectClickTarget)try{this._objectClickTarget.removeEventListener("click",this._objectClickHandler),this._objectClickTarget.removeEventListener("pointerdown",this._objectClickHandler)}catch{}this._objectClickTarget=e;const t=o=>{if(this.player&&this.player.gameMode==="studio"){const c=e.getBoundingClientRect(),u=(o.clientX-c.left)/c.width*2-1,f=-((o.clientY-c.top)/c.height*2-1),m=new Y;m.setFromCamera(new U(u,f),this.camera);let d=null;const p=[];if(this.world&&this.world.objects&&p.push(...this.world.objects),this.enemyManager&&this.enemyManager.enemies){console.log("[DEBUG] Enemies in scene:",this.enemyManager.enemies.map(M=>{var b,S;return((S=(b=M.mesh)==null?void 0:b.userData)==null?void 0:S.gameName)||"Unknown"}));for(const M of this.enemyManager.enemies)M.mesh&&p.push(M.mesh)}const g=m.intersectObjects(p,!0);console.log("[DEBUG] Raycast hits:",g.length,"objects. Checking each hit...");for(const M of g){let b=M.object;for(console.log("[DEBUG] Hit object:",b.type,b.userData);b.parent&&b.parent.type!=="Scene";)b=b.parent;if(console.log("[DEBUG] Root object:",b.type,b.userData),b.userData&&b.userData.gameName==="Ground"){console.log("[DEBUG] Skipping ground");continue}if(b.userData&&(b.userData.isNPC||b.userData.gameName)){console.log("[DEBUG] FOUND VALID OBJECT!",b.userData.gameName,"isNPC:",b.userData.isNPC),d=b;break}else console.log("[DEBUG] Object has no valid userData, skipping")}d?(console.log("[DEBUG] Setting selection for:",d.userData.gameName),this.player&&typeof this.player.setStudioSelection=="function"&&(this.player.setStudioSelection(d),console.log("[DEBUG] setStudioSelection called successfully"))):this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(null)}if(!this.studioMoveMode||this.player.gameMode!=="studio")return;const n=e.getBoundingClientRect(),a=(o.clientX-n.left)/n.width*2-1,l=-((o.clientY-n.top)/n.height*2-1),r=new Y;r.setFromCamera(new U(a,l),this.camera);let h=null;if(this.enemyManager&&this.enemyManager.enemies){for(const c of this.enemyManager.enemies)if(c.mesh&&r.intersectObject(c.mesh,!0).length>0){for(h=c.mesh;h.parent&&h.parent.type!=="Scene";)h=h.parent;break}}if(!h){const c=r.intersectObjects(this.world.objects,!0);for(const u of c)if(u.object.userData&&u.object.userData.gameName!=="Ground"){for(h=u.object;h.parent&&h.parent.type!=="Scene";)h=h.parent;break}}h&&(this.studioDraggedObject=h,this.studioIsDragging=!0,this.player.controls&&(this.player.controls.enabled=!1),this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(h))},s=o=>{if(!this.studioIsDragging||!this.studioDraggedObject)return;const n=e.getBoundingClientRect(),a=(o.clientX-n.left)/n.width*2-1,l=-((o.clientY-n.top)/n.height*2-1),r=new Y;r.setFromCamera(new U(a,l),this.camera);const h=r.intersectObjects(this.world.objects,!0);for(const c of h)if(c.object.userData&&c.object.userData.gameName==="Ground"){if(this.studioDraggedObject.position.x=c.point.x,this.studioDraggedObject.position.z=c.point.z,this.world&&typeof this.world.getHeightAt=="function"&&(this.studioDraggedObject.position.y=this.world.getHeightAt(c.point.x,c.point.z)),this.enemyManager){const u=this.enemyManager.enemies.find(f=>f.mesh===this.studioDraggedObject);u&&u.position.copy(this.studioDraggedObject.position)}break}},i=()=>{this.studioIsDragging&&(this.studioIsDragging=!1,this.studioDraggedObject=null,this.player.controls&&(this.player.controls.enabled=!0))};e.addEventListener("pointerdown",t),e.addEventListener("pointermove",s),e.addEventListener("pointerup",i),e.addEventListener("pointerleave",i),this._objectClickHandler=o=>{if(!this.player||!this.hud)return;const n=this.player.gameMode||"arcade";if(n==="matrix")return;if(n==="studio"&&this.studioRemoveNPCMode){const d=this.renderer.domElement.getBoundingClientRect(),p=(o.clientX-d.left)/d.width*2-1,g=-((o.clientY-d.top)/d.height*2-1),M=new Y;if(M.setFromCamera(new U(p,g),this.camera),this.enemyManager&&this.enemyManager.enemies){console.log("Remove NPC: Checking",this.enemyManager.enemies.length,"enemies");for(let b=this.enemyManager.enemies.length-1;b>=0;b--){const S=this.enemyManager.enemies[b];if(S.mesh&&M.intersectObject(S.mesh,!0).length>0){console.log("Hit enemy",b,"removing..."),this.scene.remove(S.mesh),this.enemyManager.enemies.splice(b,1),console.log("Removed NPC");return}}}return}if(n==="studio"&&this.studioSelectedPrefab){const d=e.getBoundingClientRect(),p=(o.clientX-d.left)/d.width*2-1,g=-((o.clientY-d.top)/d.height*2-1),M=new Y;M.setFromCamera(new U(p,g),this.camera);const b=M.intersectObjects(this.world.objects,!0);let S=null;for(const C of b)if(C.object&&C.object.userData&&C.object.userData.gameName==="Ground"){S=C;break}if(!S){const C=new Y;C.setFromCamera(new U(0,0),this.camera);const D=C.intersectObjects(this.world.objects,!0);for(const B of D)if(B.object&&B.object.userData&&B.object.userData.gameName==="Ground"){S=B;break}}if(S){if(this.studioSelectedPrefab==="npc"){if(this.enemyManager&&typeof this.enemyManager.spawnEnemyAt=="function"){const C=this.studioSelectedOptions?this.studioSelectedOptions.type:"normal";this.enemyManager.spawnEnemyAt(S.point.x,S.point.z,C)}}else if(typeof this.world.spawnPrefab=="function"){const C=this.studioSelectedOptions||{};this.world.spawnPrefab(this.studioSelectedPrefab,S.point.x,S.point.z,C)}}this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0);return}let a=0,l=0;if(this.player.controls&&this.player.controls.isLocked)a=0,l=0;else{const d=e.getBoundingClientRect();a=(o.clientX-d.left)/d.width*2-1,l=-((o.clientY-d.top)/d.height*2-1)}this._pickRaycaster.setFromCamera(new U(a,l),this.camera);const r=[];if(this.world&&Array.isArray(this.world.objects)&&r.push(...this.world.objects),this.itemManager&&Array.isArray(this.itemManager.items)&&r.push(...this.itemManager.items),this.enemyManager&&Array.isArray(this.enemyManager.enemies)&&this.enemyManager.enemies.forEach(d=>{d&&d.mesh&&r.push(d.mesh)}),r.length===0)return;const h=this._pickRaycaster.intersectObjects(r,!0);if(!h.length)return;let c=h[0].object,u=null;for(;c;){if(c.userData&&(c.userData.gameId||c.userData.gameid)&&c.userData.gameName){u=c.userData;break}c=c.parent}if(!u)return;const f=u.gameName||"Object",m=u.gameId||u.gameid||"---";typeof this.hud.showSelectionInfo=="function"&&this.hud.showSelectionInfo(f,m)},e.addEventListener("click",this._objectClickHandler),e.addEventListener("pointerdown",this._objectClickHandler)}initStudioPaletteDrag(e){if(!e||e._dragInit)return;e._dragInit=!0;const t=e.querySelector(".palette-title")||e;let s=!1,i=0,o=0,n=0,a=0,l=null;e.style.touchAction="none";const r=c=>{if(!s){const d=Math.abs(c.clientX-n),p=Math.abs(c.clientY-a);if(d<3&&p<3)return;s=!0,l&&(e.style.right="auto",e.style.bottom="auto",e.style.position="fixed",e.style.width=`${l.width}px`,e.style.minWidth=`${l.width}px`,e.style.maxWidth=`${l.width}px`,e.style.left=`${l.left}px`,e.style.top=`${l.top}px`)}const u=e.getBoundingClientRect(),f=Math.max(0,Math.min(window.innerWidth-u.width,c.clientX-i)),m=Math.max(0,Math.min(window.innerHeight-u.height,c.clientY-o));e.style.left=`${f}px`,e.style.top=`${m}px`},h=()=>{s=!1,t.releasePointerCapture&&t.releasePointerCapture(t._dragPointerId),document.removeEventListener("pointermove",r),document.removeEventListener("pointerup",h)};t.addEventListener("pointerdown",c=>{try{c.preventDefault()}catch{}const u=e.getBoundingClientRect();l=u,i=c.clientX-u.left,o=c.clientY-u.top,n=c.clientX,a=c.clientY,s=!1,t._dragPointerId=c.pointerId;try{t.setPointerCapture(c.pointerId)}catch{}document.addEventListener("pointermove",r),document.addEventListener("pointerup",h)})}togglePause(){if(this.player){if(this.player.controls&&this.player.controls.isLocked){this.showPauseMenu();return}this.isPaused=!this.isPaused,this.isPaused?this.pauseBackgroundMusic():this.playBackgroundMusic()}}setupPauseMenu(){document.addEventListener("keydown",t=>{t.code==="Escape"&&this.player&&!this.player.isDead&&(t.preventDefault(),this.showPauseMenu())});const e=document.getElementById("pause-menu");e&&e.remove()}showPauseMenu(){this.isPaused=!0,this.player.controls&&this.player.controls.isLocked&&this.player.controls.unlock(),this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps(),this.pauseBackgroundMusic();const e=document.getElementById("main-menu");if(e){e.style.display="flex",this.setMenuOpenState(!0);const t=document.getElementById("play-btn");t&&this.player&&(t.innerText="RESUME GAME")}if(this.setHotbarVisible(!1),this.player&&this.player.gameMode==="studio"){const t=document.getElementById("studio-palette");t&&t.classList.remove("hidden")}}setupTopBar(e){const t=document.getElementById("game-topbar");if(!t)return;t.style.display="flex";const s=document.getElementById("topbar-gamemode");if(s){const l={arcade:"ARCADE",survival:"SURVIVAL",arena:"ARENA",matrix:"MATRIX","matrix-ai":"MATRIX AI",multiplayer:"MULTIPLAYER"};s.innerText=`MODE: ${l[e.gameMode]||"UNKNOWN"}`}const i=document.getElementById("topbar-menu-btn"),o=document.getElementById("topbar-dropdown");if(i&&o){const l=i.cloneNode(!0);i.parentNode.replaceChild(l,i),l.addEventListener("click",h=>{h.stopPropagation(),o.classList.toggle("hidden")});const r=()=>{o.classList.add("hidden")};document.addEventListener("click",r)}const n=document.getElementById("topbar-quit");if(n){const l=n.cloneNode(!0);n.parentNode.replaceChild(l,n),l.addEventListener("click",()=>{confirm("Are you sure you want to quit this game?")&&(t&&(t.style.display="none"),location.reload())})}const a=document.getElementById("topbar-info");if(a){const l=a.cloneNode(!0);a.parentNode.replaceChild(l,a),l.addEventListener("click",()=>{const r=e.mapSize||"Unknown",h=e.enemyCount||0,c=e.stormEnabled?"Yes":"No",u=this.multiplayer&&this.multiplayer.others?this.multiplayer.others.size+1:1;alert(`ðŸŽ® Game Information

Mode: ${e.gameMode}
Map Size: ${r}m
Enemies: ${h}
Storm: ${c}
Players: ${u}`)})}}playBackgroundMusic(){try{this.bgAudio||(this.bgAudio=new Audio(Wt),this.bgAudio.loop=!0,this.bgAudio.volume=this.bgMusicVolume,this.bgAudio.preload="auto");const e=this.bgAudio.play();e&&typeof e.then=="function"&&e.catch(()=>{})}catch(e){console.warn("Could not play background music:",e)}}pauseBackgroundMusic(){if(this.bgAudio&&!this.bgAudio.paused)try{this.bgAudio.pause()}catch{}}stopBackgroundMusic(){if(this.bgAudio)try{this.bgAudio.pause(),this.bgAudio.currentTime=0}catch{}}requestFullscreenIfNeeded(e){if(!e)return;const t=document;if(t.fullscreenElement||t.webkitFullscreenElement||t.mozFullScreenElement||t.msFullscreenElement)return;const i=document.documentElement||document.body,o=i.requestFullscreen||i.webkitRequestFullscreen||i.mozRequestFullScreen||i.msRequestFullscreen;o?o.call(i).catch(n=>{console.warn("Fullscreen request failed:",n),me&&alert("Fullscreen may not be supported on this mobile device.")}):me&&alert("Fullscreen is not available on this mobile device.")}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){if(this._animationStarted){this.stats.begin(),requestAnimationFrame(()=>this.animate());try{const e=this.clock.getDelta(),t=Math.min(e,.1),s=!!(this.touchControls&&this.touchControls.enabled),i=!!(this.player&&this.player.controls&&this.player.controls.isLocked),o=!!(this.player&&this.player.gameMode==="studio");if(!this.isPaused&&this.player&&(i||s||o)){try{this.player.update(t)}catch(n){console.error("Error in player.update:",n)}try{const n=this.world.update(t,this.player.position);!(this.player&&this.player.gameMode==="studio")&&n&&n.inStorm?this.player.takeDamage(1*t):this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch(n){console.error("Error in world.update:",n)}try{this.enemyManager.update(t)}catch(n){console.error("Error in enemyManager.update:",n)}try{this.itemManager.update(t)}catch(n){console.error("Error in itemManager.update:",n)}if(this.player&&this.player.gameMode==="multiplayer"){if(this.matchPhase==="live")this.multiplayerDropTimer+=t,this.multiplayerDropTimer>=30&&(this.multiplayerDropActive=!0),this.multiplayerDropActive&&this.itemManager&&(this.multiplayerDropCooldown-=t,this.multiplayerDropCooldown<=0&&(this.multiplayerDropCooldown=60,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"&&this.itemManager.spawnMatrixDropNearPlayer()));else if(this.matchPhase==="countdown"){this.lobbyCountdown-=t;const n=document.getElementById("mp-lobby-countdown");this.lobbyCountdown<0&&(this.lobbyCountdown=0),n&&(n.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`),this.lobbyCountdown<=0&&this.startMultiplayerMatch()}}try{this.multiplayer&&typeof this.multiplayer.update=="function"&&this.multiplayer.update(t)}catch(n){console.error("Error in multiplayer.update:",n)}if(this.player&&(this.player.gameMode==="arcade"||this.player.gameMode==="survival")){this.survivalTime=(performance.now()-this.survivalStartTime)/1e3;const n=document.getElementById("survival-time-value");if(n){const a=Math.floor(this.survivalTime/60),l=Math.floor(this.survivalTime%60);n.innerText=`${a.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`}if(this.itemManager&&this.enemyManager){const a=this.itemManager.items?this.itemManager.items.filter(r=>!(r.userData&&r.userData.isOpened)).length:0,l=this.enemyManager.targetCount>0?this.enemyManager.killedCount/this.enemyManager.targetCount:0;if(a===0&&l>=.3&&!this.lootDropEligible&&(this.lootDropEligible=!0,this.lootDropCooldown=0,console.log("Loot drops from sky enabled! Player killed 30%+ zombies.")),this.lootDropEligible&&(this.lootDropCooldown-=t,this.lootDropCooldown<=0&&(this.lootDropCooldown=45,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"))){const r=2+Math.floor(Math.random()*2);for(let h=0;h<r;h++)this.itemManager.spawnMatrixDropNearPlayer();console.log(`Dropped ${r} items from sky!`)}}}try{this.hud.update()}catch(n){console.error("Error in hud.update:",n)}try{this.touchControls&&typeof this.touchControls.update=="function"&&this.touchControls.update()}catch(n){console.error("Error in touchControls.update:",n)}try{if(!(this.player&&(this.player.gameMode==="matrix"||this.player.gameMode==="studio"||this.player.gameMode==="multiplayer"||this.player.gameMode==="matrix-ai"))&&this.enemyManager.enemies.length===0&&!this.player.isDead&&!this.victoryShown){this.victoryShown=!0;try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}this.hud.showVictory(),this.player.controls.unlock()}else this.player&&this.player.gameMode==="multiplayer"&&this.matchPhase==="live"&&!this.player.isDead&&!this.victoryShown&&(this.multiplayer?this.multiplayer.others.size:0)===0&&(this.victoryShown=!0,this.hud.showVictory(),this.player.controls&&this.player.controls.unlock&&this.player.controls.unlock())}catch(n){console.error("Error in victory check:",n)}}this.renderer.render(this.scene,this.camera),this.stats.end()}catch(e){try{console.error("Unhandled error in Game.animate:",e,{playerExists:!!this.player,playerWeaponCount:this.player?this.player.weapons?this.player.weapons.length:"no-weapons":"no-player",currentWeaponIndex:this.player?this.player.currentWeaponIndex:"no-player",hudExists:!!this.hud,hudSettings:this.hud?this.hud.settings:null});try{this._logRenderMaterialDiagnostics(e)}catch(t){console.error("Error during render diagnostics:",t)}}catch(t){console.error("Error logging animate failure:",t)}return}}}}_e.prototype.playEndSequence=function(H,e={}){try{if(this._playingEndSequence)return;if(this._playingEndSequence=!0,this.bgAudio)try{this._prevBgVolume=this.bgAudio.volume,this.bgAudio.pause()}catch{this._prevBgVolume=this.bgMusicVolume}if(this._endSequenceAudio){try{this._endSequenceAudio.pause(),this._endSequenceAudio.currentTime=0}catch{}this._endSequenceAudio=null}const t=new Audio(H);t.loop=e.loop||!1,t.volume=e.volume!==void 0?e.volume:1,t.preload="auto",this._endSequenceAudio=t,t.load(),setTimeout(()=>{const s=t.play();s&&typeof s.then=="function"&&s.catch(i=>{console.log("Audio playback blocked, waiting for user interaction:",i);const o=()=>{t.readyState<2&&t.load(),t.play().catch(()=>{}),document.removeEventListener("touchstart",o),document.removeEventListener("click",o)};document.addEventListener("touchstart",o,{once:!0}),document.addEventListener("click",o,{once:!0})})},100),t.addEventListener("ended",()=>{try{this.bgAudio&&this._prevBgVolume!==null&&(this.bgAudio.volume=this._prevBgVolume)}catch{}this._endSequenceAudio=null,this._prevBgVolume=null,this._playingEndSequence=!1})}catch(t){console.warn("playEndSequence error:",t)}};_e.prototype._logRenderMaterialDiagnostics=function(H){try{const e=[];let t=0;this.scene.traverse(s=>{if(s.isMesh){t++;const i=s.material;if(!i){e.push({uuid:s.uuid,name:s.name||s.userData&&s.userData.gameName||"mesh",issue:"no-material"});return}const o=n=>({type:n.type||n.constructor&&n.constructor.name||"Unknown",isShaderMaterial:!!n.isShaderMaterial,isStandardMaterial:!!n.isMeshStandardMaterial,hasEmissive:n.emissive!==void 0,uniformsKeys:n.uniforms?Object.keys(n.uniforms):null,userData:n.userData||null});Array.isArray(i)?e.push({uuid:s.uuid,name:s.name||s.userData&&s.userData.gameName||"mesh",materials:i.map(o)}):e.push({uuid:s.uuid,name:s.userData&&s.userData.gameName||s.name||"mesh",material:o(i)})}}),console.error("Render diagnostics:",{originalError:H&&H.toString(),totalMeshes:t,sampleProblems:e.slice(0,30),note:"Look for materials missing expected uniforms (shader/standard) or meshes without material."})}catch(e){console.error("Failed collecting render diagnostics:",e)}};window.game=new _e;(function(){try{if(typeof qe!="function"){console.warn("createDebugOverlay is not available, skipping debug overlay setup");return}const e=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}"),t=e&&e.debugMode||localStorage.getItem("showDebugOverlay")==="true"||!!window.DEBUG_OVERLAY;window.debugOverlay=qe({autoShow:!!t}),window.addEventListener("keydown",s=>{if(s.key==="`"&&window.debugOverlay){const i=document.getElementById("debug-overlay");i&&i.classList.contains("hidden")?window.debugOverlay.show():window.debugOverlay&&window.debugOverlay.hide()}});try{let s=document.getElementById("debug-toggle-btn");s||(s=document.createElement("button"),s.id="debug-toggle-btn",s.title="Debug logs",s.innerText="DBG",document.body.appendChild(s));const i=!0;s.addEventListener("click",o=>{try{const n=document.getElementById("debug-overlay");n&&n.classList.contains("hidden")?(window.debugOverlay&&window.debugOverlay.show(),localStorage.setItem("showDebugOverlay","true")):(window.debugOverlay&&window.debugOverlay.hide(),localStorage.removeItem("showDebugOverlay"))}catch(n){console.warn("debug toggle error",n)}})}catch{}}catch(e){console.warn("debugOverlay init failed",e)}})();window.addEventListener("game-touch-look",H=>{try{const e=H.detail||{dx:0,dy:0},t=.003;if(window.game&&window.game.player)try{if(typeof window.game.player.rotateCamera=="function")window.game.player.rotateCamera(e.dx*t,e.dy*t);else{window.game.player._touchYaw=(window.game.player._touchYaw||0)-e.dx*.01,window.game.player._touchPitch=(window.game.player._touchPitch||0)-e.dy*.01;const i=Math.PI/2-.1;window.game.player._touchPitch=Math.max(-i,Math.min(i,window.game.player._touchPitch))}}catch{}}catch{}});
