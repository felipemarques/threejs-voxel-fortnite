import{V as B,P as q,B as xe,C as ie,M as x,a as w,b as ye,c as S,G as Ke,d as Me,e as T,f as Je,g as Ze,R as Qe,N as et,h as tt,S as Ce,D as Re,i as Ve,j as K,k as Fe,l as Ge,T as it,E as st,m as Ue,n as j,o as O,p as ot,q as We,L as nt,r as at,s as rt,t as F,u as ht,v as lt,w as ct,x as dt,y as ut,z as mt,A as pt,F as ft,H as gt,I as yt,J as wt,W as vt,K as Mt,O as Oe,Q as Be,U as bt,X as St}from"./slendermanElement-5duizSjO.js";import{c as xt,a as kt,b as Et,d as Dt,e as Bt,f as Ct,g as Pt,h as It,i as At,j as Tt,_ as Lt,k as zt}from"./spiderElement-CzOL8jDE.js";const _t="/threejs-voxel-firecraft/dist/assets/background-music-by-suno-B4M28EgO.ogg",ke=400;class Ht{constructor(e,t,i){this.scene=e,this.itemManager=t,this.objects=[],this.gameMode=i&&i.gameMode?i.gameMode:"arcade",this.gameMode==="arena"?this.mapSize=150:this.mapSize=i&&i.mapSize?i.mapSize:ke,this.halfMapSize=this.mapSize/2,this.stormRadius=this.halfMapSize,this.initialStormRadius=this.stormRadius,this._heightFn=this._buildHeightFn(),this.stormEnabled=i&&i.stormEnabled!==!1;const s=i?i.stormTime:180;this.stormShrinkRate=this.stormRadius/s,this.safeZoneCenter=new B(0,0,0),this.init()}init(){this.gameMode==="arena"?this.createArenaEnvironment():this.gameMode==="matrix"?this.createMatrixEnvironment():this.gameMode==="matrix-ai"?this.createMatrixAIEnvironment():this.gameMode==="multiplayer"?this.createMultiplayerEnvironment():this.gameMode==="studio"?this.createStudioEnvironment():this.gameMode==="survival"?this.createSurvivalEnvironment():this.createEnvironment(),this.gameMode!=="matrix"&&this.gameMode!=="studio"&&this.stormEnabled&&this.createStormVisuals()}createEnvironment(){const e=(d=1)=>(Math.random()-.5)*(this.mapSize*d),t=(d=1)=>{const u=this.halfMapSize-5,p=e(d);return Math.max(-u,Math.min(u,p))},i=(d=1,u=12)=>{let p,v,g=0;do p=t(d),v=t(d),g++;while(p*p+v*v<u*u&&g<20);return{x:p,z:v}},s=(d,u)=>this.getHeightAt?this.getHeightAt(d,u):0,o={trees:70,rocks:50,bushes:50,grass:180,houses:12,vehicles:12,plateaus:4,smallBuildings:5},n=new q(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let d=0;d<a.count;d++)a.setZ(d,0);a.needsUpdate=!0;const c=n.attributes.position.count;n.setAttribute("color",new xe(new Float32Array(c*3),3));const h=n.attributes.color,r=new ie;for(let d=0;d<c;d++){const u=Math.random();u>.8?r.setHex(2600544):u>.4?r.setHex(3066993):r.setHex(5822093),h.setXYZ(d,r.r,r.g,r.b)}const l=new x({vertexColors:!0,roughness:.8}),m=new w(n,l);m.rotation.x=-Math.PI/2,m.receiveShadow=!0,m.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(m),this.objects.push(m);for(let d=0;d<o.trees;d++){const{x:u,z:p}=i(.9),v=s(u,p),g=Math.random()>.5?"Oak":"Pine",M=this.createTree(u,p,g);M.position.y=v,M.userData={gameId:this.generateID(),gameName:`Tree_${g}`,type:"tree"},this.scene.add(M),this.objects.push(M)}const f=[(d,u)=>this.createRock(d,u),(d,u,p)=>this.createRockPillar(d,u,p),(d,u,p)=>this.createFlatBoulder(d,u,p),(d,u,p)=>this.createCrystalShard(d,u,p),(d,u,p)=>this.createStackedRock(d,u,p),(d,u,p)=>this.createBasaltCluster(d,u,p)];for(let d=0;d<o.rocks;d++){const{x:u,z:p}=i(.9),v=s(u,p),g=f[d%f.length],M=g(u,p,v);M.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(M),this.objects.push(M)}for(let d=0;d<o.bushes;d++){const{x:u,z:p}=i(.85),v=s(u,p),g=this.createBush(u,p);g.position.y=v,g.userData={gameId:this.generateID(),gameName:"Bush"},this.scene.add(g),this.objects.push(g)}for(let d=0;d<o.grass;d++){const{x:u,z:p}=i(.95),v=s(u,p),g=this.createGrassClump(u,p);g.position.y=v,this.scene.add(g)}for(let d=0;d<o.houses;d++){const{x:u,z:p}=i(.75,20),v=s(u,p),g=Math.random(),M=g>.7,k=g<.25,b=M?1.55:k?.9:1,D=M?"Mansion":k?"Cabin":"House",C=M?"large":k?"small":"medium",P=this.createHouse(u,p,{scale:b});P.position.y=v,P.userData={gameId:this.generateID(),gameName:D,type:"house",size:C},this.scene.add(P),this.objects.push(P),this.itemManager.spawnLootInHouse(u,1,p)}for(let d=0;d<o.vehicles;d++){const{x:u,z:p}=i(.8),v=s(u,p),g=Math.random()>.6?"truck":"car",M=this.createVehicle(u,p,g);M.position.y=v,M.userData={...M.userData||{},gameId:this.generateID(),gameName:`Vehicle_${g}`,type:"vehicle"},this.scene.add(M),this.objects.push(M)}for(let d=0;d<o.plateaus;d++){const{x:u,z:p}=i(.6,25),v=6+Math.random()*6,g=8+Math.random()*6,M=s(u,p),k=this.createPlateau(u,p,g,v,M);k.userData={gameId:this.generateID(),gameName:"Plateau",type:"house"},this.scene.add(k),this.objects.push(k)}for(let d=0;d<o.smallBuildings;d++){const{x:u,z:p}=i(.7,18),v=s(u,p),g=this.createSmallBuilding(u,p);g.position.y=v,g.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"},this.scene.add(g),this.objects.push(g)}}createSurvivalEnvironment(){const e=(d=1)=>(Math.random()-.5)*(this.mapSize*d),t=(d=1)=>{const u=this.halfMapSize-5,p=e(d);return Math.max(-u,Math.min(u,p))},i=(d=1,u=12)=>{let p,v,g=0;do p=t(d),v=t(d),g++;while(p*p+v*v<u*u&&g<20);return{x:p,z:v}},s=(d,u)=>this.getHeightAt?this.getHeightAt(d,u):0,o={trees:90,rocks:60,bushes:80,grass:250},n=new q(this.mapSize,this.mapSize,64,64),a=n.attributes.position;for(let d=0;d<a.count;d++)a.setZ(d,0);a.needsUpdate=!0;const c=n.attributes.position.count;n.setAttribute("color",new xe(new Float32Array(c*3),3));const h=n.attributes.color,r=new ie;for(let d=0;d<c;d++){const u=Math.random();u>.8?r.setHex(2600544):u>.4?r.setHex(3066993):r.setHex(5822093),h.setXYZ(d,r.r,r.g,r.b)}const l=new x({vertexColors:!0,roughness:.8}),m=new w(n,l);m.rotation.x=-Math.PI/2,m.receiveShadow=!0,m.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(m),this.objects.push(m);for(let d=0;d<o.trees;d++){const{x:u,z:p}=i(.9),v=s(u,p),g=Math.random()>.5?"Oak":"Pine",M=this.createTree(u,p,g);M.position.y=v,M.userData={gameId:this.generateID(),gameName:`Tree_${g}`,type:"tree"},this.scene.add(M),this.objects.push(M)}const f=[(d,u)=>this.createRock(d,u),(d,u,p)=>this.createRockPillar(d,u,p),(d,u,p)=>this.createFlatBoulder(d,u,p),(d,u,p)=>this.createCrystalShard(d,u,p),(d,u,p)=>this.createStackedRock(d,u,p),(d,u,p)=>this.createBasaltCluster(d,u,p)];for(let d=0;d<o.rocks;d++){const{x:u,z:p}=i(.9),v=s(u,p),g=f[d%f.length],M=g(u,p,v);M.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(M),this.objects.push(M)}for(let d=0;d<o.bushes;d++){const{x:u,z:p}=i(.85),v=s(u,p),g=this.createBush(u,p);g.position.y=v,g.userData={gameId:this.generateID(),gameName:"Bush"},this.scene.add(g),this.objects.push(g)}for(let d=0;d<o.grass;d++){const{x:u,z:p}=i(.95),v=s(u,p),g=this.createGrassClump(u,p);g.position.y=v,this.scene.add(g)}}createArenaEnvironment(){const e=(n=1)=>(Math.random()-.5)*(this.mapSize*n),t=(n=1)=>{const a=this.halfMapSize-5,c=e(n);return Math.max(-a,Math.min(a,c))},i=new q(this.mapSize,this.mapSize,1,1),s=new ye({color:3885915,flatShading:!0}),o=new w(i,s);o.rotation.x=-Math.PI/2,o.receiveShadow=!0,o.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(o),this.objects.push(o);for(let n=0;n<30;n++){const a=t(.8),c=t(.8),h=1+Math.random()*3,r=1+Math.random()*2,l=1+Math.random()*2,m=new S(r,h,l),f=new ye({color:5596791,flatShading:!0}),d=new w(m,f);d.position.set(a,h/2,c),d.castShadow=!0,d.receiveShadow=!0,d.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},this.scene.add(d),this.objects.push(d)}for(let n=0;n<6;n++){const a=t(.7),c=t(.7),h=6+Math.random()*3,r=3+Math.random()*2,l=3,m=new S(l,r,h),f=new ye({color:4937059,flatShading:!0}),d=new w(m,f);d.position.set(a,r/2,c),d.rotation.x=-Math.atan(r/h),d.castShadow=!0,d.receiveShadow=!0,d.userData={gameId:this.generateID(),gameName:"Ramp",type:"house"},this.scene.add(d),this.objects.push(d)}for(let n=0;n<6;n++){const a=t(.6),c=t(.6),h=this.createArenaBunker(a,c);h.userData={gameId:this.generateID(),gameName:"Bunker",type:"house"},this.scene.add(h),this.objects.push(h)}for(let n=0;n<20;n++){const a=t(.8),c=t(.8),h=this.createFlatBoulder(a,c,0);h.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"},this.scene.add(h),this.objects.push(h)}this.itemManager.spawnLootInHouse(0,0,0)}createMatrixEnvironment(){const e=new q(this.mapSize,this.mapSize,128,128),t=e.attributes.position.count;e.setAttribute("color",new xe(new Float32Array(t*3),3));const i=e.attributes.color,s=new ie;for(let m=0;m<t;m++){const f=Math.random();f>.8?s.setHex(2600544):f>.4?s.setHex(3066993):s.setHex(5822093),i.setXYZ(m,s.r,s.g,s.b)}const o=new x({vertexColors:!0,roughness:.8}),n=new w(e,o);n.rotation.x=-Math.PI/2,n.receiveShadow=!0,n.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(n),this.objects.push(n);const a=new S(20,6,.5),c=new x({color:15987699,roughness:.9}),h=new w(a,c);h.position.set(0,3,-15),h.castShadow=!0,h.receiveShadow=!0,h.userData={gameId:this.generateID(),gameName:"Wall",type:"house"},this.scene.add(h),this.objects.push(h);const r=this.createTree(-12,-15,"Oak"),l=this.createTree(12,-15,"Pine");this.scene.add(r),this.scene.add(l),this.objects.push(r),this.objects.push(l)}createStudioEnvironment(){const e=new q(this.mapSize,this.mapSize,128,128),t=this.buildVoxelGroundMaterial(),i=new w(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(i),this.objects.push(i);const s=12;for(let o=0;o<s;o++){const n=(Math.random()-.5)*this.mapSize*.6,a=(Math.random()-.5)*this.mapSize*.6,c=this.createVoxelCloud(n,a);this.scene.add(c)}}createMatrixAIEnvironment(){const e=this.mapSize,t=80,i=new Ke(e,t,16777215,16777215);(Array.isArray(i.material)?i.material:[i.material]).forEach(c=>{c.opacity=.3,c.transparent=!0,c.depthWrite=!1}),i.position.y=.02,this.scene.add(i);const o=new q(e,e,1,1),n=new Me({visible:!1}),a=new w(o,n);a.rotation.x=-Math.PI/2,a.userData={gameId:this.generateID(),gameName:"Ground",type:"ground"},this.scene.add(a),this.objects.push(a)}createMultiplayerEnvironment(){const e=new q(this.mapSize,this.mapSize,128,128),t=this.buildVoxelGroundMaterial(),i=new w(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.userData={gameId:this.generateID(),gameName:"Ground"},this.scene.add(i),this.objects.push(i),this.stormEnabled=!1}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}createTree(e,t,i){const s=i==="Oak"?xt():kt();return s.position.set(e,0,t),s}createVoxelCloud(e,t){const i=new T,s=new S(3,2,3),o=new Je({color:15922943,transparent:!0,opacity:.9}),n=8+Math.floor(Math.random()*6);for(let a=0;a<n;a++){const c=(Math.random()-.5)*12,h=(Math.random()-.5)*12,r=(Math.random()-.5)*2,l=new w(s,o);l.position.set(c,r,h),l.castShadow=!1,l.receiveShadow=!1,i.add(l)}return i.position.set(e,30+Math.random()*8,t),i}buildVoxelGroundMaterial(){const t=document.createElement("canvas");t.width=64,t.height=64;const i=t.getContext("2d"),s="#4caf50",o="#66bb6a",n="#8d6e63",a=8;for(let l=0;l<64;l+=a)for(let m=0;m<64;m+=a){const d=Math.random()>.85?n:(m/a+l/a)%2===0?s:o;i.fillStyle=d,i.fillRect(m,l,a,a)}const c=i.getImageData(0,0,64,64),h=c.data;for(let l=0;l<h.length;l+=4){const m=Math.random()*30-15;h[l]=Math.min(255,Math.max(0,h[l]+m)),h[l+1]=Math.min(255,Math.max(0,h[l+1]+m)),h[l+2]=Math.min(255,Math.max(0,h[l+2]+m))}i.putImageData(c,0,0);const r=new Ze(t);return r.wrapS=r.wrapT=Qe,r.repeat.set(this.mapSize/10,this.mapSize/10),r.magFilter=et,r.minFilter=tt,new x({map:r,roughness:1,metalness:0})}createRock(e,t,i=0){const s=Et(e,t,i);return this._tagStaticCollider(s,"rock"),s}createRockPillar(e,t,i=0){const s=Dt(e,t,i);return this._tagStaticCollider(s,"rock"),s}createFlatBoulder(e,t,i=0){const s=Bt(e,t,i);return this._tagStaticCollider(s,"rock"),s}createCrystalShard(e,t,i=0){return Ct(e,t,i)}createStackedRock(e,t,i=0){const s=new T,o=this.createRock(0,0,0);s.add(o);const n=this.createRock(0,0);n.scale.set(.6,.6,.6),n.position.set(.3,n.position.y+.9,-.2),s.add(n);const a=this.createRock(0,0);return a.scale.set(.4,.4,.4),a.position.set(-.2,a.position.y+1.5,.3),s.add(a),s.position.set(e,i,t),s.traverse(c=>{c.castShadow=!0,c.receiveShadow=!0}),this._tagStaticCollider(s,"rock"),s}createBasaltCluster(e,t,i=0){const s=Pt(e,t,i);return this._tagStaticCollider(s,"rock"),s}createVehicle(e,t,i="car"){let s;return i==="bus"?s=It():i==="motorcycle"?s=At():s=Tt(i),s.position.set(e,0,t),s}createBush(e,t){const i=new T;i.position.set(e,0,t);const s=new x({color:2924588,roughness:1}),o=2+Math.floor(Math.random()*3);for(let n=0;n<o;n++){const a=1.2+Math.random()*1,c=new w(new Ce(a,6,6),s);c.position.set((Math.random()-.5)*1.2,a*.65,(Math.random()-.5)*1.2),c.castShadow=!0,i.add(c)}return i}createGrassClump(e,t){const i=new T;i.position.set(e,0,t);const s=3+Math.floor(Math.random()*4);for(let o=0;o<s;o++){const n=.2+Math.random()*.6,a=new q(.05,n),c=new x({color:5620331,side:Re}),h=new w(a,c);h.position.y=n/2,h.rotation.y=Math.random()*Math.PI,h.rotation.z=(Math.random()-.5)*.6,h.receiveShadow=!0,i.add(h)}return i}createHouse(e,t,{scale:i=1}={}){const s=new T;s.position.set(e,0,t),s.rotation.y=Math.random()*Math.PI*2;const o=new x({color:9807270}),n=new x({color:12597547});[{w:6,h:4,d:.5,x:0,y:2,z:-3},{w:.5,h:4,d:6,x:-3,y:2,z:0},{w:.5,h:4,d:6,x:3,y:2,z:0},{w:2,h:4,d:.5,x:-2,y:2,z:3},{w:2,h:4,d:.5,x:2,y:2,z:3},{w:2,h:1,d:.5,x:0,y:3.5,z:3}].forEach(d=>{const u=new w(new S(d.w,d.h,d.d),o);u.position.set(d.x,d.y,d.z),u.castShadow=!0,u.receiveShadow=!0,s.add(u),this.objects.push(u)});const c=new w(new Ve(5,2,4),n);c.position.y=5,c.rotation.y=Math.PI/4,c.castShadow=!0,s.add(c);const h=new x({color:5057307}),r=new w(new S(1,2.2,.1),h);r.position.set(0,1.1,3.26),s.add(r);const l=new x({color:8962303,metalness:.1,roughness:.2,transparent:!0,opacity:.8}),m=new w(new S(1,1,.05),l);m.position.set(-2,2.2,-3.26);const f=m.clone();return f.position.set(2,2.2,-3.26),s.add(m),s.add(f),s.scale.setScalar(i),s}createPlateau(e,t,i=10,s=8,o=0){const n=new T,a=new x({color:8355711,roughness:1}),c=new w(new K(i,i*1.05,s,16,1),a);c.position.set(0,s/2,0),c.castShadow=!0,c.receiveShadow=!0,n.add(c);const h=i*1.4,r=s,l=i*.8,m=new S(l,r,h),f=new w(m,new x({color:9342606,roughness:1}));f.castShadow=!0,f.receiveShadow=!0;const d=Math.atan(r/h);f.rotation.x=-d,f.position.set(0,r/2,i),f.userData={type:"house"},n.add(f);const u=new S(l,.2,h),p=new w(u,new x({color:7105644}));return p.position.set(0,r,i),p.rotation.x=f.rotation.x,p.castShadow=!0,n.add(p),n.position.set(e,o,t),n.userData={type:"house"},n}createSmallBuilding(e,t){const i=new T;i.position.set(e,0,t),i.rotation.y=Math.random()*Math.PI*2;const s=new x({color:8359053}),o=new x({color:12436423}),n=8,a=8,c=6,h=.35,r=2.2,l=n/2,m=a/2,f=new w(new S(n,c,h),s);f.position.set(0,c/2,-m);const d=new w(new S(h,c,a),s);d.position.set(-l,c/2,0);const u=d.clone();u.position.x=l;const p=new w(new S((n-r)/2,c,h),s);p.position.set(-2.55,c/2,m);const v=p.clone();v.position.x=r/2+(n-r)/4,[f,d,u,p,v].forEach(L=>{L.castShadow=!0,L.receiveShadow=!0,i.add(L)});const g=new w(new S(n-.4,.3,a-.4),o);g.position.y=.15,g.receiveShadow=!0,i.add(g);const M=new w(new S(n-.4,.3,a-.4),o);M.position.y=3.4,M.receiveShadow=!0,i.add(M);const k=M.position.y,b=10,D=new S(3,k,b),C=new w(D,o);C.position.set(0,k/2,m+b/2),C.rotation.x=-Math.atan(k/b),C.castShadow=!0,C.receiveShadow=!0,i.add(C);const P=new w(new S(n+.4,.4,a+.4),new x({color:9807270}));return P.position.y=c+.2,P.castShadow=!0,i.add(P),i}spawnPrefab(e,t,i,s={}){const o=this.getHeightAt&&typeof this.getHeightAt=="function"?this.getHeightAt(t,i):0;let n=null;switch(e){case"house":{n=this.createHouse(t,i,{scale:1}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"House",type:"house"};break}case"mansion":{n=this.createHouse(t,i,{scale:1.6}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Mansion",type:"house",size:"large"};break}case"cabin":{n=this.createHouse(t,i,{scale:.85}),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Cabin",type:"house",size:"small"};break}case"smallBuilding":{n=this.createSmallBuilding(t,i),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"SmallBuilding",type:"house"};break}case"plateau":{const a=this.createPlateau(t,i,10+Math.random()*6,8+Math.random()*6,o);a.userData={gameId:this.generateID(),gameName:"Plateau",type:"house",size:"large"},n=a;break}case"rock":{n=this.createRock(t,i),n.position.y=o,n.userData={gameId:this.generateID(),gameName:"Rock",type:"rock"};break}case"tree":{const a=s.variant||(Math.random()>.5?"Oak":"Pine");n=this.createTree(t,i,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Tree_${a}`,type:"tree"};break}case"vehicle":{const a=s.variant||(Math.random()>.6?"truck":"car");n=this.createVehicle(t,i,a),n.position.y=o,n.userData={gameId:this.generateID(),gameName:`Vehicle_${a}`,type:"vehicle"};break}case"crate":{const a=new w(new S(2,2,2),new x({color:9342606,roughness:.9}));a.position.set(t,o+1,i),a.castShadow=!0,a.receiveShadow=!0,a.userData={gameId:this.generateID(),gameName:"Crate",type:"house"},n=a;break}}return n&&(this.scene.add(n),this.objects.push(n)),n}createArenaBunker(e,t){const i=new T;i.position.set(e,0,t),i.rotation.y=Math.random()*Math.PI*2;const s=new ye({color:4937059,flatShading:!0}),o=new ye({color:6253691,flatShading:!0}),n=new w(new S(6,2.5,6),s);n.position.y=1.25,n.castShadow=!0,n.receiveShadow=!0,i.add(n);const a=new w(new S(6.2,.3,6.2),o);a.position.y=2.65,a.castShadow=!0,i.add(a);const c=new w(new S(1.2,1.8,.2),new ye({color:9280168,flatShading:!0,transparent:!0,opacity:.2}));c.position.set(0,.9,3.1),i.add(c);const h=new S(2,1.2,4),r=new w(h,o);return r.position.set(-2.5,.6,-1),r.rotation.x=-Math.atan(1.2/4),r.castShadow=!0,r.receiveShadow=!0,r.userData={type:"house"},i.add(r),i}createStormVisuals(){if(this.gameMode==="matrix")return;const e=new K(this.stormRadius,this.stormRadius,50,32,1,!0),t=new Me({color:9323693,transparent:!0,opacity:.3,side:Re});this.stormMesh=new w(e,t),this.stormMesh.position.y=25,this.scene.add(this.stormMesh)}createTarget(e,t){const i=new T;i.position.set(e,0,t);const s=new w(new K(.05,.05,2,6),new x({color:8947848}));s.position.y=1,i.add(s);const o=new Fe(.8,24),n=new x({color:16777215}),a=new w(o,n);a.position.set(0,2,0),a.rotation.y=Math.PI,i.add(a);const c=new x({color:16729156}),h=new x({color:15844367}),r=new x({color:3447003}),l=(f,d)=>{const u=new w(new it(f,.02,6,24),d);return u.rotation.x=Math.PI/2,u.position.y=2,u};i.add(l(.75,r)),i.add(l(.55,c)),i.add(l(.35,h));const m=new w(new Fe(.1,12),new x({color:0}));return m.position.set(0,2.01,0),m.rotation.y=Math.PI,i.add(m),i.userData={gameId:this.generateID(),gameName:"Target",type:"house"},i}update(e,t){if(this.gameMode==="matrix"||this.gameMode==="studio"||this.gameMode==="matrix-ai")return{inStorm:!1};if(this.stormEnabled===!1)return{inStorm:!1};if(this.stormRadius>10){this.stormRadius-=this.stormShrinkRate*e;const s=this.initialStormRadius?this.stormRadius/this.initialStormRadius:1;this.stormMesh&&this.stormMesh.scale&&this.stormMesh.scale.set(s,1,s)}return{inStorm:Math.sqrt(t.x*t.x+t.z*t.z)>this.stormRadius}}_buildHeightFn(){return()=>0}_tagStaticCollider(e,t=null){if(!e)return;e.updateWorldMatrix(!0,!0);const i=new Ge().setFromObject(e);e.userData=e.userData||{},t&&!e.userData.type&&(e.userData.type=t),e.userData.colliderBox=i,e.userData.colliderType="solid"}getHeightAt(e,t){return this._heightFn?this._heightFn(e,t):0}}const we=new Ue(0,0,0,"YXZ"),ve=new B,Rt={type:"change"},Ft={type:"lock"},Ot={type:"unlock"},je=Math.PI/2;class jt extends st{constructor(e,t){super(),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=Nt.bind(this),this._onPointerlockChange=Vt.bind(this),this._onPointerlockError=Gt.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(e){return e.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(e){const t=this.camera;ve.setFromMatrixColumn(t.matrix,0),ve.crossVectors(t.up,ve),t.position.addScaledVector(ve,e)}moveRight(e){const t=this.camera;ve.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(ve,e)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function Nt(I){if(this.isLocked===!1)return;const e=I.movementX||I.mozMovementX||I.webkitMovementX||0,t=I.movementY||I.mozMovementY||I.webkitMovementY||0,i=this.camera;we.setFromQuaternion(i.quaternion),we.y-=e*.002*this.pointerSpeed,we.x-=t*.002*this.pointerSpeed,we.x=Math.max(je-this.maxPolarAngle,Math.min(je-this.minPolarAngle,we.x)),i.quaternion.setFromEuler(we),this.dispatchEvent(Rt)}function Vt(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(Ft),this.isLocked=!0):(this.dispatchEvent(Ot),this.isLocked=!1)}function Gt(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}const Ut="/threejs-voxel-firecraft/dist/assets/mixkit-game-gun-shot-D1lu3gfh.ogg",Wt="/threejs-voxel-firecraft/dist/assets/smack-BAv2er9i.ogg",Xt="/threejs-voxel-firecraft/dist/assets/ugh-CPf3Qqe6.ogg",Yt="/threejs-voxel-firecraft/dist/assets/mixkit-footsteps-on-tall-grass-532-DkmduvPT.ogg",$t="/threejs-voxel-firecraft/dist/assets/mixkit-car-door-slam-xN3cwxzE.wav";class Pe{constructor(e,t,i,s={}){this.camera=e,this.scene=t,this.worldObjects=i,this.world=null,this.hud=null,this.gameMode=s.gameMode||"arcade",this.showTracers=s.showTracers===!0,this.backpack=null,this.backpackColor=null,this.placedBlocks=[],this.blockSize=1,this.minBlockSize=.5,this.maxBlockSize=2,this.previewBlock=null,this.isFloating=!1,this.selectedBlock=null,this.selectedBlockHelper=null,this.health=100,this.shield=100,this.isDead=!1,this.stamina=100,this.punchCount=0,this.isTired=!1,this.velocity=new B,this.direction=new B,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.isSprinting=!1,this.canJump=!1,this.speed=42,this.jumpHeight=16,this.gravity=65,this.mouthStyle=s&&s.mouthStyle?s.mouthStyle:"serious",this.mouthMesh=null,this.mouthStyles=["serious","smile","angry","surprised","none"],this.showHat=s&&typeof s.showHat<"u"?s.showHat:!0,this.hatMeshes=[],this.distanceTraveled=0,this.previousPosition=new B,this.allWeapons=[{name:"Pistol",ammo:12,maxAmmo:60,magazineSize:12,currentMag:12,damage:20,cooldown:.5,lastShot:0,reloadTime:1.5,range:50},{name:"Fist",ammo:1/0,maxAmmo:1/0,magazineSize:1/0,currentMag:1/0,damage:10,cooldown:.2,lastShot:0,reloadTime:0,range:3},{name:"Rifle",ammo:30,maxAmmo:120,magazineSize:30,currentMag:30,damage:25,cooldown:.15,lastShot:0,reloadTime:2,range:120,zoomFov:30},{name:"Sniper",ammo:5,maxAmmo:20,magazineSize:5,currentMag:5,damage:100,cooldown:2,lastShot:0,reloadTime:3,range:400,zoomFov:12},{name:"SMG",ammo:40,maxAmmo:200,magazineSize:40,currentMag:40,damage:15,cooldown:.08,lastShot:0,reloadTime:1.8,range:80},{name:"Shotgun",ammo:6,maxAmmo:24,magazineSize:6,currentMag:6,damage:60,cooldown:1,lastShot:0,reloadTime:2.5,range:25},{name:"DMR",ammo:12,maxAmmo:48,magazineSize:12,currentMag:12,damage:45,cooldown:.35,lastShot:0,reloadTime:2.2,range:200,zoomFov:18}],this.gameMode==="matrix-ai"?this.weapons=[this.allWeapons[1]]:this.weapons=[this.allWeapons[1],this.allWeapons[0]],this.currentWeaponIndex=0,this.isReloading=!1,this.controls=new jt(e,document.body),document.addEventListener("pointerlockerror",o=>{try{o.stopImmediatePropagation()}catch{}console.warn("Pointer lock request failed or unavailable in this environment.")},!0),this.allowTouchMovement=!1,this._touchYaw=0,this._touchPitch=0,document.addEventListener("fullscreenchange",()=>{document.fullscreenElement&&document.exitFullscreen().catch(()=>{})}),this.createPlayerMesh(),this.cameraMode=s.cameraMode||"TPS",this.fpsCameraOffset=new B(0,1.6,0),this.tpsCameraOffset=new B(1,1.8,3.4),this.initControls(),this.sfxVolume=.7,this.sfxVolume=.7,this.gunshotBuffer=null,this.reloadBuffer=null,this.smackBuffer=null,this.ughBuffer=null,this.footstepsBuffer=null,this._footstepsSource=null,this._footstepsGain=null,this.vehicleDoorBuffer=null,this.vehicleDriveBuffer=null,this._vehicleDriveSource=null,this._vehicleDriveGain=null,this._lastVehicleDriveActive=!1,this.enableVehicleDriveSound=!1,this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer=null,this._lastFootstepsActive=!1,this.isCrouching=!1,this.crouchHeight=.8,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.vehicleBaseMaxSpeed=70,this.vehicleBoostMax=45,this.vehicleAccel=70,this.vehicleTurnSpeed=1.8,this.vehicleFriction=2.8,this.vehicleAccelHold=0,this.vehiclePromptEl=document.getElementById("interaction-prompt"),this.nearVehicle=null,this.vehicleFuel=0,this.vehicleFuelCapacity=0,this.vehicleDistance=0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=0,this.vehicleEfficiencyKmPerL=10,this.vehicleIdleLph=.4,this.vehicleThrottleLph=.8,this._vehicleStateCache=null,this.vehicleTurbo=!1,this.currentSpeed=0,this.vehicleHud={root:document.getElementById("vehicle-hud"),speed:document.getElementById("vehicle-speed"),fuelBar:document.getElementById("vehicle-fuel-bar"),fuelFill:document.getElementById("vehicle-fuel-fill"),fuelText:document.getElementById("vehicle-fuel-text"),distance:document.getElementById("vehicle-distance"),efficiency:document.getElementById("vehicle-efficiency"),range:document.getElementById("vehicle-range")},this.studioSelected=null,this._studioRaycaster=new j,this.studioSelectionHelper=null,this.selectionInfo=document.getElementById("selection-info"),this.controls.enabled=this.gameMode!=="studio";try{const o=window.AudioContext||window.webkitAudioContext;o&&(this.audioCtx=new o,fetch(Ut).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.gunshotBuffer=n}).catch(n=>console.warn("Error loading gunshot SFX:",n)),Lt(()=>import("./mixkit-shotgun-recharge-CcrH8C2K.js"),[]).then(n=>fetch(n.default)).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.reloadBuffer=n}).catch(n=>console.warn("Error loading reload SFX:",n)),fetch(Wt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.smackBuffer=n}).catch(n=>console.warn("Error loading smack SFX:",n)),fetch(Xt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.ughBuffer=n}).catch(n=>console.warn("Error loading hurt SFX:",n)),fetch(Yt).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.footstepsBuffer=n}).catch(n=>console.warn("Error loading footsteps SFX:",n)),fetch($t).then(n=>n.arrayBuffer()).then(n=>this.audioCtx.decodeAudioData(n)).then(n=>{this.vehicleDoorBuffer=n}).catch(n=>console.warn("Error loading vehicle door SFX:",n)))}catch(o){console.warn("Web Audio API not supported:",o)}}separateFromRemotePlayers(){if(!this.multiplayerClient||!this.multiplayerClient.others||this.multiplayerClient.others.size===0)return;const t=.6*2,i=this.mesh.position;this.multiplayerClient.others.forEach(s=>{if(!s||!s.position||s.userData&&s.userData.dead)return;const o=i.x-s.position.x,n=i.z-s.position.z,a=o*o+n*n;if(a<t*t&&a>1e-4){const c=Math.sqrt(a),h=(t-c)*.5,r=o/c,l=n/c;i.x+=r*h,i.z+=l*h}})}placeBlock(){if(!this.world)return;const e=this.getBlockTarget(),t=e.size,i=new S(t,t,t),s=new x({color:11887901,roughness:.9}),o=new w(i,s);o.position.copy(e.position),o.castShadow=!0,o.receiveShadow=!0,o.userData={type:"block",size:t,gameId:this.world.generateID?this.world.generateID():void 0,gameName:"Block"},this.scene.add(o),this.world.objects&&this.world.objects.push(o),this.placedBlocks.push(o)}createPlayerMesh(){this.mesh=new T,this.scene.add(this.mesh);const e=this.playerColor||3447003,t=new x({color:e}),i=new x({color:16764074}),s=new x({color:2899536});this.head=new w(new S(.5,.5,.5),i),this.head.position.y=1.75,this.head.name="playerHead",this.head.userData={role:"playerHead"},this.mesh.add(this.head);const o=new x({color:15158332}),n=new w(new S(.52,.1,.52),o);n.position.set(0,.3,0),n.userData={role:"playerHat"},n.name="playerHatCap",this.head.add(n);const a=new w(new S(.52,.02,.35),o);a.position.set(0,.22,.35),a.userData={role:"playerHat"},a.name="playerHatBrim",this.head.add(a),this.hatMeshes=[n,a],this.setHatVisible(this.showHat);const c=new x({color:0}),h=new x({color:1710618,transparent:!0,opacity:.7,metalness:.8,roughness:.2}),r=new w(new S(.18,.12,.02),h);r.position.set(-.12,.05,.26),this.head.add(r);const l=new w(new S(.18,.12,.02),h);l.position.set(.12,.05,.26),this.head.add(l);const m=new w(new S(.08,.02,.02),c);m.position.set(0,.05,.26),this.head.add(m);const f=new w(new S(.02,.02,.3),c);f.position.set(-.21,.05,.1),this.head.add(f);const d=new w(new S(.02,.02,.3),c);d.position.set(.21,.05,.1),this.head.add(d),this.createMouth(this.mouthStyle);const u=new w(new S(.6,.8,.3),t);u.position.y=1.1,this.mesh.add(u);const p=new S(.2,.8,.2);p.translate(0,-.3,0),this.leftArmPivot=new T,this.leftArmPivot.name="leftArmPivot",this.leftArmPivot.position.set(-.45,1.4,0),this.mesh.add(this.leftArmPivot);const v=new w(p,i);this.leftArmPivot.add(v),this.rightArmPivot=new T,this.rightArmPivot.name="rightArmPivot",this.rightArmPivot.position.set(.45,1.4,0),this.mesh.add(this.rightArmPivot);const g=new w(p,i);this.rightArmPivot.add(g),this.weaponModels={};const M=new T,k=new w(new S(.12,.12,.35),new x({color:1710618,metalness:.8,roughness:.3}));k.position.set(0,-.28,.2);const b=new w(new S(.06,.06,.15),new x({color:657930,metalness:.9,roughness:.2}));b.position.set(0,-.28,.4);const D=new w(new S(.1,.25,.12),new x({color:2894892}));D.position.set(0,-.42,.15);const C=new w(new S(.03,.05,.03),new x({color:1710618}));C.position.set(0,-.35,.18),M.add(k,b,D,C),this.rightArmPivot.add(M),this.weaponModels.Pistol=M;const P=new T,L=new w(new S(.08,.08,.9),new x({color:1710618,metalness:.8,roughness:.3}));L.position.set(0,-.28,.45);const H=new w(new S(.12,.14,.4),new x({color:2894892}));H.position.set(0,-.3,.2);const le=new w(new S(.1,.22,.12),new x({color:2894892}));le.position.set(0,-.44,.15);const se=new w(new S(.1,.12,.25),new x({color:3815994}));se.position.set(0,-.28,-.1);const J=new w(new S(.08,.25,.1),new x({color:1710618}));J.position.set(0,-.5,.2),P.add(L,H,le,se,J),this.rightArmPivot.add(P),this.weaponModels.Rifle=P;const X=new T,Z=new w(new S(.08,.08,1.3),new x({color:1727514,metalness:.6,roughness:.4}));Z.position.set(0,-.28,.65);const Q=new w(new S(.14,.16,.5),new x({color:2969622}));Q.position.set(0,-.3,.25);const Y=new w(new K(.06,.06,.35,8),new x({color:657930,metalness:.9,roughness:.1}));Y.rotation.z=Math.PI/2,Y.position.set(0,-.18,.4);const N=new w(new K(.05,.05,.02,8),new x({color:1723791,metalness:.9,roughness:.1,emissive:663616}));N.rotation.z=Math.PI/2,N.position.set(0,-.18,.58);const ae=new w(new S(.12,.14,.3),new x({color:3811866}));ae.position.set(0,-.28,-.05);const ee=new w(new S(.02,.15,.02),new x({color:1710618}));ee.position.set(0,-.42,.5),X.add(Z,Q,Y,N,ae,ee),this.rightArmPivot.add(X),this.weaponModels.Sniper=X,Object.values(this.weaponModels).forEach(z=>z.visible=!1);const V=P.clone();V.traverse(z=>{z.material&&z.material.color&&z.material.color.setHex(5598095)}),V.scale.set(.8,.8,.8),this.rightArmPivot.add(V),this.weaponModels.SMG=V;const G=P.clone();G.traverse(z=>{z.material&&z.material.color&&z.material.color.setHex(9132587)}),G.scale.set(1.1,1,.8),this.rightArmPivot.add(G),this.weaponModels.Shotgun=G;const U=P.clone();U.traverse(z=>{z.material&&z.material.color&&z.material.color.setHex(3050327)}),U.scale.set(.95,.95,1),this.rightArmPivot.add(U),this.weaponModels.DMR=U;const oe=new S(this.blockSize,this.blockSize,this.blockSize),ne=new x({color:3066993,transparent:!0,opacity:.35,wireframe:!0});this.previewBlock=new w(oe,ne),this.previewBlock.visible=this.gameMode==="studio",this.previewBlock.castShadow=!1,this.previewBlock.receiveShadow=!1,this.scene.add(this.previewBlock);const te=new S(.25,.8,.25);te.translate(0,-.4,0),this.leftLegPivot=new T,this.leftLegPivot.name="leftLegPivot",this.leftLegPivot.position.set(-.15,.7,0),this.mesh.add(this.leftLegPivot);const ce=new w(te,s);this.leftLegPivot.add(ce),this.rightLegPivot=new T,this.rightLegPivot.name="rightLegPivot",this.rightLegPivot.position.set(.15,.7,0),this.mesh.add(this.rightLegPivot);const $=new w(te,s);if(this.rightLegPivot.add($),this.isAiming=!1,this.baseFov=75,this.aimFov=20,this.hitTimer=0,this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.animTime=0,this.isPunching=!1,this.punchSide=0,this.isBlocking=!1,this.yaw=0,this.pitch=0,this.camera){const z=new Ue().setFromQuaternion(this.camera.quaternion,"YXZ");this.yaw=z.y,this.pitch=z.x}}rotateCamera(e,t){if(!this.controls||!this.controls.isLocked){this.yaw-=e,this.pitch-=t;const i=Math.PI/2-.01;this.pitch=Math.max(-i,Math.min(i,this.pitch)),this.camera.rotation.set(this.pitch,this.yaw,0,"YXZ")}}initControls(){const e=o=>{if(this.gameMode==="studio"&&this.studioSelected)switch(o.code){case"ArrowUp":o.shiftKey?this.moveSelectedObject(0,0,1.5):this.moveSelectedObject(0,-2),o.preventDefault();return;case"ArrowDown":o.shiftKey?this.moveSelectedObject(0,0,-1.5):this.moveSelectedObject(0,2),o.preventDefault();return;case"ArrowLeft":this.moveSelectedObject(-2,0),o.preventDefault();return;case"ArrowRight":this.moveSelectedObject(2,0),o.preventDefault();return;case"KeyX":this.removeSelectedObject(),o.preventDefault();return}switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"Space":this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"Digit1":this.switchWeapon(0);break;case"Digit2":this.switchWeapon(1);break;case"Digit3":this.switchWeapon(2);break;case"Digit4":this.switchWeapon(3);break;case"Digit5":this.switchWeapon(4);break;case"Digit6":this.switchWeapon(5);break;case"Numpad1":this.switchWeapon(0);break;case"Numpad2":this.switchWeapon(1);break;case"Numpad3":this.switchWeapon(2);break;case"Numpad4":this.switchWeapon(3);break;case"Numpad5":this.switchWeapon(4);break;case"Numpad6":this.switchWeapon(5);break;case"KeyB":this.gameMode==="studio"&&this.placeBlock();break;case"KeyU":if(this.gameMode==="studio"&&(this.isFloating=!this.isFloating,!this.isFloating)){const n=this.getSurfaceHeight(this.position.x,this.position.z);this.mesh.position.y=n,this.velocity.y=0}break;case"Minus":this.gameMode==="studio"&&this.adjustBlockSize(-.1);break;case"Equal":this.gameMode==="studio"&&this.adjustBlockSize(.1);break;case"KeyM":this.gameMode==="studio"&&this.moveLastBlock();break;case"KeyX":this.gameMode==="studio"&&(this.studioSelected?this.removeSelectedObject():this.selectedBlock?this.removeBlock(this.selectedBlock):this.removeLastBlock());break;case"KeyR":this.reload();break;case"KeyC":this.isCrouching=!this.isCrouching,this.isCrouching&&(this.isSprinting=!1);break;case"ShiftLeft":case"ShiftRight":this.isCrouching||(this.isSprinting=!0);break;case"Space":!this.isInVehicle&&this.canJump===!0&&(this.velocity.y+=this.jumpHeight,this.canJump=!1);break;case"KeyN":this.isInVehicle&&(this.vehicleTurbo=!0);break;case"KeyV":this.toggleCameraMode();break;case"KeyE":if(this.isInVehicle){this.exitVehicle();return}else{const n=this.findNearbyVehicle();if(n){this.enterVehicle(n);return}}break}},t=o=>{switch(o.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"ShiftLeft":case"ShiftRight":this.isSprinting=!1;break;case"Space":break;case"KeyN":this.vehicleTurbo=!1;break}},i=o=>{this.gameMode==="studio"&&(this.selectStudioObject(o)||this.selectBlockUnderCrosshair())||this.controls.isLocked&&(o.button===0?this.shoot():o.button===2&&(this.isAiming=!0))},s=o=>{o.button===2&&(this.isAiming=!1)};document.addEventListener("keydown",e),document.addEventListener("keyup",t),document.addEventListener("mousedown",i),document.addEventListener("mouseup",s),document.addEventListener("contextmenu",o=>o.preventDefault()),this._mouthRaycaster=new j,document.addEventListener("pointerdown",o=>{try{if(this.controls&&this.controls.isLocked||!this.head||!this.camera)return;const n=o.clientX/window.innerWidth*2-1,a=-(o.clientY/window.innerHeight)*2+1;this._mouthRaycaster.setFromCamera(new O(n,a),this.camera);const c=this._mouthRaycaster.intersectObject(this.head,!0);c&&c.length>0&&(o.preventDefault(),o.stopPropagation(),this.cycleMouthStyle())}catch{}})}lockControls(){if(!("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document)){console.warn("Pointer Lock API not available in this environment.");return}const t=document.getElementById("main-menu");if(!(t&&t.style.display!=="none")&&!this.isPaused)try{const i=this.controls.lock();i&&typeof i.catch=="function"&&i.catch(()=>{})}catch(i){console.warn("Unable to lock pointer:",i)}}toggleCameraMode(){this.cameraMode=this.cameraMode==="FPS"?"TPS":"FPS",this.mesh&&(this.mesh.visible=this.cameraMode==="TPS"),console.log(`Camera mode: ${this.cameraMode}`)}switchWeapon(e){if(e>=0&&e<this.weapons.length){if(this.isReloading)return;this.currentWeaponIndex=e;const t=this.weapons[e].name;Object.values(this.weaponModels).forEach(i=>i.visible=!1),this.weaponModels[t]&&(this.weaponModels[t].visible=!0)}}reload(){if(this.isReloading)return;const e=this.weapons[this.currentWeaponIndex];e.ammo!==1/0&&e.currentMag!==e.magazineSize&&(e.ammo<=0||(this.isReloading=!0,console.log("Reloading..."),this.playReloadSound(),setTimeout(()=>{this.finishReload()},e.reloadTime*1e3)))}playReloadSound(){try{if(this.audioCtx&&this.reloadBuffer){this.audioCtx.state==="suspended"&&this.audioCtx.resume();const e=this.audioCtx.createBufferSource();e.buffer=this.reloadBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume*.8,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}catch(e){console.warn("Error playing reload sound:",e)}}finishReload(){if(!this.isReloading)return;const e=this.weapons[this.currentWeaponIndex],t=e.magazineSize-e.currentMag,i=e.ammo,s=Math.min(t,i);e.currentMag+=s,e.ammo-=s,this.isReloading=!1,console.log("Reloaded!")}startBlocking(){this.weapons[this.currentWeaponIndex].name==="Fist"&&(this.isBlocking=!0)}stopBlocking(){this.isBlocking=!1}collectItem(e){if(e==="ShieldPotion"){this.shield=Math.min(100,this.shield+50);return}if(e==="MedKit"){this.health=Math.min(100,this.health+25),console.log("Used MedKit from chest: +25 HP");return}if(e&&e.startsWith("Backpack:")){const i=e.split(":")[1]||"2c3e50";return this.equipBackpack(parseInt(i,16))}const t=this.weapons.find(i=>i.name===e);if(t)t.ammo=Math.min(t.maxAmmo,t.ammo+t.magazineSize),console.log("Added ammo for "+e);else{const i=this.allWeapons.find(s=>s.name===e);i&&(this.weapons.push(i),console.log("Picked up "+e))}}setEnemyManager(e){this.enemyManager=e}setMultiplayerClient(e){this.multiplayerClient=e}shoot(){var c;if(!(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0)||this.isDead||this.isReloading||this.isBlocking)return;const t=this.weapons[this.currentWeaponIndex],i=performance.now()/1e3;if(i-t.lastShot<t.cooldown)return;if(t.currentMag<=0){this.reload();return}if(t.lastShot=i,t.ammo!==1/0&&t.currentMag--,t.name==="Fist"){this.punch();return}this.createMuzzleFlash();try{if(this.audioCtx&&this.gunshotBuffer&&this.audioCtx.state==="running"){const h=this.audioCtx.createBufferSource();h.buffer=this.gunshotBuffer,t.name==="Pistol"?h.playbackRate.value=1:t.name==="Rifle"?h.playbackRate.value=1.15:t.name==="Sniper"?h.playbackRate.value=.9:h.playbackRate.value=1;const r=this.audioCtx.createGain();r.gain.value=this.sfxVolume,h.connect(r),r.connect(this.audioCtx.destination),h.start(0)}else this.audioCtx&&this.audioCtx.state==="suspended"&&this.audioCtx.resume()}catch{}const s=new j;s.setFromCamera(new O(0,0),this.camera);const o=this.camera.position.clone();new B,s.ray.direction.clone().normalize();let n=o.clone().add(s.ray.direction.clone().multiplyScalar(1e3)),a=!1;if(this.worldObjects&&this.worldObjects.length>0){const h=s.intersectObjects(this.worldObjects,!0);h.length>0&&(n=h[0].point.clone(),a=!0)}if(this.enemyManager&&this.enemyManager.enemies){const h=s.intersectObjects(this.enemyManager.enemies.map(r=>r.mesh),!0);if(h.length>0){const r=h[0].point,l=o.distanceTo(r),m=o.distanceTo(n);if(l<m){const f=h[0].object;n=r.clone(),a=!0;let d=null;if(d=(p=>{let v=p;for(;v;){const g=this.enemyManager.enemies.find(M=>M.mesh===v);if(g)return g;v=v.parent}return null})(f),d){const p=o.distanceTo(d.position),v=t.range||1e3;if(p<=v){const g=t.damage;if(this.multiplayerClient&&this.player&&this.player.gameMode==="multiplayer"){const M=this.multiplayerClient.isHost,k=d.mesh&&d.mesh.userData?d.mesh.userData.gameId:null;k&&(M?(d.takeDamage(g),typeof this.multiplayerClient.sendZombieState=="function"&&this.multiplayerClient.sendZombieState(k,d.health)):typeof this.multiplayerClient.sendZombieHit=="function"&&this.multiplayerClient.sendZombieHit(k,g))}else d.takeDamage(t.damage)}else a=!1}}}}if(this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const h=Array.from(this.multiplayerClient.others.values()),r=s.intersectObjects(h,!0);if(r.length>0){const l=r[0].point,m=o.distanceTo(l),f=o.distanceTo(n);if(m<f){n=l.clone(),a=!0;let d=r[0].object;for(;d&&!((c=d.userData)!=null&&c.gameId)&&d.parent;)d=d.parent;const u=d&&d.userData?d.userData.gameId:null;u&&this.multiplayerClient&&typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(u,t.damage)}}}this.showTracers&&this.createBulletTracer(o,n,a),a&&t.name==="Sniper"&&this.createImpactSmoke(n)}static buildMouthMesh(e){const t=(e||"serious").toLowerCase(),i=new x({color:2824976,roughness:.6,metalness:0});let s=null;if(t==="smile"){const o=new T;o.userData={role:"playerMouth"},o.name="playerMouth";const n=i.clone(),a=new w(new S(.08,.04,.02),n),c=a.clone(),h=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,c.position.set(0,-.16,.26),h.position.set(.1,-.15,.26),h.rotation.z=.2,[a,c,h].forEach(r=>{r.userData={role:"playerMouth"},r.name="playerMouthSeg"}),o.add(a,c,h),s=o}else if(t==="angry"){const o=new x({color:5901324,roughness:.4});s=new w(new S(.26,.05,.02),o),s.position.set(0,-.16,.26),s.rotation.z=-.18,s.userData={role:"playerMouth"}}else if(t==="surprised")s=new w(new K(.06,.06,.02,20),i),s.position.set(0,-.14,.26),s.rotation.x=Math.PI/2,s.userData={role:"playerMouth"};else{if(t==="none")return null;s=new w(new S(.22,.06,.02),i),s.position.set(0,-.16,.26),s.userData={role:"playerMouth"}}return s.castShadow=!1,s.receiveShadow=!1,s.name="playerMouth",s}createMouth(e){if(!this.head)return;if(this.mouthMesh){try{this.head.remove(this.mouthMesh)}catch{}this.mouthMesh=null}const t=Pe.buildMouthMesh(e);t&&(this.head.add(t),this.mouthMesh=t)}setHatVisible(e){this.showHat=e,Array.isArray(this.hatMeshes)&&this.hatMeshes.forEach(t=>{t&&(t.visible=e)})}cycleMouthStyle(){const e=this.mouthStyle||"serious",t=this.mouthStyles.indexOf(e),i=this.mouthStyles[(t+1)%this.mouthStyles.length];this.mouthStyle=i,this.createMouth(i),this.persistSetting("mouthStyle",i);const s=document.getElementById("setting-mouth-style");s&&(s.value=i)}persistSetting(e,t){if(!(typeof window>"u"||!window.localStorage))try{const i=window.localStorage.getItem("voxel-firecraft-settings"),s=i?JSON.parse(i):{};s[e]=t,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(s))}catch{}}createMuzzleFlash(){const e=new ot(16776960,1,5),t=new B;this.camera.getWorldDirection(t),e.position.copy(this.mesh.position),e.position.y+=1.5,e.position.add(t.multiplyScalar(1)),this.scene.add(e),setTimeout(()=>this.scene.remove(e),100)}createBulletTracer(e,t,i){const s=[e,t],o=new We().setFromPoints(s),n=i?16729156:16776960,a=new nt({color:n,linewidth:2,opacity:.8,transparent:!0}),c=new at(o,a);this.scene.add(c);let h=.8;const r=setInterval(()=>{h-=.1,a.opacity=h,h<=0&&(clearInterval(r),this.scene.remove(c),o.dispose(),a.dispose())},30)}createImpactSmoke(e){const t=new T;t.position.copy(e);const i=8;for(let a=0;a<i;a++){const c=.15+Math.random()*.2,h=new Ce(c,6,6),r=new Me({color:6710886,transparent:!0,opacity:.5}),l=new w(h,r);l.position.set((Math.random()-.5)*.4,(Math.random()-.5)*.2,(Math.random()-.5)*.4),t.add(l)}this.scene.add(t);const s=600,o=performance.now(),n=()=>{const a=performance.now()-o,c=Math.max(0,1-a/s);t.children.forEach(h=>{h.material&&(h.material.opacity=c*.5)}),a<s?requestAnimationFrame(n):(t.traverse(h=>{h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()}),this.scene.remove(t))};n()}update(e){if(this.isDead)return;if(this.updateVehiclePrompt(),this.isInVehicle){this.updateVehicleDrive(e);return}if(this.controls&&this.controls.isLocked===!0||this.allowTouchMovement===!0){this.velocity.x-=this.velocity.x*10*e,this.velocity.z-=this.velocity.z*10*e,this.isFloating?this.velocity.y*=.9:this.velocity.y-=this.gravity*e,this.direction.z=Number(this.moveForward)-Number(this.moveBackward),this.direction.x=Number(this.moveRight)-Number(this.moveLeft),this.direction.normalize(),(this.moveForward||this.moveBackward)&&(this.velocity.z-=this.direction.z*this.speed*e),(this.moveLeft||this.moveRight)&&(this.velocity.x-=this.direction.x*this.speed*e);const i=new B;this.camera.getWorldDirection(i),i.y=0,i.normalize();const s=new B;s.crossVectors(i,new B(0,1,0));const o=new B;this.moveForward&&o.add(i),this.moveBackward&&o.sub(i),this.moveRight&&o.add(s),this.moveLeft&&o.sub(s),o.normalize();const n=o.length()>0;let a=1;this.isSprinting&&!this.isCrouching&&n&&this.stamina>0&&(a=2);const c=this.speed*e*.1*a,h=o.multiplyScalar(c);h.x!==0&&(this.checkCollision(new B(Math.sign(h.x),0,0),Math.abs(h.x))||(this.mesh.position.x+=h.x)),h.z!==0&&(this.checkCollision(new B(0,0,Math.sign(h.z)),Math.abs(h.z))||(this.mesh.position.z+=h.z));let r=0;if(this.isFloating){const g=new B;this.camera.getWorldDirection(g);const M=g.y;this.moveForward&&(r+=M*this.speed*e*.3),this.moveBackward&&(r-=M*this.speed*e*.3)}if(this.mesh.position.y+=this.velocity.y*e+r,o.length()>0){const g=Math.atan2(o.x,o.z);this.mesh.rotation.y=g}if(this.mesh.position.y+=this.velocity.y*e,!this.isFloating&&!this.isFloating){this.mesh.position.y<0&&(this.velocity.y=0,this.mesh.position.y=0,this.canJump=!0);const g=this.getSurfaceHeight(this.mesh.position.x,this.mesh.position.z);this.mesh.position.y<g&&(this.mesh.position.y=g,this.velocity.y=0,this.canJump=!0)}const l=!this.isFloating&&(this.canJump||this.mesh.position.y<=.01);if(this.handleFootsteps(n&&l&&!this.isDead),this.gameMode==="studio"?this.updateBlockPreview():this.previewBlock&&(this.previewBlock.visible=!1),this.world&&typeof this.world.halfMapSize=="number"){const g=this.world.halfMapSize-1;this.mesh.position.x=Math.max(-g,Math.min(g,this.mesh.position.x)),this.mesh.position.z=Math.max(-g,Math.min(g,this.mesh.position.z))}if(this.separateFromRemotePlayers(),this.previousPosition.length()>0){const g=this.mesh.position.distanceTo(this.previousPosition);this.distanceTraveled+=g,e>0&&(this.currentSpeed=g/e)}if(this.previousPosition.copy(this.mesh.position),this.gameMode==="studio"||this.gameMode==="matrix-ai")this.stamina=100;else if(this.isSprinting&&!this.isCrouching&&n&&this.stamina>0){const g=20*e;this.stamina=Math.max(0,this.stamina-g),this.stamina<=0&&(this.isSprinting=!1)}else{const g=10*e;this.stamina=Math.min(100,this.stamina+g)}this.camera.position.copy(this.mesh.position);const f=this.isCrouching?1.6*this.crouchHeight:1.6;this.camera.position.y+=f;const d=this.isCrouching?this.crouchHeight:1;this.mesh.scale.y+=(d-this.mesh.scale.y)*10*e;let u=this.baseFov;const p=this.weapons[this.currentWeaponIndex];this.isAiming&&p&&p.zoomFov&&(u=p.zoomFov),Math.abs(this.camera.fov-u)>.1&&(this.camera.fov+=(u-this.camera.fov)*10*e,this.camera.updateProjectionMatrix());let v;this.cameraMode==="FPS"?v=this.fpsCameraOffset.clone():(v=this.tpsCameraOffset.clone(),v.applyQuaternion(this.camera.quaternion)),v.add(this.mesh.position),this.camera.position.copy(v),this.updateAnimations(e)}}findNearbyVehicle(){if(!this.worldObjects)return null;let e=null,t=4;return this.worldObjects.forEach(i=>{if(!i||!i.userData||i.userData.type!=="vehicle")return;const s=i.position.distanceTo(this.mesh.position);s<t&&(e=i,t=s)}),e}updateVehiclePrompt(){const e=this.vehiclePromptEl;if(!e)return;if(this.isInVehicle){e.innerText="Press E to exit vehicle",e.dataset.vehiclePrompt="1",e.classList.remove("hidden");return}const t=this.findNearbyVehicle();this.nearVehicle=t,t?(e.innerText="Press E to drive vehicle",e.dataset.vehiclePrompt="1",e.classList.remove("hidden")):e.dataset.vehiclePrompt==="1"&&(e.classList.add("hidden"),delete e.dataset.vehiclePrompt)}enterVehicle(e){if(!e||this.isInVehicle)return!1;e.userData||(e.userData={}),e.userData.hasFrontAligned||(e.rotation.y+=Math.PI,e.userData.hasFrontAligned=!0);const t=this.loadVehicleState(e);this.isInVehicle=!0,this.vehicleAccelHold=0,this.isSprinting=!1,this.vehicleTurbo=!1,this.currentVehicle=e,this.vehicleSpeed=0,this.currentSpeed=0;const i=e.userData&&e.userData.vehicleType||"car";return this.vehicleFuelCapacity=t?t.capacity:i==="truck"?60:40,this.vehicleFuel=t?t.fuel:this.vehicleFuelCapacity,this.vehicleDistance=t?t.distanceKm:0,this._vehicleFuelDistAccum=0,this.vehicleFuelUsed=t?t.fuelUsed:0,this.vehicleEfficiencyKmPerL=i==="truck"?3.5:5.5,this.vehicleIdleLph=i==="truck"?1:.7,this.vehicleThrottleLph=i==="truck"?2.8:1.9,this._vehicleMaxSpeed=i==="truck"?80/3.6:null,this._vehicleTurboMaxSpeed=i==="truck"?100/3.6:null,this._vehicleStateCache=t||null,this.previousPosition.copy(e.position),this.stopFootsteps(),this.stopVehicleDriveSound(),this.playVehicleDoor(),this.mesh.visible=!1,this.velocity.set(0,0,0),this.mesh.position.copy(e.position),this.updateVehicleHUD(!0),!0}exitVehicle(){if(!this.currentVehicle){this.isInVehicle=!1;return}const e=this.currentVehicle;if(this.playVehicleDoor(),this.stopVehicleDriveSound(),this.stopFootsteps(),this.world&&typeof this.world.getHeightAt=="function"){const o=this.world.getHeightAt(e.position.x,e.position.z),n=this.getVehicleGroundClearance(e);e.position.y=o+n}const t=new B(-1.5,0,-2).applyEuler(e.rotation),i=e.position.clone().add(t);this.mesh.position.copy(i);const s=typeof this.getSurfaceHeight=="function"?this.getSurfaceHeight(i.x,i.z):this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(i.x,i.z):i.y;this.mesh.position.y=s,this.velocity.set(0,0,0),this.mesh.visible=!0,this.isInVehicle=!1,this.currentVehicle=null,this.vehicleSpeed=0,this.canJump=!0,this.previousPosition.copy(this.mesh.position),this.saveVehicleState(e),this.updateVehicleHUD(!1),this.vehiclePromptEl&&this.vehiclePromptEl.dataset.vehiclePrompt==="1"&&(this.vehiclePromptEl.classList.add("hidden"),delete this.vehiclePromptEl.dataset.vehiclePrompt)}getVehicleGroundClearance(e){if(!e)return .05;const t=e.userData||{};return typeof t.groundClearance=="number"?t.groundClearance:typeof t.wheelRadius=="number"&&typeof t.wheelCenterY=="number"?Math.max(0,t.wheelRadius-t.wheelCenterY):.05}updateVehicleDrive(e){const t=this.currentVehicle;if(!t){this.isInVehicle=!1;return}this.stopFootsteps();const i=t.position.clone();if(this.vehicleFuel<=0){this.vehicleSpeed=0,this.mesh.position.copy(t.position),this.previousPosition.copy(t.position),this.currentSpeed=0,this.updateVehicleHUD(!0);return}let s=0;this.moveForward&&(s+=1),this.moveBackward&&(s-=1),this.vehicleSpeed+=s*this.vehicleAccel*e,this.moveForward&&s>0?this.vehicleAccelHold=Math.min(1,this.vehicleAccelHold+e*.8):this.vehicleAccelHold=Math.max(0,this.vehicleAccelHold-e*.6);const o=this.vehicleTurbo&&s>0,n=o?vType==="truck"?1.25:1.6:1,a=o?vType==="truck"?1.15:1.35:1,c=(this.vehicleBaseMaxSpeed+this.vehicleBoostMax*this.vehicleAccelHold)*n,h=this.vehicleBaseMaxSpeed*.5;this.vehicleSpeed=Math.min(c,Math.max(-h,this.vehicleSpeed)),this.vehicleSpeed+=s*this.vehicleAccel*e*(a-1),this.vehicleSpeed*=Math.max(0,1-this.vehicleFriction*e),this._vehicleMaxSpeed&&!o?this.vehicleSpeed=Math.min(this._vehicleMaxSpeed,this.vehicleSpeed):this._vehicleTurboMaxSpeed&&o&&(this.vehicleSpeed=Math.min(this._vehicleTurboMaxSpeed,this.vehicleSpeed)),this.currentSpeed=Math.abs(this.vehicleSpeed);const r=s>0,l=this.vehicleSpeed>=0?1:-1;this.moveLeft&&(t.rotation.y+=this.vehicleTurnSpeed*e*l),this.moveRight&&(t.rotation.y-=this.vehicleTurnSpeed*e*l);const m=new B(0,0,1).applyEuler(t.rotation),f=t.position.clone().addScaledVector(m,this.vehicleSpeed*e);if(this.checkVehicleCollision(f,t)?this.vehicleSpeed*=.2:t.position.copy(f),this.world&&typeof this.world.getHeightAt=="function"){const k=this.world.getHeightAt(t.position.x,t.position.z),b=this.getVehicleGroundClearance(t);t.position.y=k+b}if(this.world&&typeof this.world.halfMapSize=="number"){const k=this.world.halfMapSize-1;t.position.x=Math.max(-k,Math.min(k,t.position.x)),t.position.z=Math.max(-k,Math.min(k,t.position.z))}if(this.previousPosition.length()>0){const k=t.position.distanceTo(this.previousPosition);this.distanceTraveled+=k}this.mesh.position.copy(t.position),this.previousPosition.copy(t.position);const d=t.position.distanceTo(i);this.rotateVehicleWheels(t,d,this.vehicleSpeed);let u=0;if(u+=this.vehicleIdleLph/3600*e,r&&(u+=this.vehicleThrottleLph/3600*e*(o?1.7:1)),d>0){const k=d/1e3;this.vehicleDistance+=k;const b=k/this.vehicleEfficiencyKmPerL,D=r?b*.35*(o?1.35:1):0;u+=b+D}if(this.vehicleFuelUsed+=u,this.vehicleFuel=Math.max(0,this.vehicleFuel-u),this.vehicleFuel<=0&&(this.vehicleSpeed=0),this.saveVehicleState(t),this.updateVehicleHUD(!0),this.enemyManager&&Array.isArray(this.enemyManager.enemies)){const k=performance.now();this.enemyManager.enemies.forEach(b=>{if(!b||!b.position)return;if(b.position.distanceTo(t.position)<2.4){b.userData||(b.userData={});const C=b.userData.lastRunOver||0;if(k-C>400){b.userData.lastRunOver=k;try{b.takeDamage(999)}catch{}}}})}const p=t.position.clone(),v=new B(0,2,6).applyQuaternion(this.camera.quaternion),g=p.clone().add(v);this.camera.position.lerp(g,.18);const M=Math.abs(this.vehicleSpeed)>.5;this.handleVehicleDriveSound(M)}rotateVehicleWheels(e,t,i){if(!e||!e.userData||!e.userData.wheels||!e.userData.wheels.length)return;const s=e.userData.wheelRadius||.35,o=t/s,n=i>=0?-1:1;e.userData.wheels.forEach(a=>{try{a.rotation.x+=n*o}catch{}})}updateVehicleHUD(e){if(!this.vehicleHud||!this.vehicleHud.root)return;const t=this.vehicleHud.root,i=document.getElementById("dashboard");if(i){const o=i.getBoundingClientRect();t.style.left=`${o.left}px`,t.style.top=`${o.top+o.height+8}px`,t.style.width=`${o.width}px`}if(!e){t.classList.add("hidden");return}t.classList.remove("hidden");const s=Math.abs(this.vehicleSpeed)*3.6;if(this.vehicleHud.speed&&(this.vehicleHud.speed.innerText=s.toFixed(0)),this.vehicleHud.fuelFill){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelFill.style.width=`${n}%`,this.vehicleHud.fuelFill.style.background=n<20?"linear-gradient(90deg, #ff7043, #ff3d00)":"linear-gradient(90deg, #8bc34a, #cddc39)"}if(this.vehicleHud.fuelText){const o=this.vehicleFuelCapacity||1,n=Math.max(0,Math.min(100,this.vehicleFuel/o*100));this.vehicleHud.fuelText.innerText=`${this.vehicleFuel.toFixed(1)}L (${n.toFixed(1)}%)`}if(this.vehicleHud.distance&&(this.vehicleHud.distance.innerText=this.vehicleDistance.toFixed(2)),this.vehicleHud.efficiency){const o=this.vehicleFuelUsed>0&&this.vehicleDistance>0?this.vehicleDistance/this.vehicleFuelUsed:0;this.vehicleHud.efficiency.innerText=o.toFixed(2)}if(this.vehicleHud.range){const o=this.vehicleFuel*this.vehicleEfficiencyKmPerL;this.vehicleHud.range.innerText=o.toFixed(1)}}getVehicleStorageKey(e){return!e||!e.userData||!e.userData.gameId?null:`vehicle-state-${e.userData.gameId}`}loadVehicleState(e){try{if(e&&e.userData&&e.userData.vehicleState)return e.userData.vehicleState;const t=this.getVehicleStorageKey(e);if(!t||typeof localStorage>"u")return null;const i=localStorage.getItem(t);if(!i)return null;const s=JSON.parse(i);return e.userData.vehicleState=s,s}catch{return null}}saveVehicleState(e){if(!e)return;const t=this.getVehicleStorageKey(e);if(!t)return;const i={fuel:this.vehicleFuel,capacity:this.vehicleFuelCapacity,distanceKm:this.vehicleDistance,fuelUsed:this.vehicleFuelUsed,vehicleType:e.userData&&e.userData.vehicleType||"car"};e.userData.vehicleState=i;try{typeof localStorage<"u"&&localStorage.setItem(t,JSON.stringify(i))}catch{}}selectStudioObject(e){if(this.gameMode!=="studio"||!this.worldObjects||this.worldObjects.length===0)return null;const t=new O;this.controls&&this.controls.isLocked?t.set(0,0):e&&e.clientX!==void 0?(t.x=e.clientX/window.innerWidth*2-1,t.y=-(e.clientY/window.innerHeight)*2+1):t.set(0,0),this._studioRaycaster.setFromCamera(t,this.camera);const i=this.worldObjects.filter(n=>n&&n.userData&&n.userData.gameName!=="Ground"),s=this._studioRaycaster.intersectObjects(i,!0);if(!s.length)return this.clearStudioSelection(),null;let o=s[0].object;for(;o&&!this.worldObjects.includes(o);)o=o.parent;return o&&this.setStudioSelection(o),o}moveSelectedObject(e,t,i=0){if(!this.studioSelected)return;const s=this.studioSelected;s.position.x+=e,s.position.z+=t,s.position.y+=i,i===0&&this.world&&typeof this.world.getHeightAt=="function"&&(s.position.y=this.world.getHeightAt(s.position.x,s.position.z)),this.refreshStudioSelectionHelper()}clearStudioSelection(){if(this.studioSelected=null,this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}this.selectionInfo&&this.selectionInfo.classList.add("hidden")}removeSelectedObject(){if(!this.studioSelected)return;const e=this.studioSelected;this.clearStudioSelection();try{this.scene.remove(e)}catch{}if(this.worldObjects){const t=this.worldObjects.indexOf(e);t>=0&&this.worldObjects.splice(t,1)}}setStudioSelection(e){if(this.studioSelected=e,this.selectionInfo)if(e&&e.userData){const t=e.userData;this.selectionInfo.innerText=`${t.gameName||"Object"} (${t.gameId||"---"})`,this.selectionInfo.classList.remove("hidden")}else this.selectionInfo.classList.add("hidden");this.refreshStudioSelectionHelper()}refreshStudioSelectionHelper(){if(this.studioSelectionHelper){try{this.scene.remove(this.studioSelectionHelper)}catch{}this.studioSelectionHelper=null}if(this.studioSelected)try{const e=this.buildStudioSelectionBox(this.studioSelected);console.log("[DEBUG BOX] Creating Box3Helper with box:",e),this.studioSelectionHelper=new rt(e,16766720),this.studioSelectionHelper.material.depthTest=!1,this.studioSelectionHelper.material.transparent=!0,this.studioSelectionHelper.material.opacity=.9,this.scene.add(this.studioSelectionHelper),console.log("[DEBUG BOX] Box3Helper added to scene successfully")}catch(e){console.error("[DEBUG BOX] ERROR creating Box3Helper:",e),this.studioSelectionHelper=null}}buildStudioSelectionBox(e){var o,n;console.log("[DEBUG BOX] Building box for:",(o=e.userData)==null?void 0:o.gameName,"isNPC:",(n=e.userData)==null?void 0:n.isNPC);const t=new Ge;let i=0,s=0;return e.traverse(a=>{if(!a.isMesh||!a.geometry)return;i++;const c=a.userData||{},h=a.material;if(h&&h.transparent||c.isShadow||c.shadow){console.log("[DEBUG BOX] Skipping mesh (transparent or shadow):",a.name||"unnamed"),s++;return}if(!a.geometry.boundingBox)try{a.geometry.computeBoundingBox()}catch{}if(a.geometry.boundingBox){const l=a.geometry.boundingBox.clone();a.updateWorldMatrix(!0,!1),l.applyMatrix4(a.matrixWorld),t.union(l),console.log("[DEBUG BOX] Added mesh to box")}}),console.log("[DEBUG BOX] Processed:",i,"meshes, skipped:",s,"isEmpty:",t.isEmpty()),t.isEmpty()&&(console.log("[DEBUG BOX] Box is empty! Using fallback 1x1x1 box"),t.setFromCenterAndSize(e.position,new B(1,1,1))),t}checkVehicleCollision(e,t=null){if(!this.worldObjects)return!1;const i=2;for(let s=0;s<this.worldObjects.length;s++){const o=this.worldObjects[s];if(!o)continue;const n=o.userData||{};if(t&&o===t||n.gameName==="Ground"||n.type==="ground")continue;const a=o.position||(o.getWorldPosition?o.getWorldPosition(new B):null);if(!a)continue;const c=a.distanceTo(e);let h=1.5;if(o.geometry&&o.geometry.boundingSphere?h=o.geometry.boundingSphere.radius||h:n&&n.size==="large"?h=5:n.type==="vehicle"&&(h=2.5),c<i+h)return!0}return!1}updateAnimations(e){const t=this.moveForward||this.moveBackward||this.moveLeft||this.moveRight,i=10,s=this.isSprinting&&t?1.8:1;if(t){this.animTime+=e*i*s;const o=Math.sin(this.animTime)*(.5*s);this.leftLegPivot.rotation.x=o,this.rightLegPivot.rotation.x=-o}else this.leftLegPivot.rotation.x=F.lerp(this.leftLegPivot.rotation.x,0,e*i),this.rightLegPivot.rotation.x=F.lerp(this.rightLegPivot.rotation.x,0,e*i);if(this.isBlocking){const o=-Math.PI/2.5,n=.5;this.leftArmPivot.rotation.x=F.lerp(this.leftArmPivot.rotation.x,o,e*15),this.rightArmPivot.rotation.x=F.lerp(this.rightArmPivot.rotation.x,o,e*15),this.leftArmPivot.rotation.z=F.lerp(this.leftArmPivot.rotation.z,-n,e*15),this.rightArmPivot.rotation.z=F.lerp(this.rightArmPivot.rotation.z,n,e*15)}else if(this.isPunching){this.punchTime+=e*20;const o=-Math.PI/2+Math.sin(this.punchTime)*.8;this.punchSide===0?(this.rightArmPivot.rotation.x=o,this.leftArmPivot.rotation.x=F.lerp(this.leftArmPivot.rotation.x,0,e*10)):(this.leftArmPivot.rotation.x=o,this.rightArmPivot.rotation.x=F.lerp(this.rightArmPivot.rotation.x,0,e*10)),this.punchTime>Math.PI&&(this.isPunching=!1,this.rightArmPivot.rotation.x=0,this.leftArmPivot.rotation.x=0),this.leftArmPivot.rotation.z=F.lerp(this.leftArmPivot.rotation.z,0,e*10),this.rightArmPivot.rotation.z=F.lerp(this.rightArmPivot.rotation.z,0,e*10)}else{if(t){const o=Math.sin(this.animTime)*.5*s;this.leftArmPivot.rotation.x=-o,this.rightArmPivot.rotation.x=o}else this.leftArmPivot.rotation.x=F.lerp(this.leftArmPivot.rotation.x,0,e*10),this.rightArmPivot.rotation.x=F.lerp(this.rightArmPivot.rotation.x,0,e*10);this.leftArmPivot.rotation.z=F.lerp(this.leftArmPivot.rotation.z,0,e*10),this.rightArmPivot.rotation.z=F.lerp(this.rightArmPivot.rotation.z,0,e*10)}if(this.hitTimer>0){this.hitTimer-=e;const o=Math.max(0,this.hitTimer)/.6,n=F.lerp(-Math.PI/2.2,0,1-o);this.leftArmPivot.rotation.x=F.lerp(this.leftArmPivot.rotation.x,n,e*20),this.rightArmPivot.rotation.x=F.lerp(this.rightArmPivot.rotation.x,n,e*20)}}punch(){if(!this.isTired&&!(this.isPunching||this.isBlocking)&&(this.isPunching=!0,this.punchTime=0,this.punchSide=this.punchSide===0?1:0,this.punchCount++,this.punchCount>=20&&(this.isTired=!0,this.stamina=Math.max(0,this.stamina-20),setTimeout(()=>{this.isTired=!1,this.punchCount=0},3e3)),this.enemyManager&&this.enemyManager.enemies)){const e=new B;this.mesh.getWorldDirection(e);let t=!1;if(this.enemyManager.enemies.forEach(i=>{if(this.mesh.position.distanceTo(i.position)<3){const o=new B().subVectors(i.position,this.mesh.position).normalize();if(e.angleTo(o)<Math.PI/3){i.takeDamage(10);const a=e.clone().multiplyScalar(2);i.position.add(a),t=!0}}}),this.gameMode==="multiplayer"&&this.multiplayerClient&&this.multiplayerClient.others&&this.multiplayerClient.others.size>0){const i=Math.PI/3,s=3;this.multiplayerClient.others.forEach((o,n)=>{if(!o||!o.position||o.userData&&o.userData.dead||this.mesh.position.distanceTo(o.position)>s)return;const c=new B().subVectors(o.position,this.mesh.position).normalize();e.angleTo(c)<i&&(typeof this.multiplayerClient.sendHit=="function"&&this.multiplayerClient.sendHit(n,10),t=!0)})}t&&this.playSmack()}}playSmack(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playSmack());return}if(this.smackBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.smackBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playSmack error:",e)}}equipBackpack(e=2899536){const t=this.backpackColor;this.backpack&&this.backpack.parent&&this.backpack.parent.remove(this.backpack);const i=new T;i.position.set(0,1.25,-.32);const s=new w(new S(.7,.9,.35),new x({color:e,metalness:.15,roughness:.8}));s.position.set(0,0,0),i.add(s);const o=new w(new S(.6,.25,.16),new x({color:3426654,metalness:.1,roughness:.8}));o.position.set(0,-.55,.22),i.add(o);const n=new x({color:2042938,metalness:.1,roughness:.9}),a=new w(new S(.1,.82,.07),n);a.position.set(-.28,-.03,.2);const c=a.clone();return c.position.x=.28,i.add(a,c),this.mesh.add(i),this.backpack=i,this.backpackColor=e,t}queueHurtBeat(){if(this._hurtAccumulator+=1,this._hurtAccumulator>=2){const e=Math.floor(this._hurtAccumulator/2);this._hurtQueue+=e,this._hurtAccumulator-=e*2}this._hurtQueue===0&&this._hurtAccumulator>0&&(this._hurtQueue=1,this._hurtAccumulator=0),this._hurtBeatTimer||this._playHurtBeatLoop()}_playHurtBeatLoop(){if(this._hurtQueue<=0){this._hurtBeatTimer=null;return}this.playHurt(),this._hurtQueue=Math.max(0,this._hurtQueue-1),this._hurtBeatTimer=setTimeout(()=>this._playHurtBeatLoop(),2e3)}clearHurtQueue(){this._hurtAccumulator=0,this._hurtQueue=0,this._hurtBeatTimer&&(clearTimeout(this._hurtBeatTimer),this._hurtBeatTimer=null)}playHurt(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playHurt());return}if(this.ughBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.ughBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playHurt error:",e)}}playVehicleDoor(){try{if(this.audioCtx){if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playVehicleDoor());return}if(this.vehicleDoorBuffer){const e=this.audioCtx.createBufferSource();e.buffer=this.vehicleDoorBuffer;const t=this.audioCtx.createGain();t.gain.value=this.sfxVolume,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}}}catch(e){console.warn("playVehicleDoor error:",e)}}handleVehicleDriveSound(e){try{if(!this.audioCtx||!this.enableVehicleDriveSound){this.stopVehicleDriveSound();return}if(!this.vehicleDriveBuffer){this.stopVehicleDriveSound();return}if(e===this._lastVehicleDriveActive&&(e&&this._vehicleDriveSource||!e&&!this._vehicleDriveSource))return;if(this._lastVehicleDriveActive=e,e){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._vehicleDriveSource)return;const t=this.audioCtx.createBufferSource();t.buffer=this.vehicleDriveBuffer,t.loop=!0;const i=this.audioCtx.createGain();i.gain.value=this.sfxVolume*.4,t.connect(i),i.connect(this.audioCtx.destination),t.start(0),this._vehicleDriveSource=t,this._vehicleDriveGain=i,t.onended=()=>{this._vehicleDriveSource=null,this._vehicleDriveGain=null}}else this.stopVehicleDriveSound()}catch(t){console.warn("handleVehicleDriveSound error:",t)}}stopVehicleDriveSound(){if(this._lastVehicleDriveActive=!1,this._vehicleDriveSource){try{this._vehicleDriveSource.stop()}catch{}try{this._vehicleDriveSource.disconnect()}catch{}}if(this._vehicleDriveGain)try{this._vehicleDriveGain.disconnect()}catch{}this._vehicleDriveSource=null,this._vehicleDriveGain=null}handleFootsteps(e){try{if(this.isInVehicle){this.stopFootsteps();return}if(!this.audioCtx||!this.footstepsBuffer){this.stopFootsteps();return}if(e===this._lastFootstepsActive&&(e&&this._footstepsSource||!e&&!this._footstepsSource)){if(e&&this._footstepsSource){const t=this.isSprinting?1.4:this.isCrouching?.8:1;this._footstepsSource.playbackRate.value=t}return}if(this._lastFootstepsActive=e,e){if(this.audioCtx.state==="suspended"&&this.audioCtx.resume(),this._footstepsSource){try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}const t=this.audioCtx.createBufferSource();t.buffer=this.footstepsBuffer,t.loop=!0,t.playbackRate.value=this.isSprinting?1.4:this.isCrouching?.8:1;const i=this.audioCtx.createGain();i.gain.value=this.sfxVolume*.35,t.connect(i),i.connect(this.audioCtx.destination),t.start(0),this._footstepsSource=t,this._footstepsGain=i,t.onended=()=>{this._footstepsSource=null,this._footstepsGain=null}}else this.stopFootsteps()}catch(t){console.warn("handleFootsteps error:",t)}}stopFootsteps(){if(this._lastFootstepsActive=!1,this._footstepsSource){try{this._footstepsSource.onended=null}catch{}try{this._footstepsSource.stop()}catch{}try{this._footstepsSource.disconnect()}catch{}}if(this._footstepsGain)try{this._footstepsGain.disconnect()}catch{}this._footstepsSource=null,this._footstepsGain=null}get position(){return this.mesh.position}getSurfaceHeight(e,t){let i=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(e,t):0;return(this.world&&this.world.objects?this.world.objects:[]).forEach(o=>{if(!(!o||!o.userData)){if(o.userData.type==="block"){const n=o.userData.size||this.blockSize;if(Math.abs(o.position.x-e)<n*.6&&Math.abs(o.position.z-t)<n*.6){const a=o.position.y+n/2;a>i&&(i=a)}}if(o.userData.colliderBox){const n=o.userData.colliderBox;e>=n.min.x&&e<=n.max.x&&t>=n.min.z&&t<=n.max.z&&n.max.y>i&&(i=n.max.y)}}}),i}adjustBlockSize(e){const t=Math.max(this.minBlockSize,Math.min(this.maxBlockSize,this.blockSize+e));this.blockSize=t,console.log("Block size:",this.blockSize.toFixed(2))}moveLastBlock(){if(!this.placedBlocks.length)return;const e=this.placedBlocks[this.placedBlocks.length-1];if(!e)return;const t=this.getBlockTarget(e);e.position.set(t.position.x,t.position.y,t.position.z)}getBlockTarget(e=null){const t=e&&e.userData&&e.userData.size?e.userData.size:this.blockSize,i=new j;i.setFromCamera(new O(0,0),this.camera);const s=l=>Math.round(l);let o=null;if(this.world&&Array.isArray(this.world.objects)){const l=this.world.objects.filter(f=>f&&f.userData&&(f.userData.type==="block"||f.userData.gameName==="Ground")),m=i.intersectObjects(l,!0);m.length>0&&(o=m[0].point.clone())}if(!o){const l=new B;this.camera.getWorldDirection(l),o=this.mesh.position.clone().add(l.multiplyScalar(1.2))}const n=new B(s(o.x),o.y,s(o.z));if(this.world&&typeof this.world.halfMapSize=="number"){const l=this.world.halfMapSize-1;n.x=Math.max(-l,Math.min(l,n.x)),n.z=Math.max(-l,Math.min(l,n.z))}let a=this.world.getHeightAt?this.world.getHeightAt(n.x,n.z):o.y;const h=(this.world.objects||[]).filter(l=>l.userData&&l.userData.type==="block"&&l!==e).filter(l=>Math.abs(l.position.x-n.x)<.1&&Math.abs(l.position.z-n.z)<.1);h.length>0&&(a=Math.max(...h.map(m=>m.position.y+(m.userData&&m.userData.size?m.userData.size/2:t/2))));const r=a+t/2;return{position:new B(n.x,r,n.z),size:t}}updateBlockPreview(){if(!this.previewBlock)return;const e=this.getBlockTarget();this.previewBlock.visible=!0,this.previewBlock.position.copy(e.position);const t=e.size/this.blockSize;this.previewBlock.scale.set(t,t,t)}removeLastBlock(){if(!this.placedBlocks.length)return;const e=this.placedBlocks.pop();e&&e.parent&&e.parent.remove(e),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(t=>t!==e)),e&&e.geometry&&e.geometry.dispose(),e&&e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),this.selectedBlock===e&&this.clearBlockSelection()}selectBlockUnderCrosshair(){if(!this.world||!this.world.objects)return!1;const e=new j;e.setFromCamera(new O(0,0),this.camera);const t=e.intersectObjects(this.world.objects,!0);if(t.length===0)return this.clearBlockSelection(),!1;let i=null;for(const s of t){let o=s.object;for(;o&&o.parent;){if(o.userData&&o.userData.type==="block"){i=o;break}o=o.parent}if(i)break}return i?(this.setBlockSelection(i),!0):(this.clearBlockSelection(),!1)}setBlockSelection(e){this.clearBlockSelection(),this.selectedBlock=e;const t=new ht(e,16776960);t.userData={ignoreSelect:!0},this.scene.add(t),this.selectedBlockHelper=t}clearBlockSelection(){this.selectedBlock=null,this.selectedBlockHelper&&(this.scene.remove(this.selectedBlockHelper),this.selectedBlockHelper.material&&this.selectedBlockHelper.material.dispose(),this.selectedBlockHelper.geometry&&this.selectedBlockHelper.geometry.dispose(),this.selectedBlockHelper=null)}removeBlock(e){e&&(this.placedBlocks=this.placedBlocks.filter(t=>t!==e),e.parent&&e.parent.remove(e),this.world&&this.world.objects&&(this.world.objects=this.world.objects.filter(t=>t!==e)),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose()),this.selectedBlock===e&&this.clearBlockSelection())}takeDamage(e){this.gameMode==="matrix"||this.gameMode==="studio"||this.multiplayerClient&&!this.multiplayerClient.isMatchLive()||(this.isBlocking&&(e*=.2,console.log("Blocked! Reduced damage to "+e)),this.shield>0?(this.shield-=e,this.shield<0&&(this.health+=this.shield,this.shield=0)):this.health-=e,e>0&&this.queueHurtBeat(),this.health<=0&&(this.health=0,this.die()),this.hitTimer=.6)}die(){this.gameMode==="matrix"||this.gameMode==="studio"||(this.handleFootsteps(!1),this.isDead=!0,this.controls.unlock(),this.mesh.rotation.x=-Math.PI/2,this.multiplayerClient&&typeof this.multiplayerClient.sendDeath=="function"&&this.multiplayerClient.sendDeath(),this.moveForward=this.moveBackward=this.moveLeft=this.moveRight=!1,this.velocity.set(0,0,0),this.hud&&typeof this.hud.showGameOver=="function"&&this.hud.showGameOver("YOU DIED"))}checkCollision(e,t){const i=new j,s=.5,o=[1.6,1,.35];let n=this.worldObjects||[];if(this.enemyManager&&this.enemyManager.enemies){const h=this.enemyManager.enemies.map(r=>r.mesh);n=n.concat(h)}const a=1.5,c=h=>{let r=h;for(;r;){if(r.userData&&r.userData.colliderBox)return r.userData.colliderBox;r=r.parent}return null};for(const h of o){const r=this.mesh.position.clone();if(r.y+=h,i.set(r,e),n.length>0){const l=i.intersectObjects(n,!0);if(l.length>0){const m=l[0];if(m.distance<t+s){const f=c(m.object);if(f){const d=f.max.y,u=d-this.mesh.position.y;if(u<=a&&u>-.5)return this.mesh.position.y=d,this.velocity.y=0,this.canJump=!0,!1}return!0}}}}return!1}}const qt="/threejs-voxel-firecraft/dist/assets/mixkit-player-losing-or-failing-vCPqUTFf.ogg",Kt="/threejs-voxel-firecraft/dist/assets/game-level-completed-envato-mixkit.co-OEgWp6-U.ogg";class Jt{constructor(e,t,i){this.player=e,this.world=t,this.settings=i||{},this.healthBar=document.getElementById("health-bar"),this.healthText=document.getElementById("health-text"),this.shieldBar=document.getElementById("shield-bar"),this.shieldText=document.getElementById("shield-text"),this.staminaBar=document.getElementById("stamina-bar"),this.staminaText=document.getElementById("stamina-text"),this.weaponName=document.getElementById("weapon-name"),this.ammoCount=document.getElementById("ammo-count"),this.slots=document.querySelectorAll(".slot"),this.timerValue=document.getElementById("timer-value"),this.debugContainer=document.getElementById("debug-container"),this.gameOverScreen=document.getElementById("game-over-screen"),this.selectionInfo=document.getElementById("selection-info"),this.selectionInfoTimeout=null,this.hotbar=document.getElementById("hotbar"),this.fpsCounter=document.getElementById("fps-counter"),this.enemyCount=document.getElementById("enemy-count"),this.killCount=document.getElementById("kill-count"),this.dropCount=document.getElementById("drop-count"),this.distanceTraveled=document.getElementById("distance-traveled"),this.playerSpeed=document.getElementById("player-speed"),this.mapSizeText=document.getElementById("map-size-readout"),this.memoryUsage=document.getElementById("memory-usage"),this.targetInspect=document.getElementById("target-inspect"),this.perfFrame=document.getElementById("perf-frame"),this.perfCalls=document.getElementById("perf-calls"),this.perfTris=document.getElementById("perf-tris"),this.perfGeoms=document.getElementById("perf-geoms"),this.perfTextures=document.getElementById("perf-textures"),this.perfPrograms=document.getElementById("perf-programs"),this.perfObjects=document.getElementById("perf-objects"),this.perfMem=document.getElementById("perf-mem"),this.perfCpu=document.getElementById("perf-cpu"),this.perfGpu=document.getElementById("perf-gpu"),this.perfGpuMem=document.getElementById("perf-gpu-mem"),this.dashboardEl=document.getElementById("dashboard"),this.perfEl=document.getElementById("perf-dashboard"),this.netStatsText=document.getElementById("net-stats"),this.netChart=document.getElementById("net-chart"),this.netChartCtx=this.netChart?this.netChart.getContext("2d"):null,this._renderer=null,this.frameTimeAvg=0,this.gpuInfo=null,this.gpuMemInfo=null,this._gl=null,this.debugInfo=document.getElementById("debug-info"),this.debugName=document.getElementById("debug-target-name"),this.debugId=document.getElementById("debug-target-id"),this.settings.debugMode?this.debugInfo.style.display="block":this.debugInfo.style.display="none",this.timeRemaining=30,this.lastTime=performance.now(),this.frames=0,this.fps=0,this.lastFpsTime=performance.now(),this.lastFrameTime=performance.now(),this.raycaster=new j,this.mouse=new O,this.hoveredEnemy=null,this.hoveredPlayer=null,this.currentOutlinedEnemy=null,this.hoverInfo=document.getElementById("hover-info"),this.scopeOverlay=document.getElementById("scope-overlay"),this.minimapContainer=document.getElementById("minimap"),this.minimapCanvas=document.getElementById("minimap-canvas"),this.minimapCtx=this.minimapCanvas?this.minimapCanvas.getContext("2d"):null,this.minimapSize=this.minimapCanvas?this.minimapCanvas.width:180,this.mapSize=t&&t.mapSize?t.mapSize:200,this.multiplayer=null,window.addEventListener("mousemove",s=>{const o=s.clientX/window.innerWidth*2-1,n=-(s.clientY/window.innerHeight)*2+1;if(this.mouse.set(o,n),this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const a=[];this.player.enemyManager.enemies.forEach(h=>{h.mesh.traverse(r=>{r.isMesh&&a.push(r)})}),this.raycaster.setFromCamera(this.mouse,this.player.camera);const c=this.raycaster.intersectObjects(a,!0);if(c.length>0){const h=c[0].object;let r=h,l=null;for(;r&&(l=this.player.enemyManager.enemies.find(m=>r.parent===m.mesh||r===m.mesh||m.mesh.children.includes(r)),!l);)r=r.parent;this.hoveredEnemy=l||h||null}else this.hoveredEnemy=null}});try{this.slots.forEach((s,o)=>{const n=a=>{try{a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),this.player&&typeof this.player.switchWeapon=="function"&&this.player.switchWeapon(o)}catch{}};s.addEventListener("pointerdown",n),s.addEventListener("touchstart",n,{passive:!1}),s.addEventListener("click",n)})}catch{}}update(){var c,h;if(this.hoveredEnemy=null,this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0&&this.currentOutlinedEnemy!==this.hoveredEnemy){if(this.currentOutlinedEnemy&&this.currentOutlinedEnemy._outline){try{this.currentOutlinedEnemy.mesh.remove(this.currentOutlinedEnemy._outline)}catch{}this.currentOutlinedEnemy._outline=null}if(this.hoveredEnemy&&this.hoveredEnemy.mesh){const r=new T;this.hoveredEnemy.mesh.traverse(l=>{if(l.isMesh){const m=new w(l.geometry,new Me({color:16776960,side:lt}));m.position.copy(l.position),m.quaternion.copy(l.quaternion),m.scale.copy(l.scale).multiplyScalar(1.06),m.renderOrder=999,m.material.depthTest=!0,r.add(m)}}),this.hoveredEnemy.mesh.add(r),this.hoveredEnemy._outline=r}this.currentOutlinedEnemy=this.hoveredEnemy}this.frames++;const e=performance.now();e-this.lastFpsTime>=1e3&&(this.fpsCounter.innerText=this.frames,this.frames=0,this.lastFpsTime=e,performance.memory&&this.memoryUsage&&(this.memoryUsage.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)));const t=e-this.lastFrameTime;if(this.lastFrameTime=e,this.frameTimeAvg=this.frameTimeAvg===0?t:this.frameTimeAvg*.9+t*.1,this.player.enemyManager&&(this.enemyCount.innerText=this.player.enemyManager.enemies.length,this.killCount.innerText=this.player.enemyManager.killedCount||0),this.dropCount){const r=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;if(r&&Array.isArray(r.items)){const l=r.items.filter(m=>!(m.userData&&m.userData.isOpened)).length;this.dropCount.innerText=l}else this.dropCount.innerText="0"}const i=(this.player.distanceTraveled/1e3).toFixed(2);if(this.distanceTraveled&&(this.distanceTraveled.innerText=i),this.playerSpeed){let r=0;this.player.isInVehicle&&typeof this.player.currentSpeed=="number"?r=this.player.currentSpeed*3.6:typeof this.player.currentSpeed=="number"&&(r=this.player.currentSpeed*3.6),this.playerSpeed.innerText=r.toFixed(1)}if(this.mapSizeText){const r=this.world&&this.world.mapSize?this.world.mapSize:this.mapSize;this.mapSizeText.innerText=Math.round(r)}if(this._renderer){if(this.isPerfCollapsed())return;const r=this._renderer.info;this.perfFrame&&(this.perfFrame.innerText=t.toFixed(1)),this.perfCalls&&(this.perfCalls.innerText=r.render.calls),this.perfTris&&(this.perfTris.innerText=r.render.triangles),this.perfGeoms&&(this.perfGeoms.innerText=r.memory.geometries),this.perfTextures&&(this.perfTextures.innerText=r.memory.textures),this.perfPrograms&&(this.perfPrograms.innerText=r.programs?r.programs.length:"0");let l=0;this.world&&Array.isArray(this.world.objects)&&(l+=this.world.objects.length);const m=typeof window<"u"&&window.game&&window.game.itemManager?window.game.itemManager:null;m&&Array.isArray(m.items)&&(l+=m.items.length),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&(l+=this.player.enemyManager.enemies.length),this.perfObjects&&(this.perfObjects.innerText=l),this.perfMem&&performance.memory&&(this.perfMem.innerText=Math.round(performance.memory.usedJSHeapSize/1048576)),this.perfCpu&&(this.perfCpu.innerText=`${this.frameTimeAvg.toFixed(1)} ms`),this.perfGpu&&(this.perfGpu.innerText=this.gpuInfo||"Unsupported"),this.updateGpuMemory()}this.updateNetPanel(),this.healthBar.style.width=`${this.player.health}%`,this.healthText.innerText=Math.ceil(this.player.health),this.shieldBar.style.width=`${this.player.shield}%`,this.shieldText.innerText=Math.ceil(this.player.shield),this.staminaBar.style.width=`${this.player.stamina}%`,this.staminaText.innerText=Math.ceil(this.player.stamina);const s=this.player.weapons[this.player.currentWeaponIndex];if(this.weaponName.innerText=s.name,this.player.isReloading?this.ammoCount.innerText="RELOADING...":this.ammoCount.innerText=s.ammo===1/0?"":`${s.currentMag} / ${s.ammo}`,this.debugContainer&&(this.debugContainer.innerHTML=""),this.debugInfo)if(this.settings.debugMode)if(this.debugInfo.style.display="block",this.hoveredEnemy){const r=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,l=r&&r.userData&&r.userData.gameName?r.userData.gameName:"Enemy",m=r&&r.userData&&(r.userData.gameId||r.userData.gameid)?r.userData.gameId||r.userData.gameid:"---",f=this.hoveredEnemy.position?this.hoveredEnemy.position:r?r.position:null,d=f?this.player.position.distanceTo(f).toFixed(2):"---";this.debugName.innerText=l,this.debugId.innerText=`${m} (${d}m)`}else this.debugName.innerText="None",this.debugId.innerText="---";else this.debugInfo.style.display="none";let o=null;if(this.hoveredPlayer=null,!this.hoveredEnemy&&this.player&&this.player.enemyManager&&this.player.enemyManager.enemies.length>0){const r=[];if(this.player.enemyManager.enemies.forEach(l=>{l.mesh.traverse(m=>{m.isMesh&&r.push(m)})}),r.length>0){this.raycaster.setFromCamera(new O(0,0),this.player.camera);const l=this.raycaster.intersectObjects(r,!0);if(l.length>0){let f=l[0].object,d=null;for(;f&&(d=this.player.enemyManager.enemies.find(u=>f.parent===u.mesh||f===u.mesh||u.mesh.children.includes(f)),!d);)f=f.parent;d?this.hoveredEnemy=d:this.hoveredEnemy=null}else this.hoveredEnemy=null}}if(!this.hoveredEnemy&&this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0){const r=[];if(this.multiplayer.others.forEach(l=>{l&&(l.isMesh?r.push(l):l.traverse&&l.traverse(m=>{m.isMesh&&r.push(m)}))}),r.length>0){this.raycaster.setFromCamera(new O(0,0),this.player.camera);const l=this.raycaster.intersectObjects(r,!0);if(l.length>0){let m=l[0].object;for(;m.parent&&!((c=m.userData)!=null&&c.nick)&&!this.multiplayer.others.has((h=m.userData)==null?void 0:h.gameId);)m=m.parent;this.hoveredPlayer=m}}}if(this.hoverInfo)if(this.hoveredEnemy){const r=this.hoveredEnemy.mesh?this.hoveredEnemy.mesh:(this.hoveredEnemy.isMesh?this.hoveredEnemy:null)||this.hoveredEnemy,l=r&&r.userData&&(r.userData.gameId||r.userData.gameid)?r.userData.gameId||r.userData.gameid:"---",m=this.hoveredEnemy.position?this.hoveredEnemy.position:r?r.position:null;o=m?this.player.position.distanceTo(m):null;const f=o?o.toFixed(2):"---";this.hoverInfo.innerText=`${l}  ${f}m`}else if(this.hoveredPlayer){const r=this.hoveredPlayer.userData&&this.hoveredPlayer.userData.nick?this.hoveredPlayer.userData.nick:"Player";let l=null;this.hoveredPlayer.getWorldPosition?(l=new B,this.hoveredPlayer.getWorldPosition(l)):l=this.hoveredPlayer.position||null,o=l?this.player.position.distanceTo(l):null;const m=o?o.toFixed(2):"---";this.hoverInfo.innerText=`${r}  ${m}m`}else this.hoverInfo.innerText="";if(this.scopeOverlay){const r=this.player.weapons&&this.player.weapons[this.player.currentWeaponIndex],l=this.player.isAiming&&r&&r.name==="Sniper";this.scopeOverlay.classList.toggle("hidden",!l);const m=document.getElementById("crosshair");m&&m.classList.toggle("hidden",l)}const n=document.getElementById("crosshair");if(n){n.classList.remove("target-red","target-yellow");const r=this.player.weapons&&this.player.weapons[this.player.currentWeaponIndex],l=r&&r.range?r.range:1e3;this.hoveredEnemy&&o!==null&&(o<=l?n.classList.add("target-red"):n.classList.add("target-yellow"))}this.updateMinimap(),this.slots.forEach(r=>r.style.display="none"),this.player.weapons.forEach((r,l)=>{let m=this.slots[l];m&&(m.style.display="flex",m.innerText=l+1,l===this.player.currentWeaponIndex?m.classList.add("active"):m.classList.remove("active"))});const a=performance.now();if(a-this.lastTime>1e3){this.timeRemaining--,this.timeRemaining<0&&(this.timeRemaining=0);const r=Math.floor(this.timeRemaining/60).toString().padStart(2,"0"),l=(this.timeRemaining%60).toString().padStart(2,"0");this.timerValue.innerText=`${r}:${l}`,this.lastTime=a}this.player.isDead&&this.player.gameMode!=="matrix"&&this.showGameOver("YOU DIED"),this.updateTargetInspect()}showSelectionInfo(e,t){if(!this.selectionInfo)return;const i=e||"Object",s=t||"---";this.selectionInfo.innerText=`${i} (${s})`,this.selectionInfo.classList.remove("hidden"),this.selectionInfoTimeout&&clearTimeout(this.selectionInfoTimeout),this.selectionInfoTimeout=setTimeout(()=>{try{this.selectionInfo.classList.add("hidden")}catch{}},2500)}updateTargetInspect(){if(!this.targetInspect||!this.player||!this.player.camera)return;const e=this.raycaster,t=new O(0,0);e.setFromCamera(t,this.player.camera);const i=[];if(this.world&&Array.isArray(this.world.objects)&&i.push(...this.world.objects),this.world&&this.world.itemManager&&Array.isArray(this.world.itemManager.items)&&i.push(...this.world.itemManager.items),this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)&&this.player.enemyManager.enemies.forEach(r=>{r&&r.mesh&&i.push(r.mesh)}),i.length===0){this.targetInspect.innerText="Target: ---";return}const s=Array.from(new Set(i)),o=e.intersectObjects(s,!0);if(!o.length){this.targetInspect.innerText="Target: ---";return}let n=null;for(let r=0;r<o.length;r++){let l=o[r].object;for(;l;){if(l.userData&&(l.userData.gameName||l.userData.type||l.userData.gameId||l.userData.gameid)){n=l.userData;break}l=l.parent}if(n)break}if(!n){this.targetInspect.innerText="Target: ---";return}const a=n.gameName||"Object",c=n.gameId||n.gameid||"---",h=n.type||"---";this.targetInspect.innerText=`Target: ${a} (ID: ${c}) [${h}]`}showGameOver(e){if(this.player&&this.player.gameMode==="matrix"||this.gameOverShown)return;this.gameOverShown=!0,this.gameOverScreen.classList.remove("hidden"),document.getElementById("game-over-title").innerText=e;try{const i=document.getElementById("touch-controls");i&&(i.style.display="none")}catch{}this.hotbar&&(this.hotbar.style.display="none");const t=document.getElementById("restart-btn");t.onclick=()=>{location.reload()},t.style.pointerEvents="auto",t.style.cursor="pointer";try{typeof window<"u"&&window.game&&e&&e.toUpperCase().includes("DIED")&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(qt)}catch{}}showVictory(){if(!(this.player&&this.player.gameMode==="matrix")){this.gameOverShown=!1,this.showGameOver("VICTORY ROYALE!"),document.getElementById("game-over-title").style.color="#f1c40f";try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}try{const e=document.getElementById("touch-controls");e&&(e.style.display="none")}catch{}try{this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch{}try{typeof window<"u"&&window.game&&typeof window.game.playEndSequence=="function"&&window.game.playEndSequence(Kt)}catch{}}}updateMinimap(){if(!this.minimapContainer)return;const e=this.settings.showMinimap!==!1;if(this.minimapContainer.classList.toggle("hidden",!e),!e||!this.minimapCtx||!this.player)return;const t=this.minimapCtx,i=this.minimapSize;t.clearRect(0,0,i,i),t.fillStyle="rgba(10, 12, 20, 0.75)",t.fillRect(0,0,i,i),t.strokeStyle="rgba(255, 255, 255, 0.25)",t.lineWidth=2,t.strokeRect(1,1,i-2,i-2);const s=Math.max(1,this.world&&this.world.halfMapSize?this.world.halfMapSize:this.mapSize/2),o=i*.45,n=i/2,a=i/2;if(this.world&&typeof this.world.stormRadius=="number"&&this.world.stormRadius>0){const m=Math.max(0,Math.min(1.2,this.world.stormRadius/s)),f=o*m;t.beginPath(),t.strokeStyle="rgba(157, 77, 187, 0.85)",t.lineWidth=3,t.arc(n,a,f,0,Math.PI*2),t.stroke()}const c=this.player&&this.player.enemyManager&&Array.isArray(this.player.enemyManager.enemies)?this.player.enemyManager.enemies:[];c.length&&(t.fillStyle="#ff3b30",t.strokeStyle="#660000",t.lineWidth=1.5,c.forEach(m=>{if(!m)return;const f=m.position||m.mesh&&m.mesh.position;if(!f)return;const d=Math.max(n-o,Math.min(n+o,n+f.x/s*o)),u=Math.max(a-o,Math.min(a+o,a-f.z/s*o));t.beginPath(),t.arc(d,u,4,0,Math.PI*2),t.fill(),t.stroke()}));const h=this.world&&Array.isArray(this.world.objects)?this.world.objects.filter(m=>m&&m.userData&&m.userData.type==="house"):[];h.length&&(t.fillStyle="#ffd166",t.strokeStyle="#8c5a00",t.lineWidth=1,h.forEach(m=>{const f=m.position;if(!f)return;const d=Math.max(n-o,Math.min(n+o,n+f.x/s*o)),u=Math.max(a-o,Math.min(a+o,a-f.z/s*o));t.beginPath(),t.arc(d,u,3,0,Math.PI*2),t.fill(),t.stroke()}));const r=Math.max(n-o,Math.min(n+o,n+this.player.position.x/s*o)),l=Math.max(a-o,Math.min(a+o,a-this.player.position.z/s*o));t.beginPath(),t.fillStyle="#00d8ff",t.strokeStyle="#ffffff",t.lineWidth=2,t.arc(r,l,6,0,Math.PI*2),t.fill(),t.stroke(),this.multiplayer&&this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach(m=>{if(!m||!m.position)return;const f=Math.max(n-o,Math.min(n+o,n+m.position.x/s*o)),d=Math.max(a-o,Math.min(a+o,a-m.position.z/s*o)),u=m.userData&&m.userData.color?m.userData.color:"#ffaa00";t.beginPath(),t.fillStyle=u,t.strokeStyle="#111",t.lineWidth=2,t.arc(f,d,5,0,Math.PI*2),t.fill(),t.stroke()});try{const m=new B;if(this.player&&this.player.camera&&this.player.camera.getWorldDirection&&this.player.camera.getWorldDirection(m),m.y=0,m.lengthSq()<1e-4&&this.player.mesh&&(m.set(0,0,-1).applyEuler(this.player.mesh.rotation),m.y=0),m.lengthSq()>1e-4){m.normalize();const f=m.x,d=-m.z,u=Math.atan2(d,f)+Math.PI/2;t.save(),t.translate(r,l),t.rotate(u),t.beginPath(),t.moveTo(0,-10),t.lineTo(6,8),t.lineTo(-6,8),t.closePath(),t.fillStyle="#00d8ff",t.strokeStyle="#003f4f",t.lineWidth=2,t.fill(),t.stroke(),t.restore()}}catch{}}updateNetPanel(){if(this.isPerfCollapsed()||!this.netStatsText&&!this.netChartCtx)return;const e=this.multiplayer&&typeof this.multiplayer.getNetStats=="function"?this.multiplayer.getNetStats():null;if(!e){this.netStatsText&&(this.netStatsText.innerText="offline"),this.netChartCtx&&this.netChartCtx.clearRect(0,0,this.netChart.width,this.netChart.height);return}const t=(e.txPerSec||0)/1024,i=(e.rxPerSec||0)/1024,s=typeof e.lastPing=="number"?`${Math.max(0,e.lastPing).toFixed(0)} ms`:"--";if(this.netStatsText&&(this.netStatsText.innerText=` ${t.toFixed(1)} kbps  ${i.toFixed(1)} kbps  ping ${s}`),!this.netChartCtx||!this.netChart)return;const o=this.netChartCtx,n=this.netChart.width,a=this.netChart.height,c=Array.isArray(e.history)?e.history:[];if(o.clearRect(0,0,n,a),!c.length)return;const h=c.reduce((u,p)=>Math.max(u,Math.max(p.tx||0,p.rx||0)/1024),1),r=2,l=c.length,m=u=>l<=1?r:r+u/(l-1)*(n-r*2),f=u=>{const p=Math.max(0,Math.min(1,u/1024/h));return a-r-p*(a-r*2)};o.strokeStyle="rgba(255,255,255,0.12)",o.beginPath(),o.moveTo(r,a-r),o.lineTo(n-r,a-r),o.stroke();const d=(u,p)=>{o.strokeStyle=u,o.beginPath(),c.forEach((v,g)=>{const M=m(g),k=f(p(v)||0);g===0?o.moveTo(M,k):o.lineTo(M,k)}),o.stroke()};d("rgba(0, 210, 255, 0.85)",u=>u.rx||0),d("rgba(255, 150, 50, 0.85)",u=>u.tx||0)}updateGpuMemory(){if(!this.perfGpuMem)return;if(!this.gpuMemInfo||!this._gl){if(performance.memory){const s=(performance.memory.usedJSHeapSize/1048576).toFixed(1),o=(performance.memory.jsHeapSizeLimit/1048576).toFixed(0);this.perfGpuMem.innerText=`${s} / ${o} MB (heap)`}else this.perfGpuMem.innerText="Unsupported";return}const e=performance.now();if(!this.gpuMemInfo.lastUpdate||e-this.gpuMemInfo.lastUpdate>1e3)try{const s=this._gl.getParameter(this.gpuMemInfo.ext.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX);this.gpuMemInfo.lastAvailKb=s||this.gpuMemInfo.lastAvailKb,this.gpuMemInfo.lastUpdate=e}catch{}const t=this.gpuMemInfo.totalKb?this.gpuMemInfo.totalKb/1024:null,i=this.gpuMemInfo.lastAvailKb?this.gpuMemInfo.lastAvailKb/1024:null;if(t&&i){const s=Math.max(0,t-i);this.perfGpuMem.innerText=`${s.toFixed(1)} / ${t.toFixed(1)} MB`}else i?this.perfGpuMem.innerText=`${i.toFixed(1)} MB free`:this.perfGpuMem.innerText="Unknown"}initGpuInfo(){if(!(!this._renderer||this.gpuInfo))try{const e=this._renderer.getContext();this._gl=e;const t=e.getExtension("WEBGL_debug_renderer_info"),i=t?e.getParameter(t.UNMASKED_RENDERER_WEBGL):e.getParameter(e.RENDERER);this.gpuInfo=i||"Unknown GPU";const s=e.getExtension("WEBGL_gpu_memory_info");if(s){const o=e.getParameter(s.GPU_MEMORY_INFO_TOTAL_AVAILABLE_MEMORY_KB)||e.getParameter(s.GPU_MEMORY_INFO_DEDICATED_VIDMEM_NVX)||null,n=e.getParameter(s.GPU_MEMORY_INFO_CURRENT_AVAILABLE_VIDMEM_NVX)||null;this.gpuMemInfo={ext:s,totalKb:o,lastAvailKb:n,lastUpdate:0}}}catch{this.gpuInfo="Unknown GPU"}}setRenderer(e){this._renderer=e,this.initGpuInfo()}setMultiplayer(e){this.multiplayer=e}isPerfCollapsed(){return this.perfEl&&this.perfEl.classList.contains("collapsed")}}const Zt="/threejs-voxel-firecraft/dist/assets/mixkit-kill-blood-zombie-By90BKfb.ogg",Qt="/threejs-voxel-firecraft/dist/assets/zombie-B8PCKsyJ.ogg";class ei{constructor(e,t,i,s){this.scene=e,this.player=t,this.world=i,this.enemies=[],this.spawnInterval=5e3,this.lastSpawn=0,this.killedCount=0,this.groanBuffer=null;const o=s&&(s.gameMode==="matrix"||s.gameMode==="studio"||s.gameMode==="matrix-ai")?0:s?s.enemyCount:15;this.targetCount=o,this.difficulty=s?s.difficulty:"medium",this.gameMode=s&&s.gameMode?s.gameMode:"arcade",this.studioAiEnabled=!1;for(let n=0;n<o;n++)this.spawnEnemy();this.deathBuffer=null;try{const n=window.AudioContext||window.webkitAudioContext;n&&(this.audioCtx=new n,fetch(Zt).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.deathBuffer=a,this.enemies.forEach(c=>{c.audioCtx=this.audioCtx,c.deathBuffer=a})}).catch(a=>{}),fetch(Qt).then(a=>a.arrayBuffer()).then(a=>this.audioCtx.decodeAudioData(a)).then(a=>{this.groanBuffer=a,this.enemies.forEach(c=>{c.audioCtx=this.audioCtx,c.groanBuffer=a})}).catch(a=>{}))}catch{}}spawnEnemy(e=!1,t=null){if(!e&&(this.gameMode==="matrix"||this.gameMode==="studio"))return;const i=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let s=(Math.random()-.5)*i,o=(Math.random()-.5)*i;if(this.gameMode==="studio"&&this.player&&(s=this.player.position.x+(Math.random()-.5)*5,o=this.player.position.z+(Math.random()-.5)*5),this.gameMode==="matrix-ai"&&this.player){const l=(this.world&&this.world.halfMapSize?this.world.halfMapSize:100)*.6;let m=0;for(;m<10;){const f=this.player.position.x,d=this.player.position.z,u=s-f,p=o-d;if(Math.sqrt(u*u+p*p)>=l)break;s=(Math.random()-.5)*i,o=(Math.random()-.5)*i,m++}}const n=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(s,o):0,a=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let c=!1,h=t||"normal";if(t)h==="big"&&(c=!0);else if(this.gameMode==="survival"){const l=this.enemies.filter(u=>u.isBig).length,m=this.enemies.filter(u=>u.zombieType==="slender").length,f=Math.floor(this.targetCount/5),d=Math.floor(this.targetCount/10);if(l<f)c=!0,h="big";else if(m<d)h="slender";else{const u=this.enemies.filter(v=>!v.isBig&&v.zombieType==="normal").length;h=this.enemies.filter(v=>!v.isBig&&v.zombieType==="fat").length<u?"fat":"normal"}}else if(this.gameMode==="arcade"){const l=this.enemies.filter(f=>f.zombieType==="slender").length,m=Math.floor(this.targetCount/10);if(l<m)h="slender";else{const f=this.enemies.filter(u=>u.zombieType==="normal").length;h=this.enemies.filter(u=>u.zombieType==="fat").length<f?"fat":"normal"}}const r=new Ne(this.scene,s,n,o,this.difficulty,a,this.player,c,h);return r.audioCtx=this.audioCtx,r.deathBuffer=this.deathBuffer,r.groanBuffer=this.groanBuffer,r.world=this.world,this.gameMode==="studio"&&(r.studioMode=!0,r.isStudioNPC=!0),this.enemies.push(r),e&&this.gameMode==="studio"&&(this.studioAiEnabled=!1),r}spawnEnemyAt(e,t,i="normal"){const s=this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(e,t):0,o=this.world&&this.world.halfMapSize?this.world.halfMapSize:100;let n=!1,a=i;a==="big"&&(n=!0);const c=new Ne(this.scene,e,s,t,this.difficulty,o,this.player,n,a);return c.audioCtx=this.audioCtx,c.deathBuffer=this.deathBuffer,c.groanBuffer=this.groanBuffer,c.world=this.world,c.studioMode=!0,c.isStudioNPC=!0,this.enemies.push(c),c}setTargetCount(e){typeof e=="number"&&e>=0&&(this.targetCount=e)}update(e){if(this.gameMode!=="matrix"&&!(this.gameMode==="studio"&&!this.studioAiEnabled)&&(this.enemies.forEach(t=>{if(t.update(e,this.player),Math.sqrt(t.position.x*t.position.x+t.position.z*t.position.z)>this.world.stormRadius&&t.takeDamage(5*e),this.world&&typeof this.world.halfMapSize=="number"){const s=this.world.halfMapSize-1;t.position.x=Math.max(-s,Math.min(s,t.position.x)),t.position.z=Math.max(-s,Math.min(s,t.position.z))}}),this.enemies=this.enemies.filter(t=>t.readyToDespawn?(this.killedCount++,!1):!0),this.gameMode==="survival"&&this.targetCount!==void 0&&this.targetCount>0)){const t=this.targetCount-this.enemies.length;if(t>0)for(let i=0;i<t;i++)this.spawnEnemy()}}getEnemyById(e){return e&&this.enemies.find(t=>t&&t.mesh&&t.mesh.userData&&t.mesh.userData.gameId===e)||null}applyRemoteZombieHit(e,t){const i=this.getEnemyById(e);return!i||i.isDead?null:(i.takeDamage(t),i.health)}syncZombieState(e,t){const i=this.getEnemyById(e);if(!i)return;i.health=t;const s=i.maxHealth||100,o=Math.max(0,i.health/s);i.healthBarFg&&(i.healthBarFg.scale.x=o),t<=0&&!i.isDead&&i.startDeath()}}class Ne{constructor(e,t,i,s,o,n=100,a=null,c=!1,h="normal"){this.scene=e,this.position=new B(t,i,s),this.mapHalfSize=n,this.world=null,this.player=a,this.isBig=c,this.zombieType=h,this.deathTimer=0,this.deathDuration=0,this.deathFallProgress=0,this.readyToDespawn=!1,this.groanBuffer=null,this.groanCooldown=0,this.groanRange=15,this._groanSource=null,this._groanGain=null,o==="easy"?(this.health=50,this.damage=2,this.speed=3):o==="hard"?(this.health=150,this.damage=10,this.speed=6):(this.health=100,this.damage=5,this.speed=4.5),this.isBig&&(this.health*=5,this.damage*=2,this.speed*=.75),this.zombieType==="fat"&&(this.health*=1.5,this.speed*=.5),this.zombieType==="slender"&&(this.health*=.8,this.speed*=1.5,this.damage*=1.5,this.attackRange=3),this.maxHealth=this.health,this.state="wander",this.isDead=!1,this.attackRange=this.isBig?3.5:2,this.detectionRange=25,this.attackCooldown=1.5,this.lastAttack=0,this.wanderTarget=null,this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4,this.createMesh()}createMesh(){let e="Zombie";this.isBig?e="Big Zombie":this.zombieType==="fat"?e="Fat Zombie":this.zombieType==="slender"&&(e="Slenderman");let t;const i=this.position.x,s=this.position.y,o=this.position.z;this.zombieType==="slender"?t=ct(this.scene,i,s,o):this.isBig?t=dt(this.scene,i,s,o):this.zombieType==="fat"?t=ut(this.scene,i,s,o):this.zombieType==="spider"?t=zt(this.scene,i,s,o):t=mt(this.scene,i,s,o),this.mesh=t.mesh,this.leftArmPivot=t.leftArmPivot,this.rightArmPivot=t.rightArmPivot,this.leftLegPivot=t.leftLegPivot,this.rightLegPivot=t.rightLegPivot,this.mesh.userData={gameId:Math.random().toString(36).substr(2,9).toUpperCase(),gameName:e,isNPC:!0},this.animTime=0,this.attackAnimTime=0,this.attackAnimDuration=.5,this.createHealthBar()}createHealthBar(){const e=new q(1,.1),t=new Me({color:0});this.healthBarBg=new w(e,t);const i=this.zombieType==="slender"?3:2.3;this.healthBarBg.position.y=i,this.mesh.add(this.healthBarBg);const s=new q(1,.1),o=new Me({color:16711680});this.healthBarFg=new w(s,o),this.healthBarFg.position.y=i,this.healthBarFg.position.z=.01,this.mesh.add(this.healthBarFg)}update(e,t){if(this.isDead){this.updateDeath(e);return}this.groanCooldown=Math.max(0,this.groanCooldown-e),this.groanBuffer&&this.audioCtx&&t&&this.groanCooldown<=0&&this.position.distanceTo(t.position)<=this.groanRange&&(this.playGroan(),this.groanCooldown=2+Math.random()*2.5);const i=t.position;if(this.healthBarBg.lookAt(i),this.healthBarFg.lookAt(i),this.studioMode||this.isStudioNPC){this.animTime+=e,this.animateIdle();return}const s=this.position.distanceTo(i);s<this.detectionRange?this.state="chase":this.state="wander";let o=!1;if(this.state==="chase"){const n=this.hasLineOfSight(t,i);if(s<this.detectionRange&&n){const a=new B().subVectors(i,this.position).normalize();if(a.y=0,s>2){const h=a.clone(),r=Math.sin(performance.now()/500+this.position.x)*.5,l=new B(a.z,0,-a.x).multiplyScalar(r);h.add(l).normalize();const m=this.position.clone().add(h.multiplyScalar(this.speed*e));this.checkCollision(m)||this.position.copy(m),this.mesh.lookAt(i),o=!0}else{const h=a.clone().multiplyScalar(-1),r=this.position.clone().add(h.multiplyScalar(this.speed*e*.5));this.checkCollision(r)||this.position.copy(r),this.mesh.lookAt(i)}if(s<this.attackRange){const h=performance.now()/1e3;h-this.lastAttack>this.attackCooldown&&(t.takeDamage(this.damage),this.lastAttack=h,this.attackAnimTime=this.attackAnimDuration)}}else this.state="wander"}else{if(this.wanderTimer+=e,!this.wanderTarget||this.wanderTimer>this.wanderChangeInterval){const n=10+Math.random()*30,a=Math.random()*Math.PI*2,c=this.position.x+Math.cos(a)*n,h=this.position.z+Math.sin(a)*n,r=(d,u,p)=>Math.max(u,Math.min(p,d)),l=this.mapHalfSize*.9,m=r(c,-l,l),f=r(h,-l,l);this.wanderTarget=new B(m,0,f),this.wanderTimer=0,this.wanderChangeInterval=2+Math.random()*4}if(this.wanderTarget){const n=new B().subVectors(this.wanderTarget,this.position);n.y=0,n.length()>.5?(n.normalize(),this.position.add(n.multiplyScalar(this.speed*e*.5)),this.mesh.lookAt(this.wanderTarget.x,this.position.y,this.wanderTarget.z),o=!0):(this.wanderTimer+=e,this.wanderTimer>this.wanderChangeInterval&&(this.wanderTarget=null,this.wanderTimer=0))}}if(this.mesh.position.copy(this.position),this.world&&typeof this.world.getHeightAt=="function"){const n=this.world.getHeightAt(this.position.x,this.position.z);this.mesh.position.y=Math.max(this.mesh.position.y,n),this.position.y=this.mesh.position.y}if(o){this.animTime+=e*5;const n=Math.sin(this.animTime)*.5;this.leftLegPivot.rotation.x=n,this.rightLegPivot.rotation.x=-n,this.leftArmPivot.rotation.x=-Math.PI/3+n*.2,this.rightArmPivot.rotation.x=-Math.PI/3-n*.2}else this.state!=="attack"&&(this.leftLegPivot.rotation.x=0,this.rightLegPivot.rotation.x=0,this.leftArmPivot.rotation.x=-Math.PI/3,this.rightArmPivot.rotation.x=-Math.PI/3);if(this.attackAnimTime>0){this.attackAnimTime=Math.max(0,this.attackAnimTime-e);const n=1-this.attackAnimTime/this.attackAnimDuration,a=Math.sin(n*Math.PI)*1.5;if(this.leftArmPivot.rotation.x=-Math.PI/2+a*.2,this.rightArmPivot.rotation.x=-Math.PI/2-a*.2,n>.3&&n<.7){const c=new B;this.mesh.getWorldDirection(c),c.y=0,c.normalize(),this.position.add(c.multiplyScalar(.02))}}}takeDamage(e){this.health-=e;const t=this.maxHealth||100,i=Math.max(0,this.health/t);this.healthBarFg.scale.x=i,this.mesh.traverse(s=>{if(s.isMesh&&s!==this.healthBarBg&&s!==this.healthBarFg){const o=s.material;if(!s.userData.originalColor&&o&&o.color)try{s.userData.originalColor=o.color.clone()}catch{s.userData.originalColor=null}if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new ie(16711680);else if(o&&o.color)try{o.color=o.color.clone().lerp(new ie(16711680),.6)}catch{}}}),setTimeout(()=>{this.isDead||this.mesh.traverse(s=>{if(s.isMesh&&s!==this.healthBarBg&&s!==this.healthBarFg){const o=s.material;if(o&&(o.isMeshStandardMaterial||o.isMeshPhongMaterial||o.isMeshLambertMaterial))o.emissive=new ie(0);else if(o&&o.color&&s.userData&&s.userData.originalColor)try{o.color.copy(s.userData.originalColor)}catch{}}})},100),this.health<=0&&!this.isDead&&this.startDeath()}playDeathSound(){try{const e=this.audioCtx.createBufferSource();e.buffer=this.deathBuffer;const t=this.audioCtx.createGain();t.gain.value=.7,e.connect(t),t.connect(this.audioCtx.destination),e.start(0)}catch(e){console.warn("playDeathSound error:",e)}}checkCollision(e){if(!this.scene)return!1;const t=.5;for(let i of this.scene.children)if(i.userData&&(i.userData.type==="house"||i.userData.type==="tree")){const s=i.position,o=Math.sqrt(Math.pow(e.x-s.x,2)+Math.pow(e.z-s.z,2)),n=i.userData.type==="house"?5:2;if(o<t+n)return!0}return!1}hasLineOfSight(e,t){if(!this.scene)return!0;const i=new B().subVectors(t,this.position).normalize(),s=this.position.distanceTo(t),n=new j(this.position.clone().add(new B(0,1,0)),i,0,s).intersectObjects(this.scene.children,!0);for(let a of n){if(a.object===this.mesh||a.object.parent===this.mesh||a.object===e.mesh||a.object.parent===e.mesh)continue;let c=a.object;for(;c.parent&&c.parent!==this.scene;)c=c.parent;if(c.userData&&(c.userData.type==="house"||c.userData.type==="tree"))return!1}return!0}startDeath(){this.isDead=!0,this.deathTimer=0,this.deathFallProgress=0,this.deathDuration=3+Math.random()*2,this.stopGroan(),this.healthBarBg&&(this.healthBarBg.visible=!1),this.healthBarFg&&(this.healthBarFg.visible=!1);const e=25,t=this.player&&this.player.position;if(t?this.position.distanceTo(t)<=e:!0)try{this.audioCtx&&this.deathBuffer&&(this.audioCtx.state==="suspended"?this.audioCtx.resume().then(()=>{this.playDeathSound()}):this.audioCtx.state==="running"&&this.playDeathSound())}catch(s){console.warn("Error playing death sound:",s)}}updateDeath(e){this.deathFallProgress=Math.min(1,this.deathFallProgress+e*2.5);const t=-Math.PI/2*this.deathFallProgress;this.mesh&&(this.mesh.rotation.x=t,this.mesh.position.y=Math.max(0,this.mesh.position.y-e*.6)),this.deathTimer+=e,this.deathTimer>=(this.deathDuration||3)&&(this.mesh&&this.mesh.parent&&this.scene.remove(this.mesh),this.readyToDespawn=!0)}playGroan(){try{if(!this.audioCtx||!this.groanBuffer)return;if(this.audioCtx.state==="suspended"){this.audioCtx.resume().then(()=>this.playGroan());return}const e=this.audioCtx.createBufferSource();e.buffer=this.groanBuffer;const t=this.audioCtx.createGain();t.gain.value=.45,e.connect(t),t.connect(this.audioCtx.destination),e.onended=()=>{this._groanSource=null,this._groanGain=null},e.start(0),this._groanSource=e,this._groanGain=t}catch(e){console.warn("playGroan error:",e)}}stopGroan(){if(this._groanSource){try{this._groanSource.stop()}catch{}try{this._groanSource.disconnect()}catch{}this._groanSource=null}if(this._groanGain){try{this._groanGain.disconnect()}catch{}this._groanGain=null}}}class ti{constructor(e,t,i){this.scene=e,this.player=t,this.items=[],this.interactionPrompt=document.getElementById("interaction-prompt"),this.mapSize=i&&i.mapSize?i.mapSize:ke,this.spawnSpan=this.mapSize*.75,this.glowRadius=7,this.world=null,this.settings=i||{},this.matrixDropInterval=5,this._matrixDropTimer=0,this.matrixDropBatchSize=10,this.matrixDropRadiusLimit=10,this.initLoot(),document.addEventListener("keydown",s=>{s.code==="KeyE"&&this.tryInteract()})}setWorld(e){this.world=e,this.realignItemsToGround()}getClampedCoord(e,t){if(this.world&&typeof this.world.halfMapSize=="number"){const i=this.world.halfMapSize-1;return{x:Math.max(-i,Math.min(i,e)),z:Math.max(-i,Math.min(i,t))}}return{x:e,z:t}}initLoot(){if(this.settings.gameMode==="matrix"||this.settings.gameMode==="studio"||this.settings.gameMode==="matrix-ai"||this.settings.skipLoot)return;for(let t=0;t<24;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.createChest(i,.5,s)}for(let t=0;t<36;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.spawnJuiceBottle(i,s)}const e=[2899536,15105570,1752220,15158332,10181046];for(let t=0;t<8;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s));const o=e[t%e.length];this.spawnBackpack(i,s,o)}for(let t=0;t<12;t++){let i=(Math.random()-.5)*this.spawnSpan,s=(Math.random()-.5)*this.spawnSpan;({x:i,z:s}=this.getClampedCoord(i,s)),this.spawnMedKit(i,s)}}createChest(e,t,i){this.spawnChest(e,i)}spawnChest(e,t){const i=new T;({x:e,z:t}=this.getClampedCoord(e,t));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(e,t)+.5),i.position.set(e,s,t);const o=new S(1,.8,.6),n=new x({color:15844367,roughness:.3,metalness:.5}),a=new w(o,n);i.add(a);const c=new S(1,.2,.6),h=new w(c,n);h.position.y=.5,i.add(h);const r=new w(new S(.2,.3,.1),new x({color:9807270}));r.position.set(0,.3,.3),i.add(r),i.castShadow=!0,i.receiveShadow=!0;const l=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],m=l[Math.floor(Math.random()*l.length)];i.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:m};const f=this.createGlowEffect();return f.position.y=1,i.add(f),i.userData.glow=f,this.scene.add(i),this.items.push(i),i}spawnChestWithLoot(e,t,i){const s=new T;({x:e,z:t}=this.getClampedCoord(e,t));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(e,t)+.5),s.position.set(e,o,t);const n=new S(1,.8,.6),a=new x({color:15844367,roughness:.3,metalness:.5}),c=new w(n,a);s.add(c);const h=new S(1,.2,.6),r=new w(h,a);r.position.y=.5,s.add(r);const l=new w(new S(.2,.3,.1),new x({color:9807270}));l.position.set(0,.3,.3),s.add(l),s.castShadow=!0,s.receiveShadow=!0,s.userData={type:"chest",isOpened:!1,gameId:this.generateID(),gameName:"Chest",loot:i};const m=this.createGlowEffect();return m.position.y=1,s.add(m),s.userData.glow=m,this.scene.add(s),this.items.push(s),s}spawnJuiceBottle(e,t){const i=new T;({x:e,z:t}=this.getClampedCoord(e,t));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(e,t)+.5),i.position.set(e,s,t);const o=new w(new K(.2,.2,.6,8),new x({color:2600544}));o.position.y=.5,i.add(o);const n=new w(new K(.12,.12,.15,8),new x({color:12597547}));n.position.y=.9,i.add(n),i.castShadow=!0,i.receiveShadow=!0,i.userData={type:"stamina",gameId:this.generateID(),gameName:"JuiceBottle",amount:50};const a=this.createGlowEffect();return a.position.y=.9,i.add(a),i.userData.glow=a,this.scene.add(i),this.items.push(i),i}generateID(){return Math.random().toString(36).substr(2,9).toUpperCase()}spawnLootInHouse(e,t,i){this.spawnChest(e,i)}spawnBackpack(e,t,i){const s=new T;({x:e,z:t}=this.getClampedCoord(e,t));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(e,t)+.5),s.position.set(e,o,t);const n=new w(new S(.7,.9,.35),new x({color:i,metalness:.15,roughness:.8}));s.add(n);const a=new w(new S(.6,.25,.16),new x({color:3426654,metalness:.1,roughness:.8}));a.position.set(0,-.55,.18),s.add(a),s.castShadow=!0,s.receiveShadow=!0;const c=this.createGlowEffect();return c.position.y=1,s.add(c),s.userData={type:"backpack",color:i,gameId:this.generateID(),gameName:"Backpack",isOpened:!1,glow:c},this.scene.add(s),this.items.push(s),s}spawnMedKit(e,t){const i=new T;({x:e,z:t}=this.getClampedCoord(e,t));let s=.5;this.world&&typeof this.world.getHeightAt=="function"&&(s=this.world.getHeightAt(e,t)+.3),i.position.set(e,s,t);const o=new w(new S(.8,.5,.6),new x({color:15790320,metalness:.2,roughness:.6}));i.add(o);const n=new w(new S(.5,.05,.15),new x({color:15158332,metalness:.1,roughness:.4}));n.position.y=.28,i.add(n);const a=new w(new S(.15,.05,.5),new x({color:15158332,metalness:.1,roughness:.4}));a.position.y=.28,i.add(a);const c=new w(new S(.6,.1,.08),new x({color:9807270,metalness:.4,roughness:.5}));c.position.y=.35,i.add(c);const h=new w(new S(.15,.08,.08),new x({color:8359053,metalness:.5,roughness:.4}));h.position.set(0,0,.32),i.add(h),i.castShadow=!0,i.receiveShadow=!0;const r=this.createGlowEffect();return r.position.y=.6,i.add(r),i.userData={type:"medkit",gameId:this.generateID(),gameName:"MedKit",healAmount:25,isOpened:!1,glow:r},this.scene.add(i),this.items.push(i),i}spawnMatrixLoadout(e=0,t=0){[{dx:2,dz:0,loot:"Pistol"},{dx:-2,dz:0,loot:"Rifle"},{dx:0,dz:2,loot:"Sniper"},{dx:0,dz:-2,loot:"ShieldPotion"},{dx:2,dz:2,loot:"SMG"},{dx:-2,dz:-2,loot:"Shotgun"},{dx:-2,dz:2,loot:"DMR"}].forEach(o=>{this.spawnChestWithLoot(e+o.dx,t+o.dz,o.loot)}),this.spawnJuiceBottle(e+3,t+3),this.spawnJuiceBottle(e-3,t-3),[2899536,15105570,1752220].forEach((o,n)=>{this.spawnBackpack(e+(n-1)*2,t+4,o)})}countNearbyChests(e=10){if(!this.player)return 0;const t=this.player.position;let i=0;return this.items.forEach(s=>{const o=s.userData||{};if(o.type!=="chest"||o.isOpened)return;const n=s.position.x-t.x,a=s.position.z-t.z;Math.sqrt(n*n+a*a)<=e&&i++}),i}createUmbrella(){const e=new T,t=new w(new K(.08,.08,1.6,6),new x({color:4863016,roughness:.8}));t.position.y=-.2,e.add(t),[16726832,15844367,3447003].forEach((o,n)=>{const a=new w(new S(1.8-n*.3,.15,1.8-n*.3),new x({color:o,roughness:.4,metalness:.2}));a.position.y=.7+n*.12,e.add(a)});const s=new w(new Ve(.2,.25,6),new x({color:2899536}));return s.position.y=1.1,e.add(s),e.castShadow=!0,e.receiveShadow=!0,e}spawnMatrixDropNearPlayer(){if(!this.player)return;const e=Math.random()*Math.PI*2,t=4+Math.random()*8;let i=this.player.position.x+Math.cos(e)*t,s=this.player.position.z+Math.sin(e)*t;({x:i,z:s}=this.getClampedCoord(i,s));let o=.5;this.world&&typeof this.world.getHeightAt=="function"&&(o=this.world.getHeightAt(i,s)+.5);const n=["Rifle","Sniper","Pistol","ShieldPotion","SMG","Shotgun","DMR","MedKit"],a=n[Math.floor(Math.random()*n.length)],c=this.spawnChestWithLoot(i,s,a);if(c){c.position.y=o+18,c.userData.isDropping=!0,c.userData.dropTargetY=o,c.userData.dropVelocity=0;const h=this.createUmbrella();h.position.y=1.2,c.add(h),c.userData.umbrella=h}}spawnMatrixDropsBatch(){if(this.countNearbyChests(this.matrixDropRadiusLimit)>=this.matrixDropBatchSize)return;const e=this.matrixDropBatchSize-this.countNearbyChests(this.matrixDropRadiusLimit),t=Math.max(0,Math.min(this.matrixDropBatchSize,e));for(let i=0;i<t;i++)this.spawnMatrixDropNearPlayer()}update(e=.016){const t=Math.max(0,e||0);this.settings.gameMode==="matrix"&&this.player&&(this._matrixDropTimer+=t,this._matrixDropTimer>=this.matrixDropInterval&&(this._matrixDropTimer=0,this.spawnMatrixDropsBatch())),this.items.forEach(o=>{const n=o.userData||{};if(n.isDropping&&(n.dropVelocity=(n.dropVelocity||0)+5*t,o.position.y-=n.dropVelocity*t,o.position.y<=n.dropTargetY&&(o.position.y=n.dropTargetY,n.isDropping=!1,n.dropVelocity=0,n.umbrella))){try{o.remove(n.umbrella)}catch{}n.umbrella=null}});let i=null;const s=this.player.position;for(const o of this.items){if(o.userData&&o.userData.isOpened)continue;const n=s.distanceTo(o.position);if(this.updateGlow(o,n),n<3){i=o;break}}if(!(this.interactionPrompt&&this.interactionPrompt.dataset.vehiclePrompt==="1"))if(i){this.interactionPrompt.classList.remove("hidden");const o=i.userData||{};if(o.type==="chest")this.interactionPrompt.innerText=`Press E to open (Contains: ${o.loot})`;else if(o.type==="stamina")this.interactionPrompt.innerText=`Press E to collect ${o.gameName} (+${o.amount} Stamina)`;else if(o.type==="medkit")this.interactionPrompt.innerText=`Press E to use ${o.gameName} (+${o.healAmount}% Health)`;else if(o.type==="backpack"){const n=o.color?"#"+o.color.toString(16).padStart(6,"0"):"";this.interactionPrompt.innerText=`Press E to equip Backpack ${n}`}else this.interactionPrompt.innerText="Press E to interact";this.currentItem=i}else this.interactionPrompt.classList.add("hidden"),this.currentItem=null}tryInteract(){if(this.currentItem){const e=this.currentItem.userData;if(!e)return;if(e.type==="chest"&&!e.isOpened)e.isOpened=!0,this.scene.remove(this.currentItem),this.player.collectItem(e.loot),console.log(`Looted ${e.loot}!`);else if(e.type==="stamina"){const t=e.amount||50;this.player&&(this.player.stamina=Math.min(100,this.player.stamina+t)),this.scene.remove(this.currentItem),e.isOpened=!0,console.log(`Picked up stamina item: +${t}`)}else if(e.type==="medkit"){const t=e.healAmount||25;if(this.player){const s=100*t/100;this.player.health=Math.min(100,this.player.health+s),console.log(`Used MedKit: +${s} HP (${t}%)`)}this.scene.remove(this.currentItem),e.isOpened=!0}else if(e.type==="backpack"){const t=e.color||2899536;if(this.player&&typeof this.player.collectItem=="function"){const i=this.player.collectItem(`Backpack:${t.toString(16)}`);if(i!=null){const s=this.player.position.clone();this.spawnBackpack(s.x+.5,s.z+.5,i)}}this.scene.remove(this.currentItem),e.isOpened=!0,console.log(`Equipped backpack ${t.toString(16)}`)}}}realignItemsToGround(){!this.world||typeof this.world.getHeightAt!="function"||this.items.forEach(e=>{const t=e.position,i=this.world.getHeightAt(t.x,t.z),s=(e.userData&&e.userData.type==="chest",.5);e.position.y=i+s})}updateGlow(e,t){if(!e||!e.userData||!e.userData.glow)return;const i=e.userData.glow,s=!e.userData.isOpened&&t<this.glowRadius;i.visible=s,s&&(i.rotation.y+=.02,i.position.y=(e.userData.type==="chest"?1:.9)+Math.sin(performance.now()/500)*.1)}createGlowEffect(){const t=new Float32Array(120),i=.6;for(let a=0;a<40;a++){const c=i*Math.random(),h=Math.random()*Math.PI*2,r=Math.random()*i*.6;t[a*3]=Math.cos(h)*c,t[a*3+1]=r,t[a*3+2]=Math.sin(h)*c}const s=new We;s.setAttribute("position",new xe(t,3));const o=new pt({color:16765286,size:.15,transparent:!0,opacity:.9,depthWrite:!1,blending:ft,sizeAttenuation:!0}),n=new gt(s,o);return n.visible=!1,n}}class ii{constructor(e,t={}){this.player=e,this.container=document.getElementById("touch-controls"),this.enabled=!0,this.layout=t&&t.layout?t.layout:{},this._cleanupExistingControls(),this.isEditing=!1,this.buttonHelpers=new Map,this._suppressDragUntil=0,this.joystick=document.createElement("div"),this.joystick.className="tc-joystick",this.joystick.style.zIndex="210",this.stick=document.createElement("div"),this.stick.className="tc-stick",this.joystick.appendChild(this.stick),this.buttons=document.createElement("div"),this.buttons.className="tc-buttons",this.buttons.style.zIndex="210",this.fireBtn=document.createElement("button"),this.fireBtn.className="tc-btn tc-btn-fire",this.fireBtn.innerText="FIRE",this.jumpBtn=document.createElement("button"),this.jumpBtn.className="tc-btn",this.jumpBtn.innerText="JUMP",this.sprintBtn=document.createElement("button"),this.sprintBtn.className="tc-btn",this.sprintBtn.innerText="SPRINT",this.interactBtn=document.createElement("button"),this.interactBtn.className="tc-btn tc-interact-btn",this.interactBtn.innerText="E",this.interactBtn.style.display="none",this.crouchBtn=document.createElement("button"),this.crouchBtn.className="tc-btn",this.crouchBtn.innerText="CROUCH",this.crouchBtn.style.fontSize="16px",this.buttons.appendChild(this.fireBtn),this.buttons.appendChild(this.jumpBtn),this.buttons.appendChild(this.sprintBtn),this.buttons.appendChild(this.crouchBtn),this.buttons.appendChild(this.interactBtn),this.container.appendChild(this.joystick),this.container.appendChild(this.buttons),this.container.classList.remove("hidden"),this.applyLayout(),this._initDragHandles(),this.active=!1,this.startPos=null,this.currentPos={x:0,y:0},this.lookActive=!1,this.lookStartPos=null,this._bindJoystick(),this._bindButtons(),this._bindLookArea(),this._setupEditToggleGesture(),this.deadZone=10,this.maxRadius=50,document.body.style.touchAction="none";try{this.player&&(this.player.allowTouchMovement=!0)}catch{}}_dispatchTouchLook(e,t){try{window.dispatchEvent(new CustomEvent("game-touch-look",{detail:{dx:e,dy:t}}))}catch{}}destroy(){try{this.container.classList.add("hidden"),this.destroyLookArea(),this.container.removeChild(this.joystick),this.container.removeChild(this.buttons),document.body.style.touchAction="",this.player&&(this.player.allowTouchMovement=!1)}catch{}}applyLayout(){const e=this.layout.joystickLeft!==void 0?this.layout.joystickLeft:10,t=this.layout.joystickBottom!==void 0?this.layout.joystickBottom:12,i=this.layout.buttonsRight!==void 0?this.layout.buttonsRight:8,s=this.layout.buttonsBottom!==void 0?this.layout.buttonsBottom:12,o=this.layout.buttonGapVh!==void 0?this.layout.buttonGapVh:14/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={});const n=(c,h)=>{this.layout.buttonPositions[c]||(this.layout.buttonPositions[c]={right:i,bottom:s+o*h})};n("fire",0),n("jump",1),n("sprint",2),n("crouch",3),n("interact",4),this.joystick.style.left=`${e}vw`,this.joystick.style.bottom=`${t}vh`,this.buttons.style.position="absolute",this.buttons.style.top="0",this.buttons.style.left="0",this.buttons.style.right="0",this.buttons.style.bottom="0",this.buttons.style.display="block",this.buttons.style.pointerEvents="none";const a=(c,h)=>{const r=this.layout.buttonPositions[h];r&&(c.style.position="absolute",c.style.right=`${r.right}vw`,c.style.bottom=`${r.bottom}vh`,c.style.pointerEvents="auto")};a(this.fireBtn,"fire"),a(this.jumpBtn,"jump"),a(this.sprintBtn,"sprint"),a(this.crouchBtn,"crouch"),a(this.interactBtn,"interact")}_cleanupExistingControls(){if(!this.container)return;this.container.querySelectorAll(".tc-joystick, .tc-buttons, .tc-look-area").forEach(t=>{try{t.parentNode.removeChild(t)}catch{}})}_initDragHandles(){const e=()=>{try{const o=localStorage.getItem("touch-layout");if(o){const n=JSON.parse(o);this.layout={...this.layout,...n}}}catch{}},t=()=>{try{localStorage.setItem("touch-layout",JSON.stringify(this.layout))}catch{}};e(),this.applyLayout(),((o,n)=>{let a=!1,c=0,h=0;const r=10,l=d=>{const u=d.touches?d.touches[0]:d;if(!a){const p=u.clientX-c,v=u.clientY-h;if(Math.sqrt(p*p+v*v)<r)return;a=!0}{const p=u.clientX/window.innerWidth*100;this.layout.joystickLeft=Math.max(0,Math.min(80,p));const v=(window.innerHeight-u.clientY)/window.innerHeight*100;this.layout.joystickBottom=Math.max(0,Math.min(80,v))}this.applyLayout(),d.preventDefault&&d.preventDefault()},m=()=>{a&&(a=!1,t()),document.removeEventListener("touchmove",l,{passive:!1}),document.removeEventListener("touchend",m),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",m)},f=d=>{if(!this.isEditing||this._shouldSuppressDrag()||d.touches&&d.touches.length>1)return;const u=d.touches?d.touches[0]:d;c=u.clientX,h=u.clientY,a=!1,document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",m),document.addEventListener("pointermove",l),document.addEventListener("pointerup",m)};o.addEventListener("touchstart",f,{passive:!0}),o.addEventListener("pointerdown",f)})(this.joystick);const s=(o,n)=>{let a=!1,c=0,h=0;const r=10,l=d=>{if(!a)return;const u=d.touches?d.touches[0]:d,p=(window.innerWidth-u.clientX)/window.innerWidth*100,v=(window.innerHeight-u.clientY)/window.innerHeight*100;this.layout.buttonPositions||(this.layout.buttonPositions={}),this.layout.buttonPositions[n]={right:Math.max(0,Math.min(90,p)),bottom:Math.max(0,Math.min(90,v))},this.applyLayout(),d.preventDefault&&d.preventDefault()},m=()=>{a&&(a=!1,t()),document.removeEventListener("touchmove",l,{passive:!1}),document.removeEventListener("touchend",m),document.removeEventListener("pointermove",l),document.removeEventListener("pointerup",m)},f=d=>{if(!this.isEditing||this._shouldSuppressDrag()||d.touches&&d.touches.length>1)return;const u=d.touches?d.touches[0]:d;c=u.clientX,h=u.clientY,a=!1,document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",m),document.addEventListener("pointermove",l),document.addEventListener("pointerup",m)};o.addEventListener("touchstart",f,{passive:!0}),o.addEventListener("pointerdown",f),o.addEventListener("touchmove",d=>{if(!this.isEditing||this._shouldSuppressDrag()||a)return;const u=d.touches?d.touches[0]:d,p=u.clientX-c,v=u.clientY-h;Math.sqrt(p*p+v*v)>r&&(a=!0)},{passive:!0}),o.addEventListener("pointermove",d=>{if(d.pointerType!=="touch"||!this.isEditing||this._shouldSuppressDrag()||a)return;const u=d.clientX-c,p=d.clientY-h;Math.sqrt(u*u+p*p)>r&&(a=!0)})};s(this.fireBtn,"fire"),s(this.jumpBtn,"jump"),s(this.sprintBtn,"sprint"),s(this.crouchBtn,"crouch"),s(this.interactBtn,"interact")}_bindJoystick(){this.joystick.addEventListener("touchstart",t=>{t.preventDefault();const i=t.changedTouches[0];this.joystick.getBoundingClientRect(),this.startPos={x:i.clientX,y:i.clientY},this.active=!0}),this.joystick.addEventListener("touchmove",t=>{if(!this.active)return;t.preventDefault();const i=t.changedTouches[0],s=i.clientX-this.startPos.x,o=i.clientY-this.startPos.y,n=Math.sqrt(s*s+o*o),a=Math.atan2(o,s),c=Math.min(this.maxRadius,n),h=Math.cos(a)*c,r=Math.sin(a)*c;this.stick.style.transform=`translate(${h}px, ${r}px)`;const l=s/this.maxRadius,m=o/this.maxRadius;this.player.moveForward=m<-.3,this.player.moveBackward=m>.3,this.player.moveLeft=l<-.3,this.player.moveRight=l>.3});const e=t=>{this.active&&(t.preventDefault(),this.active=!1,this.startPos=null,this.stick.style.transform="translate(0,0)",this.player.moveForward=!1,this.player.moveBackward=!1,this.player.moveLeft=!1,this.player.moveRight=!1)};this.joystick.addEventListener("touchend",e),this.joystick.addEventListener("touchcancel",e)}_bindButtons(){let e=null,t=null;const i=()=>{e&&(clearInterval(e),e=null)};this._stopFireInterval=i,this.fireBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&(i(),t&&(clearTimeout(t),t=null),this.player&&typeof this.player.shoot=="function"&&(this.player.shoot(),t=setTimeout(()=>{e=setInterval(()=>{this.player&&typeof this.player.shoot=="function"&&this.player.shoot()},150)},220)))});const s=o=>{o&&o.preventDefault&&o.preventDefault(),!this.isEditing&&(t&&(clearTimeout(t),t=null),i())};this.fireBtn.addEventListener("touchend",s),this.fireBtn.addEventListener("touchcancel",s),this.fireBtn.addEventListener("pointerup",o=>{o.pointerType==="touch"&&s(o)}),this.fireBtn.addEventListener("pointercancel",o=>{o.pointerType==="touch"&&s(o)}),this.fireBtn.addEventListener("mouseup",s),this.fireBtn.addEventListener("mouseleave",s),this.jumpBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&this.player.canJump===!0&&(this.player.velocity.y+=this.player.jumpHeight,this.player.canJump=!1)}),this.sprintBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.stamina<=0?this.player.isSprinting=!1:this.player.isSprinting=!this.player.isSprinting,this._updateSprintButton())}),this.interactBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&window.game&&window.game.itemManager&&window.game.itemManager.tryInteract()}),this.crouchBtn.addEventListener("touchstart",o=>{o.preventDefault(),!this.isEditing&&this.player&&(this.player.isCrouching=!this.player.isCrouching,this.crouchBtn.style.background=this.player.isCrouching?"rgba(52, 152, 219, 0.9)":"rgba(241, 196, 15, 0.9)")})}update(){window.game&&window.game.itemManager&&window.game.itemManager.currentItem?this.interactBtn.style.display="block":this.interactBtn.style.display="none";try{this.player&&this.player.stamina!==void 0&&(this.player.isSprinting&&this.player.stamina<=0&&(this.player.isSprinting=!1),this._updateSprintButton())}catch{}}destroyLookArea(){try{this.lookArea&&this.container&&this.lookArea.parentElement===this.container&&this.container.removeChild(this.lookArea)}catch{}this.lookArea=null}rebuildLookArea(){this.destroyLookArea(),this._bindLookArea()}_bindLookArea(){try{if(this.lookArea)try{this.container.removeChild(this.lookArea)}catch{}this.lookArea=document.createElement("div"),this.lookArea.className="tc-look-area",this.lookArea.style.position="absolute",this.lookArea.style.top="0",this.lookArea.style.bottom="0",this.lookArea.style.right="0",this.lookArea.style.left="0",this.lookArea.style.width="100%",this.lookArea.style.zIndex="190",this.lookArea.style.background="transparent",this.lookArea.style.touchAction="none",this.lookArea.style.pointerEvents="auto",this.container.appendChild(this.lookArea);let e=null,t=0,i=0;this.lookArea.addEventListener("touchstart",o=>{if(e!==null)return;const n=o.changedTouches[0];e=n.identifier,t=n.clientX,i=n.clientY,o.cancelable&&o.preventDefault()},{passive:!1}),this.lookArea.addEventListener("touchmove",o=>{if(e!==null){o.cancelable&&o.preventDefault();for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===e){const a=o.changedTouches[n],c=a.clientX-t,h=a.clientY-i;t=a.clientX,i=a.clientY,this._dispatchTouchLook(c,h);break}}},{passive:!1});const s=o=>{if(e!==null){for(let n=0;n<o.changedTouches.length;n++)if(o.changedTouches[n].identifier===e){e=null;break}}};this.lookArea.addEventListener("touchend",s),this.lookArea.addEventListener("touchcancel",s)}catch{}}_getButtons(){return[this.fireBtn,this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_getEditToggleTargets(){return[this.jumpBtn,this.sprintBtn,this.crouchBtn,this.interactBtn]}_setupEditToggleGesture(){let e=0,t=0;const i=700,s=n=>{n.touches&&n.touches.length>=2&&(n.preventDefault(),n.stopPropagation(),e=0,this._suppressDrag(),this._toggleEditMode())},o=n=>{const a=performance.now();a-t<i?e+=1:e=1,t=a,e>=3&&(n.preventDefault(),n.stopPropagation(),e=0,this._suppressDrag(),this._toggleEditMode())};this._getEditToggleTargets().forEach(n=>{n.addEventListener("touchstart",s,{passive:!1}),n.addEventListener("touchend",o,{passive:!1}),n.addEventListener("touchcancel",()=>{e=0},{passive:!0}),n.addEventListener("pointerdown",a=>{a.pointerType})})}_updateSprintButton(){if(!this.player)return;const e=!!this.player.isSprinting;this.sprintBtn.style.background=e?"rgba(46, 204, 113, 0.9)":"rgba(241, 196, 15, 0.9)"}_toggleEditMode(){this.isEditing?this._exitEditMode():this._enterEditMode()}_enterEditMode(){this.isEditing=!0,typeof this._stopFireInterval=="function"&&this._stopFireInterval(),this._showButtonHelpers(),this._suppressDrag()}_exitEditMode(){this.isEditing=!1,this._hideButtonHelpers()}_showButtonHelpers(){this._getButtons().forEach(e=>{e.classList.add("tc-btn-editing");let t=this.buttonHelpers.get(e);t||(t=document.createElement("div"),t.className="tc-btn-helper",t.style.position="absolute",t.style.inset="-8px",t.style.border="2px dashed rgba(255, 255, 255, 0.75)",t.style.borderRadius="22px",t.style.pointerEvents="none",t.style.boxShadow="0 0 12px rgba(255, 255, 255, 0.5)",t.style.animation="tc-btn-helper-pulse 1.6s ease-in-out infinite",t.style.opacity="0.9",this.buttonHelpers.set(e,t)),e.contains(t)||(t.setAttribute("aria-hidden","true"),e.appendChild(t))})}_hideButtonHelpers(){this._getButtons().forEach(e=>{e.classList.remove("tc-btn-editing");const t=this.buttonHelpers.get(e);t&&t.parentNode===e&&e.removeChild(t)})}_suppressDrag(e=450){this._suppressDragUntil=performance.now()+e}_shouldSuppressDrag(){return performance.now()<this._suppressDragUntil}}class si{constructor({player:e,scene:t,url:i,nick:s="Player",color:o="#29b6f6",roomCode:n="PUBLIC",settings:a=null}){this.player=e,this.scene=t,this.url=i,this.nick=s,this.color=o,this.roomCode=n||"PUBLIC",this.socket=null,this.id=null,this.others=new Map,this.lastSend=0,this.sendInterval=.05,this.lastSentPos=null,this.lastSentRot=null,this.lastAnimSig=null,this.heartbeatTimer=0,this.isHost=!1,this.roomSettings=a,this._manualClose=!1,this.deadPeers=new Set,this.matchLive=!1,this.remoteStates=new Map,this.remoteLastYaw=new Map,this.interpDelayMs=100,this.maxBufferMs=1e3,this.maxExtrapMs=80,this.remoteFaceOffset=0,this._now=typeof performance<"u"&&performance.now.bind(performance)||Date.now,this._tmpVec=new B,this.enemyManager=null,this.netStats={txBytes:0,rxBytes:0,txPerSec:0,rxPerSec:0,lastSample:this._now(),history:[]},this.lastPingSent=0,this.pingInterval=5,this.connect()}applyColorToTorso(e,t){if(!e||!t)return;let i=!1;const s=new ie(t);return e.traverse(o=>{if(!o.isMesh||!o.material||Array.isArray(o.material))return;const n=o.userData&&o.userData.gameName?o.userData.gameName.toLowerCase():"";(n.includes("body")||n.includes("torso")||n.includes("shirt")||n.includes("clothes")||o.geometry&&o.geometry.parameters&&Math.abs(o.geometry.parameters.width-.6)<.05)&&(o.material=o.material.clone(),o.material.color=s,i=!0)}),e.userData&&(e.userData.color=t),i}connect(){if(!this.url){console.warn("Multiplayer URL not configured.");const e=document.getElementById("ai-log");if(e){const t=document.createElement("div");t.textContent="Multiplayer URL not set in settings.",t.style.color="#ff9b9b",e.appendChild(t)}return}try{this.socket=new WebSocket(this.url),this.socket.onopen=()=>{this.sendJoin()},this.socket.onmessage=e=>this.handleMessage(e),this.socket.onclose=()=>{this.others.forEach(e=>{try{this.scene.remove(e)}catch{}}),this.others.clear(),this.deadPeers.clear(),this.matchLive=!1,this._manualClose||setTimeout(()=>this.connect(),1500)},this.socket.onerror=()=>{}}catch(e){console.warn("Multiplayer connect failed:",e)}}handleMessage(e){var t;try{const i=typeof e.data=="string"?e.data.length:0,s=JSON.parse(e.data);if(i>0&&this.trackRx(i),s.type!=="hello"){if(s.type==="welcome")this.id=s.id,this.isHost=!!s.isHost,s.settings&&(this.roomSettings=s.settings),s.custom&&(this.localCustom=s.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount()),this.onHostChanged&&this.onHostChanged(this.isHost),s.settings&&this.onSettings&&this.onSettings(s.settings);else if(s.type==="player-join")s.id&&s.id!==this.id&&this.ensureRemote(s.id,null,s.custom),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(s.type==="player-leave")this.removeRemote(s.id),this.onPeersChanged&&this.onPeersChanged(this.getPeerCount());else if(s.type==="state"&&s.id!==this.id){if(this.deadPeers.has(s.id))return;const o=this.ensureRemote(s.id,s.color,s.custom),n=typeof s.ts=="number"?s.ts:this._now();this.bufferRemoteState(s.id,{t:n,pos:s.pos,rot:s.rot,fwd:s.fwd,anim:s.anim,nick:s.nick,color:s.color,custom:s.custom?{...s.custom}:null}),o&&s.color&&((t=o.userData)==null?void 0:t.color)!==s.color&&this.applyColorToTorso(o,s.color),this.applyRemoteCustomization(o,s.custom),o&&o.userData&&(o.userData.custom=s.custom?{...s.custom}:null)}else if(s.type==="hit")this.onHit&&this.onHit(s);else if(s.type==="host-changed")this.isHost=s.hostId===this.id,this.onHostChanged&&this.onHostChanged(this.isHost);else if(s.type==="start-countdown")this.onCountdown&&this.onCountdown(s.duration||10);else if(s.type==="match-start")this.onMatchStart&&this.onMatchStart(),this.matchLive=!0;else if(s.type==="settings")this.roomSettings=s.settings,this.onSettings&&this.onSettings(s.settings);else if(s.type==="zombie-hit"){if(this.isHost&&this.enemyManager&&s.id&&typeof s.amount=="number"){const o=this.enemyManager.applyRemoteZombieHit(s.id,s.amount);typeof o=="number"&&this.sendZombieState(s.id,o)}}else if(s.type==="zombie-state")this.enemyManager&&s.id&&typeof s.health=="number"&&this.enemyManager.syncZombieState(s.id,s.health);else if(s.type==="player-dead")s.id&&(this.deadPeers.add(s.id),this.killRemote(s.id),this.onPeerDeath&&this.onPeerDeath(s.id));else if(s.type==="pong"&&typeof s.ts=="number"){const o=this._now()-s.ts;this.netStats.lastPing=o}}}catch(i){console.warn("Multiplayer parse error:",i)}}ensureRemote(e,t=null,i=null){if(!e||e===this.id||this.deadPeers&&this.deadPeers.has(e))return null;if(this.others.has(e))return this.others.get(e);const s=this.clonePlayerAvatar(t);if(s)return s.userData={...s.userData||{},gameId:e,gameName:"Player",color:t||this.color},this.applyColorToTorso(s,t||this.color),s.traverse(c=>{c.isMesh&&(c.castShadow=!1,c.receiveShadow=!0)}),this.scene.add(s),this.others.set(e,s),s.userData&&(s.userData.custom=i?{...i}:null),this.applyRemoteCustomization(s,i),s;const o=new S(.8,1.8,.8),n=new x({color:t||this.color,emissive:0,roughness:.7}),a=new w(o,n);return a.position.y=1,a.userData={gameId:e,gameName:"Player"},this.scene.add(a),this.others.set(e,a),a.userData&&(a.userData.custom=i?{...i}:null),this.applyRemoteCustomization(a,i),a}removeRemote(e){const t=this.others.get(e);if(t){if(t.userData&&t.userData.label&&t.userData.label.parentNode)try{t.userData.label.parentNode.removeChild(t.userData.label)}catch{}try{this.scene.remove(t)}catch{}this.others.delete(e)}this.remoteStates.delete(e)}killRemote(e){const t=this.others.get(e);if(t){try{t.rotation.x=-Math.PI/2,t.userData.dead=!0}catch{}setTimeout(()=>{this.removeRemote(e)},3500)}}clonePlayerAvatar(e=null){if(!this.player||!this.player.mesh)return null;try{const t=this.player.mesh.clone(!0),i={leftArm:null,rightArm:null,leftLeg:null,rightLeg:null};return t.traverse(s=>{if(s.isMesh&&(s.castShadow=!0,s.receiveShadow=!0,s.material&&s.material.clone&&(s.material=s.material.clone()),s.geometry&&s.geometry.clone&&(s.geometry=s.geometry.clone()),e&&s.material&&!Array.isArray(s.material))){const o=s.userData&&s.userData.gameName?s.userData.gameName.toLowerCase():"";(o.includes("body")||o.includes("torso")||o.includes("shirt")||o.includes("clothes")||s.geometry&&s.geometry.parameters&&Math.abs(s.geometry.parameters.width-.6)<.05)&&(s.material=s.material.clone(),s.material.color=new ie(e))}s.userData&&(s.userData={...s.userData}),s.name==="leftArmPivot"?i.leftArm=s:s.name==="rightArmPivot"?i.rightArm=s:s.name==="leftLegPivot"?i.leftLeg=s:s.name==="rightLegPivot"&&(i.rightLeg=s)}),t.userData={...t.userData||{},pivots:i},t}catch(t){return console.warn("Failed to clone player avatar:",t),null}}applyRemoteAnimation(e,t){var s,o,n,a;if(!t||!e||!e.userData)return;const i=e.userData.pivots||{};try{i.leftArm&&typeof((s=t==null?void 0:t.arms)==null?void 0:s.leftX)=="number"&&(i.leftArm.rotation.x=t.arms.leftX),i.rightArm&&typeof((o=t==null?void 0:t.arms)==null?void 0:o.rightX)=="number"&&(i.rightArm.rotation.x=t.arms.rightX),i.leftLeg&&typeof((n=t==null?void 0:t.legs)==null?void 0:n.leftX)=="number"&&(i.leftLeg.rotation.x=t.legs.leftX),i.rightLeg&&typeof((a=t==null?void 0:t.legs)==null?void 0:a.rightX)=="number"&&(i.rightLeg.rotation.x=t.legs.rightX)}catch{}}update(e){var m,f,d;if(this.updateRemoteInterpolation(),this.sampleNetRates(),!this.socket||this.socket.readyState!==WebSocket.OPEN||(this.lastSend+=e,this.heartbeatTimer+=e,this.player&&!this.player.isDead&&(this.lastPingSent+=e,this.lastPingSent>=this.pingInterval&&(this.sendPing(),this.lastPingSent=0)),this.lastSend<this.sendInterval)||(this.lastSend=0,!this.player||!this.player.mesh)||this.player.isDead)return;const t=this.player.mesh.position,i={arms:{leftX:this.player.leftArmPivot?this.player.leftArmPivot.rotation.x:0,rightX:this.player.rightArmPivot?this.player.rightArmPivot.rotation.x:0},legs:{leftX:this.player.leftLegPivot?this.player.leftLegPivot.rotation.x:0,rightX:this.player.rightLegPivot?this.player.rightLegPivot.rotation.x:0}};let s=0,o={x:0,z:1};if(this.player&&this.player.camera&&this.player.camera.getWorldDirection){const u=new B;this.player.camera.getWorldDirection(u),u.y=0,u.lengthSq()<1e-6&&this.player.mesh&&this.player.mesh.rotation?(s=this.player.mesh.rotation.y,o={x:Math.sin(s),z:Math.cos(s)}):(u.normalize(),s=Math.atan2(u.x,u.z),o={x:u.x,z:u.z})}else{const u=typeof this.player.yaw=="number"?this.player.yaw:this.player.mesh&&this.player.mesh.rotation?this.player.mesh.rotation.y:0;s=this._wrapAngle(u),o={x:Math.sin(s),z:Math.cos(s)}}s=this._wrapAngle(s+Math.PI),o={x:Math.sin(s),z:Math.cos(s)};const n={type:"state",pos:{x:t.x,y:t.y,z:t.z},rot:s,fwd:o,nick:this.nick,color:this.color,anim:i,ts:this._now(),custom:{...this.getCustomization()}};let a=!1;this.lastSentPos?t.distanceTo?a=t.distanceTo(new B(this.lastSentPos.x,this.lastSentPos.y,this.lastSentPos.z))>.015:a=Math.abs(t.x-(((m=this.lastSentPos)==null?void 0:m.x)||0))>.015||Math.abs(t.y-(((f=this.lastSentPos)==null?void 0:f.y)||0))>.015||Math.abs(t.z-(((d=this.lastSentPos)==null?void 0:d.z)||0))>.015:a=!0;const c=`${i.arms.leftX.toFixed(3)},${i.arms.rightX.toFixed(3)},${i.legs.leftX.toFixed(3)},${i.legs.rightX.toFixed(3)}`,h=this.lastAnimSig!==c,r=Math.abs(this._angleDiff(this.lastSentRot??s,s))>.02,l=this.heartbeatTimer>=5;if(a||h||r||l){const u=JSON.stringify(n);try{this.socket.send(u)}catch{}this.trackTx(u.length),this.lastSentPos={x:t.x,y:t.y,z:t.z},this.lastAnimSig=c,this.lastSentRot=s,l&&(this.heartbeatTimer=0)}}dispose(){if(this._manualClose=!0,this.socket)try{this.socket.close()}catch{}this.others.forEach(e=>{try{this.scene.remove(e)}catch{}}),this.others.clear()}updateLabel(e,t){if(e.userData&&e.userData.label)try{e.userData.label.style.display="none"}catch{}e.userData&&(e.userData.nick=t||"Player")}sendHit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const s=JSON.stringify({type:"hit",targetId:e,amount:t});try{this.socket.send(s)}catch{}this.trackTx(s.length)}getPeerCount(){return 1+this.others.size}sendJoin(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify({type:"join",room:this.roomCode,nick:this.nick,color:this.color,custom:this.getCustomization()});this.socket.send(e),this.trackTx(e.length)}catch{}}sendStart(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN))try{const e=JSON.stringify({type:"start"});this.socket.send(e),this.trackTx(e.length)}catch{}}sendSettings(e){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&!(!this.isHost||!e))try{const t=JSON.stringify({type:"settings",settings:e});this.socket.send(t),this.trackTx(t.length)}catch{}}sendDeath(){if(!(!this.socket||this.socket.readyState!==WebSocket.OPEN)&&this.id)try{const e=JSON.stringify({type:"player-dead",id:this.id});this.socket.send(e),this.trackTx(e.length)}catch{}}isMatchLive(){return this.matchLive===!0}resetMatchState(){this.deadPeers.clear(),this.matchLive=!1}bufferRemoteState(e,t){if(!e||!t)return;const i=this.remoteStates.get(e)||[];if(typeof t.rot=="number"){const s=this.remoteLastYaw.get(e),o=this._unwrapAngle(t.rot,s);t.rot=o,this.remoteLastYaw.set(e,o)}for(i.push(t);i.length>24;)i.shift();this.remoteStates.set(e,i)}applyRemoteCustomization(e,t){if(!e||!t)return;const i=e.getObjectByName("playerHead");if(!i)return;this.removeNodesByRole(i,"playerMouth");const s=this._buildMouthMesh(t.mouthStyle||"serious");s&&i.add(s),this.setHatVisibility(i,t.showHat!==!1)}removeNodesByRole(e,t){if(!e)return;const i=[];e.traverse(s=>{s.userData&&s.userData.role===t&&i.push(s)}),i.forEach(s=>{s.parent&&s.parent.remove(s)})}setHatVisibility(e,t){e&&e.traverse(i=>{i.userData&&i.userData.role==="playerHat"&&(i.visible=t)})}_buildMouthMesh(e){const t=(e||"serious").toLowerCase(),i=new x({color:2824976,roughness:.6,metalness:0});let s=null;if(t==="smile"){const o=new T;o.userData={role:"playerMouth"},o.name="playerMouth";const n=i.clone(),a=new w(new S(.08,.04,.02),n),c=a.clone(),h=a.clone();a.position.set(-.1,-.15,.26),a.rotation.z=-.2,c.position.set(0,-.16,.26),h.position.set(.1,-.15,.26),h.rotation.z=.2,[a,c,h].forEach(r=>{r.userData={role:"playerMouth"},r.name="playerMouthSeg"}),o.add(a,c,h),s=o}else if(t==="angry"){const o=new x({color:5901324,roughness:.4});s=new w(new S(.26,.05,.02),o),s.position.set(0,-.16,.26),s.rotation.z=-.18}else if(t==="surprised")s=new w(new K(.06,.06,.02,20),i),s.position.set(0,-.14,.26),s.rotation.x=Math.PI/2;else{if(t==="none")return null;s=new w(new S(.22,.06,.02),i),s.position.set(0,-.16,.26)}return s.castShadow=!1,s.receiveShadow=!1,s.userData||(s.userData={}),s.userData.role="playerMouth",s.name=s.name||"playerMouth",s}updateRemoteInterpolation(){if(!this.remoteStates||this.remoteStates.size===0)return;const t=this._now()-this.interpDelayMs;this.remoteStates.forEach((i,s)=>{var J,X,Z,Q,Y,N,ae,ee,V,G,U,oe,ne,te,ce,$,z,de;if(!i||i.length===0)return;const o=this.others.get(s);if(!o)return;for(;i.length>2&&t-i[0].t>this.maxBufferMs;)i.shift();const n=i[i.length-1];let a=i[0],c=n;for(let A=1;A<i.length;A++)if(i[A].t>=t){a=i[A-1]||i[A],c=i[A];break}const h=c.t-a.t;let r=h>0?(t-a.t)/h:1;if(t>n.t&&t-n.t<=this.maxExtrapMs&&i.length>=2){const A=i[i.length-2],W=Math.max(1,n.t-A.t),me=(n.pos.x-A.pos.x)/W,pe=(n.pos.y-A.pos.y)/W,fe=(n.pos.z-A.pos.z)/W,re=t-n.t;this._tmpVec.set(n.pos.x+me*re,n.pos.y+pe*re,n.pos.z+fe*re),o.position.copy(this._tmpVec),o.rotation&&(typeof n.rot=="number"?o.rotation.y=this._wrapAngle(n.rot+this.remoteFaceOffset):n.fwd&&typeof n.fwd.x=="number"&&typeof n.fwd.z=="number"&&(o.rotation.y=this._wrapAngle(Math.atan2(n.fwd.x,n.fwd.z)+this.remoteFaceOffset))),this.applyRemoteAnimation(o,n.anim),this.updateLabel(o,n.nick);return}r=Math.min(1,Math.max(0,r));const l=((J=a.pos)==null?void 0:J.x)??0,m=((X=a.pos)==null?void 0:X.y)??0,f=((Z=a.pos)==null?void 0:Z.z)??0,d=((Q=c.pos)==null?void 0:Q.x)??l,u=((Y=c.pos)==null?void 0:Y.y)??m,p=((N=c.pos)==null?void 0:N.z)??f;this._tmpVec.set(l+(d-l)*r,m+(u-m)*r,f+(p-f)*r),o.position.copy(this._tmpVec);const v=typeof a.rot=="number"?a.rot:typeof((ae=a.fwd)==null?void 0:ae.x)=="number"&&typeof((ee=a.fwd)==null?void 0:ee.z)=="number"?Math.atan2(a.fwd.x,a.fwd.z):o.rotation.y||0,g=typeof c.rot=="number"?c.rot:typeof((V=c.fwd)==null?void 0:V.x)=="number"&&typeof((G=c.fwd)==null?void 0:G.z)=="number"?Math.atan2(c.fwd.x,c.fwd.z):v,M=v+this.remoteFaceOffset,k=g+this.remoteFaceOffset,b=A=>{for(;A>Math.PI;)A-=Math.PI*2;for(;A<-Math.PI;)A+=Math.PI*2;return A},D=k-M,C=M+D*r;o.rotation&&(o.rotation.y=b(C+this.remoteFaceOffset));const P=(A,W)=>(typeof A!="number"&&(A=0),typeof W!="number"&&(W=A),A+(W-A)*r),L=a.anim||{},H=c.anim||{},le={arms:{leftX:P((U=L==null?void 0:L.arms)==null?void 0:U.leftX,(oe=H==null?void 0:H.arms)==null?void 0:oe.leftX),rightX:P((ne=L==null?void 0:L.arms)==null?void 0:ne.rightX,(te=H==null?void 0:H.arms)==null?void 0:te.rightX)},legs:{leftX:P((ce=L==null?void 0:L.legs)==null?void 0:ce.leftX,($=H==null?void 0:H.legs)==null?void 0:$.leftX),rightX:P((z=L==null?void 0:L.legs)==null?void 0:z.rightX,(de=H==null?void 0:H.legs)==null?void 0:de.rightX)}};this.applyRemoteAnimation(o,le);const se=c.custom||a.custom||(o.userData?o.userData.custom:null);this.applyRemoteCustomization(o,se),o.userData&&(o.userData.custom=se?{...se}:null),this.updateLabel(o,c.nick||a.nick)})}sendPing(){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return;const e={type:"ping",ts:this._now()},t=JSON.stringify(e);try{this.socket.send(t)}catch{}this.trackTx(t.length)}trackTx(e){!e||e<=0||(this.netStats.txBytes+=e)}sendZombieHit(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const i=JSON.stringify({type:"zombie-hit",id:e,amount:t});try{this.socket.send(i)}catch{}this.trackTx(i.length)}sendZombieState(e,t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN||!e||typeof t!="number")return;const i=JSON.stringify({type:"zombie-state",id:e,health:t});try{this.socket.send(i)}catch{}this.trackTx(i.length)}trackRx(e){!e||e<=0||(this.netStats.rxBytes+=e)}sampleNetRates(){const e=this._now(),t=e-this.netStats.lastSample;if(t<1e3)return;const i=t/1e3,s=this.netStats.txBytes/i,o=this.netStats.rxBytes/i;for(this.netStats.txPerSec=s,this.netStats.rxPerSec=o,this.netStats.history.push({t:e,tx:s,rx:o,ping:this.netStats.lastPing||null});this.netStats.history.length>60;)this.netStats.history.shift();this.netStats.txBytes=0,this.netStats.rxBytes=0,this.netStats.lastSample=e}getNetStats(){return this.netStats}getCustomization(){return this.player?{mouthStyle:this.player.mouthStyle||"serious",showHat:this.player.showHat!==!1}:{mouthStyle:"serious",showHat:!0}}setEnemyManager(e){this.enemyManager=e}_wrapAngle(e){let t=e;for(;t>Math.PI;)t-=Math.PI*2;for(;t<-Math.PI;)t+=Math.PI*2;return t}_angleDiff(e,t){return this._wrapAngle(e-t)}_unwrapAngle(e,t){if(typeof t!="number")return e;let i=e,s=i-t;for(;s>Math.PI;)i-=Math.PI*2,s=i-t;for(;s<-Math.PI;)i+=Math.PI*2,s=i-t;return i}}function oi({maxLines:I=400,autoShow:e=!1}={}){const t=[],i={log:console.log.bind(console),info:console.info.bind(console),warn:console.warn.bind(console),error:console.error.bind(console)},s=document.createElement("div");s.id="debug-overlay",s.className="debug-overlay hidden";const o=document.createElement("div");o.className="debug-overlay-header",o.innerHTML="<strong>DEBUG</strong>";const n=document.createElement("div");n.className="debug-overlay-actions";const a=document.createElement("button");a.textContent="Clear";const c=document.createElement("button");c.textContent="Close",n.appendChild(a),n.appendChild(c),o.appendChild(n);const h=document.createElement("div");h.className="debug-overlay-list",s.appendChild(o),s.appendChild(h),document.body.appendChild(s),o.style.cursor="move";let r=!1,l=0,m=0;function f(b){if(!r)return;const D=Math.max(0,Math.min(window.innerWidth-s.offsetWidth,b.clientX-l)),C=Math.max(0,Math.min(window.innerHeight-s.offsetHeight,b.clientY-m));s.style.left=D+"px",s.style.top=C+"px",s.style.right="auto"}function d(b){r=!1,window.removeEventListener("pointermove",f),window.removeEventListener("pointerup",d);try{b&&b.pointerId&&s.releasePointerCapture&&s.releasePointerCapture(b.pointerId)}catch{}}o.addEventListener("pointerdown",b=>{try{const D=s.getBoundingClientRect();s.style.left=D.left+"px",s.style.top=D.top+"px",s.style.position="fixed",s.style.transform="none",s.style.right="auto",l=b.clientX-D.left,m=b.clientY-D.top,r=!0,window.addEventListener("pointermove",f),window.addEventListener("pointerup",d);try{s.setPointerCapture&&s.setPointerCapture(b.pointerId)}catch{}}catch{}},{passive:!1});function u(){h.innerHTML="";const b=Math.max(0,t.length-I);for(let D=b;D<t.length;D++){const C=document.createElement("div");C.className="debug-line debug-"+t[D].level;const P=new Date(t[D].ts).toLocaleTimeString();C.textContent=`[${P}] ${t[D].level.toUpperCase()}: ${t[D].msg}`,h.appendChild(C)}h.scrollTop=h.scrollHeight}function p(b,D){try{const C=D.map(P=>{try{return typeof P=="string"?P:JSON.stringify(P)}catch{return String(P)}}).join(" ");t.push({level:b,msg:C,ts:Date.now()}),t.length>I*2&&t.splice(0,t.length-I*2),u()}catch{}}console.log=function(...b){i.log(...b),p("log",b)},console.info=function(...b){i.info(...b),p("info",b)},console.warn=function(...b){i.warn(...b),p("warn",b)},console.error=function(...b){i.error(...b),p("error",b)};function v(b,D,C,P,L){typeof b=="string"?p("error",[b+" "+(D||"")+":"+(C||"?")]):b&&b.message&&p("error",[b.message,b.error||L])}function g(b){try{p("error",["UnhandledRejection",b&&b.reason?b.reason:b])}catch{}}window.addEventListener("error",v),window.addEventListener("unhandledrejection",g),a.addEventListener("click",()=>{t.length=0,u()}),c.addEventListener("click",()=>k());function M(){s.classList.remove("hidden")}function k(){s.classList.add("hidden")}return e&&M(),{show:M,hide:k,destroy(){console.log=i.log,console.info=i.info,console.warn=i.warn,console.error=i.error,window.removeEventListener("error",v),window.removeEventListener("unhandledrejection",g);try{s.remove()}catch{}},logs:t}}const ue=(()=>{try{return typeof navigator>"u"?!1:/Mobi|Android|iPhone|iPad|Tablet|Mobile/i.test(navigator.userAgent)||window.matchMedia&&window.matchMedia("(pointer: coarse)").matches}catch{return!1}})();window.addEventListener("unhandledrejection",I=>{try{const e=I.reason,t=e&&e.message?e.message:String(e);if(t&&t.includes("If you see this error we have a bug")){console.warn("Suppressed Chromium UnknownError:",t),I.preventDefault&&I.preventDefault();return}}catch{}});class Ie{constructor(){this.scene=new yt,this.scene.background=new ie(8900331),this.scene.fog=new wt(8900331,20,100),this._animationStarted=!1,this._selectedMode="arcade",this._defaultRandom=Math.random,this._currentRandomSeed=null,this.matchSettings=null,this.lastPlaySettings=null,this.aiObjects=[],this.aiMaxAiObjects=200,this.renderer=new vt({antialias:!0});const e=ue?1:1.5;this.renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,e)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=Mt,document.getElementById("game-container").appendChild(this.renderer.domElement),this._renderScaleApplied=this.renderer.getPixelRatio(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.forceFixedMultiplayerSpawn=!1;const t=new Oe(16777215,.6);this.scene.add(t);const i=new Be(16777215,.8);i.position.set(50,100,50),i.castShadow=!0,i.shadow.camera.left=-100,i.shadow.camera.right=100,i.shadow.camera.top=100,i.shadow.camera.bottom=-100,i.shadow.camera.near=.1,i.shadow.camera.far=160,i.shadow.mapSize.width=1024,i.shadow.mapSize.height=1024,this.scene.add(i),this.dirLight=i,this.camera=new bt(75,window.innerWidth/window.innerHeight,.1,1e3),this.clock=new St,this._pickRaycaster=new j,this._objectClickHandler=null,this._objectClickTarget=null,this._longPressTimer=null,this.hotkeyModalVisible=!1,this.isPaused=!1,this.pauseMenu=document.getElementById("pause-menu"),this.bgAudio=null,this.bgMusicVolume=.5,this._endSequenceAudio=null,this._prevBgVolume=null,this.autoPerfEnabled=!1,this._autoPerfTimer=0,this._renderScaleApplied=1,this.sfxVolume=.7,document.addEventListener("keydown",s=>{if(s.code==="Escape"&&this.togglePause(),this.player&&this.player.gameMode==="studio")if(s.code==="KeyL")try{this.spawnStudioDrops()}catch(o){console.warn("Studio drop failed:",o)}else s.code==="KeyH"&&this.toggleHotkeyModal(!this.hotkeyModalVisible)}),this.setupMenu(),this.setupLongPressMenu(),this.setMenuOpenState(!0),document.addEventListener("pointerlockerror",s=>{s.preventDefault&&s.preventDefault(),console.warn("Pointer lock request failed or was cancelled.")})}applyGraphicsSettings(e={}){if(!this.renderer)return;const t=!!e.performanceMode,i=Math.max(.5,Math.min(1,(e.renderScale||100)/100)),s=ue?1:t?1.25:1.5,o=Math.min((window.devicePixelRatio||1)*i,s);this.renderer.setPixelRatio(o),this.renderer.setSize(window.innerWidth,window.innerHeight);const n=!t;if(this.renderer.shadowMap.enabled=n,this.dirLight&&this.dirLight.shadow){this.dirLight.castShadow=n;const a=t?512:1024;this.dirLight.shadow.mapSize.width=a,this.dirLight.shadow.mapSize.height=a}}applyDeterministicRandom(e){if(!e)return;this._currentRandomSeed=e;const t=String(e);let i=1779033703^t.length;for(let n=0;n<t.length;n++)i=Math.imul(i^t.charCodeAt(n),3432918353),i=i<<13|i>>>19;i=Math.imul(i^i>>>16,2246822507),i=(i^i>>>13)>>>0;let s=i;Math.random=()=>{s=s+1831565813|0;let n=Math.imul(s^s>>>15,1|s);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}spawnStudioDrops(){if(!(!this.itemManager||!this.player||this.player.gameMode!=="studio"))try{for(let e=0;e<3;e++)this.itemManager.spawnMatrixDropNearPlayer()}catch(e){console.warn("spawnStudioDrops error:",e)}}toggleHotkeyModal(e){const t=document.getElementById("hotkey-modal");t&&(t.classList.toggle("hidden",!e),t.setAttribute("aria-hidden",e?"false":"true"),this.hotkeyModalVisible=e)}toggleTouchLookArea(e){try{if(!this.touchControls)return;e?this.touchControls.lookArea?this.touchControls.lookArea.style.display="":this.touchControls.rebuildLookArea&&this.touchControls.rebuildLookArea():this.touchControls.destroyLookArea?this.touchControls.destroyLookArea():this.touchControls.lookArea&&(this.touchControls.lookArea.style.display="none")}catch{}}setHotbarVisible(e){const t=document.getElementById("hotbar");t&&(t.style.display=e?"flex":"none")}setMenuOpenState(e){document.body.classList.toggle("menu-open",!!e)}updateDebugToggleVisibility(e){const t=document.getElementById("debug-toggle-btn");if(t&&(t.classList.toggle("hidden",!e),!e&&window.debugOverlay&&typeof window.debugOverlay.hide=="function")){try{window.debugOverlay.hide()}catch{}try{localStorage.removeItem("showDebugOverlay")}catch{}}}assignMultiplayerSpawn(){if(!this.player||!this.world)return;const e=this.world&&typeof this.world.halfMapSize=="number"?this.world.halfMapSize-5:100;let t=null;const i=this._defaultRandom||Math.random;if(this.forceFixedMultiplayerSpawn)t={x:0,y:this.world&&typeof this.world.getHeightAt=="function"?this.world.getHeightAt(0,0):0,z:0};else for(let s=0;s<12;s++){const o=(i()*2-1)*e,n=(i()*2-1)*e;let a=0;if(this.world&&typeof this.world.getHeightAt=="function"&&(a=this.world.getHeightAt(o,n)),!this.multiplayer||this.multiplayer.others.size===0||Array.from(this.multiplayer.others.values()).every(h=>{if(!h||!h.position)return!0;const r=h.position.x-o,l=h.position.z-n;return Math.sqrt(r*r+l*l)>15})){t={x:o,y:a,z:n};break}}t||(t={x:0,y:0,z:0}),this.player.mesh.position.set(t.x,t.y,t.z),this.player.controls&&this.player.controls.getObject&&this.player.controls.getObject().position.set(t.x,t.y+1.6,t.z),this.player.camera&&this.player.camera.position.set(t.x,t.y+1.6,t.z)}setupMultiplayerLobbyUI(){const e=document.getElementById("mp-lobby"),t=document.getElementById("mp-start-btn"),i=document.getElementById("mp-lobby-status");if(!e||!t||!i)return;e.classList.remove("hidden");const s=this.multiplayer&&this.multiplayer.roomCode?this.multiplayer.roomCode:"PUBLIC";i.innerText=`Waiting in lobby (Room: ${s})`,t.classList.toggle("hidden",!(this.multiplayer&&this.multiplayer.isHost)),t.onclick=()=>{if(!this.multiplayer||!this.multiplayer.isHost)return;const o=typeof this.multiplayer.getPeerCount=="function"?Math.max(0,this.multiplayer.getPeerCount()-1):0,n=this.enemyManager?typeof this.enemyManager.targetCount=="number"?this.enemyManager.targetCount:this.enemyManager.enemies?this.enemyManager.enemies.length:0:0;if(o<=0&&n<=0){alert("Need at least 1 remote player or 1 NPC zombie before starting the match.");return}this.beginLobbyCountdown(10),this.multiplayer.sendStart()},this.lobbyCountdown=0,this.updateLobbyUI(this.multiplayer?this.multiplayer.isHost:!1)}updateLobbyUI(e){const t=document.getElementById("mp-start-btn");t&&t.classList.toggle("hidden",!e)}beginLobbyCountdown(e=10){this.matchPhase="countdown",this.lobbyCountdown=e;const t=document.getElementById("mp-lobby"),i=document.getElementById("mp-lobby-countdown");t&&t.classList.remove("hidden"),i&&(i.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`)}startMultiplayerMatch(){this.matchPhase="live",this.multiplayer&&(this.multiplayer.matchLive=!0),this.refreshMultiplayerTargets();const e=document.getElementById("mp-lobby");e&&e.classList.add("hidden"),this.lobbyCountdown=0}checkMultiplayerVictory(){if(!this.multiplayer)return;const e=this.multiplayer.deadPeers||new Set;let t=0;this.multiplayer.others&&this.multiplayer.others.size>0&&this.multiplayer.others.forEach((o,n)=>{e.has(n)||o&&o.userData&&o.userData.dead||(t+=1)});const i=this.player&&!this.player.isDead;(i?1:0)+t===1&&i&&(this.hud&&typeof this.hud.showVictory=="function"&&this.hud.showVictory(),this.multiplayer&&(this.multiplayer.matchLive=!1))}setupMenu(){const e=document.getElementById("main-menu"),t=document.getElementById("play-btn"),i=document.getElementById("setting-difficulty"),s=document.getElementById("setting-enemies"),o=document.getElementById("setting-storm"),n=document.getElementById("setting-storm-enabled"),a=document.getElementById("setting-map-size"),c=document.getElementById("map-size-val"),h=document.getElementById("setting-debug"),r=document.getElementById("setting-minimap"),l=document.getElementById("setting-music-volume"),m=document.getElementById("setting-music-volume-val"),f=document.getElementById("setting-sfx-volume"),d=document.getElementById("setting-sfx-volume-val"),u=document.getElementById("setting-camera"),p=document.getElementById("setting-mouth-style"),v=document.getElementById("setting-show-hat"),g=document.getElementById("setting-performance-mode"),M=document.getElementById("setting-auto-performance"),k=document.getElementById("setting-render-scale"),b=document.getElementById("render-scale-val"),D=document.getElementById("setting-touch-controls"),C=document.getElementById("setting-fullscreen"),P=document.getElementById("setting-game-mode"),L=document.getElementById("quit-btn"),H=document.getElementById("active-mode-label"),le=document.getElementById("active-mode-chip"),se=document.getElementById("float-btn"),J=document.getElementById("setting-openai-key"),X=document.getElementById("setting-groq-key"),Z=document.getElementById("setting-nvidia-key"),Q=document.getElementById("setting-mp-server"),Y=document.getElementById("setting-mp-seed"),N=document.getElementById("setting-mp-room"),ae=document.getElementById("mp-room-generate"),ee=document.getElementById("setting-mp-nickname"),V=document.getElementById("setting-mp-color"),G=document.getElementById("setting-mp-zombies"),U=document.getElementById("setting-mp-fixed-spawn"),oe=document.getElementById("setting-language"),ne=document.getElementById("hotkey-hint"),te=document.getElementById("hotkey-modal"),ce=document.getElementById("hotkey-modal-close"),$=document.getElementById("setting-arena-time"),z=document.getElementById("arena-time-val"),de=document.getElementById("setting-arena-respawn"),A=document.getElementById("setting-matrix-infinite-ammo"),W=document.getElementById("setting-matrix-show-ui"),me=document.getElementById("setting-matrix-ai-autospawn"),pe=document.getElementById("setting-matrix-ai-hints"),fe=document.getElementById("setting-studio-flight"),re=document.getElementById("setting-studio-show-grid"),Xe=document.getElementById("dash-toggle"),Ye=document.getElementById("perf-toggle"),Ae=document.getElementById("enemy-count-val"),Te=document.getElementById("storm-time-val"),ge=(y,E)=>{if(!y||!E)return;const _=()=>{E.innerText=y.value};y.addEventListener("input",_),y.addEventListener("change",_),_()},Se=(y,E)=>{if(!(typeof window>"u"||!window.localStorage))try{const _=window.localStorage.getItem("voxel-firecraft-settings"),R=_?JSON.parse(_):{};R[y]=E,window.localStorage.setItem("voxel-firecraft-settings",JSON.stringify(R))}catch{}},Le=(y,E)=>{y&&(y.addEventListener("pointerdown",_=>{try{_.preventDefault(),_.stopPropagation()}catch{}}),y.addEventListener("click",_=>{try{_.preventDefault(),_.stopPropagation()}catch{}const R=document.getElementById(E);if(!R)return;const he=R.classList.toggle("collapsed");Array.from(R.children).forEach(De=>{De!==y&&(De.style.display=he?"none":"")}),y.innerText=he?"+":""}))};Le(Xe,"dashboard"),Le(Ye,"perf-dashboard");const ze=localStorage.getItem("voxel-firecraft-settings");if(ze){const y=JSON.parse(ze);if(y.gameMode==="survival"&&(y.gameMode="arcade"),i.value=y.difficulty,s.value=y.enemyCount,o.value=y.stormTime,Ae.innerText=y.enemyCount,Te.innerText=y.stormTime,n&&(n.checked=y.stormEnabled!==!1),a&&c){const E=y.mapSize||ke;a.value=E,c.innerText=E}if(y.debugMode&&(h.checked=!0),r&&(r.checked=y.showMinimap!==!1),C&&(C.checked=!!y.fullscreen),y.musicVolume!==void 0&&l&&m){const E=parseInt(y.musicVolume,10);l.value=E,m.innerText=E,this.bgMusicVolume=E/100}if(f&&d&&y.sfxVolume!==void 0){const E=parseInt(y.sfxVolume,10);f.value=E,d.innerText=E,this.sfxVolume=E/100}if(y.cameraMode&&(u.value=y.cameraMode),p&&y.mouthStyle&&(p.value=y.mouthStyle),v&&(v.checked=y.showHat!==!1),g&&(g.checked=!!y.performanceMode),M&&(M.checked=!!y.autoPerformance),k&&b){const E=y.renderScale||100;k.value=E,b.innerText=E}if(y.useTouchControls!==void 0&&D&&(D.checked=!!y.useTouchControls),y.gameMode&&P&&(P.value=y.gameMode),y.gameMode&&(this._selectedMode=y.gameMode),oe&&y.language&&(oe.value=y.language),J&&(J.value=y.openaiKey||""),X&&(X.value=y.groqKey||""),Z&&(Z.value=y.nvidiaKey||""),Q&&(Q.value=y.mpServer||""),Y&&(Y.value=y.mpSeed||""),N&&(N.value=y.mpRoom||""),ee&&(ee.value=y.mpNick||""),V&&(V.value=y.mpColor||"#29b6f6"),G&&(G.checked=y.mpZombies!==!1),U&&(U.checked=!!y.mpFixedSpawn),$&&z){const E=y.arenaTime||parseInt($.value,10)||180;$.value=E,z.innerText=E}de&&(de.checked=y.arenaRespawn!==!1),A&&(A.checked=y.matrixInfiniteAmmo!==!1),W&&(W.checked=y.matrixShowUI!==!1),me&&(me.checked=y.matrixAiAutospawn!==!1),pe&&(pe.checked=y.matrixAiHints!==!1),fe&&(fe.checked=y.studioFlight!==!1),re&&(re.checked=y.studioShowGrid!==!1)}ge(s,Ae),ge(o,Te),ge(a,c),ge($,z),ge(k,b),ge(f,d),M&&M.addEventListener("change",()=>{const y=this.lastPlaySettings||{};y.autoPerformance=M.checked,this.autoPerfEnabled=y.autoPerformance,Se("autoPerformance",y.autoPerformance)}),g&&g.addEventListener("change",()=>{const y=this.lastPlaySettings||{};y.performanceMode=g.checked,this.applyGraphicsSettings(y),Se("performanceMode",g.checked)}),k&&k.addEventListener("change",()=>{const y=this.lastPlaySettings||{};y.renderScale=parseInt(k.value,10),this.applyGraphicsSettings(y),Se("renderScale",y.renderScale)}),v&&v.addEventListener("change",()=>{this.player&&typeof this.player.setHatVisible=="function"&&this.player.setHatVisible(v.checked),Se("showHat",v.checked)}),t.onclick=()=>{const y=this._selectedMode||"arcade";if(y==="multiplayer"&&this.multiplayer&&!this.multiplayer.isHost&&!this.multiplayer.roomSettings){alert("Waiting for host settings. Please try again in a moment.");return}const E={difficulty:y==="survival"?document.getElementById("setting-survival-difficulty")?document.getElementById("setting-survival-difficulty").value:"medium":i.value,enemyCount:parseInt(s.value),stormTime:parseInt(o.value),stormEnabled:n?n.checked:!0,mapSize:a?parseInt(a.value):ke,debugMode:h.checked,showMinimap:r?r.checked:!0,musicVolume:l?parseInt(l.value):Math.round(this.bgMusicVolume*100),musicEnabled:document.getElementById("setting-music-enabled")?document.getElementById("setting-music-enabled").checked:!0,cameraMode:u.value,mouthStyle:p?p.value:"serious",showHat:v?v.checked:!0,performanceMode:g?g.checked:!1,autoPerformance:M?M.checked:!1,renderScale:k?parseInt(k.value,10):100,sfxVolume:f?parseInt(f.value,10):70,language:oe?oe.value:"en",useTouchControls:D?D.checked:!1,fullscreen:C?C.checked:!1,gameMode:y,openaiKey:J?J.value:"",groqKey:X?X.value:"",nvidiaKey:Z?Z.value:"",mpServer:Q?Q.value:"",mpSeed:Y?Y.value.trim():"",mpRoom:N?N.value:"",mpNick:ee?ee.value:"",mpColor:V?V.value:"#29b6f6",mpZombies:G?G.checked:!0,mpFixedSpawn:U?U.checked:!1,arenaTime:$?parseInt($.value,10):180,arenaRespawn:de?de.checked:!0,matrixInfiniteAmmo:A?A.checked:!0,matrixShowUI:W?W.checked:!0,matrixAiAutospawn:me?me.checked:!0,matrixAiHints:pe?pe.checked:!0,studioFlight:fe?fe.checked:!0,studioShowGrid:re?re.checked:!0};this.lastPlaySettings=E,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(E)),this.updateDebugToggleVisibility(E.debugMode),this.applyGraphicsSettings(E),e.style.display="none",this.setMenuOpenState(!1),E.musicEnabled!==!1?this.playBackgroundMusic():this.stopBackgroundMusic(),this.requestFullscreenIfNeeded(E.fullscreen);const _=this.player&&this.world&&this.enemyManager,R=_&&this.player&&this.player.gameMode===y;if(_&&!R&&this.resetGameState(),this.player&&this.world&&this.enemyManager&&R){if(this.isPaused=!1,this.clock.getDelta(),t.innerText="PLAY GAME",this.player)try{this.player.lockControls()}catch{}if(this.hud&&(this.hud.settings=E),this.world){this.world.stormEnabled=E.stormEnabled!==!1;const he=this.world.stormEnabled&&this.world.gameMode!=="matrix"&&this.world.gameMode!=="studio"&&this.world.gameMode!=="matrix-ai";this.world.stormMesh?this.world.stormMesh.visible=he:he&&typeof this.world.createStormVisuals=="function"&&this.world.createStormVisuals()}this.player&&(this.player.mouthStyle=E.mouthStyle||"serious",typeof this.player.createMouth=="function"&&this.player.createMouth(this.player.mouthStyle)),this.setHotbarVisible(!0)}else t.innerText="PLAY GAME",this.startGame(E);if(ne){const he=E&&E.gameMode==="studio";ne.classList.toggle("hidden",!he)}},L&&(L.onclick=()=>{this.multiplayer&&typeof this.multiplayer.dispose=="function"&&this.multiplayer.dispose(),location.reload()}),se&&se.classList.add("hidden"),ae&&N&&(ae.onclick=()=>{const y=Math.random().toString(36).substr(2,5).toUpperCase();N.value=y;try{const E=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");E.mpRoom=y,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(E))}catch{}}),ne&&(ne.onclick=()=>this.toggleHotkeyModal(!0)),ce&&(ce.onclick=()=>this.toggleHotkeyModal(!1)),te&&te.addEventListener("click",y=>{y.target===te&&this.toggleHotkeyModal(!1)}),l&&(l.oninput=()=>{const y=parseInt(l.value,10);if(m&&(m.innerText=y),this.bgMusicVolume=y/100,this.bgAudio)try{this.bgAudio.volume=this.bgMusicVolume}catch{}});const Ee=document.getElementById("setting-music-enabled");Ee&&(Ee.onchange=()=>{Ee.checked?this.playBackgroundMusic():this.stopBackgroundMusic()}),D&&(D.onchange=()=>{try{const y=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}");y.useTouchControls=D.checked,localStorage.setItem("voxel-firecraft-settings",JSON.stringify(y))}catch{}}),this.setHotbarVisible(!1),this.setMenuOpenState(!0);const be=Array.from(document.querySelectorAll(".tab-btn")),$e=document.querySelectorAll(".tab-panel"),_e=y=>{if(!y)return;const E=y.getAttribute("data-tab");be.forEach(R=>R.classList.toggle("active",R===y)),$e.forEach(R=>{R.id===E?R.classList.remove("hidden"):R.classList.add("hidden")});const _=y.getAttribute("data-mode");_&&P&&(P.value=_,H&&(H.innerText=y.innerText),le&&(le.innerText=y.innerText)),_&&(this._selectedMode=_)};be.forEach(y=>y.addEventListener("click",()=>_e(y)));const He=this._selectedMode||(P?P.value:null),qe=(He?be.find(y=>y.getAttribute("data-mode")===He):null)||be.find(y=>y.classList.contains("active"))||be[0];_e(qe)}resetGameState(){if(this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState(),this.multiplayer&&typeof this.multiplayer.dispose=="function")try{this.multiplayer.dispose()}catch(e){console.warn("Dispose multiplayer failed:",e)}this.multiplayer=null,this.multiplayerEnemyBaseCount=0,this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.isPaused=!1,this.forceFixedMultiplayerSpawn=!1,this.matchSettings=null;try{this.scene.clear()}catch(e){console.warn("Scene clear failed:",e)}try{const e=new Oe(16777215,.6);this.scene.add(e);const t=new Be(16777215,.8);t.position.set(50,100,50),t.castShadow=!0,t.shadow.camera.left=-100,t.shadow.camera.right=100,t.shadow.camera.top=100,t.shadow.camera.bottom=-100,t.shadow.camera.near=.1,t.shadow.camera.far=160,t.shadow.mapSize.width=1024,t.shadow.mapSize.height=1024,this.scene.add(t)}catch(e){console.warn("Rebuild lights failed:",e)}this.player=null,this.world=null,this.enemyManager=null,this.itemManager=null,this.hud=null,this.matchSettings=null,this.lastPlaySettings=null,Math.random=this._defaultRandom,this._currentRandomSeed=null,this.multiplayer&&typeof this.multiplayer.resetMatchState=="function"&&this.multiplayer.resetMatchState()}startGame(e){this.clearAiObjects(),this.multiplayerDropTimer=0,this.multiplayerDropCooldown=0,this.multiplayerDropActive=!1,this.matchPhase="live",this.lobbyCountdown=0,this.victoryShown=!1;const t={...e};if(this.forceFixedMultiplayerSpawn=t.gameMode==="multiplayer"?!!e.mpFixedSpawn:!1,t.gameMode==="multiplayer"){const h=this.multiplayer&&!this.multiplayer.isHost&&this.multiplayer.roomSettings?this.multiplayer.roomSettings:null;if(!this.multiplayer||this.multiplayer.isHost||!h){const r=e.mpSeed||Math.random().toString(36).slice(2);this.matchSettings={mapSize:e.mapSize,enemyCount:e.enemyCount,stormEnabled:!1,seed:r,fixedSpawn:!!e.mpFixedSpawn}}else this.matchSettings=h;this.matchSettings&&(t.mapSize=this.matchSettings.mapSize,t.enemyCount=this.matchSettings.enemyCount,t.stormEnabled=this.matchSettings.stormEnabled,this.forceFixedMultiplayerSpawn=!!this.matchSettings.fixedSpawn,this.applyDeterministicRandom(this.matchSettings.seed||"mp-seed"))}if((t.gameMode==="matrix"||t.gameMode==="studio")&&(t.enemyCount=0,t.skipLoot=!0),t.gameMode==="multiplayer"&&(t.skipLoot=!0,t.stormEnabled=!1,e.mpZombies===!1&&(t.enemyCount=0)),t.gameMode==="survival"&&(t.stormEnabled=!1,t.mapSize=Math.max(100,t.mapSize)),this.survivalStartTime=performance.now(),this.survivalTime=0,this.lootDropEligible=!1,this.lootDropCooldown=0,this.multiplayerEnemyBaseCount=t.enemyCount||0,this.player=new Pe(this.camera,this.scene,null,t),typeof e.sfxVolume<"u"&&(this.player.sfxVolume=Math.max(0,Math.min(1,e.sfxVolume/100))),e&&e.mpColor){if(this.player.playerColor=e.mpColor,this.player.mesh)try{this.scene.remove(this.player.mesh)}catch{}this.player.createPlayerMesh()}this.player&&(this.player.setHatVisible(e.showHat!==!1),this.player.mouthStyle=e.mouthStyle||"serious",this.player.createMouth(this.player.mouthStyle)),t.gameMode==="multiplayer"?(this.matchPhase="lobby",this.multiplayer&&(this.multiplayer.matchLive=!1)):this.matchPhase="live",this.itemManager=new ti(this.scene,this.player,t),this.world=new Ht(this.scene,this.itemManager,t),this.player.worldObjects=this.world.objects,this.player.world=this.world,this.itemManager&&typeof this.itemManager.setWorld=="function"&&this.itemManager.setWorld(this.world);const i=document.getElementById("mp-lobby"),s=document.getElementById("mp-start-btn");if(i&&i.classList.add("hidden"),s&&s.classList.add("hidden"),t.gameMode==="matrix"&&this.itemManager&&typeof this.itemManager.spawnMatrixLoadout=="function"&&this.itemManager.spawnMatrixLoadout(this.player.position.x,this.player.position.z),t.gameMode==="multiplayer"&&this.assignMultiplayerSpawn(),t.gameMode==="multiplayer"?(this.multiplayer=new si({player:this.player,scene:this.scene,url:e.mpServer,nick:e.mpNick||"Player",color:e.mpColor||"#29b6f6",roomCode:e.mpRoom||"PUBLIC",settings:this.matchSettings}),e.mpServer||alert("Multiplayer server URL not set. Please configure it in the Multiplayer tab."),this.player&&typeof this.player.setMultiplayerClient=="function"&&this.player.setMultiplayerClient(this.multiplayer),this.multiplayer&&(this.multiplayer.onPeersChanged=()=>this.refreshMultiplayerTargets(),this.multiplayer.roomCode=e.mpRoom||"PUBLIC",this.multiplayer.onHostChanged=h=>{this.updateLobbyUI(h),h&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings)},this.multiplayer.onCountdown=h=>this.beginLobbyCountdown(h),this.multiplayer.onMatchStart=()=>this.startMultiplayerMatch(),this.multiplayer.onSettings=h=>{this.matchSettings=h;const r=this.multiplayer&&this.multiplayer.isHost,m=this.player&&this.player.gameMode==="multiplayer"&&h&&(this.world&&this.world.mapSize!==h.mapSize||this.multiplayerEnemyBaseCount!==h.enemyCount);if(!r&&h&&m&&this.lastPlaySettings){const f={...this.lastPlaySettings,mapSize:h.mapSize,enemyCount:h.enemyCount};this.resetGameState(),this.matchSettings=h,this.applyDeterministicRandom(h.seed||"mp-seed"),this.startGame(f)}},this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings),this.multiplayer.onPeerDeath=()=>{this.checkMultiplayerVictory()},this.updateLobbyUI(this.multiplayer.isHost),this.multiplayer.isHost&&this.matchSettings&&this.multiplayer.sendSettings(this.matchSettings))):this.multiplayer=null,t.gameMode==="matrix-ai"){t.enemyCount=0,t.skipLoot=!0;const h=document.getElementById("ai-panel");h&&h.classList.remove("hidden")}else{const h=document.getElementById("ai-panel");h&&h.classList.add("hidden")}this.hud=new Jt(this.player,this.world,e),this.player&&(this.player.hud=this.hud),this.hud&&typeof this.hud.setRenderer=="function"&&this.hud.setRenderer(this.renderer),this.hud&&typeof this.hud.setMultiplayer=="function"&&this.hud.setMultiplayer(this.multiplayer),this.enemyManager=new ei(this.scene,this.player,this.world,t),this.multiplayer&&typeof this.multiplayer.setEnemyManager=="function"&&this.multiplayer.setEnemyManager(this.enemyManager),t.gameMode==="multiplayer"&&(this.multiplayerEnemyBaseCount=t.enemyCount||0,typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(this.multiplayerEnemyBaseCount),this.multiplayer&&(this.multiplayer.onHit=h=>{if(!h||h.targetId!==this.multiplayer.id)return;const r=typeof h.amount=="number"?h.amount:0;r>0&&this.player&&typeof this.player.takeDamage=="function"&&this.player.takeDamage(r)})),this.player.setEnemyManager(this.enemyManager),t.gameMode==="multiplayer"&&(this.refreshMultiplayerTargets(),this.setupMultiplayerLobbyUI()),this.setupObjectInspector(),this.updateDebugToggleVisibility(!!e.debugMode),this.setHotbarVisible(!0);const o=document.getElementById("float-btn");o&&(t.gameMode==="studio"?(o.classList.remove("hidden"),o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF",o.onclick=()=>{if(this.player.isFloating=!this.player.isFloating,!this.player.isFloating){const h=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=h,this.player.velocity.y=0}o.innerText=this.player.isFloating?"FLOAT ON":"FLOAT OFF"}):o.classList.add("hidden"));const n=document.getElementById("storm-timer");if(n){const h=t.stormEnabled===!1||t.gameMode==="studio"||t.gameMode==="matrix"||t.gameMode==="matrix-ai"||t.gameMode==="multiplayer"||t.gameMode==="survival";n.classList.toggle("hidden",h)}const a=document.getElementById("survival-timer");if(a){const h=t.gameMode==="arcade"||t.gameMode==="survival";a.classList.toggle("hidden",!h)}window.addEventListener("resize",()=>this.onWindowResize(),!1),this.renderer.domElement.addEventListener("pointerdown",()=>{if(!ue){try{const h=document.getElementById("main-menu")&&document.getElementById("main-menu").style.display!=="none",r=this.player&&this.player.gameMode==="studio";if(this.isPaused||h||r)return;this.player&&!this.player.isDead&&this.player.lockControls()}catch(h){console.warn("Pointer lock request skipped or failed:",h)}this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic()}}),this.setupPauseMenu();try{const h=typeof navigator<"u"&&/Mobi|Android|iPhone|iPad|iPod|Tablet/i.test(navigator.userAgent),r=typeof window<"u"&&window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;(!!e.useTouchControls||h||r)&&(this.touchControls=new ii(this.player))}catch{}if(this.setupStudioPalette(t),this.refreshStudioPaletteVisibility(),this.setupAiPanel(),!ue&&this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch(h){console.warn("Pointer lock on start skipped/failed:",h)}this._animationStarted||(this._animationStarted=!0,this.animate())}setupLongPressMenu(){if(!ue)return;const e=document.getElementById("ui-layer")||document.body;if(!e)return;const t=s=>{try{if(s.touches&&s.touches.length>1)return;this._longPressTimer&&clearTimeout(this._longPressTimer),this._longPressTimer=setTimeout(()=>{this._longPressTimer=null,this.showPauseMenu()},800)}catch{}},i=()=>{this._longPressTimer&&(clearTimeout(this._longPressTimer),this._longPressTimer=null)};e.addEventListener("touchstart",t,{passive:!0}),e.addEventListener("touchend",i),e.addEventListener("touchcancel",i),e.addEventListener("touchmove",i)}setupAiPanel(){const e=document.getElementById("ai-panel"),t=document.getElementById("ai-send"),i=document.getElementById("ai-prompt"),s=document.getElementById("ai-log"),o=document.getElementById("ai-provider");if(!e||!t||!i||!s)return;const n=(h,r="")=>{const l=document.createElement("div");l.textContent=h,r&&(l.className=r),s.appendChild(l),s.scrollTop=s.scrollHeight};t.onclick=()=>{const h=i.value.trim();h&&(n(`You: ${h}`,"ai-user"),n("AI: (stub) Interpreter not wired. Imagine this runs your Three.js code.","ai-bot"),i.value="")};const a=`You are a level-building assistant for a Three.js sandbox. Respond ONLY with a JSON object:
{
  "actions": [
    {
      "action": "add",
      "type": "box" | "sphere" | "cylinder" | "plane",
      "pos": [x,y,z],
      "size": [sx,sy,sz],
      "color": "#rrggbb"
    }
  ]
}
Constraints: numbers are in meters, keep |x|,|z| <= 150, size in [0.2, 40]. No functions, no code, no prose, no markdown.`,c=async h=>{const r=document.getElementById("setting-openai-key"),l=r&&r.value?r.value.trim():"";if(!l)return n("Erro: configure a chave OpenAI em Settings.","ai-error"),"";const m={model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:h}],temperature:.2,max_tokens:2e3,response_format:{type:"json_object"}},f=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(m)});if(!f.ok){const p=await f.text();return n(`Erro OpenAI: ${f.status} ${p}`,"ai-error"),""}const d=await f.json(),u=d&&d.choices&&d.choices[0]&&d.choices[0].message?d.choices[0].message.content:"";return n(`AI: ${u||"(vazio)"}`,"ai-bot"),u||""};t.onclick=async()=>{const h=i.value.trim();if(!h)return;n(`You: ${h}`,"ai-user"),i.value="";const r=o?o.value:"openai";t.disabled=!0,t.innerText="Enviando...";try{if(r==="openai"){const l=await c(h);if(l){const m=this.parseAiActions(l,n);if(m&&m.length){const f=this.applyAiActions(m,n);n(`Aplicado: ${f} objeto(s)`,"ai-info")}}}else n(`Provider ${r} no suportado.`,"ai-error")}catch(l){n(`Erro na requisio: ${l.message||l}`,"ai-error")}finally{t.disabled=!1,t.innerText="Send to AI"}}}parseAiActions(e,t){const i=t||(()=>{});let s=null;try{s=JSON.parse(e)}catch{return i("Falha ao parsear JSON da AI.","ai-error"),[]}if(s&&s.actions&&Array.isArray(s.actions)&&(s=s.actions),!Array.isArray(s))return i("Resposta no  uma lista de aes.","ai-error"),[];const o=(r,l,m)=>Math.min(m,Math.max(l,r)),n=new Set(["box","sphere","cylinder","plane"]),a=/^#([0-9a-fA-F]{6})$/,c=this.aiMaxAiObjects||200,h=[];for(const r of s){if(!r||r.action!=="add"||!n.has(r.type))continue;const l=Array.isArray(r.pos)?r.pos.slice(0,3):[0,0,0],m=Array.isArray(r.size)?r.size.slice(0,3):[1,1,1],f=[o(Number(l[0]??0),-150,150),o(Number(l[1]??0),-10,200),o(Number(l[2]??0),-150,150)],d=[o(Math.abs(Number(m[0]??1)),.2,40),o(Math.abs(Number(m[1]??1)),.2,40),o(Math.abs(Number(m[2]??1)),.2,40)],u=typeof r.color=="string"&&a.test(r.color)?r.color:"#cccccc";if(h.push({type:r.type,pos:f,size:d,color:u}),h.length>=c)break}return h.length||i("Nenhuma ao vlida na resposta.","ai-error"),h}clearAiObjects(){this.aiObjects||(this.aiObjects=[]),this.aiObjects.forEach(e=>{try{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose&&e.geometry.dispose(),e.material&&e.material.dispose&&e.material.dispose()}catch{}}),this.aiObjects=[]}applyAiActions(e,t){const i=t||(()=>{});if(!e||!e.length)return 0;if(!this.scene||!this.player||this.player.gameMode!=="matrix-ai")return i("Aes ignoradas: no est no modo Matrix AI Builder.","ai-error"),0;this.clearAiObjects();const s=this.aiMaxAiObjects||200,o=[],n=new Be(16777215,.2);return n.position.set(0,10,0),this.scene.add(n),o.push(n),e.slice(0,s).forEach(a=>{try{let c=null;const h=new x({color:new ie(a.color),metalness:.05,roughness:.85});if(a.type==="box")c=new S(a.size[0],a.size[1],a.size[2]);else if(a.type==="sphere"){const l=a.size[0]/2;c=new Ce(l,20,16)}else if(a.type==="cylinder"){const l=a.size[0]/2;c=new K(l,l,a.size[1],16)}else a.type==="plane"&&(c=new q(a.size[0],a.size[2]));if(!c)return;const r=new w(c,h);r.position.set(a.pos[0],a.pos[1],a.pos[2]),a.type==="plane"&&(r.rotation.x=-Math.PI/2),this.scene.add(r),o.push(r)}catch(c){i("Falha ao criar objeto: "+c.message,"ai-error")}}),this.aiObjects=o,o.length}refreshStudioPaletteVisibility(){const e=document.getElementById("studio-palette");if(!e)return;const t=this.player&&this.player.gameMode==="studio"&&!this.isPaused;e.classList.toggle("hidden",!t)}refreshMultiplayerTargets(){if(!this.player||this.player.gameMode!=="multiplayer"||!this.enemyManager)return;const e=typeof this.multiplayerEnemyBaseCount=="number"?this.multiplayerEnemyBaseCount:this.enemyManager.enemies.length;this.matchPhase==="live"&&typeof this.enemyManager.setTargetCount=="function"?this.enemyManager.setTargetCount(e):this.matchPhase!=="live"&&typeof this.enemyManager.setTargetCount=="function"&&this.enemyManager.setTargetCount(0)}setupStudioPalette(e){const t=document.getElementById("studio-palette");if(!t)return;const i=e&&(e.gameMode==="studio"||e.gameMode==="matrix-ai");if(t.classList.toggle("hidden",!i),!i)return;this.initStudioPaletteDrag(t),t.querySelectorAll("button").forEach(n=>{if(n._boundStudio)return;n._boundStudio=!0;const a=h=>{if(h&&h.stopPropagation&&h.stopPropagation(),!this.player||!this.world)return;const r=n.getAttribute("data-action");if(r==="resume"){if(this.isPaused=!1,this.player&&this.player.controls&&!this.player.controls.isLocked)try{this.player.lockControls()}catch{}const u=document.getElementById("main-menu");u&&(u.style.display="none"),this.setMenuOpenState(!1),this.setHotbarVisible(!0);try{t.classList.add("hidden")}catch{}if(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0),this.player&&this.player.studioSelectionHelper){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}this.refreshStudioPaletteVisibility(),this.bgAudio&&this.bgAudio.paused&&this.playBackgroundMusic();return}else if(r==="float-toggle"){if(this.player&&this.player.gameMode==="studio"){this.player.isFloating=!this.player.isFloating;const u=this.player.isFloating?"FLOAT ON":"FLOAT OFF";if(n.innerText=u,!this.player.isFloating){const p=this.player.getSurfaceHeight(this.player.position.x,this.player.position.z);this.player.mesh.position.y=p,this.player.velocity.y=0}}return}else if(r==="spawn-npc"){const u=n.getAttribute("data-npc-type")||"normal";this.studioSelectedPrefab="npc",this.studioSelectedOptions={type:u},this.toggleTouchLookArea(!1);const p=document.getElementById("npc-menu");p&&p.classList.add("hidden");return}else if(r==="remove-npc"){if(this.studioRemoveNPCMode=!this.studioRemoveNPCMode,this.studioMoveMode=!1,n.style.background=this.studioRemoveNPCMode?"#e74c3c":"",n.textContent=this.studioRemoveNPCMode?"Remove NPC (Active)":"Remove NPC",this.studioRemoveNPCMode&&(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.player&&this.player.studioSelectionHelper)){try{this.player.scene.remove(this.player.studioSelectionHelper)}catch{}this.player.studioSelectionHelper=null}return}else if(r==="move-tool"){this.studioMoveMode=!this.studioMoveMode,this.studioRemoveNPCMode=!1,n.style.background=this.studioMoveMode?"#3498db":"",n.textContent=this.studioMoveMode?"Move Tool (Active)":"Move Tool",this.studioMoveMode?(this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!1)):(this.toggleTouchLookArea(!0),this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(null));return}else if(r!=="drops"){if(r==="drops"){this.spawnStudioDrops();return}else if(r==="menu"){this.showPauseMenu();return}else if(r==="quit"){try{localStorage.removeItem("voxel-firecraft-settings")}catch{}location.reload();return}}const l=n.getAttribute("data-prefab"),m=n.getAttribute("data-vehicle-type"),f=n.getAttribute("data-tree-type"),d=n.getAttribute("data-submenu");if(d){const u=document.getElementById(d);u&&u.classList.toggle("hidden");return}if(this.studioSelectedPrefab=l,this.studioSelectedOptions=m?{variant:m}:f?{variant:f}:{},this.toggleTouchLookArea(!1),d){const u=document.getElementById(d);u&&u.classList.add("hidden")}},c=h=>{h&&h.preventDefault&&h.preventDefault(),a(h)};n.addEventListener("pointerdown",c),n.addEventListener("click",h=>{h&&h.preventDefault&&h.preventDefault(),a(h)})});const o=document.getElementById("studio-minimize-btn");o&&o.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const a=document.querySelector("#studio-palette .palette-grid");a&&(a.classList.toggle("hidden"),o.textContent=a.classList.contains("hidden")?"+":"_")})}setupObjectInspector(){const e=this.renderer?this.renderer.domElement:null;if(!e)return;if(this._objectClickHandler&&this._objectClickTarget)try{this._objectClickTarget.removeEventListener("click",this._objectClickHandler),this._objectClickTarget.removeEventListener("pointerdown",this._objectClickHandler)}catch{}this._objectClickTarget=e;const t=o=>{if(this.player&&this.player.gameMode==="studio"){const l=e.getBoundingClientRect(),m=(o.clientX-l.left)/l.width*2-1,f=-((o.clientY-l.top)/l.height*2-1),d=new j;d.setFromCamera(new O(m,f),this.camera);let u=null;const p=[];if(this.world&&this.world.objects&&p.push(...this.world.objects),this.enemyManager&&this.enemyManager.enemies){console.log("[DEBUG] Enemies in scene:",this.enemyManager.enemies.map(g=>{var M,k;return((k=(M=g.mesh)==null?void 0:M.userData)==null?void 0:k.gameName)||"Unknown"}));for(const g of this.enemyManager.enemies)g.mesh&&p.push(g.mesh)}const v=d.intersectObjects(p,!0);console.log("[DEBUG] Raycast hits:",v.length,"objects. Checking each hit...");for(const g of v){let M=g.object;for(console.log("[DEBUG] Hit object:",M.type,M.userData);M.parent&&M.parent.type!=="Scene";)M=M.parent;if(console.log("[DEBUG] Root object:",M.type,M.userData),M.userData&&M.userData.gameName==="Ground"){console.log("[DEBUG] Skipping ground");continue}if(M.userData&&(M.userData.isNPC||M.userData.gameName)){console.log("[DEBUG] FOUND VALID OBJECT!",M.userData.gameName,"isNPC:",M.userData.isNPC),u=M;break}else console.log("[DEBUG] Object has no valid userData, skipping")}u?(console.log("[DEBUG] Setting selection for:",u.userData.gameName),this.player&&typeof this.player.setStudioSelection=="function"&&(this.player.setStudioSelection(u),console.log("[DEBUG] setStudioSelection called successfully"))):this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(null)}if(!this.studioMoveMode||this.player.gameMode!=="studio")return;const n=e.getBoundingClientRect(),a=(o.clientX-n.left)/n.width*2-1,c=-((o.clientY-n.top)/n.height*2-1),h=new j;h.setFromCamera(new O(a,c),this.camera);let r=null;if(this.enemyManager&&this.enemyManager.enemies){for(const l of this.enemyManager.enemies)if(l.mesh&&h.intersectObject(l.mesh,!0).length>0){for(r=l.mesh;r.parent&&r.parent.type!=="Scene";)r=r.parent;break}}if(!r){const l=h.intersectObjects(this.world.objects,!0);for(const m of l)if(m.object.userData&&m.object.userData.gameName!=="Ground"){for(r=m.object;r.parent&&r.parent.type!=="Scene";)r=r.parent;break}}r&&(this.studioDraggedObject=r,this.studioIsDragging=!0,this.player.controls&&(this.player.controls.enabled=!1),this.player&&typeof this.player.setStudioSelection=="function"&&this.player.setStudioSelection(r))},i=o=>{if(!this.studioIsDragging||!this.studioDraggedObject)return;const n=e.getBoundingClientRect(),a=(o.clientX-n.left)/n.width*2-1,c=-((o.clientY-n.top)/n.height*2-1),h=new j;h.setFromCamera(new O(a,c),this.camera);const r=h.intersectObjects(this.world.objects,!0);for(const l of r)if(l.object.userData&&l.object.userData.gameName==="Ground"){if(this.studioDraggedObject.position.x=l.point.x,this.studioDraggedObject.position.z=l.point.z,this.world&&typeof this.world.getHeightAt=="function"&&(this.studioDraggedObject.position.y=this.world.getHeightAt(l.point.x,l.point.z)),this.enemyManager){const m=this.enemyManager.enemies.find(f=>f.mesh===this.studioDraggedObject);m&&m.position.copy(this.studioDraggedObject.position)}break}},s=()=>{this.studioIsDragging&&(this.studioIsDragging=!1,this.studioDraggedObject=null,this.player.controls&&(this.player.controls.enabled=!0))};e.addEventListener("pointerdown",t),e.addEventListener("pointermove",i),e.addEventListener("pointerup",s),e.addEventListener("pointerleave",s),this._objectClickHandler=o=>{if(!this.player||!this.hud)return;const n=this.player.gameMode||"arcade";if(n==="matrix")return;if(n==="studio"&&this.studioRemoveNPCMode){const u=this.renderer.domElement.getBoundingClientRect(),p=(o.clientX-u.left)/u.width*2-1,v=-((o.clientY-u.top)/u.height*2-1),g=new j;if(g.setFromCamera(new O(p,v),this.camera),this.enemyManager&&this.enemyManager.enemies){console.log("Remove NPC: Checking",this.enemyManager.enemies.length,"enemies");for(let M=this.enemyManager.enemies.length-1;M>=0;M--){const k=this.enemyManager.enemies[M];if(k.mesh&&g.intersectObject(k.mesh,!0).length>0){console.log("Hit enemy",M,"removing..."),this.scene.remove(k.mesh),this.enemyManager.enemies.splice(M,1),console.log("Removed NPC");return}}}return}if(n==="studio"&&this.studioSelectedPrefab){const u=e.getBoundingClientRect(),p=(o.clientX-u.left)/u.width*2-1,v=-((o.clientY-u.top)/u.height*2-1),g=new j;g.setFromCamera(new O(p,v),this.camera);const M=g.intersectObjects(this.world.objects,!0);let k=null;for(const b of M)if(b.object&&b.object.userData&&b.object.userData.gameName==="Ground"){k=b;break}if(!k){const b=new j;b.setFromCamera(new O(0,0),this.camera);const D=b.intersectObjects(this.world.objects,!0);for(const C of D)if(C.object&&C.object.userData&&C.object.userData.gameName==="Ground"){k=C;break}}if(k){if(this.studioSelectedPrefab==="npc"){if(this.enemyManager&&typeof this.enemyManager.spawnEnemyAt=="function"){const b=this.studioSelectedOptions?this.studioSelectedOptions.type:"normal";this.enemyManager.spawnEnemyAt(k.point.x,k.point.z,b)}}else if(typeof this.world.spawnPrefab=="function"){const b=this.studioSelectedOptions||{};this.world.spawnPrefab(this.studioSelectedPrefab,k.point.x,k.point.z,b)}}this.studioSelectedPrefab=null,this.studioSelectedOptions=null,this.toggleTouchLookArea(!0);return}let a=0,c=0;if(this.player.controls&&this.player.controls.isLocked)a=0,c=0;else{const u=e.getBoundingClientRect();a=(o.clientX-u.left)/u.width*2-1,c=-((o.clientY-u.top)/u.height*2-1)}this._pickRaycaster.setFromCamera(new O(a,c),this.camera);const h=[];if(this.world&&Array.isArray(this.world.objects)&&h.push(...this.world.objects),this.itemManager&&Array.isArray(this.itemManager.items)&&h.push(...this.itemManager.items),this.enemyManager&&Array.isArray(this.enemyManager.enemies)&&this.enemyManager.enemies.forEach(u=>{u&&u.mesh&&h.push(u.mesh)}),h.length===0)return;const r=this._pickRaycaster.intersectObjects(h,!0);if(!r.length)return;let l=r[0].object,m=null;for(;l;){if(l.userData&&(l.userData.gameId||l.userData.gameid)&&l.userData.gameName){m=l.userData;break}l=l.parent}if(!m)return;const f=m.gameName||"Object",d=m.gameId||m.gameid||"---";typeof this.hud.showSelectionInfo=="function"&&this.hud.showSelectionInfo(f,d)},e.addEventListener("click",this._objectClickHandler),e.addEventListener("pointerdown",this._objectClickHandler)}initStudioPaletteDrag(e){if(!e||e._dragInit)return;e._dragInit=!0;const t=e.querySelector(".palette-title")||e;let i=!1,s=0,o=0,n=0,a=0,c=null;e.style.touchAction="none";const h=l=>{if(!i){const u=Math.abs(l.clientX-n),p=Math.abs(l.clientY-a);if(u<3&&p<3)return;i=!0,c&&(e.style.right="auto",e.style.bottom="auto",e.style.position="fixed",e.style.width=`${c.width}px`,e.style.minWidth=`${c.width}px`,e.style.maxWidth=`${c.width}px`,e.style.left=`${c.left}px`,e.style.top=`${c.top}px`)}const m=e.getBoundingClientRect(),f=Math.max(0,Math.min(window.innerWidth-m.width,l.clientX-s)),d=Math.max(0,Math.min(window.innerHeight-m.height,l.clientY-o));e.style.left=`${f}px`,e.style.top=`${d}px`},r=()=>{i=!1,t.releasePointerCapture&&t.releasePointerCapture(t._dragPointerId),document.removeEventListener("pointermove",h),document.removeEventListener("pointerup",r)};t.addEventListener("pointerdown",l=>{try{l.preventDefault()}catch{}const m=e.getBoundingClientRect();c=m,s=l.clientX-m.left,o=l.clientY-m.top,n=l.clientX,a=l.clientY,i=!1,t._dragPointerId=l.pointerId;try{t.setPointerCapture(l.pointerId)}catch{}document.addEventListener("pointermove",h),document.addEventListener("pointerup",r)})}togglePause(){if(this.player){if(this.player.controls&&this.player.controls.isLocked){this.showPauseMenu();return}this.isPaused=!this.isPaused,this.isPaused?this.pauseBackgroundMusic():this.playBackgroundMusic()}}setupPauseMenu(){document.addEventListener("keydown",t=>{t.code==="Escape"&&this.player&&!this.player.isDead&&(t.preventDefault(),this.showPauseMenu())});const e=document.getElementById("pause-menu");e&&e.remove()}showPauseMenu(){this.isPaused=!0,this.player.controls&&this.player.controls.isLocked&&this.player.controls.unlock(),this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps(),this.pauseBackgroundMusic();const e=document.getElementById("main-menu");if(e){e.style.display="flex",this.setMenuOpenState(!0);const t=document.getElementById("play-btn");t&&this.player&&(t.innerText="RESUME GAME")}if(this.setHotbarVisible(!1),this.player&&this.player.gameMode==="studio"){const t=document.getElementById("studio-palette");t&&t.classList.remove("hidden")}}playBackgroundMusic(){try{this.bgAudio||(this.bgAudio=new Audio(_t),this.bgAudio.loop=!0,this.bgAudio.volume=this.bgMusicVolume,this.bgAudio.preload="auto");const e=this.bgAudio.play();e&&typeof e.then=="function"&&e.catch(()=>{})}catch(e){console.warn("Could not play background music:",e)}}pauseBackgroundMusic(){if(this.bgAudio&&!this.bgAudio.paused)try{this.bgAudio.pause()}catch{}}stopBackgroundMusic(){if(this.bgAudio)try{this.bgAudio.pause(),this.bgAudio.currentTime=0}catch{}}requestFullscreenIfNeeded(e){if(!e)return;const t=document;if(t.fullscreenElement||t.webkitFullscreenElement||t.mozFullScreenElement||t.msFullscreenElement)return;const s=document.documentElement||document.body,o=s.requestFullscreen||s.webkitRequestFullscreen||s.mozRequestFullScreen||s.msRequestFullscreen;o?o.call(s).catch(n=>{console.warn("Fullscreen request failed:",n),ue&&alert("Fullscreen may not be supported on this mobile device.")}):ue&&alert("Fullscreen is not available on this mobile device.")}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate());try{const e=this.clock.getDelta(),t=Math.min(e,.1),i=!!(this.touchControls&&this.touchControls.enabled),s=!!(this.player&&this.player.controls&&this.player.controls.isLocked),o=!!(this.player&&this.player.gameMode==="studio");if(!this.isPaused&&this.player&&(s||i||o)){try{this.player.update(t)}catch(n){console.error("Error in player.update:",n)}try{const n=this.world.update(t,this.player.position);!(this.player&&this.player.gameMode==="studio")&&n&&n.inStorm?this.player.takeDamage(1*t):this.player&&typeof this.player.clearHurtQueue=="function"&&this.player.clearHurtQueue()}catch(n){console.error("Error in world.update:",n)}try{this.enemyManager.update(t)}catch(n){console.error("Error in enemyManager.update:",n)}try{this.itemManager.update(t)}catch(n){console.error("Error in itemManager.update:",n)}if(this.player&&this.player.gameMode==="multiplayer"){if(this.matchPhase==="live")this.multiplayerDropTimer+=t,this.multiplayerDropTimer>=30&&(this.multiplayerDropActive=!0),this.multiplayerDropActive&&this.itemManager&&(this.multiplayerDropCooldown-=t,this.multiplayerDropCooldown<=0&&(this.multiplayerDropCooldown=60,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"&&this.itemManager.spawnMatrixDropNearPlayer()));else if(this.matchPhase==="countdown"){this.lobbyCountdown-=t;const n=document.getElementById("mp-lobby-countdown");this.lobbyCountdown<0&&(this.lobbyCountdown=0),n&&(n.innerText=`Starting in ${Math.ceil(this.lobbyCountdown)}...`),this.lobbyCountdown<=0&&this.startMultiplayerMatch()}}try{this.multiplayer&&typeof this.multiplayer.update=="function"&&this.multiplayer.update(t)}catch(n){console.error("Error in multiplayer.update:",n)}if(this.player&&(this.player.gameMode==="arcade"||this.player.gameMode==="survival")){this.survivalTime=(performance.now()-this.survivalStartTime)/1e3;const n=document.getElementById("survival-time-value");if(n){const a=Math.floor(this.survivalTime/60),c=Math.floor(this.survivalTime%60);n.innerText=`${a.toString().padStart(2,"0")}:${c.toString().padStart(2,"0")}`}if(this.itemManager&&this.enemyManager){const a=this.itemManager.items?this.itemManager.items.filter(h=>!(h.userData&&h.userData.isOpened)).length:0,c=this.enemyManager.targetCount>0?this.enemyManager.killedCount/this.enemyManager.targetCount:0;if(a===0&&c>=.3&&!this.lootDropEligible&&(this.lootDropEligible=!0,this.lootDropCooldown=0,console.log("Loot drops from sky enabled! Player killed 30%+ zombies.")),this.lootDropEligible&&(this.lootDropCooldown-=t,this.lootDropCooldown<=0&&(this.lootDropCooldown=45,typeof this.itemManager.spawnMatrixDropNearPlayer=="function"))){const h=2+Math.floor(Math.random()*2);for(let r=0;r<h;r++)this.itemManager.spawnMatrixDropNearPlayer();console.log(`Dropped ${h} items from sky!`)}}}try{this.hud.update()}catch(n){console.error("Error in hud.update:",n)}try{this.touchControls&&typeof this.touchControls.update=="function"&&this.touchControls.update()}catch(n){console.error("Error in touchControls.update:",n)}try{if(!(this.player&&(this.player.gameMode==="matrix"||this.player.gameMode==="studio"||this.player.gameMode==="multiplayer"||this.player.gameMode==="matrix-ai"))&&this.enemyManager.enemies.length===0&&!this.player.isDead&&!this.victoryShown){this.victoryShown=!0;try{this.player&&typeof this.player.stopFootsteps=="function"&&this.player.stopFootsteps()}catch{}this.hud.showVictory(),this.player.controls.unlock()}else this.player&&this.player.gameMode==="multiplayer"&&this.matchPhase==="live"&&!this.player.isDead&&!this.victoryShown&&(this.multiplayer?this.multiplayer.others.size:0)===0&&(this.victoryShown=!0,this.hud.showVictory(),this.player.controls&&this.player.controls.unlock&&this.player.controls.unlock())}catch(n){console.error("Error in victory check:",n)}}this.renderer.render(this.scene,this.camera)}catch(e){try{console.error("Unhandled error in Game.animate:",e,{playerExists:!!this.player,playerWeaponCount:this.player?this.player.weapons?this.player.weapons.length:"no-weapons":"no-player",currentWeaponIndex:this.player?this.player.currentWeaponIndex:"no-player",hudExists:!!this.hud,hudSettings:this.hud?this.hud.settings:null});try{this._logRenderMaterialDiagnostics(e)}catch(t){console.error("Error during render diagnostics:",t)}}catch(t){console.error("Error logging animate failure:",t)}return}}}Ie.prototype.playEndSequence=function(I,e={}){try{if(this._playingEndSequence)return;if(this._playingEndSequence=!0,this.bgAudio)try{this._prevBgVolume=this.bgAudio.volume,this.bgAudio.pause()}catch{this._prevBgVolume=this.bgMusicVolume}if(this._endSequenceAudio){try{this._endSequenceAudio.pause(),this._endSequenceAudio.currentTime=0}catch{}this._endSequenceAudio=null}const t=new Audio(I);t.loop=e.loop||!1,t.volume=e.volume!==void 0?e.volume:1,t.preload="auto",this._endSequenceAudio=t,t.load(),setTimeout(()=>{const i=t.play();i&&typeof i.then=="function"&&i.catch(s=>{console.log("Audio playback blocked, waiting for user interaction:",s);const o=()=>{t.readyState<2&&t.load(),t.play().catch(()=>{}),document.removeEventListener("touchstart",o),document.removeEventListener("click",o)};document.addEventListener("touchstart",o,{once:!0}),document.addEventListener("click",o,{once:!0})})},100),t.addEventListener("ended",()=>{try{this.bgAudio&&this._prevBgVolume!==null&&(this.bgAudio.volume=this._prevBgVolume)}catch{}this._endSequenceAudio=null,this._prevBgVolume=null,this._playingEndSequence=!1})}catch(t){console.warn("playEndSequence error:",t)}};Ie.prototype._logRenderMaterialDiagnostics=function(I){try{const e=[];let t=0;this.scene.traverse(i=>{if(i.isMesh){t++;const s=i.material;if(!s){e.push({uuid:i.uuid,name:i.name||i.userData&&i.userData.gameName||"mesh",issue:"no-material"});return}const o=n=>({type:n.type||n.constructor&&n.constructor.name||"Unknown",isShaderMaterial:!!n.isShaderMaterial,isStandardMaterial:!!n.isMeshStandardMaterial,hasEmissive:n.emissive!==void 0,uniformsKeys:n.uniforms?Object.keys(n.uniforms):null,userData:n.userData||null});Array.isArray(s)?e.push({uuid:i.uuid,name:i.name||i.userData&&i.userData.gameName||"mesh",materials:s.map(o)}):e.push({uuid:i.uuid,name:i.userData&&i.userData.gameName||i.name||"mesh",material:o(s)})}}),console.error("Render diagnostics:",{originalError:I&&I.toString(),totalMeshes:t,sampleProblems:e.slice(0,30),note:"Look for materials missing expected uniforms (shader/standard) or meshes without material."})}catch(e){console.error("Failed collecting render diagnostics:",e)}};window.game=new Ie;(function(){try{const e=JSON.parse(localStorage.getItem("voxel-firecraft-settings")||"{}"),t=e&&e.debugMode||localStorage.getItem("showDebugOverlay")==="true"||!!window.DEBUG_OVERLAY;window.debugOverlay=oi({autoShow:!!t}),window.addEventListener("keydown",i=>{if(i.key==="`"&&window.debugOverlay){const s=document.getElementById("debug-overlay");s&&s.classList.contains("hidden")?window.debugOverlay.show():window.debugOverlay&&window.debugOverlay.hide()}});try{let i=document.getElementById("debug-toggle-btn");i||(i=document.createElement("button"),i.id="debug-toggle-btn",i.title="Debug logs",i.innerText="DBG",document.body.appendChild(i));const s=!0;i.addEventListener("click",o=>{try{const n=document.getElementById("debug-overlay");n&&n.classList.contains("hidden")?(window.debugOverlay&&window.debugOverlay.show(),localStorage.setItem("showDebugOverlay","true")):(window.debugOverlay&&window.debugOverlay.hide(),localStorage.removeItem("showDebugOverlay"))}catch(n){console.warn("debug toggle error",n)}})}catch{}}catch(e){console.warn("debugOverlay init failed",e)}})();window.addEventListener("game-touch-look",I=>{try{const e=I.detail||{dx:0,dy:0},t=.003;if(window.game&&window.game.player)try{if(typeof window.game.player.rotateCamera=="function")window.game.player.rotateCamera(e.dx*t,e.dy*t);else{window.game.player._touchYaw=(window.game.player._touchYaw||0)-e.dx*.01,window.game.player._touchPitch=(window.game.player._touchPitch||0)-e.dy*.01;const s=Math.PI/2-.1;window.game.player._touchPitch=Math.max(-s,Math.min(s,window.game.player._touchPitch))}}catch{}}catch{}});
